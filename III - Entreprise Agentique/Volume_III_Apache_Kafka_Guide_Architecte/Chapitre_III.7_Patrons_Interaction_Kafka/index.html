
<!doctype html>
<html lang="fr" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Corpus encyclopédique francophone — science informatique, interopérabilité et entreprise agentique">
      
      
        <meta name="author" content="André-Guy Bruneau">
      
      
        <link rel="canonical" href="https://agbruneau.github.io/CorpusInformatique/III%20-%20Entreprise%20Agentique/Volume_III_Apache_Kafka_Guide_Architecte/Chapitre_III.7_Patrons_Interaction_Kafka/">
      
      
        <link rel="prev" href="../Chapitre_III.6_Contrats_Donnees/">
      
      
        <link rel="next" href="../Chapitre_III.8_Conception_Application_Streaming/">
      
      
        
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.2">
    
    
      
        <title>III.7 — Patrons d'interaction Kafka - Corpus Informatique</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../css/extra.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#chapitre-iii7" class="md-skip">
          Aller au contenu
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="En-tête">
    <a href="../../.." title="Corpus Informatique" class="md-header__button md-logo" aria-label="Corpus Informatique" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Corpus Informatique
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              III.7 — Patrons d'interaction Kafka
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Passer au mode sombre"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Passer au mode sombre" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Passer au mode clair"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Passer au mode clair" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Rechercher" placeholder="Rechercher" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Recherche">
        
        <button type="reset" class="md-search__icon md-icon" title="Effacer" aria-label="Effacer" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initialisation de la recherche
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/agbruneau/CorpusInformatique" title="Aller au dépôt" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    agbruneau/CorpusInformatique
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Onglets" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../.." class="md-tabs__link">
        
  
  
    
  
  Accueil

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_I_Fondements_Mathematiques_Theorie/Chapitre_I.1_Fondements_Logiques_Raisonnement/" class="md-tabs__link">
          
  
  
    
  
  I — Science et Génie Informatique

        </a>
      </li>
    
  

    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../II%20-%20Interop%C3%A9rabilit%C3%A9/Chapitre_II.1_Introduction_Problematique/" class="md-tabs__link">
          
  
  
    
  
  II — Interopérabilité

        </a>
      </li>
    
  

      
        
  
  
  
    
  
  
    
    
      
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../../Volume_I_Fondations_Entreprise_Agentique/Chapitre_I.1_Crise_Integration_Systemique/" class="md-tabs__link">
          
  
  
    
  
  III — Entreprise Agentique

        </a>
      </li>
    
  

    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="Corpus Informatique" class="md-nav__button md-logo" aria-label="Corpus Informatique" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Corpus Informatique
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/agbruneau/CorpusInformatique" title="Aller au dépôt" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    agbruneau/CorpusInformatique
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Accueil
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    I — Science et Génie Informatique
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    I — Science et Génie Informatique
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2_1" >
        
          
          <label class="md-nav__link" for="__nav_2_1" id="__nav_2_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Volume I — Fondements Mathématiques et Théorie de l'Informatique
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Volume I — Fondements Mathématiques et Théorie de l'Informatique
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_I_Fondements_Mathematiques_Theorie/Chapitre_I.1_Fondements_Logiques_Raisonnement/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.1 — Fondements logiques et raisonnement
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_I_Fondements_Mathematiques_Theorie/Chapitre_I.2_Structures_Discretes_Combinatoire/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.2 — Structures discrètes et combinatoire
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_I_Fondements_Mathematiques_Theorie/Chapitre_I.3_Theorie_Graphes/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.3 — Théorie des graphes
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_I_Fondements_Mathematiques_Theorie/Chapitre_I.4_Langages_Formels_Automates/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.4 — Langages formels et automates
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_I_Fondements_Mathematiques_Theorie/Chapitre_I.5_Calculabilite_Decidabilite/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.5 — Calculabilité et décidabilité
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_I_Fondements_Mathematiques_Theorie/Chapitre_I.6_Theorie_Complexite/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.6 — Théorie de la complexité
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2_2" >
        
          
          <label class="md-nav__link" for="__nav_2_2" id="__nav_2_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Volume II — Architecture des Ordinateurs et Systèmes Numériques
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Volume II — Architecture des Ordinateurs et Systèmes Numériques
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_II_Architecture_Ordinateurs_Systemes_Numeriques/Chapitre_I.7_Systemes_Numeriques_Donnees/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.7 — Systèmes numériques et données
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_II_Architecture_Ordinateurs_Systemes_Numeriques/Chapitre_I.8_Circuits_Combinatoires/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.8 — Circuits combinatoires
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_II_Architecture_Ordinateurs_Systemes_Numeriques/Chapitre_I.9_Circuits_Sequentiels/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.9 — Circuits séquentiels
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_II_Architecture_Ordinateurs_Systemes_Numeriques/Chapitre_I.10_Conception_Systeme_HDL/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.10 — Conception système HDL
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_II_Architecture_Ordinateurs_Systemes_Numeriques/Chapitre_I.11_Architecture_ISA/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.11 — Architecture ISA
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_II_Architecture_Ordinateurs_Systemes_Numeriques/Chapitre_I.12_Conception_CPU/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.12 — Conception CPU
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_II_Architecture_Ordinateurs_Systemes_Numeriques/Chapitre_I.13_Parallelisme_ILP/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.13 — Parallélisme ILP
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_II_Architecture_Ordinateurs_Systemes_Numeriques/Chapitre_I.14_Hierarchie_Memoire_Stockage/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.14 — Hiérarchie mémoire et stockage
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_II_Architecture_Ordinateurs_Systemes_Numeriques/Chapitre_I.15_Systemes_IO_Accelere/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.15 — Systèmes I/O accélérés
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2_3" >
        
          
          <label class="md-nav__link" for="__nav_2_3" id="__nav_2_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Volume III — Systèmes d'Exploitation, Langages et Environnements
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Volume III — Systèmes d'Exploitation, Langages et Environnements
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_III_Systemes_Exploitation_Langages_Environnements/Chapitre_I.16_Systemes_Exploitation_OS/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.16 — Systèmes d'exploitation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_III_Systemes_Exploitation_Langages_Environnements/Chapitre_I.17_Gestion_Concurrence/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.17 — Gestion de la concurrence
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_III_Systemes_Exploitation_Langages_Environnements/Chapitre_I.18_Gestion_Memoire_Fichiers/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.18 — Gestion mémoire et fichiers
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_III_Systemes_Exploitation_Langages_Environnements/Chapitre_I.19_Conception_Langages/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.19 — Conception des langages
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_III_Systemes_Exploitation_Langages_Environnements/Chapitre_I.20_Compilation_Interpretation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.20 — Compilation et interprétation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_III_Systemes_Exploitation_Langages_Environnements/Chapitre_I.21_Environnements_Virtualisation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.21 — Environnements et virtualisation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2_4" >
        
          
          <label class="md-nav__link" for="__nav_2_4" id="__nav_2_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Volume IV — Structures de Données, Algorithmique et Génie Logiciel
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Volume IV — Structures de Données, Algorithmique et Génie Logiciel
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_IV_Structures_Donnees_Algorithmique_Genie_Logiciel/Chapitre_I.22_Structures_Donnees_Fondamentales/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.22 — Structures de données fondamentales
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_IV_Structures_Donnees_Algorithmique_Genie_Logiciel/Chapitre_I.23_Structures_Donnees_Avancees/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.23 — Structures de données avancées
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_IV_Structures_Donnees_Algorithmique_Genie_Logiciel/Chapitre_I.24_Conception_Analyse_Algorithmes/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.24 — Conception et analyse d'algorithmes
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_IV_Structures_Donnees_Algorithmique_Genie_Logiciel/Chapitre_I.25_Algorithmes_Graphes_Avances/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.25 — Algorithmes de graphes avancés
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_IV_Structures_Donnees_Algorithmique_Genie_Logiciel/Chapitre_I.26_Processus_Developpement/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.26 — Processus de développement
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_IV_Structures_Donnees_Algorithmique_Genie_Logiciel/Chapitre_I.27_Architecture_Logicielle/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.27 — Architecture logicielle
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_IV_Structures_Donnees_Algorithmique_Genie_Logiciel/Chapitre_I.28_Qualite_Test_Maintenance/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.28 — Qualité, test et maintenance
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_IV_Structures_Donnees_Algorithmique_Genie_Logiciel/Chapitre_I.29_DevOps_SRE/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.29 — DevOps et SRE
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2_5" >
        
          
          <label class="md-nav__link" for="__nav_2_5" id="__nav_2_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Volume V — Données, Réseaux, Cloud et Sécurité
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Volume V — Données, Réseaux, Cloud et Sécurité
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_V_Donnees_Reseaux_Cloud_Securite/Chapitre_I.30_SGBD_Fondements/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.30 — SGBD fondements
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_V_Donnees_Reseaux_Cloud_Securite/Chapitre_I.31_SGBD_Implementation_Transactions/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.31 — SGBD implémentation et transactions
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_V_Donnees_Reseaux_Cloud_Securite/Chapitre_I.32_Donnees_Modernes_BigData/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.32 — Données modernes et Big Data
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_V_Donnees_Reseaux_Cloud_Securite/Chapitre_I.33_Fondements_Reseaux/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.33 — Fondements des réseaux
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_V_Donnees_Reseaux_Cloud_Securite/Chapitre_I.34_Protocoles_Internetworking/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.34 — Protocoles et internetworking
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_V_Donnees_Reseaux_Cloud_Securite/Chapitre_I.35_Systemes_Distribues/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.35 — Systèmes distribués
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_V_Donnees_Reseaux_Cloud_Securite/Chapitre_I.36_Cloud_Infrastructures/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.36 — Cloud et infrastructures
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_V_Donnees_Reseaux_Cloud_Securite/Chapitre_I.37_Fondements_Securite/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.37 — Fondements de la sécurité
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_V_Donnees_Reseaux_Cloud_Securite/Chapitre_I.38_Cryptographie_Appliquee/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.38 — Cryptographie appliquée
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_V_Donnees_Reseaux_Cloud_Securite/Chapitre_I.39_Securite_Reseaux/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.39 — Sécurité des réseaux
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_V_Donnees_Reseaux_Cloud_Securite/Chapitre_I.40_Securite_Systemes/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.40 — Sécurité des systèmes
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2_6" >
        
          
          <label class="md-nav__link" for="__nav_2_6" id="__nav_2_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Volume VI — Intelligence Artificielle et Systèmes Interactifs
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    Volume VI — Intelligence Artificielle et Systèmes Interactifs
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_VI_Intelligence_Artificielle_Systemes_Interactifs/Chapitre_I.41_Fondements_IA/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.41 — Fondements de l'IA
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_VI_Intelligence_Artificielle_Systemes_Interactifs/Chapitre_I.42_Connaissance_Raisonnement/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.42 — Connaissance et raisonnement
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_VI_Intelligence_Artificielle_Systemes_Interactifs/Chapitre_I.43_ML_Fondements/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.43 — ML fondements
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_VI_Intelligence_Artificielle_Systemes_Interactifs/Chapitre_I.44_DeepLearning/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.44 — Deep Learning
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_VI_Intelligence_Artificielle_Systemes_Interactifs/Chapitre_I.45_Reinforcement_Learning/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.45 — Reinforcement Learning
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_VI_Intelligence_Artificielle_Systemes_Interactifs/Chapitre_I.46_TALN_NLP/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.46 — TALN / NLP
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_VI_Intelligence_Artificielle_Systemes_Interactifs/Chapitre_I.47_Vision_Ordinateur/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.47 — Vision par ordinateur
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_VI_Intelligence_Artificielle_Systemes_Interactifs/Chapitre_I.48_Infographie_Visualisation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.48 — Infographie et visualisation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_VI_Intelligence_Artificielle_Systemes_Interactifs/Chapitre_I.49_IHM_HCI/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.49 — IHM / HCI
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_VI_Intelligence_Artificielle_Systemes_Interactifs/Chapitre_I.50_Robotique_IoT/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.50 — Robotique et IoT
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2_7" >
        
          
          <label class="md-nav__link" for="__nav_2_7" id="__nav_2_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Volume VII — Technologies Émergentes et Frontières
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_7">
            <span class="md-nav__icon md-icon"></span>
            
  
    Volume VII — Technologies Émergentes et Frontières
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_VII_Technologies_Emergentes_Frontieres/Chapitre_I.51_Informatique_Quantique/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.51 — Informatique quantique
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_VII_Technologies_Emergentes_Frontieres/Chapitre_I.52_Algorithmes_Cryptographie_Quantiques/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.52 — Algorithmes et cryptographie quantiques
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_VII_Technologies_Emergentes_Frontieres/Chapitre_I.53_HPC_Exascale/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.53 — HPC et exascale
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_VII_Technologies_Emergentes_Frontieres/Chapitre_I.54_Architectures_Post_Moore/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.54 — Architectures post-Moore
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_VII_Technologies_Emergentes_Frontieres/Chapitre_I.55_Modeles_Fondateurs_IA/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.55 — Modèles fondateurs IA
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_VII_Technologies_Emergentes_Frontieres/Chapitre_I.56_AGI_Alignement_Securite/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.56 — AGI, alignement et sécurité
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_VII_Technologies_Emergentes_Frontieres/Chapitre_I.57_Sciences_Computationnelles/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.57 — Sciences computationnelles
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_VII_Technologies_Emergentes_Frontieres/Chapitre_I.58_CyberPhysiques_Jumeaux/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.58 — Systèmes cyber-physiques et jumeaux
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_VII_Technologies_Emergentes_Frontieres/Chapitre_I.59_Web3_Decentralise/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.59 — Web3 et décentralisé
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_VII_Technologies_Emergentes_Frontieres/Chapitre_I.60_Synthese_Frontieres/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.60 — Synthèse et frontières
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2_8" >
        
          
          <label class="md-nav__link" for="__nav_2_8" id="__nav_2_8_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Volume VIII — Convergence AGI–Quantique : Fondements et Algorithmes
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_8">
            <span class="md-nav__icon md-icon"></span>
            
  
    Volume VIII — Convergence AGI–Quantique : Fondements et Algorithmes
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_VIII_Convergence_AGI_Quantique_Fondements/Chapitre_I.61_Introduction_Informatique/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.61 — Introduction à l'informatique
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_VIII_Convergence_AGI_Quantique_Fondements/Chapitre_I.62_Convergence_AGI_Quantique/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.62 — Convergence AGI-quantique
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_VIII_Convergence_AGI_Quantique_Fondements/Chapitre_I.63_Evolution_IA_Quantique/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.63 — Évolution IA-quantique
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_VIII_Convergence_AGI_Quantique_Fondements/Chapitre_I.64_Reseaux_Neuronaux_Quantiques/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.64 — Réseaux neuronaux quantiques
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_VIII_Convergence_AGI_Quantique_Fondements/Chapitre_I.65_Algorithmes_Evolutionnaires_Quantiques/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.65 — Algorithmes évolutionnaires quantiques
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_VIII_Convergence_AGI_Quantique_Fondements/Chapitre_I.66_Renforcement_Quantique/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.66 — Renforcement quantique
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_VIII_Convergence_AGI_Quantique_Fondements/Chapitre_I.67_Architectures_Hybrides/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.67 — Architectures hybrides
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_VIII_Convergence_AGI_Quantique_Fondements/Chapitre_I.68_SVM_Quantiques/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.68 — SVM quantiques
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_VIII_Convergence_AGI_Quantique_Fondements/Chapitre_I.69_Codage_Donnees_Quantiques/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.69 — Codage de données quantiques
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_VIII_Convergence_AGI_Quantique_Fondements/Chapitre_I.70_Scalabilite_Correction_Erreurs/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.70 — Scalabilité et correction d'erreurs
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2_9" >
        
          
          <label class="md-nav__link" for="__nav_2_9" id="__nav_2_9_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Volume IX — Convergence AGI–Quantique : Applications et Perspectives
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_9">
            <span class="md-nav__icon md-icon"></span>
            
  
    Volume IX — Convergence AGI–Quantique : Applications et Perspectives
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_IX_Convergence_AGI_Quantique_Applications/Chapitre_I.71_TALN_Quantique/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.71 — TALN quantique
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_IX_Convergence_AGI_Quantique_Applications/Chapitre_I.72_Securite_Confidentialite/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.72 — Sécurité et confidentialité
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_IX_Convergence_AGI_Quantique_Applications/Chapitre_I.73_Ethique_Reglementaire/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.73 — Éthique et réglementaire
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_IX_Convergence_AGI_Quantique_Applications/Chapitre_I.74_Implementation_Materielle/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.74 — Implémentation matérielle
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_IX_Convergence_AGI_Quantique_Applications/Chapitre_I.75_Middleware_Software/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.75 — Middleware et software
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_IX_Convergence_AGI_Quantique_Applications/Chapitre_I.76_Etudes_Cas/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.76 — Études de cas
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_IX_Convergence_AGI_Quantique_Applications/Chapitre_I.77_Durabilite_Energie/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.77 — Durabilité et énergie
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_IX_Convergence_AGI_Quantique_Applications/Chapitre_I.78_Metriques_Bancs/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.78 — Métriques et bancs d'essai
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_IX_Convergence_AGI_Quantique_Applications/Chapitre_I.79_Perspectives_Avenir/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.79 — Perspectives d'avenir
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_IX_Convergence_AGI_Quantique_Applications/Chapitre_I.80_Infrastructure_Centres_Donnees_IA/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.80 — Infrastructure et centres de données IA
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    II — Interopérabilité
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    II — Interopérabilité
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../II%20-%20Interop%C3%A9rabilit%C3%A9/Chapitre_II.1_Introduction_Problematique/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    II.1 — Introduction et problématique
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../II%20-%20Interop%C3%A9rabilit%C3%A9/Chapitre_II.2_Fondements_Theoriques/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    II.2 — Fondements théoriques
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../II%20-%20Interop%C3%A9rabilit%C3%A9/Chapitre_II.3_Integration_Applications/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    II.3 — Intégration des applications
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../II%20-%20Interop%C3%A9rabilit%C3%A9/Chapitre_II.4_Integration_Donnees/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    II.4 — Intégration des données
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../II%20-%20Interop%C3%A9rabilit%C3%A9/Chapitre_II.5_Integration_Evenements/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    II.5 — Intégration des événements
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../II%20-%20Interop%C3%A9rabilit%C3%A9/Chapitre_II.6_Standards_Contrats/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    II.6 — Standards et contrats
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../II%20-%20Interop%C3%A9rabilit%C3%A9/Chapitre_II.7_Resilience_Observabilite/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    II.7 — Résilience et observabilité
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../II%20-%20Interop%C3%A9rabilit%C3%A9/Chapitre_II.8_Collaboration_Automatisation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    II.8 — Collaboration et automatisation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../II%20-%20Interop%C3%A9rabilit%C3%A9/Chapitre_II.9_Architecture_Reference/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    II.9 — Architecture de référence
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../II%20-%20Interop%C3%A9rabilit%C3%A9/Chapitre_II.10_Order_to_Cash/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    II.10 — Order-to-Cash
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../II%20-%20Interop%C3%A9rabilit%C3%A9/Chapitre_II.11_Entreprise_Agentique/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    II.11 — Entreprise agentique
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../II%20-%20Interop%C3%A9rabilit%C3%A9/Chapitre_II.12_Securite_Identite_Conformite/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    II.12 — Sécurité, identité et conformité
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../II%20-%20Interop%C3%A9rabilit%C3%A9/Chapitre_II.A_Annexes/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Annexes
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" checked>
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    III — Entreprise Agentique
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    III — Entreprise Agentique
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_1" >
        
          
          <label class="md-nav__link" for="__nav_4_1" id="__nav_4_1_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Volume I — Fondations
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Volume I — Fondations
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_I_Fondations_Entreprise_Agentique/Chapitre_I.1_Crise_Integration_Systemique/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.1 — Crise d'intégration systémique
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_I_Fondations_Entreprise_Agentique/Chapitre_I.2_Fondements_Dimensions_Interoperabilite/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.2 — Fondements et dimensions de l'interopérabilité
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_I_Fondations_Entreprise_Agentique/Chapitre_I.3_Cadres_Reference_Standards_Maturite/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.3 — Cadres de référence, standards et maturité
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_I_Fondations_Entreprise_Agentique/Chapitre_I.4_Principes_Architecture_Reactive/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.4 — Principes d'architecture réactive
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_I_Fondations_Entreprise_Agentique/Chapitre_I.5_Ecosysteme_API/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.5 — Écosystème API
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_I_Fondations_Entreprise_Agentique/Chapitre_I.6_Architecture_Evenements_EDA/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.6 — Architecture événements (EDA)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_I_Fondations_Entreprise_Agentique/Chapitre_I.7_Contrats_Donnees/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.7 — Contrats de données
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_I_Fondations_Entreprise_Agentique/Chapitre_I.8_Conception_Implementation_Observabilite/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.8 — Conception et implémentation de l'observabilité
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_I_Fondations_Entreprise_Agentique/Chapitre_I.9_Etudes_Cas_Architecturales/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.9 — Études de cas architecturales
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_I_Fondations_Entreprise_Agentique/Chapitre_I.10_Limites_Interoperabilite_Semantique/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.10 — Limites de l'interopérabilité sémantique
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_I_Fondations_Entreprise_Agentique/Chapitre_I.11_IA_Moteur_Interoperabilite/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.11 — IA moteur d'interopérabilité
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_I_Fondations_Entreprise_Agentique/Chapitre_I.12_Definition_Interoperabilite_Cognitivo_Adaptative/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.12 — Définition de l'interopérabilité cognitivo-adaptative
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_I_Fondations_Entreprise_Agentique/Chapitre_I.13_Ere_IA_Agentique_Modele_Travailleur_Numerique/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.13 — Ère IA agentique et modèle du travailleur numérique
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_I_Fondations_Entreprise_Agentique/Chapitre_I.14_Maillage_Agentique/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.14 — Maillage agentique
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_I_Fondations_Entreprise_Agentique/Chapitre_I.15_Ingenierie_Systemes_Cognitifs_Protocoles_Interaction/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.15 — Ingénierie des systèmes cognitifs et protocoles d'interaction
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_I_Fondations_Entreprise_Agentique/Chapitre_I.16_Modele_Operationnel_Symbiose_Humain_Agent/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.16 — Modèle opérationnel de symbiose humain-agent
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_I_Fondations_Entreprise_Agentique/Chapitre_I.17_Gouvernance_Constitutionnelle_Alignement_IA/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.17 — Gouvernance constitutionnelle et alignement IA
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_I_Fondations_Entreprise_Agentique/Chapitre_I.18_AgentOps_Industrialisation_Securisation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.18 — AgentOps : industrialisation et sécurisation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_I_Fondations_Entreprise_Agentique/Chapitre_I.19_Architecte_Intentions_Role_Sociotechnique/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.19 — Architecte des intentions : rôle sociotechnique
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_I_Fondations_Entreprise_Agentique/Chapitre_I.20_Cockpit_Berger_Intention/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.20 — Cockpit du berger d'intention
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_I_Fondations_Entreprise_Agentique/Chapitre_I.21_Feuille_Route_Transformation_Agentique/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.21 — Feuille de route de la transformation agentique
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_I_Fondations_Entreprise_Agentique/Chapitre_I.22_Gestion_Strategique_Portefeuille_Applicatif_APM_Cognitif/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.22 — Gestion stratégique du portefeuille applicatif (APM cognitif)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_I_Fondations_Entreprise_Agentique/Chapitre_I.23_Patrons_Modernisation_Agentification/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.23 — Patrons de modernisation et agentification
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_I_Fondations_Entreprise_Agentique/Chapitre_I.24_Industrialisation_Ingenierie_Plateforme/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.24 — Industrialisation et ingénierie de plateforme
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_I_Fondations_Entreprise_Agentique/Chapitre_I.25_Economie_Cognitive_Diplomatie_Algorithmique/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.25 — Économie cognitive et diplomatie algorithmique
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_I_Fondations_Entreprise_Agentique/Chapitre_I.26_Gestion_Risques_Systemiques_Superalignement/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.26 — Gestion des risques systémiques et superalignement
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_I_Fondations_Entreprise_Agentique/Chapitre_I.27_Prospective_Agent_Auto_Architecturant_AGI_Entreprise/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.27 — Prospective : agent auto-architecturant et AGI d'entreprise
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_I_Fondations_Entreprise_Agentique/Chapitre_I.28_Conclusion_Architecture_Intentionnelle_Sagesse_Collective/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.28 — Conclusion : architecture intentionnelle et sagesse collective
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_2" >
        
          
          <label class="md-nav__link" for="__nav_4_2" id="__nav_4_2_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Volume II — Infrastructure Agentique
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Volume II — Infrastructure Agentique
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_II_Infrastructure_Agentique/Chapitre_II.1_Ingenierie_Plateforme/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    II.1 — Ingénierie de plateforme
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_II_Infrastructure_Agentique/Chapitre_II.2_Fondamentaux_Apache_Kafka_Confluent/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    II.2 — Fondamentaux Apache Kafka et Confluent
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_II_Infrastructure_Agentique/Chapitre_II.3_Conception_Modelisation_Flux_Evenements/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    II.3 — Conception et modélisation des flux d'événements
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_II_Infrastructure_Agentique/Chapitre_II.4_Contrats_Donnees_Gouvernance_Semantique/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    II.4 — Contrats de données et gouvernance sémantique
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_II_Infrastructure_Agentique/Chapitre_II.5_Flux_Temps_Reel/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    II.5 — Flux temps réel
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_II_Infrastructure_Agentique/Chapitre_II.6_Google_Cloud_Vertex_AI/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    II.6 — Google Cloud et Vertex AI
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_II_Infrastructure_Agentique/Chapitre_II.7_Ingenierie_Contexte_RAG/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    II.7 — Ingénierie de contexte et RAG
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_II_Infrastructure_Agentique/Chapitre_II.8_Integration_Backbone_Evenementiel_Couche_Cognitive/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    II.8 — Intégration backbone événementiel et couche cognitive
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_II_Infrastructure_Agentique/Chapitre_II.9_Patrons_Architecturaux_Avances_AEM/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    II.9 — Patrons architecturaux avancés (AEM)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_II_Infrastructure_Agentique/Chapitre_II.10_Pipelines_CI_CD_Deploiement_Agents/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    II.10 — Pipelines CI/CD et déploiement d'agents
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_II_Infrastructure_Agentique/Chapitre_II.11_Observabilite_Comportementale_Monitoring/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    II.11 — Observabilité comportementale et monitoring
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_II_Infrastructure_Agentique/Chapitre_II.12_Tests_Evaluation_Simulation_Systemes_Multi_Agents/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    II.12 — Tests, évaluation et simulation de systèmes multi-agents
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_II_Infrastructure_Agentique/Chapitre_II.13_Paysage_Menaces_Securite_Systemes_Agentiques/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    II.13 — Paysage des menaces et sécurité des systèmes agentiques
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_II_Infrastructure_Agentique/Chapitre_II.14_Securisation_Infrastructure/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    II.14 — Sécurisation de l'infrastructure
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_II_Infrastructure_Agentique/Chapitre_II.15_Conformite_Reglementaire_Gestion_Confidentialite/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    II.15 — Conformité réglementaire et gestion de la confidentialité
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_3" checked>
        
          
          <label class="md-nav__link" for="__nav_4_3" id="__nav_4_3_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Volume III — Apache Kafka : Guide de l'Architecte
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Volume III — Apache Kafka : Guide de l'Architecte
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Chapitre_III.1_Decouvrir_Kafka/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    III.1 — Découvrir Kafka
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Chapitre_III.2_Architecture_Cluster_Kafka/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    III.2 — Architecture du cluster Kafka
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Chapitre_III.3_Clients_Kafka_Production/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    III.3 — Clients Kafka en production
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Chapitre_III.4_Applications_Consommatrices/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    III.4 — Applications consommatrices
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Chapitre_III.5_Cas_Utilisation_Kafka/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    III.5 — Cas d'utilisation Kafka
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Chapitre_III.6_Contrats_Donnees/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    III.6 — Contrats de données
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    III.7 — Patrons d'interaction Kafka
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    III.7 — Patrons d'interaction Kafka
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table des matières">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table des matières
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#patrons-dinteraction-kafka" class="md-nav__link">
    <span class="md-ellipsis">
      
        PATRONS D'INTERACTION KAFKA
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#iii71-notes-de-terrain-cas-problematiques" class="md-nav__link">
    <span class="md-ellipsis">
      
        III.7.1 Notes de Terrain : Cas Problématiques
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="III.7.1 Notes de Terrain : Cas Problématiques">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cas-1-le-systeme-de-commandes-incoherent" class="md-nav__link">
    <span class="md-ellipsis">
      
        Cas 1 : Le Système de Commandes Incohérent
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cas-2-la-tempete-de-retry" class="md-nav__link">
    <span class="md-ellipsis">
      
        Cas 2 : La Tempête de Retry
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cas-3-le-consommateur-lent-qui-bloque-tout" class="md-nav__link">
    <span class="md-ellipsis">
      
        Cas 3 : Le Consommateur Lent qui Bloque Tout
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cas-4-le-schema-poison" class="md-nav__link">
    <span class="md-ellipsis">
      
        Cas 4 : Le Schéma Poison
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cas-5-la-duplication-invisible" class="md-nav__link">
    <span class="md-ellipsis">
      
        Cas 5 : La Duplication Invisible
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#synthese-des-cas-problematiques" class="md-nav__link">
    <span class="md-ellipsis">
      
        Synthèse des Cas Problématiques
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#analyse-approfondie-patterns-de-resilience" class="md-nav__link">
    <span class="md-ellipsis">
      
        Analyse Approfondie : Patterns de Résilience
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implementation-technique-avec-kafka" class="md-nav__link">
    <span class="md-ellipsis">
      
        Implémentation Technique avec Kafka
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gouvernance-et-qualite-des-donnees" class="md-nav__link">
    <span class="md-ellipsis">
      
        Gouvernance et Qualité des Données
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#iii73-utilisation-de-kafka-connect" class="md-nav__link">
    <span class="md-ellipsis">
      
        III.7.3 Utilisation de Kafka Connect
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="III.7.3 Utilisation de Kafka Connect">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#le-role-de-kafka-connect" class="md-nav__link">
    <span class="md-ellipsis">
      
        Le Rôle de Kafka Connect
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patterns-dintegration-avec-kafka-connect" class="md-nav__link">
    <span class="md-ellipsis">
      
        Patterns d'Intégration avec Kafka Connect
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gestion-des-erreurs-dans-kafka-connect" class="md-nav__link">
    <span class="md-ellipsis">
      
        Gestion des Erreurs dans Kafka Connect
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitoring-de-kafka-connect" class="md-nav__link">
    <span class="md-ellipsis">
      
        Monitoring de Kafka Connect
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#transformations-single-message-transforms-smt" class="md-nav__link">
    <span class="md-ellipsis">
      
        Transformations Single Message Transforms (SMT)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scalabilite-et-haute-disponibilite-de-kafka-connect" class="md-nav__link">
    <span class="md-ellipsis">
      
        Scalabilité et Haute Disponibilité de Kafka Connect
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#iii74-assurer-la-garantie-de-livraison" class="md-nav__link">
    <span class="md-ellipsis">
      
        III.7.4 Assurer la Garantie de Livraison
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="III.7.4 Assurer la Garantie de Livraison">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#les-trois-semantiques-de-livraison" class="md-nav__link">
    <span class="md-ellipsis">
      
        Les Trois Sémantiques de Livraison
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#comparaison-des-semantiques" class="md-nav__link">
    <span class="md-ellipsis">
      
        Comparaison des Sémantiques
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pattern-outbox-transactionnel" class="md-nav__link">
    <span class="md-ellipsis">
      
        Pattern Outbox Transactionnel
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#idempotence-cote-consommateur" class="md-nav__link">
    <span class="md-ellipsis">
      
        Idempotence Côté Consommateur
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dead-letter-queue-dlq-pattern" class="md-nav__link">
    <span class="md-ellipsis">
      
        Dead Letter Queue (DLQ) Pattern
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#traitement-des-messages-dlq" class="md-nav__link">
    <span class="md-ellipsis">
      
        Traitement des Messages DLQ
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patterns-avances-de-communication" class="md-nav__link">
    <span class="md-ellipsis">
      
        Patterns Avancés de Communication
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patterns-de-partitionnement-et-ordering" class="md-nav__link">
    <span class="md-ellipsis">
      
        Patterns de Partitionnement et Ordering
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#iii75-resume" class="md-nav__link">
    <span class="md-ellipsis">
      
        III.7.5 Résumé
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="III.7.5 Résumé">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#lecons-des-cas-problematiques" class="md-nav__link">
    <span class="md-ellipsis">
      
        Leçons des Cas Problématiques
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#data-mesh-avec-kafka" class="md-nav__link">
    <span class="md-ellipsis">
      
        Data Mesh avec Kafka
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#kafka-connect-pour-lintegration" class="md-nav__link">
    <span class="md-ellipsis">
      
        Kafka Connect pour l'Intégration
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#garanties-de-livraison" class="md-nav__link">
    <span class="md-ellipsis">
      
        Garanties de Livraison
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#principes-directeurs-pour-larchitecte" class="md-nav__link">
    <span class="md-ellipsis">
      
        Principes Directeurs pour l'Architecte
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vers-le-chapitre-suivant" class="md-nav__link">
    <span class="md-ellipsis">
      
        Vers le Chapitre Suivant
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Chapitre_III.8_Conception_Application_Streaming/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    III.8 — Conception d'application streaming
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Chapitre_III.9_Gestion_Kafka_Entreprise/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    III.9 — Gestion Kafka en entreprise
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Chapitre_III.10_Organisation_Projet_Kafka/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    III.10 — Organisation d'un projet Kafka
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Chapitre_III.11_Operer_Kafka/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    III.11 — Opérer Kafka
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Chapitre_III.12_Avenir_Kafka/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    III.12 — L'avenir de Kafka
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_4" >
        
          
          <label class="md-nav__link" for="__nav_4_4" id="__nav_4_4_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Volume IV — Apache Iceberg et Lakehouse
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Volume IV — Apache Iceberg et Lakehouse
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_IV_Apache_Iceberg_Lakehouse/Chapitre_IV.1_Monde_Lakehouse_Iceberg/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    IV.1 — Le monde Lakehouse et Iceberg
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_IV_Apache_Iceberg_Lakehouse/Chapitre_IV.2_Anatomie_Technique/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    IV.2 — Anatomie technique
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_IV_Apache_Iceberg_Lakehouse/Chapitre_IV.3_Mise_Pratique/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    IV.3 — Mise en pratique
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_IV_Apache_Iceberg_Lakehouse/Chapitre_IV.4_Preparer_Passage_Iceberg/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    IV.4 — Préparer le passage à Iceberg
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_IV_Apache_Iceberg_Lakehouse/Chapitre_IV.5_Selection_Couche_Stockage/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    IV.5 — Sélection de la couche de stockage
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_IV_Apache_Iceberg_Lakehouse/Chapitre_IV.6_Architecture_Couche_Ingestion/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    IV.6 — Architecture de la couche d'ingestion
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_IV_Apache_Iceberg_Lakehouse/Chapitre_IV.7_Implementation_Couche_Catalogue/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    IV.7 — Implémentation de la couche catalogue
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_IV_Apache_Iceberg_Lakehouse/Chapitre_IV.8_Conception_Couche_Federation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    IV.8 — Conception de la couche de fédération
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_IV_Apache_Iceberg_Lakehouse/Chapitre_IV.9_Comprendre_Couche_Consommation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    IV.9 — Comprendre la couche de consommation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_IV_Apache_Iceberg_Lakehouse/Chapitre_IV.10_Maintenir_Lakehouse_Production/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    IV.10 — Maintenir le Lakehouse en production
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_IV_Apache_Iceberg_Lakehouse/Chapitre_IV.11_Operationnaliser_Apache_Iceberg/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    IV.11 — Opérationnaliser Apache Iceberg
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_IV_Apache_Iceberg_Lakehouse/Chapitre_IV.12_Evolution_Streaming_Lakehouse/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    IV.12 — Évolution du streaming Lakehouse
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_IV_Apache_Iceberg_Lakehouse/Chapitre_IV.13_Securite_Gouvernance_Conformite/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    IV.13 — Sécurité, gouvernance et conformité
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_IV_Apache_Iceberg_Lakehouse/Chapitre_IV.14_Integration_Microsoft_Fabric_PowerBI/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    IV.14 — Intégration Microsoft Fabric et Power BI
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_IV_Apache_Iceberg_Lakehouse/Chapitre_IV.15_Contexte_Canadien_Etudes_Cas/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    IV.15 — Contexte canadien et études de cas
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_IV_Apache_Iceberg_Lakehouse/Chapitre_IV.16_Conclusion_Perspectives_2026_2030/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    IV.16 — Conclusion et perspectives 2026-2030
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_IV_Apache_Iceberg_Lakehouse/Chapitre_IV.Annexe_A_Specification_Apache_Iceberg/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Annexe A — Spécification Apache Iceberg
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_IV_Apache_Iceberg_Lakehouse/Chapitre_IV.Annexe_B_Glossaire/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Annexe B — Glossaire
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_5" >
        
          
          <label class="md-nav__link" for="__nav_4_5" id="__nav_4_5_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Volume V — Développeur Renaissance
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Volume V — Développeur Renaissance
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_V_Developpeur_Renaissance/Chapitre_V.0_Introduction/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    V.0 — Introduction
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_V_Developpeur_Renaissance/Chapitre_V.1_Convergence_Ages_Or/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    V.1 — Convergence des âges d'or
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_V_Developpeur_Renaissance/Chapitre_V.2_Curiosite_Appliquee/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    V.2 — Curiosité appliquée
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_V_Developpeur_Renaissance/Chapitre_V.3_Pensee_Systemique/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    V.3 — Pensée systémique
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_V_Developpeur_Renaissance/Chapitre_V.4_Nouvelle_Communication/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    V.4 — Nouvelle communication
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_V_Developpeur_Renaissance/Chapitre_V.5_Imperatif_Qualite_Responsabilite/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    V.5 — Impératif qualité et responsabilité
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_V_Developpeur_Renaissance/Chapitre_V.6_Capital_Humain_Profil_Polymathe/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    V.6 — Capital humain et profil polymathe
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_V_Developpeur_Renaissance/Chapitre_V.7_Art_Batir_Futur/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    V.7 — L'art de bâtir le futur
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_V_Developpeur_Renaissance/Chapitre_V.8_Bibliotheque_Developpeur_Renaissance/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    V.8 — Bibliothèque du développeur Renaissance
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_V_Developpeur_Renaissance/Chapitre_V.9_Mandat/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    V.9 — Mandat
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_V_Developpeur_Renaissance/Chapitre_V.10_Spec_Driven_Development/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    V.10 — Spec-Driven Development
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="chapitre-iii7">Chapitre III.7<a class="headerlink" href="#chapitre-iii7" title="Permanent link">&para;</a></h1>
<h2 id="patrons-dinteraction-kafka">PATRONS D'INTERACTION KAFKA<a class="headerlink" href="#patrons-dinteraction-kafka" title="Permanent link">&para;</a></h2>
<hr />
<blockquote>
<p><em>« Les patterns ne sont pas des solutions ; ce sont des vocabulaires partagés qui permettent aux équipes de communiquer efficacement sur des problèmes complexes. »</em></p>
<p>— Gregor Hohpe, Enterprise Integration Patterns</p>
</blockquote>
<hr />
<p>Le chapitre précédent a établi les fondations des contrats de données — les accords qui définissent la structure et la sémantique des messages échangés. Mais un contrat sans contexte d'utilisation reste abstrait. Comment ces messages circulent-ils ? Quels patterns gouvernent les interactions entre producteurs et consommateurs ? Comment garantir la fiabilité dans un système distribué ?</p>
<p>Ce chapitre explore les patrons d'interaction Kafka : les modèles architecturaux éprouvés qui structurent la communication événementielle à l'échelle de l'entreprise. Nous commencerons par des cas problématiques réels qui illustrent pourquoi ces patterns sont nécessaires, puis nous examinerons l'implémentation d'un maillage de données (data mesh), l'utilisation de Kafka Connect pour l'intégration, et les mécanismes qui garantissent la livraison fiable des messages.</p>
<hr />
<h2 id="iii71-notes-de-terrain-cas-problematiques">III.7.1 Notes de Terrain : Cas Problématiques<a class="headerlink" href="#iii71-notes-de-terrain-cas-problematiques" title="Permanent link">&para;</a></h2>
<p>Avant d'explorer les solutions, examinons les problèmes. Les cas suivants, tirés de projets réels, illustrent les défis que les patrons d'interaction Kafka sont conçus pour résoudre.</p>
<h3 id="cas-1-le-systeme-de-commandes-incoherent">Cas 1 : Le Système de Commandes Incohérent<a class="headerlink" href="#cas-1-le-systeme-de-commandes-incoherent" title="Permanent link">&para;</a></h3>
<p><strong>Contexte</strong> : Une plateforme e-commerce avec trois services — Commandes, Inventaire, et Paiements — communiquant via Kafka.</p>
<p><strong>Architecture initiale</strong> :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>┌─────────────────┐      ┌─────────────────┐      ┌─────────────────┐
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>│   Service       │      │   Service       │      │   Service       │
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>│   Commandes     │─────▶│   Inventaire    │─────▶│   Paiements     │
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>│                 │      │                 │      │                 │
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>│  [OrderCreated] │      │ [InventoryRes.] │      │ [PaymentProc.]  │
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>└─────────────────┘      └─────────────────┘      └─────────────────┘
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>        │                        │                        │
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>        ▼                        ▼                        ▼
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>   ┌─────────┐             ┌─────────┐             ┌─────────┐
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>   │ DB      │             │ DB      │             │ DB      │
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>   │ Orders  │             │ Inventory│            │ Payments│
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>   └─────────┘             └─────────┘             └─────────┘
</code></pre></div>
<p><strong>Le problème</strong> : Le service Commandes créait une commande dans sa base de données, puis publiait un événement <code>OrderCreated</code>. Mais entre l'écriture en base et la publication, plusieurs défaillances pouvaient survenir :</p>
<ol>
<li>L'écriture réussit, mais le service crashe avant de publier → Commande créée mais jamais traitée</li>
<li>L'écriture échoue, mais l'événement est publié → Inventaire réservé pour une commande inexistante</li>
<li>L'événement est publié deux fois (retry après timeout) → Double réservation d'inventaire</li>
</ol>
<p><strong>Impact business</strong> : En 3 mois de production, 0.3% des commandes présentaient des incohérences. Sur 100 000 commandes/jour, cela représentait 300 cas problématiques quotidiens nécessitant une intervention manuelle.</p>
<p><strong>Symptômes observés</strong> :
- Clients facturés pour des commandes jamais expédiées
- Stock négatif dans le système d'inventaire
- Réconciliations comptables impossibles</p>
<blockquote>
<p><strong>Note de terrain</strong></p>
<p><em>Diagnostic</em> : L'équipe a passé 2 semaines à déboguer ce qu'ils pensaient être un « bug aléatoire ». Le vrai problème était architectural : l'absence de garantie transactionnelle entre l'écriture en base et la publication de l'événement.</p>
<p><em>Solution appliquée</em> : Pattern Outbox Transactionnel (détaillé plus loin dans ce chapitre).</p>
<p><em>Résultat</em> : Incohérences réduites à 0%, temps de réconciliation divisé par 10.</p>
</blockquote>
<h3 id="cas-2-la-tempete-de-retry">Cas 2 : La Tempête de Retry<a class="headerlink" href="#cas-2-la-tempete-de-retry" title="Permanent link">&para;</a></h3>
<p><strong>Contexte</strong> : Un service de notification qui envoie des emails suite aux événements de commande.</p>
<p><strong>Le problème</strong> : Le service de notification consommait les événements et appelait un service SMTP externe. En cas d'échec SMTP (timeout, service indisponible), le message n'était pas commité, causant un retry.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>Consumer                    SMTP Service               Kafka
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>   │                            │                        │
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a>   │◀────────── OrderShipped ───────────────────────────│
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a>   │                            │                        │
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a>   │────── Send Email ─────────▶│                        │
<a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a>   │                            │ (timeout 30s)          │
<a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a>   │◀───── Timeout Error ───────│                        │
<a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a>   │                            │                        │
<a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a>   │ (no commit, rebalance)     │                        │
<a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a>   │                            │                        │
<a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a>   │◀────────── OrderShipped (replay) ──────────────────│
<a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a>   │                            │                        │
<a id="__codelineno-1-13" name="__codelineno-1-13" href="#__codelineno-1-13"></a>   │────── Send Email ─────────▶│                        │
<a id="__codelineno-1-14" name="__codelineno-1-14" href="#__codelineno-1-14"></a>   │                            │ (timeout 30s)          │
<a id="__codelineno-1-15" name="__codelineno-1-15" href="#__codelineno-1-15"></a>   │◀───── Timeout Error ───────│                        │
<a id="__codelineno-1-16" name="__codelineno-1-16" href="#__codelineno-1-16"></a>   │                            │                        │
<a id="__codelineno-1-17" name="__codelineno-1-17" href="#__codelineno-1-17"></a>   └─── (boucle infinie) ───────┴────────────────────────┘
</code></pre></div>
<p><strong>Impact</strong> : Quand le service SMTP est devenu lent (pas indisponible, juste lent), le consumer a commencé à boucler. Chaque retry augmentait la charge sur le SMTP, aggravant la lenteur. En 30 minutes :
- 50 000 tentatives d'envoi pour 500 emails
- Service SMTP saturé
- Alertes en cascade sur tous les systèmes dépendants</p>
<p><strong>Symptômes</strong> :
- Lag Kafka explosant (de 0 à 100 000 messages)
- CPU du consumer à 100%
- Timeouts en cascade</p>
<blockquote>
<p><strong>Anti-patron</strong></p>
<p><em>Erreur fondamentale</em> : Traiter un appel externe (SMTP) comme une opération synchrone bloquante dans un consumer Kafka.</p>
<p><em>Règle violée</em> : Ne jamais bloquer un consumer Kafka sur une opération externe non bornée en temps.</p>
<p><em>Pattern correctif</em> : Dead Letter Queue + Circuit Breaker + Traitement asynchrone avec backoff exponentiel.</p>
</blockquote>
<h3 id="cas-3-le-consommateur-lent-qui-bloque-tout">Cas 3 : Le Consommateur Lent qui Bloque Tout<a class="headerlink" href="#cas-3-le-consommateur-lent-qui-bloque-tout" title="Permanent link">&para;</a></h3>
<p><strong>Contexte</strong> : Un topic partagé par 5 services consommateurs avec des besoins de traitement très différents.</p>
<p><strong>Architecture</strong> :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>                    Topic: order-events
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>                           │
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a>       ┌───────────────────┼───────────────────┐
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a>       │                   │                   │
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a>       ▼                   ▼                   ▼
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a>┌─────────────┐     ┌─────────────┐     ┌─────────────┐
<a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a>│ Analytics   │     │ Notification│     │ ML Training │
<a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a>│ (rapide)    │     │ (moyen)     │     │ (très lent) │
<a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a>│ ~1ms/msg    │     │ ~50ms/msg   │     │ ~2s/msg     │
<a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a>└─────────────┘     └─────────────┘     └─────────────┘
</code></pre></div>
<p><strong>Le problème</strong> : Tous les services étaient dans le même consumer group pour « simplifier la gestion ». Quand le service ML (qui faisait du feature engineering complexe sur chaque événement) prenait du retard :</p>
<ol>
<li>Le rebalancing Kafka redistribuait ses partitions aux autres consumers</li>
<li>Les autres services recevaient des messages qu'ils ne savaient pas traiter</li>
<li>Erreurs en cascade, puis crash du groupe entier</li>
</ol>
<p><strong>Impact</strong> : Indisponibilité de tous les services de notification pendant 4 heures le jour du Black Friday.</p>
<blockquote>
<p><strong>Décision architecturale</strong></p>
<p><em>Problème</em> : Comment permettre à des consommateurs avec des vitesses de traitement très différentes de consommer le même topic ?</p>
<p><em>Solution</em> : Consumer groups séparés par service. Chaque service a son propre groupe et progresse à son rythme.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a>                    Topic: order-events
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a>                           │
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a>       ┌───────────────────┼───────────────────┐
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a>       │                   │                   │
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a>       ▼                   ▼                   ▼
<a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a>  Group: analytics    Group: notif       Group: ml-training
<a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a>  (offset: 1000)     (offset: 950)       (offset: 500)
</code></pre></div>
<p><em>Trade-off</em> : Plus de ressources (chaque groupe lit toutes les partitions), mais isolation complète.</p>
</blockquote>
<h3 id="cas-4-le-schema-poison">Cas 4 : Le Schéma Poison<a class="headerlink" href="#cas-4-le-schema-poison" title="Permanent link">&para;</a></h3>
<p><strong>Contexte</strong> : Un producteur a déployé une nouvelle version de schéma avec un bug — un champ obligatoire était mal formaté.</p>
<p><strong>Le problème</strong> : Les 50 000 messages produits pendant 2 heures étaient tous invalides. Les consumers ne pouvaient pas les désérialiser.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a>Producer (buggy)           Kafka              Consumer
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a>     │                       │                    │
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a>     │── [Invalid Avro] ────▶│                    │
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a>     │── [Invalid Avro] ────▶│                    │
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a>     │── [Invalid Avro] ────▶│                    │
<a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a>     │        ...            │                    │
<a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a>     │                       │                    │
<a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a>     │                       │◀── Poll ──────────│
<a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a>     │                       │                    │
<a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a>     │                       │── [Invalid] ──────▶│
<a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a>     │                       │               CRASH│
<a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a>     │                       │                    │
<a id="__codelineno-4-13" name="__codelineno-4-13" href="#__codelineno-4-13"></a>     │                       │◀── Poll (retry) ──│
<a id="__codelineno-4-14" name="__codelineno-4-14" href="#__codelineno-4-14"></a>     │                       │── [Invalid] ──────▶│
<a id="__codelineno-4-15" name="__codelineno-4-15" href="#__codelineno-4-15"></a>     │                       │               CRASH│
</code></pre></div>
<p><strong>Impact</strong> : 
- Tous les consumers en boucle de crash
- Impossible de « sauter » les messages invalides sans intervention manuelle
- 6 heures d'indisponibilité totale du pipeline</p>
<blockquote>
<p><strong>Note de terrain</strong></p>
<p><em>Cause racine</em> : Validation de schéma insuffisante côté producteur. Le Schema Registry validait la compatibilité structurelle, mais pas la validité des données.</p>
<p><em>Solutions implémentées</em> :
1. Validation applicative avant publication
2. Dead Letter Queue pour les messages non désérialisables
3. Consumer avec gestion d'erreur gracieuse (log + skip)
4. Alertes sur le taux d'erreur de désérialisation</p>
</blockquote>
<h3 id="cas-5-la-duplication-invisible">Cas 5 : La Duplication Invisible<a class="headerlink" href="#cas-5-la-duplication-invisible" title="Permanent link">&para;</a></h3>
<p><strong>Contexte</strong> : Un système de facturation qui crée des factures à partir des événements de commande.</p>
<p><strong>Le problème</strong> : Le consumer utilisait <code>enable.auto.commit=true</code> avec un traitement qui pouvait prendre plus de 5 secondes (le délai d'auto-commit). Scénario :</p>
<ol>
<li>Consumer reçoit le message, commence le traitement</li>
<li>Après 5 secondes, auto-commit se déclenche (message marqué comme traité)</li>
<li>Le traitement continue pendant 10 secondes</li>
<li>À la seconde 12, le traitement échoue</li>
<li>Le consumer crashe, redémarre</li>
<li>Le message est considéré comme traité (déjà commité) → Message perdu</li>
</ol>
<p>Inversement, si le consumer crashait AVANT l'auto-commit :
1. Consumer reçoit le message, traite en 3 secondes
2. Traitement réussi, facture créée
3. Consumer crashe avant l'auto-commit
4. Au redémarrage, le message est rejoué → Facture en double</p>
<p><strong>Impact</strong> : 0.5% des factures étaient soit manquantes, soit en double. Pour une entreprise avec 10 000 factures/mois, cela représentait 50 cas de contentieux potentiels.</p>
<blockquote>
<p><strong>Décision architecturale</strong></p>
<p><em>Règle absolue</em> : Ne JAMAIS utiliser <code>enable.auto.commit=true</code> pour des traitements critiques.</p>
<p><em>Pattern</em> : Commit manuel après traitement réussi, avec idempotence côté consommateur.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="c1">// Pattern correct</span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="w">    </span><span class="n">ConsumerRecords</span><span class="o">&lt;</span><span class="n">K</span><span class="p">,</span><span class="w"> </span><span class="n">V</span><span class="o">&gt;</span><span class="w"> </span><span class="n">records</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">consumer</span><span class="p">.</span><span class="na">poll</span><span class="p">(</span><span class="n">Duration</span><span class="p">.</span><span class="na">ofMillis</span><span class="p">(</span><span class="mi">100</span><span class="p">));</span>
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">ConsumerRecord</span><span class="o">&lt;</span><span class="n">K</span><span class="p">,</span><span class="w"> </span><span class="n">V</span><span class="o">&gt;</span><span class="w"> </span><span class="n">record</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">records</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a><span class="w">            </span><span class="c1">// Traitement idempotent</span>
<a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a><span class="w">            </span><span class="n">processIdempotent</span><span class="p">(</span><span class="n">record</span><span class="p">);</span>
<a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a><span class="w">            </span><span class="c1">// Commit après succès</span>
<a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a><span class="w">            </span><span class="n">consumer</span><span class="p">.</span><span class="na">commitSync</span><span class="p">(</span><span class="n">Collections</span><span class="p">.</span><span class="na">singletonMap</span><span class="p">(</span>
<a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a><span class="w">                </span><span class="k">new</span><span class="w"> </span><span class="n">TopicPartition</span><span class="p">(</span><span class="n">record</span><span class="p">.</span><span class="na">topic</span><span class="p">(),</span><span class="w"> </span><span class="n">record</span><span class="p">.</span><span class="na">partition</span><span class="p">()),</span>
<a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a><span class="w">                </span><span class="k">new</span><span class="w"> </span><span class="n">OffsetAndMetadata</span><span class="p">(</span><span class="n">record</span><span class="p">.</span><span class="na">offset</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-5-12" name="__codelineno-5-12" href="#__codelineno-5-12"></a><span class="w">            </span><span class="p">));</span>
<a id="__codelineno-5-13" name="__codelineno-5-13" href="#__codelineno-5-13"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-5-14" name="__codelineno-5-14" href="#__codelineno-5-14"></a><span class="w">            </span><span class="c1">// Gestion d&#39;erreur explicite</span>
<a id="__codelineno-5-15" name="__codelineno-5-15" href="#__codelineno-5-15"></a><span class="w">            </span><span class="n">handleError</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">);</span>
<a id="__codelineno-5-16" name="__codelineno-5-16" href="#__codelineno-5-16"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-5-17" name="__codelineno-5-17" href="#__codelineno-5-17"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-5-18" name="__codelineno-5-18" href="#__codelineno-5-18"></a><span class="p">}</span>
</code></pre></div>
</blockquote>
<h3 id="synthese-des-cas-problematiques">Synthèse des Cas Problématiques<a class="headerlink" href="#synthese-des-cas-problematiques" title="Permanent link">&para;</a></h3>
<p>Ces cas illustrent les défis fondamentaux des architectures événementielles :</p>
<table>
<thead>
<tr>
<th>Cas</th>
<th>Problème</th>
<th>Pattern de solution</th>
</tr>
</thead>
<tbody>
<tr>
<td>Commandes incohérentes</td>
<td>Atomicité DB + Event</td>
<td>Outbox Transactionnel</td>
</tr>
<tr>
<td>Tempête de retry</td>
<td>Appel externe bloquant</td>
<td>Dead Letter Queue, Circuit Breaker</td>
</tr>
<tr>
<td>Consumer lent</td>
<td>Isolation insuffisante</td>
<td>Consumer groups séparés</td>
</tr>
<tr>
<td>Schéma poison</td>
<td>Messages non désérialisables</td>
<td>DLQ, validation, skip gracieux</td>
</tr>
<tr>
<td>Duplication</td>
<td>Auto-commit non fiable</td>
<td>Commit manuel, idempotence</td>
</tr>
</tbody>
</table>
<h3 id="analyse-approfondie-patterns-de-resilience">Analyse Approfondie : Patterns de Résilience<a class="headerlink" href="#analyse-approfondie-patterns-de-resilience" title="Permanent link">&para;</a></h3>
<p>Les cas présentés convergent vers un ensemble de patterns de résilience qui forment le socle de toute architecture Kafka robuste.</p>
<p><strong>Circuit Breaker pour les Dépendances Externes</strong></p>
<p>Quand un consumer dépend d'un service externe (API, base de données, service SMTP), le pattern Circuit Breaker prévient les cascades de défaillances.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">CircuitBreakerConsumer</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a>
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">CircuitBreaker</span><span class="w"> </span><span class="n">circuitBreaker</span><span class="p">;</span>
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">ExternalService</span><span class="w"> </span><span class="n">externalService</span><span class="p">;</span>
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">DeadLetterQueue</span><span class="w"> </span><span class="n">dlq</span><span class="p">;</span>
<a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a>
<a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">CircuitBreakerConsumer</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">circuitBreaker</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CircuitBreaker</span><span class="p">.</span><span class="na">builder</span><span class="p">(</span><span class="s">&quot;external-service&quot;</span><span class="p">)</span>
<a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a><span class="w">            </span><span class="p">.</span><span class="na">failureRateThreshold</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span><span class="w">           </span><span class="c1">// Ouvre après 50% d&#39;échecs</span>
<a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a><span class="w">            </span><span class="p">.</span><span class="na">waitDurationInOpenState</span><span class="p">(</span><span class="n">Duration</span><span class="p">.</span><span class="na">ofSeconds</span><span class="p">(</span><span class="mi">30</span><span class="p">))</span>
<a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a><span class="w">            </span><span class="p">.</span><span class="na">slidingWindowSize</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="w">              </span><span class="c1">// Sur les 10 derniers appels</span>
<a id="__codelineno-6-12" name="__codelineno-6-12" href="#__codelineno-6-12"></a><span class="w">            </span><span class="p">.</span><span class="na">build</span><span class="p">();</span>
<a id="__codelineno-6-13" name="__codelineno-6-13" href="#__codelineno-6-13"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-6-14" name="__codelineno-6-14" href="#__codelineno-6-14"></a>
<a id="__codelineno-6-15" name="__codelineno-6-15" href="#__codelineno-6-15"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">process</span><span class="p">(</span><span class="n">ConsumerRecord</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Event</span><span class="o">&gt;</span><span class="w"> </span><span class="n">record</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-16" name="__codelineno-6-16" href="#__codelineno-6-16"></a><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-17" name="__codelineno-6-17" href="#__codelineno-6-17"></a><span class="w">            </span><span class="c1">// Le circuit breaker protège l&#39;appel externe</span>
<a id="__codelineno-6-18" name="__codelineno-6-18" href="#__codelineno-6-18"></a><span class="w">            </span><span class="n">circuitBreaker</span><span class="p">.</span><span class="na">executeSupplier</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-19" name="__codelineno-6-19" href="#__codelineno-6-19"></a><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">externalService</span><span class="p">.</span><span class="na">call</span><span class="p">(</span><span class="n">record</span><span class="p">.</span><span class="na">value</span><span class="p">());</span>
<a id="__codelineno-6-20" name="__codelineno-6-20" href="#__codelineno-6-20"></a><span class="w">            </span><span class="p">});</span>
<a id="__codelineno-6-21" name="__codelineno-6-21" href="#__codelineno-6-21"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">CircuitBreakerOpenException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-22" name="__codelineno-6-22" href="#__codelineno-6-22"></a><span class="w">            </span><span class="c1">// Circuit ouvert : envoyer au DLQ pour retry ultérieur</span>
<a id="__codelineno-6-23" name="__codelineno-6-23" href="#__codelineno-6-23"></a><span class="w">            </span><span class="n">log</span><span class="p">.</span><span class="na">warn</span><span class="p">(</span><span class="s">&quot;Circuit breaker open, sending to DLQ&quot;</span><span class="p">);</span>
<a id="__codelineno-6-24" name="__codelineno-6-24" href="#__codelineno-6-24"></a><span class="w">            </span><span class="n">dlq</span><span class="p">.</span><span class="na">send</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Circuit breaker open - external service unavailable&quot;</span><span class="p">);</span>
<a id="__codelineno-6-25" name="__codelineno-6-25" href="#__codelineno-6-25"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-26" name="__codelineno-6-26" href="#__codelineno-6-26"></a><span class="w">            </span><span class="c1">// Autre erreur : retry normal ou DLQ selon le type</span>
<a id="__codelineno-6-27" name="__codelineno-6-27" href="#__codelineno-6-27"></a><span class="w">            </span><span class="n">handleError</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">);</span>
<a id="__codelineno-6-28" name="__codelineno-6-28" href="#__codelineno-6-28"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-6-29" name="__codelineno-6-29" href="#__codelineno-6-29"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-6-30" name="__codelineno-6-30" href="#__codelineno-6-30"></a><span class="p">}</span>
</code></pre></div>
<p><strong>États du Circuit Breaker</strong> :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a>┌─────────────────────────────────────────────────────────────────────────┐
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a>│                    États du Circuit Breaker                             │
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a>│                                                                         │
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a>│     CLOSED                   OPEN                    HALF-OPEN          │
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a>│  ┌─────────────┐         ┌─────────────┐         ┌─────────────┐       │
<a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a>│  │ Appels      │         │ Appels      │         │ Appels      │       │
<a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a>│  │ autorisés   │────────▶│ rejetés     │────────▶│ limités     │       │
<a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a>│  │             │ échecs  │ immédiatement│ timeout │ (test)      │       │
<a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a>│  │             │ &gt; seuil │             │         │             │       │
<a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a>│  └─────────────┘         └─────────────┘         └──────┬──────┘       │
<a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a>│        ▲                                                │              │
<a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a>│        │                                                │              │
<a id="__codelineno-7-13" name="__codelineno-7-13" href="#__codelineno-7-13"></a>│        │                 succès                         │              │
<a id="__codelineno-7-14" name="__codelineno-7-14" href="#__codelineno-7-14"></a>│        └────────────────────────────────────────────────┘              │
<a id="__codelineno-7-15" name="__codelineno-7-15" href="#__codelineno-7-15"></a>│                                                                         │
<a id="__codelineno-7-16" name="__codelineno-7-16" href="#__codelineno-7-16"></a>│  Métriques clés:                                                       │
<a id="__codelineno-7-17" name="__codelineno-7-17" href="#__codelineno-7-17"></a>│  - failure_rate: Taux d&#39;échec courant                                  │
<a id="__codelineno-7-18" name="__codelineno-7-18" href="#__codelineno-7-18"></a>│  - state: CLOSED/OPEN/HALF_OPEN                                        │
<a id="__codelineno-7-19" name="__codelineno-7-19" href="#__codelineno-7-19"></a>│  - calls_not_permitted: Appels rejetés par circuit ouvert             │
<a id="__codelineno-7-20" name="__codelineno-7-20" href="#__codelineno-7-20"></a>└─────────────────────────────────────────────────────────────────────────┘
</code></pre></div>
<p><strong>Backpressure et Rate Limiting</strong></p>
<p>Quand un consumer ne peut pas suivre le rythme de production, le backpressure permet de contrôler le flux.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">RateLimitedConsumer</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a>
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">RateLimiter</span><span class="w"> </span><span class="n">rateLimiter</span><span class="p">;</span>
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Semaphore</span><span class="w"> </span><span class="n">concurrencyLimiter</span><span class="p">;</span>
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a>
<a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">RateLimitedConsumer</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">maxRps</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">maxConcurrent</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">rateLimiter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RateLimiter</span><span class="p">.</span><span class="na">create</span><span class="p">(</span><span class="n">maxRps</span><span class="p">);</span>
<a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">concurrencyLimiter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Semaphore</span><span class="p">(</span><span class="n">maxConcurrent</span><span class="p">);</span>
<a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-8-10" name="__codelineno-8-10" href="#__codelineno-8-10"></a>
<a id="__codelineno-8-11" name="__codelineno-8-11" href="#__codelineno-8-11"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">consumeWithBackpressure</span><span class="p">(</span><span class="n">ConsumerRecords</span><span class="o">&lt;</span><span class="n">K</span><span class="p">,</span><span class="w"> </span><span class="n">V</span><span class="o">&gt;</span><span class="w"> </span><span class="n">records</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-12" name="__codelineno-8-12" href="#__codelineno-8-12"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">ConsumerRecord</span><span class="o">&lt;</span><span class="n">K</span><span class="p">,</span><span class="w"> </span><span class="n">V</span><span class="o">&gt;</span><span class="w"> </span><span class="n">record</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">records</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-13" name="__codelineno-8-13" href="#__codelineno-8-13"></a><span class="w">            </span><span class="c1">// Limiter le débit</span>
<a id="__codelineno-8-14" name="__codelineno-8-14" href="#__codelineno-8-14"></a><span class="w">            </span><span class="n">rateLimiter</span><span class="p">.</span><span class="na">acquire</span><span class="p">();</span>
<a id="__codelineno-8-15" name="__codelineno-8-15" href="#__codelineno-8-15"></a>
<a id="__codelineno-8-16" name="__codelineno-8-16" href="#__codelineno-8-16"></a><span class="w">            </span><span class="c1">// Limiter la concurrence</span>
<a id="__codelineno-8-17" name="__codelineno-8-17" href="#__codelineno-8-17"></a><span class="w">            </span><span class="n">concurrencyLimiter</span><span class="p">.</span><span class="na">acquire</span><span class="p">();</span>
<a id="__codelineno-8-18" name="__codelineno-8-18" href="#__codelineno-8-18"></a><span class="w">            </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-19" name="__codelineno-8-19" href="#__codelineno-8-19"></a><span class="w">                </span><span class="n">processAsync</span><span class="p">(</span><span class="n">record</span><span class="p">).</span><span class="na">whenComplete</span><span class="p">((</span><span class="n">result</span><span class="p">,</span><span class="w"> </span><span class="n">error</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-20" name="__codelineno-8-20" href="#__codelineno-8-20"></a><span class="w">                    </span><span class="n">concurrencyLimiter</span><span class="p">.</span><span class="na">release</span><span class="p">();</span>
<a id="__codelineno-8-21" name="__codelineno-8-21" href="#__codelineno-8-21"></a><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">error</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-22" name="__codelineno-8-22" href="#__codelineno-8-22"></a><span class="w">                        </span><span class="n">handleError</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="w"> </span><span class="n">error</span><span class="p">);</span>
<a id="__codelineno-8-23" name="__codelineno-8-23" href="#__codelineno-8-23"></a><span class="w">                    </span><span class="p">}</span>
<a id="__codelineno-8-24" name="__codelineno-8-24" href="#__codelineno-8-24"></a><span class="w">                </span><span class="p">});</span>
<a id="__codelineno-8-25" name="__codelineno-8-25" href="#__codelineno-8-25"></a><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-26" name="__codelineno-8-26" href="#__codelineno-8-26"></a><span class="w">                </span><span class="n">concurrencyLimiter</span><span class="p">.</span><span class="na">release</span><span class="p">();</span>
<a id="__codelineno-8-27" name="__codelineno-8-27" href="#__codelineno-8-27"></a><span class="w">                </span><span class="k">throw</span><span class="w"> </span><span class="n">e</span><span class="p">;</span>
<a id="__codelineno-8-28" name="__codelineno-8-28" href="#__codelineno-8-28"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-8-29" name="__codelineno-8-29" href="#__codelineno-8-29"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-8-30" name="__codelineno-8-30" href="#__codelineno-8-30"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-8-31" name="__codelineno-8-31" href="#__codelineno-8-31"></a><span class="p">}</span>
</code></pre></div>
<p><strong>Bulkhead Pattern (Isolation des Ressources)</strong></p>
<p>Le pattern Bulkhead isole les ressources pour éviter qu'une défaillance dans un domaine n'affecte les autres.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a>┌─────────────────────────────────────────────────────────────────────────┐
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a>│                    Pattern Bulkhead                                     │
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a>│                                                                         │
<a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a>│  Consumer avec Bulkheads séparés par type de traitement:               │
<a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a>│                                                                         │
<a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a>│  ┌─────────────────────────────────────────────────────────────────┐   │
<a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a>│  │                    Thread Pool Principal                         │   │
<a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a>│  │                                                                  │   │
<a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a>│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │   │
<a id="__codelineno-9-10" name="__codelineno-9-10" href="#__codelineno-9-10"></a>│  │  │ Bulkhead        │  │ Bulkhead        │  │ Bulkhead        │ │   │
<a id="__codelineno-9-11" name="__codelineno-9-11" href="#__codelineno-9-11"></a>│  │  │ Orders          │  │ Payments        │  │ Notifications   │ │   │
<a id="__codelineno-9-12" name="__codelineno-9-12" href="#__codelineno-9-12"></a>│  │  │ (10 threads)    │  │ (5 threads)     │  │ (3 threads)     │ │   │
<a id="__codelineno-9-13" name="__codelineno-9-13" href="#__codelineno-9-13"></a>│  │  │                 │  │                 │  │                 │ │   │
<a id="__codelineno-9-14" name="__codelineno-9-14" href="#__codelineno-9-14"></a>│  │  │ Si saturé:      │  │ Si saturé:      │  │ Si saturé:      │ │   │
<a id="__codelineno-9-15" name="__codelineno-9-15" href="#__codelineno-9-15"></a>│  │  │ DLQ orders      │  │ DLQ payments    │  │ DLQ notif       │ │   │
<a id="__codelineno-9-16" name="__codelineno-9-16" href="#__codelineno-9-16"></a>│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘ │   │
<a id="__codelineno-9-17" name="__codelineno-9-17" href="#__codelineno-9-17"></a>│  └─────────────────────────────────────────────────────────────────┘   │
<a id="__codelineno-9-18" name="__codelineno-9-18" href="#__codelineno-9-18"></a>│                                                                         │
<a id="__codelineno-9-19" name="__codelineno-9-19" href="#__codelineno-9-19"></a>│  Avantage: Une saturation du bulkhead Payments n&#39;affecte pas           │
<a id="__codelineno-9-20" name="__codelineno-9-20" href="#__codelineno-9-20"></a>│  le traitement des Orders                                              │
<a id="__codelineno-9-21" name="__codelineno-9-21" href="#__codelineno-9-21"></a>└─────────────────────────────────────────────────────────────────────────┘
</code></pre></div>
<p><strong>Timeout Patterns</strong></p>
<p>Les timeouts sont essentiels pour éviter les blocages indéfinis.</p>
<p><div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">TimeoutAwareConsumer</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a>
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Duration</span><span class="w"> </span><span class="n">PROCESSING_TIMEOUT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Duration</span><span class="p">.</span><span class="na">ofSeconds</span><span class="p">(</span><span class="mi">30</span><span class="p">);</span>
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Duration</span><span class="w"> </span><span class="n">EXTERNAL_CALL_TIMEOUT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Duration</span><span class="p">.</span><span class="na">ofSeconds</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
<a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a>
<a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">ExecutorService</span><span class="w"> </span><span class="n">executor</span><span class="p">;</span>
<a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a>
<a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">processWithTimeout</span><span class="p">(</span><span class="n">ConsumerRecord</span><span class="o">&lt;</span><span class="n">K</span><span class="p">,</span><span class="w"> </span><span class="n">V</span><span class="o">&gt;</span><span class="w"> </span><span class="n">record</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a><span class="w">        </span><span class="n">CompletableFuture</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span><span class="w"> </span><span class="n">future</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CompletableFuture</span><span class="p">.</span><span class="na">runAsync</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-10-10" name="__codelineno-10-10" href="#__codelineno-10-10"></a><span class="w">            </span><span class="c1">// Traitement avec timeout sur chaque appel externe</span>
<a id="__codelineno-10-11" name="__codelineno-10-11" href="#__codelineno-10-11"></a><span class="w">            </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-10-12" name="__codelineno-10-12" href="#__codelineno-10-12"></a><span class="w">                </span><span class="n">ExternalResult</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">callExternalWithTimeout</span><span class="p">(</span><span class="n">record</span><span class="p">.</span><span class="na">value</span><span class="p">());</span>
<a id="__codelineno-10-13" name="__codelineno-10-13" href="#__codelineno-10-13"></a><span class="w">                </span><span class="n">saveResult</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
<a id="__codelineno-10-14" name="__codelineno-10-14" href="#__codelineno-10-14"></a><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">TimeoutException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-10-15" name="__codelineno-10-15" href="#__codelineno-10-15"></a><span class="w">                </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ProcessingException</span><span class="p">(</span><span class="s">&quot;External call timeout&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">);</span>
<a id="__codelineno-10-16" name="__codelineno-10-16" href="#__codelineno-10-16"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-10-17" name="__codelineno-10-17" href="#__codelineno-10-17"></a><span class="w">        </span><span class="p">},</span><span class="w"> </span><span class="n">executor</span><span class="p">);</span>
<a id="__codelineno-10-18" name="__codelineno-10-18" href="#__codelineno-10-18"></a>
<a id="__codelineno-10-19" name="__codelineno-10-19" href="#__codelineno-10-19"></a><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-10-20" name="__codelineno-10-20" href="#__codelineno-10-20"></a><span class="w">            </span><span class="c1">// Timeout global sur le traitement</span>
<a id="__codelineno-10-21" name="__codelineno-10-21" href="#__codelineno-10-21"></a><span class="w">            </span><span class="n">future</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">PROCESSING_TIMEOUT</span><span class="p">.</span><span class="na">toMillis</span><span class="p">(),</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">MILLISECONDS</span><span class="p">);</span>
<a id="__codelineno-10-22" name="__codelineno-10-22" href="#__codelineno-10-22"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">TimeoutException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-10-23" name="__codelineno-10-23" href="#__codelineno-10-23"></a><span class="w">            </span><span class="n">future</span><span class="p">.</span><span class="na">cancel</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
<a id="__codelineno-10-24" name="__codelineno-10-24" href="#__codelineno-10-24"></a><span class="w">            </span><span class="n">sendToDlq</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Processing timeout exceeded&quot;</span><span class="p">);</span>
<a id="__codelineno-10-25" name="__codelineno-10-25" href="#__codelineno-10-25"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">ExecutionException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-10-26" name="__codelineno-10-26" href="#__codelineno-10-26"></a><span class="w">            </span><span class="n">handleError</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="na">getCause</span><span class="p">());</span>
<a id="__codelineno-10-27" name="__codelineno-10-27" href="#__codelineno-10-27"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-10-28" name="__codelineno-10-28" href="#__codelineno-10-28"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-10-29" name="__codelineno-10-29" href="#__codelineno-10-29"></a>
<a id="__codelineno-10-30" name="__codelineno-10-30" href="#__codelineno-10-30"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">ExternalResult</span><span class="w"> </span><span class="nf">callExternalWithTimeout</span><span class="p">(</span><span class="n">Event</span><span class="w"> </span><span class="n">event</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">TimeoutException</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-10-31" name="__codelineno-10-31" href="#__codelineno-10-31"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">CompletableFuture</span>
<a id="__codelineno-10-32" name="__codelineno-10-32" href="#__codelineno-10-32"></a><span class="w">            </span><span class="p">.</span><span class="na">supplyAsync</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">externalService</span><span class="p">.</span><span class="na">call</span><span class="p">(</span><span class="n">event</span><span class="p">))</span>
<a id="__codelineno-10-33" name="__codelineno-10-33" href="#__codelineno-10-33"></a><span class="w">            </span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">EXTERNAL_CALL_TIMEOUT</span><span class="p">.</span><span class="na">toMillis</span><span class="p">(),</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">MILLISECONDS</span><span class="p">);</span>
<a id="__codelineno-10-34" name="__codelineno-10-34" href="#__codelineno-10-34"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-10-35" name="__codelineno-10-35" href="#__codelineno-10-35"></a><span class="p">}</span>
<a id="__codelineno-10-36" name="__codelineno-10-36" href="#__codelineno-10-36"></a>
<a id="__codelineno-10-37" name="__codelineno-10-37" href="#__codelineno-10-37"></a><span class="o">---</span>
<a id="__codelineno-10-38" name="__codelineno-10-38" href="#__codelineno-10-38"></a>
<a id="__codelineno-10-39" name="__codelineno-10-39" href="#__codelineno-10-39"></a><span class="err">##</span><span class="w"> </span><span class="n">III</span><span class="mf">.7.2</span><span class="w"> </span><span class="n">Implémentation</span><span class="w"> </span><span class="n">d</span><span class="err">&#39;</span><span class="n">un</span><span class="w"> </span><span class="n">Maillage</span><span class="w"> </span><span class="n">de</span><span class="w"> </span><span class="nf">Données</span><span class="w"> </span><span class="p">(</span><span class="n">Data</span><span class="w"> </span><span class="n">Mesh</span><span class="p">)</span>
<a id="__codelineno-10-40" name="__codelineno-10-40" href="#__codelineno-10-40"></a>
<a id="__codelineno-10-41" name="__codelineno-10-41" href="#__codelineno-10-41"></a><span class="err">###</span><span class="w"> </span><span class="n">Du</span><span class="w"> </span><span class="n">Monolithe</span><span class="w"> </span><span class="n">de</span><span class="w"> </span><span class="n">Données</span><span class="w"> </span><span class="n">au</span><span class="w"> </span><span class="n">Maillage</span>
<a id="__codelineno-10-42" name="__codelineno-10-42" href="#__codelineno-10-42"></a>
<a id="__codelineno-10-43" name="__codelineno-10-43" href="#__codelineno-10-43"></a><span class="n">Le</span><span class="w"> </span><span class="n">Data</span><span class="w"> </span><span class="n">Mesh</span><span class="w"> </span><span class="n">est</span><span class="w"> </span><span class="n">un</span><span class="w"> </span><span class="n">paradigme</span><span class="w"> </span><span class="n">architectural</span><span class="w"> </span><span class="n">qui</span><span class="w"> </span><span class="n">décentralise</span><span class="w"> </span><span class="n">la</span><span class="w"> </span><span class="n">propriété</span><span class="w"> </span><span class="n">et</span><span class="w"> </span><span class="n">la</span><span class="w"> </span><span class="n">gouvernance</span><span class="w"> </span><span class="n">des</span><span class="w"> </span><span class="n">données</span><span class="p">.</span><span class="w"> </span><span class="n">Au</span><span class="w"> </span><span class="n">lieu</span><span class="w"> </span><span class="n">d</span><span class="err">&#39;</span><span class="n">un</span><span class="w"> </span><span class="n">lac</span><span class="w"> </span><span class="n">de</span><span class="w"> </span><span class="n">données</span><span class="w"> </span><span class="n">centralisé</span><span class="w"> </span><span class="n">géré</span><span class="w"> </span><span class="n">par</span><span class="w"> </span><span class="n">une</span><span class="w"> </span><span class="n">équipe</span><span class="w"> </span><span class="n">Data</span><span class="p">,</span><span class="w"> </span><span class="n">chaque</span><span class="w"> </span><span class="n">domaine</span><span class="w"> </span><span class="n">métier</span><span class="w"> </span><span class="n">devient</span><span class="w"> </span><span class="n">responsable</span><span class="w"> </span><span class="n">de</span><span class="w"> </span><span class="n">ses</span><span class="w"> </span><span class="n">propres</span><span class="w"> </span><span class="err">«</span><span class="w"> </span><span class="n">produits</span><span class="w"> </span><span class="n">de</span><span class="w"> </span><span class="n">données</span><span class="w"> </span><span class="err">»</span><span class="p">.</span>
<a id="__codelineno-10-44" name="__codelineno-10-44" href="#__codelineno-10-44"></a>
<a id="__codelineno-10-45" name="__codelineno-10-45" href="#__codelineno-10-45"></a><span class="o">**</span><span class="n">Architecture</span><span class="w"> </span><span class="nf">traditionnelle</span><span class="w"> </span><span class="p">(</span><span class="n">Data</span><span class="w"> </span><span class="n">Lake</span><span class="w"> </span><span class="n">centralisé</span><span class="p">)</span><span class="o">**</span><span class="w"> </span><span class="p">:</span>
</code></pre></div>
┌─────────────────────────────────────────────────────────────────────────┐
│                        Équipe Data Centrale                             │
│                                                                         │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐                 │
│  │   ETL       │    │  Data Lake  │    │  Data       │                 │
│  │  Pipelines  │───▶│  (central)  │───▶│  Warehouse  │                 │
│  └─────────────┘    └─────────────┘    └─────────────┘                 │
│         ▲                                     │                        │
│         │                                     ▼                        │
│  ┌──────┴──────────────────────────────────────────┐                  │
│  │          Équipes Métier (sources)               │                  │
│  │  Commandes │ Clients │ Inventaire │ Paiements   │                  │
│  └─────────────────────────────────────────────────┘                  │
└─────────────────────────────────────────────────────────────────────────┘</p>
<p>Problèmes:
- Goulot d'étranglement sur l'équipe Data
- Délais de mise à disposition (semaines/mois)
- Perte de contexte métier
- Qualité des données dégradée
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a>**Architecture Data Mesh avec Kafka** :
</code></pre></div>
┌─────────────────────────────────────────────────────────────────────────┐
│                        Plateforme Self-Service                          │
│                         (Kafka + Gouvernance)                           │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                    Event Backbone (Kafka)                        │   │
│  │  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐             │   │
│  │  │orders.events │ │customers.    │ │inventory.    │             │   │
│  │  │              │ │events        │ │events        │             │   │
│  │  └──────────────┘ └──────────────┘ └──────────────┘             │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│         ▲                  ▲                  ▲                        │
│         │                  │                  │                        │
│  ┌──────┴──────┐    ┌──────┴──────┐    ┌──────┴──────┐                │
│  │  Domaine    │    │  Domaine    │    │  Domaine    │                │
│  │  Commandes  │    │  Clients    │    │  Inventaire │                │
│  │             │    │             │    │             │                │
│  │ [Produit    │    │ [Produit    │    │ [Produit    │                │
│  │  de données]│    │  de données]│    │  de données]│                │
│  └─────────────┘    └─────────────┘    └─────────────┘                │
│                                                                         │
│  Chaque domaine:                                                       │
│  - Possède ses données                                                 │
│  - Publie des produits de données                                      │
│  - Garantit la qualité et la documentation                             │
└─────────────────────────────────────────────────────────────────────────┘
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a>### Les Quatre Principes du Data Mesh
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a>
<a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a>**Principe 1 : Propriété par Domaine (Domain Ownership)**
<a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a>
<a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a>Chaque domaine métier possède et gère ses données comme un produit. L&#39;équipe Commandes est responsable des événements de commande, de leur qualité, de leur documentation, et de leur évolution.
<a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a>
<a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a>*Implémentation Kafka* :
<a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a>- Convention de nommage : `{domaine}.{type}.{version}` (ex: `orders.events.v1`)
<a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a>- Schémas gérés par l&#39;équipe du domaine
<a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a>- SLA définis et mesurés par le domaine
<a id="__codelineno-12-11" name="__codelineno-12-11" href="#__codelineno-12-11"></a>
<a id="__codelineno-12-12" name="__codelineno-12-12" href="#__codelineno-12-12"></a>```yaml
<a id="__codelineno-12-13" name="__codelineno-12-13" href="#__codelineno-12-13"></a># Exemple de définition de produit de données
<a id="__codelineno-12-14" name="__codelineno-12-14" href="#__codelineno-12-14"></a>product:
<a id="__codelineno-12-15" name="__codelineno-12-15" href="#__codelineno-12-15"></a>  name: &quot;orders.events&quot;
<a id="__codelineno-12-16" name="__codelineno-12-16" href="#__codelineno-12-16"></a>  domain: &quot;commerce/orders&quot;
<a id="__codelineno-12-17" name="__codelineno-12-17" href="#__codelineno-12-17"></a>  owner:
<a id="__codelineno-12-18" name="__codelineno-12-18" href="#__codelineno-12-18"></a>    team: &quot;team-orders&quot;
<a id="__codelineno-12-19" name="__codelineno-12-19" href="#__codelineno-12-19"></a>    contact: &quot;orders-team@company.com&quot;
<a id="__codelineno-12-20" name="__codelineno-12-20" href="#__codelineno-12-20"></a>  description: &quot;Événements du cycle de vie des commandes&quot;
<a id="__codelineno-12-21" name="__codelineno-12-21" href="#__codelineno-12-21"></a>
<a id="__codelineno-12-22" name="__codelineno-12-22" href="#__codelineno-12-22"></a>  topics:
<a id="__codelineno-12-23" name="__codelineno-12-23" href="#__codelineno-12-23"></a>    - name: &quot;orders.events.v1&quot;
<a id="__codelineno-12-24" name="__codelineno-12-24" href="#__codelineno-12-24"></a>      schema: &quot;schemas/order-event.avsc&quot;
<a id="__codelineno-12-25" name="__codelineno-12-25" href="#__codelineno-12-25"></a>      partitions: 24
<a id="__codelineno-12-26" name="__codelineno-12-26" href="#__codelineno-12-26"></a>      retention: &quot;30d&quot;
<a id="__codelineno-12-27" name="__codelineno-12-27" href="#__codelineno-12-27"></a>
<a id="__codelineno-12-28" name="__codelineno-12-28" href="#__codelineno-12-28"></a>  sla:
<a id="__codelineno-12-29" name="__codelineno-12-29" href="#__codelineno-12-29"></a>    availability: &quot;99.9%&quot;
<a id="__codelineno-12-30" name="__codelineno-12-30" href="#__codelineno-12-30"></a>    latency_p99: &quot;500ms&quot;
<a id="__codelineno-12-31" name="__codelineno-12-31" href="#__codelineno-12-31"></a>    freshness: &quot;&lt; 5min&quot;
<a id="__codelineno-12-32" name="__codelineno-12-32" href="#__codelineno-12-32"></a>
<a id="__codelineno-12-33" name="__codelineno-12-33" href="#__codelineno-12-33"></a>  documentation:
<a id="__codelineno-12-34" name="__codelineno-12-34" href="#__codelineno-12-34"></a>    wiki: &quot;https://wiki.company.com/orders-events&quot;
<a id="__codelineno-12-35" name="__codelineno-12-35" href="#__codelineno-12-35"></a>    schema_docs: &quot;https://schema-registry/orders&quot;
</code></pre></div></p>
<p><strong>Principe 2 : Données comme Produit (Data as Product)</strong></p>
<p>Les données ne sont pas un sous-produit des applications ; elles sont des produits à part entière avec des utilisateurs, des SLA, et une roadmap.</p>
<p><em>Caractéristiques d'un produit de données</em> :
- Découvrable : Catalogue centralisé, documentation accessible
- Compréhensible : Schémas documentés, exemples, métadonnées
- Fiable : SLA mesurés, alertes, processus d'incident
- Interopérable : Formats standards, contrats explicites</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a>┌─────────────────────────────────────────────────────────────────────────┐
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a>│                   Produit de Données : Orders Events                    │
<a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a>│                                                                         │
<a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a>│  ┌──────────────────────────────────────────────────────────────────┐  │
<a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a>│  │ Découvrabilité                                                    │  │
<a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a>│  │ - Enregistré dans le catalogue de données                        │  │
<a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a>│  │ - Tags: commerce, orders, transactional                          │  │
<a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a>│  │ - Recherchable par domaine, type, propriétaire                   │  │
<a id="__codelineno-13-9" name="__codelineno-13-9" href="#__codelineno-13-9"></a>│  └──────────────────────────────────────────────────────────────────┘  │
<a id="__codelineno-13-10" name="__codelineno-13-10" href="#__codelineno-13-10"></a>│                                                                         │
<a id="__codelineno-13-11" name="__codelineno-13-11" href="#__codelineno-13-11"></a>│  ┌──────────────────────────────────────────────────────────────────┐  │
<a id="__codelineno-13-12" name="__codelineno-13-12" href="#__codelineno-13-12"></a>│  │ Documentation                                                     │  │
<a id="__codelineno-13-13" name="__codelineno-13-13" href="#__codelineno-13-13"></a>│  │ - Schéma Avro avec champs doc                                    │  │
<a id="__codelineno-13-14" name="__codelineno-13-14" href="#__codelineno-13-14"></a>│  │ - Exemples de messages pour chaque type d&#39;événement              │  │
<a id="__codelineno-13-15" name="__codelineno-13-15" href="#__codelineno-13-15"></a>│  │ - Guide d&#39;intégration pour les consommateurs                     │  │
<a id="__codelineno-13-16" name="__codelineno-13-16" href="#__codelineno-13-16"></a>│  │ - Changelog des versions                                         │  │
<a id="__codelineno-13-17" name="__codelineno-13-17" href="#__codelineno-13-17"></a>│  └──────────────────────────────────────────────────────────────────┘  │
<a id="__codelineno-13-18" name="__codelineno-13-18" href="#__codelineno-13-18"></a>│                                                                         │
<a id="__codelineno-13-19" name="__codelineno-13-19" href="#__codelineno-13-19"></a>│  ┌──────────────────────────────────────────────────────────────────┐  │
<a id="__codelineno-13-20" name="__codelineno-13-20" href="#__codelineno-13-20"></a>│  │ Qualité &amp; SLA                                                     │  │
<a id="__codelineno-13-21" name="__codelineno-13-21" href="#__codelineno-13-21"></a>│  │ - Disponibilité: 99.9% (mesuré: 99.95%)                         │  │
<a id="__codelineno-13-22" name="__codelineno-13-22" href="#__codelineno-13-22"></a>│  │ - Latence p99: 500ms (mesuré: 320ms)                            │  │
<a id="__codelineno-13-23" name="__codelineno-13-23" href="#__codelineno-13-23"></a>│  │ - Fraîcheur: &lt; 5min (mesuré: 2min)                              │  │
<a id="__codelineno-13-24" name="__codelineno-13-24" href="#__codelineno-13-24"></a>│  │ - Taux d&#39;erreur: &lt; 0.1% (mesuré: 0.02%)                         │  │
<a id="__codelineno-13-25" name="__codelineno-13-25" href="#__codelineno-13-25"></a>│  └──────────────────────────────────────────────────────────────────┘  │
<a id="__codelineno-13-26" name="__codelineno-13-26" href="#__codelineno-13-26"></a>│                                                                         │
<a id="__codelineno-13-27" name="__codelineno-13-27" href="#__codelineno-13-27"></a>│  ┌──────────────────────────────────────────────────────────────────┐  │
<a id="__codelineno-13-28" name="__codelineno-13-28" href="#__codelineno-13-28"></a>│  │ Interopérabilité                                                  │  │
<a id="__codelineno-13-29" name="__codelineno-13-29" href="#__codelineno-13-29"></a>│  │ - Format: Avro avec Schema Registry                              │  │
<a id="__codelineno-13-30" name="__codelineno-13-30" href="#__codelineno-13-30"></a>│  │ - Compatibilité: BACKWARD                                        │  │
<a id="__codelineno-13-31" name="__codelineno-13-31" href="#__codelineno-13-31"></a>│  │ - Protocole: Kafka (Confluent Cloud)                             │  │
<a id="__codelineno-13-32" name="__codelineno-13-32" href="#__codelineno-13-32"></a>│  └──────────────────────────────────────────────────────────────────┘  │
<a id="__codelineno-13-33" name="__codelineno-13-33" href="#__codelineno-13-33"></a>└─────────────────────────────────────────────────────────────────────────┘
</code></pre></div>
<p><strong>Principe 3 : Plateforme Self-Service</strong></p>
<p>Une plateforme commune fournit les outils, l'infrastructure, et les abstractions qui permettent aux équipes de domaine de publier et consommer des données sans dépendre d'une équipe centrale.</p>
<p><em>Composants de la plateforme</em> :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a>┌─────────────────────────────────────────────────────────────────────────┐
<a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a>│                      Plateforme Data Mesh                               │
<a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a>│                                                                         │
<a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a>│  ┌─────────────────────────────────────────────────────────────────┐   │
<a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a>│  │                    Couche Self-Service                           │   │
<a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a>│  │  ┌───────────┐  ┌───────────┐  ┌───────────┐  ┌───────────┐    │   │
<a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a>│  │  │ Catalogue │  │ Portail   │  │ CLI/API   │  │ Templates │    │   │
<a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a>│  │  │ de données│  │ développeur│ │ provision │  │ de topics │    │   │
<a id="__codelineno-14-9" name="__codelineno-14-9" href="#__codelineno-14-9"></a>│  │  └───────────┘  └───────────┘  └───────────┘  └───────────┘    │   │
<a id="__codelineno-14-10" name="__codelineno-14-10" href="#__codelineno-14-10"></a>│  └─────────────────────────────────────────────────────────────────┘   │
<a id="__codelineno-14-11" name="__codelineno-14-11" href="#__codelineno-14-11"></a>│                                                                         │
<a id="__codelineno-14-12" name="__codelineno-14-12" href="#__codelineno-14-12"></a>│  ┌─────────────────────────────────────────────────────────────────┐   │
<a id="__codelineno-14-13" name="__codelineno-14-13" href="#__codelineno-14-13"></a>│  │                    Couche Gouvernance                            │   │
<a id="__codelineno-14-14" name="__codelineno-14-14" href="#__codelineno-14-14"></a>│  │  ┌───────────┐  ┌───────────┐  ┌───────────┐  ┌───────────┐    │   │
<a id="__codelineno-14-15" name="__codelineno-14-15" href="#__codelineno-14-15"></a>│  │  │ Schema    │  │ Policies  │  │ Audit &amp;   │  │ Sécurité  │    │   │
<a id="__codelineno-14-16" name="__codelineno-14-16" href="#__codelineno-14-16"></a>│  │  │ Registry  │  │ (naming,  │  │ Lineage   │  │ (ACLs)    │    │   │
<a id="__codelineno-14-17" name="__codelineno-14-17" href="#__codelineno-14-17"></a>│  │  │           │  │  retention)│ │           │  │           │    │   │
<a id="__codelineno-14-18" name="__codelineno-14-18" href="#__codelineno-14-18"></a>│  │  └───────────┘  └───────────┘  └───────────┘  └───────────┘    │   │
<a id="__codelineno-14-19" name="__codelineno-14-19" href="#__codelineno-14-19"></a>│  └─────────────────────────────────────────────────────────────────┘   │
<a id="__codelineno-14-20" name="__codelineno-14-20" href="#__codelineno-14-20"></a>│                                                                         │
<a id="__codelineno-14-21" name="__codelineno-14-21" href="#__codelineno-14-21"></a>│  ┌─────────────────────────────────────────────────────────────────┐   │
<a id="__codelineno-14-22" name="__codelineno-14-22" href="#__codelineno-14-22"></a>│  │                    Couche Infrastructure                         │   │
<a id="__codelineno-14-23" name="__codelineno-14-23" href="#__codelineno-14-23"></a>│  │  ┌───────────────────────────────────────────────────────────┐  │   │
<a id="__codelineno-14-24" name="__codelineno-14-24" href="#__codelineno-14-24"></a>│  │  │              Kafka (Confluent Cloud / Self-managed)        │  │   │
<a id="__codelineno-14-25" name="__codelineno-14-25" href="#__codelineno-14-25"></a>│  │  └───────────────────────────────────────────────────────────┘  │   │
<a id="__codelineno-14-26" name="__codelineno-14-26" href="#__codelineno-14-26"></a>│  │  ┌───────────┐  ┌───────────┐  ┌───────────┐  ┌───────────┐    │   │
<a id="__codelineno-14-27" name="__codelineno-14-27" href="#__codelineno-14-27"></a>│  │  │ Kafka     │  │ ksqlDB    │  │ Flink     │  │ Monitoring│    │   │
<a id="__codelineno-14-28" name="__codelineno-14-28" href="#__codelineno-14-28"></a>│  │  │ Connect   │  │           │  │           │  │           │    │   │
<a id="__codelineno-14-29" name="__codelineno-14-29" href="#__codelineno-14-29"></a>│  │  └───────────┘  └───────────┘  └───────────┘  └───────────┘    │   │
<a id="__codelineno-14-30" name="__codelineno-14-30" href="#__codelineno-14-30"></a>│  └─────────────────────────────────────────────────────────────────┘   │
<a id="__codelineno-14-31" name="__codelineno-14-31" href="#__codelineno-14-31"></a>└─────────────────────────────────────────────────────────────────────────┘
</code></pre></div>
<p><strong>Principe 4 : Gouvernance Fédérée</strong></p>
<p>La gouvernance n'est pas centralisée mais fédérée : des standards globaux (conventions, sécurité, interopérabilité) combinés avec une autonomie locale (schémas, SLA, évolution).</p>
<p><em>Standards globaux (non négociables)</em> :
- Convention de nommage des topics
- Format de sérialisation (Avro)
- Métadonnées obligatoires dans les événements
- Politique de rétention minimum
- Exigences de sécurité (chiffrement, authentification)</p>
<p><em>Autonomie locale (par domaine)</em> :
- Structure des schémas métier
- SLA spécifiques au produit
- Fréquence de publication
- Stratégie de partitionnement</p>
<h3 id="implementation-technique-avec-kafka">Implémentation Technique avec Kafka<a class="headerlink" href="#implementation-technique-avec-kafka" title="Permanent link">&para;</a></h3>
<p><strong>Convention de nommage des topics</strong> :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a>{domaine}.{sous-domaine}.{type}.{version}
<a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a>
<a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a>Exemples:
<a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a>- orders.checkout.events.v1
<a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a>- orders.fulfillment.events.v1
<a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a>- customers.profile.events.v1
<a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a>- inventory.warehouse.snapshots.v1
</code></pre></div>
<p><strong>Structure de métadonnées standard</strong> :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a>{
<a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a>  &quot;type&quot;: &quot;record&quot;,
<a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a>  &quot;name&quot;: &quot;DataMeshEnvelope&quot;,
<a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a>  &quot;namespace&quot;: &quot;com.company.datamesh&quot;,
<a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a>  &quot;fields&quot;: [
<a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a>    {
<a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a>      &quot;name&quot;: &quot;header&quot;,
<a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a>      &quot;type&quot;: {
<a id="__codelineno-16-9" name="__codelineno-16-9" href="#__codelineno-16-9"></a>        &quot;type&quot;: &quot;record&quot;,
<a id="__codelineno-16-10" name="__codelineno-16-10" href="#__codelineno-16-10"></a>        &quot;name&quot;: &quot;DataMeshHeader&quot;,
<a id="__codelineno-16-11" name="__codelineno-16-11" href="#__codelineno-16-11"></a>        &quot;fields&quot;: [
<a id="__codelineno-16-12" name="__codelineno-16-12" href="#__codelineno-16-12"></a>          {&quot;name&quot;: &quot;event_id&quot;, &quot;type&quot;: &quot;string&quot;},
<a id="__codelineno-16-13" name="__codelineno-16-13" href="#__codelineno-16-13"></a>          {&quot;name&quot;: &quot;event_type&quot;, &quot;type&quot;: &quot;string&quot;},
<a id="__codelineno-16-14" name="__codelineno-16-14" href="#__codelineno-16-14"></a>          {&quot;name&quot;: &quot;event_time&quot;, &quot;type&quot;: &quot;long&quot;, &quot;logicalType&quot;: &quot;timestamp-millis&quot;},
<a id="__codelineno-16-15" name="__codelineno-16-15" href="#__codelineno-16-15"></a>          {&quot;name&quot;: &quot;domain&quot;, &quot;type&quot;: &quot;string&quot;},
<a id="__codelineno-16-16" name="__codelineno-16-16" href="#__codelineno-16-16"></a>          {&quot;name&quot;: &quot;product&quot;, &quot;type&quot;: &quot;string&quot;},
<a id="__codelineno-16-17" name="__codelineno-16-17" href="#__codelineno-16-17"></a>          {&quot;name&quot;: &quot;version&quot;, &quot;type&quot;: &quot;string&quot;},
<a id="__codelineno-16-18" name="__codelineno-16-18" href="#__codelineno-16-18"></a>          {&quot;name&quot;: &quot;correlation_id&quot;, &quot;type&quot;: [&quot;null&quot;, &quot;string&quot;]},
<a id="__codelineno-16-19" name="__codelineno-16-19" href="#__codelineno-16-19"></a>          {&quot;name&quot;: &quot;causation_id&quot;, &quot;type&quot;: [&quot;null&quot;, &quot;string&quot;]},
<a id="__codelineno-16-20" name="__codelineno-16-20" href="#__codelineno-16-20"></a>          {
<a id="__codelineno-16-21" name="__codelineno-16-21" href="#__codelineno-16-21"></a>            &quot;name&quot;: &quot;source&quot;,
<a id="__codelineno-16-22" name="__codelineno-16-22" href="#__codelineno-16-22"></a>            &quot;type&quot;: {
<a id="__codelineno-16-23" name="__codelineno-16-23" href="#__codelineno-16-23"></a>              &quot;type&quot;: &quot;record&quot;,
<a id="__codelineno-16-24" name="__codelineno-16-24" href="#__codelineno-16-24"></a>              &quot;name&quot;: &quot;Source&quot;,
<a id="__codelineno-16-25" name="__codelineno-16-25" href="#__codelineno-16-25"></a>              &quot;fields&quot;: [
<a id="__codelineno-16-26" name="__codelineno-16-26" href="#__codelineno-16-26"></a>                {&quot;name&quot;: &quot;system&quot;, &quot;type&quot;: &quot;string&quot;},
<a id="__codelineno-16-27" name="__codelineno-16-27" href="#__codelineno-16-27"></a>                {&quot;name&quot;: &quot;instance&quot;, &quot;type&quot;: [&quot;null&quot;, &quot;string&quot;]}
<a id="__codelineno-16-28" name="__codelineno-16-28" href="#__codelineno-16-28"></a>              ]
<a id="__codelineno-16-29" name="__codelineno-16-29" href="#__codelineno-16-29"></a>            }
<a id="__codelineno-16-30" name="__codelineno-16-30" href="#__codelineno-16-30"></a>          }
<a id="__codelineno-16-31" name="__codelineno-16-31" href="#__codelineno-16-31"></a>        ]
<a id="__codelineno-16-32" name="__codelineno-16-32" href="#__codelineno-16-32"></a>      }
<a id="__codelineno-16-33" name="__codelineno-16-33" href="#__codelineno-16-33"></a>    },
<a id="__codelineno-16-34" name="__codelineno-16-34" href="#__codelineno-16-34"></a>    {
<a id="__codelineno-16-35" name="__codelineno-16-35" href="#__codelineno-16-35"></a>      &quot;name&quot;: &quot;payload&quot;,
<a id="__codelineno-16-36" name="__codelineno-16-36" href="#__codelineno-16-36"></a>      &quot;type&quot;: &quot;bytes&quot;,
<a id="__codelineno-16-37" name="__codelineno-16-37" href="#__codelineno-16-37"></a>      &quot;doc&quot;: &quot;Payload spécifique au domaine, sérialisé selon le schéma du produit&quot;
<a id="__codelineno-16-38" name="__codelineno-16-38" href="#__codelineno-16-38"></a>    }
<a id="__codelineno-16-39" name="__codelineno-16-39" href="#__codelineno-16-39"></a>  ]
<a id="__codelineno-16-40" name="__codelineno-16-40" href="#__codelineno-16-40"></a>}
</code></pre></div>
<p><strong>Workflow de création d'un nouveau produit de données</strong> :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="c1"># data-product.yaml - Définition déclarative</span>
<a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">datamesh/v1</span>
<a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DataProduct</span>
<a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a><span class="nt">metadata</span><span class="p">:</span>
<a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">order-events</span>
<a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a><span class="w">  </span><span class="nt">domain</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">commerce/orders</span>
<a id="__codelineno-17-7" name="__codelineno-17-7" href="#__codelineno-17-7"></a><span class="w">  </span><span class="nt">owner</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">team-orders</span>
<a id="__codelineno-17-8" name="__codelineno-17-8" href="#__codelineno-17-8"></a><span class="nt">spec</span><span class="p">:</span>
<a id="__codelineno-17-9" name="__codelineno-17-9" href="#__codelineno-17-9"></a><span class="w">  </span><span class="nt">topics</span><span class="p">:</span>
<a id="__codelineno-17-10" name="__codelineno-17-10" href="#__codelineno-17-10"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">orders.events.v1</span>
<a id="__codelineno-17-11" name="__codelineno-17-11" href="#__codelineno-17-11"></a><span class="w">      </span><span class="nt">partitions</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">24</span>
<a id="__codelineno-17-12" name="__codelineno-17-12" href="#__codelineno-17-12"></a><span class="w">      </span><span class="nt">replication</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3</span>
<a id="__codelineno-17-13" name="__codelineno-17-13" href="#__codelineno-17-13"></a><span class="w">      </span><span class="nt">retention</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30d</span>
<a id="__codelineno-17-14" name="__codelineno-17-14" href="#__codelineno-17-14"></a><span class="w">      </span><span class="nt">schema</span><span class="p">:</span>
<a id="__codelineno-17-15" name="__codelineno-17-15" href="#__codelineno-17-15"></a><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">avro</span>
<a id="__codelineno-17-16" name="__codelineno-17-16" href="#__codelineno-17-16"></a><span class="w">        </span><span class="nt">file</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">schemas/order-event.avsc</span>
<a id="__codelineno-17-17" name="__codelineno-17-17" href="#__codelineno-17-17"></a><span class="w">        </span><span class="nt">compatibility</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">BACKWARD</span>
<a id="__codelineno-17-18" name="__codelineno-17-18" href="#__codelineno-17-18"></a>
<a id="__codelineno-17-19" name="__codelineno-17-19" href="#__codelineno-17-19"></a><span class="w">  </span><span class="nt">access</span><span class="p">:</span>
<a id="__codelineno-17-20" name="__codelineno-17-20" href="#__codelineno-17-20"></a><span class="w">    </span><span class="nt">producers</span><span class="p">:</span>
<a id="__codelineno-17-21" name="__codelineno-17-21" href="#__codelineno-17-21"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">service</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">order-service</span>
<a id="__codelineno-17-22" name="__codelineno-17-22" href="#__codelineno-17-22"></a><span class="w">        </span><span class="nt">environment</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">dev</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">staging</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">prod</span><span class="p p-Indicator">]</span>
<a id="__codelineno-17-23" name="__codelineno-17-23" href="#__codelineno-17-23"></a><span class="w">    </span><span class="nt">consumers</span><span class="p">:</span>
<a id="__codelineno-17-24" name="__codelineno-17-24" href="#__codelineno-17-24"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">service</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">analytics-service</span>
<a id="__codelineno-17-25" name="__codelineno-17-25" href="#__codelineno-17-25"></a><span class="w">        </span><span class="nt">environment</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">prod</span><span class="p p-Indicator">]</span>
<a id="__codelineno-17-26" name="__codelineno-17-26" href="#__codelineno-17-26"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">service</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">notification-service</span>
<a id="__codelineno-17-27" name="__codelineno-17-27" href="#__codelineno-17-27"></a><span class="w">        </span><span class="nt">environment</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">prod</span><span class="p p-Indicator">]</span>
<a id="__codelineno-17-28" name="__codelineno-17-28" href="#__codelineno-17-28"></a>
<a id="__codelineno-17-29" name="__codelineno-17-29" href="#__codelineno-17-29"></a><span class="w">  </span><span class="nt">monitoring</span><span class="p">:</span>
<a id="__codelineno-17-30" name="__codelineno-17-30" href="#__codelineno-17-30"></a><span class="w">    </span><span class="nt">alerts</span><span class="p">:</span>
<a id="__codelineno-17-31" name="__codelineno-17-31" href="#__codelineno-17-31"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">lag</span>
<a id="__codelineno-17-32" name="__codelineno-17-32" href="#__codelineno-17-32"></a><span class="w">        </span><span class="nt">threshold</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10000</span>
<a id="__codelineno-17-33" name="__codelineno-17-33" href="#__codelineno-17-33"></a><span class="w">        </span><span class="nt">severity</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">warning</span>
<a id="__codelineno-17-34" name="__codelineno-17-34" href="#__codelineno-17-34"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">error_rate</span>
<a id="__codelineno-17-35" name="__codelineno-17-35" href="#__codelineno-17-35"></a><span class="w">        </span><span class="nt">threshold</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.01</span>
<a id="__codelineno-17-36" name="__codelineno-17-36" href="#__codelineno-17-36"></a><span class="w">        </span><span class="nt">severity</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">critical</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="c1"># Provisionnement via CLI</span>
<a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a>datamesh<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>data-product.yaml
<a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a>
<a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a><span class="c1"># Résultat:</span>
<a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a><span class="c1"># ✓ Topic orders.events.v1 créé</span>
<a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a><span class="c1"># ✓ Schema enregistré dans Schema Registry</span>
<a id="__codelineno-18-7" name="__codelineno-18-7" href="#__codelineno-18-7"></a><span class="c1"># ✓ ACLs configurés pour les producteurs/consommateurs</span>
<a id="__codelineno-18-8" name="__codelineno-18-8" href="#__codelineno-18-8"></a><span class="c1"># ✓ Dashboards de monitoring créés</span>
<a id="__codelineno-18-9" name="__codelineno-18-9" href="#__codelineno-18-9"></a><span class="c1"># ✓ Produit enregistré dans le catalogue</span>
</code></pre></div>
<h3 id="gouvernance-et-qualite-des-donnees">Gouvernance et Qualité des Données<a class="headerlink" href="#gouvernance-et-qualite-des-donnees" title="Permanent link">&para;</a></h3>
<p>Dans un Data Mesh, la qualité des données est la responsabilité du domaine producteur. Kafka offre plusieurs mécanismes pour garantir cette qualité.</p>
<p><strong>Validation à la Source</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">ValidatingProducer</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a>
<a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">KafkaProducer</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">OrderEvent</span><span class="o">&gt;</span><span class="w"> </span><span class="n">producer</span><span class="p">;</span>
<a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Validator</span><span class="w"> </span><span class="n">validator</span><span class="p">;</span>
<a id="__codelineno-19-5" name="__codelineno-19-5" href="#__codelineno-19-5"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">MetricRegistry</span><span class="w"> </span><span class="n">metrics</span><span class="p">;</span>
<a id="__codelineno-19-6" name="__codelineno-19-6" href="#__codelineno-19-6"></a>
<a id="__codelineno-19-7" name="__codelineno-19-7" href="#__codelineno-19-7"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">publishOrder</span><span class="p">(</span><span class="n">OrderEvent</span><span class="w"> </span><span class="n">event</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-19-8" name="__codelineno-19-8" href="#__codelineno-19-8"></a><span class="w">        </span><span class="c1">// Validation avant publication</span>
<a id="__codelineno-19-9" name="__codelineno-19-9" href="#__codelineno-19-9"></a><span class="w">        </span><span class="n">ValidationResult</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">validator</span><span class="p">.</span><span class="na">validate</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
<a id="__codelineno-19-10" name="__codelineno-19-10" href="#__codelineno-19-10"></a>
<a id="__codelineno-19-11" name="__codelineno-19-11" href="#__codelineno-19-11"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">result</span><span class="p">.</span><span class="na">isValid</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-19-12" name="__codelineno-19-12" href="#__codelineno-19-12"></a><span class="w">            </span><span class="n">metrics</span><span class="p">.</span><span class="na">counter</span><span class="p">(</span><span class="s">&quot;events.validation.failed&quot;</span><span class="p">).</span><span class="na">inc</span><span class="p">();</span>
<a id="__codelineno-19-13" name="__codelineno-19-13" href="#__codelineno-19-13"></a><span class="w">            </span><span class="n">log</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">&quot;Event validation failed: {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">result</span><span class="p">.</span><span class="na">getErrors</span><span class="p">());</span>
<a id="__codelineno-19-14" name="__codelineno-19-14" href="#__codelineno-19-14"></a><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ValidationException</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="na">getErrors</span><span class="p">());</span>
<a id="__codelineno-19-15" name="__codelineno-19-15" href="#__codelineno-19-15"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-19-16" name="__codelineno-19-16" href="#__codelineno-19-16"></a>
<a id="__codelineno-19-17" name="__codelineno-19-17" href="#__codelineno-19-17"></a><span class="w">        </span><span class="c1">// Enrichissement des métadonnées</span>
<a id="__codelineno-19-18" name="__codelineno-19-18" href="#__codelineno-19-18"></a><span class="w">        </span><span class="n">event</span><span class="p">.</span><span class="na">getHeader</span><span class="p">().</span><span class="na">setProducedAt</span><span class="p">(</span><span class="n">Instant</span><span class="p">.</span><span class="na">now</span><span class="p">());</span>
<a id="__codelineno-19-19" name="__codelineno-19-19" href="#__codelineno-19-19"></a><span class="w">        </span><span class="n">event</span><span class="p">.</span><span class="na">getHeader</span><span class="p">().</span><span class="na">setProducerVersion</span><span class="p">(</span><span class="n">getApplicationVersion</span><span class="p">());</span>
<a id="__codelineno-19-20" name="__codelineno-19-20" href="#__codelineno-19-20"></a>
<a id="__codelineno-19-21" name="__codelineno-19-21" href="#__codelineno-19-21"></a><span class="w">        </span><span class="c1">// Publication avec callback de confirmation</span>
<a id="__codelineno-19-22" name="__codelineno-19-22" href="#__codelineno-19-22"></a><span class="w">        </span><span class="n">producer</span><span class="p">.</span><span class="na">send</span><span class="p">(</span>
<a id="__codelineno-19-23" name="__codelineno-19-23" href="#__codelineno-19-23"></a><span class="w">            </span><span class="k">new</span><span class="w"> </span><span class="n">ProducerRecord</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="s">&quot;orders.events.v1&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">event</span><span class="p">.</span><span class="na">getOrderId</span><span class="p">(),</span><span class="w"> </span><span class="n">event</span><span class="p">),</span>
<a id="__codelineno-19-24" name="__codelineno-19-24" href="#__codelineno-19-24"></a><span class="w">            </span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span><span class="w"> </span><span class="n">exception</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-19-25" name="__codelineno-19-25" href="#__codelineno-19-25"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">exception</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-19-26" name="__codelineno-19-26" href="#__codelineno-19-26"></a><span class="w">                    </span><span class="n">metrics</span><span class="p">.</span><span class="na">counter</span><span class="p">(</span><span class="s">&quot;events.publish.failed&quot;</span><span class="p">).</span><span class="na">inc</span><span class="p">();</span>
<a id="__codelineno-19-27" name="__codelineno-19-27" href="#__codelineno-19-27"></a><span class="w">                    </span><span class="n">log</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">&quot;Failed to publish event&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">exception</span><span class="p">);</span>
<a id="__codelineno-19-28" name="__codelineno-19-28" href="#__codelineno-19-28"></a><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-19-29" name="__codelineno-19-29" href="#__codelineno-19-29"></a><span class="w">                    </span><span class="n">metrics</span><span class="p">.</span><span class="na">counter</span><span class="p">(</span><span class="s">&quot;events.publish.success&quot;</span><span class="p">).</span><span class="na">inc</span><span class="p">();</span>
<a id="__codelineno-19-30" name="__codelineno-19-30" href="#__codelineno-19-30"></a><span class="w">                    </span><span class="n">log</span><span class="p">.</span><span class="na">debug</span><span class="p">(</span><span class="s">&quot;Event published to partition {} offset {}&quot;</span><span class="p">,</span><span class="w"> </span>
<a id="__codelineno-19-31" name="__codelineno-19-31" href="#__codelineno-19-31"></a><span class="w">                        </span><span class="n">metadata</span><span class="p">.</span><span class="na">partition</span><span class="p">(),</span><span class="w"> </span><span class="n">metadata</span><span class="p">.</span><span class="na">offset</span><span class="p">());</span>
<a id="__codelineno-19-32" name="__codelineno-19-32" href="#__codelineno-19-32"></a><span class="w">                </span><span class="p">}</span>
<a id="__codelineno-19-33" name="__codelineno-19-33" href="#__codelineno-19-33"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-19-34" name="__codelineno-19-34" href="#__codelineno-19-34"></a><span class="w">        </span><span class="p">);</span>
<a id="__codelineno-19-35" name="__codelineno-19-35" href="#__codelineno-19-35"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-19-36" name="__codelineno-19-36" href="#__codelineno-19-36"></a><span class="p">}</span>
</code></pre></div>
<p><strong>Contrats de Qualité (Data Quality SLAs)</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="c1"># quality-contract.yaml</span>
<a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a><span class="nt">product</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">orders.events.v1</span>
<a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a><span class="nt">quality_rules</span><span class="p">:</span>
<a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">completeness</span>
<a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a><span class="w">    </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Tous</span><span class="nv"> </span><span class="s">les</span><span class="nv"> </span><span class="s">champs</span><span class="nv"> </span><span class="s">obligatoires</span><span class="nv"> </span><span class="s">sont</span><span class="nv"> </span><span class="s">présents&quot;</span>
<a id="__codelineno-20-6" name="__codelineno-20-6" href="#__codelineno-20-6"></a><span class="w">    </span><span class="nt">check</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;order_id</span><span class="nv"> </span><span class="s">IS</span><span class="nv"> </span><span class="s">NOT</span><span class="nv"> </span><span class="s">NULL</span><span class="nv"> </span><span class="s">AND</span><span class="nv"> </span><span class="s">customer_id</span><span class="nv"> </span><span class="s">IS</span><span class="nv"> </span><span class="s">NOT</span><span class="nv"> </span><span class="s">NULL</span><span class="nv"> </span><span class="s">AND</span><span class="nv"> </span><span class="s">total</span><span class="nv"> </span><span class="s">&gt;</span><span class="nv"> </span><span class="s">0&quot;</span>
<a id="__codelineno-20-7" name="__codelineno-20-7" href="#__codelineno-20-7"></a><span class="w">    </span><span class="nt">threshold</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">99.9%</span>
<a id="__codelineno-20-8" name="__codelineno-20-8" href="#__codelineno-20-8"></a>
<a id="__codelineno-20-9" name="__codelineno-20-9" href="#__codelineno-20-9"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">freshness</span>
<a id="__codelineno-20-10" name="__codelineno-20-10" href="#__codelineno-20-10"></a><span class="w">    </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Événements</span><span class="nv"> </span><span class="s">publiés</span><span class="nv"> </span><span class="s">dans</span><span class="nv"> </span><span class="s">les</span><span class="nv"> </span><span class="s">5</span><span class="nv"> </span><span class="s">minutes</span><span class="nv"> </span><span class="s">suivant</span><span class="nv"> </span><span class="s">l&#39;action&quot;</span>
<a id="__codelineno-20-11" name="__codelineno-20-11" href="#__codelineno-20-11"></a><span class="w">    </span><span class="nt">check</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;event_time</span><span class="nv"> </span><span class="s">-</span><span class="nv"> </span><span class="s">action_time</span><span class="nv"> </span><span class="s">&lt;</span><span class="nv"> </span><span class="s">300000&quot;</span>
<a id="__codelineno-20-12" name="__codelineno-20-12" href="#__codelineno-20-12"></a><span class="w">    </span><span class="nt">threshold</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">95%</span>
<a id="__codelineno-20-13" name="__codelineno-20-13" href="#__codelineno-20-13"></a>
<a id="__codelineno-20-14" name="__codelineno-20-14" href="#__codelineno-20-14"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">accuracy</span>
<a id="__codelineno-20-15" name="__codelineno-20-15" href="#__codelineno-20-15"></a><span class="w">    </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Total</span><span class="nv"> </span><span class="s">correspond</span><span class="nv"> </span><span class="s">à</span><span class="nv"> </span><span class="s">la</span><span class="nv"> </span><span class="s">somme</span><span class="nv"> </span><span class="s">des</span><span class="nv"> </span><span class="s">items&quot;</span>
<a id="__codelineno-20-16" name="__codelineno-20-16" href="#__codelineno-20-16"></a><span class="w">    </span><span class="nt">check</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;ABS(total</span><span class="nv"> </span><span class="s">-</span><span class="nv"> </span><span class="s">SUM(items.price</span><span class="nv"> </span><span class="s">*</span><span class="nv"> </span><span class="s">items.quantity))</span><span class="nv"> </span><span class="s">&lt;</span><span class="nv"> </span><span class="s">1&quot;</span>
<a id="__codelineno-20-17" name="__codelineno-20-17" href="#__codelineno-20-17"></a><span class="w">    </span><span class="nt">threshold</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">100%</span>
<a id="__codelineno-20-18" name="__codelineno-20-18" href="#__codelineno-20-18"></a>
<a id="__codelineno-20-19" name="__codelineno-20-19" href="#__codelineno-20-19"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">uniqueness</span>
<a id="__codelineno-20-20" name="__codelineno-20-20" href="#__codelineno-20-20"></a><span class="w">    </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Pas</span><span class="nv"> </span><span class="s">de</span><span class="nv"> </span><span class="s">doublons</span><span class="nv"> </span><span class="s">sur</span><span class="nv"> </span><span class="s">event_id&quot;</span>
<a id="__codelineno-20-21" name="__codelineno-20-21" href="#__codelineno-20-21"></a><span class="w">    </span><span class="nt">check</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;COUNT(DISTINCT</span><span class="nv"> </span><span class="s">event_id)</span><span class="nv"> </span><span class="s">=</span><span class="nv"> </span><span class="s">COUNT(*)&quot;</span>
<a id="__codelineno-20-22" name="__codelineno-20-22" href="#__codelineno-20-22"></a><span class="w">    </span><span class="nt">threshold</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">100%</span>
<a id="__codelineno-20-23" name="__codelineno-20-23" href="#__codelineno-20-23"></a>
<a id="__codelineno-20-24" name="__codelineno-20-24" href="#__codelineno-20-24"></a><span class="nt">monitoring</span><span class="p">:</span>
<a id="__codelineno-20-25" name="__codelineno-20-25" href="#__codelineno-20-25"></a><span class="w">  </span><span class="nt">check_interval</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5m</span>
<a id="__codelineno-20-26" name="__codelineno-20-26" href="#__codelineno-20-26"></a><span class="w">  </span><span class="nt">alert_on_breach</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<a id="__codelineno-20-27" name="__codelineno-20-27" href="#__codelineno-20-27"></a><span class="w">  </span><span class="nt">alert_channels</span><span class="p">:</span>
<a id="__codelineno-20-28" name="__codelineno-20-28" href="#__codelineno-20-28"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">slack</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;#orders-team&quot;</span>
<a id="__codelineno-20-29" name="__codelineno-20-29" href="#__codelineno-20-29"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">pagerduty</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;orders-oncall&quot;</span>
</code></pre></div>
<p><strong>Observabilité du Data Mesh</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a>┌─────────────────────────────────────────────────────────────────────────┐
<a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a>│                    Dashboard Data Mesh                                  │
<a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a>│                                                                         │
<a id="__codelineno-21-4" name="__codelineno-21-4" href="#__codelineno-21-4"></a>│  Santé des Produits de Données                                         │
<a id="__codelineno-21-5" name="__codelineno-21-5" href="#__codelineno-21-5"></a>│  ┌─────────────────────────────────────────────────────────────────┐   │
<a id="__codelineno-21-6" name="__codelineno-21-6" href="#__codelineno-21-6"></a>│  │ Produit              │ SLA Dispo │ SLA Latence │ Qualité │ État │   │
<a id="__codelineno-21-7" name="__codelineno-21-7" href="#__codelineno-21-7"></a>│  ├─────────────────────────────────────────────────────────────────┤   │
<a id="__codelineno-21-8" name="__codelineno-21-8" href="#__codelineno-21-8"></a>│  │ orders.events.v1     │ 99.95%    │ 320ms       │ 99.8%   │ ✓    │   │
<a id="__codelineno-21-9" name="__codelineno-21-9" href="#__codelineno-21-9"></a>│  │ customers.profile.v1 │ 99.90%    │ 450ms       │ 99.5%   │ ✓    │   │
<a id="__codelineno-21-10" name="__codelineno-21-10" href="#__codelineno-21-10"></a>│  │ inventory.stock.v1   │ 98.50%    │ 1200ms      │ 97.2%   │ ⚠    │   │
<a id="__codelineno-21-11" name="__codelineno-21-11" href="#__codelineno-21-11"></a>│  │ payments.txn.v1      │ 99.99%    │ 180ms       │ 100%    │ ✓    │   │
<a id="__codelineno-21-12" name="__codelineno-21-12" href="#__codelineno-21-12"></a>│  └─────────────────────────────────────────────────────────────────┘   │
<a id="__codelineno-21-13" name="__codelineno-21-13" href="#__codelineno-21-13"></a>│                                                                         │
<a id="__codelineno-21-14" name="__codelineno-21-14" href="#__codelineno-21-14"></a>│  Flux Inter-domaines                                                   │
<a id="__codelineno-21-15" name="__codelineno-21-15" href="#__codelineno-21-15"></a>│  ┌─────────────────────────────────────────────────────────────────┐   │
<a id="__codelineno-21-16" name="__codelineno-21-16" href="#__codelineno-21-16"></a>│  │                                                                  │   │
<a id="__codelineno-21-17" name="__codelineno-21-17" href="#__codelineno-21-17"></a>│  │  Orders ──────▶ Inventory ──────▶ Shipping                      │   │
<a id="__codelineno-21-18" name="__codelineno-21-18" href="#__codelineno-21-18"></a>│  │    │                │                │                          │   │
<a id="__codelineno-21-19" name="__codelineno-21-19" href="#__codelineno-21-19"></a>│  │    │                ▼                ▼                          │   │
<a id="__codelineno-21-20" name="__codelineno-21-20" href="#__codelineno-21-20"></a>│  │    └──────▶ Payments ──────▶ Notifications                      │   │
<a id="__codelineno-21-21" name="__codelineno-21-21" href="#__codelineno-21-21"></a>│  │                                                                  │   │
<a id="__codelineno-21-22" name="__codelineno-21-22" href="#__codelineno-21-22"></a>│  │  Latence end-to-end: 2.3s (SLA: 5s) ✓                          │   │
<a id="__codelineno-21-23" name="__codelineno-21-23" href="#__codelineno-21-23"></a>│  └─────────────────────────────────────────────────────────────────┘   │
<a id="__codelineno-21-24" name="__codelineno-21-24" href="#__codelineno-21-24"></a>│                                                                         │
<a id="__codelineno-21-25" name="__codelineno-21-25" href="#__codelineno-21-25"></a>│  Alertes Actives: 1                                                    │
<a id="__codelineno-21-26" name="__codelineno-21-26" href="#__codelineno-21-26"></a>│  │ ⚠ inventory.stock.v1: Latence p99 au-dessus du SLA (1200ms)    │   │
<a id="__codelineno-21-27" name="__codelineno-21-27" href="#__codelineno-21-27"></a>└─────────────────────────────────────────────────────────────────────────┘
</code></pre></div>
<blockquote>
<p><strong>Perspective stratégique</strong></p>
<p>Le Data Mesh n'est pas une technologie mais un changement organisationnel. Kafka est un excellent enabler technique, mais le succès dépend de :
- L'engagement des équipes de domaine à traiter les données comme un produit
- L'investissement dans une plateforme self-service mature
- La culture de collaboration et de standards partagés
- La capacité à mesurer et améliorer la qualité des données</p>
<p><em>Indicateur de maturité</em> : Quand une nouvelle équipe peut publier un produit de données en moins d'une journée sans intervention de l'équipe plateforme, le Data Mesh fonctionne.</p>
<p><em>Anti-pattern à éviter</em> : Créer un « Data Mesh » qui n'est qu'un Data Lake renommé avec la même équipe centrale qui fait tout le travail. Le Data Mesh requiert une véritable décentralisation.</p>
</blockquote>
<hr />
<h2 id="iii73-utilisation-de-kafka-connect">III.7.3 Utilisation de Kafka Connect<a class="headerlink" href="#iii73-utilisation-de-kafka-connect" title="Permanent link">&para;</a></h2>
<h3 id="le-role-de-kafka-connect">Le Rôle de Kafka Connect<a class="headerlink" href="#le-role-de-kafka-connect" title="Permanent link">&para;</a></h3>
<p>Kafka Connect est le framework d'intégration de l'écosystème Kafka. Il permet de connecter Kafka à des systèmes externes (bases de données, files, APIs, stockage cloud) sans écrire de code custom.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a>┌─────────────────────────────────────────────────────────────────────────┐
<a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a>│                      Architecture Kafka Connect                         │
<a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a>│                                                                         │
<a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a>│  Sources externes              Kafka              Destinations          │
<a id="__codelineno-22-5" name="__codelineno-22-5" href="#__codelineno-22-5"></a>│  ┌─────────────┐         ┌─────────────┐         ┌─────────────┐       │
<a id="__codelineno-22-6" name="__codelineno-22-6" href="#__codelineno-22-6"></a>│  │ PostgreSQL  │─┐       │             │       ┌─│ Elasticsearch│       │
<a id="__codelineno-22-7" name="__codelineno-22-7" href="#__codelineno-22-7"></a>│  └─────────────┘ │       │             │       │ └─────────────┘       │
<a id="__codelineno-22-8" name="__codelineno-22-8" href="#__codelineno-22-8"></a>│  ┌─────────────┐ │       │   Topics    │       │ ┌─────────────┐       │
<a id="__codelineno-22-9" name="__codelineno-22-9" href="#__codelineno-22-9"></a>│  │  MongoDB    │─┼──────▶│             │──────┼─│    S3       │       │
<a id="__codelineno-22-10" name="__codelineno-22-10" href="#__codelineno-22-10"></a>│  └─────────────┘ │       │             │       │ └─────────────┘       │
<a id="__codelineno-22-11" name="__codelineno-22-11" href="#__codelineno-22-11"></a>│  ┌─────────────┐ │       │             │       │ ┌─────────────┐       │
<a id="__codelineno-22-12" name="__codelineno-22-12" href="#__codelineno-22-12"></a>│  │  Salesforce │─┘       │             │       └─│  Snowflake  │       │
<a id="__codelineno-22-13" name="__codelineno-22-13" href="#__codelineno-22-13"></a>│  └─────────────┘         └─────────────┘         └─────────────┘       │
<a id="__codelineno-22-14" name="__codelineno-22-14" href="#__codelineno-22-14"></a>│        │                        │                        │              │
<a id="__codelineno-22-15" name="__codelineno-22-15" href="#__codelineno-22-15"></a>│        │     Source Connectors  │    Sink Connectors     │              │
<a id="__codelineno-22-16" name="__codelineno-22-16" href="#__codelineno-22-16"></a>│        └────────────────────────┼────────────────────────┘              │
<a id="__codelineno-22-17" name="__codelineno-22-17" href="#__codelineno-22-17"></a>│                                 │                                       │
<a id="__codelineno-22-18" name="__codelineno-22-18" href="#__codelineno-22-18"></a>│                    ┌────────────┴────────────┐                         │
<a id="__codelineno-22-19" name="__codelineno-22-19" href="#__codelineno-22-19"></a>│                    │    Kafka Connect        │                         │
<a id="__codelineno-22-20" name="__codelineno-22-20" href="#__codelineno-22-20"></a>│                    │    Workers (cluster)    │                         │
<a id="__codelineno-22-21" name="__codelineno-22-21" href="#__codelineno-22-21"></a>│                    └─────────────────────────┘                         │
<a id="__codelineno-22-22" name="__codelineno-22-22" href="#__codelineno-22-22"></a>└─────────────────────────────────────────────────────────────────────────┘
</code></pre></div>
<p><strong>Avantages de Kafka Connect</strong> :</p>
<p><em>Configuration vs. Code</em> : Les connecteurs sont configurés en JSON/YAML, pas développés. Cela réduit le temps de mise en place et les risques de bugs.</p>
<p><em>Scalabilité native</em> : Les workers Kafka Connect forment un cluster qui distribue automatiquement la charge.</p>
<p><em>Tolérance aux pannes</em> : En cas de défaillance d'un worker, les tâches sont redistribuées aux workers restants.</p>
<p><em>Écosystème riche</em> : Plus de 200 connecteurs disponibles pour les systèmes courants.</p>
<h3 id="patterns-dintegration-avec-kafka-connect">Patterns d'Intégration avec Kafka Connect<a class="headerlink" href="#patterns-dintegration-avec-kafka-connect" title="Permanent link">&para;</a></h3>
<p><strong>Pattern 1 : Change Data Capture (CDC)</strong></p>
<p>Le CDC capture les changements dans une base de données et les publie comme événements Kafka. C'est le pattern le plus puissant pour intégrer des systèmes legacy.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a>┌─────────────────┐      ┌─────────────────┐      ┌─────────────────┐
<a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a>│   PostgreSQL    │      │  Debezium       │      │    Kafka        │
<a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a>│                 │      │  Connector      │      │                 │
<a id="__codelineno-23-4" name="__codelineno-23-4" href="#__codelineno-23-4"></a>│  ┌───────────┐  │      │                 │      │  ┌───────────┐  │
<a id="__codelineno-23-5" name="__codelineno-23-5" href="#__codelineno-23-5"></a>│  │  orders   │──┼─────▶│  (reads WAL)   │─────▶│  │ orders.   │  │
<a id="__codelineno-23-6" name="__codelineno-23-6" href="#__codelineno-23-6"></a>│  │  table    │  │      │                 │      │  │ cdc       │  │
<a id="__codelineno-23-7" name="__codelineno-23-7" href="#__codelineno-23-7"></a>│  └───────────┘  │      │                 │      │  └───────────┘  │
<a id="__codelineno-23-8" name="__codelineno-23-8" href="#__codelineno-23-8"></a>│                 │      │                 │      │                 │
<a id="__codelineno-23-9" name="__codelineno-23-9" href="#__codelineno-23-9"></a>│  Transaction    │      │  Captures:      │      │  Events:        │
<a id="__codelineno-23-10" name="__codelineno-23-10" href="#__codelineno-23-10"></a>│  Log (WAL)      │      │  - INSERT       │      │  - Created      │
<a id="__codelineno-23-11" name="__codelineno-23-11" href="#__codelineno-23-11"></a>│                 │      │  - UPDATE       │      │  - Updated      │
<a id="__codelineno-23-12" name="__codelineno-23-12" href="#__codelineno-23-12"></a>│                 │      │  - DELETE       │      │  - Deleted      │
<a id="__codelineno-23-13" name="__codelineno-23-13" href="#__codelineno-23-13"></a>└─────────────────┘      └─────────────────┘      └─────────────────┘
</code></pre></div>
<p><strong>Configuration Debezium pour PostgreSQL</strong> :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a><span class="p">{</span>
<a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a><span class="w">  </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;orders-cdc-connector&quot;</span><span class="p">,</span>
<a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a><span class="w">  </span><span class="nt">&quot;config&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-24-4" name="__codelineno-24-4" href="#__codelineno-24-4"></a><span class="w">    </span><span class="nt">&quot;connector.class&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;io.debezium.connector.postgresql.PostgresConnector&quot;</span><span class="p">,</span>
<a id="__codelineno-24-5" name="__codelineno-24-5" href="#__codelineno-24-5"></a><span class="w">    </span><span class="nt">&quot;database.hostname&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;postgres.internal&quot;</span><span class="p">,</span>
<a id="__codelineno-24-6" name="__codelineno-24-6" href="#__codelineno-24-6"></a><span class="w">    </span><span class="nt">&quot;database.port&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;5432&quot;</span><span class="p">,</span>
<a id="__codelineno-24-7" name="__codelineno-24-7" href="#__codelineno-24-7"></a><span class="w">    </span><span class="nt">&quot;database.user&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;debezium&quot;</span><span class="p">,</span>
<a id="__codelineno-24-8" name="__codelineno-24-8" href="#__codelineno-24-8"></a><span class="w">    </span><span class="nt">&quot;database.password&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;${secrets:postgres-password}&quot;</span><span class="p">,</span>
<a id="__codelineno-24-9" name="__codelineno-24-9" href="#__codelineno-24-9"></a><span class="w">    </span><span class="nt">&quot;database.dbname&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;orders_db&quot;</span><span class="p">,</span>
<a id="__codelineno-24-10" name="__codelineno-24-10" href="#__codelineno-24-10"></a><span class="w">    </span><span class="nt">&quot;database.server.name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;orders&quot;</span><span class="p">,</span>
<a id="__codelineno-24-11" name="__codelineno-24-11" href="#__codelineno-24-11"></a><span class="w">    </span><span class="nt">&quot;table.include.list&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;public.orders,public.order_items&quot;</span><span class="p">,</span>
<a id="__codelineno-24-12" name="__codelineno-24-12" href="#__codelineno-24-12"></a><span class="w">    </span><span class="nt">&quot;plugin.name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;pgoutput&quot;</span><span class="p">,</span>
<a id="__codelineno-24-13" name="__codelineno-24-13" href="#__codelineno-24-13"></a>
<a id="__codelineno-24-14" name="__codelineno-24-14" href="#__codelineno-24-14"></a><span class="w">    </span><span class="nt">&quot;transforms&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;route&quot;</span><span class="p">,</span>
<a id="__codelineno-24-15" name="__codelineno-24-15" href="#__codelineno-24-15"></a><span class="w">    </span><span class="nt">&quot;transforms.route.type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;org.apache.kafka.connect.transforms.RegexRouter&quot;</span><span class="p">,</span>
<a id="__codelineno-24-16" name="__codelineno-24-16" href="#__codelineno-24-16"></a><span class="w">    </span><span class="nt">&quot;transforms.route.regex&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;orders\\.public\\.(.*)&quot;</span><span class="p">,</span>
<a id="__codelineno-24-17" name="__codelineno-24-17" href="#__codelineno-24-17"></a><span class="w">    </span><span class="nt">&quot;transforms.route.replacement&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;orders.cdc.$1&quot;</span><span class="p">,</span>
<a id="__codelineno-24-18" name="__codelineno-24-18" href="#__codelineno-24-18"></a>
<a id="__codelineno-24-19" name="__codelineno-24-19" href="#__codelineno-24-19"></a><span class="w">    </span><span class="nt">&quot;key.converter&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;io.confluent.connect.avro.AvroConverter&quot;</span><span class="p">,</span>
<a id="__codelineno-24-20" name="__codelineno-24-20" href="#__codelineno-24-20"></a><span class="w">    </span><span class="nt">&quot;key.converter.schema.registry.url&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;http://schema-registry:8081&quot;</span><span class="p">,</span>
<a id="__codelineno-24-21" name="__codelineno-24-21" href="#__codelineno-24-21"></a><span class="w">    </span><span class="nt">&quot;value.converter&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;io.confluent.connect.avro.AvroConverter&quot;</span><span class="p">,</span>
<a id="__codelineno-24-22" name="__codelineno-24-22" href="#__codelineno-24-22"></a><span class="w">    </span><span class="nt">&quot;value.converter.schema.registry.url&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;http://schema-registry:8081&quot;</span>
<a id="__codelineno-24-23" name="__codelineno-24-23" href="#__codelineno-24-23"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-24-24" name="__codelineno-24-24" href="#__codelineno-24-24"></a><span class="p">}</span>
</code></pre></div>
<p><strong>Structure d'un événement CDC</strong> :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a><span class="p">{</span>
<a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a><span class="w">  </span><span class="nt">&quot;before&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a><span class="w">    </span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">123</span><span class="p">,</span>
<a id="__codelineno-25-4" name="__codelineno-25-4" href="#__codelineno-25-4"></a><span class="w">    </span><span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;pending&quot;</span><span class="p">,</span>
<a id="__codelineno-25-5" name="__codelineno-25-5" href="#__codelineno-25-5"></a><span class="w">    </span><span class="nt">&quot;total&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">5000</span>
<a id="__codelineno-25-6" name="__codelineno-25-6" href="#__codelineno-25-6"></a><span class="w">  </span><span class="p">},</span>
<a id="__codelineno-25-7" name="__codelineno-25-7" href="#__codelineno-25-7"></a><span class="w">  </span><span class="nt">&quot;after&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-25-8" name="__codelineno-25-8" href="#__codelineno-25-8"></a><span class="w">    </span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">123</span><span class="p">,</span>
<a id="__codelineno-25-9" name="__codelineno-25-9" href="#__codelineno-25-9"></a><span class="w">    </span><span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;confirmed&quot;</span><span class="p">,</span>
<a id="__codelineno-25-10" name="__codelineno-25-10" href="#__codelineno-25-10"></a><span class="w">    </span><span class="nt">&quot;total&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">5000</span>
<a id="__codelineno-25-11" name="__codelineno-25-11" href="#__codelineno-25-11"></a><span class="w">  </span><span class="p">},</span>
<a id="__codelineno-25-12" name="__codelineno-25-12" href="#__codelineno-25-12"></a><span class="w">  </span><span class="nt">&quot;source&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-25-13" name="__codelineno-25-13" href="#__codelineno-25-13"></a><span class="w">    </span><span class="nt">&quot;version&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2.4.0.Final&quot;</span><span class="p">,</span>
<a id="__codelineno-25-14" name="__codelineno-25-14" href="#__codelineno-25-14"></a><span class="w">    </span><span class="nt">&quot;connector&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;postgresql&quot;</span><span class="p">,</span>
<a id="__codelineno-25-15" name="__codelineno-25-15" href="#__codelineno-25-15"></a><span class="w">    </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;orders&quot;</span><span class="p">,</span>
<a id="__codelineno-25-16" name="__codelineno-25-16" href="#__codelineno-25-16"></a><span class="w">    </span><span class="nt">&quot;ts_ms&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1705312200000</span><span class="p">,</span>
<a id="__codelineno-25-17" name="__codelineno-25-17" href="#__codelineno-25-17"></a><span class="w">    </span><span class="nt">&quot;snapshot&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;false&quot;</span><span class="p">,</span>
<a id="__codelineno-25-18" name="__codelineno-25-18" href="#__codelineno-25-18"></a><span class="w">    </span><span class="nt">&quot;db&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;orders_db&quot;</span><span class="p">,</span>
<a id="__codelineno-25-19" name="__codelineno-25-19" href="#__codelineno-25-19"></a><span class="w">    </span><span class="nt">&quot;schema&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;public&quot;</span><span class="p">,</span>
<a id="__codelineno-25-20" name="__codelineno-25-20" href="#__codelineno-25-20"></a><span class="w">    </span><span class="nt">&quot;table&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;orders&quot;</span><span class="p">,</span>
<a id="__codelineno-25-21" name="__codelineno-25-21" href="#__codelineno-25-21"></a><span class="w">    </span><span class="nt">&quot;txId&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">12345</span><span class="p">,</span>
<a id="__codelineno-25-22" name="__codelineno-25-22" href="#__codelineno-25-22"></a><span class="w">    </span><span class="nt">&quot;lsn&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">98765432</span>
<a id="__codelineno-25-23" name="__codelineno-25-23" href="#__codelineno-25-23"></a><span class="w">  </span><span class="p">},</span>
<a id="__codelineno-25-24" name="__codelineno-25-24" href="#__codelineno-25-24"></a><span class="w">  </span><span class="nt">&quot;op&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;u&quot;</span><span class="p">,</span>
<a id="__codelineno-25-25" name="__codelineno-25-25" href="#__codelineno-25-25"></a><span class="w">  </span><span class="nt">&quot;ts_ms&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1705312200100</span>
<a id="__codelineno-25-26" name="__codelineno-25-26" href="#__codelineno-25-26"></a><span class="p">}</span>
</code></pre></div>
<blockquote>
<p><strong>Note de terrain</strong></p>
<p><em>Contexte</em> : Migration d'un monolithe vers des microservices. Le monolithe utilisait une base PostgreSQL partagée.</p>
<p><em>Approche</em> : Debezium pour capturer les changements de la base legacy et les publier vers Kafka. Les nouveaux microservices consomment les événements CDC.</p>
<p><em>Avantages</em> :
- Pas de modification du monolithe (non-invasif)
- Latence faible (millisecondes)
- Historique complet des changements</p>
<p><em>Pièges évités</em> :
- Configurer la rétention du WAL suffisante (évite la perte d'événements)
- Monitorer le lag du connecteur (alerte si &gt; 1 minute)
- Tester le comportement lors des migrations de schéma BD</p>
</blockquote>
<p><strong>Pattern 2 : Sink vers Data Lake / Data Warehouse</strong></p>
<p>Kafka Connect peut écrire les événements vers des systèmes analytiques pour le reporting et le machine learning.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a>┌─────────────────┐      ┌─────────────────┐      ┌─────────────────┐
<a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a>│    Kafka        │      │  S3 Sink        │      │    S3 / Iceberg │
<a id="__codelineno-26-3" name="__codelineno-26-3" href="#__codelineno-26-3"></a>│                 │      │  Connector      │      │                 │
<a id="__codelineno-26-4" name="__codelineno-26-4" href="#__codelineno-26-4"></a>│  ┌───────────┐  │      │                 │      │  ┌───────────┐  │
<a id="__codelineno-26-5" name="__codelineno-26-5" href="#__codelineno-26-5"></a>│  │ orders.   │──┼─────▶│  (batches to   │─────▶│  │ /data/    │  │
<a id="__codelineno-26-6" name="__codelineno-26-6" href="#__codelineno-26-6"></a>│  │ events    │  │      │   Parquet)     │      │  │ orders/   │  │
<a id="__codelineno-26-7" name="__codelineno-26-7" href="#__codelineno-26-7"></a>│  └───────────┘  │      │                 │      │  └───────────┘  │
<a id="__codelineno-26-8" name="__codelineno-26-8" href="#__codelineno-26-8"></a>│                 │      │  - Partitioning │      │                 │
<a id="__codelineno-26-9" name="__codelineno-26-9" href="#__codelineno-26-9"></a>│                 │      │  - Compaction   │      │  Format:        │
<a id="__codelineno-26-10" name="__codelineno-26-10" href="#__codelineno-26-10"></a>│                 │      │  - Schema evol. │      │  Parquet/Iceberg│
<a id="__codelineno-26-11" name="__codelineno-26-11" href="#__codelineno-26-11"></a>└─────────────────┘      └─────────────────┘      └─────────────────┘
</code></pre></div>
<p><strong>Configuration S3 Sink avec partitionnement temporel</strong> :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a><span class="p">{</span>
<a id="__codelineno-27-2" name="__codelineno-27-2" href="#__codelineno-27-2"></a><span class="w">  </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;orders-s3-sink&quot;</span><span class="p">,</span>
<a id="__codelineno-27-3" name="__codelineno-27-3" href="#__codelineno-27-3"></a><span class="w">  </span><span class="nt">&quot;config&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-27-4" name="__codelineno-27-4" href="#__codelineno-27-4"></a><span class="w">    </span><span class="nt">&quot;connector.class&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;io.confluent.connect.s3.S3SinkConnector&quot;</span><span class="p">,</span>
<a id="__codelineno-27-5" name="__codelineno-27-5" href="#__codelineno-27-5"></a><span class="w">    </span><span class="nt">&quot;tasks.max&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;4&quot;</span><span class="p">,</span>
<a id="__codelineno-27-6" name="__codelineno-27-6" href="#__codelineno-27-6"></a><span class="w">    </span><span class="nt">&quot;topics&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;orders.events.v1&quot;</span><span class="p">,</span>
<a id="__codelineno-27-7" name="__codelineno-27-7" href="#__codelineno-27-7"></a>
<a id="__codelineno-27-8" name="__codelineno-27-8" href="#__codelineno-27-8"></a><span class="w">    </span><span class="nt">&quot;s3.region&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;ca-central-1&quot;</span><span class="p">,</span>
<a id="__codelineno-27-9" name="__codelineno-27-9" href="#__codelineno-27-9"></a><span class="w">    </span><span class="nt">&quot;s3.bucket.name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;company-data-lake&quot;</span><span class="p">,</span>
<a id="__codelineno-27-10" name="__codelineno-27-10" href="#__codelineno-27-10"></a><span class="w">    </span><span class="nt">&quot;s3.part.size&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;52428800&quot;</span><span class="p">,</span>
<a id="__codelineno-27-11" name="__codelineno-27-11" href="#__codelineno-27-11"></a>
<a id="__codelineno-27-12" name="__codelineno-27-12" href="#__codelineno-27-12"></a><span class="w">    </span><span class="nt">&quot;storage.class&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;io.confluent.connect.s3.storage.S3Storage&quot;</span><span class="p">,</span>
<a id="__codelineno-27-13" name="__codelineno-27-13" href="#__codelineno-27-13"></a><span class="w">    </span><span class="nt">&quot;format.class&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;io.confluent.connect.s3.format.parquet.ParquetFormat&quot;</span><span class="p">,</span>
<a id="__codelineno-27-14" name="__codelineno-27-14" href="#__codelineno-27-14"></a><span class="w">    </span><span class="nt">&quot;parquet.codec&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;snappy&quot;</span><span class="p">,</span>
<a id="__codelineno-27-15" name="__codelineno-27-15" href="#__codelineno-27-15"></a>
<a id="__codelineno-27-16" name="__codelineno-27-16" href="#__codelineno-27-16"></a><span class="w">    </span><span class="nt">&quot;partitioner.class&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;io.confluent.connect.storage.partitioner.TimeBasedPartitioner&quot;</span><span class="p">,</span>
<a id="__codelineno-27-17" name="__codelineno-27-17" href="#__codelineno-27-17"></a><span class="w">    </span><span class="nt">&quot;path.format&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&#39;year&#39;=YYYY/&#39;month&#39;=MM/&#39;day&#39;=dd/&#39;hour&#39;=HH&quot;</span><span class="p">,</span>
<a id="__codelineno-27-18" name="__codelineno-27-18" href="#__codelineno-27-18"></a><span class="w">    </span><span class="nt">&quot;locale&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;en-CA&quot;</span><span class="p">,</span>
<a id="__codelineno-27-19" name="__codelineno-27-19" href="#__codelineno-27-19"></a><span class="w">    </span><span class="nt">&quot;timezone&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;America/Toronto&quot;</span><span class="p">,</span>
<a id="__codelineno-27-20" name="__codelineno-27-20" href="#__codelineno-27-20"></a><span class="w">    </span><span class="nt">&quot;partition.duration.ms&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;3600000&quot;</span><span class="p">,</span>
<a id="__codelineno-27-21" name="__codelineno-27-21" href="#__codelineno-27-21"></a>
<a id="__codelineno-27-22" name="__codelineno-27-22" href="#__codelineno-27-22"></a><span class="w">    </span><span class="nt">&quot;flush.size&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;10000&quot;</span><span class="p">,</span>
<a id="__codelineno-27-23" name="__codelineno-27-23" href="#__codelineno-27-23"></a><span class="w">    </span><span class="nt">&quot;rotate.interval.ms&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;600000&quot;</span><span class="p">,</span>
<a id="__codelineno-27-24" name="__codelineno-27-24" href="#__codelineno-27-24"></a>
<a id="__codelineno-27-25" name="__codelineno-27-25" href="#__codelineno-27-25"></a><span class="w">    </span><span class="nt">&quot;key.converter&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;io.confluent.connect.avro.AvroConverter&quot;</span><span class="p">,</span>
<a id="__codelineno-27-26" name="__codelineno-27-26" href="#__codelineno-27-26"></a><span class="w">    </span><span class="nt">&quot;key.converter.schema.registry.url&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;http://schema-registry:8081&quot;</span><span class="p">,</span>
<a id="__codelineno-27-27" name="__codelineno-27-27" href="#__codelineno-27-27"></a><span class="w">    </span><span class="nt">&quot;value.converter&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;io.confluent.connect.avro.AvroConverter&quot;</span><span class="p">,</span>
<a id="__codelineno-27-28" name="__codelineno-27-28" href="#__codelineno-27-28"></a><span class="w">    </span><span class="nt">&quot;value.converter.schema.registry.url&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;http://schema-registry:8081&quot;</span>
<a id="__codelineno-27-29" name="__codelineno-27-29" href="#__codelineno-27-29"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-27-30" name="__codelineno-27-30" href="#__codelineno-27-30"></a><span class="p">}</span>
</code></pre></div>
<p><strong>Pattern 3 : Intégration API avec HTTP Sink</strong></p>
<p>Pour les systèmes sans connecteur natif, le HTTP Sink permet d'appeler des APIs REST.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a><span class="p">{</span>
<a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a><span class="w">  </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;webhook-sink&quot;</span><span class="p">,</span>
<a id="__codelineno-28-3" name="__codelineno-28-3" href="#__codelineno-28-3"></a><span class="w">  </span><span class="nt">&quot;config&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-28-4" name="__codelineno-28-4" href="#__codelineno-28-4"></a><span class="w">    </span><span class="nt">&quot;connector.class&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;io.confluent.connect.http.HttpSinkConnector&quot;</span><span class="p">,</span>
<a id="__codelineno-28-5" name="__codelineno-28-5" href="#__codelineno-28-5"></a><span class="w">    </span><span class="nt">&quot;tasks.max&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2&quot;</span><span class="p">,</span>
<a id="__codelineno-28-6" name="__codelineno-28-6" href="#__codelineno-28-6"></a><span class="w">    </span><span class="nt">&quot;topics&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;notifications.events.v1&quot;</span><span class="p">,</span>
<a id="__codelineno-28-7" name="__codelineno-28-7" href="#__codelineno-28-7"></a>
<a id="__codelineno-28-8" name="__codelineno-28-8" href="#__codelineno-28-8"></a><span class="w">    </span><span class="nt">&quot;http.api.url&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;https://api.external-system.com/events&quot;</span><span class="p">,</span>
<a id="__codelineno-28-9" name="__codelineno-28-9" href="#__codelineno-28-9"></a><span class="w">    </span><span class="nt">&quot;request.method&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;POST&quot;</span><span class="p">,</span>
<a id="__codelineno-28-10" name="__codelineno-28-10" href="#__codelineno-28-10"></a><span class="w">    </span><span class="nt">&quot;headers&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Content-Type:application/json|Authorization:Bearer ${secrets:api-token}&quot;</span><span class="p">,</span>
<a id="__codelineno-28-11" name="__codelineno-28-11" href="#__codelineno-28-11"></a>
<a id="__codelineno-28-12" name="__codelineno-28-12" href="#__codelineno-28-12"></a><span class="w">    </span><span class="nt">&quot;batch.max.size&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;100&quot;</span><span class="p">,</span>
<a id="__codelineno-28-13" name="__codelineno-28-13" href="#__codelineno-28-13"></a><span class="w">    </span><span class="nt">&quot;request.body.format&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;json&quot;</span><span class="p">,</span>
<a id="__codelineno-28-14" name="__codelineno-28-14" href="#__codelineno-28-14"></a>
<a id="__codelineno-28-15" name="__codelineno-28-15" href="#__codelineno-28-15"></a><span class="w">    </span><span class="nt">&quot;retry.on.status.codes&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;500-599&quot;</span><span class="p">,</span>
<a id="__codelineno-28-16" name="__codelineno-28-16" href="#__codelineno-28-16"></a><span class="w">    </span><span class="nt">&quot;max.retries&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;5&quot;</span><span class="p">,</span>
<a id="__codelineno-28-17" name="__codelineno-28-17" href="#__codelineno-28-17"></a><span class="w">    </span><span class="nt">&quot;retry.backoff.ms&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;1000&quot;</span><span class="p">,</span>
<a id="__codelineno-28-18" name="__codelineno-28-18" href="#__codelineno-28-18"></a>
<a id="__codelineno-28-19" name="__codelineno-28-19" href="#__codelineno-28-19"></a><span class="w">    </span><span class="nt">&quot;behavior.on.error&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;log&quot;</span><span class="p">,</span>
<a id="__codelineno-28-20" name="__codelineno-28-20" href="#__codelineno-28-20"></a>
<a id="__codelineno-28-21" name="__codelineno-28-21" href="#__codelineno-28-21"></a><span class="w">    </span><span class="nt">&quot;key.converter&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;org.apache.kafka.connect.storage.StringConverter&quot;</span><span class="p">,</span>
<a id="__codelineno-28-22" name="__codelineno-28-22" href="#__codelineno-28-22"></a><span class="w">    </span><span class="nt">&quot;value.converter&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;org.apache.kafka.connect.json.JsonConverter&quot;</span><span class="p">,</span>
<a id="__codelineno-28-23" name="__codelineno-28-23" href="#__codelineno-28-23"></a><span class="w">    </span><span class="nt">&quot;value.converter.schemas.enable&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;false&quot;</span>
<a id="__codelineno-28-24" name="__codelineno-28-24" href="#__codelineno-28-24"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-28-25" name="__codelineno-28-25" href="#__codelineno-28-25"></a><span class="p">}</span>
</code></pre></div>
<h3 id="gestion-des-erreurs-dans-kafka-connect">Gestion des Erreurs dans Kafka Connect<a class="headerlink" href="#gestion-des-erreurs-dans-kafka-connect" title="Permanent link">&para;</a></h3>
<p><strong>Dead Letter Queue pour les erreurs</strong> :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a><span class="p">{</span>
<a id="__codelineno-29-2" name="__codelineno-29-2" href="#__codelineno-29-2"></a><span class="w">  </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;orders-sink-with-dlq&quot;</span><span class="p">,</span>
<a id="__codelineno-29-3" name="__codelineno-29-3" href="#__codelineno-29-3"></a><span class="w">  </span><span class="nt">&quot;config&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-29-4" name="__codelineno-29-4" href="#__codelineno-29-4"></a><span class="w">    </span><span class="nt">&quot;connector.class&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;...&quot;</span><span class="p">,</span>
<a id="__codelineno-29-5" name="__codelineno-29-5" href="#__codelineno-29-5"></a>
<a id="__codelineno-29-6" name="__codelineno-29-6" href="#__codelineno-29-6"></a><span class="w">    </span><span class="nt">&quot;errors.tolerance&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;all&quot;</span><span class="p">,</span>
<a id="__codelineno-29-7" name="__codelineno-29-7" href="#__codelineno-29-7"></a><span class="w">    </span><span class="nt">&quot;errors.deadletterqueue.topic.name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;orders-sink-dlq&quot;</span><span class="p">,</span>
<a id="__codelineno-29-8" name="__codelineno-29-8" href="#__codelineno-29-8"></a><span class="w">    </span><span class="nt">&quot;errors.deadletterqueue.topic.replication.factor&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;3&quot;</span><span class="p">,</span>
<a id="__codelineno-29-9" name="__codelineno-29-9" href="#__codelineno-29-9"></a><span class="w">    </span><span class="nt">&quot;errors.deadletterqueue.context.headers.enable&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;true&quot;</span><span class="p">,</span>
<a id="__codelineno-29-10" name="__codelineno-29-10" href="#__codelineno-29-10"></a>
<a id="__codelineno-29-11" name="__codelineno-29-11" href="#__codelineno-29-11"></a><span class="w">    </span><span class="nt">&quot;errors.log.enable&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;true&quot;</span><span class="p">,</span>
<a id="__codelineno-29-12" name="__codelineno-29-12" href="#__codelineno-29-12"></a><span class="w">    </span><span class="nt">&quot;errors.log.include.messages&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;true&quot;</span>
<a id="__codelineno-29-13" name="__codelineno-29-13" href="#__codelineno-29-13"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-29-14" name="__codelineno-29-14" href="#__codelineno-29-14"></a><span class="p">}</span>
</code></pre></div>
<p><strong>Structure des headers DLQ</strong> :</p>
<table>
<thead>
<tr>
<th>Header</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>__connect.errors.topic</code></td>
<td>Topic source du message en erreur</td>
</tr>
<tr>
<td><code>__connect.errors.partition</code></td>
<td>Partition source</td>
</tr>
<tr>
<td><code>__connect.errors.offset</code></td>
<td>Offset du message</td>
</tr>
<tr>
<td><code>__connect.errors.connector.name</code></td>
<td>Nom du connecteur</td>
</tr>
<tr>
<td><code>__connect.errors.task.id</code></td>
<td>ID de la tâche</td>
</tr>
<tr>
<td><code>__connect.errors.exception.class</code></td>
<td>Classe de l'exception</td>
</tr>
<tr>
<td><code>__connect.errors.exception.message</code></td>
<td>Message d'erreur</td>
</tr>
<tr>
<td><code>__connect.errors.exception.stacktrace</code></td>
<td>Stack trace complète</td>
</tr>
</tbody>
</table>
<h3 id="monitoring-de-kafka-connect">Monitoring de Kafka Connect<a class="headerlink" href="#monitoring-de-kafka-connect" title="Permanent link">&para;</a></h3>
<p><strong>Métriques JMX essentielles</strong> :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a># Santé des connecteurs
<a id="__codelineno-30-2" name="__codelineno-30-2" href="#__codelineno-30-2"></a>kafka.connect:type=connector-metrics,connector=*
<a id="__codelineno-30-3" name="__codelineno-30-3" href="#__codelineno-30-3"></a>  - connector-status (running/paused/failed)
<a id="__codelineno-30-4" name="__codelineno-30-4" href="#__codelineno-30-4"></a>  - connector-type (source/sink)
<a id="__codelineno-30-5" name="__codelineno-30-5" href="#__codelineno-30-5"></a>
<a id="__codelineno-30-6" name="__codelineno-30-6" href="#__codelineno-30-6"></a># Performance des tâches
<a id="__codelineno-30-7" name="__codelineno-30-7" href="#__codelineno-30-7"></a>kafka.connect:type=task-metrics,connector=*,task=*
<a id="__codelineno-30-8" name="__codelineno-30-8" href="#__codelineno-30-8"></a>  - batch-size-avg
<a id="__codelineno-30-9" name="__codelineno-30-9" href="#__codelineno-30-9"></a>  - batch-size-max
<a id="__codelineno-30-10" name="__codelineno-30-10" href="#__codelineno-30-10"></a>  - offset-commit-success-rate
<a id="__codelineno-30-11" name="__codelineno-30-11" href="#__codelineno-30-11"></a>  - offset-commit-failure-rate
<a id="__codelineno-30-12" name="__codelineno-30-12" href="#__codelineno-30-12"></a>
<a id="__codelineno-30-13" name="__codelineno-30-13" href="#__codelineno-30-13"></a># Erreurs
<a id="__codelineno-30-14" name="__codelineno-30-14" href="#__codelineno-30-14"></a>kafka.connect:type=task-error-metrics,connector=*,task=*
<a id="__codelineno-30-15" name="__codelineno-30-15" href="#__codelineno-30-15"></a>  - total-errors-logged
<a id="__codelineno-30-16" name="__codelineno-30-16" href="#__codelineno-30-16"></a>  - total-records-failed
<a id="__codelineno-30-17" name="__codelineno-30-17" href="#__codelineno-30-17"></a>  - total-records-skipped
<a id="__codelineno-30-18" name="__codelineno-30-18" href="#__codelineno-30-18"></a>  - deadletterqueue-produce-requests
</code></pre></div>
<p><strong>Dashboard de monitoring recommandé</strong> :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a>┌─────────────────────────────────────────────────────────────────────────┐
<a id="__codelineno-31-2" name="__codelineno-31-2" href="#__codelineno-31-2"></a>│                    Kafka Connect Dashboard                              │
<a id="__codelineno-31-3" name="__codelineno-31-3" href="#__codelineno-31-3"></a>│                                                                         │
<a id="__codelineno-31-4" name="__codelineno-31-4" href="#__codelineno-31-4"></a>│  Connecteurs actifs: 12/12 ✓        Workers: 3/3 ✓                     │
<a id="__codelineno-31-5" name="__codelineno-31-5" href="#__codelineno-31-5"></a>│                                                                         │
<a id="__codelineno-31-6" name="__codelineno-31-6" href="#__codelineno-31-6"></a>│  ┌─────────────────────────────────────────────────────────────────┐   │
<a id="__codelineno-31-7" name="__codelineno-31-7" href="#__codelineno-31-7"></a>│  │ Throughput (messages/sec)                                        │   │
<a id="__codelineno-31-8" name="__codelineno-31-8" href="#__codelineno-31-8"></a>│  │ ████████████████████████████████████░░░░░░ 45,000 msg/s         │   │
<a id="__codelineno-31-9" name="__codelineno-31-9" href="#__codelineno-31-9"></a>│  └─────────────────────────────────────────────────────────────────┘   │
<a id="__codelineno-31-10" name="__codelineno-31-10" href="#__codelineno-31-10"></a>│                                                                         │
<a id="__codelineno-31-11" name="__codelineno-31-11" href="#__codelineno-31-11"></a>│  ┌─────────────────────────────────────────────────────────────────┐   │
<a id="__codelineno-31-12" name="__codelineno-31-12" href="#__codelineno-31-12"></a>│  │ Error Rate                                                       │   │
<a id="__codelineno-31-13" name="__codelineno-31-13" href="#__codelineno-31-13"></a>│  │ ░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░ 0.02%               │   │
<a id="__codelineno-31-14" name="__codelineno-31-14" href="#__codelineno-31-14"></a>│  └─────────────────────────────────────────────────────────────────┘   │
<a id="__codelineno-31-15" name="__codelineno-31-15" href="#__codelineno-31-15"></a>│                                                                         │
<a id="__codelineno-31-16" name="__codelineno-31-16" href="#__codelineno-31-16"></a>│  Connecteurs avec erreurs:                                             │
<a id="__codelineno-31-17" name="__codelineno-31-17" href="#__codelineno-31-17"></a>│  │ salesforce-source │ 3 erreurs │ Voir DLQ │                         │
<a id="__codelineno-31-18" name="__codelineno-31-18" href="#__codelineno-31-18"></a>│                                                                         │
<a id="__codelineno-31-19" name="__codelineno-31-19" href="#__codelineno-31-19"></a>│  Top connecteurs par volume:                                           │
<a id="__codelineno-31-20" name="__codelineno-31-20" href="#__codelineno-31-20"></a>│  │ orders-cdc        │ 15,000 msg/s │ lag: 0    │                     │
<a id="__codelineno-31-21" name="__codelineno-31-21" href="#__codelineno-31-21"></a>│  │ customers-cdc     │ 8,000 msg/s  │ lag: 120  │                     │
<a id="__codelineno-31-22" name="__codelineno-31-22" href="#__codelineno-31-22"></a>│  │ s3-sink           │ 22,000 msg/s │ lag: 500  │                     │
<a id="__codelineno-31-23" name="__codelineno-31-23" href="#__codelineno-31-23"></a>└─────────────────────────────────────────────────────────────────────────┘
</code></pre></div>
<h3 id="transformations-single-message-transforms-smt">Transformations Single Message Transforms (SMT)<a class="headerlink" href="#transformations-single-message-transforms-smt" title="Permanent link">&para;</a></h3>
<p>Les SMT permettent de transformer les messages à la volée sans code custom. Elles sont essentielles pour adapter les données sources au format cible.</p>
<p><strong>Transformations courantes</strong> :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a><span class="p">{</span>
<a id="__codelineno-32-2" name="__codelineno-32-2" href="#__codelineno-32-2"></a><span class="w">  </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;orders-cdc-with-transforms&quot;</span><span class="p">,</span>
<a id="__codelineno-32-3" name="__codelineno-32-3" href="#__codelineno-32-3"></a><span class="w">  </span><span class="nt">&quot;config&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-32-4" name="__codelineno-32-4" href="#__codelineno-32-4"></a><span class="w">    </span><span class="nt">&quot;connector.class&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;io.debezium.connector.postgresql.PostgresConnector&quot;</span><span class="p">,</span>
<a id="__codelineno-32-5" name="__codelineno-32-5" href="#__codelineno-32-5"></a><span class="w">    </span><span class="nt">&quot;database.hostname&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;postgres&quot;</span><span class="p">,</span>
<a id="__codelineno-32-6" name="__codelineno-32-6" href="#__codelineno-32-6"></a><span class="w">    </span><span class="nt">&quot;database.dbname&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;orders&quot;</span><span class="p">,</span>
<a id="__codelineno-32-7" name="__codelineno-32-7" href="#__codelineno-32-7"></a>
<a id="__codelineno-32-8" name="__codelineno-32-8" href="#__codelineno-32-8"></a><span class="w">    </span><span class="nt">&quot;transforms&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;route,unwrap,timestamp,mask&quot;</span><span class="p">,</span>
<a id="__codelineno-32-9" name="__codelineno-32-9" href="#__codelineno-32-9"></a>
<a id="__codelineno-32-10" name="__codelineno-32-10" href="#__codelineno-32-10"></a><span class="w">    </span><span class="nt">&quot;transforms.route.type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;org.apache.kafka.connect.transforms.RegexRouter&quot;</span><span class="p">,</span>
<a id="__codelineno-32-11" name="__codelineno-32-11" href="#__codelineno-32-11"></a><span class="w">    </span><span class="nt">&quot;transforms.route.regex&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;orders\\.public\\.(.*)&quot;</span><span class="p">,</span>
<a id="__codelineno-32-12" name="__codelineno-32-12" href="#__codelineno-32-12"></a><span class="w">    </span><span class="nt">&quot;transforms.route.replacement&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;cdc.$1.events&quot;</span><span class="p">,</span>
<a id="__codelineno-32-13" name="__codelineno-32-13" href="#__codelineno-32-13"></a>
<a id="__codelineno-32-14" name="__codelineno-32-14" href="#__codelineno-32-14"></a><span class="w">    </span><span class="nt">&quot;transforms.unwrap.type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;io.debezium.transforms.ExtractNewRecordState&quot;</span><span class="p">,</span>
<a id="__codelineno-32-15" name="__codelineno-32-15" href="#__codelineno-32-15"></a><span class="w">    </span><span class="nt">&quot;transforms.unwrap.drop.tombstones&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;false&quot;</span><span class="p">,</span>
<a id="__codelineno-32-16" name="__codelineno-32-16" href="#__codelineno-32-16"></a><span class="w">    </span><span class="nt">&quot;transforms.unwrap.delete.handling.mode&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;rewrite&quot;</span><span class="p">,</span>
<a id="__codelineno-32-17" name="__codelineno-32-17" href="#__codelineno-32-17"></a><span class="w">    </span><span class="nt">&quot;transforms.unwrap.add.fields&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;op,source.ts_ms&quot;</span><span class="p">,</span>
<a id="__codelineno-32-18" name="__codelineno-32-18" href="#__codelineno-32-18"></a>
<a id="__codelineno-32-19" name="__codelineno-32-19" href="#__codelineno-32-19"></a><span class="w">    </span><span class="nt">&quot;transforms.timestamp.type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;org.apache.kafka.connect.transforms.InsertField$Value&quot;</span><span class="p">,</span>
<a id="__codelineno-32-20" name="__codelineno-32-20" href="#__codelineno-32-20"></a><span class="w">    </span><span class="nt">&quot;transforms.timestamp.timestamp.field&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;kafka_timestamp&quot;</span><span class="p">,</span>
<a id="__codelineno-32-21" name="__codelineno-32-21" href="#__codelineno-32-21"></a>
<a id="__codelineno-32-22" name="__codelineno-32-22" href="#__codelineno-32-22"></a><span class="w">    </span><span class="nt">&quot;transforms.mask.type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;org.apache.kafka.connect.transforms.MaskField$Value&quot;</span><span class="p">,</span>
<a id="__codelineno-32-23" name="__codelineno-32-23" href="#__codelineno-32-23"></a><span class="w">    </span><span class="nt">&quot;transforms.mask.fields&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;credit_card_number,ssn&quot;</span><span class="p">,</span>
<a id="__codelineno-32-24" name="__codelineno-32-24" href="#__codelineno-32-24"></a><span class="w">    </span><span class="nt">&quot;transforms.mask.replacement&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;****&quot;</span>
<a id="__codelineno-32-25" name="__codelineno-32-25" href="#__codelineno-32-25"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-32-26" name="__codelineno-32-26" href="#__codelineno-32-26"></a><span class="p">}</span>
</code></pre></div>
<p><strong>Transformation personnalisée</strong> :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">EnrichWithEnvironment</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">Transformation</span><span class="o">&lt;</span><span class="n">SourceRecord</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-33-2" name="__codelineno-33-2" href="#__codelineno-33-2"></a>
<a id="__codelineno-33-3" name="__codelineno-33-3" href="#__codelineno-33-3"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">environment</span><span class="p">;</span>
<a id="__codelineno-33-4" name="__codelineno-33-4" href="#__codelineno-33-4"></a>
<a id="__codelineno-33-5" name="__codelineno-33-5" href="#__codelineno-33-5"></a><span class="w">    </span><span class="nd">@Override</span>
<a id="__codelineno-33-6" name="__codelineno-33-6" href="#__codelineno-33-6"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">configure</span><span class="p">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="o">?&gt;</span><span class="w"> </span><span class="n">configs</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-33-7" name="__codelineno-33-7" href="#__codelineno-33-7"></a><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">environment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">String</span><span class="p">)</span><span class="w"> </span><span class="n">configs</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">&quot;environment&quot;</span><span class="p">);</span>
<a id="__codelineno-33-8" name="__codelineno-33-8" href="#__codelineno-33-8"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-33-9" name="__codelineno-33-9" href="#__codelineno-33-9"></a>
<a id="__codelineno-33-10" name="__codelineno-33-10" href="#__codelineno-33-10"></a><span class="w">    </span><span class="nd">@Override</span>
<a id="__codelineno-33-11" name="__codelineno-33-11" href="#__codelineno-33-11"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">SourceRecord</span><span class="w"> </span><span class="nf">apply</span><span class="p">(</span><span class="n">SourceRecord</span><span class="w"> </span><span class="n">record</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-33-12" name="__codelineno-33-12" href="#__codelineno-33-12"></a><span class="w">        </span><span class="n">Struct</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Struct</span><span class="p">)</span><span class="w"> </span><span class="n">record</span><span class="p">.</span><span class="na">value</span><span class="p">();</span>
<a id="__codelineno-33-13" name="__codelineno-33-13" href="#__codelineno-33-13"></a>
<a id="__codelineno-33-14" name="__codelineno-33-14" href="#__codelineno-33-14"></a><span class="w">        </span><span class="c1">// Créer une nouvelle structure enrichie</span>
<a id="__codelineno-33-15" name="__codelineno-33-15" href="#__codelineno-33-15"></a><span class="w">        </span><span class="n">Schema</span><span class="w"> </span><span class="n">newSchema</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SchemaBuilder</span><span class="p">.</span><span class="na">struct</span><span class="p">()</span>
<a id="__codelineno-33-16" name="__codelineno-33-16" href="#__codelineno-33-16"></a><span class="w">            </span><span class="p">.</span><span class="na">field</span><span class="p">(</span><span class="s">&quot;environment&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Schema</span><span class="p">.</span><span class="na">STRING_SCHEMA</span><span class="p">)</span>
<a id="__codelineno-33-17" name="__codelineno-33-17" href="#__codelineno-33-17"></a><span class="w">            </span><span class="p">.</span><span class="na">field</span><span class="p">(</span><span class="s">&quot;data&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">record</span><span class="p">.</span><span class="na">valueSchema</span><span class="p">())</span>
<a id="__codelineno-33-18" name="__codelineno-33-18" href="#__codelineno-33-18"></a><span class="w">            </span><span class="p">.</span><span class="na">build</span><span class="p">();</span>
<a id="__codelineno-33-19" name="__codelineno-33-19" href="#__codelineno-33-19"></a>
<a id="__codelineno-33-20" name="__codelineno-33-20" href="#__codelineno-33-20"></a><span class="w">        </span><span class="n">Struct</span><span class="w"> </span><span class="n">newValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Struct</span><span class="p">(</span><span class="n">newSchema</span><span class="p">)</span>
<a id="__codelineno-33-21" name="__codelineno-33-21" href="#__codelineno-33-21"></a><span class="w">            </span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;environment&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">environment</span><span class="p">)</span>
<a id="__codelineno-33-22" name="__codelineno-33-22" href="#__codelineno-33-22"></a><span class="w">            </span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;data&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">);</span>
<a id="__codelineno-33-23" name="__codelineno-33-23" href="#__codelineno-33-23"></a>
<a id="__codelineno-33-24" name="__codelineno-33-24" href="#__codelineno-33-24"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">record</span><span class="p">.</span><span class="na">newRecord</span><span class="p">(</span>
<a id="__codelineno-33-25" name="__codelineno-33-25" href="#__codelineno-33-25"></a><span class="w">            </span><span class="kd">record</span><span class="err">.</span><span class="nc">topic</span><span class="p">(),</span>
<a id="__codelineno-33-26" name="__codelineno-33-26" href="#__codelineno-33-26"></a><span class="w">            </span><span class="kd">record</span><span class="err">.</span><span class="nc">kafkaPartition</span><span class="p">(),</span>
<a id="__codelineno-33-27" name="__codelineno-33-27" href="#__codelineno-33-27"></a><span class="w">            </span><span class="kd">record</span><span class="err">.</span><span class="nc">keySchema</span><span class="p">(),</span>
<a id="__codelineno-33-28" name="__codelineno-33-28" href="#__codelineno-33-28"></a><span class="w">            </span><span class="kd">record</span><span class="err">.</span><span class="nc">key</span><span class="p">(),</span>
<a id="__codelineno-33-29" name="__codelineno-33-29" href="#__codelineno-33-29"></a><span class="w">            </span><span class="n">newSchema</span><span class="p">,</span>
<a id="__codelineno-33-30" name="__codelineno-33-30" href="#__codelineno-33-30"></a><span class="w">            </span><span class="n">newValue</span><span class="p">,</span>
<a id="__codelineno-33-31" name="__codelineno-33-31" href="#__codelineno-33-31"></a><span class="w">            </span><span class="kd">record</span><span class="err">.</span><span class="nc">timestamp</span><span class="p">()</span>
<a id="__codelineno-33-32" name="__codelineno-33-32" href="#__codelineno-33-32"></a><span class="w">        </span><span class="p">);</span>
<a id="__codelineno-33-33" name="__codelineno-33-33" href="#__codelineno-33-33"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-33-34" name="__codelineno-33-34" href="#__codelineno-33-34"></a>
<a id="__codelineno-33-35" name="__codelineno-33-35" href="#__codelineno-33-35"></a><span class="w">    </span><span class="nd">@Override</span>
<a id="__codelineno-33-36" name="__codelineno-33-36" href="#__codelineno-33-36"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">ConfigDef</span><span class="w"> </span><span class="nf">config</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-33-37" name="__codelineno-33-37" href="#__codelineno-33-37"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ConfigDef</span><span class="p">()</span>
<a id="__codelineno-33-38" name="__codelineno-33-38" href="#__codelineno-33-38"></a><span class="w">            </span><span class="p">.</span><span class="na">define</span><span class="p">(</span><span class="s">&quot;environment&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ConfigDef</span><span class="p">.</span><span class="na">Type</span><span class="p">.</span><span class="na">STRING</span><span class="p">,</span><span class="w"> </span>
<a id="__codelineno-33-39" name="__codelineno-33-39" href="#__codelineno-33-39"></a><span class="w">                    </span><span class="n">ConfigDef</span><span class="p">.</span><span class="na">Importance</span><span class="p">.</span><span class="na">HIGH</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Environment name&quot;</span><span class="p">);</span>
<a id="__codelineno-33-40" name="__codelineno-33-40" href="#__codelineno-33-40"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-33-41" name="__codelineno-33-41" href="#__codelineno-33-41"></a>
<a id="__codelineno-33-42" name="__codelineno-33-42" href="#__codelineno-33-42"></a><span class="w">    </span><span class="nd">@Override</span>
<a id="__codelineno-33-43" name="__codelineno-33-43" href="#__codelineno-33-43"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">close</span><span class="p">()</span><span class="w"> </span><span class="p">{}</span>
<a id="__codelineno-33-44" name="__codelineno-33-44" href="#__codelineno-33-44"></a><span class="p">}</span>
</code></pre></div>
<h3 id="scalabilite-et-haute-disponibilite-de-kafka-connect">Scalabilité et Haute Disponibilité de Kafka Connect<a class="headerlink" href="#scalabilite-et-haute-disponibilite-de-kafka-connect" title="Permanent link">&para;</a></h3>
<p><strong>Architecture distribuée</strong> :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-34-1" name="__codelineno-34-1" href="#__codelineno-34-1"></a>┌─────────────────────────────────────────────────────────────────────────┐
<a id="__codelineno-34-2" name="__codelineno-34-2" href="#__codelineno-34-2"></a>│                Cluster Kafka Connect Distribué                          │
<a id="__codelineno-34-3" name="__codelineno-34-3" href="#__codelineno-34-3"></a>│                                                                         │
<a id="__codelineno-34-4" name="__codelineno-34-4" href="#__codelineno-34-4"></a>│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐         │
<a id="__codelineno-34-5" name="__codelineno-34-5" href="#__codelineno-34-5"></a>│  │ Worker 1        │  │ Worker 2        │  │ Worker 3        │         │
<a id="__codelineno-34-6" name="__codelineno-34-6" href="#__codelineno-34-6"></a>│  │                 │  │                 │  │                 │         │
<a id="__codelineno-34-7" name="__codelineno-34-7" href="#__codelineno-34-7"></a>│  │ Connector A     │  │ Connector A     │  │ Connector B     │         │
<a id="__codelineno-34-8" name="__codelineno-34-8" href="#__codelineno-34-8"></a>│  │ Task 0          │  │ Task 1          │  │ Task 0          │         │
<a id="__codelineno-34-9" name="__codelineno-34-9" href="#__codelineno-34-9"></a>│  │                 │  │                 │  │                 │         │
<a id="__codelineno-34-10" name="__codelineno-34-10" href="#__codelineno-34-10"></a>│  │ Connector B     │  │ Connector C     │  │ Connector C     │         │
<a id="__codelineno-34-11" name="__codelineno-34-11" href="#__codelineno-34-11"></a>│  │ Task 1          │  │ Task 0          │  │ Task 1          │         │
<a id="__codelineno-34-12" name="__codelineno-34-12" href="#__codelineno-34-12"></a>│  └────────┬────────┘  └────────┬────────┘  └────────┬────────┘         │
<a id="__codelineno-34-13" name="__codelineno-34-13" href="#__codelineno-34-13"></a>│           │                    │                    │                   │
<a id="__codelineno-34-14" name="__codelineno-34-14" href="#__codelineno-34-14"></a>│           └────────────────────┼────────────────────┘                   │
<a id="__codelineno-34-15" name="__codelineno-34-15" href="#__codelineno-34-15"></a>│                                │                                        │
<a id="__codelineno-34-16" name="__codelineno-34-16" href="#__codelineno-34-16"></a>│                                ▼                                        │
<a id="__codelineno-34-17" name="__codelineno-34-17" href="#__codelineno-34-17"></a>│  ┌─────────────────────────────────────────────────────────────────┐   │
<a id="__codelineno-34-18" name="__codelineno-34-18" href="#__codelineno-34-18"></a>│  │                    Topics Internes                               │   │
<a id="__codelineno-34-19" name="__codelineno-34-19" href="#__codelineno-34-19"></a>│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │   │
<a id="__codelineno-34-20" name="__codelineno-34-20" href="#__codelineno-34-20"></a>│  │  │ connect-    │  │ connect-    │  │ connect-    │              │   │
<a id="__codelineno-34-21" name="__codelineno-34-21" href="#__codelineno-34-21"></a>│  │  │ configs     │  │ offsets     │  │ status      │              │   │
<a id="__codelineno-34-22" name="__codelineno-34-22" href="#__codelineno-34-22"></a>│  │  └─────────────┘  └─────────────┘  └─────────────┘              │   │
<a id="__codelineno-34-23" name="__codelineno-34-23" href="#__codelineno-34-23"></a>│  └─────────────────────────────────────────────────────────────────┘   │
<a id="__codelineno-34-24" name="__codelineno-34-24" href="#__codelineno-34-24"></a>│                                                                         │
<a id="__codelineno-34-25" name="__codelineno-34-25" href="#__codelineno-34-25"></a>│  En cas de défaillance du Worker 2:                                    │
<a id="__codelineno-34-26" name="__codelineno-34-26" href="#__codelineno-34-26"></a>│  - Les tâches sont redistribuées aux Workers 1 et 3                    │
<a id="__codelineno-34-27" name="__codelineno-34-27" href="#__codelineno-34-27"></a>│  - Les offsets sont préservés (stockés dans Kafka)                     │
<a id="__codelineno-34-28" name="__codelineno-34-28" href="#__codelineno-34-28"></a>│  - Reprise automatique sans perte de données                           │
<a id="__codelineno-34-29" name="__codelineno-34-29" href="#__codelineno-34-29"></a>└─────────────────────────────────────────────────────────────────────────┘
</code></pre></div>
<p><strong>Configuration pour la haute disponibilité</strong> :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-35-1" name="__codelineno-35-1" href="#__codelineno-35-1"></a><span class="c1"># worker.properties</span>
<a id="__codelineno-35-2" name="__codelineno-35-2" href="#__codelineno-35-2"></a><span class="na">group.id</span><span class="o">=</span><span class="s">connect-cluster-prod</span>
<a id="__codelineno-35-3" name="__codelineno-35-3" href="#__codelineno-35-3"></a>
<a id="__codelineno-35-4" name="__codelineno-35-4" href="#__codelineno-35-4"></a><span class="c1"># Stockage distribué</span>
<a id="__codelineno-35-5" name="__codelineno-35-5" href="#__codelineno-35-5"></a><span class="na">config.storage.topic</span><span class="o">=</span><span class="s">connect-configs</span>
<a id="__codelineno-35-6" name="__codelineno-35-6" href="#__codelineno-35-6"></a><span class="na">config.storage.replication.factor</span><span class="o">=</span><span class="s">3</span>
<a id="__codelineno-35-7" name="__codelineno-35-7" href="#__codelineno-35-7"></a>
<a id="__codelineno-35-8" name="__codelineno-35-8" href="#__codelineno-35-8"></a><span class="na">offset.storage.topic</span><span class="o">=</span><span class="s">connect-offsets</span>
<a id="__codelineno-35-9" name="__codelineno-35-9" href="#__codelineno-35-9"></a><span class="na">offset.storage.replication.factor</span><span class="o">=</span><span class="s">3</span>
<a id="__codelineno-35-10" name="__codelineno-35-10" href="#__codelineno-35-10"></a><span class="na">offset.storage.partitions</span><span class="o">=</span><span class="s">25</span>
<a id="__codelineno-35-11" name="__codelineno-35-11" href="#__codelineno-35-11"></a>
<a id="__codelineno-35-12" name="__codelineno-35-12" href="#__codelineno-35-12"></a><span class="na">status.storage.topic</span><span class="o">=</span><span class="s">connect-status</span>
<a id="__codelineno-35-13" name="__codelineno-35-13" href="#__codelineno-35-13"></a><span class="na">status.storage.replication.factor</span><span class="o">=</span><span class="s">3</span>
<a id="__codelineno-35-14" name="__codelineno-35-14" href="#__codelineno-35-14"></a><span class="na">status.storage.partitions</span><span class="o">=</span><span class="s">5</span>
<a id="__codelineno-35-15" name="__codelineno-35-15" href="#__codelineno-35-15"></a>
<a id="__codelineno-35-16" name="__codelineno-35-16" href="#__codelineno-35-16"></a><span class="c1"># Heartbeat et rebalancing</span>
<a id="__codelineno-35-17" name="__codelineno-35-17" href="#__codelineno-35-17"></a><span class="na">heartbeat.interval.ms</span><span class="o">=</span><span class="s">3000</span>
<a id="__codelineno-35-18" name="__codelineno-35-18" href="#__codelineno-35-18"></a><span class="na">session.timeout.ms</span><span class="o">=</span><span class="s">30000</span>
<a id="__codelineno-35-19" name="__codelineno-35-19" href="#__codelineno-35-19"></a><span class="na">rebalance.timeout.ms</span><span class="o">=</span><span class="s">60000</span>
<a id="__codelineno-35-20" name="__codelineno-35-20" href="#__codelineno-35-20"></a>
<a id="__codelineno-35-21" name="__codelineno-35-21" href="#__codelineno-35-21"></a><span class="c1"># Nombre de tâches par worker</span>
<a id="__codelineno-35-22" name="__codelineno-35-22" href="#__codelineno-35-22"></a><span class="na">tasks.max.per.worker</span><span class="o">=</span><span class="s">20</span>
</code></pre></div>
<blockquote>
<p><strong>Note de terrain</strong></p>
<p><em>Contexte</em> : Migration de 50 tables PostgreSQL vers Kafka via Debezium.</p>
<p><em>Défis rencontrés</em> :
1. Initial snapshot de tables volumineuses (100M+ lignes) causait des timeouts
2. Pics de charge lors des mises à jour batch saturaient les workers
3. Changements de schéma BD causaient des erreurs de sérialisation</p>
<p><em>Solutions appliquées</em> :
1. Snapshot incrémental avec <code>snapshot.mode=when_needed</code> et filtrage par date
2. Scaling horizontal à 5 workers avec tasks.max=3 par connecteur
3. SMT pour filtrer les colonnes non nécessaires + alertes sur les migrations de schéma</p>
<p><em>Résultat</em> : Latence CDC &lt; 500ms pour 99% des événements, 0 perte de données en 18 mois.</p>
</blockquote>
<hr />
<h2 id="iii74-assurer-la-garantie-de-livraison">III.7.4 Assurer la Garantie de Livraison<a class="headerlink" href="#iii74-assurer-la-garantie-de-livraison" title="Permanent link">&para;</a></h2>
<p>La garantie de livraison est au cœur de toute architecture événementielle fiable. Kafka offre plusieurs niveaux de garantie, chacun avec des compromis entre performance, complexité, et fiabilité. Comprendre ces compromis est essentiel pour choisir la bonne approche pour chaque cas d'usage.</p>
<h3 id="les-trois-semantiques-de-livraison">Les Trois Sémantiques de Livraison<a class="headerlink" href="#les-trois-semantiques-de-livraison" title="Permanent link">&para;</a></h3>
<p>Kafka supporte trois niveaux de garantie de livraison, chacun avec des trade-offs différents. Le choix dépend des exigences métier et de la tolérance aux pertes ou duplications.</p>
<p><strong>At-Most-Once (Au plus une fois)</strong></p>
<p>Le message est livré zéro ou une fois. En cas d'erreur, le message peut être perdu. C'est la sémantique la plus simple mais aussi la moins fiable.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-36-1" name="__codelineno-36-1" href="#__codelineno-36-1"></a>Producer                    Broker                    Consumer
<a id="__codelineno-36-2" name="__codelineno-36-2" href="#__codelineno-36-2"></a>   │                          │                          │
<a id="__codelineno-36-3" name="__codelineno-36-3" href="#__codelineno-36-3"></a>   │─── Send message ────────▶│                          │
<a id="__codelineno-36-4" name="__codelineno-36-4" href="#__codelineno-36-4"></a>   │                          │                          │
<a id="__codelineno-36-5" name="__codelineno-36-5" href="#__codelineno-36-5"></a>   │    (no ack wait)         │                          │
<a id="__codelineno-36-6" name="__codelineno-36-6" href="#__codelineno-36-6"></a>   │                          │◀─── Poll ────────────────│
<a id="__codelineno-36-7" name="__codelineno-36-7" href="#__codelineno-36-7"></a>   │                          │                          │
<a id="__codelineno-36-8" name="__codelineno-36-8" href="#__codelineno-36-8"></a>   │                          │─── Message ─────────────▶│
<a id="__codelineno-36-9" name="__codelineno-36-9" href="#__codelineno-36-9"></a>   │                          │                          │
<a id="__codelineno-36-10" name="__codelineno-36-10" href="#__codelineno-36-10"></a>   │                          │         (process)        │
<a id="__codelineno-36-11" name="__codelineno-36-11" href="#__codelineno-36-11"></a>   │                          │                          │
<a id="__codelineno-36-12" name="__codelineno-36-12" href="#__codelineno-36-12"></a>   │                          │◀─── Commit ──────────────│
<a id="__codelineno-36-13" name="__codelineno-36-13" href="#__codelineno-36-13"></a>   │                          │         (before success) │
<a id="__codelineno-36-14" name="__codelineno-36-14" href="#__codelineno-36-14"></a>   │                          │                          │
<a id="__codelineno-36-15" name="__codelineno-36-15" href="#__codelineno-36-15"></a>   │                          │         [CRASH]          │
<a id="__codelineno-36-16" name="__codelineno-36-16" href="#__codelineno-36-16"></a>   │                          │                          │
<a id="__codelineno-36-17" name="__codelineno-36-17" href="#__codelineno-36-17"></a>   │                          │    Message perdu         │
</code></pre></div>
<p><em>Mécanisme</em> : Le producteur envoie le message sans attendre d'acquittement (<code>acks=0</code>). Le consommateur commit l'offset avant ou pendant le traitement. Si le traitement échoue après le commit, le message est perdu.</p>
<p><em>Configuration</em> :
<div class="highlight"><pre><span></span><code><a id="__codelineno-37-1" name="__codelineno-37-1" href="#__codelineno-37-1"></a><span class="c1">// Producer - Pas d&#39;attente d&#39;acquittement</span>
<a id="__codelineno-37-2" name="__codelineno-37-2" href="#__codelineno-37-2"></a><span class="n">Properties</span><span class="w"> </span><span class="n">producerProps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Properties</span><span class="p">();</span>
<a id="__codelineno-37-3" name="__codelineno-37-3" href="#__codelineno-37-3"></a><span class="n">producerProps</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;acks&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;0&quot;</span><span class="p">);</span>
<a id="__codelineno-37-4" name="__codelineno-37-4" href="#__codelineno-37-4"></a><span class="n">producerProps</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;retries&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;0&quot;</span><span class="p">);</span>
<a id="__codelineno-37-5" name="__codelineno-37-5" href="#__codelineno-37-5"></a>
<a id="__codelineno-37-6" name="__codelineno-37-6" href="#__codelineno-37-6"></a><span class="c1">// Consumer - Auto-commit avant traitement</span>
<a id="__codelineno-37-7" name="__codelineno-37-7" href="#__codelineno-37-7"></a><span class="n">Properties</span><span class="w"> </span><span class="n">consumerProps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Properties</span><span class="p">();</span>
<a id="__codelineno-37-8" name="__codelineno-37-8" href="#__codelineno-37-8"></a><span class="n">consumerProps</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;enable.auto.commit&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;true&quot;</span><span class="p">);</span>
<a id="__codelineno-37-9" name="__codelineno-37-9" href="#__codelineno-37-9"></a><span class="n">consumerProps</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;auto.commit.interval.ms&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;1000&quot;</span><span class="p">);</span>
</code></pre></div></p>
<p><em>Performances</em> : Latence minimale (~1-2ms), débit maximal.</p>
<p><em>Cas d'usage appropriés</em> :
- Logs applicatifs non critiques
- Métriques de monitoring où la perte occasionnelle est acceptable
- Données de clickstream pour analytics approximatif
- Systèmes de cache warming où la fraîcheur prime sur la complétude</p>
<p><em>Cas d'usage inappropriés</em> :
- Transactions financières
- Données réglementaires
- Événements déclenchant des actions irréversibles</p>
<p><strong>At-Least-Once (Au moins une fois)</strong></p>
<p>Le message est livré une ou plusieurs fois. En cas d'erreur, le message peut être dupliqué mais jamais perdu. C'est la sémantique la plus couramment utilisée.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-38-1" name="__codelineno-38-1" href="#__codelineno-38-1"></a>Producer                    Broker                    Consumer
<a id="__codelineno-38-2" name="__codelineno-38-2" href="#__codelineno-38-2"></a>   │                          │                          │
<a id="__codelineno-38-3" name="__codelineno-38-3" href="#__codelineno-38-3"></a>   │─── Send message ────────▶│                          │
<a id="__codelineno-38-4" name="__codelineno-38-4" href="#__codelineno-38-4"></a>   │◀── Ack ──────────────────│                          │
<a id="__codelineno-38-5" name="__codelineno-38-5" href="#__codelineno-38-5"></a>   │                          │                          │
<a id="__codelineno-38-6" name="__codelineno-38-6" href="#__codelineno-38-6"></a>   │                          │◀─── Poll ────────────────│
<a id="__codelineno-38-7" name="__codelineno-38-7" href="#__codelineno-38-7"></a>   │                          │─── Message ─────────────▶│
<a id="__codelineno-38-8" name="__codelineno-38-8" href="#__codelineno-38-8"></a>   │                          │                          │
<a id="__codelineno-38-9" name="__codelineno-38-9" href="#__codelineno-38-9"></a>   │                          │         (process OK)     │
<a id="__codelineno-38-10" name="__codelineno-38-10" href="#__codelineno-38-10"></a>   │                          │                          │
<a id="__codelineno-38-11" name="__codelineno-38-11" href="#__codelineno-38-11"></a>   │                          │         [CRASH before    │
<a id="__codelineno-38-12" name="__codelineno-38-12" href="#__codelineno-38-12"></a>   │                          │          commit]         │
<a id="__codelineno-38-13" name="__codelineno-38-13" href="#__codelineno-38-13"></a>   │                          │                          │
<a id="__codelineno-38-14" name="__codelineno-38-14" href="#__codelineno-38-14"></a>   │                          │◀─── Poll (after restart)─│
<a id="__codelineno-38-15" name="__codelineno-38-15" href="#__codelineno-38-15"></a>   │                          │─── Message (replay) ────▶│
<a id="__codelineno-38-16" name="__codelineno-38-16" href="#__codelineno-38-16"></a>   │                          │                          │
<a id="__codelineno-38-17" name="__codelineno-38-17" href="#__codelineno-38-17"></a>   │                          │         Message dupliqué │
</code></pre></div>
<p><em>Mécanisme</em> : Le producteur attend l'acquittement (<code>acks=all</code>) et retry en cas d'échec. Le consommateur commit l'offset après traitement réussi. Si le consumer crashe après traitement mais avant commit, le message sera rejoué.</p>
<p><em>Configuration</em> :
<div class="highlight"><pre><span></span><code><a id="__codelineno-39-1" name="__codelineno-39-1" href="#__codelineno-39-1"></a><span class="c1">// Producer - Acquittement complet avec retry</span>
<a id="__codelineno-39-2" name="__codelineno-39-2" href="#__codelineno-39-2"></a><span class="n">Properties</span><span class="w"> </span><span class="n">producerProps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Properties</span><span class="p">();</span>
<a id="__codelineno-39-3" name="__codelineno-39-3" href="#__codelineno-39-3"></a><span class="n">producerProps</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;acks&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;all&quot;</span><span class="p">);</span>
<a id="__codelineno-39-4" name="__codelineno-39-4" href="#__codelineno-39-4"></a><span class="n">producerProps</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;retries&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Integer</span><span class="p">.</span><span class="na">MAX_VALUE</span><span class="p">);</span>
<a id="__codelineno-39-5" name="__codelineno-39-5" href="#__codelineno-39-5"></a><span class="n">producerProps</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;retry.backoff.ms&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;100&quot;</span><span class="p">);</span>
<a id="__codelineno-39-6" name="__codelineno-39-6" href="#__codelineno-39-6"></a><span class="n">producerProps</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;delivery.timeout.ms&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;120000&quot;</span><span class="p">);</span>
<a id="__codelineno-39-7" name="__codelineno-39-7" href="#__codelineno-39-7"></a><span class="n">producerProps</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;enable.idempotence&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;false&quot;</span><span class="p">);</span><span class="w">  </span><span class="c1">// Pas d&#39;idempotence producteur</span>
<a id="__codelineno-39-8" name="__codelineno-39-8" href="#__codelineno-39-8"></a>
<a id="__codelineno-39-9" name="__codelineno-39-9" href="#__codelineno-39-9"></a><span class="c1">// Consumer - Commit manuel après traitement</span>
<a id="__codelineno-39-10" name="__codelineno-39-10" href="#__codelineno-39-10"></a><span class="n">Properties</span><span class="w"> </span><span class="n">consumerProps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Properties</span><span class="p">();</span>
<a id="__codelineno-39-11" name="__codelineno-39-11" href="#__codelineno-39-11"></a><span class="n">consumerProps</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;enable.auto.commit&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;false&quot;</span><span class="p">);</span>
<a id="__codelineno-39-12" name="__codelineno-39-12" href="#__codelineno-39-12"></a><span class="n">consumerProps</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;auto.offset.reset&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;earliest&quot;</span><span class="p">);</span>
<a id="__codelineno-39-13" name="__codelineno-39-13" href="#__codelineno-39-13"></a>
<a id="__codelineno-39-14" name="__codelineno-39-14" href="#__codelineno-39-14"></a><span class="c1">// Boucle de consommation</span>
<a id="__codelineno-39-15" name="__codelineno-39-15" href="#__codelineno-39-15"></a><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-39-16" name="__codelineno-39-16" href="#__codelineno-39-16"></a><span class="w">    </span><span class="n">ConsumerRecords</span><span class="o">&lt;</span><span class="n">K</span><span class="p">,</span><span class="w"> </span><span class="n">V</span><span class="o">&gt;</span><span class="w"> </span><span class="n">records</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">consumer</span><span class="p">.</span><span class="na">poll</span><span class="p">(</span><span class="n">Duration</span><span class="p">.</span><span class="na">ofMillis</span><span class="p">(</span><span class="mi">100</span><span class="p">));</span>
<a id="__codelineno-39-17" name="__codelineno-39-17" href="#__codelineno-39-17"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">ConsumerRecord</span><span class="o">&lt;</span><span class="n">K</span><span class="p">,</span><span class="w"> </span><span class="n">V</span><span class="o">&gt;</span><span class="w"> </span><span class="n">record</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">records</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-39-18" name="__codelineno-39-18" href="#__codelineno-39-18"></a><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-39-19" name="__codelineno-39-19" href="#__codelineno-39-19"></a><span class="w">            </span><span class="n">process</span><span class="p">(</span><span class="n">record</span><span class="p">);</span><span class="w">  </span><span class="c1">// Traitement métier</span>
<a id="__codelineno-39-20" name="__codelineno-39-20" href="#__codelineno-39-20"></a><span class="w">            </span><span class="n">consumer</span><span class="p">.</span><span class="na">commitSync</span><span class="p">(</span><span class="n">Collections</span><span class="p">.</span><span class="na">singletonMap</span><span class="p">(</span>
<a id="__codelineno-39-21" name="__codelineno-39-21" href="#__codelineno-39-21"></a><span class="w">                </span><span class="k">new</span><span class="w"> </span><span class="n">TopicPartition</span><span class="p">(</span><span class="n">record</span><span class="p">.</span><span class="na">topic</span><span class="p">(),</span><span class="w"> </span><span class="n">record</span><span class="p">.</span><span class="na">partition</span><span class="p">()),</span>
<a id="__codelineno-39-22" name="__codelineno-39-22" href="#__codelineno-39-22"></a><span class="w">                </span><span class="k">new</span><span class="w"> </span><span class="n">OffsetAndMetadata</span><span class="p">(</span><span class="n">record</span><span class="p">.</span><span class="na">offset</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-39-23" name="__codelineno-39-23" href="#__codelineno-39-23"></a><span class="w">            </span><span class="p">));</span>
<a id="__codelineno-39-24" name="__codelineno-39-24" href="#__codelineno-39-24"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-39-25" name="__codelineno-39-25" href="#__codelineno-39-25"></a><span class="w">            </span><span class="c1">// Gestion d&#39;erreur - le message sera rejoué</span>
<a id="__codelineno-39-26" name="__codelineno-39-26" href="#__codelineno-39-26"></a><span class="w">            </span><span class="n">handleError</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">);</span>
<a id="__codelineno-39-27" name="__codelineno-39-27" href="#__codelineno-39-27"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-39-28" name="__codelineno-39-28" href="#__codelineno-39-28"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-39-29" name="__codelineno-39-29" href="#__codelineno-39-29"></a><span class="p">}</span>
</code></pre></div></p>
<p><em>Performances</em> : Latence modérée (~5-20ms), débit élevé.</p>
<p><em>Cas d'usage appropriés</em> :
- La plupart des cas d'usage métier
- Systèmes où l'idempotence peut être implémentée côté consommateur
- Pipelines de données avec déduplication en aval
- Notifications (envoyer deux fois vaut mieux que pas du tout)</p>
<p><em>Exigence critique</em> : Le consommateur DOIT être idempotent pour gérer les duplications.</p>
<p><strong>Exactly-Once (Exactement une fois)</strong></p>
<p>Le message est livré exactement une fois, même en cas d'erreur. C'est la garantie la plus forte mais aussi la plus coûteuse en termes de performance et de complexité.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-40-1" name="__codelineno-40-1" href="#__codelineno-40-1"></a>Producer (transactionnel)   Broker                    Consumer (read_committed)
<a id="__codelineno-40-2" name="__codelineno-40-2" href="#__codelineno-40-2"></a>   │                          │                          │
<a id="__codelineno-40-3" name="__codelineno-40-3" href="#__codelineno-40-3"></a>   │─── beginTransaction() ──▶│                          │
<a id="__codelineno-40-4" name="__codelineno-40-4" href="#__codelineno-40-4"></a>   │─── Send message ────────▶│ (non visible)            │
<a id="__codelineno-40-5" name="__codelineno-40-5" href="#__codelineno-40-5"></a>   │─── commitTransaction() ─▶│                          │
<a id="__codelineno-40-6" name="__codelineno-40-6" href="#__codelineno-40-6"></a>   │                          │ (visible)                │
<a id="__codelineno-40-7" name="__codelineno-40-7" href="#__codelineno-40-7"></a>   │                          │                          │
<a id="__codelineno-40-8" name="__codelineno-40-8" href="#__codelineno-40-8"></a>   │                          │◀─── Poll ────────────────│
<a id="__codelineno-40-9" name="__codelineno-40-9" href="#__codelineno-40-9"></a>   │                          │─── Message ─────────────▶│
<a id="__codelineno-40-10" name="__codelineno-40-10" href="#__codelineno-40-10"></a>   │                          │                          │
<a id="__codelineno-40-11" name="__codelineno-40-11" href="#__codelineno-40-11"></a>   │                          │         (process)        │
<a id="__codelineno-40-12" name="__codelineno-40-12" href="#__codelineno-40-12"></a>   │                          │                          │
<a id="__codelineno-40-13" name="__codelineno-40-13" href="#__codelineno-40-13"></a>   │                          │◀─── sendOffsetsToTx ─────│
<a id="__codelineno-40-14" name="__codelineno-40-14" href="#__codelineno-40-14"></a>   │                          │◀─── commitTransaction ───│
</code></pre></div>
<p><em>Mécanisme</em> : Kafka utilise des transactions pour garantir l'atomicité entre la production de messages et le commit des offsets. Les consommateurs en mode <code>read_committed</code> ne voient que les messages des transactions commitées.</p>
<p><em>Configuration producteur transactionnel</em> :
<div class="highlight"><pre><span></span><code><a id="__codelineno-41-1" name="__codelineno-41-1" href="#__codelineno-41-1"></a><span class="n">Properties</span><span class="w"> </span><span class="n">producerProps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Properties</span><span class="p">();</span>
<a id="__codelineno-41-2" name="__codelineno-41-2" href="#__codelineno-41-2"></a><span class="n">producerProps</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;acks&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;all&quot;</span><span class="p">);</span>
<a id="__codelineno-41-3" name="__codelineno-41-3" href="#__codelineno-41-3"></a><span class="n">producerProps</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;enable.idempotence&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;true&quot;</span><span class="p">);</span>
<a id="__codelineno-41-4" name="__codelineno-41-4" href="#__codelineno-41-4"></a><span class="n">producerProps</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;transactional.id&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;orders-producer-&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">instanceId</span><span class="p">);</span>
<a id="__codelineno-41-5" name="__codelineno-41-5" href="#__codelineno-41-5"></a><span class="n">producerProps</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;transaction.timeout.ms&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;60000&quot;</span><span class="p">);</span>
<a id="__codelineno-41-6" name="__codelineno-41-6" href="#__codelineno-41-6"></a>
<a id="__codelineno-41-7" name="__codelineno-41-7" href="#__codelineno-41-7"></a><span class="n">KafkaProducer</span><span class="o">&lt;</span><span class="n">K</span><span class="p">,</span><span class="w"> </span><span class="n">V</span><span class="o">&gt;</span><span class="w"> </span><span class="n">producer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">KafkaProducer</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">producerProps</span><span class="p">);</span>
<a id="__codelineno-41-8" name="__codelineno-41-8" href="#__codelineno-41-8"></a><span class="n">producer</span><span class="p">.</span><span class="na">initTransactions</span><span class="p">();</span>
<a id="__codelineno-41-9" name="__codelineno-41-9" href="#__codelineno-41-9"></a>
<a id="__codelineno-41-10" name="__codelineno-41-10" href="#__codelineno-41-10"></a><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-41-11" name="__codelineno-41-11" href="#__codelineno-41-11"></a><span class="w">    </span><span class="n">producer</span><span class="p">.</span><span class="na">beginTransaction</span><span class="p">();</span>
<a id="__codelineno-41-12" name="__codelineno-41-12" href="#__codelineno-41-12"></a>
<a id="__codelineno-41-13" name="__codelineno-41-13" href="#__codelineno-41-13"></a><span class="w">    </span><span class="c1">// Envoyer plusieurs messages dans la même transaction</span>
<a id="__codelineno-41-14" name="__codelineno-41-14" href="#__codelineno-41-14"></a><span class="w">    </span><span class="n">producer</span><span class="p">.</span><span class="na">send</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">ProducerRecord</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="s">&quot;topic-a&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">key1</span><span class="p">,</span><span class="w"> </span><span class="n">value1</span><span class="p">));</span>
<a id="__codelineno-41-15" name="__codelineno-41-15" href="#__codelineno-41-15"></a><span class="w">    </span><span class="n">producer</span><span class="p">.</span><span class="na">send</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">ProducerRecord</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="s">&quot;topic-b&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">key2</span><span class="p">,</span><span class="w"> </span><span class="n">value2</span><span class="p">));</span>
<a id="__codelineno-41-16" name="__codelineno-41-16" href="#__codelineno-41-16"></a>
<a id="__codelineno-41-17" name="__codelineno-41-17" href="#__codelineno-41-17"></a><span class="w">    </span><span class="c1">// Commit des offsets du consumer dans la transaction</span>
<a id="__codelineno-41-18" name="__codelineno-41-18" href="#__codelineno-41-18"></a><span class="w">    </span><span class="n">producer</span><span class="p">.</span><span class="na">sendOffsetsToTransaction</span><span class="p">(</span><span class="n">offsets</span><span class="p">,</span><span class="w"> </span><span class="n">consumerGroupId</span><span class="p">);</span>
<a id="__codelineno-41-19" name="__codelineno-41-19" href="#__codelineno-41-19"></a>
<a id="__codelineno-41-20" name="__codelineno-41-20" href="#__codelineno-41-20"></a><span class="w">    </span><span class="n">producer</span><span class="p">.</span><span class="na">commitTransaction</span><span class="p">();</span>
<a id="__codelineno-41-21" name="__codelineno-41-21" href="#__codelineno-41-21"></a><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">ProducerFencedException</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">OutOfOrderSequenceException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-41-22" name="__codelineno-41-22" href="#__codelineno-41-22"></a><span class="w">    </span><span class="c1">// Erreur fatale - le producteur doit être recréé</span>
<a id="__codelineno-41-23" name="__codelineno-41-23" href="#__codelineno-41-23"></a><span class="w">    </span><span class="n">producer</span><span class="p">.</span><span class="na">close</span><span class="p">();</span>
<a id="__codelineno-41-24" name="__codelineno-41-24" href="#__codelineno-41-24"></a><span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="n">e</span><span class="p">;</span>
<a id="__codelineno-41-25" name="__codelineno-41-25" href="#__codelineno-41-25"></a><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">KafkaException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-41-26" name="__codelineno-41-26" href="#__codelineno-41-26"></a><span class="w">    </span><span class="c1">// Erreur récupérable - abort et retry</span>
<a id="__codelineno-41-27" name="__codelineno-41-27" href="#__codelineno-41-27"></a><span class="w">    </span><span class="n">producer</span><span class="p">.</span><span class="na">abortTransaction</span><span class="p">();</span>
<a id="__codelineno-41-28" name="__codelineno-41-28" href="#__codelineno-41-28"></a><span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="n">e</span><span class="p">;</span>
<a id="__codelineno-41-29" name="__codelineno-41-29" href="#__codelineno-41-29"></a><span class="p">}</span>
</code></pre></div></p>
<p><em>Configuration consommateur read_committed</em> :
<div class="highlight"><pre><span></span><code><a id="__codelineno-42-1" name="__codelineno-42-1" href="#__codelineno-42-1"></a><span class="n">Properties</span><span class="w"> </span><span class="n">consumerProps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Properties</span><span class="p">();</span>
<a id="__codelineno-42-2" name="__codelineno-42-2" href="#__codelineno-42-2"></a><span class="n">consumerProps</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;isolation.level&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;read_committed&quot;</span><span class="p">);</span>
<a id="__codelineno-42-3" name="__codelineno-42-3" href="#__codelineno-42-3"></a><span class="n">consumerProps</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;enable.auto.commit&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;false&quot;</span><span class="p">);</span>
</code></pre></div></p>
<p><em>Performances</em> : Latence plus élevée (~20-100ms), débit réduit de 20-30%.</p>
<p><em>Cas d'usage appropriés</em> :
- Transactions financières où toute perte ou duplication est inacceptable
- Transfert de fonds entre comptes
- Systèmes de comptabilité et d'audit
- Pipelines Kafka Streams avec state stores</p>
<p><em>Limitations</em> :
- Exactly-once est limité à l'écosystème Kafka
- Les appels à des systèmes externes (BD, API) restent at-least-once
- Coût en performance non négligeable</p>
<h3 id="comparaison-des-semantiques">Comparaison des Sémantiques<a class="headerlink" href="#comparaison-des-semantiques" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Critère</th>
<th>At-Most-Once</th>
<th>At-Least-Once</th>
<th>Exactly-Once</th>
</tr>
</thead>
<tbody>
<tr>
<td>Perte possible</td>
<td>Oui</td>
<td>Non</td>
<td>Non</td>
</tr>
<tr>
<td>Duplication possible</td>
<td>Non</td>
<td>Oui</td>
<td>Non</td>
</tr>
<tr>
<td>Latence</td>
<td>Minimale</td>
<td>Modérée</td>
<td>Élevée</td>
</tr>
<tr>
<td>Débit</td>
<td>Maximum</td>
<td>Élevé</td>
<td>Réduit</td>
</tr>
<tr>
<td>Complexité</td>
<td>Simple</td>
<td>Moyenne</td>
<td>Élevée</td>
</tr>
<tr>
<td>Idempotence requise</td>
<td>Non</td>
<td>Oui</td>
<td>Non</td>
</tr>
<tr>
<td>Cas d'usage</td>
<td>Logs, métriques</td>
<td>Plupart des cas</td>
<td>Financier, critique</td>
</tr>
</tbody>
</table>
<h3 id="pattern-outbox-transactionnel">Pattern Outbox Transactionnel<a class="headerlink" href="#pattern-outbox-transactionnel" title="Permanent link">&para;</a></h3>
<p>Le pattern Outbox résout le problème de l'atomicité entre une écriture en base de données et la publication d'un événement Kafka. C'est l'un des patterns les plus importants pour les architectures événementielles.</p>
<p><strong>Le problème</strong> :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-43-1" name="__codelineno-43-1" href="#__codelineno-43-1"></a><span class="c1">// Code problématique - PAS atomique</span>
<a id="__codelineno-43-2" name="__codelineno-43-2" href="#__codelineno-43-2"></a><span class="nd">@Transactional</span>
<a id="__codelineno-43-3" name="__codelineno-43-3" href="#__codelineno-43-3"></a><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">createOrder</span><span class="p">(</span><span class="n">Order</span><span class="w"> </span><span class="n">order</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-43-4" name="__codelineno-43-4" href="#__codelineno-43-4"></a><span class="w">    </span><span class="n">orderRepository</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">order</span><span class="p">);</span><span class="w">      </span><span class="c1">// 1. Écriture BD</span>
<a id="__codelineno-43-5" name="__codelineno-43-5" href="#__codelineno-43-5"></a><span class="w">    </span><span class="n">kafkaProducer</span><span class="p">.</span><span class="na">send</span><span class="p">(</span><span class="n">orderEvent</span><span class="p">);</span><span class="w">   </span><span class="c1">// 2. Publication Kafka</span>
<a id="__codelineno-43-6" name="__codelineno-43-6" href="#__codelineno-43-6"></a><span class="w">    </span><span class="c1">// Que se passe-t-il si le service crashe entre 1 et 2 ?</span>
<a id="__codelineno-43-7" name="__codelineno-43-7" href="#__codelineno-43-7"></a><span class="p">}</span>
</code></pre></div>
<p><strong>La solution Outbox</strong> :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-44-1" name="__codelineno-44-1" href="#__codelineno-44-1"></a>┌─────────────────────────────────────────────────────────────────────────┐
<a id="__codelineno-44-2" name="__codelineno-44-2" href="#__codelineno-44-2"></a>│                       Pattern Outbox Transactionnel                     │
<a id="__codelineno-44-3" name="__codelineno-44-3" href="#__codelineno-44-3"></a>│                                                                         │
<a id="__codelineno-44-4" name="__codelineno-44-4" href="#__codelineno-44-4"></a>│  ┌─────────────────────────────────────────────────────────────────┐   │
<a id="__codelineno-44-5" name="__codelineno-44-5" href="#__codelineno-44-5"></a>│  │                    Service Application                           │   │
<a id="__codelineno-44-6" name="__codelineno-44-6" href="#__codelineno-44-6"></a>│  │                                                                  │   │
<a id="__codelineno-44-7" name="__codelineno-44-7" href="#__codelineno-44-7"></a>│  │  @Transactional                                                 │   │
<a id="__codelineno-44-8" name="__codelineno-44-8" href="#__codelineno-44-8"></a>│  │  public void createOrder(Order order) {                         │   │
<a id="__codelineno-44-9" name="__codelineno-44-9" href="#__codelineno-44-9"></a>│  │      orderRepository.save(order);                               │   │
<a id="__codelineno-44-10" name="__codelineno-44-10" href="#__codelineno-44-10"></a>│  │      outboxRepository.save(new OutboxEvent(                     │   │
<a id="__codelineno-44-11" name="__codelineno-44-11" href="#__codelineno-44-11"></a>│  │          &quot;OrderCreated&quot;,                                        │   │
<a id="__codelineno-44-12" name="__codelineno-44-12" href="#__codelineno-44-12"></a>│  │          order.getId(),                                         │   │
<a id="__codelineno-44-13" name="__codelineno-44-13" href="#__codelineno-44-13"></a>│  │          serialize(order)                                       │   │
<a id="__codelineno-44-14" name="__codelineno-44-14" href="#__codelineno-44-14"></a>│  │      ));                                                        │   │
<a id="__codelineno-44-15" name="__codelineno-44-15" href="#__codelineno-44-15"></a>│  │      // Les deux écritures sont dans la même transaction DB     │   │
<a id="__codelineno-44-16" name="__codelineno-44-16" href="#__codelineno-44-16"></a>│  │  }                                                              │   │
<a id="__codelineno-44-17" name="__codelineno-44-17" href="#__codelineno-44-17"></a>│  └─────────────────────────────────────────────────────────────────┘   │
<a id="__codelineno-44-18" name="__codelineno-44-18" href="#__codelineno-44-18"></a>│                              │                                          │
<a id="__codelineno-44-19" name="__codelineno-44-19" href="#__codelineno-44-19"></a>│                              ▼                                          │
<a id="__codelineno-44-20" name="__codelineno-44-20" href="#__codelineno-44-20"></a>│  ┌─────────────────────────────────────────────────────────────────┐   │
<a id="__codelineno-44-21" name="__codelineno-44-21" href="#__codelineno-44-21"></a>│  │                    Base de Données                               │   │
<a id="__codelineno-44-22" name="__codelineno-44-22" href="#__codelineno-44-22"></a>│  │  ┌───────────────┐    ┌───────────────────────────────────┐     │   │
<a id="__codelineno-44-23" name="__codelineno-44-23" href="#__codelineno-44-23"></a>│  │  │ orders        │    │ outbox                             │     │   │
<a id="__codelineno-44-24" name="__codelineno-44-24" href="#__codelineno-44-24"></a>│  │  │ (table métier)│    │ (table outbox)                    │     │   │
<a id="__codelineno-44-25" name="__codelineno-44-25" href="#__codelineno-44-25"></a>│  │  │               │    │                                    │     │   │
<a id="__codelineno-44-26" name="__codelineno-44-26" href="#__codelineno-44-26"></a>│  │  │ id: 123       │    │ id: 456                           │     │   │
<a id="__codelineno-44-27" name="__codelineno-44-27" href="#__codelineno-44-27"></a>│  │  │ status: new   │    │ event_type: OrderCreated          │     │   │
<a id="__codelineno-44-28" name="__codelineno-44-28" href="#__codelineno-44-28"></a>│  │  │ total: 5000   │    │ aggregate_id: 123                 │     │   │
<a id="__codelineno-44-29" name="__codelineno-44-29" href="#__codelineno-44-29"></a>│  │  │               │    │ payload: {...}                    │     │   │
<a id="__codelineno-44-30" name="__codelineno-44-30" href="#__codelineno-44-30"></a>│  │  │               │    │ created_at: 2024-01-15T10:30:00Z  │     │   │
<a id="__codelineno-44-31" name="__codelineno-44-31" href="#__codelineno-44-31"></a>│  │  │               │    │ published: false                  │     │   │
<a id="__codelineno-44-32" name="__codelineno-44-32" href="#__codelineno-44-32"></a>│  │  └───────────────┘    └───────────────────────────────────┘     │   │
<a id="__codelineno-44-33" name="__codelineno-44-33" href="#__codelineno-44-33"></a>│  └─────────────────────────────────────────────────────────────────┘   │
<a id="__codelineno-44-34" name="__codelineno-44-34" href="#__codelineno-44-34"></a>│                              │                                          │
<a id="__codelineno-44-35" name="__codelineno-44-35" href="#__codelineno-44-35"></a>│                              ▼                                          │
<a id="__codelineno-44-36" name="__codelineno-44-36" href="#__codelineno-44-36"></a>│  ┌─────────────────────────────────────────────────────────────────┐   │
<a id="__codelineno-44-37" name="__codelineno-44-37" href="#__codelineno-44-37"></a>│  │               Debezium CDC Connector (ou polling)                │   │
<a id="__codelineno-44-38" name="__codelineno-44-38" href="#__codelineno-44-38"></a>│  │                                                                  │   │
<a id="__codelineno-44-39" name="__codelineno-44-39" href="#__codelineno-44-39"></a>│  │  - Lit les nouvelles entrées dans la table outbox               │   │
<a id="__codelineno-44-40" name="__codelineno-44-40" href="#__codelineno-44-40"></a>│  │  - Publie vers Kafka                                            │   │
<a id="__codelineno-44-41" name="__codelineno-44-41" href="#__codelineno-44-41"></a>│  │  - Marque comme published (ou supprime)                         │   │
<a id="__codelineno-44-42" name="__codelineno-44-42" href="#__codelineno-44-42"></a>│  └─────────────────────────────────────────────────────────────────┘   │
<a id="__codelineno-44-43" name="__codelineno-44-43" href="#__codelineno-44-43"></a>│                              │                                          │
<a id="__codelineno-44-44" name="__codelineno-44-44" href="#__codelineno-44-44"></a>│                              ▼                                          │
<a id="__codelineno-44-45" name="__codelineno-44-45" href="#__codelineno-44-45"></a>│  ┌─────────────────────────────────────────────────────────────────┐   │
<a id="__codelineno-44-46" name="__codelineno-44-46" href="#__codelineno-44-46"></a>│  │                         Kafka                                    │   │
<a id="__codelineno-44-47" name="__codelineno-44-47" href="#__codelineno-44-47"></a>│  │  ┌───────────────────────────────────────────────────────────┐  │   │
<a id="__codelineno-44-48" name="__codelineno-44-48" href="#__codelineno-44-48"></a>│  │  │ orders.events.v1                                           │  │   │
<a id="__codelineno-44-49" name="__codelineno-44-49" href="#__codelineno-44-49"></a>│  │  │ [OrderCreated: {id: 123, ...}]                            │  │   │
<a id="__codelineno-44-50" name="__codelineno-44-50" href="#__codelineno-44-50"></a>│  │  └───────────────────────────────────────────────────────────┘  │   │
<a id="__codelineno-44-51" name="__codelineno-44-51" href="#__codelineno-44-51"></a>│  └─────────────────────────────────────────────────────────────────┘   │
<a id="__codelineno-44-52" name="__codelineno-44-52" href="#__codelineno-44-52"></a>└─────────────────────────────────────────────────────────────────────────┘
</code></pre></div>
<p><strong>Structure de la table Outbox</strong> :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-45-1" name="__codelineno-45-1" href="#__codelineno-45-1"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">outbox</span><span class="w"> </span><span class="p">(</span>
<a id="__codelineno-45-2" name="__codelineno-45-2" href="#__codelineno-45-2"></a><span class="w">    </span><span class="n">id</span><span class="w"> </span><span class="n">UUID</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">gen_random_uuid</span><span class="p">(),</span>
<a id="__codelineno-45-3" name="__codelineno-45-3" href="#__codelineno-45-3"></a><span class="w">    </span><span class="n">aggregate_type</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<a id="__codelineno-45-4" name="__codelineno-45-4" href="#__codelineno-45-4"></a><span class="w">    </span><span class="n">aggregate_id</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<a id="__codelineno-45-5" name="__codelineno-45-5" href="#__codelineno-45-5"></a><span class="w">    </span><span class="n">event_type</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<a id="__codelineno-45-6" name="__codelineno-45-6" href="#__codelineno-45-6"></a><span class="w">    </span><span class="n">payload</span><span class="w"> </span><span class="n">JSONB</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<a id="__codelineno-45-7" name="__codelineno-45-7" href="#__codelineno-45-7"></a><span class="w">    </span><span class="n">created_at</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="w"> </span><span class="k">WITH</span><span class="w"> </span><span class="k">TIME</span><span class="w"> </span><span class="k">ZONE</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">(),</span>
<a id="__codelineno-45-8" name="__codelineno-45-8" href="#__codelineno-45-8"></a><span class="w">    </span><span class="n">published_at</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="w"> </span><span class="k">WITH</span><span class="w"> </span><span class="k">TIME</span><span class="w"> </span><span class="k">ZONE</span><span class="p">,</span>
<a id="__codelineno-45-9" name="__codelineno-45-9" href="#__codelineno-45-9"></a>
<a id="__codelineno-45-10" name="__codelineno-45-10" href="#__codelineno-45-10"></a><span class="w">    </span><span class="c1">-- Index pour le polling ou CDC</span>
<a id="__codelineno-45-11" name="__codelineno-45-11" href="#__codelineno-45-11"></a><span class="w">    </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_outbox_unpublished</span><span class="w"> </span><span class="p">(</span><span class="n">created_at</span><span class="p">)</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">published_at</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span>
<a id="__codelineno-45-12" name="__codelineno-45-12" href="#__codelineno-45-12"></a><span class="p">);</span>
</code></pre></div>
<p><strong>Implémentation avec Debezium Outbox Extension</strong> :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-46-1" name="__codelineno-46-1" href="#__codelineno-46-1"></a><span class="p">{</span>
<a id="__codelineno-46-2" name="__codelineno-46-2" href="#__codelineno-46-2"></a><span class="w">  </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;orders-outbox-connector&quot;</span><span class="p">,</span>
<a id="__codelineno-46-3" name="__codelineno-46-3" href="#__codelineno-46-3"></a><span class="w">  </span><span class="nt">&quot;config&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-46-4" name="__codelineno-46-4" href="#__codelineno-46-4"></a><span class="w">    </span><span class="nt">&quot;connector.class&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;io.debezium.connector.postgresql.PostgresConnector&quot;</span><span class="p">,</span>
<a id="__codelineno-46-5" name="__codelineno-46-5" href="#__codelineno-46-5"></a><span class="w">    </span><span class="nt">&quot;database.hostname&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;postgres&quot;</span><span class="p">,</span>
<a id="__codelineno-46-6" name="__codelineno-46-6" href="#__codelineno-46-6"></a><span class="w">    </span><span class="nt">&quot;database.port&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;5432&quot;</span><span class="p">,</span>
<a id="__codelineno-46-7" name="__codelineno-46-7" href="#__codelineno-46-7"></a><span class="w">    </span><span class="nt">&quot;database.user&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;debezium&quot;</span><span class="p">,</span>
<a id="__codelineno-46-8" name="__codelineno-46-8" href="#__codelineno-46-8"></a><span class="w">    </span><span class="nt">&quot;database.password&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;${secrets:db-password}&quot;</span><span class="p">,</span>
<a id="__codelineno-46-9" name="__codelineno-46-9" href="#__codelineno-46-9"></a><span class="w">    </span><span class="nt">&quot;database.dbname&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;orders&quot;</span><span class="p">,</span>
<a id="__codelineno-46-10" name="__codelineno-46-10" href="#__codelineno-46-10"></a><span class="w">    </span><span class="nt">&quot;database.server.name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;orders&quot;</span><span class="p">,</span>
<a id="__codelineno-46-11" name="__codelineno-46-11" href="#__codelineno-46-11"></a>
<a id="__codelineno-46-12" name="__codelineno-46-12" href="#__codelineno-46-12"></a><span class="w">    </span><span class="nt">&quot;table.include.list&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;public.outbox&quot;</span><span class="p">,</span>
<a id="__codelineno-46-13" name="__codelineno-46-13" href="#__codelineno-46-13"></a><span class="w">    </span><span class="nt">&quot;tombstones.on.delete&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;false&quot;</span><span class="p">,</span>
<a id="__codelineno-46-14" name="__codelineno-46-14" href="#__codelineno-46-14"></a>
<a id="__codelineno-46-15" name="__codelineno-46-15" href="#__codelineno-46-15"></a><span class="w">    </span><span class="nt">&quot;transforms&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;outbox&quot;</span><span class="p">,</span>
<a id="__codelineno-46-16" name="__codelineno-46-16" href="#__codelineno-46-16"></a><span class="w">    </span><span class="nt">&quot;transforms.outbox.type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;io.debezium.transforms.outbox.EventRouter&quot;</span><span class="p">,</span>
<a id="__codelineno-46-17" name="__codelineno-46-17" href="#__codelineno-46-17"></a><span class="w">    </span><span class="nt">&quot;transforms.outbox.table.fields.additional.placement&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;event_type:header:eventType&quot;</span><span class="p">,</span>
<a id="__codelineno-46-18" name="__codelineno-46-18" href="#__codelineno-46-18"></a><span class="w">    </span><span class="nt">&quot;transforms.outbox.route.by.field&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;aggregate_type&quot;</span><span class="p">,</span>
<a id="__codelineno-46-19" name="__codelineno-46-19" href="#__codelineno-46-19"></a><span class="w">    </span><span class="nt">&quot;transforms.outbox.route.topic.replacement&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;${routedByValue}.events&quot;</span>
<a id="__codelineno-46-20" name="__codelineno-46-20" href="#__codelineno-46-20"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-46-21" name="__codelineno-46-21" href="#__codelineno-46-21"></a><span class="p">}</span>
</code></pre></div>
<p><strong>Implémentation Alternative : Polling</strong></p>
<p>Pour les environnements où le CDC n'est pas possible, un job de polling peut publier les événements de la table outbox.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-47-1" name="__codelineno-47-1" href="#__codelineno-47-1"></a><span class="nd">@Component</span>
<a id="__codelineno-47-2" name="__codelineno-47-2" href="#__codelineno-47-2"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">OutboxPoller</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-47-3" name="__codelineno-47-3" href="#__codelineno-47-3"></a>
<a id="__codelineno-47-4" name="__codelineno-47-4" href="#__codelineno-47-4"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">OutboxRepository</span><span class="w"> </span><span class="n">outboxRepository</span><span class="p">;</span>
<a id="__codelineno-47-5" name="__codelineno-47-5" href="#__codelineno-47-5"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">KafkaTemplate</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="kt">byte</span><span class="o">[]&gt;</span><span class="w"> </span><span class="n">kafkaTemplate</span><span class="p">;</span>
<a id="__codelineno-47-6" name="__codelineno-47-6" href="#__codelineno-47-6"></a>
<a id="__codelineno-47-7" name="__codelineno-47-7" href="#__codelineno-47-7"></a><span class="w">    </span><span class="nd">@Scheduled</span><span class="p">(</span><span class="n">fixedRate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span><span class="w">  </span><span class="c1">// Poll toutes les 100ms</span>
<a id="__codelineno-47-8" name="__codelineno-47-8" href="#__codelineno-47-8"></a><span class="w">    </span><span class="nd">@Transactional</span>
<a id="__codelineno-47-9" name="__codelineno-47-9" href="#__codelineno-47-9"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">pollAndPublish</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-47-10" name="__codelineno-47-10" href="#__codelineno-47-10"></a><span class="w">        </span><span class="n">List</span><span class="o">&lt;</span><span class="n">OutboxEvent</span><span class="o">&gt;</span><span class="w"> </span><span class="n">events</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">outboxRepository</span>
<a id="__codelineno-47-11" name="__codelineno-47-11" href="#__codelineno-47-11"></a><span class="w">            </span><span class="p">.</span><span class="na">findUnpublishedEvents</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span><span class="w">  </span><span class="c1">// Batch de 100</span>
<a id="__codelineno-47-12" name="__codelineno-47-12" href="#__codelineno-47-12"></a>
<a id="__codelineno-47-13" name="__codelineno-47-13" href="#__codelineno-47-13"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">OutboxEvent</span><span class="w"> </span><span class="n">event</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">events</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-47-14" name="__codelineno-47-14" href="#__codelineno-47-14"></a><span class="w">            </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-47-15" name="__codelineno-47-15" href="#__codelineno-47-15"></a><span class="w">                </span><span class="c1">// Publication vers Kafka</span>
<a id="__codelineno-47-16" name="__codelineno-47-16" href="#__codelineno-47-16"></a><span class="w">                </span><span class="n">kafkaTemplate</span><span class="p">.</span><span class="na">send</span><span class="p">(</span>
<a id="__codelineno-47-17" name="__codelineno-47-17" href="#__codelineno-47-17"></a><span class="w">                    </span><span class="n">event</span><span class="p">.</span><span class="na">getAggregateType</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;.events&quot;</span><span class="p">,</span>
<a id="__codelineno-47-18" name="__codelineno-47-18" href="#__codelineno-47-18"></a><span class="w">                    </span><span class="n">event</span><span class="p">.</span><span class="na">getAggregateId</span><span class="p">(),</span>
<a id="__codelineno-47-19" name="__codelineno-47-19" href="#__codelineno-47-19"></a><span class="w">                    </span><span class="n">event</span><span class="p">.</span><span class="na">getPayload</span><span class="p">()</span>
<a id="__codelineno-47-20" name="__codelineno-47-20" href="#__codelineno-47-20"></a><span class="w">                </span><span class="p">).</span><span class="na">get</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">SECONDS</span><span class="p">);</span><span class="w">  </span><span class="c1">// Attendre la confirmation</span>
<a id="__codelineno-47-21" name="__codelineno-47-21" href="#__codelineno-47-21"></a>
<a id="__codelineno-47-22" name="__codelineno-47-22" href="#__codelineno-47-22"></a><span class="w">                </span><span class="c1">// Marquer comme publié</span>
<a id="__codelineno-47-23" name="__codelineno-47-23" href="#__codelineno-47-23"></a><span class="w">                </span><span class="n">event</span><span class="p">.</span><span class="na">setPublishedAt</span><span class="p">(</span><span class="n">Instant</span><span class="p">.</span><span class="na">now</span><span class="p">());</span>
<a id="__codelineno-47-24" name="__codelineno-47-24" href="#__codelineno-47-24"></a><span class="w">                </span><span class="n">outboxRepository</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
<a id="__codelineno-47-25" name="__codelineno-47-25" href="#__codelineno-47-25"></a>
<a id="__codelineno-47-26" name="__codelineno-47-26" href="#__codelineno-47-26"></a><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-47-27" name="__codelineno-47-27" href="#__codelineno-47-27"></a><span class="w">                </span><span class="n">log</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">&quot;Failed to publish outbox event {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">event</span><span class="p">.</span><span class="na">getId</span><span class="p">(),</span><span class="w"> </span><span class="n">e</span><span class="p">);</span>
<a id="__codelineno-47-28" name="__codelineno-47-28" href="#__codelineno-47-28"></a><span class="w">                </span><span class="c1">// L&#39;événement sera retenté au prochain poll</span>
<a id="__codelineno-47-29" name="__codelineno-47-29" href="#__codelineno-47-29"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-47-30" name="__codelineno-47-30" href="#__codelineno-47-30"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-47-31" name="__codelineno-47-31" href="#__codelineno-47-31"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-47-32" name="__codelineno-47-32" href="#__codelineno-47-32"></a>
<a id="__codelineno-47-33" name="__codelineno-47-33" href="#__codelineno-47-33"></a><span class="w">    </span><span class="c1">// Nettoyage des événements publiés (job séparé)</span>
<a id="__codelineno-47-34" name="__codelineno-47-34" href="#__codelineno-47-34"></a><span class="w">    </span><span class="nd">@Scheduled</span><span class="p">(</span><span class="n">cron</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;0 0 * * * *&quot;</span><span class="p">)</span><span class="w">  </span><span class="c1">// Toutes les heures</span>
<a id="__codelineno-47-35" name="__codelineno-47-35" href="#__codelineno-47-35"></a><span class="w">    </span><span class="nd">@Transactional</span>
<a id="__codelineno-47-36" name="__codelineno-47-36" href="#__codelineno-47-36"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">cleanupOldEvents</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-47-37" name="__codelineno-47-37" href="#__codelineno-47-37"></a><span class="w">        </span><span class="n">Instant</span><span class="w"> </span><span class="n">cutoff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Instant</span><span class="p">.</span><span class="na">now</span><span class="p">().</span><span class="na">minus</span><span class="p">(</span><span class="n">Duration</span><span class="p">.</span><span class="na">ofDays</span><span class="p">(</span><span class="mi">7</span><span class="p">));</span>
<a id="__codelineno-47-38" name="__codelineno-47-38" href="#__codelineno-47-38"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">deleted</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">outboxRepository</span><span class="p">.</span><span class="na">deletePublishedBefore</span><span class="p">(</span><span class="n">cutoff</span><span class="p">);</span>
<a id="__codelineno-47-39" name="__codelineno-47-39" href="#__codelineno-47-39"></a><span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;Deleted {} old outbox events&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">deleted</span><span class="p">);</span>
<a id="__codelineno-47-40" name="__codelineno-47-40" href="#__codelineno-47-40"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-47-41" name="__codelineno-47-41" href="#__codelineno-47-41"></a><span class="p">}</span>
</code></pre></div>
<p><strong>Comparaison CDC vs. Polling</strong> :</p>
<table>
<thead>
<tr>
<th>Aspect</th>
<th>CDC (Debezium)</th>
<th>Polling</th>
</tr>
</thead>
<tbody>
<tr>
<td>Latence</td>
<td>~10-100ms</td>
<td>~100-1000ms (dépend de l'intervalle)</td>
</tr>
<tr>
<td>Charge BD</td>
<td>Faible (lecture du WAL)</td>
<td>Modérée (requêtes répétées)</td>
</tr>
<tr>
<td>Complexité</td>
<td>Plus élevée (infrastructure CDC)</td>
<td>Plus simple</td>
</tr>
<tr>
<td>Ordre garanti</td>
<td>Oui (ordre du WAL)</td>
<td>Oui (si ORDER BY timestamp)</td>
</tr>
<tr>
<td>Scalabilité</td>
<td>Excellente</td>
<td>Limitée (contention sur la table)</td>
</tr>
</tbody>
</table>
<h3 id="idempotence-cote-consommateur">Idempotence Côté Consommateur<a class="headerlink" href="#idempotence-cote-consommateur" title="Permanent link">&para;</a></h3>
<p>Même avec exactly-once côté Kafka, les consommateurs doivent être idempotents car des duplications peuvent survenir au niveau applicatif (retry, reprocessing, replay manuel). L'idempotence est la capacité à traiter le même message plusieurs fois sans effet de bord.</p>
<p><strong>Pattern 1 : Stockage des IDs traités</strong></p>
<p>Ce pattern maintient une table des événements déjà traités pour détecter et ignorer les duplications.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-48-1" name="__codelineno-48-1" href="#__codelineno-48-1"></a><span class="nd">@Service</span>
<a id="__codelineno-48-2" name="__codelineno-48-2" href="#__codelineno-48-2"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">IdempotentOrderConsumer</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-48-3" name="__codelineno-48-3" href="#__codelineno-48-3"></a>
<a id="__codelineno-48-4" name="__codelineno-48-4" href="#__codelineno-48-4"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">OrderRepository</span><span class="w"> </span><span class="n">orderRepository</span><span class="p">;</span>
<a id="__codelineno-48-5" name="__codelineno-48-5" href="#__codelineno-48-5"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">ProcessedEventRepository</span><span class="w"> </span><span class="n">processedEventRepository</span><span class="p">;</span>
<a id="__codelineno-48-6" name="__codelineno-48-6" href="#__codelineno-48-6"></a>
<a id="__codelineno-48-7" name="__codelineno-48-7" href="#__codelineno-48-7"></a><span class="w">    </span><span class="nd">@Transactional</span>
<a id="__codelineno-48-8" name="__codelineno-48-8" href="#__codelineno-48-8"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">processOrder</span><span class="p">(</span><span class="n">OrderCreatedEvent</span><span class="w"> </span><span class="n">event</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-48-9" name="__codelineno-48-9" href="#__codelineno-48-9"></a><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">eventId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">event</span><span class="p">.</span><span class="na">getHeader</span><span class="p">().</span><span class="na">getEventId</span><span class="p">();</span>
<a id="__codelineno-48-10" name="__codelineno-48-10" href="#__codelineno-48-10"></a>
<a id="__codelineno-48-11" name="__codelineno-48-11" href="#__codelineno-48-11"></a><span class="w">        </span><span class="c1">// Vérifier si déjà traité (dans la même transaction)</span>
<a id="__codelineno-48-12" name="__codelineno-48-12" href="#__codelineno-48-12"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">processedEventRepository</span><span class="p">.</span><span class="na">existsById</span><span class="p">(</span><span class="n">eventId</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-48-13" name="__codelineno-48-13" href="#__codelineno-48-13"></a><span class="w">            </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;Event {} already processed, skipping&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">eventId</span><span class="p">);</span>
<a id="__codelineno-48-14" name="__codelineno-48-14" href="#__codelineno-48-14"></a><span class="w">            </span><span class="n">metrics</span><span class="p">.</span><span class="na">counter</span><span class="p">(</span><span class="s">&quot;events.duplicates.skipped&quot;</span><span class="p">).</span><span class="na">inc</span><span class="p">();</span>
<a id="__codelineno-48-15" name="__codelineno-48-15" href="#__codelineno-48-15"></a><span class="w">            </span><span class="k">return</span><span class="p">;</span>
<a id="__codelineno-48-16" name="__codelineno-48-16" href="#__codelineno-48-16"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-48-17" name="__codelineno-48-17" href="#__codelineno-48-17"></a>
<a id="__codelineno-48-18" name="__codelineno-48-18" href="#__codelineno-48-18"></a><span class="w">        </span><span class="c1">// Traiter l&#39;événement</span>
<a id="__codelineno-48-19" name="__codelineno-48-19" href="#__codelineno-48-19"></a><span class="w">        </span><span class="n">Order</span><span class="w"> </span><span class="n">order</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">createOrderFromEvent</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
<a id="__codelineno-48-20" name="__codelineno-48-20" href="#__codelineno-48-20"></a><span class="w">        </span><span class="n">orderRepository</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">order</span><span class="p">);</span>
<a id="__codelineno-48-21" name="__codelineno-48-21" href="#__codelineno-48-21"></a>
<a id="__codelineno-48-22" name="__codelineno-48-22" href="#__codelineno-48-22"></a><span class="w">        </span><span class="c1">// Marquer comme traité (dans la même transaction)</span>
<a id="__codelineno-48-23" name="__codelineno-48-23" href="#__codelineno-48-23"></a><span class="w">        </span><span class="n">processedEventRepository</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">ProcessedEvent</span><span class="p">(</span>
<a id="__codelineno-48-24" name="__codelineno-48-24" href="#__codelineno-48-24"></a><span class="w">            </span><span class="n">eventId</span><span class="p">,</span>
<a id="__codelineno-48-25" name="__codelineno-48-25" href="#__codelineno-48-25"></a><span class="w">            </span><span class="s">&quot;OrderCreated&quot;</span><span class="p">,</span>
<a id="__codelineno-48-26" name="__codelineno-48-26" href="#__codelineno-48-26"></a><span class="w">            </span><span class="n">event</span><span class="p">.</span><span class="na">getHeader</span><span class="p">().</span><span class="na">getEventTime</span><span class="p">(),</span>
<a id="__codelineno-48-27" name="__codelineno-48-27" href="#__codelineno-48-27"></a><span class="w">            </span><span class="n">Instant</span><span class="p">.</span><span class="na">now</span><span class="p">()</span>
<a id="__codelineno-48-28" name="__codelineno-48-28" href="#__codelineno-48-28"></a><span class="w">        </span><span class="p">));</span>
<a id="__codelineno-48-29" name="__codelineno-48-29" href="#__codelineno-48-29"></a>
<a id="__codelineno-48-30" name="__codelineno-48-30" href="#__codelineno-48-30"></a><span class="w">        </span><span class="n">metrics</span><span class="p">.</span><span class="na">counter</span><span class="p">(</span><span class="s">&quot;events.processed.success&quot;</span><span class="p">).</span><span class="na">inc</span><span class="p">();</span>
<a id="__codelineno-48-31" name="__codelineno-48-31" href="#__codelineno-48-31"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-48-32" name="__codelineno-48-32" href="#__codelineno-48-32"></a><span class="p">}</span>
<a id="__codelineno-48-33" name="__codelineno-48-33" href="#__codelineno-48-33"></a>
<a id="__codelineno-48-34" name="__codelineno-48-34" href="#__codelineno-48-34"></a><span class="c1">// Table des événements traités</span>
<a id="__codelineno-48-35" name="__codelineno-48-35" href="#__codelineno-48-35"></a><span class="nd">@Entity</span>
<a id="__codelineno-48-36" name="__codelineno-48-36" href="#__codelineno-48-36"></a><span class="nd">@Table</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;processed_events&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">indexes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-48-37" name="__codelineno-48-37" href="#__codelineno-48-37"></a><span class="w">    </span><span class="nd">@Index</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;idx_processed_events_type_time&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">columnList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;event_type, event_time&quot;</span><span class="p">)</span>
<a id="__codelineno-48-38" name="__codelineno-48-38" href="#__codelineno-48-38"></a><span class="p">})</span>
<a id="__codelineno-48-39" name="__codelineno-48-39" href="#__codelineno-48-39"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">ProcessedEvent</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-48-40" name="__codelineno-48-40" href="#__codelineno-48-40"></a><span class="w">    </span><span class="nd">@Id</span>
<a id="__codelineno-48-41" name="__codelineno-48-41" href="#__codelineno-48-41"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">eventId</span><span class="p">;</span>
<a id="__codelineno-48-42" name="__codelineno-48-42" href="#__codelineno-48-42"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">eventType</span><span class="p">;</span>
<a id="__codelineno-48-43" name="__codelineno-48-43" href="#__codelineno-48-43"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">Instant</span><span class="w"> </span><span class="n">eventTime</span><span class="p">;</span>
<a id="__codelineno-48-44" name="__codelineno-48-44" href="#__codelineno-48-44"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">Instant</span><span class="w"> </span><span class="n">processedAt</span><span class="p">;</span>
<a id="__codelineno-48-45" name="__codelineno-48-45" href="#__codelineno-48-45"></a>
<a id="__codelineno-48-46" name="__codelineno-48-46" href="#__codelineno-48-46"></a><span class="w">    </span><span class="c1">// TTL pour nettoyage automatique</span>
<a id="__codelineno-48-47" name="__codelineno-48-47" href="#__codelineno-48-47"></a><span class="w">    </span><span class="c1">// Conserver les IDs assez longtemps pour couvrir la fenêtre de replay possible</span>
<a id="__codelineno-48-48" name="__codelineno-48-48" href="#__codelineno-48-48"></a><span class="p">}</span>
<a id="__codelineno-48-49" name="__codelineno-48-49" href="#__codelineno-48-49"></a>
<a id="__codelineno-48-50" name="__codelineno-48-50" href="#__codelineno-48-50"></a><span class="c1">// Nettoyage périodique</span>
<a id="__codelineno-48-51" name="__codelineno-48-51" href="#__codelineno-48-51"></a><span class="nd">@Scheduled</span><span class="p">(</span><span class="n">cron</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;0 0 2 * * *&quot;</span><span class="p">)</span><span class="w">  </span><span class="c1">// Tous les jours à 2h</span>
<a id="__codelineno-48-52" name="__codelineno-48-52" href="#__codelineno-48-52"></a><span class="nd">@Transactional</span>
<a id="__codelineno-48-53" name="__codelineno-48-53" href="#__codelineno-48-53"></a><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">cleanupOldProcessedEvents</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-48-54" name="__codelineno-48-54" href="#__codelineno-48-54"></a><span class="w">    </span><span class="c1">// Conserver 30 jours (doit être &gt; rétention Kafka)</span>
<a id="__codelineno-48-55" name="__codelineno-48-55" href="#__codelineno-48-55"></a><span class="w">    </span><span class="n">Instant</span><span class="w"> </span><span class="n">cutoff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Instant</span><span class="p">.</span><span class="na">now</span><span class="p">().</span><span class="na">minus</span><span class="p">(</span><span class="n">Duration</span><span class="p">.</span><span class="na">ofDays</span><span class="p">(</span><span class="mi">30</span><span class="p">));</span>
<a id="__codelineno-48-56" name="__codelineno-48-56" href="#__codelineno-48-56"></a><span class="w">    </span><span class="n">processedEventRepository</span><span class="p">.</span><span class="na">deleteByProcessedAtBefore</span><span class="p">(</span><span class="n">cutoff</span><span class="p">);</span>
<a id="__codelineno-48-57" name="__codelineno-48-57" href="#__codelineno-48-57"></a><span class="p">}</span>
</code></pre></div>
<p><strong>Pattern 2 : Clé naturelle d'idempotence</strong></p>
<p>Utiliser une contrainte unique sur une clé métier permet à la base de données de rejeter les duplications.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-49-1" name="__codelineno-49-1" href="#__codelineno-49-1"></a><span class="nd">@Service</span>
<a id="__codelineno-49-2" name="__codelineno-49-2" href="#__codelineno-49-2"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">IdempotentPaymentProcessor</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-49-3" name="__codelineno-49-3" href="#__codelineno-49-3"></a>
<a id="__codelineno-49-4" name="__codelineno-49-4" href="#__codelineno-49-4"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">PaymentRepository</span><span class="w"> </span><span class="n">paymentRepository</span><span class="p">;</span>
<a id="__codelineno-49-5" name="__codelineno-49-5" href="#__codelineno-49-5"></a>
<a id="__codelineno-49-6" name="__codelineno-49-6" href="#__codelineno-49-6"></a><span class="w">    </span><span class="nd">@Transactional</span>
<a id="__codelineno-49-7" name="__codelineno-49-7" href="#__codelineno-49-7"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">PaymentResult</span><span class="w"> </span><span class="nf">processPayment</span><span class="p">(</span><span class="n">PaymentRequestEvent</span><span class="w"> </span><span class="n">event</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-49-8" name="__codelineno-49-8" href="#__codelineno-49-8"></a><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">orderId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">event</span><span class="p">.</span><span class="na">getOrderId</span><span class="p">();</span>
<a id="__codelineno-49-9" name="__codelineno-49-9" href="#__codelineno-49-9"></a><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">paymentId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">event</span><span class="p">.</span><span class="na">getPaymentId</span><span class="p">();</span>
<a id="__codelineno-49-10" name="__codelineno-49-10" href="#__codelineno-49-10"></a>
<a id="__codelineno-49-11" name="__codelineno-49-11" href="#__codelineno-49-11"></a><span class="w">        </span><span class="c1">// Vérifier si un paiement existe déjà pour cette commande</span>
<a id="__codelineno-49-12" name="__codelineno-49-12" href="#__codelineno-49-12"></a><span class="w">        </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">Payment</span><span class="o">&gt;</span><span class="w"> </span><span class="n">existingPayment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">paymentRepository</span>
<a id="__codelineno-49-13" name="__codelineno-49-13" href="#__codelineno-49-13"></a><span class="w">            </span><span class="p">.</span><span class="na">findByOrderId</span><span class="p">(</span><span class="n">orderId</span><span class="p">);</span>
<a id="__codelineno-49-14" name="__codelineno-49-14" href="#__codelineno-49-14"></a>
<a id="__codelineno-49-15" name="__codelineno-49-15" href="#__codelineno-49-15"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">existingPayment</span><span class="p">.</span><span class="na">isPresent</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-49-16" name="__codelineno-49-16" href="#__codelineno-49-16"></a><span class="w">            </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;Payment for order {} already exists: {}&quot;</span><span class="p">,</span><span class="w"> </span>
<a id="__codelineno-49-17" name="__codelineno-49-17" href="#__codelineno-49-17"></a><span class="w">                </span><span class="n">orderId</span><span class="p">,</span><span class="w"> </span><span class="n">existingPayment</span><span class="p">.</span><span class="na">get</span><span class="p">().</span><span class="na">getId</span><span class="p">());</span>
<a id="__codelineno-49-18" name="__codelineno-49-18" href="#__codelineno-49-18"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">PaymentResult</span><span class="p">.</span><span class="na">alreadyProcessed</span><span class="p">(</span><span class="n">existingPayment</span><span class="p">.</span><span class="na">get</span><span class="p">());</span>
<a id="__codelineno-49-19" name="__codelineno-49-19" href="#__codelineno-49-19"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-49-20" name="__codelineno-49-20" href="#__codelineno-49-20"></a>
<a id="__codelineno-49-21" name="__codelineno-49-21" href="#__codelineno-49-21"></a><span class="w">        </span><span class="c1">// Créer le paiement avec contrainte unique</span>
<a id="__codelineno-49-22" name="__codelineno-49-22" href="#__codelineno-49-22"></a><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-49-23" name="__codelineno-49-23" href="#__codelineno-49-23"></a><span class="w">            </span><span class="n">Payment</span><span class="w"> </span><span class="n">payment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Payment</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span>
<a id="__codelineno-49-24" name="__codelineno-49-24" href="#__codelineno-49-24"></a><span class="w">                </span><span class="p">.</span><span class="na">id</span><span class="p">(</span><span class="n">paymentId</span><span class="p">)</span>
<a id="__codelineno-49-25" name="__codelineno-49-25" href="#__codelineno-49-25"></a><span class="w">                </span><span class="p">.</span><span class="na">orderId</span><span class="p">(</span><span class="n">orderId</span><span class="p">)</span><span class="w">  </span><span class="c1">// UNIQUE constraint</span>
<a id="__codelineno-49-26" name="__codelineno-49-26" href="#__codelineno-49-26"></a><span class="w">                </span><span class="p">.</span><span class="na">amount</span><span class="p">(</span><span class="n">event</span><span class="p">.</span><span class="na">getAmount</span><span class="p">())</span>
<a id="__codelineno-49-27" name="__codelineno-49-27" href="#__codelineno-49-27"></a><span class="w">                </span><span class="p">.</span><span class="na">status</span><span class="p">(</span><span class="n">PaymentStatus</span><span class="p">.</span><span class="na">PENDING</span><span class="p">)</span>
<a id="__codelineno-49-28" name="__codelineno-49-28" href="#__codelineno-49-28"></a><span class="w">                </span><span class="p">.</span><span class="na">createdAt</span><span class="p">(</span><span class="n">Instant</span><span class="p">.</span><span class="na">now</span><span class="p">())</span>
<a id="__codelineno-49-29" name="__codelineno-49-29" href="#__codelineno-49-29"></a><span class="w">                </span><span class="p">.</span><span class="na">build</span><span class="p">();</span>
<a id="__codelineno-49-30" name="__codelineno-49-30" href="#__codelineno-49-30"></a>
<a id="__codelineno-49-31" name="__codelineno-49-31" href="#__codelineno-49-31"></a><span class="w">            </span><span class="n">paymentRepository</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">payment</span><span class="p">);</span>
<a id="__codelineno-49-32" name="__codelineno-49-32" href="#__codelineno-49-32"></a>
<a id="__codelineno-49-33" name="__codelineno-49-33" href="#__codelineno-49-33"></a><span class="w">            </span><span class="c1">// Traitement du paiement (appel au PSP, etc.)</span>
<a id="__codelineno-49-34" name="__codelineno-49-34" href="#__codelineno-49-34"></a><span class="w">            </span><span class="n">PaymentStatus</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">paymentGateway</span><span class="p">.</span><span class="na">charge</span><span class="p">(</span><span class="n">payment</span><span class="p">);</span>
<a id="__codelineno-49-35" name="__codelineno-49-35" href="#__codelineno-49-35"></a><span class="w">            </span><span class="n">payment</span><span class="p">.</span><span class="na">setStatus</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
<a id="__codelineno-49-36" name="__codelineno-49-36" href="#__codelineno-49-36"></a><span class="w">            </span><span class="n">paymentRepository</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">payment</span><span class="p">);</span>
<a id="__codelineno-49-37" name="__codelineno-49-37" href="#__codelineno-49-37"></a>
<a id="__codelineno-49-38" name="__codelineno-49-38" href="#__codelineno-49-38"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">PaymentResult</span><span class="p">.</span><span class="na">success</span><span class="p">(</span><span class="n">payment</span><span class="p">);</span>
<a id="__codelineno-49-39" name="__codelineno-49-39" href="#__codelineno-49-39"></a>
<a id="__codelineno-49-40" name="__codelineno-49-40" href="#__codelineno-49-40"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">DataIntegrityViolationException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-49-41" name="__codelineno-49-41" href="#__codelineno-49-41"></a><span class="w">            </span><span class="c1">// Race condition : un autre thread a créé le paiement</span>
<a id="__codelineno-49-42" name="__codelineno-49-42" href="#__codelineno-49-42"></a><span class="w">            </span><span class="c1">// entre notre check et notre insert</span>
<a id="__codelineno-49-43" name="__codelineno-49-43" href="#__codelineno-49-43"></a><span class="w">            </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;Concurrent payment creation for order {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">orderId</span><span class="p">);</span>
<a id="__codelineno-49-44" name="__codelineno-49-44" href="#__codelineno-49-44"></a><span class="w">            </span><span class="n">Payment</span><span class="w"> </span><span class="n">existing</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">paymentRepository</span><span class="p">.</span><span class="na">findByOrderId</span><span class="p">(</span><span class="n">orderId</span><span class="p">)</span>
<a id="__codelineno-49-45" name="__codelineno-49-45" href="#__codelineno-49-45"></a><span class="w">                </span><span class="p">.</span><span class="na">orElseThrow</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IllegalStateException</span><span class="p">(</span>
<a id="__codelineno-49-46" name="__codelineno-49-46" href="#__codelineno-49-46"></a><span class="w">                    </span><span class="s">&quot;Payment should exist after constraint violation&quot;</span><span class="p">));</span>
<a id="__codelineno-49-47" name="__codelineno-49-47" href="#__codelineno-49-47"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">PaymentResult</span><span class="p">.</span><span class="na">alreadyProcessed</span><span class="p">(</span><span class="n">existing</span><span class="p">);</span>
<a id="__codelineno-49-48" name="__codelineno-49-48" href="#__codelineno-49-48"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-49-49" name="__codelineno-49-49" href="#__codelineno-49-49"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-49-50" name="__codelineno-49-50" href="#__codelineno-49-50"></a><span class="p">}</span>
<a id="__codelineno-49-51" name="__codelineno-49-51" href="#__codelineno-49-51"></a>
<a id="__codelineno-49-52" name="__codelineno-49-52" href="#__codelineno-49-52"></a><span class="c1">// Contrainte unique sur la table</span>
<a id="__codelineno-49-53" name="__codelineno-49-53" href="#__codelineno-49-53"></a><span class="nd">@Entity</span>
<a id="__codelineno-49-54" name="__codelineno-49-54" href="#__codelineno-49-54"></a><span class="nd">@Table</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;payments&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">uniqueConstraints</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-49-55" name="__codelineno-49-55" href="#__codelineno-49-55"></a><span class="w">    </span><span class="nd">@UniqueConstraint</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;uk_payments_order_id&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">columnNames</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;order_id&quot;</span><span class="p">)</span>
<a id="__codelineno-49-56" name="__codelineno-49-56" href="#__codelineno-49-56"></a><span class="p">})</span>
<a id="__codelineno-49-57" name="__codelineno-49-57" href="#__codelineno-49-57"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Payment</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-49-58" name="__codelineno-49-58" href="#__codelineno-49-58"></a><span class="w">    </span><span class="nd">@Id</span>
<a id="__codelineno-49-59" name="__codelineno-49-59" href="#__codelineno-49-59"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">;</span>
<a id="__codelineno-49-60" name="__codelineno-49-60" href="#__codelineno-49-60"></a>
<a id="__codelineno-49-61" name="__codelineno-49-61" href="#__codelineno-49-61"></a><span class="w">    </span><span class="nd">@Column</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;order_id&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">nullable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span>
<a id="__codelineno-49-62" name="__codelineno-49-62" href="#__codelineno-49-62"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">orderId</span><span class="p">;</span>
<a id="__codelineno-49-63" name="__codelineno-49-63" href="#__codelineno-49-63"></a>
<a id="__codelineno-49-64" name="__codelineno-49-64" href="#__codelineno-49-64"></a><span class="w">    </span><span class="c1">// ...</span>
<a id="__codelineno-49-65" name="__codelineno-49-65" href="#__codelineno-49-65"></a><span class="p">}</span>
</code></pre></div>
<p><strong>Pattern 3 : Idempotence par versioning optimiste</strong></p>
<p>Pour les mises à jour, le versioning optimiste garantit qu'une mise à jour n'est appliquée qu'une seule fois.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-50-1" name="__codelineno-50-1" href="#__codelineno-50-1"></a><span class="nd">@Entity</span>
<a id="__codelineno-50-2" name="__codelineno-50-2" href="#__codelineno-50-2"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Order</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-50-3" name="__codelineno-50-3" href="#__codelineno-50-3"></a><span class="w">    </span><span class="nd">@Id</span>
<a id="__codelineno-50-4" name="__codelineno-50-4" href="#__codelineno-50-4"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">;</span>
<a id="__codelineno-50-5" name="__codelineno-50-5" href="#__codelineno-50-5"></a>
<a id="__codelineno-50-6" name="__codelineno-50-6" href="#__codelineno-50-6"></a><span class="w">    </span><span class="nd">@Version</span>
<a id="__codelineno-50-7" name="__codelineno-50-7" href="#__codelineno-50-7"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">Long</span><span class="w"> </span><span class="n">version</span><span class="p">;</span>
<a id="__codelineno-50-8" name="__codelineno-50-8" href="#__codelineno-50-8"></a>
<a id="__codelineno-50-9" name="__codelineno-50-9" href="#__codelineno-50-9"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">OrderStatus</span><span class="w"> </span><span class="n">status</span><span class="p">;</span>
<a id="__codelineno-50-10" name="__codelineno-50-10" href="#__codelineno-50-10"></a><span class="w">    </span><span class="c1">// ...</span>
<a id="__codelineno-50-11" name="__codelineno-50-11" href="#__codelineno-50-11"></a><span class="p">}</span>
<a id="__codelineno-50-12" name="__codelineno-50-12" href="#__codelineno-50-12"></a>
<a id="__codelineno-50-13" name="__codelineno-50-13" href="#__codelineno-50-13"></a><span class="nd">@Service</span>
<a id="__codelineno-50-14" name="__codelineno-50-14" href="#__codelineno-50-14"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">IdempotentOrderUpdater</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-50-15" name="__codelineno-50-15" href="#__codelineno-50-15"></a>
<a id="__codelineno-50-16" name="__codelineno-50-16" href="#__codelineno-50-16"></a><span class="w">    </span><span class="nd">@Transactional</span>
<a id="__codelineno-50-17" name="__codelineno-50-17" href="#__codelineno-50-17"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">updateOrderStatus</span><span class="p">(</span><span class="n">OrderStatusChangedEvent</span><span class="w"> </span><span class="n">event</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-50-18" name="__codelineno-50-18" href="#__codelineno-50-18"></a><span class="w">        </span><span class="n">Order</span><span class="w"> </span><span class="n">order</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">orderRepository</span><span class="p">.</span><span class="na">findById</span><span class="p">(</span><span class="n">event</span><span class="p">.</span><span class="na">getOrderId</span><span class="p">())</span>
<a id="__codelineno-50-19" name="__codelineno-50-19" href="#__codelineno-50-19"></a><span class="w">            </span><span class="p">.</span><span class="na">orElseThrow</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">OrderNotFoundException</span><span class="p">(</span><span class="n">event</span><span class="p">.</span><span class="na">getOrderId</span><span class="p">()));</span>
<a id="__codelineno-50-20" name="__codelineno-50-20" href="#__codelineno-50-20"></a>
<a id="__codelineno-50-21" name="__codelineno-50-21" href="#__codelineno-50-21"></a><span class="w">        </span><span class="c1">// Vérifier si la mise à jour est déjà appliquée</span>
<a id="__codelineno-50-22" name="__codelineno-50-22" href="#__codelineno-50-22"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">order</span><span class="p">.</span><span class="na">getStatus</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">event</span><span class="p">.</span><span class="na">getNewStatus</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-50-23" name="__codelineno-50-23" href="#__codelineno-50-23"></a><span class="w">            </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;Order {} already in status {}&quot;</span><span class="p">,</span><span class="w"> </span>
<a id="__codelineno-50-24" name="__codelineno-50-24" href="#__codelineno-50-24"></a><span class="w">                </span><span class="n">event</span><span class="p">.</span><span class="na">getOrderId</span><span class="p">(),</span><span class="w"> </span><span class="n">event</span><span class="p">.</span><span class="na">getNewStatus</span><span class="p">());</span>
<a id="__codelineno-50-25" name="__codelineno-50-25" href="#__codelineno-50-25"></a><span class="w">            </span><span class="k">return</span><span class="p">;</span>
<a id="__codelineno-50-26" name="__codelineno-50-26" href="#__codelineno-50-26"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-50-27" name="__codelineno-50-27" href="#__codelineno-50-27"></a>
<a id="__codelineno-50-28" name="__codelineno-50-28" href="#__codelineno-50-28"></a><span class="w">        </span><span class="c1">// Vérifier la version (optimistic locking)</span>
<a id="__codelineno-50-29" name="__codelineno-50-29" href="#__codelineno-50-29"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">event</span><span class="p">.</span><span class="na">getExpectedVersion</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>
<a id="__codelineno-50-30" name="__codelineno-50-30" href="#__codelineno-50-30"></a><span class="w">            </span><span class="o">!</span><span class="n">event</span><span class="p">.</span><span class="na">getExpectedVersion</span><span class="p">().</span><span class="na">equals</span><span class="p">(</span><span class="n">order</span><span class="p">.</span><span class="na">getVersion</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-50-31" name="__codelineno-50-31" href="#__codelineno-50-31"></a><span class="w">            </span><span class="n">log</span><span class="p">.</span><span class="na">warn</span><span class="p">(</span><span class="s">&quot;Version mismatch for order {}: expected {}, actual {}&quot;</span><span class="p">,</span><span class="w"> </span>
<a id="__codelineno-50-32" name="__codelineno-50-32" href="#__codelineno-50-32"></a><span class="w">                </span><span class="n">event</span><span class="p">.</span><span class="na">getOrderId</span><span class="p">(),</span><span class="w"> </span><span class="n">event</span><span class="p">.</span><span class="na">getExpectedVersion</span><span class="p">(),</span><span class="w"> </span><span class="n">order</span><span class="p">.</span><span class="na">getVersion</span><span class="p">());</span>
<a id="__codelineno-50-33" name="__codelineno-50-33" href="#__codelineno-50-33"></a><span class="w">            </span><span class="c1">// Décider selon le cas : ignorer, alerter, ou forcer</span>
<a id="__codelineno-50-34" name="__codelineno-50-34" href="#__codelineno-50-34"></a><span class="w">            </span><span class="k">return</span><span class="p">;</span>
<a id="__codelineno-50-35" name="__codelineno-50-35" href="#__codelineno-50-35"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-50-36" name="__codelineno-50-36" href="#__codelineno-50-36"></a>
<a id="__codelineno-50-37" name="__codelineno-50-37" href="#__codelineno-50-37"></a><span class="w">        </span><span class="n">order</span><span class="p">.</span><span class="na">setStatus</span><span class="p">(</span><span class="n">event</span><span class="p">.</span><span class="na">getNewStatus</span><span class="p">());</span>
<a id="__codelineno-50-38" name="__codelineno-50-38" href="#__codelineno-50-38"></a><span class="w">        </span><span class="n">orderRepository</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">order</span><span class="p">);</span><span class="w">  </span><span class="c1">// Version auto-incrémentée</span>
<a id="__codelineno-50-39" name="__codelineno-50-39" href="#__codelineno-50-39"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-50-40" name="__codelineno-50-40" href="#__codelineno-50-40"></a><span class="p">}</span>
</code></pre></div>
<h3 id="dead-letter-queue-dlq-pattern">Dead Letter Queue (DLQ) Pattern<a class="headerlink" href="#dead-letter-queue-dlq-pattern" title="Permanent link">&para;</a></h3>
<p>Les messages qui échouent de manière répétée doivent être isolés pour ne pas bloquer le traitement des autres messages. Le pattern DLQ est essentiel pour la résilience des systèmes événementiels.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-51-1" name="__codelineno-51-1" href="#__codelineno-51-1"></a>┌─────────────────────────────────────────────────────────────────────────┐
<a id="__codelineno-51-2" name="__codelineno-51-2" href="#__codelineno-51-2"></a>│                      Pattern Dead Letter Queue                          │
<a id="__codelineno-51-3" name="__codelineno-51-3" href="#__codelineno-51-3"></a>│                                                                         │
<a id="__codelineno-51-4" name="__codelineno-51-4" href="#__codelineno-51-4"></a>│  ┌─────────────────┐      ┌─────────────────┐                          │
<a id="__codelineno-51-5" name="__codelineno-51-5" href="#__codelineno-51-5"></a>│  │ orders.events   │      │   Consumer      │                          │
<a id="__codelineno-51-6" name="__codelineno-51-6" href="#__codelineno-51-6"></a>│  │                 │─────▶│                 │                          │
<a id="__codelineno-51-7" name="__codelineno-51-7" href="#__codelineno-51-7"></a>│  └─────────────────┘      │  ┌───────────┐  │                          │
<a id="__codelineno-51-8" name="__codelineno-51-8" href="#__codelineno-51-8"></a>│                           │  │  Process  │  │                          │
<a id="__codelineno-51-9" name="__codelineno-51-9" href="#__codelineno-51-9"></a>│                           │  │           │  │                          │
<a id="__codelineno-51-10" name="__codelineno-51-10" href="#__codelineno-51-10"></a>│                           │  │  Success? │  │                          │
<a id="__codelineno-51-11" name="__codelineno-51-11" href="#__codelineno-51-11"></a>│                           │  └─────┬─────┘  │                          │
<a id="__codelineno-51-12" name="__codelineno-51-12" href="#__codelineno-51-12"></a>│                           │        │        │                          │
<a id="__codelineno-51-13" name="__codelineno-51-13" href="#__codelineno-51-13"></a>│                           │    ┌───┴───┐    │                          │
<a id="__codelineno-51-14" name="__codelineno-51-14" href="#__codelineno-51-14"></a>│                           │   Yes     No    │                          │
<a id="__codelineno-51-15" name="__codelineno-51-15" href="#__codelineno-51-15"></a>│                           │    │       │    │                          │
<a id="__codelineno-51-16" name="__codelineno-51-16" href="#__codelineno-51-16"></a>│                           │    ▼       ▼    │                          │
<a id="__codelineno-51-17" name="__codelineno-51-17" href="#__codelineno-51-17"></a>│                           │ Commit   Retry  │                          │
<a id="__codelineno-51-18" name="__codelineno-51-18" href="#__codelineno-51-18"></a>│                           │          (3x)   │                          │
<a id="__codelineno-51-19" name="__codelineno-51-19" href="#__codelineno-51-19"></a>│                           │           │     │                          │
<a id="__codelineno-51-20" name="__codelineno-51-20" href="#__codelineno-51-20"></a>│                           │      Still No?  │                          │
<a id="__codelineno-51-21" name="__codelineno-51-21" href="#__codelineno-51-21"></a>│                           │           │     │                          │
<a id="__codelineno-51-22" name="__codelineno-51-22" href="#__codelineno-51-22"></a>│                           │           ▼     │                          │
<a id="__codelineno-51-23" name="__codelineno-51-23" href="#__codelineno-51-23"></a>│                           │      Send to    │                          │
<a id="__codelineno-51-24" name="__codelineno-51-24" href="#__codelineno-51-24"></a>│                           │        DLQ      │                          │
<a id="__codelineno-51-25" name="__codelineno-51-25" href="#__codelineno-51-25"></a>│                           └─────────┬───────┘                          │
<a id="__codelineno-51-26" name="__codelineno-51-26" href="#__codelineno-51-26"></a>│                                     │                                   │
<a id="__codelineno-51-27" name="__codelineno-51-27" href="#__codelineno-51-27"></a>│                                     ▼                                   │
<a id="__codelineno-51-28" name="__codelineno-51-28" href="#__codelineno-51-28"></a>│  ┌─────────────────────────────────────────────────────────────────┐   │
<a id="__codelineno-51-29" name="__codelineno-51-29" href="#__codelineno-51-29"></a>│  │ orders.events.dlq                                                │   │
<a id="__codelineno-51-30" name="__codelineno-51-30" href="#__codelineno-51-30"></a>│  │                                                                  │   │
<a id="__codelineno-51-31" name="__codelineno-51-31" href="#__codelineno-51-31"></a>│  │ Headers:                                                         │   │
<a id="__codelineno-51-32" name="__codelineno-51-32" href="#__codelineno-51-32"></a>│  │ - original_topic: orders.events                                 │   │
<a id="__codelineno-51-33" name="__codelineno-51-33" href="#__codelineno-51-33"></a>│  │ - original_partition: 3                                         │   │
<a id="__codelineno-51-34" name="__codelineno-51-34" href="#__codelineno-51-34"></a>│  │ - original_offset: 12345                                        │   │
<a id="__codelineno-51-35" name="__codelineno-51-35" href="#__codelineno-51-35"></a>│  │ - failure_reason: &quot;Database connection timeout&quot;                 │   │
<a id="__codelineno-51-36" name="__codelineno-51-36" href="#__codelineno-51-36"></a>│  │ - retry_count: 3                                                │   │
<a id="__codelineno-51-37" name="__codelineno-51-37" href="#__codelineno-51-37"></a>│  │ - failed_at: 2024-01-15T10:30:00Z                              │   │
<a id="__codelineno-51-38" name="__codelineno-51-38" href="#__codelineno-51-38"></a>│  └─────────────────────────────────────────────────────────────────┘   │
<a id="__codelineno-51-39" name="__codelineno-51-39" href="#__codelineno-51-39"></a>│                                     │                                   │
<a id="__codelineno-51-40" name="__codelineno-51-40" href="#__codelineno-51-40"></a>│                                     ▼                                   │
<a id="__codelineno-51-41" name="__codelineno-51-41" href="#__codelineno-51-41"></a>│  ┌─────────────────────────────────────────────────────────────────┐   │
<a id="__codelineno-51-42" name="__codelineno-51-42" href="#__codelineno-51-42"></a>│  │               DLQ Handler (manuel ou automatisé)                 │   │
<a id="__codelineno-51-43" name="__codelineno-51-43" href="#__codelineno-51-43"></a>│  │                                                                  │   │
<a id="__codelineno-51-44" name="__codelineno-51-44" href="#__codelineno-51-44"></a>│  │ Options:                                                         │   │
<a id="__codelineno-51-45" name="__codelineno-51-45" href="#__codelineno-51-45"></a>│  │ 1. Analyse manuelle et correction                               │   │
<a id="__codelineno-51-46" name="__codelineno-51-46" href="#__codelineno-51-46"></a>│  │ 2. Republication vers le topic original après correction        │   │
<a id="__codelineno-51-47" name="__codelineno-51-47" href="#__codelineno-51-47"></a>│  │ 3. Archivage pour audit                                         │   │
<a id="__codelineno-51-48" name="__codelineno-51-48" href="#__codelineno-51-48"></a>│  │ 4. Alerte et escalade                                           │   │
<a id="__codelineno-51-49" name="__codelineno-51-49" href="#__codelineno-51-49"></a>│  └─────────────────────────────────────────────────────────────────┘   │
<a id="__codelineno-51-50" name="__codelineno-51-50" href="#__codelineno-51-50"></a>└─────────────────────────────────────────────────────────────────────────┘
</code></pre></div>
<p><strong>Implémentation Java</strong> :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-52-1" name="__codelineno-52-1" href="#__codelineno-52-1"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">ResilientConsumer</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-52-2" name="__codelineno-52-2" href="#__codelineno-52-2"></a>
<a id="__codelineno-52-3" name="__codelineno-52-3" href="#__codelineno-52-3"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">MAX_RETRIES</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span>
<a id="__codelineno-52-4" name="__codelineno-52-4" href="#__codelineno-52-4"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">KafkaTemplate</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="kt">byte</span><span class="o">[]&gt;</span><span class="w"> </span><span class="n">dlqProducer</span><span class="p">;</span>
<a id="__codelineno-52-5" name="__codelineno-52-5" href="#__codelineno-52-5"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">MeterRegistry</span><span class="w"> </span><span class="n">metrics</span><span class="p">;</span>
<a id="__codelineno-52-6" name="__codelineno-52-6" href="#__codelineno-52-6"></a>
<a id="__codelineno-52-7" name="__codelineno-52-7" href="#__codelineno-52-7"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">consume</span><span class="p">(</span><span class="n">ConsumerRecord</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">OrderEvent</span><span class="o">&gt;</span><span class="w"> </span><span class="n">record</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-52-8" name="__codelineno-52-8" href="#__codelineno-52-8"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">retryCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-52-9" name="__codelineno-52-9" href="#__codelineno-52-9"></a><span class="w">        </span><span class="n">Exception</span><span class="w"> </span><span class="n">lastException</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<a id="__codelineno-52-10" name="__codelineno-52-10" href="#__codelineno-52-10"></a>
<a id="__codelineno-52-11" name="__codelineno-52-11" href="#__codelineno-52-11"></a><span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">retryCount</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">MAX_RETRIES</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-52-12" name="__codelineno-52-12" href="#__codelineno-52-12"></a><span class="w">            </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-52-13" name="__codelineno-52-13" href="#__codelineno-52-13"></a><span class="w">                </span><span class="n">processOrder</span><span class="p">(</span><span class="n">record</span><span class="p">.</span><span class="na">value</span><span class="p">());</span>
<a id="__codelineno-52-14" name="__codelineno-52-14" href="#__codelineno-52-14"></a><span class="w">                </span><span class="n">metrics</span><span class="p">.</span><span class="na">counter</span><span class="p">(</span><span class="s">&quot;consumer.success&quot;</span><span class="p">).</span><span class="na">inc</span><span class="p">();</span>
<a id="__codelineno-52-15" name="__codelineno-52-15" href="#__codelineno-52-15"></a><span class="w">                </span><span class="k">return</span><span class="p">;</span><span class="w">  </span><span class="c1">// Succès</span>
<a id="__codelineno-52-16" name="__codelineno-52-16" href="#__codelineno-52-16"></a><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">RetriableException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-52-17" name="__codelineno-52-17" href="#__codelineno-52-17"></a><span class="w">                </span><span class="n">retryCount</span><span class="o">++</span><span class="p">;</span>
<a id="__codelineno-52-18" name="__codelineno-52-18" href="#__codelineno-52-18"></a><span class="w">                </span><span class="n">lastException</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">e</span><span class="p">;</span>
<a id="__codelineno-52-19" name="__codelineno-52-19" href="#__codelineno-52-19"></a><span class="w">                </span><span class="n">log</span><span class="p">.</span><span class="na">warn</span><span class="p">(</span><span class="s">&quot;Retry {}/{} for offset {} - {}&quot;</span><span class="p">,</span><span class="w"> </span>
<a id="__codelineno-52-20" name="__codelineno-52-20" href="#__codelineno-52-20"></a><span class="w">                    </span><span class="n">retryCount</span><span class="p">,</span><span class="w"> </span><span class="n">MAX_RETRIES</span><span class="p">,</span><span class="w"> </span><span class="n">record</span><span class="p">.</span><span class="na">offset</span><span class="p">(),</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="na">getMessage</span><span class="p">());</span>
<a id="__codelineno-52-21" name="__codelineno-52-21" href="#__codelineno-52-21"></a><span class="w">                </span><span class="n">metrics</span><span class="p">.</span><span class="na">counter</span><span class="p">(</span><span class="s">&quot;consumer.retry&quot;</span><span class="p">).</span><span class="na">inc</span><span class="p">();</span>
<a id="__codelineno-52-22" name="__codelineno-52-22" href="#__codelineno-52-22"></a><span class="w">                </span><span class="n">sleep</span><span class="p">(</span><span class="n">exponentialBackoff</span><span class="p">(</span><span class="n">retryCount</span><span class="p">));</span>
<a id="__codelineno-52-23" name="__codelineno-52-23" href="#__codelineno-52-23"></a><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">NonRetriableException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-52-24" name="__codelineno-52-24" href="#__codelineno-52-24"></a><span class="w">                </span><span class="c1">// Erreur permanente, envoyer directement au DLQ</span>
<a id="__codelineno-52-25" name="__codelineno-52-25" href="#__codelineno-52-25"></a><span class="w">                </span><span class="n">log</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">&quot;Non-retriable error for offset {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">record</span><span class="p">.</span><span class="na">offset</span><span class="p">(),</span><span class="w"> </span><span class="n">e</span><span class="p">);</span>
<a id="__codelineno-52-26" name="__codelineno-52-26" href="#__codelineno-52-26"></a><span class="w">                </span><span class="n">sendToDlq</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<a id="__codelineno-52-27" name="__codelineno-52-27" href="#__codelineno-52-27"></a><span class="w">                </span><span class="n">metrics</span><span class="p">.</span><span class="na">counter</span><span class="p">(</span><span class="s">&quot;consumer.dlq.non_retriable&quot;</span><span class="p">).</span><span class="na">inc</span><span class="p">();</span>
<a id="__codelineno-52-28" name="__codelineno-52-28" href="#__codelineno-52-28"></a><span class="w">                </span><span class="k">return</span><span class="p">;</span>
<a id="__codelineno-52-29" name="__codelineno-52-29" href="#__codelineno-52-29"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-52-30" name="__codelineno-52-30" href="#__codelineno-52-30"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-52-31" name="__codelineno-52-31" href="#__codelineno-52-31"></a>
<a id="__codelineno-52-32" name="__codelineno-52-32" href="#__codelineno-52-32"></a><span class="w">        </span><span class="c1">// Max retries atteint</span>
<a id="__codelineno-52-33" name="__codelineno-52-33" href="#__codelineno-52-33"></a><span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">&quot;Max retries reached for offset {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">record</span><span class="p">.</span><span class="na">offset</span><span class="p">(),</span><span class="w"> </span><span class="n">lastException</span><span class="p">);</span>
<a id="__codelineno-52-34" name="__codelineno-52-34" href="#__codelineno-52-34"></a><span class="w">        </span><span class="n">sendToDlq</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="w"> </span><span class="n">lastException</span><span class="p">,</span><span class="w"> </span><span class="n">retryCount</span><span class="p">);</span>
<a id="__codelineno-52-35" name="__codelineno-52-35" href="#__codelineno-52-35"></a><span class="w">        </span><span class="n">metrics</span><span class="p">.</span><span class="na">counter</span><span class="p">(</span><span class="s">&quot;consumer.dlq.max_retries&quot;</span><span class="p">).</span><span class="na">inc</span><span class="p">();</span>
<a id="__codelineno-52-36" name="__codelineno-52-36" href="#__codelineno-52-36"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-52-37" name="__codelineno-52-37" href="#__codelineno-52-37"></a>
<a id="__codelineno-52-38" name="__codelineno-52-38" href="#__codelineno-52-38"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">sendToDlq</span><span class="p">(</span><span class="n">ConsumerRecord</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">OrderEvent</span><span class="o">&gt;</span><span class="w"> </span><span class="n">record</span><span class="p">,</span><span class="w"> </span>
<a id="__codelineno-52-39" name="__codelineno-52-39" href="#__codelineno-52-39"></a><span class="w">                          </span><span class="n">Exception</span><span class="w"> </span><span class="n">exception</span><span class="p">,</span><span class="w"> </span>
<a id="__codelineno-52-40" name="__codelineno-52-40" href="#__codelineno-52-40"></a><span class="w">                          </span><span class="kt">int</span><span class="w"> </span><span class="n">retryCount</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-52-41" name="__codelineno-52-41" href="#__codelineno-52-41"></a><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">dlqTopic</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">record</span><span class="p">.</span><span class="na">topic</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;.dlq&quot;</span><span class="p">;</span>
<a id="__codelineno-52-42" name="__codelineno-52-42" href="#__codelineno-52-42"></a>
<a id="__codelineno-52-43" name="__codelineno-52-43" href="#__codelineno-52-43"></a><span class="w">        </span><span class="n">ProducerRecord</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="kt">byte</span><span class="o">[]&gt;</span><span class="w"> </span><span class="n">dlqRecord</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ProducerRecord</span><span class="o">&lt;&gt;</span><span class="p">(</span>
<a id="__codelineno-52-44" name="__codelineno-52-44" href="#__codelineno-52-44"></a><span class="w">            </span><span class="n">dlqTopic</span><span class="p">,</span>
<a id="__codelineno-52-45" name="__codelineno-52-45" href="#__codelineno-52-45"></a><span class="w">            </span><span class="kd">record</span><span class="err">.</span><span class="nc">key</span><span class="p">(),</span>
<a id="__codelineno-52-46" name="__codelineno-52-46" href="#__codelineno-52-46"></a><span class="w">            </span><span class="n">serialize</span><span class="p">(</span><span class="n">record</span><span class="p">.</span><span class="na">value</span><span class="p">())</span>
<a id="__codelineno-52-47" name="__codelineno-52-47" href="#__codelineno-52-47"></a><span class="w">        </span><span class="p">);</span>
<a id="__codelineno-52-48" name="__codelineno-52-48" href="#__codelineno-52-48"></a>
<a id="__codelineno-52-49" name="__codelineno-52-49" href="#__codelineno-52-49"></a><span class="w">        </span><span class="c1">// Ajouter des headers de diagnostic</span>
<a id="__codelineno-52-50" name="__codelineno-52-50" href="#__codelineno-52-50"></a><span class="w">        </span><span class="n">dlqRecord</span><span class="p">.</span><span class="na">headers</span><span class="p">()</span>
<a id="__codelineno-52-51" name="__codelineno-52-51" href="#__codelineno-52-51"></a><span class="w">            </span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="s">&quot;dlq.original.topic&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">record</span><span class="p">.</span><span class="na">topic</span><span class="p">().</span><span class="na">getBytes</span><span class="p">(</span><span class="n">StandardCharsets</span><span class="p">.</span><span class="na">UTF_8</span><span class="p">))</span>
<a id="__codelineno-52-52" name="__codelineno-52-52" href="#__codelineno-52-52"></a><span class="w">            </span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="s">&quot;dlq.original.partition&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="p">.</span><span class="na">valueOf</span><span class="p">(</span><span class="n">record</span><span class="p">.</span><span class="na">partition</span><span class="p">()).</span><span class="na">getBytes</span><span class="p">())</span>
<a id="__codelineno-52-53" name="__codelineno-52-53" href="#__codelineno-52-53"></a><span class="w">            </span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="s">&quot;dlq.original.offset&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="p">.</span><span class="na">valueOf</span><span class="p">(</span><span class="n">record</span><span class="p">.</span><span class="na">offset</span><span class="p">()).</span><span class="na">getBytes</span><span class="p">())</span>
<a id="__codelineno-52-54" name="__codelineno-52-54" href="#__codelineno-52-54"></a><span class="w">            </span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="s">&quot;dlq.original.timestamp&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="p">.</span><span class="na">valueOf</span><span class="p">(</span><span class="n">record</span><span class="p">.</span><span class="na">timestamp</span><span class="p">()).</span><span class="na">getBytes</span><span class="p">())</span>
<a id="__codelineno-52-55" name="__codelineno-52-55" href="#__codelineno-52-55"></a><span class="w">            </span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="s">&quot;dlq.failure.reason&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">exception</span><span class="p">.</span><span class="na">getMessage</span><span class="p">().</span><span class="na">getBytes</span><span class="p">(</span><span class="n">StandardCharsets</span><span class="p">.</span><span class="na">UTF_8</span><span class="p">))</span>
<a id="__codelineno-52-56" name="__codelineno-52-56" href="#__codelineno-52-56"></a><span class="w">            </span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="s">&quot;dlq.failure.exception&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">exception</span><span class="p">.</span><span class="na">getClass</span><span class="p">().</span><span class="na">getName</span><span class="p">().</span><span class="na">getBytes</span><span class="p">())</span>
<a id="__codelineno-52-57" name="__codelineno-52-57" href="#__codelineno-52-57"></a><span class="w">            </span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="s">&quot;dlq.retry.count&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="p">.</span><span class="na">valueOf</span><span class="p">(</span><span class="n">retryCount</span><span class="p">).</span><span class="na">getBytes</span><span class="p">())</span>
<a id="__codelineno-52-58" name="__codelineno-52-58" href="#__codelineno-52-58"></a><span class="w">            </span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="s">&quot;dlq.failed.at&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Instant</span><span class="p">.</span><span class="na">now</span><span class="p">().</span><span class="na">toString</span><span class="p">().</span><span class="na">getBytes</span><span class="p">())</span>
<a id="__codelineno-52-59" name="__codelineno-52-59" href="#__codelineno-52-59"></a><span class="w">            </span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="s">&quot;dlq.consumer.group&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">consumerGroupId</span><span class="p">.</span><span class="na">getBytes</span><span class="p">())</span>
<a id="__codelineno-52-60" name="__codelineno-52-60" href="#__codelineno-52-60"></a><span class="w">            </span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="s">&quot;dlq.consumer.instance&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">instanceId</span><span class="p">.</span><span class="na">getBytes</span><span class="p">());</span>
<a id="__codelineno-52-61" name="__codelineno-52-61" href="#__codelineno-52-61"></a>
<a id="__codelineno-52-62" name="__codelineno-52-62" href="#__codelineno-52-62"></a><span class="w">        </span><span class="c1">// Stack trace complet pour le débogage</span>
<a id="__codelineno-52-63" name="__codelineno-52-63" href="#__codelineno-52-63"></a><span class="w">        </span><span class="n">StringWriter</span><span class="w"> </span><span class="n">sw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">StringWriter</span><span class="p">();</span>
<a id="__codelineno-52-64" name="__codelineno-52-64" href="#__codelineno-52-64"></a><span class="w">        </span><span class="n">exception</span><span class="p">.</span><span class="na">printStackTrace</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">PrintWriter</span><span class="p">(</span><span class="n">sw</span><span class="p">));</span>
<a id="__codelineno-52-65" name="__codelineno-52-65" href="#__codelineno-52-65"></a><span class="w">        </span><span class="n">dlqRecord</span><span class="p">.</span><span class="na">headers</span><span class="p">().</span><span class="na">add</span><span class="p">(</span><span class="s">&quot;dlq.stacktrace&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">sw</span><span class="p">.</span><span class="na">toString</span><span class="p">().</span><span class="na">getBytes</span><span class="p">());</span>
<a id="__codelineno-52-66" name="__codelineno-52-66" href="#__codelineno-52-66"></a>
<a id="__codelineno-52-67" name="__codelineno-52-67" href="#__codelineno-52-67"></a><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-52-68" name="__codelineno-52-68" href="#__codelineno-52-68"></a><span class="w">            </span><span class="n">dlqProducer</span><span class="p">.</span><span class="na">send</span><span class="p">(</span><span class="n">dlqRecord</span><span class="p">).</span><span class="na">get</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">SECONDS</span><span class="p">);</span>
<a id="__codelineno-52-69" name="__codelineno-52-69" href="#__codelineno-52-69"></a><span class="w">            </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;Message sent to DLQ {} after {} retries&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">dlqTopic</span><span class="p">,</span><span class="w"> </span><span class="n">retryCount</span><span class="p">);</span>
<a id="__codelineno-52-70" name="__codelineno-52-70" href="#__codelineno-52-70"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-52-71" name="__codelineno-52-71" href="#__codelineno-52-71"></a><span class="w">            </span><span class="c1">// Échec critique : impossible d&#39;envoyer au DLQ</span>
<a id="__codelineno-52-72" name="__codelineno-52-72" href="#__codelineno-52-72"></a><span class="w">            </span><span class="n">log</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">&quot;CRITICAL: Failed to send to DLQ&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">);</span>
<a id="__codelineno-52-73" name="__codelineno-52-73" href="#__codelineno-52-73"></a><span class="w">            </span><span class="n">metrics</span><span class="p">.</span><span class="na">counter</span><span class="p">(</span><span class="s">&quot;consumer.dlq.send_failed&quot;</span><span class="p">).</span><span class="na">inc</span><span class="p">();</span>
<a id="__codelineno-52-74" name="__codelineno-52-74" href="#__codelineno-52-74"></a><span class="w">            </span><span class="c1">// Alerter immédiatement</span>
<a id="__codelineno-52-75" name="__codelineno-52-75" href="#__codelineno-52-75"></a><span class="w">            </span><span class="n">alertService</span><span class="p">.</span><span class="na">critical</span><span class="p">(</span><span class="s">&quot;DLQ send failure&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">);</span>
<a id="__codelineno-52-76" name="__codelineno-52-76" href="#__codelineno-52-76"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-52-77" name="__codelineno-52-77" href="#__codelineno-52-77"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-52-78" name="__codelineno-52-78" href="#__codelineno-52-78"></a>
<a id="__codelineno-52-79" name="__codelineno-52-79" href="#__codelineno-52-79"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="nf">exponentialBackoff</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">retryCount</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-52-80" name="__codelineno-52-80" href="#__codelineno-52-80"></a><span class="w">        </span><span class="c1">// Backoff exponentiel avec jitter</span>
<a id="__codelineno-52-81" name="__codelineno-52-81" href="#__codelineno-52-81"></a><span class="w">        </span><span class="kt">long</span><span class="w"> </span><span class="n">baseDelay</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1000L</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="w"> </span><span class="n">Math</span><span class="p">.</span><span class="na">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">retryCount</span><span class="p">);</span><span class="w">  </span><span class="c1">// 2s, 4s, 8s</span>
<a id="__codelineno-52-82" name="__codelineno-52-82" href="#__codelineno-52-82"></a><span class="w">        </span><span class="kt">long</span><span class="w"> </span><span class="n">jitter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">baseDelay</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">0.2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">Math</span><span class="p">.</span><span class="na">random</span><span class="p">());</span><span class="w">   </span><span class="c1">// ±20% jitter</span>
<a id="__codelineno-52-83" name="__codelineno-52-83" href="#__codelineno-52-83"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">baseDelay</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">jitter</span><span class="p">;</span>
<a id="__codelineno-52-84" name="__codelineno-52-84" href="#__codelineno-52-84"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-52-85" name="__codelineno-52-85" href="#__codelineno-52-85"></a>
<a id="__codelineno-52-86" name="__codelineno-52-86" href="#__codelineno-52-86"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">sleep</span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="n">millis</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-52-87" name="__codelineno-52-87" href="#__codelineno-52-87"></a><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-52-88" name="__codelineno-52-88" href="#__codelineno-52-88"></a><span class="w">            </span><span class="n">Thread</span><span class="p">.</span><span class="na">sleep</span><span class="p">(</span><span class="n">millis</span><span class="p">);</span>
<a id="__codelineno-52-89" name="__codelineno-52-89" href="#__codelineno-52-89"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">InterruptedException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-52-90" name="__codelineno-52-90" href="#__codelineno-52-90"></a><span class="w">            </span><span class="n">Thread</span><span class="p">.</span><span class="na">currentThread</span><span class="p">().</span><span class="na">interrupt</span><span class="p">();</span>
<a id="__codelineno-52-91" name="__codelineno-52-91" href="#__codelineno-52-91"></a><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">(</span><span class="s">&quot;Consumer interrupted during backoff&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">);</span>
<a id="__codelineno-52-92" name="__codelineno-52-92" href="#__codelineno-52-92"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-52-93" name="__codelineno-52-93" href="#__codelineno-52-93"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-52-94" name="__codelineno-52-94" href="#__codelineno-52-94"></a><span class="p">}</span>
</code></pre></div>
<h3 id="traitement-des-messages-dlq">Traitement des Messages DLQ<a class="headerlink" href="#traitement-des-messages-dlq" title="Permanent link">&para;</a></h3>
<p>Les messages dans le DLQ doivent être analysés et traités. Plusieurs stratégies sont possibles.</p>
<p><strong>Stratégie 1 : Analyse et correction manuelle</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-53-1" name="__codelineno-53-1" href="#__codelineno-53-1"></a><span class="nd">@RestController</span>
<a id="__codelineno-53-2" name="__codelineno-53-2" href="#__codelineno-53-2"></a><span class="nd">@RequestMapping</span><span class="p">(</span><span class="s">&quot;/api/dlq&quot;</span><span class="p">)</span>
<a id="__codelineno-53-3" name="__codelineno-53-3" href="#__codelineno-53-3"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">DlqManagementController</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-53-4" name="__codelineno-53-4" href="#__codelineno-53-4"></a>
<a id="__codelineno-53-5" name="__codelineno-53-5" href="#__codelineno-53-5"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">KafkaConsumer</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="kt">byte</span><span class="o">[]&gt;</span><span class="w"> </span><span class="n">dlqConsumer</span><span class="p">;</span>
<a id="__codelineno-53-6" name="__codelineno-53-6" href="#__codelineno-53-6"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">KafkaProducer</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="kt">byte</span><span class="o">[]&gt;</span><span class="w"> </span><span class="n">replayProducer</span><span class="p">;</span>
<a id="__codelineno-53-7" name="__codelineno-53-7" href="#__codelineno-53-7"></a>
<a id="__codelineno-53-8" name="__codelineno-53-8" href="#__codelineno-53-8"></a><span class="w">    </span><span class="nd">@GetMapping</span><span class="p">(</span><span class="s">&quot;/{topic}/messages&quot;</span><span class="p">)</span>
<a id="__codelineno-53-9" name="__codelineno-53-9" href="#__codelineno-53-9"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">DlqMessage</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getMessages</span><span class="p">(</span>
<a id="__codelineno-53-10" name="__codelineno-53-10" href="#__codelineno-53-10"></a><span class="w">            </span><span class="nd">@PathVariable</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">topic</span><span class="p">,</span>
<a id="__codelineno-53-11" name="__codelineno-53-11" href="#__codelineno-53-11"></a><span class="w">            </span><span class="nd">@RequestParam</span><span class="p">(</span><span class="n">defaultValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;100&quot;</span><span class="p">)</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">limit</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-53-12" name="__codelineno-53-12" href="#__codelineno-53-12"></a>
<a id="__codelineno-53-13" name="__codelineno-53-13" href="#__codelineno-53-13"></a><span class="w">        </span><span class="c1">// Lire les messages du DLQ sans commit</span>
<a id="__codelineno-53-14" name="__codelineno-53-14" href="#__codelineno-53-14"></a><span class="w">        </span><span class="n">dlqConsumer</span><span class="p">.</span><span class="na">assign</span><span class="p">(</span><span class="n">getPartitions</span><span class="p">(</span><span class="n">topic</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;.dlq&quot;</span><span class="p">));</span>
<a id="__codelineno-53-15" name="__codelineno-53-15" href="#__codelineno-53-15"></a><span class="w">        </span><span class="n">dlqConsumer</span><span class="p">.</span><span class="na">seekToBeginning</span><span class="p">(</span><span class="n">dlqConsumer</span><span class="p">.</span><span class="na">assignment</span><span class="p">());</span>
<a id="__codelineno-53-16" name="__codelineno-53-16" href="#__codelineno-53-16"></a>
<a id="__codelineno-53-17" name="__codelineno-53-17" href="#__codelineno-53-17"></a><span class="w">        </span><span class="n">List</span><span class="o">&lt;</span><span class="n">DlqMessage</span><span class="o">&gt;</span><span class="w"> </span><span class="n">messages</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<a id="__codelineno-53-18" name="__codelineno-53-18" href="#__codelineno-53-18"></a><span class="w">        </span><span class="n">ConsumerRecords</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="kt">byte</span><span class="o">[]&gt;</span><span class="w"> </span><span class="n">records</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dlqConsumer</span><span class="p">.</span><span class="na">poll</span><span class="p">(</span><span class="n">Duration</span><span class="p">.</span><span class="na">ofSeconds</span><span class="p">(</span><span class="mi">10</span><span class="p">));</span>
<a id="__codelineno-53-19" name="__codelineno-53-19" href="#__codelineno-53-19"></a>
<a id="__codelineno-53-20" name="__codelineno-53-20" href="#__codelineno-53-20"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">ConsumerRecord</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="kt">byte</span><span class="o">[]&gt;</span><span class="w"> </span><span class="n">record</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">records</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-53-21" name="__codelineno-53-21" href="#__codelineno-53-21"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">messages</span><span class="p">.</span><span class="na">size</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">limit</span><span class="p">)</span><span class="w"> </span><span class="k">break</span><span class="p">;</span>
<a id="__codelineno-53-22" name="__codelineno-53-22" href="#__codelineno-53-22"></a><span class="w">            </span><span class="n">messages</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">DlqMessage</span><span class="p">.</span><span class="na">from</span><span class="p">(</span><span class="n">record</span><span class="p">));</span>
<a id="__codelineno-53-23" name="__codelineno-53-23" href="#__codelineno-53-23"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-53-24" name="__codelineno-53-24" href="#__codelineno-53-24"></a>
<a id="__codelineno-53-25" name="__codelineno-53-25" href="#__codelineno-53-25"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">messages</span><span class="p">;</span>
<a id="__codelineno-53-26" name="__codelineno-53-26" href="#__codelineno-53-26"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-53-27" name="__codelineno-53-27" href="#__codelineno-53-27"></a>
<a id="__codelineno-53-28" name="__codelineno-53-28" href="#__codelineno-53-28"></a><span class="w">    </span><span class="nd">@PostMapping</span><span class="p">(</span><span class="s">&quot;/{topic}/replay/{offset}&quot;</span><span class="p">)</span>
<a id="__codelineno-53-29" name="__codelineno-53-29" href="#__codelineno-53-29"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">ResponseEntity</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="nf">replayMessage</span><span class="p">(</span>
<a id="__codelineno-53-30" name="__codelineno-53-30" href="#__codelineno-53-30"></a><span class="w">            </span><span class="nd">@PathVariable</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">topic</span><span class="p">,</span>
<a id="__codelineno-53-31" name="__codelineno-53-31" href="#__codelineno-53-31"></a><span class="w">            </span><span class="nd">@PathVariable</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">offset</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-53-32" name="__codelineno-53-32" href="#__codelineno-53-32"></a>
<a id="__codelineno-53-33" name="__codelineno-53-33" href="#__codelineno-53-33"></a><span class="w">        </span><span class="c1">// Récupérer le message</span>
<a id="__codelineno-53-34" name="__codelineno-53-34" href="#__codelineno-53-34"></a><span class="w">        </span><span class="n">ConsumerRecord</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="kt">byte</span><span class="o">[]&gt;</span><span class="w"> </span><span class="n">dlqRecord</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">findMessage</span><span class="p">(</span><span class="n">topic</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;.dlq&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">offset</span><span class="p">);</span>
<a id="__codelineno-53-35" name="__codelineno-53-35" href="#__codelineno-53-35"></a>
<a id="__codelineno-53-36" name="__codelineno-53-36" href="#__codelineno-53-36"></a><span class="w">        </span><span class="c1">// Extraire le topic original des headers</span>
<a id="__codelineno-53-37" name="__codelineno-53-37" href="#__codelineno-53-37"></a><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">originalTopic</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">String</span><span class="p">(</span>
<a id="__codelineno-53-38" name="__codelineno-53-38" href="#__codelineno-53-38"></a><span class="w">            </span><span class="n">dlqRecord</span><span class="p">.</span><span class="na">headers</span><span class="p">().</span><span class="na">lastHeader</span><span class="p">(</span><span class="s">&quot;dlq.original.topic&quot;</span><span class="p">).</span><span class="na">value</span><span class="p">());</span>
<a id="__codelineno-53-39" name="__codelineno-53-39" href="#__codelineno-53-39"></a>
<a id="__codelineno-53-40" name="__codelineno-53-40" href="#__codelineno-53-40"></a><span class="w">        </span><span class="c1">// Republier vers le topic original</span>
<a id="__codelineno-53-41" name="__codelineno-53-41" href="#__codelineno-53-41"></a><span class="w">        </span><span class="n">ProducerRecord</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="kt">byte</span><span class="o">[]&gt;</span><span class="w"> </span><span class="n">replayRecord</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ProducerRecord</span><span class="o">&lt;&gt;</span><span class="p">(</span>
<a id="__codelineno-53-42" name="__codelineno-53-42" href="#__codelineno-53-42"></a><span class="w">            </span><span class="n">originalTopic</span><span class="p">,</span>
<a id="__codelineno-53-43" name="__codelineno-53-43" href="#__codelineno-53-43"></a><span class="w">            </span><span class="n">dlqRecord</span><span class="p">.</span><span class="na">key</span><span class="p">(),</span>
<a id="__codelineno-53-44" name="__codelineno-53-44" href="#__codelineno-53-44"></a><span class="w">            </span><span class="n">dlqRecord</span><span class="p">.</span><span class="na">value</span><span class="p">()</span>
<a id="__codelineno-53-45" name="__codelineno-53-45" href="#__codelineno-53-45"></a><span class="w">        </span><span class="p">);</span>
<a id="__codelineno-53-46" name="__codelineno-53-46" href="#__codelineno-53-46"></a><span class="w">        </span><span class="n">replayRecord</span><span class="p">.</span><span class="na">headers</span><span class="p">().</span><span class="na">add</span><span class="p">(</span><span class="s">&quot;dlq.replayed&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;true&quot;</span><span class="p">.</span><span class="na">getBytes</span><span class="p">());</span>
<a id="__codelineno-53-47" name="__codelineno-53-47" href="#__codelineno-53-47"></a><span class="w">        </span><span class="n">replayRecord</span><span class="p">.</span><span class="na">headers</span><span class="p">().</span><span class="na">add</span><span class="p">(</span><span class="s">&quot;dlq.replay.time&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Instant</span><span class="p">.</span><span class="na">now</span><span class="p">().</span><span class="na">toString</span><span class="p">().</span><span class="na">getBytes</span><span class="p">());</span>
<a id="__codelineno-53-48" name="__codelineno-53-48" href="#__codelineno-53-48"></a>
<a id="__codelineno-53-49" name="__codelineno-53-49" href="#__codelineno-53-49"></a><span class="w">        </span><span class="n">replayProducer</span><span class="p">.</span><span class="na">send</span><span class="p">(</span><span class="n">replayRecord</span><span class="p">).</span><span class="na">get</span><span class="p">();</span>
<a id="__codelineno-53-50" name="__codelineno-53-50" href="#__codelineno-53-50"></a>
<a id="__codelineno-53-51" name="__codelineno-53-51" href="#__codelineno-53-51"></a><span class="w">        </span><span class="c1">// Optionnel : supprimer du DLQ après replay réussi</span>
<a id="__codelineno-53-52" name="__codelineno-53-52" href="#__codelineno-53-52"></a><span class="w">        </span><span class="c1">// (ou marquer comme traité dans une table séparée)</span>
<a id="__codelineno-53-53" name="__codelineno-53-53" href="#__codelineno-53-53"></a>
<a id="__codelineno-53-54" name="__codelineno-53-54" href="#__codelineno-53-54"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">ResponseEntity</span><span class="p">.</span><span class="na">ok</span><span class="p">().</span><span class="na">build</span><span class="p">();</span>
<a id="__codelineno-53-55" name="__codelineno-53-55" href="#__codelineno-53-55"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-53-56" name="__codelineno-53-56" href="#__codelineno-53-56"></a>
<a id="__codelineno-53-57" name="__codelineno-53-57" href="#__codelineno-53-57"></a><span class="w">    </span><span class="nd">@DeleteMapping</span><span class="p">(</span><span class="s">&quot;/{topic}/messages/{offset}&quot;</span><span class="p">)</span>
<a id="__codelineno-53-58" name="__codelineno-53-58" href="#__codelineno-53-58"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">ResponseEntity</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="nf">acknowledgeMessage</span><span class="p">(</span>
<a id="__codelineno-53-59" name="__codelineno-53-59" href="#__codelineno-53-59"></a><span class="w">            </span><span class="nd">@PathVariable</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">topic</span><span class="p">,</span>
<a id="__codelineno-53-60" name="__codelineno-53-60" href="#__codelineno-53-60"></a><span class="w">            </span><span class="nd">@PathVariable</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">offset</span><span class="p">,</span>
<a id="__codelineno-53-61" name="__codelineno-53-61" href="#__codelineno-53-61"></a><span class="w">            </span><span class="nd">@RequestBody</span><span class="w"> </span><span class="n">AcknowledgeRequest</span><span class="w"> </span><span class="n">request</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-53-62" name="__codelineno-53-62" href="#__codelineno-53-62"></a>
<a id="__codelineno-53-63" name="__codelineno-53-63" href="#__codelineno-53-63"></a><span class="w">        </span><span class="c1">// Enregistrer la raison de l&#39;acquittement (ignoré, corrigé manuellement, etc.)</span>
<a id="__codelineno-53-64" name="__codelineno-53-64" href="#__codelineno-53-64"></a><span class="w">        </span><span class="n">dlqAuditService</span><span class="p">.</span><span class="na">acknowledge</span><span class="p">(</span><span class="n">topic</span><span class="p">,</span><span class="w"> </span><span class="n">offset</span><span class="p">,</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="na">getReason</span><span class="p">(),</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="na">getUser</span><span class="p">());</span>
<a id="__codelineno-53-65" name="__codelineno-53-65" href="#__codelineno-53-65"></a>
<a id="__codelineno-53-66" name="__codelineno-53-66" href="#__codelineno-53-66"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">ResponseEntity</span><span class="p">.</span><span class="na">ok</span><span class="p">().</span><span class="na">build</span><span class="p">();</span>
<a id="__codelineno-53-67" name="__codelineno-53-67" href="#__codelineno-53-67"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-53-68" name="__codelineno-53-68" href="#__codelineno-53-68"></a><span class="p">}</span>
</code></pre></div>
<p><strong>Stratégie 2 : Retry automatique avec délai</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-54-1" name="__codelineno-54-1" href="#__codelineno-54-1"></a><span class="nd">@Component</span>
<a id="__codelineno-54-2" name="__codelineno-54-2" href="#__codelineno-54-2"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">DlqRetryProcessor</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-54-3" name="__codelineno-54-3" href="#__codelineno-54-3"></a>
<a id="__codelineno-54-4" name="__codelineno-54-4" href="#__codelineno-54-4"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">KafkaTemplate</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="kt">byte</span><span class="o">[]&gt;</span><span class="w"> </span><span class="n">producer</span><span class="p">;</span>
<a id="__codelineno-54-5" name="__codelineno-54-5" href="#__codelineno-54-5"></a>
<a id="__codelineno-54-6" name="__codelineno-54-6" href="#__codelineno-54-6"></a><span class="w">    </span><span class="nd">@KafkaListener</span><span class="p">(</span><span class="n">topics</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;orders.events.dlq&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">groupId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;dlq-retry-processor&quot;</span><span class="p">)</span>
<a id="__codelineno-54-7" name="__codelineno-54-7" href="#__codelineno-54-7"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">processRetryable</span><span class="p">(</span><span class="n">ConsumerRecord</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="kt">byte</span><span class="o">[]&gt;</span><span class="w"> </span><span class="n">record</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-54-8" name="__codelineno-54-8" href="#__codelineno-54-8"></a><span class="w">        </span><span class="c1">// Vérifier si le message peut être retenté</span>
<a id="__codelineno-54-9" name="__codelineno-54-9" href="#__codelineno-54-9"></a><span class="w">        </span><span class="n">Header</span><span class="w"> </span><span class="n">retryCountHeader</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">record</span><span class="p">.</span><span class="na">headers</span><span class="p">().</span><span class="na">lastHeader</span><span class="p">(</span><span class="s">&quot;dlq.retry.count&quot;</span><span class="p">);</span>
<a id="__codelineno-54-10" name="__codelineno-54-10" href="#__codelineno-54-10"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">previousRetries</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Integer</span><span class="p">.</span><span class="na">parseInt</span><span class="p">(</span>
<a id="__codelineno-54-11" name="__codelineno-54-11" href="#__codelineno-54-11"></a><span class="w">            </span><span class="k">new</span><span class="w"> </span><span class="n">String</span><span class="p">(</span><span class="n">retryCountHeader</span><span class="p">.</span><span class="na">value</span><span class="p">()));</span>
<a id="__codelineno-54-12" name="__codelineno-54-12" href="#__codelineno-54-12"></a>
<a id="__codelineno-54-13" name="__codelineno-54-13" href="#__codelineno-54-13"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">previousRetries</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-54-14" name="__codelineno-54-14" href="#__codelineno-54-14"></a><span class="w">            </span><span class="c1">// Trop de retries, archiver et alerter</span>
<a id="__codelineno-54-15" name="__codelineno-54-15" href="#__codelineno-54-15"></a><span class="w">            </span><span class="n">archiveAndAlert</span><span class="p">(</span><span class="n">record</span><span class="p">);</span>
<a id="__codelineno-54-16" name="__codelineno-54-16" href="#__codelineno-54-16"></a><span class="w">            </span><span class="k">return</span><span class="p">;</span>
<a id="__codelineno-54-17" name="__codelineno-54-17" href="#__codelineno-54-17"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-54-18" name="__codelineno-54-18" href="#__codelineno-54-18"></a>
<a id="__codelineno-54-19" name="__codelineno-54-19" href="#__codelineno-54-19"></a><span class="w">        </span><span class="c1">// Vérifier le délai depuis l&#39;échec</span>
<a id="__codelineno-54-20" name="__codelineno-54-20" href="#__codelineno-54-20"></a><span class="w">        </span><span class="n">Header</span><span class="w"> </span><span class="n">failedAtHeader</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">record</span><span class="p">.</span><span class="na">headers</span><span class="p">().</span><span class="na">lastHeader</span><span class="p">(</span><span class="s">&quot;dlq.failed.at&quot;</span><span class="p">);</span>
<a id="__codelineno-54-21" name="__codelineno-54-21" href="#__codelineno-54-21"></a><span class="w">        </span><span class="n">Instant</span><span class="w"> </span><span class="n">failedAt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Instant</span><span class="p">.</span><span class="na">parse</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">String</span><span class="p">(</span><span class="n">failedAtHeader</span><span class="p">.</span><span class="na">value</span><span class="p">()));</span>
<a id="__codelineno-54-22" name="__codelineno-54-22" href="#__codelineno-54-22"></a><span class="w">        </span><span class="n">Duration</span><span class="w"> </span><span class="n">timeSinceFail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Duration</span><span class="p">.</span><span class="na">between</span><span class="p">(</span><span class="n">failedAt</span><span class="p">,</span><span class="w"> </span><span class="n">Instant</span><span class="p">.</span><span class="na">now</span><span class="p">());</span>
<a id="__codelineno-54-23" name="__codelineno-54-23" href="#__codelineno-54-23"></a>
<a id="__codelineno-54-24" name="__codelineno-54-24" href="#__codelineno-54-24"></a><span class="w">        </span><span class="c1">// Attendre un délai croissant avant retry</span>
<a id="__codelineno-54-25" name="__codelineno-54-25" href="#__codelineno-54-25"></a><span class="w">        </span><span class="n">Duration</span><span class="w"> </span><span class="n">requiredDelay</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Duration</span><span class="p">.</span><span class="na">ofMinutes</span><span class="p">(</span><span class="n">previousRetries</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">5L</span><span class="p">);</span><span class="w">  </span><span class="c1">// 0, 5, 10, 15... minutes</span>
<a id="__codelineno-54-26" name="__codelineno-54-26" href="#__codelineno-54-26"></a>
<a id="__codelineno-54-27" name="__codelineno-54-27" href="#__codelineno-54-27"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">timeSinceFail</span><span class="p">.</span><span class="na">compareTo</span><span class="p">(</span><span class="n">requiredDelay</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-54-28" name="__codelineno-54-28" href="#__codelineno-54-28"></a><span class="w">            </span><span class="c1">// Pas encore temps de retry, remettre dans le DLQ</span>
<a id="__codelineno-54-29" name="__codelineno-54-29" href="#__codelineno-54-29"></a><span class="w">            </span><span class="n">republishToDlq</span><span class="p">(</span><span class="n">record</span><span class="p">);</span>
<a id="__codelineno-54-30" name="__codelineno-54-30" href="#__codelineno-54-30"></a><span class="w">            </span><span class="k">return</span><span class="p">;</span>
<a id="__codelineno-54-31" name="__codelineno-54-31" href="#__codelineno-54-31"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-54-32" name="__codelineno-54-32" href="#__codelineno-54-32"></a>
<a id="__codelineno-54-33" name="__codelineno-54-33" href="#__codelineno-54-33"></a><span class="w">        </span><span class="c1">// Retry vers le topic original</span>
<a id="__codelineno-54-34" name="__codelineno-54-34" href="#__codelineno-54-34"></a><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">originalTopic</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">String</span><span class="p">(</span>
<a id="__codelineno-54-35" name="__codelineno-54-35" href="#__codelineno-54-35"></a><span class="w">            </span><span class="kd">record</span><span class="err">.</span><span class="nc">headers</span><span class="p">().</span><span class="na">lastHeader</span><span class="p">(</span><span class="s">&quot;dlq.original.topic&quot;</span><span class="p">).</span><span class="na">value</span><span class="p">());</span>
<a id="__codelineno-54-36" name="__codelineno-54-36" href="#__codelineno-54-36"></a>
<a id="__codelineno-54-37" name="__codelineno-54-37" href="#__codelineno-54-37"></a><span class="w">        </span><span class="n">ProducerRecord</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="kt">byte</span><span class="o">[]&gt;</span><span class="w"> </span><span class="n">retryRecord</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ProducerRecord</span><span class="o">&lt;&gt;</span><span class="p">(</span>
<a id="__codelineno-54-38" name="__codelineno-54-38" href="#__codelineno-54-38"></a><span class="w">            </span><span class="n">originalTopic</span><span class="p">,</span>
<a id="__codelineno-54-39" name="__codelineno-54-39" href="#__codelineno-54-39"></a><span class="w">            </span><span class="kd">record</span><span class="err">.</span><span class="nc">key</span><span class="p">(),</span>
<a id="__codelineno-54-40" name="__codelineno-54-40" href="#__codelineno-54-40"></a><span class="w">            </span><span class="kd">record</span><span class="err">.</span><span class="nc">value</span><span class="p">()</span>
<a id="__codelineno-54-41" name="__codelineno-54-41" href="#__codelineno-54-41"></a><span class="w">        </span><span class="p">);</span>
<a id="__codelineno-54-42" name="__codelineno-54-42" href="#__codelineno-54-42"></a><span class="w">        </span><span class="n">retryRecord</span><span class="p">.</span><span class="na">headers</span><span class="p">().</span><span class="na">add</span><span class="p">(</span><span class="s">&quot;dlq.retry.attempt&quot;</span><span class="p">,</span><span class="w"> </span>
<a id="__codelineno-54-43" name="__codelineno-54-43" href="#__codelineno-54-43"></a><span class="w">            </span><span class="n">String</span><span class="p">.</span><span class="na">valueOf</span><span class="p">(</span><span class="n">previousRetries</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">).</span><span class="na">getBytes</span><span class="p">());</span>
<a id="__codelineno-54-44" name="__codelineno-54-44" href="#__codelineno-54-44"></a>
<a id="__codelineno-54-45" name="__codelineno-54-45" href="#__codelineno-54-45"></a><span class="w">        </span><span class="n">producer</span><span class="p">.</span><span class="na">send</span><span class="p">(</span><span class="n">retryRecord</span><span class="p">);</span>
<a id="__codelineno-54-46" name="__codelineno-54-46" href="#__codelineno-54-46"></a><span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;Retrying message from DLQ, attempt {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">previousRetries</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-54-47" name="__codelineno-54-47" href="#__codelineno-54-47"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-54-48" name="__codelineno-54-48" href="#__codelineno-54-48"></a><span class="p">}</span>
</code></pre></div>
<p><strong>Stratégie 3 : Alertes et escalade</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-55-1" name="__codelineno-55-1" href="#__codelineno-55-1"></a><span class="nd">@Component</span>
<a id="__codelineno-55-2" name="__codelineno-55-2" href="#__codelineno-55-2"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">DlqAlertProcessor</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-55-3" name="__codelineno-55-3" href="#__codelineno-55-3"></a>
<a id="__codelineno-55-4" name="__codelineno-55-4" href="#__codelineno-55-4"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">AlertService</span><span class="w"> </span><span class="n">alertService</span><span class="p">;</span>
<a id="__codelineno-55-5" name="__codelineno-55-5" href="#__codelineno-55-5"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">MetricRegistry</span><span class="w"> </span><span class="n">metrics</span><span class="p">;</span>
<a id="__codelineno-55-6" name="__codelineno-55-6" href="#__codelineno-55-6"></a>
<a id="__codelineno-55-7" name="__codelineno-55-7" href="#__codelineno-55-7"></a><span class="w">    </span><span class="nd">@Scheduled</span><span class="p">(</span><span class="n">fixedRate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">60000</span><span class="p">)</span><span class="w">  </span><span class="c1">// Toutes les minutes</span>
<a id="__codelineno-55-8" name="__codelineno-55-8" href="#__codelineno-55-8"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">checkDlqHealth</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-55-9" name="__codelineno-55-9" href="#__codelineno-55-9"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">dlqTopic</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">getDlqTopics</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-55-10" name="__codelineno-55-10" href="#__codelineno-55-10"></a><span class="w">            </span><span class="kt">long</span><span class="w"> </span><span class="n">messageCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getMessageCount</span><span class="p">(</span><span class="n">dlqTopic</span><span class="p">);</span>
<a id="__codelineno-55-11" name="__codelineno-55-11" href="#__codelineno-55-11"></a><span class="w">            </span><span class="kt">long</span><span class="w"> </span><span class="n">oldestMessageAge</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getOldestMessageAge</span><span class="p">(</span><span class="n">dlqTopic</span><span class="p">);</span>
<a id="__codelineno-55-12" name="__codelineno-55-12" href="#__codelineno-55-12"></a>
<a id="__codelineno-55-13" name="__codelineno-55-13" href="#__codelineno-55-13"></a><span class="w">            </span><span class="n">metrics</span><span class="p">.</span><span class="na">gauge</span><span class="p">(</span><span class="s">&quot;dlq.message_count&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">messageCount</span><span class="p">,</span><span class="w"> </span>
<a id="__codelineno-55-14" name="__codelineno-55-14" href="#__codelineno-55-14"></a><span class="w">                </span><span class="n">Tags</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="s">&quot;topic&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">dlqTopic</span><span class="p">));</span>
<a id="__codelineno-55-15" name="__codelineno-55-15" href="#__codelineno-55-15"></a><span class="w">            </span><span class="n">metrics</span><span class="p">.</span><span class="na">gauge</span><span class="p">(</span><span class="s">&quot;dlq.oldest_message_age_seconds&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">oldestMessageAge</span><span class="p">,</span><span class="w"> </span>
<a id="__codelineno-55-16" name="__codelineno-55-16" href="#__codelineno-55-16"></a><span class="w">                </span><span class="n">Tags</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="s">&quot;topic&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">dlqTopic</span><span class="p">));</span>
<a id="__codelineno-55-17" name="__codelineno-55-17" href="#__codelineno-55-17"></a>
<a id="__codelineno-55-18" name="__codelineno-55-18" href="#__codelineno-55-18"></a><span class="w">            </span><span class="c1">// Alertes basées sur des seuils</span>
<a id="__codelineno-55-19" name="__codelineno-55-19" href="#__codelineno-55-19"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">messageCount</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1000</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-55-20" name="__codelineno-55-20" href="#__codelineno-55-20"></a><span class="w">                </span><span class="n">alertService</span><span class="p">.</span><span class="na">warning</span><span class="p">(</span>
<a id="__codelineno-55-21" name="__codelineno-55-21" href="#__codelineno-55-21"></a><span class="w">                    </span><span class="s">&quot;DLQ &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">dlqTopic</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; has &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">messageCount</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; messages&quot;</span><span class="p">);</span>
<a id="__codelineno-55-22" name="__codelineno-55-22" href="#__codelineno-55-22"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-55-23" name="__codelineno-55-23" href="#__codelineno-55-23"></a>
<a id="__codelineno-55-24" name="__codelineno-55-24" href="#__codelineno-55-24"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">oldestMessageAge</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">Duration</span><span class="p">.</span><span class="na">ofHours</span><span class="p">(</span><span class="mi">24</span><span class="p">).</span><span class="na">getSeconds</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-55-25" name="__codelineno-55-25" href="#__codelineno-55-25"></a><span class="w">                </span><span class="n">alertService</span><span class="p">.</span><span class="na">critical</span><span class="p">(</span>
<a id="__codelineno-55-26" name="__codelineno-55-26" href="#__codelineno-55-26"></a><span class="w">                    </span><span class="s">&quot;DLQ &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">dlqTopic</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; has messages older than 24 hours&quot;</span><span class="p">);</span>
<a id="__codelineno-55-27" name="__codelineno-55-27" href="#__codelineno-55-27"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-55-28" name="__codelineno-55-28" href="#__codelineno-55-28"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-55-29" name="__codelineno-55-29" href="#__codelineno-55-29"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-55-30" name="__codelineno-55-30" href="#__codelineno-55-30"></a><span class="p">}</span>
</code></pre></div>
<h3 id="patterns-avances-de-communication">Patterns Avancés de Communication<a class="headerlink" href="#patterns-avances-de-communication" title="Permanent link">&para;</a></h3>
<p>Au-delà des patterns de base (publication/abonnement), Kafka supporte des patterns de communication plus sophistiqués nécessaires pour certains cas d'usage complexes.</p>
<p><strong>Pattern Request-Reply</strong></p>
<p>Bien que Kafka soit conçu pour la communication asynchrone, certains cas d'usage nécessitent une sémantique requête-réponse. Ce pattern implémente une communication pseudo-synchrone au-dessus de Kafka.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-56-1" name="__codelineno-56-1" href="#__codelineno-56-1"></a>┌─────────────────────────────────────────────────────────────────────────┐
<a id="__codelineno-56-2" name="__codelineno-56-2" href="#__codelineno-56-2"></a>│                    Pattern Request-Reply avec Kafka                     │
<a id="__codelineno-56-3" name="__codelineno-56-3" href="#__codelineno-56-3"></a>│                                                                         │
<a id="__codelineno-56-4" name="__codelineno-56-4" href="#__codelineno-56-4"></a>│  Service A (Requester)                      Service B (Responder)       │
<a id="__codelineno-56-5" name="__codelineno-56-5" href="#__codelineno-56-5"></a>│  ┌─────────────────────┐                   ┌─────────────────────┐     │
<a id="__codelineno-56-6" name="__codelineno-56-6" href="#__codelineno-56-6"></a>│  │  1. Générer         │                   │                     │     │
<a id="__codelineno-56-7" name="__codelineno-56-7" href="#__codelineno-56-7"></a>│  │     correlation_id  │                   │                     │     │
<a id="__codelineno-56-8" name="__codelineno-56-8" href="#__codelineno-56-8"></a>│  │  2. Envoyer requête │                   │                     │     │
<a id="__codelineno-56-9" name="__codelineno-56-9" href="#__codelineno-56-9"></a>│  │     avec reply_topic│                   │                     │     │
<a id="__codelineno-56-10" name="__codelineno-56-10" href="#__codelineno-56-10"></a>│  └──────────┬──────────┘                   └──────────┬──────────┘     │
<a id="__codelineno-56-11" name="__codelineno-56-11" href="#__codelineno-56-11"></a>│             │                                         │                 │
<a id="__codelineno-56-12" name="__codelineno-56-12" href="#__codelineno-56-12"></a>│             ▼                                         │                 │
<a id="__codelineno-56-13" name="__codelineno-56-13" href="#__codelineno-56-13"></a>│  ┌─────────────────────────────────────────────────────────────────┐   │
<a id="__codelineno-56-14" name="__codelineno-56-14" href="#__codelineno-56-14"></a>│  │                      Topic: requests                             │   │
<a id="__codelineno-56-15" name="__codelineno-56-15" href="#__codelineno-56-15"></a>│  │  {correlation_id: &quot;abc&quot;, reply_topic: &quot;replies.svc-a&quot;, ...}     │   │
<a id="__codelineno-56-16" name="__codelineno-56-16" href="#__codelineno-56-16"></a>│  └─────────────────────────────────────────────────────────────────┘   │
<a id="__codelineno-56-17" name="__codelineno-56-17" href="#__codelineno-56-17"></a>│                                         │                               │
<a id="__codelineno-56-18" name="__codelineno-56-18" href="#__codelineno-56-18"></a>│                                         ▼                               │
<a id="__codelineno-56-19" name="__codelineno-56-19" href="#__codelineno-56-19"></a>│                              ┌──────────┴──────────┐                   │
<a id="__codelineno-56-20" name="__codelineno-56-20" href="#__codelineno-56-20"></a>│                              │  3. Traiter requête │                   │
<a id="__codelineno-56-21" name="__codelineno-56-21" href="#__codelineno-56-21"></a>│                              │  4. Envoyer réponse │                   │
<a id="__codelineno-56-22" name="__codelineno-56-22" href="#__codelineno-56-22"></a>│                              └──────────┬──────────┘                   │
<a id="__codelineno-56-23" name="__codelineno-56-23" href="#__codelineno-56-23"></a>│                                         │                               │
<a id="__codelineno-56-24" name="__codelineno-56-24" href="#__codelineno-56-24"></a>│                                         ▼                               │
<a id="__codelineno-56-25" name="__codelineno-56-25" href="#__codelineno-56-25"></a>│  ┌─────────────────────────────────────────────────────────────────┐   │
<a id="__codelineno-56-26" name="__codelineno-56-26" href="#__codelineno-56-26"></a>│  │                   Topic: replies.svc-a                           │   │
<a id="__codelineno-56-27" name="__codelineno-56-27" href="#__codelineno-56-27"></a>│  │  {correlation_id: &quot;abc&quot;, result: &quot;success&quot;, ...}                │   │
<a id="__codelineno-56-28" name="__codelineno-56-28" href="#__codelineno-56-28"></a>│  └─────────────────────────────────────────────────────────────────┘   │
<a id="__codelineno-56-29" name="__codelineno-56-29" href="#__codelineno-56-29"></a>│             │                                                           │
<a id="__codelineno-56-30" name="__codelineno-56-30" href="#__codelineno-56-30"></a>│             ▼                                                           │
<a id="__codelineno-56-31" name="__codelineno-56-31" href="#__codelineno-56-31"></a>│  ┌──────────┴──────────┐                                               │
<a id="__codelineno-56-32" name="__codelineno-56-32" href="#__codelineno-56-32"></a>│  │  5. Corrélation     │                                               │
<a id="__codelineno-56-33" name="__codelineno-56-33" href="#__codelineno-56-33"></a>│  │  6. Retourner       │                                               │
<a id="__codelineno-56-34" name="__codelineno-56-34" href="#__codelineno-56-34"></a>│  │     réponse         │                                               │
<a id="__codelineno-56-35" name="__codelineno-56-35" href="#__codelineno-56-35"></a>│  └─────────────────────┘                                               │
<a id="__codelineno-56-36" name="__codelineno-56-36" href="#__codelineno-56-36"></a>└─────────────────────────────────────────────────────────────────────────┘
</code></pre></div>
<p><strong>Implémentation Request-Reply</strong> :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-57-1" name="__codelineno-57-1" href="#__codelineno-57-1"></a><span class="nd">@Service</span>
<a id="__codelineno-57-2" name="__codelineno-57-2" href="#__codelineno-57-2"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">KafkaRequestReplyService</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-57-3" name="__codelineno-57-3" href="#__codelineno-57-3"></a>
<a id="__codelineno-57-4" name="__codelineno-57-4" href="#__codelineno-57-4"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">KafkaTemplate</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Request</span><span class="o">&gt;</span><span class="w"> </span><span class="n">requestTemplate</span><span class="p">;</span>
<a id="__codelineno-57-5" name="__codelineno-57-5" href="#__codelineno-57-5"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">CompletableFuture</span><span class="o">&lt;</span><span class="n">Response</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">pendingRequests</span><span class="p">;</span>
<a id="__codelineno-57-6" name="__codelineno-57-6" href="#__codelineno-57-6"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">replyTopic</span><span class="p">;</span>
<a id="__codelineno-57-7" name="__codelineno-57-7" href="#__codelineno-57-7"></a>
<a id="__codelineno-57-8" name="__codelineno-57-8" href="#__codelineno-57-8"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">KafkaRequestReplyService</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">instanceId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-57-9" name="__codelineno-57-9" href="#__codelineno-57-9"></a><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">pendingRequests</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ConcurrentHashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<a id="__codelineno-57-10" name="__codelineno-57-10" href="#__codelineno-57-10"></a><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">replyTopic</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;replies.&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">instanceId</span><span class="p">;</span>
<a id="__codelineno-57-11" name="__codelineno-57-11" href="#__codelineno-57-11"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-57-12" name="__codelineno-57-12" href="#__codelineno-57-12"></a>
<a id="__codelineno-57-13" name="__codelineno-57-13" href="#__codelineno-57-13"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">CompletableFuture</span><span class="o">&lt;</span><span class="n">Response</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">sendRequest</span><span class="p">(</span><span class="n">Request</span><span class="w"> </span><span class="n">request</span><span class="p">,</span><span class="w"> </span><span class="n">Duration</span><span class="w"> </span><span class="n">timeout</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-57-14" name="__codelineno-57-14" href="#__codelineno-57-14"></a><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">correlationId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UUID</span><span class="p">.</span><span class="na">randomUUID</span><span class="p">().</span><span class="na">toString</span><span class="p">();</span>
<a id="__codelineno-57-15" name="__codelineno-57-15" href="#__codelineno-57-15"></a>
<a id="__codelineno-57-16" name="__codelineno-57-16" href="#__codelineno-57-16"></a><span class="w">        </span><span class="c1">// Créer le future pour la réponse</span>
<a id="__codelineno-57-17" name="__codelineno-57-17" href="#__codelineno-57-17"></a><span class="w">        </span><span class="n">CompletableFuture</span><span class="o">&lt;</span><span class="n">Response</span><span class="o">&gt;</span><span class="w"> </span><span class="n">future</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">CompletableFuture</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<a id="__codelineno-57-18" name="__codelineno-57-18" href="#__codelineno-57-18"></a><span class="w">        </span><span class="n">pendingRequests</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">correlationId</span><span class="p">,</span><span class="w"> </span><span class="n">future</span><span class="p">);</span>
<a id="__codelineno-57-19" name="__codelineno-57-19" href="#__codelineno-57-19"></a>
<a id="__codelineno-57-20" name="__codelineno-57-20" href="#__codelineno-57-20"></a><span class="w">        </span><span class="c1">// Configurer le timeout</span>
<a id="__codelineno-57-21" name="__codelineno-57-21" href="#__codelineno-57-21"></a><span class="w">        </span><span class="n">future</span><span class="p">.</span><span class="na">orTimeout</span><span class="p">(</span><span class="n">timeout</span><span class="p">.</span><span class="na">toMillis</span><span class="p">(),</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">MILLISECONDS</span><span class="p">)</span>
<a id="__codelineno-57-22" name="__codelineno-57-22" href="#__codelineno-57-22"></a><span class="w">            </span><span class="p">.</span><span class="na">whenComplete</span><span class="p">((</span><span class="n">result</span><span class="p">,</span><span class="w"> </span><span class="n">error</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-57-23" name="__codelineno-57-23" href="#__codelineno-57-23"></a><span class="w">                </span><span class="n">pendingRequests</span><span class="p">.</span><span class="na">remove</span><span class="p">(</span><span class="n">correlationId</span><span class="p">);</span>
<a id="__codelineno-57-24" name="__codelineno-57-24" href="#__codelineno-57-24"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">error</span><span class="w"> </span><span class="k">instanceof</span><span class="w"> </span><span class="n">TimeoutException</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-57-25" name="__codelineno-57-25" href="#__codelineno-57-25"></a><span class="w">                    </span><span class="n">log</span><span class="p">.</span><span class="na">warn</span><span class="p">(</span><span class="s">&quot;Request {} timed out after {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">correlationId</span><span class="p">,</span><span class="w"> </span><span class="n">timeout</span><span class="p">);</span>
<a id="__codelineno-57-26" name="__codelineno-57-26" href="#__codelineno-57-26"></a><span class="w">                </span><span class="p">}</span>
<a id="__codelineno-57-27" name="__codelineno-57-27" href="#__codelineno-57-27"></a><span class="w">            </span><span class="p">});</span>
<a id="__codelineno-57-28" name="__codelineno-57-28" href="#__codelineno-57-28"></a>
<a id="__codelineno-57-29" name="__codelineno-57-29" href="#__codelineno-57-29"></a><span class="w">        </span><span class="c1">// Envoyer la requête avec les headers de corrélation</span>
<a id="__codelineno-57-30" name="__codelineno-57-30" href="#__codelineno-57-30"></a><span class="w">        </span><span class="n">ProducerRecord</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Request</span><span class="o">&gt;</span><span class="w"> </span><span class="n">record</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ProducerRecord</span><span class="o">&lt;&gt;</span><span class="p">(</span>
<a id="__codelineno-57-31" name="__codelineno-57-31" href="#__codelineno-57-31"></a><span class="w">            </span><span class="s">&quot;requests&quot;</span><span class="p">,</span>
<a id="__codelineno-57-32" name="__codelineno-57-32" href="#__codelineno-57-32"></a><span class="w">            </span><span class="n">request</span><span class="p">.</span><span class="na">getKey</span><span class="p">(),</span>
<a id="__codelineno-57-33" name="__codelineno-57-33" href="#__codelineno-57-33"></a><span class="w">            </span><span class="n">request</span>
<a id="__codelineno-57-34" name="__codelineno-57-34" href="#__codelineno-57-34"></a><span class="w">        </span><span class="p">);</span>
<a id="__codelineno-57-35" name="__codelineno-57-35" href="#__codelineno-57-35"></a><span class="w">        </span><span class="kd">record</span><span class="err">.</span><span class="nc">headers</span><span class="p">()</span>
<a id="__codelineno-57-36" name="__codelineno-57-36" href="#__codelineno-57-36"></a><span class="w">            </span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="s">&quot;correlation_id&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">correlationId</span><span class="p">.</span><span class="na">getBytes</span><span class="p">())</span>
<a id="__codelineno-57-37" name="__codelineno-57-37" href="#__codelineno-57-37"></a><span class="w">            </span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="s">&quot;reply_topic&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">replyTopic</span><span class="p">.</span><span class="na">getBytes</span><span class="p">());</span>
<a id="__codelineno-57-38" name="__codelineno-57-38" href="#__codelineno-57-38"></a>
<a id="__codelineno-57-39" name="__codelineno-57-39" href="#__codelineno-57-39"></a><span class="w">        </span><span class="n">requestTemplate</span><span class="p">.</span><span class="na">send</span><span class="p">(</span><span class="n">record</span><span class="p">);</span>
<a id="__codelineno-57-40" name="__codelineno-57-40" href="#__codelineno-57-40"></a>
<a id="__codelineno-57-41" name="__codelineno-57-41" href="#__codelineno-57-41"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">future</span><span class="p">;</span>
<a id="__codelineno-57-42" name="__codelineno-57-42" href="#__codelineno-57-42"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-57-43" name="__codelineno-57-43" href="#__codelineno-57-43"></a>
<a id="__codelineno-57-44" name="__codelineno-57-44" href="#__codelineno-57-44"></a><span class="w">    </span><span class="nd">@KafkaListener</span><span class="p">(</span><span class="n">topicPattern</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;replies\\..*&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">groupId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;${instance.id}&quot;</span><span class="p">)</span>
<a id="__codelineno-57-45" name="__codelineno-57-45" href="#__codelineno-57-45"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">handleReply</span><span class="p">(</span><span class="n">ConsumerRecord</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Response</span><span class="o">&gt;</span><span class="w"> </span><span class="n">record</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-57-46" name="__codelineno-57-46" href="#__codelineno-57-46"></a><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">correlationId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">String</span><span class="p">(</span>
<a id="__codelineno-57-47" name="__codelineno-57-47" href="#__codelineno-57-47"></a><span class="w">            </span><span class="kd">record</span><span class="err">.</span><span class="nc">headers</span><span class="p">().</span><span class="na">lastHeader</span><span class="p">(</span><span class="s">&quot;correlation_id&quot;</span><span class="p">).</span><span class="na">value</span><span class="p">());</span>
<a id="__codelineno-57-48" name="__codelineno-57-48" href="#__codelineno-57-48"></a>
<a id="__codelineno-57-49" name="__codelineno-57-49" href="#__codelineno-57-49"></a><span class="w">        </span><span class="n">CompletableFuture</span><span class="o">&lt;</span><span class="n">Response</span><span class="o">&gt;</span><span class="w"> </span><span class="n">future</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pendingRequests</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">correlationId</span><span class="p">);</span>
<a id="__codelineno-57-50" name="__codelineno-57-50" href="#__codelineno-57-50"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">future</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-57-51" name="__codelineno-57-51" href="#__codelineno-57-51"></a><span class="w">            </span><span class="n">future</span><span class="p">.</span><span class="na">complete</span><span class="p">(</span><span class="n">record</span><span class="p">.</span><span class="na">value</span><span class="p">());</span>
<a id="__codelineno-57-52" name="__codelineno-57-52" href="#__codelineno-57-52"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-57-53" name="__codelineno-57-53" href="#__codelineno-57-53"></a><span class="w">            </span><span class="n">log</span><span class="p">.</span><span class="na">warn</span><span class="p">(</span><span class="s">&quot;Received reply for unknown correlation_id: {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">correlationId</span><span class="p">);</span>
<a id="__codelineno-57-54" name="__codelineno-57-54" href="#__codelineno-57-54"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-57-55" name="__codelineno-57-55" href="#__codelineno-57-55"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-57-56" name="__codelineno-57-56" href="#__codelineno-57-56"></a><span class="p">}</span>
</code></pre></div>
<blockquote>
<p><strong>Décision architecturale</strong></p>
<p><em>Question</em> : Quand utiliser Request-Reply avec Kafka plutôt qu'un appel HTTP direct ?</p>
<p><em>Utiliser Request-Reply Kafka quand</em> :
- Le traitement peut prendre plusieurs secondes/minutes
- Le responder peut être down temporairement (découplage)
- Besoin de retry automatique et persistance
- Audit trail des requêtes/réponses requis</p>
<p><em>Utiliser HTTP quand</em> :
- Latence &lt; 100ms requise
- Communication point-à-point simple
- Pas besoin de persistance des requêtes</p>
</blockquote>
<p><strong>Pattern Saga Chorégraphiée</strong></p>
<p>Le pattern Saga gère les transactions distribuées à travers plusieurs services via une séquence d'événements. Chaque service publie un événement après avoir terminé sa partie, et les autres services réagissent à ces événements.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-58-1" name="__codelineno-58-1" href="#__codelineno-58-1"></a>┌─────────────────────────────────────────────────────────────────────────┐
<a id="__codelineno-58-2" name="__codelineno-58-2" href="#__codelineno-58-2"></a>│                    Saga Chorégraphiée : Commande                        │
<a id="__codelineno-58-3" name="__codelineno-58-3" href="#__codelineno-58-3"></a>│                                                                         │
<a id="__codelineno-58-4" name="__codelineno-58-4" href="#__codelineno-58-4"></a>│  ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐         │
<a id="__codelineno-58-5" name="__codelineno-58-5" href="#__codelineno-58-5"></a>│  │ Orders   │    │ Inventory│    │ Payment  │    │ Shipping │         │
<a id="__codelineno-58-6" name="__codelineno-58-6" href="#__codelineno-58-6"></a>│  └────┬─────┘    └────┬─────┘    └────┬─────┘    └────┬─────┘         │
<a id="__codelineno-58-7" name="__codelineno-58-7" href="#__codelineno-58-7"></a>│       │               │               │               │                │
<a id="__codelineno-58-8" name="__codelineno-58-8" href="#__codelineno-58-8"></a>│       │ OrderCreated  │               │               │                │
<a id="__codelineno-58-9" name="__codelineno-58-9" href="#__codelineno-58-9"></a>│       │──────────────▶│               │               │                │
<a id="__codelineno-58-10" name="__codelineno-58-10" href="#__codelineno-58-10"></a>│       │               │               │               │                │
<a id="__codelineno-58-11" name="__codelineno-58-11" href="#__codelineno-58-11"></a>│       │               │InventoryReserved              │                │
<a id="__codelineno-58-12" name="__codelineno-58-12" href="#__codelineno-58-12"></a>│       │               │──────────────▶│               │                │
<a id="__codelineno-58-13" name="__codelineno-58-13" href="#__codelineno-58-13"></a>│       │               │               │               │                │
<a id="__codelineno-58-14" name="__codelineno-58-14" href="#__codelineno-58-14"></a>│       │               │               │ PaymentProcessed               │
<a id="__codelineno-58-15" name="__codelineno-58-15" href="#__codelineno-58-15"></a>│       │               │               │──────────────▶│                │
<a id="__codelineno-58-16" name="__codelineno-58-16" href="#__codelineno-58-16"></a>│       │               │               │               │                │
<a id="__codelineno-58-17" name="__codelineno-58-17" href="#__codelineno-58-17"></a>│       │               │               │               │ ShipmentCreated│
<a id="__codelineno-58-18" name="__codelineno-58-18" href="#__codelineno-58-18"></a>│       │◀──────────────┼───────────────┼───────────────│                │
<a id="__codelineno-58-19" name="__codelineno-58-19" href="#__codelineno-58-19"></a>│       │               │               │               │                │
<a id="__codelineno-58-20" name="__codelineno-58-20" href="#__codelineno-58-20"></a>│       │ OrderCompleted│               │               │                │
<a id="__codelineno-58-21" name="__codelineno-58-21" href="#__codelineno-58-21"></a>│       │──────────────▶│──────────────▶│──────────────▶│                │
<a id="__codelineno-58-22" name="__codelineno-58-22" href="#__codelineno-58-22"></a>│                                                                         │
<a id="__codelineno-58-23" name="__codelineno-58-23" href="#__codelineno-58-23"></a>│  Compensation (en cas d&#39;échec Payment):                                │
<a id="__codelineno-58-24" name="__codelineno-58-24" href="#__codelineno-58-24"></a>│       │               │PaymentFailed  │               │                │
<a id="__codelineno-58-25" name="__codelineno-58-25" href="#__codelineno-58-25"></a>│       │               │◀──────────────│               │                │
<a id="__codelineno-58-26" name="__codelineno-58-26" href="#__codelineno-58-26"></a>│       │               │InventoryReleased              │                │
<a id="__codelineno-58-27" name="__codelineno-58-27" href="#__codelineno-58-27"></a>│       │◀──────────────│               │               │                │
<a id="__codelineno-58-28" name="__codelineno-58-28" href="#__codelineno-58-28"></a>│       │ OrderCancelled│               │               │                │
<a id="__codelineno-58-29" name="__codelineno-58-29" href="#__codelineno-58-29"></a>└─────────────────────────────────────────────────────────────────────────┘
</code></pre></div>
<p><strong>Implémentation de la Saga (Service Orders)</strong> :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-59-1" name="__codelineno-59-1" href="#__codelineno-59-1"></a><span class="nd">@Service</span>
<a id="__codelineno-59-2" name="__codelineno-59-2" href="#__codelineno-59-2"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">OrderSagaParticipant</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-59-3" name="__codelineno-59-3" href="#__codelineno-59-3"></a>
<a id="__codelineno-59-4" name="__codelineno-59-4" href="#__codelineno-59-4"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">OrderRepository</span><span class="w"> </span><span class="n">orderRepository</span><span class="p">;</span>
<a id="__codelineno-59-5" name="__codelineno-59-5" href="#__codelineno-59-5"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">KafkaTemplate</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">kafkaTemplate</span><span class="p">;</span>
<a id="__codelineno-59-6" name="__codelineno-59-6" href="#__codelineno-59-6"></a>
<a id="__codelineno-59-7" name="__codelineno-59-7" href="#__codelineno-59-7"></a><span class="w">    </span><span class="nd">@KafkaListener</span><span class="p">(</span><span class="n">topics</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;inventory.events&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">groupId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;orders-saga&quot;</span><span class="p">)</span>
<a id="__codelineno-59-8" name="__codelineno-59-8" href="#__codelineno-59-8"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">onInventoryEvent</span><span class="p">(</span><span class="n">InventoryEvent</span><span class="w"> </span><span class="n">event</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-59-9" name="__codelineno-59-9" href="#__codelineno-59-9"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">event</span><span class="w"> </span><span class="k">instanceof</span><span class="w"> </span><span class="n">InventoryReservedEvent</span><span class="w"> </span><span class="n">reserved</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-59-10" name="__codelineno-59-10" href="#__codelineno-59-10"></a><span class="w">            </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;Inventory reserved for order {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">reserved</span><span class="p">.</span><span class="na">getOrderId</span><span class="p">());</span>
<a id="__codelineno-59-11" name="__codelineno-59-11" href="#__codelineno-59-11"></a><span class="w">            </span><span class="n">orderRepository</span><span class="p">.</span><span class="na">updateStatus</span><span class="p">(</span><span class="n">reserved</span><span class="p">.</span><span class="na">getOrderId</span><span class="p">(),</span><span class="w"> </span>
<a id="__codelineno-59-12" name="__codelineno-59-12" href="#__codelineno-59-12"></a><span class="w">                </span><span class="n">OrderStatus</span><span class="p">.</span><span class="na">INVENTORY_RESERVED</span><span class="p">);</span>
<a id="__codelineno-59-13" name="__codelineno-59-13" href="#__codelineno-59-13"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">event</span><span class="w"> </span><span class="k">instanceof</span><span class="w"> </span><span class="n">InventoryReservationFailedEvent</span><span class="w"> </span><span class="n">failed</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-59-14" name="__codelineno-59-14" href="#__codelineno-59-14"></a><span class="w">            </span><span class="n">log</span><span class="p">.</span><span class="na">warn</span><span class="p">(</span><span class="s">&quot;Inventory reservation failed for order {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">failed</span><span class="p">.</span><span class="na">getOrderId</span><span class="p">());</span>
<a id="__codelineno-59-15" name="__codelineno-59-15" href="#__codelineno-59-15"></a><span class="w">            </span><span class="n">cancelOrder</span><span class="p">(</span><span class="n">failed</span><span class="p">.</span><span class="na">getOrderId</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;Insufficient inventory&quot;</span><span class="p">);</span>
<a id="__codelineno-59-16" name="__codelineno-59-16" href="#__codelineno-59-16"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-59-17" name="__codelineno-59-17" href="#__codelineno-59-17"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-59-18" name="__codelineno-59-18" href="#__codelineno-59-18"></a>
<a id="__codelineno-59-19" name="__codelineno-59-19" href="#__codelineno-59-19"></a><span class="w">    </span><span class="nd">@KafkaListener</span><span class="p">(</span><span class="n">topics</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;payment.events&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">groupId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;orders-saga&quot;</span><span class="p">)</span>
<a id="__codelineno-59-20" name="__codelineno-59-20" href="#__codelineno-59-20"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">onPaymentEvent</span><span class="p">(</span><span class="n">PaymentEvent</span><span class="w"> </span><span class="n">event</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-59-21" name="__codelineno-59-21" href="#__codelineno-59-21"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">event</span><span class="w"> </span><span class="k">instanceof</span><span class="w"> </span><span class="n">PaymentProcessedEvent</span><span class="w"> </span><span class="n">processed</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-59-22" name="__codelineno-59-22" href="#__codelineno-59-22"></a><span class="w">            </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;Payment processed for order {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">processed</span><span class="p">.</span><span class="na">getOrderId</span><span class="p">());</span>
<a id="__codelineno-59-23" name="__codelineno-59-23" href="#__codelineno-59-23"></a><span class="w">            </span><span class="n">orderRepository</span><span class="p">.</span><span class="na">updateStatus</span><span class="p">(</span><span class="n">processed</span><span class="p">.</span><span class="na">getOrderId</span><span class="p">(),</span><span class="w"> </span><span class="n">OrderStatus</span><span class="p">.</span><span class="na">PAID</span><span class="p">);</span>
<a id="__codelineno-59-24" name="__codelineno-59-24" href="#__codelineno-59-24"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">event</span><span class="w"> </span><span class="k">instanceof</span><span class="w"> </span><span class="n">PaymentFailedEvent</span><span class="w"> </span><span class="n">failed</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-59-25" name="__codelineno-59-25" href="#__codelineno-59-25"></a><span class="w">            </span><span class="n">log</span><span class="p">.</span><span class="na">warn</span><span class="p">(</span><span class="s">&quot;Payment failed for order {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">failed</span><span class="p">.</span><span class="na">getOrderId</span><span class="p">());</span>
<a id="__codelineno-59-26" name="__codelineno-59-26" href="#__codelineno-59-26"></a><span class="w">            </span><span class="n">compensateOrder</span><span class="p">(</span><span class="n">failed</span><span class="p">.</span><span class="na">getOrderId</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;Payment failed: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">failed</span><span class="p">.</span><span class="na">getReason</span><span class="p">());</span>
<a id="__codelineno-59-27" name="__codelineno-59-27" href="#__codelineno-59-27"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-59-28" name="__codelineno-59-28" href="#__codelineno-59-28"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-59-29" name="__codelineno-59-29" href="#__codelineno-59-29"></a>
<a id="__codelineno-59-30" name="__codelineno-59-30" href="#__codelineno-59-30"></a><span class="w">    </span><span class="nd">@KafkaListener</span><span class="p">(</span><span class="n">topics</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;shipping.events&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">groupId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;orders-saga&quot;</span><span class="p">)</span>
<a id="__codelineno-59-31" name="__codelineno-59-31" href="#__codelineno-59-31"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">onShippingEvent</span><span class="p">(</span><span class="n">ShippingEvent</span><span class="w"> </span><span class="n">event</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-59-32" name="__codelineno-59-32" href="#__codelineno-59-32"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">event</span><span class="w"> </span><span class="k">instanceof</span><span class="w"> </span><span class="n">ShipmentCreatedEvent</span><span class="w"> </span><span class="n">shipped</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-59-33" name="__codelineno-59-33" href="#__codelineno-59-33"></a><span class="w">            </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;Shipment created for order {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">shipped</span><span class="p">.</span><span class="na">getOrderId</span><span class="p">());</span>
<a id="__codelineno-59-34" name="__codelineno-59-34" href="#__codelineno-59-34"></a><span class="w">            </span><span class="n">completeOrder</span><span class="p">(</span><span class="n">shipped</span><span class="p">.</span><span class="na">getOrderId</span><span class="p">());</span>
<a id="__codelineno-59-35" name="__codelineno-59-35" href="#__codelineno-59-35"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-59-36" name="__codelineno-59-36" href="#__codelineno-59-36"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-59-37" name="__codelineno-59-37" href="#__codelineno-59-37"></a>
<a id="__codelineno-59-38" name="__codelineno-59-38" href="#__codelineno-59-38"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">compensateOrder</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">orderId</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">reason</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-59-39" name="__codelineno-59-39" href="#__codelineno-59-39"></a><span class="w">        </span><span class="n">Order</span><span class="w"> </span><span class="n">order</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">orderRepository</span><span class="p">.</span><span class="na">findById</span><span class="p">(</span><span class="n">orderId</span><span class="p">).</span><span class="na">orElseThrow</span><span class="p">();</span>
<a id="__codelineno-59-40" name="__codelineno-59-40" href="#__codelineno-59-40"></a>
<a id="__codelineno-59-41" name="__codelineno-59-41" href="#__codelineno-59-41"></a><span class="w">        </span><span class="c1">// Publier l&#39;événement de compensation</span>
<a id="__codelineno-59-42" name="__codelineno-59-42" href="#__codelineno-59-42"></a><span class="w">        </span><span class="n">OrderCancelledEvent</span><span class="w"> </span><span class="n">cancelEvent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OrderCancelledEvent</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span>
<a id="__codelineno-59-43" name="__codelineno-59-43" href="#__codelineno-59-43"></a><span class="w">            </span><span class="p">.</span><span class="na">orderId</span><span class="p">(</span><span class="n">orderId</span><span class="p">)</span>
<a id="__codelineno-59-44" name="__codelineno-59-44" href="#__codelineno-59-44"></a><span class="w">            </span><span class="p">.</span><span class="na">reason</span><span class="p">(</span><span class="n">reason</span><span class="p">)</span>
<a id="__codelineno-59-45" name="__codelineno-59-45" href="#__codelineno-59-45"></a><span class="w">            </span><span class="p">.</span><span class="na">cancelledAt</span><span class="p">(</span><span class="n">Instant</span><span class="p">.</span><span class="na">now</span><span class="p">())</span>
<a id="__codelineno-59-46" name="__codelineno-59-46" href="#__codelineno-59-46"></a><span class="w">            </span><span class="p">.</span><span class="na">build</span><span class="p">();</span>
<a id="__codelineno-59-47" name="__codelineno-59-47" href="#__codelineno-59-47"></a>
<a id="__codelineno-59-48" name="__codelineno-59-48" href="#__codelineno-59-48"></a><span class="w">        </span><span class="n">kafkaTemplate</span><span class="p">.</span><span class="na">send</span><span class="p">(</span><span class="s">&quot;orders.events&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">orderId</span><span class="p">,</span><span class="w"> </span><span class="n">cancelEvent</span><span class="p">);</span>
<a id="__codelineno-59-49" name="__codelineno-59-49" href="#__codelineno-59-49"></a><span class="w">        </span><span class="n">orderRepository</span><span class="p">.</span><span class="na">updateStatus</span><span class="p">(</span><span class="n">orderId</span><span class="p">,</span><span class="w"> </span><span class="n">OrderStatus</span><span class="p">.</span><span class="na">CANCELLED</span><span class="p">);</span>
<a id="__codelineno-59-50" name="__codelineno-59-50" href="#__codelineno-59-50"></a>
<a id="__codelineno-59-51" name="__codelineno-59-51" href="#__codelineno-59-51"></a><span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;Order {} cancelled due to: {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">orderId</span><span class="p">,</span><span class="w"> </span><span class="n">reason</span><span class="p">);</span>
<a id="__codelineno-59-52" name="__codelineno-59-52" href="#__codelineno-59-52"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-59-53" name="__codelineno-59-53" href="#__codelineno-59-53"></a><span class="p">}</span>
</code></pre></div>
<p><strong>Implémentation de la Saga (Service Inventory)</strong> :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-60-1" name="__codelineno-60-1" href="#__codelineno-60-1"></a><span class="nd">@Service</span>
<a id="__codelineno-60-2" name="__codelineno-60-2" href="#__codelineno-60-2"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">InventorySagaParticipant</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-60-3" name="__codelineno-60-3" href="#__codelineno-60-3"></a>
<a id="__codelineno-60-4" name="__codelineno-60-4" href="#__codelineno-60-4"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">InventoryRepository</span><span class="w"> </span><span class="n">inventoryRepository</span><span class="p">;</span>
<a id="__codelineno-60-5" name="__codelineno-60-5" href="#__codelineno-60-5"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">ReservationRepository</span><span class="w"> </span><span class="n">reservationRepository</span><span class="p">;</span>
<a id="__codelineno-60-6" name="__codelineno-60-6" href="#__codelineno-60-6"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">KafkaTemplate</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">kafkaTemplate</span><span class="p">;</span>
<a id="__codelineno-60-7" name="__codelineno-60-7" href="#__codelineno-60-7"></a>
<a id="__codelineno-60-8" name="__codelineno-60-8" href="#__codelineno-60-8"></a><span class="w">    </span><span class="nd">@KafkaListener</span><span class="p">(</span><span class="n">topics</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;orders.events&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">groupId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;inventory-saga&quot;</span><span class="p">)</span>
<a id="__codelineno-60-9" name="__codelineno-60-9" href="#__codelineno-60-9"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">onOrderEvent</span><span class="p">(</span><span class="n">OrderEvent</span><span class="w"> </span><span class="n">event</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-60-10" name="__codelineno-60-10" href="#__codelineno-60-10"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">event</span><span class="w"> </span><span class="k">instanceof</span><span class="w"> </span><span class="n">OrderCreatedEvent</span><span class="w"> </span><span class="n">created</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-60-11" name="__codelineno-60-11" href="#__codelineno-60-11"></a><span class="w">            </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-60-12" name="__codelineno-60-12" href="#__codelineno-60-12"></a><span class="w">                </span><span class="n">reserveInventory</span><span class="p">(</span><span class="n">created</span><span class="p">);</span>
<a id="__codelineno-60-13" name="__codelineno-60-13" href="#__codelineno-60-13"></a><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">InsufficientInventoryException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-60-14" name="__codelineno-60-14" href="#__codelineno-60-14"></a><span class="w">                </span><span class="n">publishReservationFailed</span><span class="p">(</span><span class="n">created</span><span class="p">.</span><span class="na">getOrderId</span><span class="p">(),</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="na">getMessage</span><span class="p">());</span>
<a id="__codelineno-60-15" name="__codelineno-60-15" href="#__codelineno-60-15"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-60-16" name="__codelineno-60-16" href="#__codelineno-60-16"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">event</span><span class="w"> </span><span class="k">instanceof</span><span class="w"> </span><span class="n">OrderCancelledEvent</span><span class="w"> </span><span class="n">cancelled</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-60-17" name="__codelineno-60-17" href="#__codelineno-60-17"></a><span class="w">            </span><span class="c1">// Compensation : libérer l&#39;inventaire réservé</span>
<a id="__codelineno-60-18" name="__codelineno-60-18" href="#__codelineno-60-18"></a><span class="w">            </span><span class="n">releaseInventory</span><span class="p">(</span><span class="n">cancelled</span><span class="p">.</span><span class="na">getOrderId</span><span class="p">());</span>
<a id="__codelineno-60-19" name="__codelineno-60-19" href="#__codelineno-60-19"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-60-20" name="__codelineno-60-20" href="#__codelineno-60-20"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-60-21" name="__codelineno-60-21" href="#__codelineno-60-21"></a>
<a id="__codelineno-60-22" name="__codelineno-60-22" href="#__codelineno-60-22"></a><span class="w">    </span><span class="nd">@Transactional</span>
<a id="__codelineno-60-23" name="__codelineno-60-23" href="#__codelineno-60-23"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">reserveInventory</span><span class="p">(</span><span class="n">OrderCreatedEvent</span><span class="w"> </span><span class="n">event</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-60-24" name="__codelineno-60-24" href="#__codelineno-60-24"></a><span class="w">        </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Reservation</span><span class="o">&gt;</span><span class="w"> </span><span class="n">reservations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<a id="__codelineno-60-25" name="__codelineno-60-25" href="#__codelineno-60-25"></a>
<a id="__codelineno-60-26" name="__codelineno-60-26" href="#__codelineno-60-26"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">OrderItem</span><span class="w"> </span><span class="n">item</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">event</span><span class="p">.</span><span class="na">getItems</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-60-27" name="__codelineno-60-27" href="#__codelineno-60-27"></a><span class="w">            </span><span class="n">Inventory</span><span class="w"> </span><span class="n">inventory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inventoryRepository</span>
<a id="__codelineno-60-28" name="__codelineno-60-28" href="#__codelineno-60-28"></a><span class="w">                </span><span class="p">.</span><span class="na">findByProductIdWithLock</span><span class="p">(</span><span class="n">item</span><span class="p">.</span><span class="na">getProductId</span><span class="p">())</span>
<a id="__codelineno-60-29" name="__codelineno-60-29" href="#__codelineno-60-29"></a><span class="w">                </span><span class="p">.</span><span class="na">orElseThrow</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ProductNotFoundException</span><span class="p">(</span><span class="n">item</span><span class="p">.</span><span class="na">getProductId</span><span class="p">()));</span>
<a id="__codelineno-60-30" name="__codelineno-60-30" href="#__codelineno-60-30"></a>
<a id="__codelineno-60-31" name="__codelineno-60-31" href="#__codelineno-60-31"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">inventory</span><span class="p">.</span><span class="na">getAvailable</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">item</span><span class="p">.</span><span class="na">getQuantity</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-60-32" name="__codelineno-60-32" href="#__codelineno-60-32"></a><span class="w">                </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">InsufficientInventoryException</span><span class="p">(</span>
<a id="__codelineno-60-33" name="__codelineno-60-33" href="#__codelineno-60-33"></a><span class="w">                    </span><span class="s">&quot;Product &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">item</span><span class="p">.</span><span class="na">getProductId</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;: requested &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span>
<a id="__codelineno-60-34" name="__codelineno-60-34" href="#__codelineno-60-34"></a><span class="w">                    </span><span class="n">item</span><span class="p">.</span><span class="na">getQuantity</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;, available &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">inventory</span><span class="p">.</span><span class="na">getAvailable</span><span class="p">());</span>
<a id="__codelineno-60-35" name="__codelineno-60-35" href="#__codelineno-60-35"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-60-36" name="__codelineno-60-36" href="#__codelineno-60-36"></a>
<a id="__codelineno-60-37" name="__codelineno-60-37" href="#__codelineno-60-37"></a><span class="w">            </span><span class="n">inventory</span><span class="p">.</span><span class="na">reserve</span><span class="p">(</span><span class="n">item</span><span class="p">.</span><span class="na">getQuantity</span><span class="p">());</span>
<a id="__codelineno-60-38" name="__codelineno-60-38" href="#__codelineno-60-38"></a><span class="w">            </span><span class="n">inventoryRepository</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">inventory</span><span class="p">);</span>
<a id="__codelineno-60-39" name="__codelineno-60-39" href="#__codelineno-60-39"></a>
<a id="__codelineno-60-40" name="__codelineno-60-40" href="#__codelineno-60-40"></a><span class="w">            </span><span class="n">reservations</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">Reservation</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span>
<a id="__codelineno-60-41" name="__codelineno-60-41" href="#__codelineno-60-41"></a><span class="w">                </span><span class="p">.</span><span class="na">orderId</span><span class="p">(</span><span class="n">event</span><span class="p">.</span><span class="na">getOrderId</span><span class="p">())</span>
<a id="__codelineno-60-42" name="__codelineno-60-42" href="#__codelineno-60-42"></a><span class="w">                </span><span class="p">.</span><span class="na">productId</span><span class="p">(</span><span class="n">item</span><span class="p">.</span><span class="na">getProductId</span><span class="p">())</span>
<a id="__codelineno-60-43" name="__codelineno-60-43" href="#__codelineno-60-43"></a><span class="w">                </span><span class="p">.</span><span class="na">quantity</span><span class="p">(</span><span class="n">item</span><span class="p">.</span><span class="na">getQuantity</span><span class="p">())</span>
<a id="__codelineno-60-44" name="__codelineno-60-44" href="#__codelineno-60-44"></a><span class="w">                </span><span class="p">.</span><span class="na">reservedAt</span><span class="p">(</span><span class="n">Instant</span><span class="p">.</span><span class="na">now</span><span class="p">())</span>
<a id="__codelineno-60-45" name="__codelineno-60-45" href="#__codelineno-60-45"></a><span class="w">                </span><span class="p">.</span><span class="na">build</span><span class="p">());</span>
<a id="__codelineno-60-46" name="__codelineno-60-46" href="#__codelineno-60-46"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-60-47" name="__codelineno-60-47" href="#__codelineno-60-47"></a>
<a id="__codelineno-60-48" name="__codelineno-60-48" href="#__codelineno-60-48"></a><span class="w">        </span><span class="n">reservationRepository</span><span class="p">.</span><span class="na">saveAll</span><span class="p">(</span><span class="n">reservations</span><span class="p">);</span>
<a id="__codelineno-60-49" name="__codelineno-60-49" href="#__codelineno-60-49"></a>
<a id="__codelineno-60-50" name="__codelineno-60-50" href="#__codelineno-60-50"></a><span class="w">        </span><span class="c1">// Publier le succès</span>
<a id="__codelineno-60-51" name="__codelineno-60-51" href="#__codelineno-60-51"></a><span class="w">        </span><span class="n">kafkaTemplate</span><span class="p">.</span><span class="na">send</span><span class="p">(</span><span class="s">&quot;inventory.events&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">event</span><span class="p">.</span><span class="na">getOrderId</span><span class="p">(),</span>
<a id="__codelineno-60-52" name="__codelineno-60-52" href="#__codelineno-60-52"></a><span class="w">            </span><span class="n">InventoryReservedEvent</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span>
<a id="__codelineno-60-53" name="__codelineno-60-53" href="#__codelineno-60-53"></a><span class="w">                </span><span class="p">.</span><span class="na">orderId</span><span class="p">(</span><span class="n">event</span><span class="p">.</span><span class="na">getOrderId</span><span class="p">())</span>
<a id="__codelineno-60-54" name="__codelineno-60-54" href="#__codelineno-60-54"></a><span class="w">                </span><span class="p">.</span><span class="na">items</span><span class="p">(</span><span class="n">event</span><span class="p">.</span><span class="na">getItems</span><span class="p">())</span>
<a id="__codelineno-60-55" name="__codelineno-60-55" href="#__codelineno-60-55"></a><span class="w">                </span><span class="p">.</span><span class="na">reservedAt</span><span class="p">(</span><span class="n">Instant</span><span class="p">.</span><span class="na">now</span><span class="p">())</span>
<a id="__codelineno-60-56" name="__codelineno-60-56" href="#__codelineno-60-56"></a><span class="w">                </span><span class="p">.</span><span class="na">build</span><span class="p">());</span>
<a id="__codelineno-60-57" name="__codelineno-60-57" href="#__codelineno-60-57"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-60-58" name="__codelineno-60-58" href="#__codelineno-60-58"></a>
<a id="__codelineno-60-59" name="__codelineno-60-59" href="#__codelineno-60-59"></a><span class="w">    </span><span class="nd">@Transactional</span>
<a id="__codelineno-60-60" name="__codelineno-60-60" href="#__codelineno-60-60"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">releaseInventory</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">orderId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-60-61" name="__codelineno-60-61" href="#__codelineno-60-61"></a><span class="w">        </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Reservation</span><span class="o">&gt;</span><span class="w"> </span><span class="n">reservations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">reservationRepository</span><span class="p">.</span><span class="na">findByOrderId</span><span class="p">(</span><span class="n">orderId</span><span class="p">);</span>
<a id="__codelineno-60-62" name="__codelineno-60-62" href="#__codelineno-60-62"></a>
<a id="__codelineno-60-63" name="__codelineno-60-63" href="#__codelineno-60-63"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">reservations</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-60-64" name="__codelineno-60-64" href="#__codelineno-60-64"></a><span class="w">            </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;No reservations found for order {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">orderId</span><span class="p">);</span>
<a id="__codelineno-60-65" name="__codelineno-60-65" href="#__codelineno-60-65"></a><span class="w">            </span><span class="k">return</span><span class="p">;</span>
<a id="__codelineno-60-66" name="__codelineno-60-66" href="#__codelineno-60-66"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-60-67" name="__codelineno-60-67" href="#__codelineno-60-67"></a>
<a id="__codelineno-60-68" name="__codelineno-60-68" href="#__codelineno-60-68"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">Reservation</span><span class="w"> </span><span class="n">reservation</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">reservations</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-60-69" name="__codelineno-60-69" href="#__codelineno-60-69"></a><span class="w">            </span><span class="n">Inventory</span><span class="w"> </span><span class="n">inventory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inventoryRepository</span>
<a id="__codelineno-60-70" name="__codelineno-60-70" href="#__codelineno-60-70"></a><span class="w">                </span><span class="p">.</span><span class="na">findByProductId</span><span class="p">(</span><span class="n">reservation</span><span class="p">.</span><span class="na">getProductId</span><span class="p">())</span>
<a id="__codelineno-60-71" name="__codelineno-60-71" href="#__codelineno-60-71"></a><span class="w">                </span><span class="p">.</span><span class="na">orElseThrow</span><span class="p">();</span>
<a id="__codelineno-60-72" name="__codelineno-60-72" href="#__codelineno-60-72"></a>
<a id="__codelineno-60-73" name="__codelineno-60-73" href="#__codelineno-60-73"></a><span class="w">            </span><span class="n">inventory</span><span class="p">.</span><span class="na">release</span><span class="p">(</span><span class="n">reservation</span><span class="p">.</span><span class="na">getQuantity</span><span class="p">());</span>
<a id="__codelineno-60-74" name="__codelineno-60-74" href="#__codelineno-60-74"></a><span class="w">            </span><span class="n">inventoryRepository</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">inventory</span><span class="p">);</span>
<a id="__codelineno-60-75" name="__codelineno-60-75" href="#__codelineno-60-75"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-60-76" name="__codelineno-60-76" href="#__codelineno-60-76"></a>
<a id="__codelineno-60-77" name="__codelineno-60-77" href="#__codelineno-60-77"></a><span class="w">        </span><span class="n">reservationRepository</span><span class="p">.</span><span class="na">deleteAll</span><span class="p">(</span><span class="n">reservations</span><span class="p">);</span>
<a id="__codelineno-60-78" name="__codelineno-60-78" href="#__codelineno-60-78"></a>
<a id="__codelineno-60-79" name="__codelineno-60-79" href="#__codelineno-60-79"></a><span class="w">        </span><span class="n">kafkaTemplate</span><span class="p">.</span><span class="na">send</span><span class="p">(</span><span class="s">&quot;inventory.events&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">orderId</span><span class="p">,</span>
<a id="__codelineno-60-80" name="__codelineno-60-80" href="#__codelineno-60-80"></a><span class="w">            </span><span class="n">InventoryReleasedEvent</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span>
<a id="__codelineno-60-81" name="__codelineno-60-81" href="#__codelineno-60-81"></a><span class="w">                </span><span class="p">.</span><span class="na">orderId</span><span class="p">(</span><span class="n">orderId</span><span class="p">)</span>
<a id="__codelineno-60-82" name="__codelineno-60-82" href="#__codelineno-60-82"></a><span class="w">                </span><span class="p">.</span><span class="na">releasedAt</span><span class="p">(</span><span class="n">Instant</span><span class="p">.</span><span class="na">now</span><span class="p">())</span>
<a id="__codelineno-60-83" name="__codelineno-60-83" href="#__codelineno-60-83"></a><span class="w">                </span><span class="p">.</span><span class="na">build</span><span class="p">());</span>
<a id="__codelineno-60-84" name="__codelineno-60-84" href="#__codelineno-60-84"></a>
<a id="__codelineno-60-85" name="__codelineno-60-85" href="#__codelineno-60-85"></a><span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;Released inventory for order {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">orderId</span><span class="p">);</span>
<a id="__codelineno-60-86" name="__codelineno-60-86" href="#__codelineno-60-86"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-60-87" name="__codelineno-60-87" href="#__codelineno-60-87"></a><span class="p">}</span>
</code></pre></div>
<h3 id="patterns-de-partitionnement-et-ordering">Patterns de Partitionnement et Ordering<a class="headerlink" href="#patterns-de-partitionnement-et-ordering" title="Permanent link">&para;</a></h3>
<p>Le partitionnement est crucial pour la scalabilité et l'ordre des messages. Le choix de la clé de partitionnement impacte directement les garanties d'ordering et la distribution de charge.</p>
<p><strong>Stratégies de Partitionnement</strong> :</p>
<table>
<thead>
<tr>
<th>Stratégie</th>
<th>Clé de partition</th>
<th>Garantie d'ordre</th>
<th>Distribution</th>
<th>Cas d'usage</th>
</tr>
</thead>
<tbody>
<tr>
<td>Par entité</td>
<td>entity_id</td>
<td>Ordre par entité</td>
<td>Bonne si entités équilibrées</td>
<td>Commandes, utilisateurs</td>
</tr>
<tr>
<td>Par tenant</td>
<td>tenant_id</td>
<td>Ordre par tenant</td>
<td>Risque de hot partition</td>
<td>SaaS multi-tenant</td>
</tr>
<tr>
<td>Par région</td>
<td>region_code</td>
<td>Ordre par région</td>
<td>Limitée (peu de régions)</td>
<td>Données géographiques</td>
</tr>
<tr>
<td>Round-robin</td>
<td>null</td>
<td>Aucune</td>
<td>Optimale</td>
<td>Logs, métriques</td>
</tr>
<tr>
<td>Par temps</td>
<td>timestamp bucket</td>
<td>Temporel approximatif</td>
<td>Bonne</td>
<td>Time-series</td>
</tr>
<tr>
<td>Composite</td>
<td>tenant:entity</td>
<td>Ordre par entité dans tenant</td>
<td>Excellente</td>
<td>Multi-tenant avec entités</td>
</tr>
</tbody>
</table>
<p><strong>Implémentation du partitionnement custom</strong> :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-61-1" name="__codelineno-61-1" href="#__codelineno-61-1"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">TenantAwarePartitioner</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">Partitioner</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-61-2" name="__codelineno-61-2" href="#__codelineno-61-2"></a>
<a id="__codelineno-61-3" name="__codelineno-61-3" href="#__codelineno-61-3"></a><span class="w">    </span><span class="nd">@Override</span>
<a id="__codelineno-61-4" name="__codelineno-61-4" href="#__codelineno-61-4"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">partition</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">topic</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">keyBytes</span><span class="p">,</span>
<a id="__codelineno-61-5" name="__codelineno-61-5" href="#__codelineno-61-5"></a><span class="w">                        </span><span class="n">Object</span><span class="w"> </span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">valueBytes</span><span class="p">,</span><span class="w"> </span><span class="n">Cluster</span><span class="w"> </span><span class="n">cluster</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-61-6" name="__codelineno-61-6" href="#__codelineno-61-6"></a>
<a id="__codelineno-61-7" name="__codelineno-61-7" href="#__codelineno-61-7"></a><span class="w">        </span><span class="n">List</span><span class="o">&lt;</span><span class="n">PartitionInfo</span><span class="o">&gt;</span><span class="w"> </span><span class="n">partitions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cluster</span><span class="p">.</span><span class="na">partitionsForTopic</span><span class="p">(</span><span class="n">topic</span><span class="p">);</span>
<a id="__codelineno-61-8" name="__codelineno-61-8" href="#__codelineno-61-8"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">numPartitions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">partitions</span><span class="p">.</span><span class="na">size</span><span class="p">();</span>
<a id="__codelineno-61-9" name="__codelineno-61-9" href="#__codelineno-61-9"></a>
<a id="__codelineno-61-10" name="__codelineno-61-10" href="#__codelineno-61-10"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">key</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-61-11" name="__codelineno-61-11" href="#__codelineno-61-11"></a><span class="w">            </span><span class="c1">// Round-robin pour les messages sans clé</span>
<a id="__codelineno-61-12" name="__codelineno-61-12" href="#__codelineno-61-12"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">ThreadLocalRandom</span><span class="p">.</span><span class="na">current</span><span class="p">().</span><span class="na">nextInt</span><span class="p">(</span><span class="n">numPartitions</span><span class="p">);</span>
<a id="__codelineno-61-13" name="__codelineno-61-13" href="#__codelineno-61-13"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-61-14" name="__codelineno-61-14" href="#__codelineno-61-14"></a>
<a id="__codelineno-61-15" name="__codelineno-61-15" href="#__codelineno-61-15"></a><span class="w">        </span><span class="c1">// Extraire le tenant_id de la clé composite &quot;tenant_id:entity_id&quot;</span>
<a id="__codelineno-61-16" name="__codelineno-61-16" href="#__codelineno-61-16"></a><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">keyStr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">String</span><span class="p">)</span><span class="w"> </span><span class="n">key</span><span class="p">;</span>
<a id="__codelineno-61-17" name="__codelineno-61-17" href="#__codelineno-61-17"></a><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">tenantId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">extractTenantId</span><span class="p">(</span><span class="n">keyStr</span><span class="p">);</span>
<a id="__codelineno-61-18" name="__codelineno-61-18" href="#__codelineno-61-18"></a>
<a id="__codelineno-61-19" name="__codelineno-61-19" href="#__codelineno-61-19"></a><span class="w">        </span><span class="c1">// Hash cohérent sur le tenant_id</span>
<a id="__codelineno-61-20" name="__codelineno-61-20" href="#__codelineno-61-20"></a><span class="w">        </span><span class="c1">// Tous les messages du même tenant vont dans la même partition</span>
<a id="__codelineno-61-21" name="__codelineno-61-21" href="#__codelineno-61-21"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">hash</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Math</span><span class="p">.</span><span class="na">abs</span><span class="p">(</span><span class="n">murmur2</span><span class="p">(</span><span class="n">tenantId</span><span class="p">.</span><span class="na">getBytes</span><span class="p">(</span><span class="n">StandardCharsets</span><span class="p">.</span><span class="na">UTF_8</span><span class="p">)));</span>
<a id="__codelineno-61-22" name="__codelineno-61-22" href="#__codelineno-61-22"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">hash</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">numPartitions</span><span class="p">;</span>
<a id="__codelineno-61-23" name="__codelineno-61-23" href="#__codelineno-61-23"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-61-24" name="__codelineno-61-24" href="#__codelineno-61-24"></a>
<a id="__codelineno-61-25" name="__codelineno-61-25" href="#__codelineno-61-25"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">extractTenantId</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">compositeKey</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-61-26" name="__codelineno-61-26" href="#__codelineno-61-26"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">separatorIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">compositeKey</span><span class="p">.</span><span class="na">indexOf</span><span class="p">(</span><span class="sc">&#39;:&#39;</span><span class="p">);</span>
<a id="__codelineno-61-27" name="__codelineno-61-27" href="#__codelineno-61-27"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">separatorIndex</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">compositeKey</span><span class="p">.</span><span class="na">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">separatorIndex</span><span class="p">)</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">compositeKey</span><span class="p">;</span>
<a id="__codelineno-61-28" name="__codelineno-61-28" href="#__codelineno-61-28"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-61-29" name="__codelineno-61-29" href="#__codelineno-61-29"></a>
<a id="__codelineno-61-30" name="__codelineno-61-30" href="#__codelineno-61-30"></a><span class="w">    </span><span class="c1">// Implémentation Murmur2 (même algo que le partitioner par défaut de Kafka)</span>
<a id="__codelineno-61-31" name="__codelineno-61-31" href="#__codelineno-61-31"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">murmur2</span><span class="p">(</span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-61-32" name="__codelineno-61-32" href="#__codelineno-61-32"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="p">.</span><span class="na">length</span><span class="p">;</span>
<a id="__codelineno-61-33" name="__codelineno-61-33" href="#__codelineno-61-33"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">seed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x9747b28c</span><span class="p">;</span>
<a id="__codelineno-61-34" name="__codelineno-61-34" href="#__codelineno-61-34"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x5bd1e995</span><span class="p">;</span>
<a id="__codelineno-61-35" name="__codelineno-61-35" href="#__codelineno-61-35"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">24</span><span class="p">;</span>
<a id="__codelineno-61-36" name="__codelineno-61-36" href="#__codelineno-61-36"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">h</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">seed</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="n">length</span><span class="p">;</span>
<a id="__codelineno-61-37" name="__codelineno-61-37" href="#__codelineno-61-37"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">length4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">length</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span>
<a id="__codelineno-61-38" name="__codelineno-61-38" href="#__codelineno-61-38"></a>
<a id="__codelineno-61-39" name="__codelineno-61-39" href="#__codelineno-61-39"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">length4</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-61-40" name="__codelineno-61-40" href="#__codelineno-61-40"></a><span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">i4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span>
<a id="__codelineno-61-41" name="__codelineno-61-41" href="#__codelineno-61-41"></a><span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="o">[</span><span class="n">i4</span><span class="o">]</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xff</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">((</span><span class="n">data</span><span class="o">[</span><span class="n">i4</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="o">]</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xff</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span>
<a id="__codelineno-61-42" name="__codelineno-61-42" href="#__codelineno-61-42"></a><span class="w">                    </span><span class="p">((</span><span class="n">data</span><span class="o">[</span><span class="n">i4</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="o">]</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xff</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">16</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">((</span><span class="n">data</span><span class="o">[</span><span class="n">i4</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">3</span><span class="o">]</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xff</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">24</span><span class="p">);</span>
<a id="__codelineno-61-43" name="__codelineno-61-43" href="#__codelineno-61-43"></a><span class="w">            </span><span class="n">k</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="n">m</span><span class="p">;</span>
<a id="__codelineno-61-44" name="__codelineno-61-44" href="#__codelineno-61-44"></a><span class="w">            </span><span class="n">k</span><span class="w"> </span><span class="o">^=</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">&gt;&gt;&gt;</span><span class="w"> </span><span class="n">r</span><span class="p">;</span>
<a id="__codelineno-61-45" name="__codelineno-61-45" href="#__codelineno-61-45"></a><span class="w">            </span><span class="n">k</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="n">m</span><span class="p">;</span>
<a id="__codelineno-61-46" name="__codelineno-61-46" href="#__codelineno-61-46"></a><span class="w">            </span><span class="n">h</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="n">m</span><span class="p">;</span>
<a id="__codelineno-61-47" name="__codelineno-61-47" href="#__codelineno-61-47"></a><span class="w">            </span><span class="n">h</span><span class="w"> </span><span class="o">^=</span><span class="w"> </span><span class="n">k</span><span class="p">;</span>
<a id="__codelineno-61-48" name="__codelineno-61-48" href="#__codelineno-61-48"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-61-49" name="__codelineno-61-49" href="#__codelineno-61-49"></a>
<a id="__codelineno-61-50" name="__codelineno-61-50" href="#__codelineno-61-50"></a><span class="w">        </span><span class="c1">// Traiter les bytes restants</span>
<a id="__codelineno-61-51" name="__codelineno-61-51" href="#__codelineno-61-51"></a><span class="w">        </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">length</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-61-52" name="__codelineno-61-52" href="#__codelineno-61-52"></a><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="mi">3</span><span class="p">:</span><span class="w"> </span><span class="n">h</span><span class="w"> </span><span class="o">^=</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="o">[</span><span class="p">(</span><span class="n">length</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="o">~</span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="o">]</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xff</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">16</span><span class="p">;</span>
<a id="__codelineno-61-53" name="__codelineno-61-53" href="#__codelineno-61-53"></a><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="mi">2</span><span class="p">:</span><span class="w"> </span><span class="n">h</span><span class="w"> </span><span class="o">^=</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="o">[</span><span class="p">(</span><span class="n">length</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="o">~</span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="o">]</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xff</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">8</span><span class="p">;</span>
<a id="__codelineno-61-54" name="__codelineno-61-54" href="#__codelineno-61-54"></a><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="w"> </span><span class="n">h</span><span class="w"> </span><span class="o">^=</span><span class="w"> </span><span class="n">data</span><span class="o">[</span><span class="n">length</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="o">~</span><span class="mi">3</span><span class="o">]</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xff</span><span class="p">;</span>
<a id="__codelineno-61-55" name="__codelineno-61-55" href="#__codelineno-61-55"></a><span class="w">                    </span><span class="n">h</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="n">m</span><span class="p">;</span>
<a id="__codelineno-61-56" name="__codelineno-61-56" href="#__codelineno-61-56"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-61-57" name="__codelineno-61-57" href="#__codelineno-61-57"></a>
<a id="__codelineno-61-58" name="__codelineno-61-58" href="#__codelineno-61-58"></a><span class="w">        </span><span class="n">h</span><span class="w"> </span><span class="o">^=</span><span class="w"> </span><span class="n">h</span><span class="w"> </span><span class="o">&gt;&gt;&gt;</span><span class="w"> </span><span class="mi">13</span><span class="p">;</span>
<a id="__codelineno-61-59" name="__codelineno-61-59" href="#__codelineno-61-59"></a><span class="w">        </span><span class="n">h</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="n">m</span><span class="p">;</span>
<a id="__codelineno-61-60" name="__codelineno-61-60" href="#__codelineno-61-60"></a><span class="w">        </span><span class="n">h</span><span class="w"> </span><span class="o">^=</span><span class="w"> </span><span class="n">h</span><span class="w"> </span><span class="o">&gt;&gt;&gt;</span><span class="w"> </span><span class="mi">15</span><span class="p">;</span>
<a id="__codelineno-61-61" name="__codelineno-61-61" href="#__codelineno-61-61"></a>
<a id="__codelineno-61-62" name="__codelineno-61-62" href="#__codelineno-61-62"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">h</span><span class="p">;</span>
<a id="__codelineno-61-63" name="__codelineno-61-63" href="#__codelineno-61-63"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-61-64" name="__codelineno-61-64" href="#__codelineno-61-64"></a>
<a id="__codelineno-61-65" name="__codelineno-61-65" href="#__codelineno-61-65"></a><span class="w">    </span><span class="nd">@Override</span>
<a id="__codelineno-61-66" name="__codelineno-61-66" href="#__codelineno-61-66"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">close</span><span class="p">()</span><span class="w"> </span><span class="p">{}</span>
<a id="__codelineno-61-67" name="__codelineno-61-67" href="#__codelineno-61-67"></a>
<a id="__codelineno-61-68" name="__codelineno-61-68" href="#__codelineno-61-68"></a><span class="w">    </span><span class="nd">@Override</span>
<a id="__codelineno-61-69" name="__codelineno-61-69" href="#__codelineno-61-69"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">configure</span><span class="p">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="o">?&gt;</span><span class="w"> </span><span class="n">configs</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span>
<a id="__codelineno-61-70" name="__codelineno-61-70" href="#__codelineno-61-70"></a><span class="p">}</span>
</code></pre></div>
<p><strong>Gestion du Hot Partition</strong> :</p>
<p>Un hot partition survient quand une clé de partitionnement est surreprésentée, causant une distribution inégale de la charge. C'est un problème courant en multi-tenant quand un gros client génère beaucoup plus de trafic que les autres.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-62-1" name="__codelineno-62-1" href="#__codelineno-62-1"></a><span class="nd">@Component</span>
<a id="__codelineno-62-2" name="__codelineno-62-2" href="#__codelineno-62-2"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">AdaptivePartitioner</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">Partitioner</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-62-3" name="__codelineno-62-3" href="#__codelineno-62-3"></a>
<a id="__codelineno-62-4" name="__codelineno-62-4" href="#__codelineno-62-4"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">HotKeyTracker</span><span class="o">&gt;</span><span class="w"> </span><span class="n">keyTrackers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ConcurrentHashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<a id="__codelineno-62-5" name="__codelineno-62-5" href="#__codelineno-62-5"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">hotKeyThreshold</span><span class="p">;</span>
<a id="__codelineno-62-6" name="__codelineno-62-6" href="#__codelineno-62-6"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">spreadFactor</span><span class="p">;</span>
<a id="__codelineno-62-7" name="__codelineno-62-7" href="#__codelineno-62-7"></a>
<a id="__codelineno-62-8" name="__codelineno-62-8" href="#__codelineno-62-8"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">AdaptivePartitioner</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-62-9" name="__codelineno-62-9" href="#__codelineno-62-9"></a><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">hotKeyThreshold</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10000</span><span class="p">;</span><span class="w">  </span><span class="c1">// Messages par minute déclenchant le spread</span>
<a id="__codelineno-62-10" name="__codelineno-62-10" href="#__codelineno-62-10"></a><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">spreadFactor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span><span class="w">          </span><span class="c1">// Nombre de partitions pour distribuer les hot keys</span>
<a id="__codelineno-62-11" name="__codelineno-62-11" href="#__codelineno-62-11"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-62-12" name="__codelineno-62-12" href="#__codelineno-62-12"></a>
<a id="__codelineno-62-13" name="__codelineno-62-13" href="#__codelineno-62-13"></a><span class="w">    </span><span class="nd">@Override</span>
<a id="__codelineno-62-14" name="__codelineno-62-14" href="#__codelineno-62-14"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">partition</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">topic</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">keyBytes</span><span class="p">,</span>
<a id="__codelineno-62-15" name="__codelineno-62-15" href="#__codelineno-62-15"></a><span class="w">                        </span><span class="n">Object</span><span class="w"> </span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">valueBytes</span><span class="p">,</span><span class="w"> </span><span class="n">Cluster</span><span class="w"> </span><span class="n">cluster</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-62-16" name="__codelineno-62-16" href="#__codelineno-62-16"></a>
<a id="__codelineno-62-17" name="__codelineno-62-17" href="#__codelineno-62-17"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">numPartitions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cluster</span><span class="p">.</span><span class="na">partitionsForTopic</span><span class="p">(</span><span class="n">topic</span><span class="p">).</span><span class="na">size</span><span class="p">();</span>
<a id="__codelineno-62-18" name="__codelineno-62-18" href="#__codelineno-62-18"></a>
<a id="__codelineno-62-19" name="__codelineno-62-19" href="#__codelineno-62-19"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">key</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-62-20" name="__codelineno-62-20" href="#__codelineno-62-20"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">ThreadLocalRandom</span><span class="p">.</span><span class="na">current</span><span class="p">().</span><span class="na">nextInt</span><span class="p">(</span><span class="n">numPartitions</span><span class="p">);</span>
<a id="__codelineno-62-21" name="__codelineno-62-21" href="#__codelineno-62-21"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-62-22" name="__codelineno-62-22" href="#__codelineno-62-22"></a>
<a id="__codelineno-62-23" name="__codelineno-62-23" href="#__codelineno-62-23"></a><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">keyStr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">String</span><span class="p">)</span><span class="w"> </span><span class="n">key</span><span class="p">;</span>
<a id="__codelineno-62-24" name="__codelineno-62-24" href="#__codelineno-62-24"></a><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">trackingKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">topic</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;:&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">keyStr</span><span class="p">;</span>
<a id="__codelineno-62-25" name="__codelineno-62-25" href="#__codelineno-62-25"></a>
<a id="__codelineno-62-26" name="__codelineno-62-26" href="#__codelineno-62-26"></a><span class="w">        </span><span class="c1">// Tracker pour cette clé</span>
<a id="__codelineno-62-27" name="__codelineno-62-27" href="#__codelineno-62-27"></a><span class="w">        </span><span class="n">HotKeyTracker</span><span class="w"> </span><span class="n">tracker</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">keyTrackers</span><span class="p">.</span><span class="na">computeIfAbsent</span><span class="p">(</span><span class="n">trackingKey</span><span class="p">,</span><span class="w"> </span>
<a id="__codelineno-62-28" name="__codelineno-62-28" href="#__codelineno-62-28"></a><span class="w">            </span><span class="n">k</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HotKeyTracker</span><span class="p">());</span>
<a id="__codelineno-62-29" name="__codelineno-62-29" href="#__codelineno-62-29"></a><span class="w">        </span><span class="n">tracker</span><span class="p">.</span><span class="na">increment</span><span class="p">();</span>
<a id="__codelineno-62-30" name="__codelineno-62-30" href="#__codelineno-62-30"></a>
<a id="__codelineno-62-31" name="__codelineno-62-31" href="#__codelineno-62-31"></a><span class="w">        </span><span class="c1">// Calculer la partition de base</span>
<a id="__codelineno-62-32" name="__codelineno-62-32" href="#__codelineno-62-32"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">basePartition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Math</span><span class="p">.</span><span class="na">abs</span><span class="p">(</span><span class="n">keyStr</span><span class="p">.</span><span class="na">hashCode</span><span class="p">())</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">numPartitions</span><span class="p">;</span>
<a id="__codelineno-62-33" name="__codelineno-62-33" href="#__codelineno-62-33"></a>
<a id="__codelineno-62-34" name="__codelineno-62-34" href="#__codelineno-62-34"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tracker</span><span class="p">.</span><span class="na">isHot</span><span class="p">(</span><span class="n">hotKeyThreshold</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-62-35" name="__codelineno-62-35" href="#__codelineno-62-35"></a><span class="w">            </span><span class="c1">// Hot key détectée : distribuer sur plusieurs partitions</span>
<a id="__codelineno-62-36" name="__codelineno-62-36" href="#__codelineno-62-36"></a><span class="w">            </span><span class="c1">// Le suffix est basé sur un compteur pour maintenir un ordre relatif</span>
<a id="__codelineno-62-37" name="__codelineno-62-37" href="#__codelineno-62-37"></a><span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">spreadIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">tracker</span><span class="p">.</span><span class="na">getCount</span><span class="p">()</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">spreadFactor</span><span class="p">);</span>
<a id="__codelineno-62-38" name="__codelineno-62-38" href="#__codelineno-62-38"></a><span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">targetPartition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">basePartition</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">spreadIndex</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">numPartitions</span><span class="p">;</span>
<a id="__codelineno-62-39" name="__codelineno-62-39" href="#__codelineno-62-39"></a>
<a id="__codelineno-62-40" name="__codelineno-62-40" href="#__codelineno-62-40"></a><span class="w">            </span><span class="n">log</span><span class="p">.</span><span class="na">debug</span><span class="p">(</span><span class="s">&quot;Hot key {} spreading to partition {} (base: {})&quot;</span><span class="p">,</span><span class="w"> </span>
<a id="__codelineno-62-41" name="__codelineno-62-41" href="#__codelineno-62-41"></a><span class="w">                </span><span class="n">keyStr</span><span class="p">,</span><span class="w"> </span><span class="n">targetPartition</span><span class="p">,</span><span class="w"> </span><span class="n">basePartition</span><span class="p">);</span>
<a id="__codelineno-62-42" name="__codelineno-62-42" href="#__codelineno-62-42"></a>
<a id="__codelineno-62-43" name="__codelineno-62-43" href="#__codelineno-62-43"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">targetPartition</span><span class="p">;</span>
<a id="__codelineno-62-44" name="__codelineno-62-44" href="#__codelineno-62-44"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-62-45" name="__codelineno-62-45" href="#__codelineno-62-45"></a>
<a id="__codelineno-62-46" name="__codelineno-62-46" href="#__codelineno-62-46"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">basePartition</span><span class="p">;</span>
<a id="__codelineno-62-47" name="__codelineno-62-47" href="#__codelineno-62-47"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-62-48" name="__codelineno-62-48" href="#__codelineno-62-48"></a>
<a id="__codelineno-62-49" name="__codelineno-62-49" href="#__codelineno-62-49"></a><span class="w">    </span><span class="c1">// Reset des compteurs toutes les minutes</span>
<a id="__codelineno-62-50" name="__codelineno-62-50" href="#__codelineno-62-50"></a><span class="w">    </span><span class="nd">@Scheduled</span><span class="p">(</span><span class="n">fixedRate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">60000</span><span class="p">)</span>
<a id="__codelineno-62-51" name="__codelineno-62-51" href="#__codelineno-62-51"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">resetCounters</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-62-52" name="__codelineno-62-52" href="#__codelineno-62-52"></a><span class="w">        </span><span class="n">keyTrackers</span><span class="p">.</span><span class="na">values</span><span class="p">().</span><span class="na">forEach</span><span class="p">(</span><span class="n">HotKeyTracker</span><span class="p">::</span><span class="n">reset</span><span class="p">);</span>
<a id="__codelineno-62-53" name="__codelineno-62-53" href="#__codelineno-62-53"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-62-54" name="__codelineno-62-54" href="#__codelineno-62-54"></a>
<a id="__codelineno-62-55" name="__codelineno-62-55" href="#__codelineno-62-55"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">class</span> <span class="nc">HotKeyTracker</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-62-56" name="__codelineno-62-56" href="#__codelineno-62-56"></a><span class="w">        </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">AtomicLong</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AtomicLong</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<a id="__codelineno-62-57" name="__codelineno-62-57" href="#__codelineno-62-57"></a><span class="w">        </span><span class="kd">private</span><span class="w"> </span><span class="kd">volatile</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">lastResetTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">();</span>
<a id="__codelineno-62-58" name="__codelineno-62-58" href="#__codelineno-62-58"></a>
<a id="__codelineno-62-59" name="__codelineno-62-59" href="#__codelineno-62-59"></a><span class="w">        </span><span class="kt">void</span><span class="w"> </span><span class="nf">increment</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-62-60" name="__codelineno-62-60" href="#__codelineno-62-60"></a><span class="w">            </span><span class="n">count</span><span class="p">.</span><span class="na">incrementAndGet</span><span class="p">();</span>
<a id="__codelineno-62-61" name="__codelineno-62-61" href="#__codelineno-62-61"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-62-62" name="__codelineno-62-62" href="#__codelineno-62-62"></a>
<a id="__codelineno-62-63" name="__codelineno-62-63" href="#__codelineno-62-63"></a><span class="w">        </span><span class="kt">long</span><span class="w"> </span><span class="nf">getCount</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-62-64" name="__codelineno-62-64" href="#__codelineno-62-64"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">count</span><span class="p">.</span><span class="na">get</span><span class="p">();</span>
<a id="__codelineno-62-65" name="__codelineno-62-65" href="#__codelineno-62-65"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-62-66" name="__codelineno-62-66" href="#__codelineno-62-66"></a>
<a id="__codelineno-62-67" name="__codelineno-62-67" href="#__codelineno-62-67"></a><span class="w">        </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">isHot</span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="n">threshold</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-62-68" name="__codelineno-62-68" href="#__codelineno-62-68"></a><span class="w">            </span><span class="kt">long</span><span class="w"> </span><span class="n">elapsed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">lastResetTime</span><span class="p">;</span>
<a id="__codelineno-62-69" name="__codelineno-62-69" href="#__codelineno-62-69"></a><span class="w">            </span><span class="kt">double</span><span class="w"> </span><span class="n">rate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">count</span><span class="p">.</span><span class="na">get</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">60000.0</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">Math</span><span class="p">.</span><span class="na">max</span><span class="p">(</span><span class="n">elapsed</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-62-70" name="__codelineno-62-70" href="#__codelineno-62-70"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">rate</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">threshold</span><span class="p">;</span>
<a id="__codelineno-62-71" name="__codelineno-62-71" href="#__codelineno-62-71"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-62-72" name="__codelineno-62-72" href="#__codelineno-62-72"></a>
<a id="__codelineno-62-73" name="__codelineno-62-73" href="#__codelineno-62-73"></a><span class="w">        </span><span class="kt">void</span><span class="w"> </span><span class="nf">reset</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-62-74" name="__codelineno-62-74" href="#__codelineno-62-74"></a><span class="w">            </span><span class="n">count</span><span class="p">.</span><span class="na">set</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<a id="__codelineno-62-75" name="__codelineno-62-75" href="#__codelineno-62-75"></a><span class="w">            </span><span class="n">lastResetTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">();</span>
<a id="__codelineno-62-76" name="__codelineno-62-76" href="#__codelineno-62-76"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-62-77" name="__codelineno-62-77" href="#__codelineno-62-77"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-62-78" name="__codelineno-62-78" href="#__codelineno-62-78"></a><span class="p">}</span>
</code></pre></div>
<blockquote>
<p><strong>Anti-patron</strong></p>
<p><em>Erreur courante</em> : Utiliser une clé avec cardinalité trop faible (ex: <code>country_code</code> avec seulement 10 valeurs pour un topic à 100 partitions).</p>
<p><em>Conséquence</em> : 90% des partitions sont vides, 10% sont surchargées.</p>
<p><em>Solution</em> : Utiliser une clé composite <code>country:customer_id</code> ou accepter de perdre l'ordering par pays.</p>
</blockquote>
<hr />
<h2 id="iii75-resume">III.7.5 Résumé<a class="headerlink" href="#iii75-resume" title="Permanent link">&para;</a></h2>
<p>Ce chapitre a exploré les patrons d'interaction Kafka, des modèles architecturaux éprouvés qui structurent la communication événementielle à l'échelle de l'entreprise. Ces patterns ne sont pas des abstractions théoriques mais des solutions concrètes à des problèmes réels rencontrés en production. Leur maîtrise est essentielle pour tout architecte travaillant avec Kafka.</p>
<h3 id="lecons-des-cas-problematiques">Leçons des Cas Problématiques<a class="headerlink" href="#lecons-des-cas-problematiques" title="Permanent link">&para;</a></h3>
<p>Les cas de terrain présentés illustrent les défis fondamentaux des architectures événementielles et les conséquences concrètes d'une mauvaise conception :</p>
<p><em>Incohérence transactionnelle</em> : L'absence d'atomicité entre l'écriture en base et la publication d'événement cause des états incohérents qui se manifestent par des commandes fantômes, des factures en double, ou des stocks négatifs. Le pattern Outbox Transactionnel résout ce problème en utilisant la base de données comme intermédiaire fiable, garantissant que l'événement n'est publié que si l'écriture métier a réussi.</p>
<p><em>Tempêtes de retry</em> : Les appels externes bloquants dans les consumers peuvent causer des boucles infinies qui saturent les systèmes. Un service SMTP lent a causé 50 000 tentatives d'envoi pour 500 emails en 30 minutes. Les Dead Letter Queues isolent les messages problématiques, les circuit breakers protègent contre les cascades de défaillances, et le backoff exponentiel évite l'aggravation des problèmes.</p>
<p><em>Isolation insuffisante</em> : Les consumers avec des vitesses de traitement différentes dans le même groupe causent des interférences. Un service ML traitant des événements en 2 secondes a bloqué tous les services de notification pendant le Black Friday. La solution est simple : consumer groups séparés pour chaque service, permettant une progression indépendante.</p>
<p><em>Messages poison</em> : Les messages malformés ou non désérialisables bloquent tout le pipeline si non gérés. Un bug de schéma a causé 6 heures d'indisponibilité totale. Les DLQ avec métadonnées de diagnostic, la validation à la source, et les mécanismes de skip gracieux sont essentiels.</p>
<p><em>Duplications invisibles</em> : L'auto-commit est dangereux pour les traitements critiques car il ne garantit pas que le traitement a réussi. 0.5% des factures étaient soit manquantes, soit en double. Le commit manuel après traitement réussi, combiné avec l'idempotence côté consommateur, est la seule approche fiable.</p>
<p><strong>Patterns de résilience essentiels</strong> :</p>
<table>
<thead>
<tr>
<th>Pattern</th>
<th>Problème résolu</th>
<th>Implémentation</th>
</tr>
</thead>
<tbody>
<tr>
<td>Circuit Breaker</td>
<td>Cascade de défaillances</td>
<td>Resilience4j, Hystrix</td>
</tr>
<tr>
<td>Backpressure</td>
<td>Surcharge du consumer</td>
<td>Rate limiting, semaphores</td>
</tr>
<tr>
<td>Bulkhead</td>
<td>Isolation des ressources</td>
<td>Thread pools séparés</td>
</tr>
<tr>
<td>Timeout</td>
<td>Blocage indéfini</td>
<td>Timeouts explicites sur chaque opération</td>
</tr>
</tbody>
</table>
<h3 id="data-mesh-avec-kafka">Data Mesh avec Kafka<a class="headerlink" href="#data-mesh-avec-kafka" title="Permanent link">&para;</a></h3>
<p>Le Data Mesh transforme l'approche de gestion des données en décentralisant la propriété vers les domaines métier. Cette transformation est organisationnelle autant que technique, et Kafka est un enabler naturel de ce paradigme.</p>
<p><em>Propriété par domaine</em> : Chaque équipe métier publie ses données comme des produits avec des conventions de nommage claires (<code>{domaine}.{type}.{version}</code>). L'équipe Commandes est responsable des événements de commande, de leur qualité, de leur documentation, et de leur évolution. Cette responsabilité inclut les SLA, les schémas, et le support aux consommateurs.</p>
<p><em>Données comme produit</em> : Les événements sont documentés, versionnés, et accompagnés de SLA mesurables. Un produit de données doit être découvrable (catalogue), compréhensible (documentation), fiable (SLA), et interopérable (formats standards). Le Schema Registry fournit la gouvernance des schémas, et les contrats de qualité définissent les attentes.</p>
<p><em>Plateforme self-service</em> : Un catalogue de données, des templates de provisionnement, et des outils CLI permettent aux équipes de créer des produits de données en autonomie. L'indicateur de maturité : une nouvelle équipe peut publier un produit de données en moins d'une journée sans intervention de l'équipe plateforme.</p>
<p><em>Gouvernance fédérée</em> : Standards globaux (formats, sécurité, métadonnées) combinés avec autonomie locale (schémas métier, SLA spécifiques). Les standards non négociables incluent les conventions de nommage, le format de sérialisation (Avro), les métadonnées obligatoires, et les exigences de sécurité.</p>
<p><strong>Métriques de santé du Data Mesh</strong> :</p>
<table>
<thead>
<tr>
<th>Métrique</th>
<th>Description</th>
<th>Cible</th>
</tr>
</thead>
<tbody>
<tr>
<td>Time to first product</td>
<td>Temps pour publier un premier produit</td>
<td>&lt; 1 jour</td>
</tr>
<tr>
<td>Product discovery rate</td>
<td>% de produits découvrables dans le catalogue</td>
<td>&gt; 95%</td>
</tr>
<tr>
<td>SLA compliance</td>
<td>% de produits respectant leurs SLA</td>
<td>&gt; 99%</td>
</tr>
<tr>
<td>Consumer satisfaction</td>
<td>NPS des consommateurs de données</td>
<td>&gt; 50</td>
</tr>
</tbody>
</table>
<h3 id="kafka-connect-pour-lintegration">Kafka Connect pour l'Intégration<a class="headerlink" href="#kafka-connect-pour-lintegration" title="Permanent link">&para;</a></h3>
<p>Kafka Connect simplifie l'intégration avec les systèmes externes en fournissant un framework configuration-driven plutôt que code-driven :</p>
<p><em>Change Data Capture (CDC)</em> : Debezium capture les changements des bases de données et les publie comme événements. C'est le pattern le plus puissant pour intégrer des systèmes legacy sans les modifier. La latence typique est de 10-100ms, et l'ordre des événements est garanti par la lecture du WAL.</p>
<p><em>Sink vers Data Lake</em> : Les connecteurs S3/Iceberg permettent d'alimenter les systèmes analytiques en temps réel avec partitionnement automatique par date/heure. Le format Parquet avec compression Snappy offre un excellent compromis entre taille et performance de lecture.</p>
<p><em>Transformations SMT</em> : Les Single Message Transforms permettent de modifier les messages à la volée sans code custom — routage, filtrage, masquage de données sensibles, enrichissement avec métadonnées.</p>
<p><em>Scalabilité et HA</em> : Le cluster Kafka Connect distribue automatiquement les tâches entre les workers. En cas de défaillance d'un worker, les tâches sont redistribuées sans perte de données grâce au stockage des offsets dans Kafka.</p>
<p><em>Gestion des erreurs</em> : Les Dead Letter Queues de Kafka Connect isolent les messages problématiques avec des métadonnées de diagnostic complètes (topic original, offset, exception, stack trace).</p>
<h3 id="garanties-de-livraison">Garanties de Livraison<a class="headerlink" href="#garanties-de-livraison" title="Permanent link">&para;</a></h3>
<p>Les trois sémantiques de livraison offrent des trade-offs différents que l'architecte doit comprendre pour choisir la bonne approche :</p>
<p><em>At-most-once</em> : Simple mais risque de perte. Latence minimale (~1-2ms), débit maximal. Approprié pour les logs non critiques et les métriques approximatives. Ne jamais utiliser pour des données métier importantes.</p>
<p><em>At-least-once</em> : Garantit la livraison mais peut dupliquer. Latence modérée (~5-20ms), débit élevé. C'est la solution standard pour la plupart des cas d'usage, combinée avec l'idempotence côté consommateur. L'idempotence peut être implémentée via le stockage des IDs traités, les clés naturelles avec contraintes d'unicité, ou le versioning optimiste.</p>
<p><em>Exactly-once</em> : Garantie maximale via les transactions Kafka. Latence plus élevée (~20-100ms), débit réduit de 20-30%. Nécessaire pour les systèmes financiers critiques où toute perte ou duplication est inacceptable. Limité à l'écosystème Kafka — les appels à des systèmes externes restent at-least-once.</p>
<p><strong>Le pattern Outbox Transactionnel</strong> garantit l'atomicité entre les opérations de base de données et la publication d'événements. C'est l'un des patterns les plus importants car il résout le problème classique du double-commit qui cause des incohérences entre l'état de la base de données et les événements publiés.</p>
<p><strong>L'idempotence côté consommateur</strong> est toujours nécessaire, quelle que soit la sémantique de livraison Kafka. Les trois approches principales sont :
1. Stockage des IDs traités dans une table dédiée
2. Clés naturelles avec contraintes d'unicité
3. Versioning optimiste pour les mises à jour</p>
<p><strong>Le pattern DLQ (Dead Letter Queue)</strong> est essentiel pour la résilience. Les messages en échec sont isolés avec des métadonnées de diagnostic, permettant une analyse et un traitement ultérieur sans bloquer le flux principal.</p>
<h3 id="principes-directeurs-pour-larchitecte">Principes Directeurs pour l'Architecte<a class="headerlink" href="#principes-directeurs-pour-larchitecte" title="Permanent link">&para;</a></h3>
<ol>
<li>
<p><strong>Concevoir pour l'échec</strong> : Tout composant peut échouer à tout moment. Les patterns DLQ, retry avec backoff exponentiel, et circuit breaker sont des nécessités architecturales, pas des optimisations optionnelles. Le coût de leur absence se mesure en heures d'indisponibilité et en données perdues.</p>
</li>
<li>
<p><strong>Isoler les consommateurs</strong> : Chaque service avec des besoins différents doit avoir son propre consumer group. L'isolation évite les effets de cascade où un service lent bloque tous les autres. Le coût en ressources (chaque groupe lit toutes les partitions) est largement compensé par la robustesse.</p>
</li>
<li>
<p><strong>Préférer at-least-once avec idempotence</strong> : C'est le meilleur compromis entre fiabilité et complexité pour la majorité des cas d'usage. L'exactly-once a un coût en performance et en complexité qui n'est justifié que pour les cas véritablement critiques.</p>
</li>
<li>
<p><strong>Utiliser Kafka Connect plutôt que du code custom</strong> : Pour les intégrations standard (CDC, sinks vers S3/Snowflake/Elasticsearch), les connecteurs sont plus fiables, plus performants, et plus maintenables que le code custom. L'écosystème de 200+ connecteurs couvre la majorité des cas.</p>
</li>
<li>
<p><strong>Adopter le Data Mesh progressivement</strong> : Commencer par un domaine pilote, prouver la valeur, puis étendre. C'est un changement organisationnel autant que technique, et la résistance au changement est le principal obstacle.</p>
</li>
<li>
<p><strong>Monitorer proactivement</strong> : Le lag, les erreurs, le throughput, et la taille des DLQ doivent être surveillés avec des alertes. Les problèmes détectés tôt sont exponentiellement plus faciles à résoudre. Un lag qui augmente est souvent le premier signe d'un problème plus grave.</p>
</li>
<li>
<p><strong>Documenter les décisions</strong> : Chaque choix de pattern (sémantique de livraison, stratégie d'idempotence, configuration DLQ) doit être documenté avec sa justification. Les architectures événementielles sont complexes, et la documentation est essentielle pour l'onboarding et la maintenance.</p>
</li>
</ol>
<hr />
<h3 id="vers-le-chapitre-suivant">Vers le Chapitre Suivant<a class="headerlink" href="#vers-le-chapitre-suivant" title="Permanent link">&para;</a></h3>
<p>Les patrons d'interaction définissent comment les messages circulent dans l'écosystème Kafka et comment gérer les cas d'erreur. Le chapitre suivant, « Conception d'Application de Traitement de Flux en Continu », explorera Kafka Streams — la bibliothèque qui permet de transformer, agréger, joindre, et enrichir ces flux d'événements en temps réel, ouvrant la porte à des cas d'usage avancés comme les vues matérialisées, les agrégations en fenêtres, et le traitement stateful.</p>
<hr />
<p><em>Volume III : Apache Kafka - Guide de l'Architecte</em></p>
<p><em>Chapitre III.7 — Patrons d'Interaction Kafka</em></p>
<p><em>Monographie « L'Entreprise Agentique »</em></p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Retour en haut de la page
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        
<div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/agbruneau/CorpusInformatique" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../../..", "features": ["navigation.tabs", "navigation.sections", "navigation.expand", "navigation.top", "navigation.indexes", "toc.integrate", "search.suggest", "search.highlight", "content.code.copy"], "search": "../../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copi\u00e9 dans le presse-papier", "clipboard.copy": "Copier dans le presse-papier", "search.result.more.one": "1 de plus sur cette page", "search.result.more.other": "# de plus sur cette page", "search.result.none": "Aucun document trouv\u00e9", "search.result.one": "1 document trouv\u00e9", "search.result.other": "# documents trouv\u00e9s", "search.result.placeholder": "Taper pour d\u00e9marrer la recherche", "search.result.term.missing": "Non trouv\u00e9", "select.version": "S\u00e9lectionner la version"}, "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.79ae519e.min.js"></script>
      
        <script src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>