
<!doctype html>
<html lang="fr" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Corpus encyclopédique francophone — science informatique, interopérabilité et entreprise agentique">
      
      
        <meta name="author" content="André-Guy Bruneau">
      
      
        <link rel="canonical" href="https://agbruneau.github.io/CorpusInformatique/III%20-%20Entreprise%20Agentique/Volume_II_Infrastructure_Agentique/Chapitre_II.9_Patrons_Architecturaux_Avances_AEM/">
      
      
        <link rel="prev" href="../Chapitre_II.8_Integration_Backbone_Evenementiel_Couche_Cognitive/">
      
      
        <link rel="next" href="../Chapitre_II.10_Pipelines_CI_CD_Deploiement_Agents/">
      
      
        
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.2">
    
    
      
        <title>II.9 — Patrons architecturaux avancés (AEM) - Corpus Informatique</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../css/extra.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#chapitre-ii9-patrons-architecturaux-avances-pour-laem" class="md-skip">
          Aller au contenu
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="En-tête">
    <a href="../../.." title="Corpus Informatique" class="md-header__button md-logo" aria-label="Corpus Informatique" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Corpus Informatique
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              II.9 — Patrons architecturaux avancés (AEM)
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Passer au mode sombre"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Passer au mode sombre" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Passer au mode clair"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Passer au mode clair" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Rechercher" placeholder="Rechercher" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Recherche">
        
        <button type="reset" class="md-search__icon md-icon" title="Effacer" aria-label="Effacer" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initialisation de la recherche
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/agbruneau/CorpusInformatique" title="Aller au dépôt" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    agbruneau/CorpusInformatique
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Onglets" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../.." class="md-tabs__link">
        
  
  
    
  
  Accueil

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_I_Fondements_Mathematiques_Theorie/Chapitre_I.1_Fondements_Logiques_Raisonnement/" class="md-tabs__link">
          
  
  
    
  
  I — Science et Génie Informatique

        </a>
      </li>
    
  

    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../II%20-%20Interop%C3%A9rabilit%C3%A9/Chapitre_II.1_Introduction_Problematique/" class="md-tabs__link">
          
  
  
    
  
  II — Interopérabilité

        </a>
      </li>
    
  

      
        
  
  
  
    
  
  
    
    
      
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../../Volume_I_Fondations_Entreprise_Agentique/Chapitre_I.1_Crise_Integration_Systemique/" class="md-tabs__link">
          
  
  
    
  
  III — Entreprise Agentique

        </a>
      </li>
    
  

    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="Corpus Informatique" class="md-nav__button md-logo" aria-label="Corpus Informatique" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Corpus Informatique
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/agbruneau/CorpusInformatique" title="Aller au dépôt" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    agbruneau/CorpusInformatique
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Accueil
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    I — Science et Génie Informatique
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    I — Science et Génie Informatique
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2_1" >
        
          
          <label class="md-nav__link" for="__nav_2_1" id="__nav_2_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Volume I — Fondements Mathématiques et Théorie de l'Informatique
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Volume I — Fondements Mathématiques et Théorie de l'Informatique
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_I_Fondements_Mathematiques_Theorie/Chapitre_I.1_Fondements_Logiques_Raisonnement/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.1 — Fondements logiques et raisonnement
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_I_Fondements_Mathematiques_Theorie/Chapitre_I.2_Structures_Discretes_Combinatoire/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.2 — Structures discrètes et combinatoire
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_I_Fondements_Mathematiques_Theorie/Chapitre_I.3_Theorie_Graphes/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.3 — Théorie des graphes
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_I_Fondements_Mathematiques_Theorie/Chapitre_I.4_Langages_Formels_Automates/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.4 — Langages formels et automates
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_I_Fondements_Mathematiques_Theorie/Chapitre_I.5_Calculabilite_Decidabilite/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.5 — Calculabilité et décidabilité
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_I_Fondements_Mathematiques_Theorie/Chapitre_I.6_Theorie_Complexite/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.6 — Théorie de la complexité
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2_2" >
        
          
          <label class="md-nav__link" for="__nav_2_2" id="__nav_2_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Volume II — Architecture des Ordinateurs et Systèmes Numériques
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Volume II — Architecture des Ordinateurs et Systèmes Numériques
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_II_Architecture_Ordinateurs_Systemes_Numeriques/Chapitre_I.7_Systemes_Numeriques_Donnees/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.7 — Systèmes numériques et données
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_II_Architecture_Ordinateurs_Systemes_Numeriques/Chapitre_I.8_Circuits_Combinatoires/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.8 — Circuits combinatoires
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_II_Architecture_Ordinateurs_Systemes_Numeriques/Chapitre_I.9_Circuits_Sequentiels/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.9 — Circuits séquentiels
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_II_Architecture_Ordinateurs_Systemes_Numeriques/Chapitre_I.10_Conception_Systeme_HDL/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.10 — Conception système HDL
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_II_Architecture_Ordinateurs_Systemes_Numeriques/Chapitre_I.11_Architecture_ISA/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.11 — Architecture ISA
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_II_Architecture_Ordinateurs_Systemes_Numeriques/Chapitre_I.12_Conception_CPU/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.12 — Conception CPU
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_II_Architecture_Ordinateurs_Systemes_Numeriques/Chapitre_I.13_Parallelisme_ILP/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.13 — Parallélisme ILP
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_II_Architecture_Ordinateurs_Systemes_Numeriques/Chapitre_I.14_Hierarchie_Memoire_Stockage/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.14 — Hiérarchie mémoire et stockage
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_II_Architecture_Ordinateurs_Systemes_Numeriques/Chapitre_I.15_Systemes_IO_Accelere/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.15 — Systèmes I/O accélérés
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2_3" >
        
          
          <label class="md-nav__link" for="__nav_2_3" id="__nav_2_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Volume III — Systèmes d'Exploitation, Langages et Environnements
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Volume III — Systèmes d'Exploitation, Langages et Environnements
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_III_Systemes_Exploitation_Langages_Environnements/Chapitre_I.16_Systemes_Exploitation_OS/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.16 — Systèmes d'exploitation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_III_Systemes_Exploitation_Langages_Environnements/Chapitre_I.17_Gestion_Concurrence/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.17 — Gestion de la concurrence
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_III_Systemes_Exploitation_Langages_Environnements/Chapitre_I.18_Gestion_Memoire_Fichiers/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.18 — Gestion mémoire et fichiers
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_III_Systemes_Exploitation_Langages_Environnements/Chapitre_I.19_Conception_Langages/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.19 — Conception des langages
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_III_Systemes_Exploitation_Langages_Environnements/Chapitre_I.20_Compilation_Interpretation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.20 — Compilation et interprétation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_III_Systemes_Exploitation_Langages_Environnements/Chapitre_I.21_Environnements_Virtualisation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.21 — Environnements et virtualisation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2_4" >
        
          
          <label class="md-nav__link" for="__nav_2_4" id="__nav_2_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Volume IV — Structures de Données, Algorithmique et Génie Logiciel
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Volume IV — Structures de Données, Algorithmique et Génie Logiciel
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_IV_Structures_Donnees_Algorithmique_Genie_Logiciel/Chapitre_I.22_Structures_Donnees_Fondamentales/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.22 — Structures de données fondamentales
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_IV_Structures_Donnees_Algorithmique_Genie_Logiciel/Chapitre_I.23_Structures_Donnees_Avancees/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.23 — Structures de données avancées
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_IV_Structures_Donnees_Algorithmique_Genie_Logiciel/Chapitre_I.24_Conception_Analyse_Algorithmes/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.24 — Conception et analyse d'algorithmes
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_IV_Structures_Donnees_Algorithmique_Genie_Logiciel/Chapitre_I.25_Algorithmes_Graphes_Avances/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.25 — Algorithmes de graphes avancés
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_IV_Structures_Donnees_Algorithmique_Genie_Logiciel/Chapitre_I.26_Processus_Developpement/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.26 — Processus de développement
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_IV_Structures_Donnees_Algorithmique_Genie_Logiciel/Chapitre_I.27_Architecture_Logicielle/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.27 — Architecture logicielle
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_IV_Structures_Donnees_Algorithmique_Genie_Logiciel/Chapitre_I.28_Qualite_Test_Maintenance/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.28 — Qualité, test et maintenance
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_IV_Structures_Donnees_Algorithmique_Genie_Logiciel/Chapitre_I.29_DevOps_SRE/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.29 — DevOps et SRE
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2_5" >
        
          
          <label class="md-nav__link" for="__nav_2_5" id="__nav_2_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Volume V — Données, Réseaux, Cloud et Sécurité
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Volume V — Données, Réseaux, Cloud et Sécurité
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_V_Donnees_Reseaux_Cloud_Securite/Chapitre_I.30_SGBD_Fondements/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.30 — SGBD fondements
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_V_Donnees_Reseaux_Cloud_Securite/Chapitre_I.31_SGBD_Implementation_Transactions/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.31 — SGBD implémentation et transactions
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_V_Donnees_Reseaux_Cloud_Securite/Chapitre_I.32_Donnees_Modernes_BigData/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.32 — Données modernes et Big Data
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_V_Donnees_Reseaux_Cloud_Securite/Chapitre_I.33_Fondements_Reseaux/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.33 — Fondements des réseaux
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_V_Donnees_Reseaux_Cloud_Securite/Chapitre_I.34_Protocoles_Internetworking/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.34 — Protocoles et internetworking
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_V_Donnees_Reseaux_Cloud_Securite/Chapitre_I.35_Systemes_Distribues/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.35 — Systèmes distribués
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_V_Donnees_Reseaux_Cloud_Securite/Chapitre_I.36_Cloud_Infrastructures/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.36 — Cloud et infrastructures
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_V_Donnees_Reseaux_Cloud_Securite/Chapitre_I.37_Fondements_Securite/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.37 — Fondements de la sécurité
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_V_Donnees_Reseaux_Cloud_Securite/Chapitre_I.38_Cryptographie_Appliquee/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.38 — Cryptographie appliquée
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_V_Donnees_Reseaux_Cloud_Securite/Chapitre_I.39_Securite_Reseaux/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.39 — Sécurité des réseaux
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_V_Donnees_Reseaux_Cloud_Securite/Chapitre_I.40_Securite_Systemes/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.40 — Sécurité des systèmes
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2_6" >
        
          
          <label class="md-nav__link" for="__nav_2_6" id="__nav_2_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Volume VI — Intelligence Artificielle et Systèmes Interactifs
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    Volume VI — Intelligence Artificielle et Systèmes Interactifs
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_VI_Intelligence_Artificielle_Systemes_Interactifs/Chapitre_I.41_Fondements_IA/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.41 — Fondements de l'IA
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_VI_Intelligence_Artificielle_Systemes_Interactifs/Chapitre_I.42_Connaissance_Raisonnement/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.42 — Connaissance et raisonnement
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_VI_Intelligence_Artificielle_Systemes_Interactifs/Chapitre_I.43_ML_Fondements/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.43 — ML fondements
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_VI_Intelligence_Artificielle_Systemes_Interactifs/Chapitre_I.44_DeepLearning/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.44 — Deep Learning
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_VI_Intelligence_Artificielle_Systemes_Interactifs/Chapitre_I.45_Reinforcement_Learning/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.45 — Reinforcement Learning
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_VI_Intelligence_Artificielle_Systemes_Interactifs/Chapitre_I.46_TALN_NLP/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.46 — TALN / NLP
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_VI_Intelligence_Artificielle_Systemes_Interactifs/Chapitre_I.47_Vision_Ordinateur/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.47 — Vision par ordinateur
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_VI_Intelligence_Artificielle_Systemes_Interactifs/Chapitre_I.48_Infographie_Visualisation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.48 — Infographie et visualisation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_VI_Intelligence_Artificielle_Systemes_Interactifs/Chapitre_I.49_IHM_HCI/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.49 — IHM / HCI
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_VI_Intelligence_Artificielle_Systemes_Interactifs/Chapitre_I.50_Robotique_IoT/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.50 — Robotique et IoT
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2_7" >
        
          
          <label class="md-nav__link" for="__nav_2_7" id="__nav_2_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Volume VII — Technologies Émergentes et Frontières
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_7">
            <span class="md-nav__icon md-icon"></span>
            
  
    Volume VII — Technologies Émergentes et Frontières
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_VII_Technologies_Emergentes_Frontieres/Chapitre_I.51_Informatique_Quantique/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.51 — Informatique quantique
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_VII_Technologies_Emergentes_Frontieres/Chapitre_I.52_Algorithmes_Cryptographie_Quantiques/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.52 — Algorithmes et cryptographie quantiques
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_VII_Technologies_Emergentes_Frontieres/Chapitre_I.53_HPC_Exascale/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.53 — HPC et exascale
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_VII_Technologies_Emergentes_Frontieres/Chapitre_I.54_Architectures_Post_Moore/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.54 — Architectures post-Moore
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_VII_Technologies_Emergentes_Frontieres/Chapitre_I.55_Modeles_Fondateurs_IA/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.55 — Modèles fondateurs IA
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_VII_Technologies_Emergentes_Frontieres/Chapitre_I.56_AGI_Alignement_Securite/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.56 — AGI, alignement et sécurité
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_VII_Technologies_Emergentes_Frontieres/Chapitre_I.57_Sciences_Computationnelles/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.57 — Sciences computationnelles
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_VII_Technologies_Emergentes_Frontieres/Chapitre_I.58_CyberPhysiques_Jumeaux/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.58 — Systèmes cyber-physiques et jumeaux
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_VII_Technologies_Emergentes_Frontieres/Chapitre_I.59_Web3_Decentralise/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.59 — Web3 et décentralisé
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_VII_Technologies_Emergentes_Frontieres/Chapitre_I.60_Synthese_Frontieres/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.60 — Synthèse et frontières
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2_8" >
        
          
          <label class="md-nav__link" for="__nav_2_8" id="__nav_2_8_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Volume VIII — Convergence AGI–Quantique : Fondements et Algorithmes
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_8">
            <span class="md-nav__icon md-icon"></span>
            
  
    Volume VIII — Convergence AGI–Quantique : Fondements et Algorithmes
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_VIII_Convergence_AGI_Quantique_Fondements/Chapitre_I.61_Introduction_Informatique/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.61 — Introduction à l'informatique
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_VIII_Convergence_AGI_Quantique_Fondements/Chapitre_I.62_Convergence_AGI_Quantique/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.62 — Convergence AGI-quantique
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_VIII_Convergence_AGI_Quantique_Fondements/Chapitre_I.63_Evolution_IA_Quantique/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.63 — Évolution IA-quantique
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_VIII_Convergence_AGI_Quantique_Fondements/Chapitre_I.64_Reseaux_Neuronaux_Quantiques/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.64 — Réseaux neuronaux quantiques
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_VIII_Convergence_AGI_Quantique_Fondements/Chapitre_I.65_Algorithmes_Evolutionnaires_Quantiques/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.65 — Algorithmes évolutionnaires quantiques
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_VIII_Convergence_AGI_Quantique_Fondements/Chapitre_I.66_Renforcement_Quantique/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.66 — Renforcement quantique
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_VIII_Convergence_AGI_Quantique_Fondements/Chapitre_I.67_Architectures_Hybrides/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.67 — Architectures hybrides
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_VIII_Convergence_AGI_Quantique_Fondements/Chapitre_I.68_SVM_Quantiques/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.68 — SVM quantiques
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_VIII_Convergence_AGI_Quantique_Fondements/Chapitre_I.69_Codage_Donnees_Quantiques/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.69 — Codage de données quantiques
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_VIII_Convergence_AGI_Quantique_Fondements/Chapitre_I.70_Scalabilite_Correction_Erreurs/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.70 — Scalabilité et correction d'erreurs
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2_9" >
        
          
          <label class="md-nav__link" for="__nav_2_9" id="__nav_2_9_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Volume IX — Convergence AGI–Quantique : Applications et Perspectives
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_9">
            <span class="md-nav__icon md-icon"></span>
            
  
    Volume IX — Convergence AGI–Quantique : Applications et Perspectives
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_IX_Convergence_AGI_Quantique_Applications/Chapitre_I.71_TALN_Quantique/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.71 — TALN quantique
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_IX_Convergence_AGI_Quantique_Applications/Chapitre_I.72_Securite_Confidentialite/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.72 — Sécurité et confidentialité
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_IX_Convergence_AGI_Quantique_Applications/Chapitre_I.73_Ethique_Reglementaire/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.73 — Éthique et réglementaire
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_IX_Convergence_AGI_Quantique_Applications/Chapitre_I.74_Implementation_Materielle/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.74 — Implémentation matérielle
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_IX_Convergence_AGI_Quantique_Applications/Chapitre_I.75_Middleware_Software/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.75 — Middleware et software
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_IX_Convergence_AGI_Quantique_Applications/Chapitre_I.76_Etudes_Cas/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.76 — Études de cas
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_IX_Convergence_AGI_Quantique_Applications/Chapitre_I.77_Durabilite_Energie/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.77 — Durabilité et énergie
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_IX_Convergence_AGI_Quantique_Applications/Chapitre_I.78_Metriques_Bancs/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.78 — Métriques et bancs d'essai
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_IX_Convergence_AGI_Quantique_Applications/Chapitre_I.79_Perspectives_Avenir/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.79 — Perspectives d'avenir
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../I%20-%20Science%20et%20G%C3%A9nie%20Informatique/Volume_IX_Convergence_AGI_Quantique_Applications/Chapitre_I.80_Infrastructure_Centres_Donnees_IA/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.80 — Infrastructure et centres de données IA
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    II — Interopérabilité
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    II — Interopérabilité
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../II%20-%20Interop%C3%A9rabilit%C3%A9/Chapitre_II.1_Introduction_Problematique/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    II.1 — Introduction et problématique
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../II%20-%20Interop%C3%A9rabilit%C3%A9/Chapitre_II.2_Fondements_Theoriques/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    II.2 — Fondements théoriques
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../II%20-%20Interop%C3%A9rabilit%C3%A9/Chapitre_II.3_Integration_Applications/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    II.3 — Intégration des applications
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../II%20-%20Interop%C3%A9rabilit%C3%A9/Chapitre_II.4_Integration_Donnees/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    II.4 — Intégration des données
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../II%20-%20Interop%C3%A9rabilit%C3%A9/Chapitre_II.5_Integration_Evenements/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    II.5 — Intégration des événements
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../II%20-%20Interop%C3%A9rabilit%C3%A9/Chapitre_II.6_Standards_Contrats/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    II.6 — Standards et contrats
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../II%20-%20Interop%C3%A9rabilit%C3%A9/Chapitre_II.7_Resilience_Observabilite/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    II.7 — Résilience et observabilité
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../II%20-%20Interop%C3%A9rabilit%C3%A9/Chapitre_II.8_Collaboration_Automatisation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    II.8 — Collaboration et automatisation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../II%20-%20Interop%C3%A9rabilit%C3%A9/Chapitre_II.9_Architecture_Reference/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    II.9 — Architecture de référence
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../II%20-%20Interop%C3%A9rabilit%C3%A9/Chapitre_II.10_Order_to_Cash/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    II.10 — Order-to-Cash
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../II%20-%20Interop%C3%A9rabilit%C3%A9/Chapitre_II.11_Entreprise_Agentique/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    II.11 — Entreprise agentique
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../II%20-%20Interop%C3%A9rabilit%C3%A9/Chapitre_II.12_Securite_Identite_Conformite/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    II.12 — Sécurité, identité et conformité
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../II%20-%20Interop%C3%A9rabilit%C3%A9/Chapitre_II.A_Annexes/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Annexes
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" checked>
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    III — Entreprise Agentique
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    III — Entreprise Agentique
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_1" >
        
          
          <label class="md-nav__link" for="__nav_4_1" id="__nav_4_1_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Volume I — Fondations
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Volume I — Fondations
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_I_Fondations_Entreprise_Agentique/Chapitre_I.1_Crise_Integration_Systemique/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.1 — Crise d'intégration systémique
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_I_Fondations_Entreprise_Agentique/Chapitre_I.2_Fondements_Dimensions_Interoperabilite/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.2 — Fondements et dimensions de l'interopérabilité
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_I_Fondations_Entreprise_Agentique/Chapitre_I.3_Cadres_Reference_Standards_Maturite/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.3 — Cadres de référence, standards et maturité
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_I_Fondations_Entreprise_Agentique/Chapitre_I.4_Principes_Architecture_Reactive/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.4 — Principes d'architecture réactive
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_I_Fondations_Entreprise_Agentique/Chapitre_I.5_Ecosysteme_API/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.5 — Écosystème API
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_I_Fondations_Entreprise_Agentique/Chapitre_I.6_Architecture_Evenements_EDA/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.6 — Architecture événements (EDA)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_I_Fondations_Entreprise_Agentique/Chapitre_I.7_Contrats_Donnees/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.7 — Contrats de données
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_I_Fondations_Entreprise_Agentique/Chapitre_I.8_Conception_Implementation_Observabilite/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.8 — Conception et implémentation de l'observabilité
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_I_Fondations_Entreprise_Agentique/Chapitre_I.9_Etudes_Cas_Architecturales/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.9 — Études de cas architecturales
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_I_Fondations_Entreprise_Agentique/Chapitre_I.10_Limites_Interoperabilite_Semantique/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.10 — Limites de l'interopérabilité sémantique
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_I_Fondations_Entreprise_Agentique/Chapitre_I.11_IA_Moteur_Interoperabilite/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.11 — IA moteur d'interopérabilité
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_I_Fondations_Entreprise_Agentique/Chapitre_I.12_Definition_Interoperabilite_Cognitivo_Adaptative/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.12 — Définition de l'interopérabilité cognitivo-adaptative
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_I_Fondations_Entreprise_Agentique/Chapitre_I.13_Ere_IA_Agentique_Modele_Travailleur_Numerique/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.13 — Ère IA agentique et modèle du travailleur numérique
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_I_Fondations_Entreprise_Agentique/Chapitre_I.14_Maillage_Agentique/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.14 — Maillage agentique
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_I_Fondations_Entreprise_Agentique/Chapitre_I.15_Ingenierie_Systemes_Cognitifs_Protocoles_Interaction/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.15 — Ingénierie des systèmes cognitifs et protocoles d'interaction
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_I_Fondations_Entreprise_Agentique/Chapitre_I.16_Modele_Operationnel_Symbiose_Humain_Agent/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.16 — Modèle opérationnel de symbiose humain-agent
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_I_Fondations_Entreprise_Agentique/Chapitre_I.17_Gouvernance_Constitutionnelle_Alignement_IA/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.17 — Gouvernance constitutionnelle et alignement IA
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_I_Fondations_Entreprise_Agentique/Chapitre_I.18_AgentOps_Industrialisation_Securisation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.18 — AgentOps : industrialisation et sécurisation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_I_Fondations_Entreprise_Agentique/Chapitre_I.19_Architecte_Intentions_Role_Sociotechnique/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.19 — Architecte des intentions : rôle sociotechnique
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_I_Fondations_Entreprise_Agentique/Chapitre_I.20_Cockpit_Berger_Intention/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.20 — Cockpit du berger d'intention
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_I_Fondations_Entreprise_Agentique/Chapitre_I.21_Feuille_Route_Transformation_Agentique/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.21 — Feuille de route de la transformation agentique
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_I_Fondations_Entreprise_Agentique/Chapitre_I.22_Gestion_Strategique_Portefeuille_Applicatif_APM_Cognitif/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.22 — Gestion stratégique du portefeuille applicatif (APM cognitif)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_I_Fondations_Entreprise_Agentique/Chapitre_I.23_Patrons_Modernisation_Agentification/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.23 — Patrons de modernisation et agentification
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_I_Fondations_Entreprise_Agentique/Chapitre_I.24_Industrialisation_Ingenierie_Plateforme/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.24 — Industrialisation et ingénierie de plateforme
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_I_Fondations_Entreprise_Agentique/Chapitre_I.25_Economie_Cognitive_Diplomatie_Algorithmique/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.25 — Économie cognitive et diplomatie algorithmique
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_I_Fondations_Entreprise_Agentique/Chapitre_I.26_Gestion_Risques_Systemiques_Superalignement/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.26 — Gestion des risques systémiques et superalignement
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_I_Fondations_Entreprise_Agentique/Chapitre_I.27_Prospective_Agent_Auto_Architecturant_AGI_Entreprise/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.27 — Prospective : agent auto-architecturant et AGI d'entreprise
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_I_Fondations_Entreprise_Agentique/Chapitre_I.28_Conclusion_Architecture_Intentionnelle_Sagesse_Collective/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I.28 — Conclusion : architecture intentionnelle et sagesse collective
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_2" checked>
        
          
          <label class="md-nav__link" for="__nav_4_2" id="__nav_4_2_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Volume II — Infrastructure Agentique
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Volume II — Infrastructure Agentique
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Chapitre_II.1_Ingenierie_Plateforme/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    II.1 — Ingénierie de plateforme
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Chapitre_II.2_Fondamentaux_Apache_Kafka_Confluent/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    II.2 — Fondamentaux Apache Kafka et Confluent
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Chapitre_II.3_Conception_Modelisation_Flux_Evenements/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    II.3 — Conception et modélisation des flux d'événements
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Chapitre_II.4_Contrats_Donnees_Gouvernance_Semantique/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    II.4 — Contrats de données et gouvernance sémantique
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Chapitre_II.5_Flux_Temps_Reel/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    II.5 — Flux temps réel
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Chapitre_II.6_Google_Cloud_Vertex_AI/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    II.6 — Google Cloud et Vertex AI
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Chapitre_II.7_Ingenierie_Contexte_RAG/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    II.7 — Ingénierie de contexte et RAG
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Chapitre_II.8_Integration_Backbone_Evenementiel_Couche_Cognitive/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    II.8 — Intégration backbone événementiel et couche cognitive
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    II.9 — Patrons architecturaux avancés (AEM)
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    II.9 — Patrons architecturaux avancés (AEM)
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table des matières">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table des matières
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#introduction" class="md-nav__link">
    <span class="md-ellipsis">
      
        Introduction
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ii91-patron-saga-choregraphiee" class="md-nav__link">
    <span class="md-ellipsis">
      
        II.9.1 Patron Saga Chorégraphiée
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="II.9.1 Patron Saga Chorégraphiée">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#fondements-et-motivation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Fondements et Motivation
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#architecture-de-la-saga-choregraphiee" class="md-nav__link">
    <span class="md-ellipsis">
      
        Architecture de la Saga Chorégraphiée
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implementation-des-participants" class="md-nav__link">
    <span class="md-ellipsis">
      
        Implémentation des Participants
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#coordinateur-de-saga-choregraphiee" class="md-nav__link">
    <span class="md-ellipsis">
      
        Coordinateur de Saga Chorégraphiée
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ii92-cqrs-dans-un-contexte-agentique" class="md-nav__link">
    <span class="md-ellipsis">
      
        II.9.2 CQRS dans un Contexte Agentique
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="II.9.2 CQRS dans un Contexte Agentique">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#principes-fondamentaux-de-cqrs" class="md-nav__link">
    <span class="md-ellipsis">
      
        Principes Fondamentaux de CQRS
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#architecture-cqrs-pour-systemes-agentiques" class="md-nav__link">
    <span class="md-ellipsis">
      
        Architecture CQRS pour Systèmes Agentiques
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#projecteurs-et-modeles-de-lecture" class="md-nav__link">
    <span class="md-ellipsis">
      
        Projecteurs et Modèles de Lecture
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ii93-event-sourcing" class="md-nav__link">
    <span class="md-ellipsis">
      
        II.9.3 Event Sourcing
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="II.9.3 Event Sourcing">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#philosophie-de-levent-sourcing" class="md-nav__link">
    <span class="md-ellipsis">
      
        Philosophie de l'Event Sourcing
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implementation-de-levent-store" class="md-nav__link">
    <span class="md-ellipsis">
      
        Implémentation de l'Event Store
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agregats-et-reconstruction-detat" class="md-nav__link">
    <span class="md-ellipsis">
      
        Agrégats et Reconstruction d'État
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#snapshots-et-optimisation-de-performance" class="md-nav__link">
    <span class="md-ellipsis">
      
        Snapshots et Optimisation de Performance
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#projection-replay-et-reconstruction" class="md-nav__link">
    <span class="md-ellipsis">
      
        Projection Replay et Reconstruction
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ii94-patron-outbox-transactionnel" class="md-nav__link">
    <span class="md-ellipsis">
      
        II.9.4 Patron « Outbox Transactionnel »
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="II.9.4 Patron « Outbox Transactionnel »">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#le-probleme-de-la-double-ecriture" class="md-nav__link">
    <span class="md-ellipsis">
      
        Le Problème de la Double Écriture
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#architecture-du-patron-outbox" class="md-nav__link">
    <span class="md-ellipsis">
      
        Architecture du Patron Outbox
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#outbox-relay-avec-kafka-connect" class="md-nav__link">
    <span class="md-ellipsis">
      
        Outbox Relay avec Kafka Connect
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ii95-gestion-des-erreurs-et-resilience" class="md-nav__link">
    <span class="md-ellipsis">
      
        II.9.5 Gestion des Erreurs et Résilience
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="II.9.5 Gestion des Erreurs et Résilience">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#taxonomie-des-erreurs-dans-les-systemes-agentiques" class="md-nav__link">
    <span class="md-ellipsis">
      
        Taxonomie des Erreurs dans les Systèmes Agentiques
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implementation-des-patterns-de-resilience" class="md-nav__link">
    <span class="md-ellipsis">
      
        Implémentation des Patterns de Résilience
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dead-letter-queue-et-traitement-des-poisons" class="md-nav__link">
    <span class="md-ellipsis">
      
        Dead Letter Queue et Traitement des Poisons
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ii96-integration-avec-les-agents-cognitifs-vertex-ai" class="md-nav__link">
    <span class="md-ellipsis">
      
        II.9.6 Intégration avec les Agents Cognitifs Vertex AI
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="II.9.6 Intégration avec les Agents Cognitifs Vertex AI">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#orchestration-agent-evenement" class="md-nav__link">
    <span class="md-ellipsis">
      
        Orchestration Agent-Événement
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agent-participant-de-saga" class="md-nav__link">
    <span class="md-ellipsis">
      
        Agent Participant de Saga
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ii97-tests-des-patrons-architecturaux" class="md-nav__link">
    <span class="md-ellipsis">
      
        II.9.7 Tests des Patrons Architecturaux
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="II.9.7 Tests des Patrons Architecturaux">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#strategies-de-test-pour-levent-sourcing" class="md-nav__link">
    <span class="md-ellipsis">
      
        Stratégies de Test pour l'Event Sourcing
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tests-de-saga-avec-simulation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Tests de Saga avec Simulation
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ii98-metriques-et-observabilite-des-patrons" class="md-nav__link">
    <span class="md-ellipsis">
      
        II.9.8 Métriques et Observabilité des Patrons
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="II.9.8 Métriques et Observabilité des Patrons">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#indicateurs-cles-de-performance" class="md-nav__link">
    <span class="md-ellipsis">
      
        Indicateurs Clés de Performance
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dashboard-grafana-pour-les-patrons" class="md-nav__link">
    <span class="md-ellipsis">
      
        Dashboard Grafana pour les Patrons
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ii99-etude-de-cas-systeme-de-gestion-de-commandes-agentique" class="md-nav__link">
    <span class="md-ellipsis">
      
        II.9.9 Étude de Cas : Système de Gestion de Commandes Agentique
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="II.9.9 Étude de Cas : Système de Gestion de Commandes Agentique">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#contexte-et-exigences" class="md-nav__link">
    <span class="md-ellipsis">
      
        Contexte et Exigences
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implementation-complete" class="md-nav__link">
    <span class="md-ellipsis">
      
        Implémentation Complète
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#conclusion" class="md-nav__link">
    <span class="md-ellipsis">
      
        Conclusion
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ii910-resume" class="md-nav__link">
    <span class="md-ellipsis">
      
        II.9.10 Résumé
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Chapitre_II.10_Pipelines_CI_CD_Deploiement_Agents/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    II.10 — Pipelines CI/CD et déploiement d'agents
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Chapitre_II.11_Observabilite_Comportementale_Monitoring/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    II.11 — Observabilité comportementale et monitoring
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Chapitre_II.12_Tests_Evaluation_Simulation_Systemes_Multi_Agents/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    II.12 — Tests, évaluation et simulation de systèmes multi-agents
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Chapitre_II.13_Paysage_Menaces_Securite_Systemes_Agentiques/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    II.13 — Paysage des menaces et sécurité des systèmes agentiques
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Chapitre_II.14_Securisation_Infrastructure/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    II.14 — Sécurisation de l'infrastructure
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Chapitre_II.15_Conformite_Reglementaire_Gestion_Confidentialite/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    II.15 — Conformité réglementaire et gestion de la confidentialité
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_3" >
        
          
          <label class="md-nav__link" for="__nav_4_3" id="__nav_4_3_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Volume III — Apache Kafka : Guide de l'Architecte
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Volume III — Apache Kafka : Guide de l'Architecte
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_III_Apache_Kafka_Guide_Architecte/Chapitre_III.1_Decouvrir_Kafka/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    III.1 — Découvrir Kafka
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_III_Apache_Kafka_Guide_Architecte/Chapitre_III.2_Architecture_Cluster_Kafka/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    III.2 — Architecture du cluster Kafka
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_III_Apache_Kafka_Guide_Architecte/Chapitre_III.3_Clients_Kafka_Production/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    III.3 — Clients Kafka en production
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_III_Apache_Kafka_Guide_Architecte/Chapitre_III.4_Applications_Consommatrices/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    III.4 — Applications consommatrices
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_III_Apache_Kafka_Guide_Architecte/Chapitre_III.5_Cas_Utilisation_Kafka/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    III.5 — Cas d'utilisation Kafka
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_III_Apache_Kafka_Guide_Architecte/Chapitre_III.6_Contrats_Donnees/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    III.6 — Contrats de données
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_III_Apache_Kafka_Guide_Architecte/Chapitre_III.7_Patrons_Interaction_Kafka/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    III.7 — Patrons d'interaction Kafka
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_III_Apache_Kafka_Guide_Architecte/Chapitre_III.8_Conception_Application_Streaming/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    III.8 — Conception d'application streaming
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_III_Apache_Kafka_Guide_Architecte/Chapitre_III.9_Gestion_Kafka_Entreprise/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    III.9 — Gestion Kafka en entreprise
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_III_Apache_Kafka_Guide_Architecte/Chapitre_III.10_Organisation_Projet_Kafka/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    III.10 — Organisation d'un projet Kafka
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_III_Apache_Kafka_Guide_Architecte/Chapitre_III.11_Operer_Kafka/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    III.11 — Opérer Kafka
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_III_Apache_Kafka_Guide_Architecte/Chapitre_III.12_Avenir_Kafka/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    III.12 — L'avenir de Kafka
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_4" >
        
          
          <label class="md-nav__link" for="__nav_4_4" id="__nav_4_4_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Volume IV — Apache Iceberg et Lakehouse
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Volume IV — Apache Iceberg et Lakehouse
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_IV_Apache_Iceberg_Lakehouse/Chapitre_IV.1_Monde_Lakehouse_Iceberg/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    IV.1 — Le monde Lakehouse et Iceberg
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_IV_Apache_Iceberg_Lakehouse/Chapitre_IV.2_Anatomie_Technique/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    IV.2 — Anatomie technique
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_IV_Apache_Iceberg_Lakehouse/Chapitre_IV.3_Mise_Pratique/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    IV.3 — Mise en pratique
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_IV_Apache_Iceberg_Lakehouse/Chapitre_IV.4_Preparer_Passage_Iceberg/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    IV.4 — Préparer le passage à Iceberg
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_IV_Apache_Iceberg_Lakehouse/Chapitre_IV.5_Selection_Couche_Stockage/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    IV.5 — Sélection de la couche de stockage
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_IV_Apache_Iceberg_Lakehouse/Chapitre_IV.6_Architecture_Couche_Ingestion/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    IV.6 — Architecture de la couche d'ingestion
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_IV_Apache_Iceberg_Lakehouse/Chapitre_IV.7_Implementation_Couche_Catalogue/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    IV.7 — Implémentation de la couche catalogue
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_IV_Apache_Iceberg_Lakehouse/Chapitre_IV.8_Conception_Couche_Federation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    IV.8 — Conception de la couche de fédération
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_IV_Apache_Iceberg_Lakehouse/Chapitre_IV.9_Comprendre_Couche_Consommation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    IV.9 — Comprendre la couche de consommation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_IV_Apache_Iceberg_Lakehouse/Chapitre_IV.10_Maintenir_Lakehouse_Production/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    IV.10 — Maintenir le Lakehouse en production
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_IV_Apache_Iceberg_Lakehouse/Chapitre_IV.11_Operationnaliser_Apache_Iceberg/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    IV.11 — Opérationnaliser Apache Iceberg
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_IV_Apache_Iceberg_Lakehouse/Chapitre_IV.12_Evolution_Streaming_Lakehouse/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    IV.12 — Évolution du streaming Lakehouse
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_IV_Apache_Iceberg_Lakehouse/Chapitre_IV.13_Securite_Gouvernance_Conformite/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    IV.13 — Sécurité, gouvernance et conformité
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_IV_Apache_Iceberg_Lakehouse/Chapitre_IV.14_Integration_Microsoft_Fabric_PowerBI/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    IV.14 — Intégration Microsoft Fabric et Power BI
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_IV_Apache_Iceberg_Lakehouse/Chapitre_IV.15_Contexte_Canadien_Etudes_Cas/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    IV.15 — Contexte canadien et études de cas
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_IV_Apache_Iceberg_Lakehouse/Chapitre_IV.16_Conclusion_Perspectives_2026_2030/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    IV.16 — Conclusion et perspectives 2026-2030
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_IV_Apache_Iceberg_Lakehouse/Chapitre_IV.Annexe_A_Specification_Apache_Iceberg/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Annexe A — Spécification Apache Iceberg
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_IV_Apache_Iceberg_Lakehouse/Chapitre_IV.Annexe_B_Glossaire/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Annexe B — Glossaire
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_5" >
        
          
          <label class="md-nav__link" for="__nav_4_5" id="__nav_4_5_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Volume V — Développeur Renaissance
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Volume V — Développeur Renaissance
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_V_Developpeur_Renaissance/Chapitre_V.0_Introduction/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    V.0 — Introduction
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_V_Developpeur_Renaissance/Chapitre_V.1_Convergence_Ages_Or/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    V.1 — Convergence des âges d'or
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_V_Developpeur_Renaissance/Chapitre_V.2_Curiosite_Appliquee/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    V.2 — Curiosité appliquée
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_V_Developpeur_Renaissance/Chapitre_V.3_Pensee_Systemique/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    V.3 — Pensée systémique
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_V_Developpeur_Renaissance/Chapitre_V.4_Nouvelle_Communication/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    V.4 — Nouvelle communication
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_V_Developpeur_Renaissance/Chapitre_V.5_Imperatif_Qualite_Responsabilite/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    V.5 — Impératif qualité et responsabilité
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_V_Developpeur_Renaissance/Chapitre_V.6_Capital_Humain_Profil_Polymathe/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    V.6 — Capital humain et profil polymathe
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_V_Developpeur_Renaissance/Chapitre_V.7_Art_Batir_Futur/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    V.7 — L'art de bâtir le futur
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_V_Developpeur_Renaissance/Chapitre_V.8_Bibliotheque_Developpeur_Renaissance/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    V.8 — Bibliothèque du développeur Renaissance
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_V_Developpeur_Renaissance/Chapitre_V.9_Mandat/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    V.9 — Mandat
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Volume_V_Developpeur_Renaissance/Chapitre_V.10_Spec_Driven_Development/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    V.10 — Spec-Driven Development
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="chapitre-ii9-patrons-architecturaux-avances-pour-laem">Chapitre II.9 — Patrons Architecturaux Avancés pour l'AEM<a class="headerlink" href="#chapitre-ii9-patrons-architecturaux-avances-pour-laem" title="Permanent link">&para;</a></h1>
<hr />
<h2 id="introduction">Introduction<a class="headerlink" href="#introduction" title="Permanent link">&para;</a></h2>
<p>L'Agentic Event Mesh (AEM) représente l'infrastructure fondamentale sur laquelle s'appuient les systèmes multi-agents modernes. Cependant, la complexité intrinsèque des architectures distribuées et la nature non déterministe des agents cognitifs exigent des patrons architecturaux sophistiqués pour garantir la cohérence, la résilience et la traçabilité des opérations. Ce chapitre explore en profondeur les patrons avancés qui permettent de construire des systèmes agentiques robustes et maintenables.</p>
<p>Les systèmes agentiques présentent des défis uniques que les architectures traditionnelles peinent à résoudre. Un agent peut initier une chaîne de traitements impliquant plusieurs services, bases de données et autres agents, le tout de manière asynchrone et potentiellement non déterministe. Comment garantir la cohérence transactionnelle dans un tel contexte ? Comment assurer que le système peut récupérer d'une défaillance partielle sans perdre l'état ni corrompre les données ?</p>
<p>Les patrons présentés dans ce chapitre — Saga Chorégraphiée, CQRS, Event Sourcing et Outbox Transactionnel — constituent les briques fondamentales pour répondre à ces questions. Ils ne sont pas mutuellement exclusifs mais se combinent naturellement pour former une architecture cohérente où chaque patron adresse un aspect spécifique de la problématique globale.</p>
<p>Le patron Saga Chorégraphiée orchestre les transactions distribuées à travers une séquence d'événements, permettant aux agents de coordonner leurs actions sans couplage fort. CQRS sépare les flux de lecture et d'écriture, optimisant les performances tout en permettant des vues spécialisées pour les différents consommateurs. Event Sourcing capture l'intégralité de l'historique des changements d'état, offrant une traçabilité complète et la possibilité de reconstituer l'état à n'importe quel moment. L'Outbox Transactionnel garantit la cohérence entre les modifications de base de données et la publication d'événements, éliminant les risques de perte ou de duplication.</p>
<p>Ce chapitre détaille chacun de ces patrons avec des implémentations concrètes utilisant l'écosystème Confluent et Google Cloud, en montrant comment ils s'intègrent naturellement dans l'architecture AEM présentée dans les chapitres précédents.</p>
<hr />
<h2 id="ii91-patron-saga-choregraphiee">II.9.1 Patron Saga Chorégraphiée<a class="headerlink" href="#ii91-patron-saga-choregraphiee" title="Permanent link">&para;</a></h2>
<h3 id="fondements-et-motivation">Fondements et Motivation<a class="headerlink" href="#fondements-et-motivation" title="Permanent link">&para;</a></h3>
<p>Dans les systèmes distribués traditionnels, les transactions ACID garantissent l'atomicité des opérations au sein d'une base de données unique. Cependant, les architectures de microservices et les systèmes agentiques impliquent souvent des opérations qui traversent plusieurs services et sources de données. Le patron de Saga, introduit par Hector Garcia-Molina et Kenneth Salem en 1987, répond à ce défi en décomposant une transaction longue en une séquence de transactions locales, chacune publiée via des événements.</p>
<p>La variante chorégraphiée de la Saga se distingue de l'approche orchestrée par l'absence d'un coordinateur central. Chaque participant écoute les événements pertinents et réagit en exécutant sa transaction locale puis en publiant l'événement suivant. Cette approche distribue la logique de coordination et élimine un point unique de défaillance, au prix d'une complexité accrue dans la compréhension du flux global.</p>
<p>Dans le contexte agentique, la Saga Chorégraphiée prend une dimension particulière. Un agent peut initier un processus métier complexe — comme le traitement d'une demande de prêt — qui implique des vérifications de crédit, des validations de documents, des approbations hiérarchiques et des notifications. Chaque étape peut être gérée par un agent spécialisé ou un service dédié, communiquant exclusivement via le backbone événementiel.</p>
<h3 id="architecture-de-la-saga-choregraphiee">Architecture de la Saga Chorégraphiée<a class="headerlink" href="#architecture-de-la-saga-choregraphiee" title="Permanent link">&para;</a></h3>
<p>L'architecture d'une Saga Chorégraphiée repose sur plusieurs éléments fondamentaux. Les événements de domaine capturent les faits métier significatifs. Les participants réagissent à ces événements et produisent de nouveaux événements. Les événements de compensation permettent d'annuler les effets d'une transaction locale en cas d'échec ultérieur.</p>
<p><strong>Figure II.9.2 --- Pipeline d'une Saga Chorégraphiée avec compensation</strong></p>
<pre class="mermaid"><code>sequenceDiagram
    participant Client
    participant ServiceA as Service A&lt;br/&gt;(Demande de prêt)
    participant Bus as Bus Événementiel&lt;br/&gt;(Kafka)
    participant ServiceB as Service B&lt;br/&gt;(Vérification crédit)
    participant ServiceC as Service C&lt;br/&gt;(Validation documents)
    participant ServiceD as Service D&lt;br/&gt;(Approbation finale)

    Client-&gt;&gt;ServiceA: Soumettre demande
    ServiceA-&gt;&gt;Bus: DemandePrêtCréée
    Bus-&gt;&gt;ServiceB: DemandePrêtCréée
    ServiceB-&gt;&gt;ServiceB: Vérifier crédit
    ServiceB-&gt;&gt;Bus: VérificationCréditRéussie
    Bus-&gt;&gt;ServiceC: VérificationCréditRéussie
    ServiceC-&gt;&gt;ServiceC: Valider documents

    alt Succès
        ServiceC-&gt;&gt;Bus: DocumentsValidés
        Bus-&gt;&gt;ServiceD: DocumentsValidés
        ServiceD-&gt;&gt;Bus: PrêtApprouvé
        Bus-&gt;&gt;Client: Notification approbation
    else Échec - Compensation
        ServiceC-&gt;&gt;Bus: ValidationDocumentsÉchouée
        Bus-&gt;&gt;ServiceB: Compensation : AnnulerVérificationCrédit
        ServiceB-&gt;&gt;Bus: VérificationCréditAnnulée
        Bus-&gt;&gt;ServiceA: Compensation : AnnulerDemande
        ServiceA-&gt;&gt;Bus: DemandeAnnulée
        Bus-&gt;&gt;Client: Notification rejet
    end</code></pre>
<table>
<thead>
<tr>
<th>Type d'événement</th>
<th>Rôle</th>
<th>Exemple</th>
</tr>
</thead>
<tbody>
<tr>
<td>Commande</td>
<td>Initie une action</td>
<td>ProcessLoanRequest</td>
</tr>
<tr>
<td>Succès</td>
<td>Confirme l'exécution</td>
<td>CreditCheckPassed</td>
</tr>
<tr>
<td>Échec</td>
<td>Signale un problème</td>
<td>CreditCheckFailed</td>
</tr>
<tr>
<td>Compensation</td>
<td>Annule une action</td>
<td>ReservationCancelled</td>
</tr>
</tbody>
</table>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="c1"># saga/events.py</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">enum</span><span class="w"> </span><span class="kn">import</span> <span class="n">Enum</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">uuid</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="k">class</span><span class="w"> </span><span class="nc">SagaStatus</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>    <span class="n">STARTED</span> <span class="o">=</span> <span class="s2">&quot;started&quot;</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>    <span class="n">IN_PROGRESS</span> <span class="o">=</span> <span class="s2">&quot;in_progress&quot;</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>    <span class="n">COMPLETED</span> <span class="o">=</span> <span class="s2">&quot;completed&quot;</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>    <span class="n">COMPENSATING</span> <span class="o">=</span> <span class="s2">&quot;compensating&quot;</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>    <span class="n">COMPENSATED</span> <span class="o">=</span> <span class="s2">&quot;compensated&quot;</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>    <span class="n">FAILED</span> <span class="o">=</span> <span class="s2">&quot;failed&quot;</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a><span class="nd">@dataclass</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a><span class="k">class</span><span class="w"> </span><span class="nc">SagaEvent</span><span class="p">:</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Événement de base pour une Saga&quot;&quot;&quot;</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>    <span class="n">event_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()))</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>    <span class="n">saga_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>    <span class="n">correlation_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>    <span class="n">timestamp</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">)</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>    <span class="n">event_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>    <span class="n">payload</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>    <span class="n">metadata</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">to_kafka_headers</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">tuple</span><span class="p">]:</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Convertit les métadonnées en headers Kafka&quot;&quot;&quot;</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>        <span class="k">return</span> <span class="p">[</span>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>            <span class="p">(</span><span class="s2">&quot;saga_id&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">saga_id</span><span class="o">.</span><span class="n">encode</span><span class="p">()),</span>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>            <span class="p">(</span><span class="s2">&quot;correlation_id&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">correlation_id</span><span class="o">.</span><span class="n">encode</span><span class="p">()),</span>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>            <span class="p">(</span><span class="s2">&quot;event_type&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_type</span><span class="o">.</span><span class="n">encode</span><span class="p">()),</span>
<a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a>            <span class="p">(</span><span class="s2">&quot;timestamp&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestamp</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
<a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a>        <span class="p">]</span>
<a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a>
<a id="__codelineno-0-36" name="__codelineno-0-36" href="#__codelineno-0-36"></a><span class="nd">@dataclass</span>
<a id="__codelineno-0-37" name="__codelineno-0-37" href="#__codelineno-0-37"></a><span class="k">class</span><span class="w"> </span><span class="nc">LoanApplicationStarted</span><span class="p">(</span><span class="n">SagaEvent</span><span class="p">):</span>
<a id="__codelineno-0-38" name="__codelineno-0-38" href="#__codelineno-0-38"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Événement de démarrage d&#39;une demande de prêt&quot;&quot;&quot;</span>
<a id="__codelineno-0-39" name="__codelineno-0-39" href="#__codelineno-0-39"></a>    <span class="n">event_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;loan.application.started&quot;</span>
<a id="__codelineno-0-40" name="__codelineno-0-40" href="#__codelineno-0-40"></a>    <span class="n">applicant_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-0-41" name="__codelineno-0-41" href="#__codelineno-0-41"></a>    <span class="n">loan_amount</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>
<a id="__codelineno-0-42" name="__codelineno-0-42" href="#__codelineno-0-42"></a>    <span class="n">loan_purpose</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-0-43" name="__codelineno-0-43" href="#__codelineno-0-43"></a>
<a id="__codelineno-0-44" name="__codelineno-0-44" href="#__codelineno-0-44"></a><span class="nd">@dataclass</span>
<a id="__codelineno-0-45" name="__codelineno-0-45" href="#__codelineno-0-45"></a><span class="k">class</span><span class="w"> </span><span class="nc">CreditCheckRequested</span><span class="p">(</span><span class="n">SagaEvent</span><span class="p">):</span>
<a id="__codelineno-0-46" name="__codelineno-0-46" href="#__codelineno-0-46"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Demande de vérification de crédit&quot;&quot;&quot;</span>
<a id="__codelineno-0-47" name="__codelineno-0-47" href="#__codelineno-0-47"></a>    <span class="n">event_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;credit.check.requested&quot;</span>
<a id="__codelineno-0-48" name="__codelineno-0-48" href="#__codelineno-0-48"></a>    <span class="n">applicant_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-0-49" name="__codelineno-0-49" href="#__codelineno-0-49"></a>    <span class="n">requested_amount</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>
<a id="__codelineno-0-50" name="__codelineno-0-50" href="#__codelineno-0-50"></a>
<a id="__codelineno-0-51" name="__codelineno-0-51" href="#__codelineno-0-51"></a><span class="nd">@dataclass</span>
<a id="__codelineno-0-52" name="__codelineno-0-52" href="#__codelineno-0-52"></a><span class="k">class</span><span class="w"> </span><span class="nc">CreditCheckCompleted</span><span class="p">(</span><span class="n">SagaEvent</span><span class="p">):</span>
<a id="__codelineno-0-53" name="__codelineno-0-53" href="#__codelineno-0-53"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Résultat de la vérification de crédit&quot;&quot;&quot;</span>
<a id="__codelineno-0-54" name="__codelineno-0-54" href="#__codelineno-0-54"></a>    <span class="n">event_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;credit.check.completed&quot;</span>
<a id="__codelineno-0-55" name="__codelineno-0-55" href="#__codelineno-0-55"></a>    <span class="n">applicant_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-0-56" name="__codelineno-0-56" href="#__codelineno-0-56"></a>    <span class="n">credit_score</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-57" name="__codelineno-0-57" href="#__codelineno-0-57"></a>    <span class="n">approved</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-58" name="__codelineno-0-58" href="#__codelineno-0-58"></a>    <span class="n">max_approved_amount</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-59" name="__codelineno-0-59" href="#__codelineno-0-59"></a>    <span class="n">rejection_reason</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-60" name="__codelineno-0-60" href="#__codelineno-0-60"></a>
<a id="__codelineno-0-61" name="__codelineno-0-61" href="#__codelineno-0-61"></a><span class="nd">@dataclass</span>
<a id="__codelineno-0-62" name="__codelineno-0-62" href="#__codelineno-0-62"></a><span class="k">class</span><span class="w"> </span><span class="nc">DocumentVerificationRequested</span><span class="p">(</span><span class="n">SagaEvent</span><span class="p">):</span>
<a id="__codelineno-0-63" name="__codelineno-0-63" href="#__codelineno-0-63"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Demande de vérification des documents&quot;&quot;&quot;</span>
<a id="__codelineno-0-64" name="__codelineno-0-64" href="#__codelineno-0-64"></a>    <span class="n">event_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;document.verification.requested&quot;</span>
<a id="__codelineno-0-65" name="__codelineno-0-65" href="#__codelineno-0-65"></a>    <span class="n">applicant_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-0-66" name="__codelineno-0-66" href="#__codelineno-0-66"></a>    <span class="n">document_ids</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
<a id="__codelineno-0-67" name="__codelineno-0-67" href="#__codelineno-0-67"></a>
<a id="__codelineno-0-68" name="__codelineno-0-68" href="#__codelineno-0-68"></a><span class="nd">@dataclass</span>
<a id="__codelineno-0-69" name="__codelineno-0-69" href="#__codelineno-0-69"></a><span class="k">class</span><span class="w"> </span><span class="nc">DocumentVerificationCompleted</span><span class="p">(</span><span class="n">SagaEvent</span><span class="p">):</span>
<a id="__codelineno-0-70" name="__codelineno-0-70" href="#__codelineno-0-70"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Résultat de la vérification des documents&quot;&quot;&quot;</span>
<a id="__codelineno-0-71" name="__codelineno-0-71" href="#__codelineno-0-71"></a>    <span class="n">event_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;document.verification.completed&quot;</span>
<a id="__codelineno-0-72" name="__codelineno-0-72" href="#__codelineno-0-72"></a>    <span class="n">applicant_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-0-73" name="__codelineno-0-73" href="#__codelineno-0-73"></a>    <span class="n">verified</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-74" name="__codelineno-0-74" href="#__codelineno-0-74"></a>    <span class="n">issues</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
<a id="__codelineno-0-75" name="__codelineno-0-75" href="#__codelineno-0-75"></a>
<a id="__codelineno-0-76" name="__codelineno-0-76" href="#__codelineno-0-76"></a><span class="nd">@dataclass</span>
<a id="__codelineno-0-77" name="__codelineno-0-77" href="#__codelineno-0-77"></a><span class="k">class</span><span class="w"> </span><span class="nc">LoanApproved</span><span class="p">(</span><span class="n">SagaEvent</span><span class="p">):</span>
<a id="__codelineno-0-78" name="__codelineno-0-78" href="#__codelineno-0-78"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Prêt approuvé&quot;&quot;&quot;</span>
<a id="__codelineno-0-79" name="__codelineno-0-79" href="#__codelineno-0-79"></a>    <span class="n">event_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;loan.approved&quot;</span>
<a id="__codelineno-0-80" name="__codelineno-0-80" href="#__codelineno-0-80"></a>    <span class="n">applicant_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-0-81" name="__codelineno-0-81" href="#__codelineno-0-81"></a>    <span class="n">approved_amount</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>
<a id="__codelineno-0-82" name="__codelineno-0-82" href="#__codelineno-0-82"></a>    <span class="n">interest_rate</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>
<a id="__codelineno-0-83" name="__codelineno-0-83" href="#__codelineno-0-83"></a>    <span class="n">term_months</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-84" name="__codelineno-0-84" href="#__codelineno-0-84"></a>
<a id="__codelineno-0-85" name="__codelineno-0-85" href="#__codelineno-0-85"></a><span class="nd">@dataclass</span>
<a id="__codelineno-0-86" name="__codelineno-0-86" href="#__codelineno-0-86"></a><span class="k">class</span><span class="w"> </span><span class="nc">LoanRejected</span><span class="p">(</span><span class="n">SagaEvent</span><span class="p">):</span>
<a id="__codelineno-0-87" name="__codelineno-0-87" href="#__codelineno-0-87"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Prêt rejeté&quot;&quot;&quot;</span>
<a id="__codelineno-0-88" name="__codelineno-0-88" href="#__codelineno-0-88"></a>    <span class="n">event_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;loan.rejected&quot;</span>
<a id="__codelineno-0-89" name="__codelineno-0-89" href="#__codelineno-0-89"></a>    <span class="n">applicant_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-0-90" name="__codelineno-0-90" href="#__codelineno-0-90"></a>    <span class="n">rejection_reasons</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
<a id="__codelineno-0-91" name="__codelineno-0-91" href="#__codelineno-0-91"></a>
<a id="__codelineno-0-92" name="__codelineno-0-92" href="#__codelineno-0-92"></a><span class="nd">@dataclass</span>
<a id="__codelineno-0-93" name="__codelineno-0-93" href="#__codelineno-0-93"></a><span class="k">class</span><span class="w"> </span><span class="nc">CompensationEvent</span><span class="p">(</span><span class="n">SagaEvent</span><span class="p">):</span>
<a id="__codelineno-0-94" name="__codelineno-0-94" href="#__codelineno-0-94"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Événement de compensation générique&quot;&quot;&quot;</span>
<a id="__codelineno-0-95" name="__codelineno-0-95" href="#__codelineno-0-95"></a>    <span class="n">event_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;compensation&quot;</span>
<a id="__codelineno-0-96" name="__codelineno-0-96" href="#__codelineno-0-96"></a>    <span class="n">original_event_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-0-97" name="__codelineno-0-97" href="#__codelineno-0-97"></a>    <span class="n">compensation_reason</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</code></pre></div>
<p>La définition des événements constitue la fondation de la Saga. Chaque événement capture un fait métier significatif avec toutes les informations nécessaires pour que les participants puissent réagir de manière autonome. Le saga_id permet de corréler tous les événements appartenant à une même transaction distribuée, tandis que le correlation_id facilite le traçage à travers les systèmes.</p>
<h3 id="implementation-des-participants">Implémentation des Participants<a class="headerlink" href="#implementation-des-participants" title="Permanent link">&para;</a></h3>
<p>Chaque participant de la Saga implémente une logique de réaction aux événements. Le participant exécute sa transaction locale, publie le résultat, et maintient suffisamment d'état pour pouvoir compenser si nécessaire.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="c1"># saga/participants/credit_check.py</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">confluent_kafka</span><span class="w"> </span><span class="kn">import</span> <span class="n">Consumer</span><span class="p">,</span> <span class="n">Producer</span>
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a>
<a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a><span class="k">class</span><span class="w"> </span><span class="nc">CreditCheckParticipant</span><span class="p">:</span>
<a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Participant responsable de la vérification de crédit&quot;&quot;&quot;</span>
<a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a>
<a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">consumer</span><span class="p">:</span> <span class="n">Consumer</span><span class="p">,</span> <span class="n">producer</span><span class="p">:</span> <span class="n">Producer</span><span class="p">,</span> <span class="n">credit_service</span><span class="p">):</span>
<a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">consumer</span> <span class="o">=</span> <span class="n">consumer</span>
<a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">producer</span> <span class="o">=</span> <span class="n">producer</span>
<a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">credit_service</span> <span class="o">=</span> <span class="n">credit_service</span>
<a id="__codelineno-1-13" name="__codelineno-1-13" href="#__codelineno-1-13"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pending_checks</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Pour la compensation</span>
<a id="__codelineno-1-14" name="__codelineno-1-14" href="#__codelineno-1-14"></a>
<a id="__codelineno-1-15" name="__codelineno-1-15" href="#__codelineno-1-15"></a>        <span class="c1"># Souscription au topic de requêtes</span>
<a id="__codelineno-1-16" name="__codelineno-1-16" href="#__codelineno-1-16"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">consumer</span><span class="o">.</span><span class="n">subscribe</span><span class="p">([</span><span class="s1">&#39;credit.check.requests&#39;</span><span class="p">])</span>
<a id="__codelineno-1-17" name="__codelineno-1-17" href="#__codelineno-1-17"></a>
<a id="__codelineno-1-18" name="__codelineno-1-18" href="#__codelineno-1-18"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">process_events</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-1-19" name="__codelineno-1-19" href="#__codelineno-1-19"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Boucle principale de traitement des événements&quot;&quot;&quot;</span>
<a id="__codelineno-1-20" name="__codelineno-1-20" href="#__codelineno-1-20"></a>        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
<a id="__codelineno-1-21" name="__codelineno-1-21" href="#__codelineno-1-21"></a>            <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">consumer</span><span class="o">.</span><span class="n">poll</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
<a id="__codelineno-1-22" name="__codelineno-1-22" href="#__codelineno-1-22"></a>            <span class="k">if</span> <span class="n">msg</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-1-23" name="__codelineno-1-23" href="#__codelineno-1-23"></a>                <span class="k">continue</span>
<a id="__codelineno-1-24" name="__codelineno-1-24" href="#__codelineno-1-24"></a>            <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">error</span><span class="p">():</span>
<a id="__codelineno-1-25" name="__codelineno-1-25" href="#__codelineno-1-25"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_handle_error</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">error</span><span class="p">())</span>
<a id="__codelineno-1-26" name="__codelineno-1-26" href="#__codelineno-1-26"></a>                <span class="k">continue</span>
<a id="__codelineno-1-27" name="__codelineno-1-27" href="#__codelineno-1-27"></a>
<a id="__codelineno-1-28" name="__codelineno-1-28" href="#__codelineno-1-28"></a>            <span class="n">event</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">value</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
<a id="__codelineno-1-29" name="__codelineno-1-29" href="#__codelineno-1-29"></a>            <span class="n">event_type</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;event_type&#39;</span><span class="p">)</span>
<a id="__codelineno-1-30" name="__codelineno-1-30" href="#__codelineno-1-30"></a>
<a id="__codelineno-1-31" name="__codelineno-1-31" href="#__codelineno-1-31"></a>            <span class="k">if</span> <span class="n">event_type</span> <span class="o">==</span> <span class="s1">&#39;credit.check.requested&#39;</span><span class="p">:</span>
<a id="__codelineno-1-32" name="__codelineno-1-32" href="#__codelineno-1-32"></a>                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_credit_check_request</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
<a id="__codelineno-1-33" name="__codelineno-1-33" href="#__codelineno-1-33"></a>            <span class="k">elif</span> <span class="n">event_type</span> <span class="o">==</span> <span class="s1">&#39;compensation.credit.check&#39;</span><span class="p">:</span>
<a id="__codelineno-1-34" name="__codelineno-1-34" href="#__codelineno-1-34"></a>                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_compensation</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
<a id="__codelineno-1-35" name="__codelineno-1-35" href="#__codelineno-1-35"></a>
<a id="__codelineno-1-36" name="__codelineno-1-36" href="#__codelineno-1-36"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_handle_credit_check_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-1-37" name="__codelineno-1-37" href="#__codelineno-1-37"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Traite une demande de vérification de crédit&quot;&quot;&quot;</span>
<a id="__codelineno-1-38" name="__codelineno-1-38" href="#__codelineno-1-38"></a>        <span class="n">saga_id</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="s1">&#39;saga_id&#39;</span><span class="p">]</span>
<a id="__codelineno-1-39" name="__codelineno-1-39" href="#__codelineno-1-39"></a>        <span class="n">applicant_id</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="s1">&#39;applicant_id&#39;</span><span class="p">]</span>
<a id="__codelineno-1-40" name="__codelineno-1-40" href="#__codelineno-1-40"></a>        <span class="n">requested_amount</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="s1">&#39;requested_amount&#39;</span><span class="p">]</span>
<a id="__codelineno-1-41" name="__codelineno-1-41" href="#__codelineno-1-41"></a>
<a id="__codelineno-1-42" name="__codelineno-1-42" href="#__codelineno-1-42"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-1-43" name="__codelineno-1-43" href="#__codelineno-1-43"></a>            <span class="c1"># Exécution de la vérification</span>
<a id="__codelineno-1-44" name="__codelineno-1-44" href="#__codelineno-1-44"></a>            <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">credit_service</span><span class="o">.</span><span class="n">check_credit</span><span class="p">(</span>
<a id="__codelineno-1-45" name="__codelineno-1-45" href="#__codelineno-1-45"></a>                <span class="n">applicant_id</span><span class="o">=</span><span class="n">applicant_id</span><span class="p">,</span>
<a id="__codelineno-1-46" name="__codelineno-1-46" href="#__codelineno-1-46"></a>                <span class="n">amount</span><span class="o">=</span><span class="n">requested_amount</span>
<a id="__codelineno-1-47" name="__codelineno-1-47" href="#__codelineno-1-47"></a>            <span class="p">)</span>
<a id="__codelineno-1-48" name="__codelineno-1-48" href="#__codelineno-1-48"></a>
<a id="__codelineno-1-49" name="__codelineno-1-49" href="#__codelineno-1-49"></a>            <span class="c1"># Stockage pour compensation potentielle</span>
<a id="__codelineno-1-50" name="__codelineno-1-50" href="#__codelineno-1-50"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">pending_checks</span><span class="p">[</span><span class="n">saga_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-1-51" name="__codelineno-1-51" href="#__codelineno-1-51"></a>                <span class="s1">&#39;applicant_id&#39;</span><span class="p">:</span> <span class="n">applicant_id</span><span class="p">,</span>
<a id="__codelineno-1-52" name="__codelineno-1-52" href="#__codelineno-1-52"></a>                <span class="s1">&#39;check_id&#39;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">check_id</span><span class="p">,</span>
<a id="__codelineno-1-53" name="__codelineno-1-53" href="#__codelineno-1-53"></a>                <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
<a id="__codelineno-1-54" name="__codelineno-1-54" href="#__codelineno-1-54"></a>            <span class="p">}</span>
<a id="__codelineno-1-55" name="__codelineno-1-55" href="#__codelineno-1-55"></a>
<a id="__codelineno-1-56" name="__codelineno-1-56" href="#__codelineno-1-56"></a>            <span class="c1"># Publication du résultat</span>
<a id="__codelineno-1-57" name="__codelineno-1-57" href="#__codelineno-1-57"></a>            <span class="n">response_event</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-1-58" name="__codelineno-1-58" href="#__codelineno-1-58"></a>                <span class="s1">&#39;event_id&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()),</span>
<a id="__codelineno-1-59" name="__codelineno-1-59" href="#__codelineno-1-59"></a>                <span class="s1">&#39;saga_id&#39;</span><span class="p">:</span> <span class="n">saga_id</span><span class="p">,</span>
<a id="__codelineno-1-60" name="__codelineno-1-60" href="#__codelineno-1-60"></a>                <span class="s1">&#39;correlation_id&#39;</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;correlation_id&#39;</span><span class="p">),</span>
<a id="__codelineno-1-61" name="__codelineno-1-61" href="#__codelineno-1-61"></a>                <span class="s1">&#39;event_type&#39;</span><span class="p">:</span> <span class="s1">&#39;credit.check.completed&#39;</span><span class="p">,</span>
<a id="__codelineno-1-62" name="__codelineno-1-62" href="#__codelineno-1-62"></a>                <span class="s1">&#39;applicant_id&#39;</span><span class="p">:</span> <span class="n">applicant_id</span><span class="p">,</span>
<a id="__codelineno-1-63" name="__codelineno-1-63" href="#__codelineno-1-63"></a>                <span class="s1">&#39;credit_score&#39;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">score</span><span class="p">,</span>
<a id="__codelineno-1-64" name="__codelineno-1-64" href="#__codelineno-1-64"></a>                <span class="s1">&#39;approved&#39;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">approved</span><span class="p">,</span>
<a id="__codelineno-1-65" name="__codelineno-1-65" href="#__codelineno-1-65"></a>                <span class="s1">&#39;max_approved_amount&#39;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">max_amount</span> <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">approved</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-1-66" name="__codelineno-1-66" href="#__codelineno-1-66"></a>                <span class="s1">&#39;rejection_reason&#39;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">reason</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="o">.</span><span class="n">approved</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-1-67" name="__codelineno-1-67" href="#__codelineno-1-67"></a>                <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
<a id="__codelineno-1-68" name="__codelineno-1-68" href="#__codelineno-1-68"></a>            <span class="p">}</span>
<a id="__codelineno-1-69" name="__codelineno-1-69" href="#__codelineno-1-69"></a>
<a id="__codelineno-1-70" name="__codelineno-1-70" href="#__codelineno-1-70"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_publish_event</span><span class="p">(</span><span class="s1">&#39;credit.check.results&#39;</span><span class="p">,</span> <span class="n">response_event</span><span class="p">)</span>
<a id="__codelineno-1-71" name="__codelineno-1-71" href="#__codelineno-1-71"></a>
<a id="__codelineno-1-72" name="__codelineno-1-72" href="#__codelineno-1-72"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-1-73" name="__codelineno-1-73" href="#__codelineno-1-73"></a>            <span class="c1"># Publication d&#39;un événement d&#39;échec</span>
<a id="__codelineno-1-74" name="__codelineno-1-74" href="#__codelineno-1-74"></a>            <span class="n">error_event</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-1-75" name="__codelineno-1-75" href="#__codelineno-1-75"></a>                <span class="s1">&#39;event_id&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()),</span>
<a id="__codelineno-1-76" name="__codelineno-1-76" href="#__codelineno-1-76"></a>                <span class="s1">&#39;saga_id&#39;</span><span class="p">:</span> <span class="n">saga_id</span><span class="p">,</span>
<a id="__codelineno-1-77" name="__codelineno-1-77" href="#__codelineno-1-77"></a>                <span class="s1">&#39;event_type&#39;</span><span class="p">:</span> <span class="s1">&#39;credit.check.failed&#39;</span><span class="p">,</span>
<a id="__codelineno-1-78" name="__codelineno-1-78" href="#__codelineno-1-78"></a>                <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
<a id="__codelineno-1-79" name="__codelineno-1-79" href="#__codelineno-1-79"></a>                <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
<a id="__codelineno-1-80" name="__codelineno-1-80" href="#__codelineno-1-80"></a>            <span class="p">}</span>
<a id="__codelineno-1-81" name="__codelineno-1-81" href="#__codelineno-1-81"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_publish_event</span><span class="p">(</span><span class="s1">&#39;credit.check.results&#39;</span><span class="p">,</span> <span class="n">error_event</span><span class="p">)</span>
<a id="__codelineno-1-82" name="__codelineno-1-82" href="#__codelineno-1-82"></a>
<a id="__codelineno-1-83" name="__codelineno-1-83" href="#__codelineno-1-83"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_handle_compensation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-1-84" name="__codelineno-1-84" href="#__codelineno-1-84"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Compense une vérification de crédit précédente&quot;&quot;&quot;</span>
<a id="__codelineno-1-85" name="__codelineno-1-85" href="#__codelineno-1-85"></a>        <span class="n">saga_id</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="s1">&#39;saga_id&#39;</span><span class="p">]</span>
<a id="__codelineno-1-86" name="__codelineno-1-86" href="#__codelineno-1-86"></a>
<a id="__codelineno-1-87" name="__codelineno-1-87" href="#__codelineno-1-87"></a>        <span class="k">if</span> <span class="n">saga_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pending_checks</span><span class="p">:</span>
<a id="__codelineno-1-88" name="__codelineno-1-88" href="#__codelineno-1-88"></a>            <span class="n">check_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pending_checks</span><span class="p">[</span><span class="n">saga_id</span><span class="p">]</span>
<a id="__codelineno-1-89" name="__codelineno-1-89" href="#__codelineno-1-89"></a>
<a id="__codelineno-1-90" name="__codelineno-1-90" href="#__codelineno-1-90"></a>            <span class="c1"># Annulation de la vérification (marquer comme annulée)</span>
<a id="__codelineno-1-91" name="__codelineno-1-91" href="#__codelineno-1-91"></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">credit_service</span><span class="o">.</span><span class="n">cancel_check</span><span class="p">(</span><span class="n">check_info</span><span class="p">[</span><span class="s1">&#39;check_id&#39;</span><span class="p">])</span>
<a id="__codelineno-1-92" name="__codelineno-1-92" href="#__codelineno-1-92"></a>
<a id="__codelineno-1-93" name="__codelineno-1-93" href="#__codelineno-1-93"></a>            <span class="c1"># Nettoyage</span>
<a id="__codelineno-1-94" name="__codelineno-1-94" href="#__codelineno-1-94"></a>            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">pending_checks</span><span class="p">[</span><span class="n">saga_id</span><span class="p">]</span>
<a id="__codelineno-1-95" name="__codelineno-1-95" href="#__codelineno-1-95"></a>
<a id="__codelineno-1-96" name="__codelineno-1-96" href="#__codelineno-1-96"></a>            <span class="c1"># Confirmation de la compensation</span>
<a id="__codelineno-1-97" name="__codelineno-1-97" href="#__codelineno-1-97"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_publish_event</span><span class="p">(</span><span class="s1">&#39;compensation.results&#39;</span><span class="p">,</span> <span class="p">{</span>
<a id="__codelineno-1-98" name="__codelineno-1-98" href="#__codelineno-1-98"></a>                <span class="s1">&#39;saga_id&#39;</span><span class="p">:</span> <span class="n">saga_id</span><span class="p">,</span>
<a id="__codelineno-1-99" name="__codelineno-1-99" href="#__codelineno-1-99"></a>                <span class="s1">&#39;event_type&#39;</span><span class="p">:</span> <span class="s1">&#39;credit.check.compensated&#39;</span><span class="p">,</span>
<a id="__codelineno-1-100" name="__codelineno-1-100" href="#__codelineno-1-100"></a>                <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
<a id="__codelineno-1-101" name="__codelineno-1-101" href="#__codelineno-1-101"></a>            <span class="p">})</span>
<a id="__codelineno-1-102" name="__codelineno-1-102" href="#__codelineno-1-102"></a>
<a id="__codelineno-1-103" name="__codelineno-1-103" href="#__codelineno-1-103"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_publish_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">topic</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-1-104" name="__codelineno-1-104" href="#__codelineno-1-104"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Publie un événement sur Kafka&quot;&quot;&quot;</span>
<a id="__codelineno-1-105" name="__codelineno-1-105" href="#__codelineno-1-105"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">producer</span><span class="o">.</span><span class="n">produce</span><span class="p">(</span>
<a id="__codelineno-1-106" name="__codelineno-1-106" href="#__codelineno-1-106"></a>            <span class="n">topic</span><span class="o">=</span><span class="n">topic</span><span class="p">,</span>
<a id="__codelineno-1-107" name="__codelineno-1-107" href="#__codelineno-1-107"></a>            <span class="n">key</span><span class="o">=</span><span class="n">event</span><span class="p">[</span><span class="s1">&#39;saga_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(),</span>
<a id="__codelineno-1-108" name="__codelineno-1-108" href="#__codelineno-1-108"></a>            <span class="n">value</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">event</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(),</span>
<a id="__codelineno-1-109" name="__codelineno-1-109" href="#__codelineno-1-109"></a>            <span class="n">headers</span><span class="o">=</span><span class="p">[</span>
<a id="__codelineno-1-110" name="__codelineno-1-110" href="#__codelineno-1-110"></a>                <span class="p">(</span><span class="s1">&#39;saga_id&#39;</span><span class="p">,</span> <span class="n">event</span><span class="p">[</span><span class="s1">&#39;saga_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">()),</span>
<a id="__codelineno-1-111" name="__codelineno-1-111" href="#__codelineno-1-111"></a>                <span class="p">(</span><span class="s1">&#39;event_type&#39;</span><span class="p">,</span> <span class="n">event</span><span class="p">[</span><span class="s1">&#39;event_type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
<a id="__codelineno-1-112" name="__codelineno-1-112" href="#__codelineno-1-112"></a>            <span class="p">]</span>
<a id="__codelineno-1-113" name="__codelineno-1-113" href="#__codelineno-1-113"></a>        <span class="p">)</span>
<a id="__codelineno-1-114" name="__codelineno-1-114" href="#__codelineno-1-114"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">producer</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
</code></pre></div>
<h3 id="coordinateur-de-saga-choregraphiee">Coordinateur de Saga Chorégraphiée<a class="headerlink" href="#coordinateur-de-saga-choregraphiee" title="Permanent link">&para;</a></h3>
<p>Bien que la Saga Chorégraphiée n'ait pas de coordinateur central au sens strict, il est utile de maintenir un composant qui observe l'état global de la saga et peut déclencher les compensations si nécessaire. Ce coordinateur n'intervient pas dans le flux normal mais surveille les timeouts et les situations anormales.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="c1"># saga/coordinator.py</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">enum</span><span class="w"> </span><span class="kn">import</span> <span class="n">Enum</span>
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a>
<a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a><span class="nd">@dataclass</span>
<a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a><span class="k">class</span><span class="w"> </span><span class="nc">SagaState</span><span class="p">:</span>
<a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;État d&#39;une Saga en cours&quot;&quot;&quot;</span>
<a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a>    <span class="n">saga_id</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a>    <span class="n">status</span><span class="p">:</span> <span class="n">SagaStatus</span>
<a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a>    <span class="n">started_at</span><span class="p">:</span> <span class="n">datetime</span>
<a id="__codelineno-2-14" name="__codelineno-2-14" href="#__codelineno-2-14"></a>    <span class="n">current_step</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-2-15" name="__codelineno-2-15" href="#__codelineno-2-15"></a>    <span class="n">completed_steps</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
<a id="__codelineno-2-16" name="__codelineno-2-16" href="#__codelineno-2-16"></a>    <span class="n">failed_step</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-2-17" name="__codelineno-2-17" href="#__codelineno-2-17"></a>    <span class="n">compensation_started</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-2-18" name="__codelineno-2-18" href="#__codelineno-2-18"></a>    <span class="n">events</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-2-19" name="__codelineno-2-19" href="#__codelineno-2-19"></a>
<a id="__codelineno-2-20" name="__codelineno-2-20" href="#__codelineno-2-20"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-2-21" name="__codelineno-2-21" href="#__codelineno-2-21"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">events</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-2-22" name="__codelineno-2-22" href="#__codelineno-2-22"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">events</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-2-23" name="__codelineno-2-23" href="#__codelineno-2-23"></a>
<a id="__codelineno-2-24" name="__codelineno-2-24" href="#__codelineno-2-24"></a><span class="k">class</span><span class="w"> </span><span class="nc">SagaCoordinator</span><span class="p">:</span>
<a id="__codelineno-2-25" name="__codelineno-2-25" href="#__codelineno-2-25"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Coordinateur observateur pour les Sagas Chorégraphiées&quot;&quot;&quot;</span>
<a id="__codelineno-2-26" name="__codelineno-2-26" href="#__codelineno-2-26"></a>
<a id="__codelineno-2-27" name="__codelineno-2-27" href="#__codelineno-2-27"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">consumer</span><span class="p">,</span> <span class="n">producer</span><span class="p">,</span> <span class="n">state_store</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-2-28" name="__codelineno-2-28" href="#__codelineno-2-28"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">consumer</span> <span class="o">=</span> <span class="n">consumer</span>
<a id="__codelineno-2-29" name="__codelineno-2-29" href="#__codelineno-2-29"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">producer</span> <span class="o">=</span> <span class="n">producer</span>
<a id="__codelineno-2-30" name="__codelineno-2-30" href="#__codelineno-2-30"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">state_store</span> <span class="o">=</span> <span class="n">state_store</span>
<a id="__codelineno-2-31" name="__codelineno-2-31" href="#__codelineno-2-31"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
<a id="__codelineno-2-32" name="__codelineno-2-32" href="#__codelineno-2-32"></a>
<a id="__codelineno-2-33" name="__codelineno-2-33" href="#__codelineno-2-33"></a>        <span class="c1"># Configuration des timeouts</span>
<a id="__codelineno-2-34" name="__codelineno-2-34" href="#__codelineno-2-34"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">step_timeout</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;step_timeout&#39;</span><span class="p">,</span> <span class="mi">300</span><span class="p">))</span>
<a id="__codelineno-2-35" name="__codelineno-2-35" href="#__codelineno-2-35"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">saga_timeout</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;saga_timeout&#39;</span><span class="p">,</span> <span class="mi">3600</span><span class="p">))</span>
<a id="__codelineno-2-36" name="__codelineno-2-36" href="#__codelineno-2-36"></a>
<a id="__codelineno-2-37" name="__codelineno-2-37" href="#__codelineno-2-37"></a>        <span class="c1"># Définition du flux de la saga</span>
<a id="__codelineno-2-38" name="__codelineno-2-38" href="#__codelineno-2-38"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">saga_flow</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;saga_flow&#39;</span><span class="p">,</span> <span class="p">[</span>
<a id="__codelineno-2-39" name="__codelineno-2-39" href="#__codelineno-2-39"></a>            <span class="s1">&#39;credit.check.completed&#39;</span><span class="p">,</span>
<a id="__codelineno-2-40" name="__codelineno-2-40" href="#__codelineno-2-40"></a>            <span class="s1">&#39;document.verification.completed&#39;</span><span class="p">,</span>
<a id="__codelineno-2-41" name="__codelineno-2-41" href="#__codelineno-2-41"></a>            <span class="s1">&#39;loan.decision.made&#39;</span>
<a id="__codelineno-2-42" name="__codelineno-2-42" href="#__codelineno-2-42"></a>        <span class="p">])</span>
<a id="__codelineno-2-43" name="__codelineno-2-43" href="#__codelineno-2-43"></a>
<a id="__codelineno-2-44" name="__codelineno-2-44" href="#__codelineno-2-44"></a>        <span class="c1"># Mapping des compensations</span>
<a id="__codelineno-2-45" name="__codelineno-2-45" href="#__codelineno-2-45"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">compensation_map</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-2-46" name="__codelineno-2-46" href="#__codelineno-2-46"></a>            <span class="s1">&#39;credit.check.completed&#39;</span><span class="p">:</span> <span class="s1">&#39;compensation.credit.check&#39;</span><span class="p">,</span>
<a id="__codelineno-2-47" name="__codelineno-2-47" href="#__codelineno-2-47"></a>            <span class="s1">&#39;document.verification.completed&#39;</span><span class="p">:</span> <span class="s1">&#39;compensation.document.verification&#39;</span><span class="p">,</span>
<a id="__codelineno-2-48" name="__codelineno-2-48" href="#__codelineno-2-48"></a>            <span class="s1">&#39;loan.decision.made&#39;</span><span class="p">:</span> <span class="s1">&#39;compensation.loan.decision&#39;</span>
<a id="__codelineno-2-49" name="__codelineno-2-49" href="#__codelineno-2-49"></a>        <span class="p">}</span>
<a id="__codelineno-2-50" name="__codelineno-2-50" href="#__codelineno-2-50"></a>
<a id="__codelineno-2-51" name="__codelineno-2-51" href="#__codelineno-2-51"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">monitor_sagas</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-2-52" name="__codelineno-2-52" href="#__codelineno-2-52"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Surveillance continue des sagas en cours&quot;&quot;&quot;</span>
<a id="__codelineno-2-53" name="__codelineno-2-53" href="#__codelineno-2-53"></a>        <span class="c1"># Souscription à tous les topics de résultats</span>
<a id="__codelineno-2-54" name="__codelineno-2-54" href="#__codelineno-2-54"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">consumer</span><span class="o">.</span><span class="n">subscribe</span><span class="p">([</span>
<a id="__codelineno-2-55" name="__codelineno-2-55" href="#__codelineno-2-55"></a>            <span class="s1">&#39;loan.application.events&#39;</span><span class="p">,</span>
<a id="__codelineno-2-56" name="__codelineno-2-56" href="#__codelineno-2-56"></a>            <span class="s1">&#39;credit.check.results&#39;</span><span class="p">,</span>
<a id="__codelineno-2-57" name="__codelineno-2-57" href="#__codelineno-2-57"></a>            <span class="s1">&#39;document.verification.results&#39;</span><span class="p">,</span>
<a id="__codelineno-2-58" name="__codelineno-2-58" href="#__codelineno-2-58"></a>            <span class="s1">&#39;loan.decision.results&#39;</span>
<a id="__codelineno-2-59" name="__codelineno-2-59" href="#__codelineno-2-59"></a>        <span class="p">])</span>
<a id="__codelineno-2-60" name="__codelineno-2-60" href="#__codelineno-2-60"></a>
<a id="__codelineno-2-61" name="__codelineno-2-61" href="#__codelineno-2-61"></a>        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
<a id="__codelineno-2-62" name="__codelineno-2-62" href="#__codelineno-2-62"></a>            <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">consumer</span><span class="o">.</span><span class="n">poll</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
<a id="__codelineno-2-63" name="__codelineno-2-63" href="#__codelineno-2-63"></a>            <span class="k">if</span> <span class="n">msg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">msg</span><span class="o">.</span><span class="n">error</span><span class="p">():</span>
<a id="__codelineno-2-64" name="__codelineno-2-64" href="#__codelineno-2-64"></a>                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_event</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">value</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">()))</span>
<a id="__codelineno-2-65" name="__codelineno-2-65" href="#__codelineno-2-65"></a>
<a id="__codelineno-2-66" name="__codelineno-2-66" href="#__codelineno-2-66"></a>            <span class="c1"># Vérification périodique des timeouts</span>
<a id="__codelineno-2-67" name="__codelineno-2-67" href="#__codelineno-2-67"></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_timeouts</span><span class="p">()</span>
<a id="__codelineno-2-68" name="__codelineno-2-68" href="#__codelineno-2-68"></a>
<a id="__codelineno-2-69" name="__codelineno-2-69" href="#__codelineno-2-69"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_process_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-2-70" name="__codelineno-2-70" href="#__codelineno-2-70"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Traite un événement et met à jour l&#39;état de la saga&quot;&quot;&quot;</span>
<a id="__codelineno-2-71" name="__codelineno-2-71" href="#__codelineno-2-71"></a>        <span class="n">saga_id</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;saga_id&#39;</span><span class="p">)</span>
<a id="__codelineno-2-72" name="__codelineno-2-72" href="#__codelineno-2-72"></a>        <span class="n">event_type</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;event_type&#39;</span><span class="p">)</span>
<a id="__codelineno-2-73" name="__codelineno-2-73" href="#__codelineno-2-73"></a>
<a id="__codelineno-2-74" name="__codelineno-2-74" href="#__codelineno-2-74"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">saga_id</span><span class="p">:</span>
<a id="__codelineno-2-75" name="__codelineno-2-75" href="#__codelineno-2-75"></a>            <span class="k">return</span>
<a id="__codelineno-2-76" name="__codelineno-2-76" href="#__codelineno-2-76"></a>
<a id="__codelineno-2-77" name="__codelineno-2-77" href="#__codelineno-2-77"></a>        <span class="c1"># Récupération ou création de l&#39;état</span>
<a id="__codelineno-2-78" name="__codelineno-2-78" href="#__codelineno-2-78"></a>        <span class="n">state</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">saga_id</span><span class="p">)</span>
<a id="__codelineno-2-79" name="__codelineno-2-79" href="#__codelineno-2-79"></a>        <span class="k">if</span> <span class="n">state</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-2-80" name="__codelineno-2-80" href="#__codelineno-2-80"></a>            <span class="k">if</span> <span class="n">event_type</span> <span class="o">==</span> <span class="s1">&#39;loan.application.started&#39;</span><span class="p">:</span>
<a id="__codelineno-2-81" name="__codelineno-2-81" href="#__codelineno-2-81"></a>                <span class="n">state</span> <span class="o">=</span> <span class="n">SagaState</span><span class="p">(</span>
<a id="__codelineno-2-82" name="__codelineno-2-82" href="#__codelineno-2-82"></a>                    <span class="n">saga_id</span><span class="o">=</span><span class="n">saga_id</span><span class="p">,</span>
<a id="__codelineno-2-83" name="__codelineno-2-83" href="#__codelineno-2-83"></a>                    <span class="n">status</span><span class="o">=</span><span class="n">SagaStatus</span><span class="o">.</span><span class="n">STARTED</span><span class="p">,</span>
<a id="__codelineno-2-84" name="__codelineno-2-84" href="#__codelineno-2-84"></a>                    <span class="n">started_at</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">(),</span>
<a id="__codelineno-2-85" name="__codelineno-2-85" href="#__codelineno-2-85"></a>                    <span class="n">current_step</span><span class="o">=</span><span class="s1">&#39;started&#39;</span><span class="p">,</span>
<a id="__codelineno-2-86" name="__codelineno-2-86" href="#__codelineno-2-86"></a>                    <span class="n">completed_steps</span><span class="o">=</span><span class="p">[]</span>
<a id="__codelineno-2-87" name="__codelineno-2-87" href="#__codelineno-2-87"></a>                <span class="p">)</span>
<a id="__codelineno-2-88" name="__codelineno-2-88" href="#__codelineno-2-88"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-2-89" name="__codelineno-2-89" href="#__codelineno-2-89"></a>                <span class="k">return</span>  <span class="c1"># Événement orphelin</span>
<a id="__codelineno-2-90" name="__codelineno-2-90" href="#__codelineno-2-90"></a>
<a id="__codelineno-2-91" name="__codelineno-2-91" href="#__codelineno-2-91"></a>        <span class="c1"># Mise à jour de l&#39;état</span>
<a id="__codelineno-2-92" name="__codelineno-2-92" href="#__codelineno-2-92"></a>        <span class="n">state</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
<a id="__codelineno-2-93" name="__codelineno-2-93" href="#__codelineno-2-93"></a>
<a id="__codelineno-2-94" name="__codelineno-2-94" href="#__codelineno-2-94"></a>        <span class="k">if</span> <span class="n">event_type</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.completed&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;error&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">event</span><span class="p">:</span>
<a id="__codelineno-2-95" name="__codelineno-2-95" href="#__codelineno-2-95"></a>            <span class="n">state</span><span class="o">.</span><span class="n">completed_steps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event_type</span><span class="p">)</span>
<a id="__codelineno-2-96" name="__codelineno-2-96" href="#__codelineno-2-96"></a>            <span class="n">state</span><span class="o">.</span><span class="n">current_step</span> <span class="o">=</span> <span class="n">event_type</span>
<a id="__codelineno-2-97" name="__codelineno-2-97" href="#__codelineno-2-97"></a>
<a id="__codelineno-2-98" name="__codelineno-2-98" href="#__codelineno-2-98"></a>            <span class="c1"># Vérification de la complétion</span>
<a id="__codelineno-2-99" name="__codelineno-2-99" href="#__codelineno-2-99"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_saga_complete</span><span class="p">(</span><span class="n">state</span><span class="p">):</span>
<a id="__codelineno-2-100" name="__codelineno-2-100" href="#__codelineno-2-100"></a>                <span class="n">state</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">SagaStatus</span><span class="o">.</span><span class="n">COMPLETED</span>
<a id="__codelineno-2-101" name="__codelineno-2-101" href="#__codelineno-2-101"></a>
<a id="__codelineno-2-102" name="__codelineno-2-102" href="#__codelineno-2-102"></a>        <span class="k">elif</span> <span class="n">event_type</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.failed&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;error&#39;</span> <span class="ow">in</span> <span class="n">event</span><span class="p">:</span>
<a id="__codelineno-2-103" name="__codelineno-2-103" href="#__codelineno-2-103"></a>            <span class="n">state</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">SagaStatus</span><span class="o">.</span><span class="n">COMPENSATING</span>
<a id="__codelineno-2-104" name="__codelineno-2-104" href="#__codelineno-2-104"></a>            <span class="n">state</span><span class="o">.</span><span class="n">failed_step</span> <span class="o">=</span> <span class="n">event_type</span>
<a id="__codelineno-2-105" name="__codelineno-2-105" href="#__codelineno-2-105"></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_initiate_compensation</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
<a id="__codelineno-2-106" name="__codelineno-2-106" href="#__codelineno-2-106"></a>
<a id="__codelineno-2-107" name="__codelineno-2-107" href="#__codelineno-2-107"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_store</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
<a id="__codelineno-2-108" name="__codelineno-2-108" href="#__codelineno-2-108"></a>
<a id="__codelineno-2-109" name="__codelineno-2-109" href="#__codelineno-2-109"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_is_saga_complete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">SagaState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-2-110" name="__codelineno-2-110" href="#__codelineno-2-110"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Vérifie si la saga est terminée avec succès&quot;&quot;&quot;</span>
<a id="__codelineno-2-111" name="__codelineno-2-111" href="#__codelineno-2-111"></a>        <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="n">step</span> <span class="ow">in</span> <span class="n">state</span><span class="o">.</span><span class="n">completed_steps</span> <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">saga_flow</span><span class="p">)</span>
<a id="__codelineno-2-112" name="__codelineno-2-112" href="#__codelineno-2-112"></a>
<a id="__codelineno-2-113" name="__codelineno-2-113" href="#__codelineno-2-113"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_initiate_compensation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">SagaState</span><span class="p">):</span>
<a id="__codelineno-2-114" name="__codelineno-2-114" href="#__codelineno-2-114"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Déclenche la compensation pour les étapes complétées&quot;&quot;&quot;</span>
<a id="__codelineno-2-115" name="__codelineno-2-115" href="#__codelineno-2-115"></a>        <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">compensation_started</span><span class="p">:</span>
<a id="__codelineno-2-116" name="__codelineno-2-116" href="#__codelineno-2-116"></a>            <span class="k">return</span>
<a id="__codelineno-2-117" name="__codelineno-2-117" href="#__codelineno-2-117"></a>
<a id="__codelineno-2-118" name="__codelineno-2-118" href="#__codelineno-2-118"></a>        <span class="n">state</span><span class="o">.</span><span class="n">compensation_started</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-2-119" name="__codelineno-2-119" href="#__codelineno-2-119"></a>
<a id="__codelineno-2-120" name="__codelineno-2-120" href="#__codelineno-2-120"></a>        <span class="c1"># Compensation en ordre inverse</span>
<a id="__codelineno-2-121" name="__codelineno-2-121" href="#__codelineno-2-121"></a>        <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">completed_steps</span><span class="p">):</span>
<a id="__codelineno-2-122" name="__codelineno-2-122" href="#__codelineno-2-122"></a>            <span class="n">compensation_event_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compensation_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>
<a id="__codelineno-2-123" name="__codelineno-2-123" href="#__codelineno-2-123"></a>            <span class="k">if</span> <span class="n">compensation_event_type</span><span class="p">:</span>
<a id="__codelineno-2-124" name="__codelineno-2-124" href="#__codelineno-2-124"></a>                <span class="n">compensation_event</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-2-125" name="__codelineno-2-125" href="#__codelineno-2-125"></a>                    <span class="s1">&#39;event_id&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()),</span>
<a id="__codelineno-2-126" name="__codelineno-2-126" href="#__codelineno-2-126"></a>                    <span class="s1">&#39;saga_id&#39;</span><span class="p">:</span> <span class="n">state</span><span class="o">.</span><span class="n">saga_id</span><span class="p">,</span>
<a id="__codelineno-2-127" name="__codelineno-2-127" href="#__codelineno-2-127"></a>                    <span class="s1">&#39;event_type&#39;</span><span class="p">:</span> <span class="n">compensation_event_type</span><span class="p">,</span>
<a id="__codelineno-2-128" name="__codelineno-2-128" href="#__codelineno-2-128"></a>                    <span class="s1">&#39;original_step&#39;</span><span class="p">:</span> <span class="n">step</span><span class="p">,</span>
<a id="__codelineno-2-129" name="__codelineno-2-129" href="#__codelineno-2-129"></a>                    <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Compensation due to failure at </span><span class="si">{</span><span class="n">state</span><span class="o">.</span><span class="n">failed_step</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
<a id="__codelineno-2-130" name="__codelineno-2-130" href="#__codelineno-2-130"></a>                    <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
<a id="__codelineno-2-131" name="__codelineno-2-131" href="#__codelineno-2-131"></a>                <span class="p">}</span>
<a id="__codelineno-2-132" name="__codelineno-2-132" href="#__codelineno-2-132"></a>
<a id="__codelineno-2-133" name="__codelineno-2-133" href="#__codelineno-2-133"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_publish_compensation</span><span class="p">(</span><span class="n">compensation_event</span><span class="p">)</span>
<a id="__codelineno-2-134" name="__codelineno-2-134" href="#__codelineno-2-134"></a>
<a id="__codelineno-2-135" name="__codelineno-2-135" href="#__codelineno-2-135"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_check_timeouts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-2-136" name="__codelineno-2-136" href="#__codelineno-2-136"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Vérifie les sagas en timeout&quot;&quot;&quot;</span>
<a id="__codelineno-2-137" name="__codelineno-2-137" href="#__codelineno-2-137"></a>        <span class="n">active_sagas</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_store</span><span class="o">.</span><span class="n">get_active</span><span class="p">()</span>
<a id="__codelineno-2-138" name="__codelineno-2-138" href="#__codelineno-2-138"></a>        <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
<a id="__codelineno-2-139" name="__codelineno-2-139" href="#__codelineno-2-139"></a>
<a id="__codelineno-2-140" name="__codelineno-2-140" href="#__codelineno-2-140"></a>        <span class="k">for</span> <span class="n">saga</span> <span class="ow">in</span> <span class="n">active_sagas</span><span class="p">:</span>
<a id="__codelineno-2-141" name="__codelineno-2-141" href="#__codelineno-2-141"></a>            <span class="c1"># Timeout global de la saga</span>
<a id="__codelineno-2-142" name="__codelineno-2-142" href="#__codelineno-2-142"></a>            <span class="k">if</span> <span class="n">now</span> <span class="o">-</span> <span class="n">saga</span><span class="o">.</span><span class="n">started_at</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">saga_timeout</span><span class="p">:</span>
<a id="__codelineno-2-143" name="__codelineno-2-143" href="#__codelineno-2-143"></a>                <span class="n">saga</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">SagaStatus</span><span class="o">.</span><span class="n">FAILED</span>
<a id="__codelineno-2-144" name="__codelineno-2-144" href="#__codelineno-2-144"></a>                <span class="n">saga</span><span class="o">.</span><span class="n">failed_step</span> <span class="o">=</span> <span class="s1">&#39;timeout&#39;</span>
<a id="__codelineno-2-145" name="__codelineno-2-145" href="#__codelineno-2-145"></a>                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_initiate_compensation</span><span class="p">(</span><span class="n">saga</span><span class="p">)</span>
<a id="__codelineno-2-146" name="__codelineno-2-146" href="#__codelineno-2-146"></a>                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_store</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">saga</span><span class="p">)</span>
<a id="__codelineno-2-147" name="__codelineno-2-147" href="#__codelineno-2-147"></a>
<a id="__codelineno-2-148" name="__codelineno-2-148" href="#__codelineno-2-148"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_publish_compensation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-2-149" name="__codelineno-2-149" href="#__codelineno-2-149"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Publie un événement de compensation&quot;&quot;&quot;</span>
<a id="__codelineno-2-150" name="__codelineno-2-150" href="#__codelineno-2-150"></a>        <span class="n">topic</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;compensation.</span><span class="si">{</span><span class="n">event</span><span class="p">[</span><span class="s1">&#39;original_step&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-2-151" name="__codelineno-2-151" href="#__codelineno-2-151"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">producer</span><span class="o">.</span><span class="n">produce</span><span class="p">(</span>
<a id="__codelineno-2-152" name="__codelineno-2-152" href="#__codelineno-2-152"></a>            <span class="n">topic</span><span class="o">=</span><span class="n">topic</span><span class="p">,</span>
<a id="__codelineno-2-153" name="__codelineno-2-153" href="#__codelineno-2-153"></a>            <span class="n">key</span><span class="o">=</span><span class="n">event</span><span class="p">[</span><span class="s1">&#39;saga_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(),</span>
<a id="__codelineno-2-154" name="__codelineno-2-154" href="#__codelineno-2-154"></a>            <span class="n">value</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">event</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
<a id="__codelineno-2-155" name="__codelineno-2-155" href="#__codelineno-2-155"></a>        <span class="p">)</span>
<a id="__codelineno-2-156" name="__codelineno-2-156" href="#__codelineno-2-156"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">producer</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
</code></pre></div>
<blockquote>
<p><strong>Bonnes pratiques</strong><br />
Conservez un historique complet des événements de chaque saga pour faciliter le débogage et l'audit. Implémentez des mécanismes de retry avec backoff exponentiel pour les compensations qui échouent. Utilisez des identifiants idempotents pour éviter les doubles traitements.</p>
</blockquote>
<hr />
<h2 id="ii92-cqrs-dans-un-contexte-agentique">II.9.2 CQRS dans un Contexte Agentique<a class="headerlink" href="#ii92-cqrs-dans-un-contexte-agentique" title="Permanent link">&para;</a></h2>
<h3 id="principes-fondamentaux-de-cqrs">Principes Fondamentaux de CQRS<a class="headerlink" href="#principes-fondamentaux-de-cqrs" title="Permanent link">&para;</a></h3>
<p>Command Query Responsibility Segregation (CQRS) est un patron architectural qui sépare les opérations de lecture (queries) des opérations d'écriture (commands) en utilisant des modèles distincts. Cette séparation permet d'optimiser chaque côté indépendamment : le modèle de commande peut être normalisé pour garantir la cohérence, tandis que le modèle de lecture peut être dénormalisé pour maximiser les performances des requêtes.</p>
<p>Dans le contexte des systèmes agentiques, CQRS prend une dimension particulière. Les agents cognitifs consomment souvent des informations agrégées provenant de multiples sources pour prendre leurs décisions, tandis que leurs actions génèrent des événements qui modifient l'état du système. La séparation lecture/écriture permet de construire des vues optimisées pour chaque agent sans compromettre l'intégrité du modèle d'écriture.</p>
<p>Le modèle de commande, ou write model, capture l'état autoritatif du système. C'est la source de vérité qui applique les règles métier et garantit la cohérence des données. Le modèle de lecture, ou read model, est une projection optimisée de cet état, mise à jour de manière asynchrone via les événements de domaine. Cette projection peut prendre de multiples formes selon les besoins des consommateurs.</p>
<table>
<thead>
<tr>
<th>Aspect</th>
<th>Write Model</th>
<th>Read Model</th>
</tr>
</thead>
<tbody>
<tr>
<td>Objectif</td>
<td>Cohérence, règles métier</td>
<td>Performance de lecture</td>
</tr>
<tr>
<td>Structure</td>
<td>Normalisée (3NF)</td>
<td>Dénormalisée</td>
</tr>
<tr>
<td>Mise à jour</td>
<td>Synchrone, transactionnelle</td>
<td>Asynchrone, éventuelle</td>
</tr>
<tr>
<td>Stockage typique</td>
<td>SGBD relationnel</td>
<td>NoSQL, cache, search</td>
</tr>
<tr>
<td>Scalabilité</td>
<td>Verticale principalement</td>
<td>Horizontale</td>
</tr>
</tbody>
</table>
<h3 id="architecture-cqrs-pour-systemes-agentiques">Architecture CQRS pour Systèmes Agentiques<a class="headerlink" href="#architecture-cqrs-pour-systemes-agentiques" title="Permanent link">&para;</a></h3>
<p>L'implémentation de CQRS dans un système agentique s'articule autour du backbone événementiel Kafka. Les commandes sont traitées par des handlers dédiés qui appliquent les règles métier et publient des événements de domaine. Ces événements sont consommés par des projecteurs qui maintiennent les différentes vues de lecture. Les agents interrogent ces vues pour obtenir l'information nécessaire à leurs décisions.</p>
<p><strong>Figure II.9.1 --- Architecture CQRS / Event Sourcing dans un contexte agentique</strong></p>
<pre class="mermaid"><code>flowchart LR
    subgraph Ecriture["Côté Écriture (Command)"]
        CMD["Commande"]
        HANDLER["Command Handler&lt;br/&gt;(Règles métier)"]
        ES["Event Store&lt;br/&gt;(Journal immuable)"]
    end

    subgraph Bus["Backbone Événementiel"]
        KAFKA["Bus d'Événements&lt;br/&gt;(Kafka)"]
    end

    subgraph Lecture["Côté Lecture (Query)"]
        PROJ["Projecteurs"]
        VIEW1["Vue Agent&lt;br/&gt;Service Client"]
        VIEW2["Vue Agent&lt;br/&gt;Analytique"]
        VIEW3["Vue Agent&lt;br/&gt;Conformité"]
    end

    subgraph Agents["Agents Cognitifs"]
        AG1["Agent&lt;br/&gt;Décisionnel"]
        AG2["Agent&lt;br/&gt;Audit"]
    end

    CMD --&gt;|"Valider &amp; Exécuter"| HANDLER
    HANDLER --&gt;|"Persister"| ES
    ES --&gt;|"Publier événements"| KAFKA
    KAFKA --&gt;|"Propager"| PROJ
    PROJ --&gt;|"Projections"| VIEW1
    PROJ --&gt;|"Projections"| VIEW2
    PROJ --&gt;|"Projections"| VIEW3
    VIEW1 --&gt;|"Requêtes"| AG1
    VIEW3 --&gt;|"Requêtes"| AG2</code></pre>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="c1"># cqrs/commands.py</span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Optional</span>
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>
<a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">uuid</span>
<a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a>
<a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a><span class="nd">@dataclass</span>
<a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a><span class="k">class</span><span class="w"> </span><span class="nc">Command</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
<a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Classe de base pour les commandes&quot;&quot;&quot;</span>
<a id="__codelineno-3-11" name="__codelineno-3-11" href="#__codelineno-3-11"></a>    <span class="n">command_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()))</span>
<a id="__codelineno-3-12" name="__codelineno-3-12" href="#__codelineno-3-12"></a>    <span class="n">correlation_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-3-13" name="__codelineno-3-13" href="#__codelineno-3-13"></a>    <span class="n">timestamp</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">)</span>
<a id="__codelineno-3-14" name="__codelineno-3-14" href="#__codelineno-3-14"></a>    <span class="n">metadata</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
<a id="__codelineno-3-15" name="__codelineno-3-15" href="#__codelineno-3-15"></a>
<a id="__codelineno-3-16" name="__codelineno-3-16" href="#__codelineno-3-16"></a>    <span class="nd">@abstractmethod</span>
<a id="__codelineno-3-17" name="__codelineno-3-17" href="#__codelineno-3-17"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-3-18" name="__codelineno-3-18" href="#__codelineno-3-18"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Valide la commande&quot;&quot;&quot;</span>
<a id="__codelineno-3-19" name="__codelineno-3-19" href="#__codelineno-3-19"></a>        <span class="k">pass</span>
<a id="__codelineno-3-20" name="__codelineno-3-20" href="#__codelineno-3-20"></a>
<a id="__codelineno-3-21" name="__codelineno-3-21" href="#__codelineno-3-21"></a><span class="nd">@dataclass</span>
<a id="__codelineno-3-22" name="__codelineno-3-22" href="#__codelineno-3-22"></a><span class="k">class</span><span class="w"> </span><span class="nc">CreateCustomerCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">):</span>
<a id="__codelineno-3-23" name="__codelineno-3-23" href="#__codelineno-3-23"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Commande de création d&#39;un client&quot;&quot;&quot;</span>
<a id="__codelineno-3-24" name="__codelineno-3-24" href="#__codelineno-3-24"></a>    <span class="n">customer_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-3-25" name="__codelineno-3-25" href="#__codelineno-3-25"></a>    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-3-26" name="__codelineno-3-26" href="#__codelineno-3-26"></a>    <span class="n">email</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-3-27" name="__codelineno-3-27" href="#__codelineno-3-27"></a>    <span class="n">phone</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-3-28" name="__codelineno-3-28" href="#__codelineno-3-28"></a>    <span class="n">address</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-3-29" name="__codelineno-3-29" href="#__codelineno-3-29"></a>
<a id="__codelineno-3-30" name="__codelineno-3-30" href="#__codelineno-3-30"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-3-31" name="__codelineno-3-31" href="#__codelineno-3-31"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
<a id="__codelineno-3-32" name="__codelineno-3-32" href="#__codelineno-3-32"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Le nom doit contenir au moins 2 caractères&quot;</span><span class="p">)</span>
<a id="__codelineno-3-33" name="__codelineno-3-33" href="#__codelineno-3-33"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">email</span> <span class="ow">or</span> <span class="s1">&#39;@&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">email</span><span class="p">:</span>
<a id="__codelineno-3-34" name="__codelineno-3-34" href="#__codelineno-3-34"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Email invalide&quot;</span><span class="p">)</span>
<a id="__codelineno-3-35" name="__codelineno-3-35" href="#__codelineno-3-35"></a>        <span class="k">return</span> <span class="kc">True</span>
<a id="__codelineno-3-36" name="__codelineno-3-36" href="#__codelineno-3-36"></a>
<a id="__codelineno-3-37" name="__codelineno-3-37" href="#__codelineno-3-37"></a><span class="nd">@dataclass</span>
<a id="__codelineno-3-38" name="__codelineno-3-38" href="#__codelineno-3-38"></a><span class="k">class</span><span class="w"> </span><span class="nc">UpdateCustomerCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">):</span>
<a id="__codelineno-3-39" name="__codelineno-3-39" href="#__codelineno-3-39"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Commande de mise à jour d&#39;un client&quot;&quot;&quot;</span>
<a id="__codelineno-3-40" name="__codelineno-3-40" href="#__codelineno-3-40"></a>    <span class="n">customer_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-3-41" name="__codelineno-3-41" href="#__codelineno-3-41"></a>    <span class="n">updates</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
<a id="__codelineno-3-42" name="__codelineno-3-42" href="#__codelineno-3-42"></a>
<a id="__codelineno-3-43" name="__codelineno-3-43" href="#__codelineno-3-43"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-3-44" name="__codelineno-3-44" href="#__codelineno-3-44"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">customer_id</span><span class="p">:</span>
<a id="__codelineno-3-45" name="__codelineno-3-45" href="#__codelineno-3-45"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;customer_id requis&quot;</span><span class="p">)</span>
<a id="__codelineno-3-46" name="__codelineno-3-46" href="#__codelineno-3-46"></a>        <span class="k">if</span> <span class="s1">&#39;email&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">updates</span> <span class="ow">and</span> <span class="s1">&#39;@&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">updates</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">]:</span>
<a id="__codelineno-3-47" name="__codelineno-3-47" href="#__codelineno-3-47"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Email invalide&quot;</span><span class="p">)</span>
<a id="__codelineno-3-48" name="__codelineno-3-48" href="#__codelineno-3-48"></a>        <span class="k">return</span> <span class="kc">True</span>
<a id="__codelineno-3-49" name="__codelineno-3-49" href="#__codelineno-3-49"></a>
<a id="__codelineno-3-50" name="__codelineno-3-50" href="#__codelineno-3-50"></a><span class="nd">@dataclass</span>
<a id="__codelineno-3-51" name="__codelineno-3-51" href="#__codelineno-3-51"></a><span class="k">class</span><span class="w"> </span><span class="nc">ProcessInteractionCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">):</span>
<a id="__codelineno-3-52" name="__codelineno-3-52" href="#__codelineno-3-52"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Commande de traitement d&#39;une interaction agent&quot;&quot;&quot;</span>
<a id="__codelineno-3-53" name="__codelineno-3-53" href="#__codelineno-3-53"></a>    <span class="n">customer_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-3-54" name="__codelineno-3-54" href="#__codelineno-3-54"></a>    <span class="n">agent_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-3-55" name="__codelineno-3-55" href="#__codelineno-3-55"></a>    <span class="n">interaction_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-3-56" name="__codelineno-3-56" href="#__codelineno-3-56"></a>    <span class="n">content</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
<a id="__codelineno-3-57" name="__codelineno-3-57" href="#__codelineno-3-57"></a>    <span class="n">resolution</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-3-58" name="__codelineno-3-58" href="#__codelineno-3-58"></a>    <span class="n">sentiment_score</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-3-59" name="__codelineno-3-59" href="#__codelineno-3-59"></a>
<a id="__codelineno-3-60" name="__codelineno-3-60" href="#__codelineno-3-60"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-3-61" name="__codelineno-3-61" href="#__codelineno-3-61"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">customer_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">interaction_type</span><span class="p">]):</span>
<a id="__codelineno-3-62" name="__codelineno-3-62" href="#__codelineno-3-62"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;customer_id, agent_id et interaction_type requis&quot;</span><span class="p">)</span>
<a id="__codelineno-3-63" name="__codelineno-3-63" href="#__codelineno-3-63"></a>        <span class="k">return</span> <span class="kc">True</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="c1"># cqrs/command_handlers.py</span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span>
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a>
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a><span class="k">class</span><span class="w"> </span><span class="nc">CommandHandler</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
<a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Interface pour les handlers de commandes&quot;&quot;&quot;</span>
<a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a>
<a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a>    <span class="nd">@abstractmethod</span>
<a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">handle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command</span><span class="p">:</span> <span class="n">Command</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">DomainEvent</span><span class="p">]:</span>
<a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Traite une commande et retourne les événements générés&quot;&quot;&quot;</span>
<a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a>        <span class="k">pass</span>
<a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a>
<a id="__codelineno-4-13" name="__codelineno-4-13" href="#__codelineno-4-13"></a><span class="k">class</span><span class="w"> </span><span class="nc">CustomerCommandHandler</span><span class="p">(</span><span class="n">CommandHandler</span><span class="p">):</span>
<a id="__codelineno-4-14" name="__codelineno-4-14" href="#__codelineno-4-14"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Handler pour les commandes relatives aux clients&quot;&quot;&quot;</span>
<a id="__codelineno-4-15" name="__codelineno-4-15" href="#__codelineno-4-15"></a>
<a id="__codelineno-4-16" name="__codelineno-4-16" href="#__codelineno-4-16"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">repository</span><span class="p">,</span> <span class="n">event_publisher</span><span class="p">,</span> <span class="n">validator</span><span class="p">):</span>
<a id="__codelineno-4-17" name="__codelineno-4-17" href="#__codelineno-4-17"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">repository</span> <span class="o">=</span> <span class="n">repository</span>
<a id="__codelineno-4-18" name="__codelineno-4-18" href="#__codelineno-4-18"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">publisher</span> <span class="o">=</span> <span class="n">event_publisher</span>
<a id="__codelineno-4-19" name="__codelineno-4-19" href="#__codelineno-4-19"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">validator</span> <span class="o">=</span> <span class="n">validator</span>
<a id="__codelineno-4-20" name="__codelineno-4-20" href="#__codelineno-4-20"></a>
<a id="__codelineno-4-21" name="__codelineno-4-21" href="#__codelineno-4-21"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">handle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command</span><span class="p">:</span> <span class="n">Command</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">DomainEvent</span><span class="p">]:</span>
<a id="__codelineno-4-22" name="__codelineno-4-22" href="#__codelineno-4-22"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Dispatch vers le handler approprié&quot;&quot;&quot;</span>
<a id="__codelineno-4-23" name="__codelineno-4-23" href="#__codelineno-4-23"></a>        <span class="n">handlers</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-4-24" name="__codelineno-4-24" href="#__codelineno-4-24"></a>            <span class="n">CreateCustomerCommand</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_create</span><span class="p">,</span>
<a id="__codelineno-4-25" name="__codelineno-4-25" href="#__codelineno-4-25"></a>            <span class="n">UpdateCustomerCommand</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_update</span><span class="p">,</span>
<a id="__codelineno-4-26" name="__codelineno-4-26" href="#__codelineno-4-26"></a>            <span class="n">ProcessInteractionCommand</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_interaction</span>
<a id="__codelineno-4-27" name="__codelineno-4-27" href="#__codelineno-4-27"></a>        <span class="p">}</span>
<a id="__codelineno-4-28" name="__codelineno-4-28" href="#__codelineno-4-28"></a>
<a id="__codelineno-4-29" name="__codelineno-4-29" href="#__codelineno-4-29"></a>        <span class="n">handler</span> <span class="o">=</span> <span class="n">handlers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">command</span><span class="p">))</span>
<a id="__codelineno-4-30" name="__codelineno-4-30" href="#__codelineno-4-30"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">handler</span><span class="p">:</span>
<a id="__codelineno-4-31" name="__codelineno-4-31" href="#__codelineno-4-31"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Handler non trouvé pour </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">command</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-4-32" name="__codelineno-4-32" href="#__codelineno-4-32"></a>
<a id="__codelineno-4-33" name="__codelineno-4-33" href="#__codelineno-4-33"></a>        <span class="c1"># Validation</span>
<a id="__codelineno-4-34" name="__codelineno-4-34" href="#__codelineno-4-34"></a>        <span class="n">command</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>
<a id="__codelineno-4-35" name="__codelineno-4-35" href="#__codelineno-4-35"></a>
<a id="__codelineno-4-36" name="__codelineno-4-36" href="#__codelineno-4-36"></a>        <span class="c1"># Exécution et publication des événements</span>
<a id="__codelineno-4-37" name="__codelineno-4-37" href="#__codelineno-4-37"></a>        <span class="n">events</span> <span class="o">=</span> <span class="k">await</span> <span class="n">handler</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
<a id="__codelineno-4-38" name="__codelineno-4-38" href="#__codelineno-4-38"></a>        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span>
<a id="__codelineno-4-39" name="__codelineno-4-39" href="#__codelineno-4-39"></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">publisher</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
<a id="__codelineno-4-40" name="__codelineno-4-40" href="#__codelineno-4-40"></a>
<a id="__codelineno-4-41" name="__codelineno-4-41" href="#__codelineno-4-41"></a>        <span class="k">return</span> <span class="n">events</span>
<a id="__codelineno-4-42" name="__codelineno-4-42" href="#__codelineno-4-42"></a>
<a id="__codelineno-4-43" name="__codelineno-4-43" href="#__codelineno-4-43"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_handle_create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">:</span> <span class="n">CreateCustomerCommand</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">DomainEvent</span><span class="p">]:</span>
<a id="__codelineno-4-44" name="__codelineno-4-44" href="#__codelineno-4-44"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Traite la création d&#39;un client&quot;&quot;&quot;</span>
<a id="__codelineno-4-45" name="__codelineno-4-45" href="#__codelineno-4-45"></a>
<a id="__codelineno-4-46" name="__codelineno-4-46" href="#__codelineno-4-46"></a>        <span class="c1"># Vérification de l&#39;unicité</span>
<a id="__codelineno-4-47" name="__codelineno-4-47" href="#__codelineno-4-47"></a>        <span class="n">existing</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">repository</span><span class="o">.</span><span class="n">find_by_email</span><span class="p">(</span><span class="n">cmd</span><span class="o">.</span><span class="n">email</span><span class="p">)</span>
<a id="__codelineno-4-48" name="__codelineno-4-48" href="#__codelineno-4-48"></a>        <span class="k">if</span> <span class="n">existing</span><span class="p">:</span>
<a id="__codelineno-4-49" name="__codelineno-4-49" href="#__codelineno-4-49"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Un client existe déjà avec l&#39;email </span><span class="si">{</span><span class="n">cmd</span><span class="o">.</span><span class="n">email</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-4-50" name="__codelineno-4-50" href="#__codelineno-4-50"></a>
<a id="__codelineno-4-51" name="__codelineno-4-51" href="#__codelineno-4-51"></a>        <span class="c1"># Création de l&#39;agrégat</span>
<a id="__codelineno-4-52" name="__codelineno-4-52" href="#__codelineno-4-52"></a>        <span class="n">customer</span> <span class="o">=</span> <span class="n">Customer</span><span class="p">(</span>
<a id="__codelineno-4-53" name="__codelineno-4-53" href="#__codelineno-4-53"></a>            <span class="n">customer_id</span><span class="o">=</span><span class="n">cmd</span><span class="o">.</span><span class="n">customer_id</span> <span class="ow">or</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()),</span>
<a id="__codelineno-4-54" name="__codelineno-4-54" href="#__codelineno-4-54"></a>            <span class="n">name</span><span class="o">=</span><span class="n">cmd</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-4-55" name="__codelineno-4-55" href="#__codelineno-4-55"></a>            <span class="n">email</span><span class="o">=</span><span class="n">cmd</span><span class="o">.</span><span class="n">email</span><span class="p">,</span>
<a id="__codelineno-4-56" name="__codelineno-4-56" href="#__codelineno-4-56"></a>            <span class="n">phone</span><span class="o">=</span><span class="n">cmd</span><span class="o">.</span><span class="n">phone</span><span class="p">,</span>
<a id="__codelineno-4-57" name="__codelineno-4-57" href="#__codelineno-4-57"></a>            <span class="n">address</span><span class="o">=</span><span class="n">cmd</span><span class="o">.</span><span class="n">address</span>
<a id="__codelineno-4-58" name="__codelineno-4-58" href="#__codelineno-4-58"></a>        <span class="p">)</span>
<a id="__codelineno-4-59" name="__codelineno-4-59" href="#__codelineno-4-59"></a>
<a id="__codelineno-4-60" name="__codelineno-4-60" href="#__codelineno-4-60"></a>        <span class="c1"># Persistance</span>
<a id="__codelineno-4-61" name="__codelineno-4-61" href="#__codelineno-4-61"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">repository</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">customer</span><span class="p">)</span>
<a id="__codelineno-4-62" name="__codelineno-4-62" href="#__codelineno-4-62"></a>
<a id="__codelineno-4-63" name="__codelineno-4-63" href="#__codelineno-4-63"></a>        <span class="c1"># Génération de l&#39;événement</span>
<a id="__codelineno-4-64" name="__codelineno-4-64" href="#__codelineno-4-64"></a>        <span class="k">return</span> <span class="p">[</span><span class="n">CustomerCreatedEvent</span><span class="p">(</span>
<a id="__codelineno-4-65" name="__codelineno-4-65" href="#__codelineno-4-65"></a>            <span class="n">event_id</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()),</span>
<a id="__codelineno-4-66" name="__codelineno-4-66" href="#__codelineno-4-66"></a>            <span class="n">aggregate_id</span><span class="o">=</span><span class="n">customer</span><span class="o">.</span><span class="n">customer_id</span><span class="p">,</span>
<a id="__codelineno-4-67" name="__codelineno-4-67" href="#__codelineno-4-67"></a>            <span class="n">correlation_id</span><span class="o">=</span><span class="n">cmd</span><span class="o">.</span><span class="n">correlation_id</span><span class="p">,</span>
<a id="__codelineno-4-68" name="__codelineno-4-68" href="#__codelineno-4-68"></a>            <span class="n">customer_id</span><span class="o">=</span><span class="n">customer</span><span class="o">.</span><span class="n">customer_id</span><span class="p">,</span>
<a id="__codelineno-4-69" name="__codelineno-4-69" href="#__codelineno-4-69"></a>            <span class="n">name</span><span class="o">=</span><span class="n">customer</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-4-70" name="__codelineno-4-70" href="#__codelineno-4-70"></a>            <span class="n">email</span><span class="o">=</span><span class="n">customer</span><span class="o">.</span><span class="n">email</span><span class="p">,</span>
<a id="__codelineno-4-71" name="__codelineno-4-71" href="#__codelineno-4-71"></a>            <span class="n">timestamp</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
<a id="__codelineno-4-72" name="__codelineno-4-72" href="#__codelineno-4-72"></a>        <span class="p">)]</span>
<a id="__codelineno-4-73" name="__codelineno-4-73" href="#__codelineno-4-73"></a>
<a id="__codelineno-4-74" name="__codelineno-4-74" href="#__codelineno-4-74"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_handle_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">:</span> <span class="n">UpdateCustomerCommand</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">DomainEvent</span><span class="p">]:</span>
<a id="__codelineno-4-75" name="__codelineno-4-75" href="#__codelineno-4-75"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Traite la mise à jour d&#39;un client&quot;&quot;&quot;</span>
<a id="__codelineno-4-76" name="__codelineno-4-76" href="#__codelineno-4-76"></a>
<a id="__codelineno-4-77" name="__codelineno-4-77" href="#__codelineno-4-77"></a>        <span class="n">customer</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">repository</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cmd</span><span class="o">.</span><span class="n">customer_id</span><span class="p">)</span>
<a id="__codelineno-4-78" name="__codelineno-4-78" href="#__codelineno-4-78"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">customer</span><span class="p">:</span>
<a id="__codelineno-4-79" name="__codelineno-4-79" href="#__codelineno-4-79"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Client </span><span class="si">{</span><span class="n">cmd</span><span class="o">.</span><span class="n">customer_id</span><span class="si">}</span><span class="s2"> non trouvé&quot;</span><span class="p">)</span>
<a id="__codelineno-4-80" name="__codelineno-4-80" href="#__codelineno-4-80"></a>
<a id="__codelineno-4-81" name="__codelineno-4-81" href="#__codelineno-4-81"></a>        <span class="c1"># Application des modifications</span>
<a id="__codelineno-4-82" name="__codelineno-4-82" href="#__codelineno-4-82"></a>        <span class="n">old_values</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-4-83" name="__codelineno-4-83" href="#__codelineno-4-83"></a>        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">cmd</span><span class="o">.</span><span class="n">updates</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-4-84" name="__codelineno-4-84" href="#__codelineno-4-84"></a>            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">customer</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
<a id="__codelineno-4-85" name="__codelineno-4-85" href="#__codelineno-4-85"></a>                <span class="n">old_values</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">customer</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
<a id="__codelineno-4-86" name="__codelineno-4-86" href="#__codelineno-4-86"></a>                <span class="nb">setattr</span><span class="p">(</span><span class="n">customer</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
<a id="__codelineno-4-87" name="__codelineno-4-87" href="#__codelineno-4-87"></a>
<a id="__codelineno-4-88" name="__codelineno-4-88" href="#__codelineno-4-88"></a>        <span class="c1"># Persistance</span>
<a id="__codelineno-4-89" name="__codelineno-4-89" href="#__codelineno-4-89"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">repository</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">customer</span><span class="p">)</span>
<a id="__codelineno-4-90" name="__codelineno-4-90" href="#__codelineno-4-90"></a>
<a id="__codelineno-4-91" name="__codelineno-4-91" href="#__codelineno-4-91"></a>        <span class="c1"># Génération de l&#39;événement</span>
<a id="__codelineno-4-92" name="__codelineno-4-92" href="#__codelineno-4-92"></a>        <span class="k">return</span> <span class="p">[</span><span class="n">CustomerUpdatedEvent</span><span class="p">(</span>
<a id="__codelineno-4-93" name="__codelineno-4-93" href="#__codelineno-4-93"></a>            <span class="n">event_id</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()),</span>
<a id="__codelineno-4-94" name="__codelineno-4-94" href="#__codelineno-4-94"></a>            <span class="n">aggregate_id</span><span class="o">=</span><span class="n">customer</span><span class="o">.</span><span class="n">customer_id</span><span class="p">,</span>
<a id="__codelineno-4-95" name="__codelineno-4-95" href="#__codelineno-4-95"></a>            <span class="n">correlation_id</span><span class="o">=</span><span class="n">cmd</span><span class="o">.</span><span class="n">correlation_id</span><span class="p">,</span>
<a id="__codelineno-4-96" name="__codelineno-4-96" href="#__codelineno-4-96"></a>            <span class="n">customer_id</span><span class="o">=</span><span class="n">customer</span><span class="o">.</span><span class="n">customer_id</span><span class="p">,</span>
<a id="__codelineno-4-97" name="__codelineno-4-97" href="#__codelineno-4-97"></a>            <span class="n">changes</span><span class="o">=</span><span class="n">cmd</span><span class="o">.</span><span class="n">updates</span><span class="p">,</span>
<a id="__codelineno-4-98" name="__codelineno-4-98" href="#__codelineno-4-98"></a>            <span class="n">previous_values</span><span class="o">=</span><span class="n">old_values</span><span class="p">,</span>
<a id="__codelineno-4-99" name="__codelineno-4-99" href="#__codelineno-4-99"></a>            <span class="n">timestamp</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
<a id="__codelineno-4-100" name="__codelineno-4-100" href="#__codelineno-4-100"></a>        <span class="p">)]</span>
<a id="__codelineno-4-101" name="__codelineno-4-101" href="#__codelineno-4-101"></a>
<a id="__codelineno-4-102" name="__codelineno-4-102" href="#__codelineno-4-102"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_handle_interaction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">:</span> <span class="n">ProcessInteractionCommand</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">DomainEvent</span><span class="p">]:</span>
<a id="__codelineno-4-103" name="__codelineno-4-103" href="#__codelineno-4-103"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Traite une interaction avec un agent&quot;&quot;&quot;</span>
<a id="__codelineno-4-104" name="__codelineno-4-104" href="#__codelineno-4-104"></a>
<a id="__codelineno-4-105" name="__codelineno-4-105" href="#__codelineno-4-105"></a>        <span class="n">customer</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">repository</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cmd</span><span class="o">.</span><span class="n">customer_id</span><span class="p">)</span>
<a id="__codelineno-4-106" name="__codelineno-4-106" href="#__codelineno-4-106"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">customer</span><span class="p">:</span>
<a id="__codelineno-4-107" name="__codelineno-4-107" href="#__codelineno-4-107"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Client </span><span class="si">{</span><span class="n">cmd</span><span class="o">.</span><span class="n">customer_id</span><span class="si">}</span><span class="s2"> non trouvé&quot;</span><span class="p">)</span>
<a id="__codelineno-4-108" name="__codelineno-4-108" href="#__codelineno-4-108"></a>
<a id="__codelineno-4-109" name="__codelineno-4-109" href="#__codelineno-4-109"></a>        <span class="c1"># Enregistrement de l&#39;interaction</span>
<a id="__codelineno-4-110" name="__codelineno-4-110" href="#__codelineno-4-110"></a>        <span class="n">interaction</span> <span class="o">=</span> <span class="n">Interaction</span><span class="p">(</span>
<a id="__codelineno-4-111" name="__codelineno-4-111" href="#__codelineno-4-111"></a>            <span class="n">interaction_id</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()),</span>
<a id="__codelineno-4-112" name="__codelineno-4-112" href="#__codelineno-4-112"></a>            <span class="n">customer_id</span><span class="o">=</span><span class="n">cmd</span><span class="o">.</span><span class="n">customer_id</span><span class="p">,</span>
<a id="__codelineno-4-113" name="__codelineno-4-113" href="#__codelineno-4-113"></a>            <span class="n">agent_id</span><span class="o">=</span><span class="n">cmd</span><span class="o">.</span><span class="n">agent_id</span><span class="p">,</span>
<a id="__codelineno-4-114" name="__codelineno-4-114" href="#__codelineno-4-114"></a>            <span class="n">interaction_type</span><span class="o">=</span><span class="n">cmd</span><span class="o">.</span><span class="n">interaction_type</span><span class="p">,</span>
<a id="__codelineno-4-115" name="__codelineno-4-115" href="#__codelineno-4-115"></a>            <span class="n">content</span><span class="o">=</span><span class="n">cmd</span><span class="o">.</span><span class="n">content</span><span class="p">,</span>
<a id="__codelineno-4-116" name="__codelineno-4-116" href="#__codelineno-4-116"></a>            <span class="n">resolution</span><span class="o">=</span><span class="n">cmd</span><span class="o">.</span><span class="n">resolution</span><span class="p">,</span>
<a id="__codelineno-4-117" name="__codelineno-4-117" href="#__codelineno-4-117"></a>            <span class="n">sentiment_score</span><span class="o">=</span><span class="n">cmd</span><span class="o">.</span><span class="n">sentiment_score</span><span class="p">,</span>
<a id="__codelineno-4-118" name="__codelineno-4-118" href="#__codelineno-4-118"></a>            <span class="n">timestamp</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
<a id="__codelineno-4-119" name="__codelineno-4-119" href="#__codelineno-4-119"></a>        <span class="p">)</span>
<a id="__codelineno-4-120" name="__codelineno-4-120" href="#__codelineno-4-120"></a>
<a id="__codelineno-4-121" name="__codelineno-4-121" href="#__codelineno-4-121"></a>        <span class="n">customer</span><span class="o">.</span><span class="n">interactions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">interaction</span><span class="p">)</span>
<a id="__codelineno-4-122" name="__codelineno-4-122" href="#__codelineno-4-122"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">repository</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">customer</span><span class="p">)</span>
<a id="__codelineno-4-123" name="__codelineno-4-123" href="#__codelineno-4-123"></a>
<a id="__codelineno-4-124" name="__codelineno-4-124" href="#__codelineno-4-124"></a>        <span class="c1"># Génération de l&#39;événement</span>
<a id="__codelineno-4-125" name="__codelineno-4-125" href="#__codelineno-4-125"></a>        <span class="k">return</span> <span class="p">[</span><span class="n">InteractionRecordedEvent</span><span class="p">(</span>
<a id="__codelineno-4-126" name="__codelineno-4-126" href="#__codelineno-4-126"></a>            <span class="n">event_id</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()),</span>
<a id="__codelineno-4-127" name="__codelineno-4-127" href="#__codelineno-4-127"></a>            <span class="n">aggregate_id</span><span class="o">=</span><span class="n">customer</span><span class="o">.</span><span class="n">customer_id</span><span class="p">,</span>
<a id="__codelineno-4-128" name="__codelineno-4-128" href="#__codelineno-4-128"></a>            <span class="n">correlation_id</span><span class="o">=</span><span class="n">cmd</span><span class="o">.</span><span class="n">correlation_id</span><span class="p">,</span>
<a id="__codelineno-4-129" name="__codelineno-4-129" href="#__codelineno-4-129"></a>            <span class="n">customer_id</span><span class="o">=</span><span class="n">cmd</span><span class="o">.</span><span class="n">customer_id</span><span class="p">,</span>
<a id="__codelineno-4-130" name="__codelineno-4-130" href="#__codelineno-4-130"></a>            <span class="n">agent_id</span><span class="o">=</span><span class="n">cmd</span><span class="o">.</span><span class="n">agent_id</span><span class="p">,</span>
<a id="__codelineno-4-131" name="__codelineno-4-131" href="#__codelineno-4-131"></a>            <span class="n">interaction_id</span><span class="o">=</span><span class="n">interaction</span><span class="o">.</span><span class="n">interaction_id</span><span class="p">,</span>
<a id="__codelineno-4-132" name="__codelineno-4-132" href="#__codelineno-4-132"></a>            <span class="n">interaction_type</span><span class="o">=</span><span class="n">cmd</span><span class="o">.</span><span class="n">interaction_type</span><span class="p">,</span>
<a id="__codelineno-4-133" name="__codelineno-4-133" href="#__codelineno-4-133"></a>            <span class="n">sentiment_score</span><span class="o">=</span><span class="n">cmd</span><span class="o">.</span><span class="n">sentiment_score</span><span class="p">,</span>
<a id="__codelineno-4-134" name="__codelineno-4-134" href="#__codelineno-4-134"></a>            <span class="n">timestamp</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
<a id="__codelineno-4-135" name="__codelineno-4-135" href="#__codelineno-4-135"></a>        <span class="p">)]</span>
</code></pre></div>
<h3 id="projecteurs-et-modeles-de-lecture">Projecteurs et Modèles de Lecture<a class="headerlink" href="#projecteurs-et-modeles-de-lecture" title="Permanent link">&para;</a></h3>
<p>Les projecteurs sont responsables de la transformation des événements de domaine en vues de lecture optimisées. Chaque projecteur maintient une ou plusieurs vues spécialisées, mises à jour de manière idempotente à partir du flux d'événements. L'idempotence est cruciale car un événement peut être traité plusieurs fois en cas de redémarrage ou de rééquilibrage des consommateurs.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="c1"># cqrs/projectors.py</span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">List</span>
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a>
<a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a><span class="k">class</span><span class="w"> </span><span class="nc">Projector</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
<a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Classe de base pour les projecteurs&quot;&quot;&quot;</span>
<a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a>
<a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a>    <span class="nd">@abstractmethod</span>
<a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">project</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="n">DomainEvent</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Projette un événement vers le modèle de lecture&quot;&quot;&quot;</span>
<a id="__codelineno-5-12" name="__codelineno-5-12" href="#__codelineno-5-12"></a>        <span class="k">pass</span>
<a id="__codelineno-5-13" name="__codelineno-5-13" href="#__codelineno-5-13"></a>
<a id="__codelineno-5-14" name="__codelineno-5-14" href="#__codelineno-5-14"></a>    <span class="nd">@abstractmethod</span>
<a id="__codelineno-5-15" name="__codelineno-5-15" href="#__codelineno-5-15"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">handles</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<a id="__codelineno-5-16" name="__codelineno-5-16" href="#__codelineno-5-16"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Retourne la liste des types d&#39;événements gérés&quot;&quot;&quot;</span>
<a id="__codelineno-5-17" name="__codelineno-5-17" href="#__codelineno-5-17"></a>        <span class="k">pass</span>
<a id="__codelineno-5-18" name="__codelineno-5-18" href="#__codelineno-5-18"></a>
<a id="__codelineno-5-19" name="__codelineno-5-19" href="#__codelineno-5-19"></a><span class="k">class</span><span class="w"> </span><span class="nc">CustomerProfileProjector</span><span class="p">(</span><span class="n">Projector</span><span class="p">):</span>
<a id="__codelineno-5-20" name="__codelineno-5-20" href="#__codelineno-5-20"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Projecteur pour la vue profil client&quot;&quot;&quot;</span>
<a id="__codelineno-5-21" name="__codelineno-5-21" href="#__codelineno-5-21"></a>
<a id="__codelineno-5-22" name="__codelineno-5-22" href="#__codelineno-5-22"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">read_store</span><span class="p">):</span>
<a id="__codelineno-5-23" name="__codelineno-5-23" href="#__codelineno-5-23"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">store</span> <span class="o">=</span> <span class="n">read_store</span>
<a id="__codelineno-5-24" name="__codelineno-5-24" href="#__codelineno-5-24"></a>
<a id="__codelineno-5-25" name="__codelineno-5-25" href="#__codelineno-5-25"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">handles</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<a id="__codelineno-5-26" name="__codelineno-5-26" href="#__codelineno-5-26"></a>        <span class="k">return</span> <span class="p">[</span>
<a id="__codelineno-5-27" name="__codelineno-5-27" href="#__codelineno-5-27"></a>            <span class="s1">&#39;customer.created&#39;</span><span class="p">,</span>
<a id="__codelineno-5-28" name="__codelineno-5-28" href="#__codelineno-5-28"></a>            <span class="s1">&#39;customer.updated&#39;</span><span class="p">,</span>
<a id="__codelineno-5-29" name="__codelineno-5-29" href="#__codelineno-5-29"></a>            <span class="s1">&#39;interaction.recorded&#39;</span>
<a id="__codelineno-5-30" name="__codelineno-5-30" href="#__codelineno-5-30"></a>        <span class="p">]</span>
<a id="__codelineno-5-31" name="__codelineno-5-31" href="#__codelineno-5-31"></a>
<a id="__codelineno-5-32" name="__codelineno-5-32" href="#__codelineno-5-32"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">project</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="n">DomainEvent</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-5-33" name="__codelineno-5-33" href="#__codelineno-5-33"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Projette un événement vers la vue profil client&quot;&quot;&quot;</span>
<a id="__codelineno-5-34" name="__codelineno-5-34" href="#__codelineno-5-34"></a>
<a id="__codelineno-5-35" name="__codelineno-5-35" href="#__codelineno-5-35"></a>        <span class="n">handlers</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-5-36" name="__codelineno-5-36" href="#__codelineno-5-36"></a>            <span class="s1">&#39;customer.created&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_project_created</span><span class="p">,</span>
<a id="__codelineno-5-37" name="__codelineno-5-37" href="#__codelineno-5-37"></a>            <span class="s1">&#39;customer.updated&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_project_updated</span><span class="p">,</span>
<a id="__codelineno-5-38" name="__codelineno-5-38" href="#__codelineno-5-38"></a>            <span class="s1">&#39;interaction.recorded&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_project_interaction</span>
<a id="__codelineno-5-39" name="__codelineno-5-39" href="#__codelineno-5-39"></a>        <span class="p">}</span>
<a id="__codelineno-5-40" name="__codelineno-5-40" href="#__codelineno-5-40"></a>
<a id="__codelineno-5-41" name="__codelineno-5-41" href="#__codelineno-5-41"></a>        <span class="n">handler</span> <span class="o">=</span> <span class="n">handlers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">event_type</span><span class="p">)</span>
<a id="__codelineno-5-42" name="__codelineno-5-42" href="#__codelineno-5-42"></a>        <span class="k">if</span> <span class="n">handler</span><span class="p">:</span>
<a id="__codelineno-5-43" name="__codelineno-5-43" href="#__codelineno-5-43"></a>            <span class="k">await</span> <span class="n">handler</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
<a id="__codelineno-5-44" name="__codelineno-5-44" href="#__codelineno-5-44"></a>
<a id="__codelineno-5-45" name="__codelineno-5-45" href="#__codelineno-5-45"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_project_created</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="n">CustomerCreatedEvent</span><span class="p">):</span>
<a id="__codelineno-5-46" name="__codelineno-5-46" href="#__codelineno-5-46"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Projette la création d&#39;un client&quot;&quot;&quot;</span>
<a id="__codelineno-5-47" name="__codelineno-5-47" href="#__codelineno-5-47"></a>        <span class="n">profile</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-5-48" name="__codelineno-5-48" href="#__codelineno-5-48"></a>            <span class="s1">&#39;customer_id&#39;</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">customer_id</span><span class="p">,</span>
<a id="__codelineno-5-49" name="__codelineno-5-49" href="#__codelineno-5-49"></a>            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-5-50" name="__codelineno-5-50" href="#__codelineno-5-50"></a>            <span class="s1">&#39;email&#39;</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">email</span><span class="p">,</span>
<a id="__codelineno-5-51" name="__codelineno-5-51" href="#__codelineno-5-51"></a>            <span class="s1">&#39;created_at&#39;</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">timestamp</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
<a id="__codelineno-5-52" name="__codelineno-5-52" href="#__codelineno-5-52"></a>            <span class="s1">&#39;total_interactions&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-5-53" name="__codelineno-5-53" href="#__codelineno-5-53"></a>            <span class="s1">&#39;last_interaction&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-5-54" name="__codelineno-5-54" href="#__codelineno-5-54"></a>            <span class="s1">&#39;sentiment_trend&#39;</span><span class="p">:</span> <span class="p">[],</span>
<a id="__codelineno-5-55" name="__codelineno-5-55" href="#__codelineno-5-55"></a>            <span class="s1">&#39;preferred_channels&#39;</span><span class="p">:</span> <span class="p">[],</span>
<a id="__codelineno-5-56" name="__codelineno-5-56" href="#__codelineno-5-56"></a>            <span class="s1">&#39;version&#39;</span><span class="p">:</span> <span class="mi">1</span>
<a id="__codelineno-5-57" name="__codelineno-5-57" href="#__codelineno-5-57"></a>        <span class="p">}</span>
<a id="__codelineno-5-58" name="__codelineno-5-58" href="#__codelineno-5-58"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">upsert</span><span class="p">(</span><span class="s1">&#39;customer_profiles&#39;</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">customer_id</span><span class="p">,</span> <span class="n">profile</span><span class="p">)</span>
<a id="__codelineno-5-59" name="__codelineno-5-59" href="#__codelineno-5-59"></a>
<a id="__codelineno-5-60" name="__codelineno-5-60" href="#__codelineno-5-60"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_project_updated</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="n">CustomerUpdatedEvent</span><span class="p">):</span>
<a id="__codelineno-5-61" name="__codelineno-5-61" href="#__codelineno-5-61"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Projette la mise à jour d&#39;un client&quot;&quot;&quot;</span>
<a id="__codelineno-5-62" name="__codelineno-5-62" href="#__codelineno-5-62"></a>        <span class="n">profile</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;customer_profiles&#39;</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">customer_id</span><span class="p">)</span>
<a id="__codelineno-5-63" name="__codelineno-5-63" href="#__codelineno-5-63"></a>        <span class="k">if</span> <span class="n">profile</span><span class="p">:</span>
<a id="__codelineno-5-64" name="__codelineno-5-64" href="#__codelineno-5-64"></a>            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">event</span><span class="o">.</span><span class="n">changes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-5-65" name="__codelineno-5-65" href="#__codelineno-5-65"></a>                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">profile</span><span class="p">:</span>
<a id="__codelineno-5-66" name="__codelineno-5-66" href="#__codelineno-5-66"></a>                    <span class="n">profile</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
<a id="__codelineno-5-67" name="__codelineno-5-67" href="#__codelineno-5-67"></a>            <span class="n">profile</span><span class="p">[</span><span class="s1">&#39;version&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-5-68" name="__codelineno-5-68" href="#__codelineno-5-68"></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">upsert</span><span class="p">(</span><span class="s1">&#39;customer_profiles&#39;</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">customer_id</span><span class="p">,</span> <span class="n">profile</span><span class="p">)</span>
<a id="__codelineno-5-69" name="__codelineno-5-69" href="#__codelineno-5-69"></a>
<a id="__codelineno-5-70" name="__codelineno-5-70" href="#__codelineno-5-70"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_project_interaction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="n">InteractionRecordedEvent</span><span class="p">):</span>
<a id="__codelineno-5-71" name="__codelineno-5-71" href="#__codelineno-5-71"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Projette une interaction&quot;&quot;&quot;</span>
<a id="__codelineno-5-72" name="__codelineno-5-72" href="#__codelineno-5-72"></a>        <span class="n">profile</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;customer_profiles&#39;</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">customer_id</span><span class="p">)</span>
<a id="__codelineno-5-73" name="__codelineno-5-73" href="#__codelineno-5-73"></a>        <span class="k">if</span> <span class="n">profile</span><span class="p">:</span>
<a id="__codelineno-5-74" name="__codelineno-5-74" href="#__codelineno-5-74"></a>            <span class="n">profile</span><span class="p">[</span><span class="s1">&#39;total_interactions&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-5-75" name="__codelineno-5-75" href="#__codelineno-5-75"></a>            <span class="n">profile</span><span class="p">[</span><span class="s1">&#39;last_interaction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">timestamp</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
<a id="__codelineno-5-76" name="__codelineno-5-76" href="#__codelineno-5-76"></a>
<a id="__codelineno-5-77" name="__codelineno-5-77" href="#__codelineno-5-77"></a>            <span class="c1"># Mise à jour de la tendance de sentiment</span>
<a id="__codelineno-5-78" name="__codelineno-5-78" href="#__codelineno-5-78"></a>            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">sentiment_score</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-5-79" name="__codelineno-5-79" href="#__codelineno-5-79"></a>                <span class="n">profile</span><span class="p">[</span><span class="s1">&#39;sentiment_trend&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
<a id="__codelineno-5-80" name="__codelineno-5-80" href="#__codelineno-5-80"></a>                    <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">timestamp</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
<a id="__codelineno-5-81" name="__codelineno-5-81" href="#__codelineno-5-81"></a>                    <span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">sentiment_score</span>
<a id="__codelineno-5-82" name="__codelineno-5-82" href="#__codelineno-5-82"></a>                <span class="p">})</span>
<a id="__codelineno-5-83" name="__codelineno-5-83" href="#__codelineno-5-83"></a>                <span class="c1"># Garder les 10 derniers</span>
<a id="__codelineno-5-84" name="__codelineno-5-84" href="#__codelineno-5-84"></a>                <span class="n">profile</span><span class="p">[</span><span class="s1">&#39;sentiment_trend&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">profile</span><span class="p">[</span><span class="s1">&#39;sentiment_trend&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">10</span><span class="p">:]</span>
<a id="__codelineno-5-85" name="__codelineno-5-85" href="#__codelineno-5-85"></a>
<a id="__codelineno-5-86" name="__codelineno-5-86" href="#__codelineno-5-86"></a>            <span class="n">profile</span><span class="p">[</span><span class="s1">&#39;version&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-5-87" name="__codelineno-5-87" href="#__codelineno-5-87"></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">upsert</span><span class="p">(</span><span class="s1">&#39;customer_profiles&#39;</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">customer_id</span><span class="p">,</span> <span class="n">profile</span><span class="p">)</span>
<a id="__codelineno-5-88" name="__codelineno-5-88" href="#__codelineno-5-88"></a>
<a id="__codelineno-5-89" name="__codelineno-5-89" href="#__codelineno-5-89"></a>
<a id="__codelineno-5-90" name="__codelineno-5-90" href="#__codelineno-5-90"></a><span class="k">class</span><span class="w"> </span><span class="nc">Agent360ViewProjector</span><span class="p">(</span><span class="n">Projector</span><span class="p">):</span>
<a id="__codelineno-5-91" name="__codelineno-5-91" href="#__codelineno-5-91"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Projecteur pour la vue 360° utilisée par les agents&quot;&quot;&quot;</span>
<a id="__codelineno-5-92" name="__codelineno-5-92" href="#__codelineno-5-92"></a>
<a id="__codelineno-5-93" name="__codelineno-5-93" href="#__codelineno-5-93"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">read_store</span><span class="p">,</span> <span class="n">enrichment_service</span><span class="p">):</span>
<a id="__codelineno-5-94" name="__codelineno-5-94" href="#__codelineno-5-94"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">store</span> <span class="o">=</span> <span class="n">read_store</span>
<a id="__codelineno-5-95" name="__codelineno-5-95" href="#__codelineno-5-95"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">enrichment</span> <span class="o">=</span> <span class="n">enrichment_service</span>
<a id="__codelineno-5-96" name="__codelineno-5-96" href="#__codelineno-5-96"></a>
<a id="__codelineno-5-97" name="__codelineno-5-97" href="#__codelineno-5-97"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">handles</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<a id="__codelineno-5-98" name="__codelineno-5-98" href="#__codelineno-5-98"></a>        <span class="k">return</span> <span class="p">[</span>
<a id="__codelineno-5-99" name="__codelineno-5-99" href="#__codelineno-5-99"></a>            <span class="s1">&#39;customer.created&#39;</span><span class="p">,</span>
<a id="__codelineno-5-100" name="__codelineno-5-100" href="#__codelineno-5-100"></a>            <span class="s1">&#39;customer.updated&#39;</span><span class="p">,</span>
<a id="__codelineno-5-101" name="__codelineno-5-101" href="#__codelineno-5-101"></a>            <span class="s1">&#39;interaction.recorded&#39;</span><span class="p">,</span>
<a id="__codelineno-5-102" name="__codelineno-5-102" href="#__codelineno-5-102"></a>            <span class="s1">&#39;order.placed&#39;</span><span class="p">,</span>
<a id="__codelineno-5-103" name="__codelineno-5-103" href="#__codelineno-5-103"></a>            <span class="s1">&#39;order.completed&#39;</span><span class="p">,</span>
<a id="__codelineno-5-104" name="__codelineno-5-104" href="#__codelineno-5-104"></a>            <span class="s1">&#39;support.ticket.created&#39;</span><span class="p">,</span>
<a id="__codelineno-5-105" name="__codelineno-5-105" href="#__codelineno-5-105"></a>            <span class="s1">&#39;support.ticket.resolved&#39;</span>
<a id="__codelineno-5-106" name="__codelineno-5-106" href="#__codelineno-5-106"></a>        <span class="p">]</span>
<a id="__codelineno-5-107" name="__codelineno-5-107" href="#__codelineno-5-107"></a>
<a id="__codelineno-5-108" name="__codelineno-5-108" href="#__codelineno-5-108"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">project</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="n">DomainEvent</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-5-109" name="__codelineno-5-109" href="#__codelineno-5-109"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Projette vers la vue 360°&quot;&quot;&quot;</span>
<a id="__codelineno-5-110" name="__codelineno-5-110" href="#__codelineno-5-110"></a>
<a id="__codelineno-5-111" name="__codelineno-5-111" href="#__codelineno-5-111"></a>        <span class="n">customer_id</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">aggregate_id</span>
<a id="__codelineno-5-112" name="__codelineno-5-112" href="#__codelineno-5-112"></a>        <span class="n">view</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;customer_360&#39;</span><span class="p">,</span> <span class="n">customer_id</span><span class="p">)</span>
<a id="__codelineno-5-113" name="__codelineno-5-113" href="#__codelineno-5-113"></a>
<a id="__codelineno-5-114" name="__codelineno-5-114" href="#__codelineno-5-114"></a>        <span class="k">if</span> <span class="n">view</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-5-115" name="__codelineno-5-115" href="#__codelineno-5-115"></a>            <span class="n">view</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_empty_view</span><span class="p">(</span><span class="n">customer_id</span><span class="p">)</span>
<a id="__codelineno-5-116" name="__codelineno-5-116" href="#__codelineno-5-116"></a>
<a id="__codelineno-5-117" name="__codelineno-5-117" href="#__codelineno-5-117"></a>        <span class="c1"># Mise à jour selon le type d&#39;événement</span>
<a id="__codelineno-5-118" name="__codelineno-5-118" href="#__codelineno-5-118"></a>        <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">==</span> <span class="s1">&#39;customer.created&#39;</span><span class="p">:</span>
<a id="__codelineno-5-119" name="__codelineno-5-119" href="#__codelineno-5-119"></a>            <span class="n">view</span><span class="p">[</span><span class="s1">&#39;profile&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-5-120" name="__codelineno-5-120" href="#__codelineno-5-120"></a>                <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-5-121" name="__codelineno-5-121" href="#__codelineno-5-121"></a>                <span class="s1">&#39;email&#39;</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">email</span><span class="p">,</span>
<a id="__codelineno-5-122" name="__codelineno-5-122" href="#__codelineno-5-122"></a>                <span class="s1">&#39;created_at&#39;</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">timestamp</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
<a id="__codelineno-5-123" name="__codelineno-5-123" href="#__codelineno-5-123"></a>            <span class="p">}</span>
<a id="__codelineno-5-124" name="__codelineno-5-124" href="#__codelineno-5-124"></a>
<a id="__codelineno-5-125" name="__codelineno-5-125" href="#__codelineno-5-125"></a>        <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">==</span> <span class="s1">&#39;interaction.recorded&#39;</span><span class="p">:</span>
<a id="__codelineno-5-126" name="__codelineno-5-126" href="#__codelineno-5-126"></a>            <span class="n">view</span><span class="p">[</span><span class="s1">&#39;interactions&#39;</span><span class="p">][</span><span class="s1">&#39;total&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-5-127" name="__codelineno-5-127" href="#__codelineno-5-127"></a>            <span class="n">view</span><span class="p">[</span><span class="s1">&#39;interactions&#39;</span><span class="p">][</span><span class="s1">&#39;last_at&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">timestamp</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
<a id="__codelineno-5-128" name="__codelineno-5-128" href="#__codelineno-5-128"></a>            <span class="n">view</span><span class="p">[</span><span class="s1">&#39;interactions&#39;</span><span class="p">][</span><span class="s1">&#39;by_type&#39;</span><span class="p">][</span><span class="n">event</span><span class="o">.</span><span class="n">interaction_type</span><span class="p">]</span> <span class="o">=</span> \
<a id="__codelineno-5-129" name="__codelineno-5-129" href="#__codelineno-5-129"></a>                <span class="n">view</span><span class="p">[</span><span class="s1">&#39;interactions&#39;</span><span class="p">][</span><span class="s1">&#39;by_type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">interaction_type</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
<a id="__codelineno-5-130" name="__codelineno-5-130" href="#__codelineno-5-130"></a>
<a id="__codelineno-5-131" name="__codelineno-5-131" href="#__codelineno-5-131"></a>            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">sentiment_score</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-5-132" name="__codelineno-5-132" href="#__codelineno-5-132"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_update_sentiment_metrics</span><span class="p">(</span><span class="n">view</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">sentiment_score</span><span class="p">)</span>
<a id="__codelineno-5-133" name="__codelineno-5-133" href="#__codelineno-5-133"></a>
<a id="__codelineno-5-134" name="__codelineno-5-134" href="#__codelineno-5-134"></a>        <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">==</span> <span class="s1">&#39;order.placed&#39;</span><span class="p">:</span>
<a id="__codelineno-5-135" name="__codelineno-5-135" href="#__codelineno-5-135"></a>            <span class="n">view</span><span class="p">[</span><span class="s1">&#39;orders&#39;</span><span class="p">][</span><span class="s1">&#39;total&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-5-136" name="__codelineno-5-136" href="#__codelineno-5-136"></a>            <span class="n">view</span><span class="p">[</span><span class="s1">&#39;orders&#39;</span><span class="p">][</span><span class="s1">&#39;total_value&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">event</span><span class="o">.</span><span class="n">order_value</span>
<a id="__codelineno-5-137" name="__codelineno-5-137" href="#__codelineno-5-137"></a>            <span class="n">view</span><span class="p">[</span><span class="s1">&#39;orders&#39;</span><span class="p">][</span><span class="s1">&#39;last_at&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">timestamp</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
<a id="__codelineno-5-138" name="__codelineno-5-138" href="#__codelineno-5-138"></a>
<a id="__codelineno-5-139" name="__codelineno-5-139" href="#__codelineno-5-139"></a>        <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">==</span> <span class="s1">&#39;support.ticket.created&#39;</span><span class="p">:</span>
<a id="__codelineno-5-140" name="__codelineno-5-140" href="#__codelineno-5-140"></a>            <span class="n">view</span><span class="p">[</span><span class="s1">&#39;support&#39;</span><span class="p">][</span><span class="s1">&#39;open_tickets&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-5-141" name="__codelineno-5-141" href="#__codelineno-5-141"></a>            <span class="n">view</span><span class="p">[</span><span class="s1">&#39;support&#39;</span><span class="p">][</span><span class="s1">&#39;total_tickets&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-5-142" name="__codelineno-5-142" href="#__codelineno-5-142"></a>
<a id="__codelineno-5-143" name="__codelineno-5-143" href="#__codelineno-5-143"></a>        <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">==</span> <span class="s1">&#39;support.ticket.resolved&#39;</span><span class="p">:</span>
<a id="__codelineno-5-144" name="__codelineno-5-144" href="#__codelineno-5-144"></a>            <span class="n">view</span><span class="p">[</span><span class="s1">&#39;support&#39;</span><span class="p">][</span><span class="s1">&#39;open_tickets&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">view</span><span class="p">[</span><span class="s1">&#39;support&#39;</span><span class="p">][</span><span class="s1">&#39;open_tickets&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-5-145" name="__codelineno-5-145" href="#__codelineno-5-145"></a>
<a id="__codelineno-5-146" name="__codelineno-5-146" href="#__codelineno-5-146"></a>        <span class="c1"># Enrichissement contextuel pour les agents</span>
<a id="__codelineno-5-147" name="__codelineno-5-147" href="#__codelineno-5-147"></a>        <span class="n">view</span><span class="p">[</span><span class="s1">&#39;context&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">enrichment</span><span class="o">.</span><span class="n">enrich</span><span class="p">(</span><span class="n">view</span><span class="p">)</span>
<a id="__codelineno-5-148" name="__codelineno-5-148" href="#__codelineno-5-148"></a>        <span class="n">view</span><span class="p">[</span><span class="s1">&#39;updated_at&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
<a id="__codelineno-5-149" name="__codelineno-5-149" href="#__codelineno-5-149"></a>        <span class="n">view</span><span class="p">[</span><span class="s1">&#39;version&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-5-150" name="__codelineno-5-150" href="#__codelineno-5-150"></a>
<a id="__codelineno-5-151" name="__codelineno-5-151" href="#__codelineno-5-151"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">upsert</span><span class="p">(</span><span class="s1">&#39;customer_360&#39;</span><span class="p">,</span> <span class="n">customer_id</span><span class="p">,</span> <span class="n">view</span><span class="p">)</span>
<a id="__codelineno-5-152" name="__codelineno-5-152" href="#__codelineno-5-152"></a>
<a id="__codelineno-5-153" name="__codelineno-5-153" href="#__codelineno-5-153"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_create_empty_view</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-5-154" name="__codelineno-5-154" href="#__codelineno-5-154"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Crée une vue 360° vide&quot;&quot;&quot;</span>
<a id="__codelineno-5-155" name="__codelineno-5-155" href="#__codelineno-5-155"></a>        <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-5-156" name="__codelineno-5-156" href="#__codelineno-5-156"></a>            <span class="s1">&#39;customer_id&#39;</span><span class="p">:</span> <span class="n">customer_id</span><span class="p">,</span>
<a id="__codelineno-5-157" name="__codelineno-5-157" href="#__codelineno-5-157"></a>            <span class="s1">&#39;profile&#39;</span><span class="p">:</span> <span class="p">{},</span>
<a id="__codelineno-5-158" name="__codelineno-5-158" href="#__codelineno-5-158"></a>            <span class="s1">&#39;interactions&#39;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-5-159" name="__codelineno-5-159" href="#__codelineno-5-159"></a>                <span class="s1">&#39;total&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-5-160" name="__codelineno-5-160" href="#__codelineno-5-160"></a>                <span class="s1">&#39;last_at&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-5-161" name="__codelineno-5-161" href="#__codelineno-5-161"></a>                <span class="s1">&#39;by_type&#39;</span><span class="p">:</span> <span class="p">{},</span>
<a id="__codelineno-5-162" name="__codelineno-5-162" href="#__codelineno-5-162"></a>                <span class="s1">&#39;sentiment_avg&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-5-163" name="__codelineno-5-163" href="#__codelineno-5-163"></a>                <span class="s1">&#39;sentiment_trend&#39;</span><span class="p">:</span> <span class="s1">&#39;neutral&#39;</span>
<a id="__codelineno-5-164" name="__codelineno-5-164" href="#__codelineno-5-164"></a>            <span class="p">},</span>
<a id="__codelineno-5-165" name="__codelineno-5-165" href="#__codelineno-5-165"></a>            <span class="s1">&#39;orders&#39;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-5-166" name="__codelineno-5-166" href="#__codelineno-5-166"></a>                <span class="s1">&#39;total&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-5-167" name="__codelineno-5-167" href="#__codelineno-5-167"></a>                <span class="s1">&#39;total_value&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-5-168" name="__codelineno-5-168" href="#__codelineno-5-168"></a>                <span class="s1">&#39;last_at&#39;</span><span class="p">:</span> <span class="kc">None</span>
<a id="__codelineno-5-169" name="__codelineno-5-169" href="#__codelineno-5-169"></a>            <span class="p">},</span>
<a id="__codelineno-5-170" name="__codelineno-5-170" href="#__codelineno-5-170"></a>            <span class="s1">&#39;support&#39;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-5-171" name="__codelineno-5-171" href="#__codelineno-5-171"></a>                <span class="s1">&#39;open_tickets&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-5-172" name="__codelineno-5-172" href="#__codelineno-5-172"></a>                <span class="s1">&#39;total_tickets&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-5-173" name="__codelineno-5-173" href="#__codelineno-5-173"></a>                <span class="s1">&#39;avg_resolution_time&#39;</span><span class="p">:</span> <span class="kc">None</span>
<a id="__codelineno-5-174" name="__codelineno-5-174" href="#__codelineno-5-174"></a>            <span class="p">},</span>
<a id="__codelineno-5-175" name="__codelineno-5-175" href="#__codelineno-5-175"></a>            <span class="s1">&#39;context&#39;</span><span class="p">:</span> <span class="p">{},</span>
<a id="__codelineno-5-176" name="__codelineno-5-176" href="#__codelineno-5-176"></a>            <span class="s1">&#39;version&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-5-177" name="__codelineno-5-177" href="#__codelineno-5-177"></a>            <span class="s1">&#39;updated_at&#39;</span><span class="p">:</span> <span class="kc">None</span>
<a id="__codelineno-5-178" name="__codelineno-5-178" href="#__codelineno-5-178"></a>        <span class="p">}</span>
<a id="__codelineno-5-179" name="__codelineno-5-179" href="#__codelineno-5-179"></a>
<a id="__codelineno-5-180" name="__codelineno-5-180" href="#__codelineno-5-180"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_update_sentiment_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">view</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">score</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
<a id="__codelineno-5-181" name="__codelineno-5-181" href="#__codelineno-5-181"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Met à jour les métriques de sentiment&quot;&quot;&quot;</span>
<a id="__codelineno-5-182" name="__codelineno-5-182" href="#__codelineno-5-182"></a>        <span class="n">interactions</span> <span class="o">=</span> <span class="n">view</span><span class="p">[</span><span class="s1">&#39;interactions&#39;</span><span class="p">]</span>
<a id="__codelineno-5-183" name="__codelineno-5-183" href="#__codelineno-5-183"></a>
<a id="__codelineno-5-184" name="__codelineno-5-184" href="#__codelineno-5-184"></a>        <span class="k">if</span> <span class="n">interactions</span><span class="p">[</span><span class="s1">&#39;sentiment_avg&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-5-185" name="__codelineno-5-185" href="#__codelineno-5-185"></a>            <span class="n">interactions</span><span class="p">[</span><span class="s1">&#39;sentiment_avg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">score</span>
<a id="__codelineno-5-186" name="__codelineno-5-186" href="#__codelineno-5-186"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-5-187" name="__codelineno-5-187" href="#__codelineno-5-187"></a>            <span class="c1"># Moyenne mobile exponentielle</span>
<a id="__codelineno-5-188" name="__codelineno-5-188" href="#__codelineno-5-188"></a>            <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.3</span>
<a id="__codelineno-5-189" name="__codelineno-5-189" href="#__codelineno-5-189"></a>            <span class="n">interactions</span><span class="p">[</span><span class="s1">&#39;sentiment_avg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-5-190" name="__codelineno-5-190" href="#__codelineno-5-190"></a>                <span class="n">alpha</span> <span class="o">*</span> <span class="n">score</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">alpha</span><span class="p">)</span> <span class="o">*</span> <span class="n">interactions</span><span class="p">[</span><span class="s1">&#39;sentiment_avg&#39;</span><span class="p">]</span>
<a id="__codelineno-5-191" name="__codelineno-5-191" href="#__codelineno-5-191"></a>            <span class="p">)</span>
<a id="__codelineno-5-192" name="__codelineno-5-192" href="#__codelineno-5-192"></a>
<a id="__codelineno-5-193" name="__codelineno-5-193" href="#__codelineno-5-193"></a>        <span class="c1"># Détermination de la tendance</span>
<a id="__codelineno-5-194" name="__codelineno-5-194" href="#__codelineno-5-194"></a>        <span class="n">avg</span> <span class="o">=</span> <span class="n">interactions</span><span class="p">[</span><span class="s1">&#39;sentiment_avg&#39;</span><span class="p">]</span>
<a id="__codelineno-5-195" name="__codelineno-5-195" href="#__codelineno-5-195"></a>        <span class="k">if</span> <span class="n">avg</span> <span class="o">&gt;</span> <span class="mf">0.6</span><span class="p">:</span>
<a id="__codelineno-5-196" name="__codelineno-5-196" href="#__codelineno-5-196"></a>            <span class="n">interactions</span><span class="p">[</span><span class="s1">&#39;sentiment_trend&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;positive&#39;</span>
<a id="__codelineno-5-197" name="__codelineno-5-197" href="#__codelineno-5-197"></a>        <span class="k">elif</span> <span class="n">avg</span> <span class="o">&lt;</span> <span class="mf">0.4</span><span class="p">:</span>
<a id="__codelineno-5-198" name="__codelineno-5-198" href="#__codelineno-5-198"></a>            <span class="n">interactions</span><span class="p">[</span><span class="s1">&#39;sentiment_trend&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;negative&#39;</span>
<a id="__codelineno-5-199" name="__codelineno-5-199" href="#__codelineno-5-199"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-5-200" name="__codelineno-5-200" href="#__codelineno-5-200"></a>            <span class="n">interactions</span><span class="p">[</span><span class="s1">&#39;sentiment_trend&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;neutral&#39;</span>
</code></pre></div>
<blockquote>
<p><strong>Note technique</strong><br />
Les projecteurs doivent être idempotents : le traitement multiple d'un même événement doit produire le même résultat. Utilisez le numéro de version ou l'offset Kafka pour détecter et ignorer les événements déjà traités.</p>
</blockquote>
<hr />
<h2 id="ii93-event-sourcing">II.9.3 Event Sourcing<a class="headerlink" href="#ii93-event-sourcing" title="Permanent link">&para;</a></h2>
<h3 id="philosophie-de-levent-sourcing">Philosophie de l'Event Sourcing<a class="headerlink" href="#philosophie-de-levent-sourcing" title="Permanent link">&para;</a></h3>
<p>L'Event Sourcing représente un changement de paradigme fondamental dans la persistance des données. Au lieu de stocker l'état courant d'une entité, on stocke la séquence complète des événements qui ont conduit à cet état. L'état actuel est alors une fonction déterministe de cette séquence d'événements : State(t) = fold(apply, InitialState, Events[0..t]).</p>
<p>Cette approche offre plusieurs avantages majeurs pour les systèmes agentiques. La traçabilité complète permet de comprendre exactement comment et pourquoi le système est arrivé à son état actuel — information précieuse pour le débogage des comportements des agents. La capacité de reconstituer l'état à n'importe quel moment dans le temps facilite l'analyse rétrospective et la correction des erreurs. La possibilité de rejouer les événements permet de créer de nouvelles projections sans modifier les données sources.</p>
<p>L'Event Sourcing s'intègre naturellement avec CQRS : les événements constituent le mécanisme de synchronisation entre le modèle d'écriture et les modèles de lecture. Combiné avec le patron Saga, il fournit également une piste d'audit complète des transactions distribuées.</p>
<h3 id="implementation-de-levent-store">Implémentation de l'Event Store<a class="headerlink" href="#implementation-de-levent-store" title="Permanent link">&para;</a></h3>
<p>L'Event Store est le composant central de l'architecture Event Sourcing. Il doit garantir l'ordonnancement des événements au sein d'un agrégat, l'atomicité des écritures, et la possibilité de lire efficacement l'historique complet ou partiel d'un agrégat.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="c1"># eventsourcing/store.py</span>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Iterator</span><span class="p">,</span> <span class="n">Callable</span>
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">hashlib</span>
<a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a>
<a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a><span class="nd">@dataclass</span>
<a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a><span class="k">class</span><span class="w"> </span><span class="nc">StoredEvent</span><span class="p">:</span>
<a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Événement persisté dans l&#39;Event Store&quot;&quot;&quot;</span>
<a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a>    <span class="n">event_id</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-6-12" name="__codelineno-6-12" href="#__codelineno-6-12"></a>    <span class="n">aggregate_type</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-6-13" name="__codelineno-6-13" href="#__codelineno-6-13"></a>    <span class="n">aggregate_id</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-6-14" name="__codelineno-6-14" href="#__codelineno-6-14"></a>    <span class="n">sequence_number</span><span class="p">:</span> <span class="nb">int</span>
<a id="__codelineno-6-15" name="__codelineno-6-15" href="#__codelineno-6-15"></a>    <span class="n">event_type</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-6-16" name="__codelineno-6-16" href="#__codelineno-6-16"></a>    <span class="n">event_data</span><span class="p">:</span> <span class="nb">dict</span>
<a id="__codelineno-6-17" name="__codelineno-6-17" href="#__codelineno-6-17"></a>    <span class="n">metadata</span><span class="p">:</span> <span class="nb">dict</span>
<a id="__codelineno-6-18" name="__codelineno-6-18" href="#__codelineno-6-18"></a>    <span class="n">timestamp</span><span class="p">:</span> <span class="n">datetime</span>
<a id="__codelineno-6-19" name="__codelineno-6-19" href="#__codelineno-6-19"></a>    <span class="n">checksum</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-6-20" name="__codelineno-6-20" href="#__codelineno-6-20"></a>
<a id="__codelineno-6-21" name="__codelineno-6-21" href="#__codelineno-6-21"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-6-22" name="__codelineno-6-22" href="#__codelineno-6-22"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">checksum</span><span class="p">:</span>
<a id="__codelineno-6-23" name="__codelineno-6-23" href="#__codelineno-6-23"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">checksum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_checksum</span><span class="p">()</span>
<a id="__codelineno-6-24" name="__codelineno-6-24" href="#__codelineno-6-24"></a>
<a id="__codelineno-6-25" name="__codelineno-6-25" href="#__codelineno-6-25"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_compute_checksum</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-6-26" name="__codelineno-6-26" href="#__codelineno-6-26"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Calcule un checksum pour l&#39;intégrité&quot;&quot;&quot;</span>
<a id="__codelineno-6-27" name="__codelineno-6-27" href="#__codelineno-6-27"></a>        <span class="n">content</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">event_id</span><span class="si">}{</span><span class="bp">self</span><span class="o">.</span><span class="n">aggregate_id</span><span class="si">}{</span><span class="bp">self</span><span class="o">.</span><span class="n">sequence_number</span><span class="si">}{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">event_data</span><span class="p">,</span><span class="w"> </span><span class="n">sort_keys</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-6-28" name="__codelineno-6-28" href="#__codelineno-6-28"></a>        <span class="k">return</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">content</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()[:</span><span class="mi">16</span><span class="p">]</span>
<a id="__codelineno-6-29" name="__codelineno-6-29" href="#__codelineno-6-29"></a>
<a id="__codelineno-6-30" name="__codelineno-6-30" href="#__codelineno-6-30"></a>
<a id="__codelineno-6-31" name="__codelineno-6-31" href="#__codelineno-6-31"></a><span class="k">class</span><span class="w"> </span><span class="nc">EventStore</span><span class="p">:</span>
<a id="__codelineno-6-32" name="__codelineno-6-32" href="#__codelineno-6-32"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Event Store basé sur Kafka et PostgreSQL&quot;&quot;&quot;</span>
<a id="__codelineno-6-33" name="__codelineno-6-33" href="#__codelineno-6-33"></a>
<a id="__codelineno-6-34" name="__codelineno-6-34" href="#__codelineno-6-34"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db_pool</span><span class="p">,</span> <span class="n">kafka_producer</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-6-35" name="__codelineno-6-35" href="#__codelineno-6-35"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">db_pool</span>
<a id="__codelineno-6-36" name="__codelineno-6-36" href="#__codelineno-6-36"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">producer</span> <span class="o">=</span> <span class="n">kafka_producer</span>
<a id="__codelineno-6-37" name="__codelineno-6-37" href="#__codelineno-6-37"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
<a id="__codelineno-6-38" name="__codelineno-6-38" href="#__codelineno-6-38"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">topic_prefix</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;topic_prefix&#39;</span><span class="p">,</span> <span class="s1">&#39;events&#39;</span><span class="p">)</span>
<a id="__codelineno-6-39" name="__codelineno-6-39" href="#__codelineno-6-39"></a>
<a id="__codelineno-6-40" name="__codelineno-6-40" href="#__codelineno-6-40"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">append</span><span class="p">(</span>
<a id="__codelineno-6-41" name="__codelineno-6-41" href="#__codelineno-6-41"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-6-42" name="__codelineno-6-42" href="#__codelineno-6-42"></a>        <span class="n">aggregate_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-6-43" name="__codelineno-6-43" href="#__codelineno-6-43"></a>        <span class="n">aggregate_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-6-44" name="__codelineno-6-44" href="#__codelineno-6-44"></a>        <span class="n">events</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">DomainEvent</span><span class="p">],</span>
<a id="__codelineno-6-45" name="__codelineno-6-45" href="#__codelineno-6-45"></a>        <span class="n">expected_version</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<a id="__codelineno-6-46" name="__codelineno-6-46" href="#__codelineno-6-46"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">StoredEvent</span><span class="p">]:</span>
<a id="__codelineno-6-47" name="__codelineno-6-47" href="#__codelineno-6-47"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Ajoute des événements à l&#39;historique d&#39;un agrégat&quot;&quot;&quot;</span>
<a id="__codelineno-6-48" name="__codelineno-6-48" href="#__codelineno-6-48"></a>
<a id="__codelineno-6-49" name="__codelineno-6-49" href="#__codelineno-6-49"></a>        <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
<a id="__codelineno-6-50" name="__codelineno-6-50" href="#__codelineno-6-50"></a>            <span class="k">async</span> <span class="k">with</span> <span class="n">conn</span><span class="o">.</span><span class="n">transaction</span><span class="p">():</span>
<a id="__codelineno-6-51" name="__codelineno-6-51" href="#__codelineno-6-51"></a>                <span class="c1"># Verrouillage optimiste</span>
<a id="__codelineno-6-52" name="__codelineno-6-52" href="#__codelineno-6-52"></a>                <span class="n">current_version</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_current_version</span><span class="p">(</span>
<a id="__codelineno-6-53" name="__codelineno-6-53" href="#__codelineno-6-53"></a>                    <span class="n">conn</span><span class="p">,</span> <span class="n">aggregate_type</span><span class="p">,</span> <span class="n">aggregate_id</span>
<a id="__codelineno-6-54" name="__codelineno-6-54" href="#__codelineno-6-54"></a>                <span class="p">)</span>
<a id="__codelineno-6-55" name="__codelineno-6-55" href="#__codelineno-6-55"></a>
<a id="__codelineno-6-56" name="__codelineno-6-56" href="#__codelineno-6-56"></a>                <span class="k">if</span> <span class="n">expected_version</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">current_version</span> <span class="o">!=</span> <span class="n">expected_version</span><span class="p">:</span>
<a id="__codelineno-6-57" name="__codelineno-6-57" href="#__codelineno-6-57"></a>                    <span class="k">raise</span> <span class="n">ConcurrencyError</span><span class="p">(</span>
<a id="__codelineno-6-58" name="__codelineno-6-58" href="#__codelineno-6-58"></a>                        <span class="sa">f</span><span class="s2">&quot;Version attendue </span><span class="si">{</span><span class="n">expected_version</span><span class="si">}</span><span class="s2">, &quot;</span>
<a id="__codelineno-6-59" name="__codelineno-6-59" href="#__codelineno-6-59"></a>                        <span class="sa">f</span><span class="s2">&quot;version actuelle </span><span class="si">{</span><span class="n">current_version</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-6-60" name="__codelineno-6-60" href="#__codelineno-6-60"></a>                    <span class="p">)</span>
<a id="__codelineno-6-61" name="__codelineno-6-61" href="#__codelineno-6-61"></a>
<a id="__codelineno-6-62" name="__codelineno-6-62" href="#__codelineno-6-62"></a>                <span class="n">stored_events</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-6-63" name="__codelineno-6-63" href="#__codelineno-6-63"></a>                <span class="n">next_sequence</span> <span class="o">=</span> <span class="n">current_version</span> <span class="o">+</span> <span class="mi">1</span>
<a id="__codelineno-6-64" name="__codelineno-6-64" href="#__codelineno-6-64"></a>
<a id="__codelineno-6-65" name="__codelineno-6-65" href="#__codelineno-6-65"></a>                <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span>
<a id="__codelineno-6-66" name="__codelineno-6-66" href="#__codelineno-6-66"></a>                    <span class="n">stored_event</span> <span class="o">=</span> <span class="n">StoredEvent</span><span class="p">(</span>
<a id="__codelineno-6-67" name="__codelineno-6-67" href="#__codelineno-6-67"></a>                        <span class="n">event_id</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">event_id</span><span class="p">,</span>
<a id="__codelineno-6-68" name="__codelineno-6-68" href="#__codelineno-6-68"></a>                        <span class="n">aggregate_type</span><span class="o">=</span><span class="n">aggregate_type</span><span class="p">,</span>
<a id="__codelineno-6-69" name="__codelineno-6-69" href="#__codelineno-6-69"></a>                        <span class="n">aggregate_id</span><span class="o">=</span><span class="n">aggregate_id</span><span class="p">,</span>
<a id="__codelineno-6-70" name="__codelineno-6-70" href="#__codelineno-6-70"></a>                        <span class="n">sequence_number</span><span class="o">=</span><span class="n">next_sequence</span><span class="p">,</span>
<a id="__codelineno-6-71" name="__codelineno-6-71" href="#__codelineno-6-71"></a>                        <span class="n">event_type</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">event_type</span><span class="p">,</span>
<a id="__codelineno-6-72" name="__codelineno-6-72" href="#__codelineno-6-72"></a>                        <span class="n">event_data</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(),</span>
<a id="__codelineno-6-73" name="__codelineno-6-73" href="#__codelineno-6-73"></a>                        <span class="n">metadata</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-6-74" name="__codelineno-6-74" href="#__codelineno-6-74"></a>                            <span class="s1">&#39;correlation_id&#39;</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">correlation_id</span><span class="p">,</span>
<a id="__codelineno-6-75" name="__codelineno-6-75" href="#__codelineno-6-75"></a>                            <span class="s1">&#39;causation_id&#39;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="s1">&#39;causation_id&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-6-76" name="__codelineno-6-76" href="#__codelineno-6-76"></a>                        <span class="p">},</span>
<a id="__codelineno-6-77" name="__codelineno-6-77" href="#__codelineno-6-77"></a>                        <span class="n">timestamp</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">timestamp</span>
<a id="__codelineno-6-78" name="__codelineno-6-78" href="#__codelineno-6-78"></a>                    <span class="p">)</span>
<a id="__codelineno-6-79" name="__codelineno-6-79" href="#__codelineno-6-79"></a>
<a id="__codelineno-6-80" name="__codelineno-6-80" href="#__codelineno-6-80"></a>                    <span class="c1"># Persistance dans PostgreSQL</span>
<a id="__codelineno-6-81" name="__codelineno-6-81" href="#__codelineno-6-81"></a>                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_insert_event</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">stored_event</span><span class="p">)</span>
<a id="__codelineno-6-82" name="__codelineno-6-82" href="#__codelineno-6-82"></a>
<a id="__codelineno-6-83" name="__codelineno-6-83" href="#__codelineno-6-83"></a>                    <span class="n">stored_events</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stored_event</span><span class="p">)</span>
<a id="__codelineno-6-84" name="__codelineno-6-84" href="#__codelineno-6-84"></a>                    <span class="n">next_sequence</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-6-85" name="__codelineno-6-85" href="#__codelineno-6-85"></a>
<a id="__codelineno-6-86" name="__codelineno-6-86" href="#__codelineno-6-86"></a>                <span class="c1"># Publication sur Kafka après commit</span>
<a id="__codelineno-6-87" name="__codelineno-6-87" href="#__codelineno-6-87"></a>                <span class="k">for</span> <span class="n">stored_event</span> <span class="ow">in</span> <span class="n">stored_events</span><span class="p">:</span>
<a id="__codelineno-6-88" name="__codelineno-6-88" href="#__codelineno-6-88"></a>                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_publish_to_kafka</span><span class="p">(</span><span class="n">stored_event</span><span class="p">)</span>
<a id="__codelineno-6-89" name="__codelineno-6-89" href="#__codelineno-6-89"></a>
<a id="__codelineno-6-90" name="__codelineno-6-90" href="#__codelineno-6-90"></a>                <span class="k">return</span> <span class="n">stored_events</span>
<a id="__codelineno-6-91" name="__codelineno-6-91" href="#__codelineno-6-91"></a>
<a id="__codelineno-6-92" name="__codelineno-6-92" href="#__codelineno-6-92"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_events</span><span class="p">(</span>
<a id="__codelineno-6-93" name="__codelineno-6-93" href="#__codelineno-6-93"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-6-94" name="__codelineno-6-94" href="#__codelineno-6-94"></a>        <span class="n">aggregate_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-6-95" name="__codelineno-6-95" href="#__codelineno-6-95"></a>        <span class="n">aggregate_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-6-96" name="__codelineno-6-96" href="#__codelineno-6-96"></a>        <span class="n">from_version</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-6-97" name="__codelineno-6-97" href="#__codelineno-6-97"></a>        <span class="n">to_version</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-6-98" name="__codelineno-6-98" href="#__codelineno-6-98"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">StoredEvent</span><span class="p">]:</span>
<a id="__codelineno-6-99" name="__codelineno-6-99" href="#__codelineno-6-99"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Récupère les événements d&#39;un agrégat&quot;&quot;&quot;</span>
<a id="__codelineno-6-100" name="__codelineno-6-100" href="#__codelineno-6-100"></a>
<a id="__codelineno-6-101" name="__codelineno-6-101" href="#__codelineno-6-101"></a>        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-6-102" name="__codelineno-6-102" href="#__codelineno-6-102"></a><span class="s2">            SELECT event_id, aggregate_type, aggregate_id, sequence_number,</span>
<a id="__codelineno-6-103" name="__codelineno-6-103" href="#__codelineno-6-103"></a><span class="s2">                   event_type, event_data, metadata, timestamp, checksum</span>
<a id="__codelineno-6-104" name="__codelineno-6-104" href="#__codelineno-6-104"></a><span class="s2">            FROM events</span>
<a id="__codelineno-6-105" name="__codelineno-6-105" href="#__codelineno-6-105"></a><span class="s2">            WHERE aggregate_type = $1 AND aggregate_id = $2</span>
<a id="__codelineno-6-106" name="__codelineno-6-106" href="#__codelineno-6-106"></a><span class="s2">                  AND sequence_number &gt;= $3</span>
<a id="__codelineno-6-107" name="__codelineno-6-107" href="#__codelineno-6-107"></a><span class="s2">        &quot;&quot;&quot;</span>
<a id="__codelineno-6-108" name="__codelineno-6-108" href="#__codelineno-6-108"></a>        <span class="n">params</span> <span class="o">=</span> <span class="p">[</span><span class="n">aggregate_type</span><span class="p">,</span> <span class="n">aggregate_id</span><span class="p">,</span> <span class="n">from_version</span><span class="p">]</span>
<a id="__codelineno-6-109" name="__codelineno-6-109" href="#__codelineno-6-109"></a>
<a id="__codelineno-6-110" name="__codelineno-6-110" href="#__codelineno-6-110"></a>        <span class="k">if</span> <span class="n">to_version</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-6-111" name="__codelineno-6-111" href="#__codelineno-6-111"></a>            <span class="n">query</span> <span class="o">+=</span> <span class="s2">&quot; AND sequence_number &lt;= $4&quot;</span>
<a id="__codelineno-6-112" name="__codelineno-6-112" href="#__codelineno-6-112"></a>            <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">to_version</span><span class="p">)</span>
<a id="__codelineno-6-113" name="__codelineno-6-113" href="#__codelineno-6-113"></a>
<a id="__codelineno-6-114" name="__codelineno-6-114" href="#__codelineno-6-114"></a>        <span class="n">query</span> <span class="o">+=</span> <span class="s2">&quot; ORDER BY sequence_number ASC&quot;</span>
<a id="__codelineno-6-115" name="__codelineno-6-115" href="#__codelineno-6-115"></a>
<a id="__codelineno-6-116" name="__codelineno-6-116" href="#__codelineno-6-116"></a>        <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
<a id="__codelineno-6-117" name="__codelineno-6-117" href="#__codelineno-6-117"></a>            <span class="n">rows</span> <span class="o">=</span> <span class="k">await</span> <span class="n">conn</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<a id="__codelineno-6-118" name="__codelineno-6-118" href="#__codelineno-6-118"></a>            <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_row_to_event</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">]</span>
<a id="__codelineno-6-119" name="__codelineno-6-119" href="#__codelineno-6-119"></a>
<a id="__codelineno-6-120" name="__codelineno-6-120" href="#__codelineno-6-120"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_all_events</span><span class="p">(</span>
<a id="__codelineno-6-121" name="__codelineno-6-121" href="#__codelineno-6-121"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-6-122" name="__codelineno-6-122" href="#__codelineno-6-122"></a>        <span class="n">from_position</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-6-123" name="__codelineno-6-123" href="#__codelineno-6-123"></a>        <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span>
<a id="__codelineno-6-124" name="__codelineno-6-124" href="#__codelineno-6-124"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">StoredEvent</span><span class="p">]:</span>
<a id="__codelineno-6-125" name="__codelineno-6-125" href="#__codelineno-6-125"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Récupère tous les événements (pour replay global)&quot;&quot;&quot;</span>
<a id="__codelineno-6-126" name="__codelineno-6-126" href="#__codelineno-6-126"></a>
<a id="__codelineno-6-127" name="__codelineno-6-127" href="#__codelineno-6-127"></a>        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-6-128" name="__codelineno-6-128" href="#__codelineno-6-128"></a><span class="s2">            SELECT event_id, aggregate_type, aggregate_id, sequence_number,</span>
<a id="__codelineno-6-129" name="__codelineno-6-129" href="#__codelineno-6-129"></a><span class="s2">                   event_type, event_data, metadata, timestamp, checksum</span>
<a id="__codelineno-6-130" name="__codelineno-6-130" href="#__codelineno-6-130"></a><span class="s2">            FROM events</span>
<a id="__codelineno-6-131" name="__codelineno-6-131" href="#__codelineno-6-131"></a><span class="s2">            WHERE global_position &gt; $1</span>
<a id="__codelineno-6-132" name="__codelineno-6-132" href="#__codelineno-6-132"></a><span class="s2">            ORDER BY global_position ASC</span>
<a id="__codelineno-6-133" name="__codelineno-6-133" href="#__codelineno-6-133"></a><span class="s2">            LIMIT $2</span>
<a id="__codelineno-6-134" name="__codelineno-6-134" href="#__codelineno-6-134"></a><span class="s2">        &quot;&quot;&quot;</span>
<a id="__codelineno-6-135" name="__codelineno-6-135" href="#__codelineno-6-135"></a>
<a id="__codelineno-6-136" name="__codelineno-6-136" href="#__codelineno-6-136"></a>        <span class="n">position</span> <span class="o">=</span> <span class="n">from_position</span>
<a id="__codelineno-6-137" name="__codelineno-6-137" href="#__codelineno-6-137"></a>
<a id="__codelineno-6-138" name="__codelineno-6-138" href="#__codelineno-6-138"></a>        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
<a id="__codelineno-6-139" name="__codelineno-6-139" href="#__codelineno-6-139"></a>            <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
<a id="__codelineno-6-140" name="__codelineno-6-140" href="#__codelineno-6-140"></a>                <span class="n">rows</span> <span class="o">=</span> <span class="k">await</span> <span class="n">conn</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">position</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">)</span>
<a id="__codelineno-6-141" name="__codelineno-6-141" href="#__codelineno-6-141"></a>
<a id="__codelineno-6-142" name="__codelineno-6-142" href="#__codelineno-6-142"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">rows</span><span class="p">:</span>
<a id="__codelineno-6-143" name="__codelineno-6-143" href="#__codelineno-6-143"></a>                <span class="k">break</span>
<a id="__codelineno-6-144" name="__codelineno-6-144" href="#__codelineno-6-144"></a>
<a id="__codelineno-6-145" name="__codelineno-6-145" href="#__codelineno-6-145"></a>            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
<a id="__codelineno-6-146" name="__codelineno-6-146" href="#__codelineno-6-146"></a>                <span class="n">event</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_row_to_event</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
<a id="__codelineno-6-147" name="__codelineno-6-147" href="#__codelineno-6-147"></a>                <span class="k">yield</span> <span class="n">event</span>
<a id="__codelineno-6-148" name="__codelineno-6-148" href="#__codelineno-6-148"></a>                <span class="n">position</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;global_position&#39;</span><span class="p">]</span>
<a id="__codelineno-6-149" name="__codelineno-6-149" href="#__codelineno-6-149"></a>
<a id="__codelineno-6-150" name="__codelineno-6-150" href="#__codelineno-6-150"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_get_current_version</span><span class="p">(</span>
<a id="__codelineno-6-151" name="__codelineno-6-151" href="#__codelineno-6-151"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-6-152" name="__codelineno-6-152" href="#__codelineno-6-152"></a>        <span class="n">conn</span><span class="p">,</span>
<a id="__codelineno-6-153" name="__codelineno-6-153" href="#__codelineno-6-153"></a>        <span class="n">aggregate_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-6-154" name="__codelineno-6-154" href="#__codelineno-6-154"></a>        <span class="n">aggregate_id</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-6-155" name="__codelineno-6-155" href="#__codelineno-6-155"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<a id="__codelineno-6-156" name="__codelineno-6-156" href="#__codelineno-6-156"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Récupère la version actuelle d&#39;un agrégat&quot;&quot;&quot;</span>
<a id="__codelineno-6-157" name="__codelineno-6-157" href="#__codelineno-6-157"></a>
<a id="__codelineno-6-158" name="__codelineno-6-158" href="#__codelineno-6-158"></a>        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">conn</span><span class="o">.</span><span class="n">fetchval</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-6-159" name="__codelineno-6-159" href="#__codelineno-6-159"></a><span class="s2">            SELECT COALESCE(MAX(sequence_number), -1)</span>
<a id="__codelineno-6-160" name="__codelineno-6-160" href="#__codelineno-6-160"></a><span class="s2">            FROM events</span>
<a id="__codelineno-6-161" name="__codelineno-6-161" href="#__codelineno-6-161"></a><span class="s2">            WHERE aggregate_type = $1 AND aggregate_id = $2</span>
<a id="__codelineno-6-162" name="__codelineno-6-162" href="#__codelineno-6-162"></a><span class="s2">        &quot;&quot;&quot;</span><span class="p">,</span> <span class="n">aggregate_type</span><span class="p">,</span> <span class="n">aggregate_id</span><span class="p">)</span>
<a id="__codelineno-6-163" name="__codelineno-6-163" href="#__codelineno-6-163"></a>
<a id="__codelineno-6-164" name="__codelineno-6-164" href="#__codelineno-6-164"></a>        <span class="k">return</span> <span class="n">result</span>
<a id="__codelineno-6-165" name="__codelineno-6-165" href="#__codelineno-6-165"></a>
<a id="__codelineno-6-166" name="__codelineno-6-166" href="#__codelineno-6-166"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_insert_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conn</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="n">StoredEvent</span><span class="p">):</span>
<a id="__codelineno-6-167" name="__codelineno-6-167" href="#__codelineno-6-167"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Insère un événement dans la base&quot;&quot;&quot;</span>
<a id="__codelineno-6-168" name="__codelineno-6-168" href="#__codelineno-6-168"></a>
<a id="__codelineno-6-169" name="__codelineno-6-169" href="#__codelineno-6-169"></a>        <span class="k">await</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-6-170" name="__codelineno-6-170" href="#__codelineno-6-170"></a><span class="s2">            INSERT INTO events (</span>
<a id="__codelineno-6-171" name="__codelineno-6-171" href="#__codelineno-6-171"></a><span class="s2">                event_id, aggregate_type, aggregate_id, sequence_number,</span>
<a id="__codelineno-6-172" name="__codelineno-6-172" href="#__codelineno-6-172"></a><span class="s2">                event_type, event_data, metadata, timestamp, checksum</span>
<a id="__codelineno-6-173" name="__codelineno-6-173" href="#__codelineno-6-173"></a><span class="s2">            ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)</span>
<a id="__codelineno-6-174" name="__codelineno-6-174" href="#__codelineno-6-174"></a><span class="s2">        &quot;&quot;&quot;</span><span class="p">,</span>
<a id="__codelineno-6-175" name="__codelineno-6-175" href="#__codelineno-6-175"></a>            <span class="n">event</span><span class="o">.</span><span class="n">event_id</span><span class="p">,</span>
<a id="__codelineno-6-176" name="__codelineno-6-176" href="#__codelineno-6-176"></a>            <span class="n">event</span><span class="o">.</span><span class="n">aggregate_type</span><span class="p">,</span>
<a id="__codelineno-6-177" name="__codelineno-6-177" href="#__codelineno-6-177"></a>            <span class="n">event</span><span class="o">.</span><span class="n">aggregate_id</span><span class="p">,</span>
<a id="__codelineno-6-178" name="__codelineno-6-178" href="#__codelineno-6-178"></a>            <span class="n">event</span><span class="o">.</span><span class="n">sequence_number</span><span class="p">,</span>
<a id="__codelineno-6-179" name="__codelineno-6-179" href="#__codelineno-6-179"></a>            <span class="n">event</span><span class="o">.</span><span class="n">event_type</span><span class="p">,</span>
<a id="__codelineno-6-180" name="__codelineno-6-180" href="#__codelineno-6-180"></a>            <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">event_data</span><span class="p">),</span>
<a id="__codelineno-6-181" name="__codelineno-6-181" href="#__codelineno-6-181"></a>            <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="p">),</span>
<a id="__codelineno-6-182" name="__codelineno-6-182" href="#__codelineno-6-182"></a>            <span class="n">event</span><span class="o">.</span><span class="n">timestamp</span><span class="p">,</span>
<a id="__codelineno-6-183" name="__codelineno-6-183" href="#__codelineno-6-183"></a>            <span class="n">event</span><span class="o">.</span><span class="n">checksum</span>
<a id="__codelineno-6-184" name="__codelineno-6-184" href="#__codelineno-6-184"></a>        <span class="p">)</span>
<a id="__codelineno-6-185" name="__codelineno-6-185" href="#__codelineno-6-185"></a>
<a id="__codelineno-6-186" name="__codelineno-6-186" href="#__codelineno-6-186"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_publish_to_kafka</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="n">StoredEvent</span><span class="p">):</span>
<a id="__codelineno-6-187" name="__codelineno-6-187" href="#__codelineno-6-187"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Publie l&#39;événement sur Kafka&quot;&quot;&quot;</span>
<a id="__codelineno-6-188" name="__codelineno-6-188" href="#__codelineno-6-188"></a>
<a id="__codelineno-6-189" name="__codelineno-6-189" href="#__codelineno-6-189"></a>        <span class="n">topic</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">topic_prefix</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">event</span><span class="o">.</span><span class="n">aggregate_type</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-6-190" name="__codelineno-6-190" href="#__codelineno-6-190"></a>
<a id="__codelineno-6-191" name="__codelineno-6-191" href="#__codelineno-6-191"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">producer</span><span class="o">.</span><span class="n">produce</span><span class="p">(</span>
<a id="__codelineno-6-192" name="__codelineno-6-192" href="#__codelineno-6-192"></a>            <span class="n">topic</span><span class="o">=</span><span class="n">topic</span><span class="p">,</span>
<a id="__codelineno-6-193" name="__codelineno-6-193" href="#__codelineno-6-193"></a>            <span class="n">key</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">aggregate_id</span><span class="o">.</span><span class="n">encode</span><span class="p">(),</span>
<a id="__codelineno-6-194" name="__codelineno-6-194" href="#__codelineno-6-194"></a>            <span class="n">value</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span>
<a id="__codelineno-6-195" name="__codelineno-6-195" href="#__codelineno-6-195"></a>                <span class="s1">&#39;event_id&#39;</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">event_id</span><span class="p">,</span>
<a id="__codelineno-6-196" name="__codelineno-6-196" href="#__codelineno-6-196"></a>                <span class="s1">&#39;aggregate_id&#39;</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">aggregate_id</span><span class="p">,</span>
<a id="__codelineno-6-197" name="__codelineno-6-197" href="#__codelineno-6-197"></a>                <span class="s1">&#39;sequence_number&#39;</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">sequence_number</span><span class="p">,</span>
<a id="__codelineno-6-198" name="__codelineno-6-198" href="#__codelineno-6-198"></a>                <span class="s1">&#39;event_type&#39;</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">event_type</span><span class="p">,</span>
<a id="__codelineno-6-199" name="__codelineno-6-199" href="#__codelineno-6-199"></a>                <span class="s1">&#39;event_data&#39;</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">event_data</span><span class="p">,</span>
<a id="__codelineno-6-200" name="__codelineno-6-200" href="#__codelineno-6-200"></a>                <span class="s1">&#39;metadata&#39;</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span>
<a id="__codelineno-6-201" name="__codelineno-6-201" href="#__codelineno-6-201"></a>                <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">timestamp</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
<a id="__codelineno-6-202" name="__codelineno-6-202" href="#__codelineno-6-202"></a>            <span class="p">})</span><span class="o">.</span><span class="n">encode</span><span class="p">(),</span>
<a id="__codelineno-6-203" name="__codelineno-6-203" href="#__codelineno-6-203"></a>            <span class="n">headers</span><span class="o">=</span><span class="p">[</span>
<a id="__codelineno-6-204" name="__codelineno-6-204" href="#__codelineno-6-204"></a>                <span class="p">(</span><span class="s1">&#39;event_type&#39;</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">event_type</span><span class="o">.</span><span class="n">encode</span><span class="p">()),</span>
<a id="__codelineno-6-205" name="__codelineno-6-205" href="#__codelineno-6-205"></a>                <span class="p">(</span><span class="s1">&#39;aggregate_type&#39;</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">aggregate_type</span><span class="o">.</span><span class="n">encode</span><span class="p">()),</span>
<a id="__codelineno-6-206" name="__codelineno-6-206" href="#__codelineno-6-206"></a>                <span class="p">(</span><span class="s1">&#39;sequence&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">sequence_number</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
<a id="__codelineno-6-207" name="__codelineno-6-207" href="#__codelineno-6-207"></a>            <span class="p">]</span>
<a id="__codelineno-6-208" name="__codelineno-6-208" href="#__codelineno-6-208"></a>        <span class="p">)</span>
<a id="__codelineno-6-209" name="__codelineno-6-209" href="#__codelineno-6-209"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">producer</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
<a id="__codelineno-6-210" name="__codelineno-6-210" href="#__codelineno-6-210"></a>
<a id="__codelineno-6-211" name="__codelineno-6-211" href="#__codelineno-6-211"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_row_to_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">StoredEvent</span><span class="p">:</span>
<a id="__codelineno-6-212" name="__codelineno-6-212" href="#__codelineno-6-212"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Convertit une ligne de base de données en événement&quot;&quot;&quot;</span>
<a id="__codelineno-6-213" name="__codelineno-6-213" href="#__codelineno-6-213"></a>        <span class="k">return</span> <span class="n">StoredEvent</span><span class="p">(</span>
<a id="__codelineno-6-214" name="__codelineno-6-214" href="#__codelineno-6-214"></a>            <span class="n">event_id</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;event_id&#39;</span><span class="p">],</span>
<a id="__codelineno-6-215" name="__codelineno-6-215" href="#__codelineno-6-215"></a>            <span class="n">aggregate_type</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;aggregate_type&#39;</span><span class="p">],</span>
<a id="__codelineno-6-216" name="__codelineno-6-216" href="#__codelineno-6-216"></a>            <span class="n">aggregate_id</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;aggregate_id&#39;</span><span class="p">],</span>
<a id="__codelineno-6-217" name="__codelineno-6-217" href="#__codelineno-6-217"></a>            <span class="n">sequence_number</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;sequence_number&#39;</span><span class="p">],</span>
<a id="__codelineno-6-218" name="__codelineno-6-218" href="#__codelineno-6-218"></a>            <span class="n">event_type</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;event_type&#39;</span><span class="p">],</span>
<a id="__codelineno-6-219" name="__codelineno-6-219" href="#__codelineno-6-219"></a>            <span class="n">event_data</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;event_data&#39;</span><span class="p">]),</span>
<a id="__codelineno-6-220" name="__codelineno-6-220" href="#__codelineno-6-220"></a>            <span class="n">metadata</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;metadata&#39;</span><span class="p">]),</span>
<a id="__codelineno-6-221" name="__codelineno-6-221" href="#__codelineno-6-221"></a>            <span class="n">timestamp</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">],</span>
<a id="__codelineno-6-222" name="__codelineno-6-222" href="#__codelineno-6-222"></a>            <span class="n">checksum</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;checksum&#39;</span><span class="p">]</span>
<a id="__codelineno-6-223" name="__codelineno-6-223" href="#__codelineno-6-223"></a>        <span class="p">)</span>
</code></pre></div>
<h3 id="agregats-et-reconstruction-detat">Agrégats et Reconstruction d'État<a class="headerlink" href="#agregats-et-reconstruction-detat" title="Permanent link">&para;</a></h3>
<p>Un agrégat en Event Sourcing est une entité dont l'état est reconstruit à partir de ses événements. L'agrégat définit les règles métier et génère de nouveaux événements lorsque des commandes sont traitées. La méthode apply permet de reconstituer l'état à partir de l'historique.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="c1"># eventsourcing/aggregate.py</span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Type</span>
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a>
<a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a><span class="k">class</span><span class="w"> </span><span class="nc">AggregateRoot</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
<a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Classe de base pour les agrégats Event-Sourced&quot;&quot;&quot;</span>
<a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a>
<a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">aggregate_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_id</span> <span class="o">=</span> <span class="n">aggregate_id</span>
<a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_version</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_pending_events</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">DomainEvent</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-7-13" name="__codelineno-7-13" href="#__codelineno-7-13"></a>
<a id="__codelineno-7-14" name="__codelineno-7-14" href="#__codelineno-7-14"></a>    <span class="nd">@property</span>
<a id="__codelineno-7-15" name="__codelineno-7-15" href="#__codelineno-7-15"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-7-16" name="__codelineno-7-16" href="#__codelineno-7-16"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_id</span>
<a id="__codelineno-7-17" name="__codelineno-7-17" href="#__codelineno-7-17"></a>
<a id="__codelineno-7-18" name="__codelineno-7-18" href="#__codelineno-7-18"></a>    <span class="nd">@property</span>
<a id="__codelineno-7-19" name="__codelineno-7-19" href="#__codelineno-7-19"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">version</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<a id="__codelineno-7-20" name="__codelineno-7-20" href="#__codelineno-7-20"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_version</span>
<a id="__codelineno-7-21" name="__codelineno-7-21" href="#__codelineno-7-21"></a>
<a id="__codelineno-7-22" name="__codelineno-7-22" href="#__codelineno-7-22"></a>    <span class="nd">@property</span>
<a id="__codelineno-7-23" name="__codelineno-7-23" href="#__codelineno-7-23"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">pending_events</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">DomainEvent</span><span class="p">]:</span>
<a id="__codelineno-7-24" name="__codelineno-7-24" href="#__codelineno-7-24"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pending_events</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<a id="__codelineno-7-25" name="__codelineno-7-25" href="#__codelineno-7-25"></a>
<a id="__codelineno-7-26" name="__codelineno-7-26" href="#__codelineno-7-26"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">clear_pending_events</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-7-27" name="__codelineno-7-27" href="#__codelineno-7-27"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_pending_events</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
<a id="__codelineno-7-28" name="__codelineno-7-28" href="#__codelineno-7-28"></a>
<a id="__codelineno-7-29" name="__codelineno-7-29" href="#__codelineno-7-29"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">load_from_history</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">events</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">StoredEvent</span><span class="p">]):</span>
<a id="__codelineno-7-30" name="__codelineno-7-30" href="#__codelineno-7-30"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Reconstruit l&#39;état à partir de l&#39;historique&quot;&quot;&quot;</span>
<a id="__codelineno-7-31" name="__codelineno-7-31" href="#__codelineno-7-31"></a>        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span>
<a id="__codelineno-7-32" name="__codelineno-7-32" href="#__codelineno-7-32"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_apply_event</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">event_data</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">event_type</span><span class="p">)</span>
<a id="__codelineno-7-33" name="__codelineno-7-33" href="#__codelineno-7-33"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_version</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">sequence_number</span>
<a id="__codelineno-7-34" name="__codelineno-7-34" href="#__codelineno-7-34"></a>
<a id="__codelineno-7-35" name="__codelineno-7-35" href="#__codelineno-7-35"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_raise_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="n">DomainEvent</span><span class="p">):</span>
<a id="__codelineno-7-36" name="__codelineno-7-36" href="#__codelineno-7-36"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Enregistre un nouvel événement&quot;&quot;&quot;</span>
<a id="__codelineno-7-37" name="__codelineno-7-37" href="#__codelineno-7-37"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_apply_event</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(),</span> <span class="n">event</span><span class="o">.</span><span class="n">event_type</span><span class="p">)</span>
<a id="__codelineno-7-38" name="__codelineno-7-38" href="#__codelineno-7-38"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_pending_events</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
<a id="__codelineno-7-39" name="__codelineno-7-39" href="#__codelineno-7-39"></a>
<a id="__codelineno-7-40" name="__codelineno-7-40" href="#__codelineno-7-40"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_apply_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">event_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-7-41" name="__codelineno-7-41" href="#__codelineno-7-41"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Applique un événement à l&#39;état&quot;&quot;&quot;</span>
<a id="__codelineno-7-42" name="__codelineno-7-42" href="#__codelineno-7-42"></a>        <span class="n">method_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;_apply_</span><span class="si">{</span><span class="n">event_type</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-7-43" name="__codelineno-7-43" href="#__codelineno-7-43"></a>        <span class="n">method</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-7-44" name="__codelineno-7-44" href="#__codelineno-7-44"></a>
<a id="__codelineno-7-45" name="__codelineno-7-45" href="#__codelineno-7-45"></a>        <span class="k">if</span> <span class="n">method</span><span class="p">:</span>
<a id="__codelineno-7-46" name="__codelineno-7-46" href="#__codelineno-7-46"></a>            <span class="n">method</span><span class="p">(</span><span class="n">event_data</span><span class="p">)</span>
<a id="__codelineno-7-47" name="__codelineno-7-47" href="#__codelineno-7-47"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-7-48" name="__codelineno-7-48" href="#__codelineno-7-48"></a>            <span class="c1"># Log warning pour événement non géré</span>
<a id="__codelineno-7-49" name="__codelineno-7-49" href="#__codelineno-7-49"></a>            <span class="k">pass</span>
<a id="__codelineno-7-50" name="__codelineno-7-50" href="#__codelineno-7-50"></a>
<a id="__codelineno-7-51" name="__codelineno-7-51" href="#__codelineno-7-51"></a>    <span class="nd">@abstractmethod</span>
<a id="__codelineno-7-52" name="__codelineno-7-52" href="#__codelineno-7-52"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_get_aggregate_type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-7-53" name="__codelineno-7-53" href="#__codelineno-7-53"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Retourne le type de l&#39;agrégat&quot;&quot;&quot;</span>
<a id="__codelineno-7-54" name="__codelineno-7-54" href="#__codelineno-7-54"></a>        <span class="k">pass</span>
<a id="__codelineno-7-55" name="__codelineno-7-55" href="#__codelineno-7-55"></a>
<a id="__codelineno-7-56" name="__codelineno-7-56" href="#__codelineno-7-56"></a>
<a id="__codelineno-7-57" name="__codelineno-7-57" href="#__codelineno-7-57"></a><span class="nd">@dataclass</span>
<a id="__codelineno-7-58" name="__codelineno-7-58" href="#__codelineno-7-58"></a><span class="k">class</span><span class="w"> </span><span class="nc">CustomerAggregate</span><span class="p">(</span><span class="n">AggregateRoot</span><span class="p">):</span>
<a id="__codelineno-7-59" name="__codelineno-7-59" href="#__codelineno-7-59"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Agrégat Client avec Event Sourcing&quot;&quot;&quot;</span>
<a id="__codelineno-7-60" name="__codelineno-7-60" href="#__codelineno-7-60"></a>
<a id="__codelineno-7-61" name="__codelineno-7-61" href="#__codelineno-7-61"></a>    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-7-62" name="__codelineno-7-62" href="#__codelineno-7-62"></a>    <span class="n">email</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-7-63" name="__codelineno-7-63" href="#__codelineno-7-63"></a>    <span class="n">phone</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-7-64" name="__codelineno-7-64" href="#__codelineno-7-64"></a>    <span class="n">status</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;active&quot;</span>
<a id="__codelineno-7-65" name="__codelineno-7-65" href="#__codelineno-7-65"></a>    <span class="n">interactions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
<a id="__codelineno-7-66" name="__codelineno-7-66" href="#__codelineno-7-66"></a>    <span class="n">preferences</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
<a id="__codelineno-7-67" name="__codelineno-7-67" href="#__codelineno-7-67"></a>
<a id="__codelineno-7-68" name="__codelineno-7-68" href="#__codelineno-7-68"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-7-69" name="__codelineno-7-69" href="#__codelineno-7-69"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">customer_id</span><span class="p">)</span>
<a id="__codelineno-7-70" name="__codelineno-7-70" href="#__codelineno-7-70"></a>
<a id="__codelineno-7-71" name="__codelineno-7-71" href="#__codelineno-7-71"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_get_aggregate_type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-7-72" name="__codelineno-7-72" href="#__codelineno-7-72"></a>        <span class="k">return</span> <span class="s2">&quot;customer&quot;</span>
<a id="__codelineno-7-73" name="__codelineno-7-73" href="#__codelineno-7-73"></a>
<a id="__codelineno-7-74" name="__codelineno-7-74" href="#__codelineno-7-74"></a>    <span class="c1"># Commandes</span>
<a id="__codelineno-7-75" name="__codelineno-7-75" href="#__codelineno-7-75"></a>
<a id="__codelineno-7-76" name="__codelineno-7-76" href="#__codelineno-7-76"></a>    <span class="nd">@classmethod</span>
<a id="__codelineno-7-77" name="__codelineno-7-77" href="#__codelineno-7-77"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">customer_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
<a id="__codelineno-7-78" name="__codelineno-7-78" href="#__codelineno-7-78"></a>               <span class="n">phone</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;CustomerAggregate&#39;</span><span class="p">:</span>
<a id="__codelineno-7-79" name="__codelineno-7-79" href="#__codelineno-7-79"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Factory method pour créer un nouveau client&quot;&quot;&quot;</span>
<a id="__codelineno-7-80" name="__codelineno-7-80" href="#__codelineno-7-80"></a>        <span class="n">customer</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">customer_id</span><span class="p">)</span>
<a id="__codelineno-7-81" name="__codelineno-7-81" href="#__codelineno-7-81"></a>
<a id="__codelineno-7-82" name="__codelineno-7-82" href="#__codelineno-7-82"></a>        <span class="n">customer</span><span class="o">.</span><span class="n">_raise_event</span><span class="p">(</span><span class="n">CustomerCreatedEvent</span><span class="p">(</span>
<a id="__codelineno-7-83" name="__codelineno-7-83" href="#__codelineno-7-83"></a>            <span class="n">event_id</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()),</span>
<a id="__codelineno-7-84" name="__codelineno-7-84" href="#__codelineno-7-84"></a>            <span class="n">aggregate_id</span><span class="o">=</span><span class="n">customer_id</span><span class="p">,</span>
<a id="__codelineno-7-85" name="__codelineno-7-85" href="#__codelineno-7-85"></a>            <span class="n">customer_id</span><span class="o">=</span><span class="n">customer_id</span><span class="p">,</span>
<a id="__codelineno-7-86" name="__codelineno-7-86" href="#__codelineno-7-86"></a>            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-7-87" name="__codelineno-7-87" href="#__codelineno-7-87"></a>            <span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">,</span>
<a id="__codelineno-7-88" name="__codelineno-7-88" href="#__codelineno-7-88"></a>            <span class="n">phone</span><span class="o">=</span><span class="n">phone</span><span class="p">,</span>
<a id="__codelineno-7-89" name="__codelineno-7-89" href="#__codelineno-7-89"></a>            <span class="n">timestamp</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
<a id="__codelineno-7-90" name="__codelineno-7-90" href="#__codelineno-7-90"></a>        <span class="p">))</span>
<a id="__codelineno-7-91" name="__codelineno-7-91" href="#__codelineno-7-91"></a>
<a id="__codelineno-7-92" name="__codelineno-7-92" href="#__codelineno-7-92"></a>        <span class="k">return</span> <span class="n">customer</span>
<a id="__codelineno-7-93" name="__codelineno-7-93" href="#__codelineno-7-93"></a>
<a id="__codelineno-7-94" name="__codelineno-7-94" href="#__codelineno-7-94"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">update_contact</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">email</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
<a id="__codelineno-7-95" name="__codelineno-7-95" href="#__codelineno-7-95"></a>                       <span class="n">phone</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-7-96" name="__codelineno-7-96" href="#__codelineno-7-96"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Met à jour les informations de contact&quot;&quot;&quot;</span>
<a id="__codelineno-7-97" name="__codelineno-7-97" href="#__codelineno-7-97"></a>        <span class="n">changes</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-7-98" name="__codelineno-7-98" href="#__codelineno-7-98"></a>        <span class="k">if</span> <span class="n">email</span> <span class="ow">and</span> <span class="n">email</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">email</span><span class="p">:</span>
<a id="__codelineno-7-99" name="__codelineno-7-99" href="#__codelineno-7-99"></a>            <span class="n">changes</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">email</span>
<a id="__codelineno-7-100" name="__codelineno-7-100" href="#__codelineno-7-100"></a>        <span class="k">if</span> <span class="n">phone</span> <span class="ow">and</span> <span class="n">phone</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phone</span><span class="p">:</span>
<a id="__codelineno-7-101" name="__codelineno-7-101" href="#__codelineno-7-101"></a>            <span class="n">changes</span><span class="p">[</span><span class="s1">&#39;phone&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">phone</span>
<a id="__codelineno-7-102" name="__codelineno-7-102" href="#__codelineno-7-102"></a>
<a id="__codelineno-7-103" name="__codelineno-7-103" href="#__codelineno-7-103"></a>        <span class="k">if</span> <span class="n">changes</span><span class="p">:</span>
<a id="__codelineno-7-104" name="__codelineno-7-104" href="#__codelineno-7-104"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_raise_event</span><span class="p">(</span><span class="n">CustomerContactUpdatedEvent</span><span class="p">(</span>
<a id="__codelineno-7-105" name="__codelineno-7-105" href="#__codelineno-7-105"></a>                <span class="n">event_id</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()),</span>
<a id="__codelineno-7-106" name="__codelineno-7-106" href="#__codelineno-7-106"></a>                <span class="n">aggregate_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_id</span><span class="p">,</span>
<a id="__codelineno-7-107" name="__codelineno-7-107" href="#__codelineno-7-107"></a>                <span class="n">customer_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_id</span><span class="p">,</span>
<a id="__codelineno-7-108" name="__codelineno-7-108" href="#__codelineno-7-108"></a>                <span class="n">changes</span><span class="o">=</span><span class="n">changes</span><span class="p">,</span>
<a id="__codelineno-7-109" name="__codelineno-7-109" href="#__codelineno-7-109"></a>                <span class="n">timestamp</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
<a id="__codelineno-7-110" name="__codelineno-7-110" href="#__codelineno-7-110"></a>            <span class="p">))</span>
<a id="__codelineno-7-111" name="__codelineno-7-111" href="#__codelineno-7-111"></a>
<a id="__codelineno-7-112" name="__codelineno-7-112" href="#__codelineno-7-112"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">record_interaction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">interaction_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-7-113" name="__codelineno-7-113" href="#__codelineno-7-113"></a>                          <span class="n">content</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">sentiment_score</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-7-114" name="__codelineno-7-114" href="#__codelineno-7-114"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Enregistre une interaction avec un agent&quot;&quot;&quot;</span>
<a id="__codelineno-7-115" name="__codelineno-7-115" href="#__codelineno-7-115"></a>        <span class="n">interaction_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
<a id="__codelineno-7-116" name="__codelineno-7-116" href="#__codelineno-7-116"></a>
<a id="__codelineno-7-117" name="__codelineno-7-117" href="#__codelineno-7-117"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_raise_event</span><span class="p">(</span><span class="n">InteractionRecordedEvent</span><span class="p">(</span>
<a id="__codelineno-7-118" name="__codelineno-7-118" href="#__codelineno-7-118"></a>            <span class="n">event_id</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()),</span>
<a id="__codelineno-7-119" name="__codelineno-7-119" href="#__codelineno-7-119"></a>            <span class="n">aggregate_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_id</span><span class="p">,</span>
<a id="__codelineno-7-120" name="__codelineno-7-120" href="#__codelineno-7-120"></a>            <span class="n">customer_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_id</span><span class="p">,</span>
<a id="__codelineno-7-121" name="__codelineno-7-121" href="#__codelineno-7-121"></a>            <span class="n">agent_id</span><span class="o">=</span><span class="n">agent_id</span><span class="p">,</span>
<a id="__codelineno-7-122" name="__codelineno-7-122" href="#__codelineno-7-122"></a>            <span class="n">interaction_id</span><span class="o">=</span><span class="n">interaction_id</span><span class="p">,</span>
<a id="__codelineno-7-123" name="__codelineno-7-123" href="#__codelineno-7-123"></a>            <span class="n">interaction_type</span><span class="o">=</span><span class="n">interaction_type</span><span class="p">,</span>
<a id="__codelineno-7-124" name="__codelineno-7-124" href="#__codelineno-7-124"></a>            <span class="n">content</span><span class="o">=</span><span class="n">content</span><span class="p">,</span>
<a id="__codelineno-7-125" name="__codelineno-7-125" href="#__codelineno-7-125"></a>            <span class="n">sentiment_score</span><span class="o">=</span><span class="n">sentiment_score</span><span class="p">,</span>
<a id="__codelineno-7-126" name="__codelineno-7-126" href="#__codelineno-7-126"></a>            <span class="n">timestamp</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
<a id="__codelineno-7-127" name="__codelineno-7-127" href="#__codelineno-7-127"></a>        <span class="p">))</span>
<a id="__codelineno-7-128" name="__codelineno-7-128" href="#__codelineno-7-128"></a>
<a id="__codelineno-7-129" name="__codelineno-7-129" href="#__codelineno-7-129"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">deactivate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reason</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-7-130" name="__codelineno-7-130" href="#__codelineno-7-130"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Désactive le compte client&quot;&quot;&quot;</span>
<a id="__codelineno-7-131" name="__codelineno-7-131" href="#__codelineno-7-131"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="s1">&#39;active&#39;</span><span class="p">:</span>
<a id="__codelineno-7-132" name="__codelineno-7-132" href="#__codelineno-7-132"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Le client n&#39;est pas actif&quot;</span><span class="p">)</span>
<a id="__codelineno-7-133" name="__codelineno-7-133" href="#__codelineno-7-133"></a>
<a id="__codelineno-7-134" name="__codelineno-7-134" href="#__codelineno-7-134"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_raise_event</span><span class="p">(</span><span class="n">CustomerDeactivatedEvent</span><span class="p">(</span>
<a id="__codelineno-7-135" name="__codelineno-7-135" href="#__codelineno-7-135"></a>            <span class="n">event_id</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()),</span>
<a id="__codelineno-7-136" name="__codelineno-7-136" href="#__codelineno-7-136"></a>            <span class="n">aggregate_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_id</span><span class="p">,</span>
<a id="__codelineno-7-137" name="__codelineno-7-137" href="#__codelineno-7-137"></a>            <span class="n">customer_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_id</span><span class="p">,</span>
<a id="__codelineno-7-138" name="__codelineno-7-138" href="#__codelineno-7-138"></a>            <span class="n">reason</span><span class="o">=</span><span class="n">reason</span><span class="p">,</span>
<a id="__codelineno-7-139" name="__codelineno-7-139" href="#__codelineno-7-139"></a>            <span class="n">timestamp</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
<a id="__codelineno-7-140" name="__codelineno-7-140" href="#__codelineno-7-140"></a>        <span class="p">))</span>
<a id="__codelineno-7-141" name="__codelineno-7-141" href="#__codelineno-7-141"></a>
<a id="__codelineno-7-142" name="__codelineno-7-142" href="#__codelineno-7-142"></a>    <span class="c1"># Applicateurs d&#39;événements</span>
<a id="__codelineno-7-143" name="__codelineno-7-143" href="#__codelineno-7-143"></a>
<a id="__codelineno-7-144" name="__codelineno-7-144" href="#__codelineno-7-144"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_apply_customer_created</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-7-145" name="__codelineno-7-145" href="#__codelineno-7-145"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">event_data</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
<a id="__codelineno-7-146" name="__codelineno-7-146" href="#__codelineno-7-146"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">event_data</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">]</span>
<a id="__codelineno-7-147" name="__codelineno-7-147" href="#__codelineno-7-147"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">phone</span> <span class="o">=</span> <span class="n">event_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;phone&#39;</span><span class="p">)</span>
<a id="__codelineno-7-148" name="__codelineno-7-148" href="#__codelineno-7-148"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;active&#39;</span>
<a id="__codelineno-7-149" name="__codelineno-7-149" href="#__codelineno-7-149"></a>
<a id="__codelineno-7-150" name="__codelineno-7-150" href="#__codelineno-7-150"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_apply_customer_contact_updated</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-7-151" name="__codelineno-7-151" href="#__codelineno-7-151"></a>        <span class="n">changes</span> <span class="o">=</span> <span class="n">event_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;changes&#39;</span><span class="p">,</span> <span class="p">{})</span>
<a id="__codelineno-7-152" name="__codelineno-7-152" href="#__codelineno-7-152"></a>        <span class="k">if</span> <span class="s1">&#39;email&#39;</span> <span class="ow">in</span> <span class="n">changes</span><span class="p">:</span>
<a id="__codelineno-7-153" name="__codelineno-7-153" href="#__codelineno-7-153"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">changes</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">]</span>
<a id="__codelineno-7-154" name="__codelineno-7-154" href="#__codelineno-7-154"></a>        <span class="k">if</span> <span class="s1">&#39;phone&#39;</span> <span class="ow">in</span> <span class="n">changes</span><span class="p">:</span>
<a id="__codelineno-7-155" name="__codelineno-7-155" href="#__codelineno-7-155"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">phone</span> <span class="o">=</span> <span class="n">changes</span><span class="p">[</span><span class="s1">&#39;phone&#39;</span><span class="p">]</span>
<a id="__codelineno-7-156" name="__codelineno-7-156" href="#__codelineno-7-156"></a>
<a id="__codelineno-7-157" name="__codelineno-7-157" href="#__codelineno-7-157"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_apply_interaction_recorded</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-7-158" name="__codelineno-7-158" href="#__codelineno-7-158"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">interactions</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
<a id="__codelineno-7-159" name="__codelineno-7-159" href="#__codelineno-7-159"></a>            <span class="s1">&#39;interaction_id&#39;</span><span class="p">:</span> <span class="n">event_data</span><span class="p">[</span><span class="s1">&#39;interaction_id&#39;</span><span class="p">],</span>
<a id="__codelineno-7-160" name="__codelineno-7-160" href="#__codelineno-7-160"></a>            <span class="s1">&#39;agent_id&#39;</span><span class="p">:</span> <span class="n">event_data</span><span class="p">[</span><span class="s1">&#39;agent_id&#39;</span><span class="p">],</span>
<a id="__codelineno-7-161" name="__codelineno-7-161" href="#__codelineno-7-161"></a>            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="n">event_data</span><span class="p">[</span><span class="s1">&#39;interaction_type&#39;</span><span class="p">],</span>
<a id="__codelineno-7-162" name="__codelineno-7-162" href="#__codelineno-7-162"></a>            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">event_data</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span>
<a id="__codelineno-7-163" name="__codelineno-7-163" href="#__codelineno-7-163"></a>        <span class="p">})</span>
<a id="__codelineno-7-164" name="__codelineno-7-164" href="#__codelineno-7-164"></a>
<a id="__codelineno-7-165" name="__codelineno-7-165" href="#__codelineno-7-165"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_apply_customer_deactivated</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-7-166" name="__codelineno-7-166" href="#__codelineno-7-166"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;inactive&#39;</span>
<a id="__codelineno-7-167" name="__codelineno-7-167" href="#__codelineno-7-167"></a>
<a id="__codelineno-7-168" name="__codelineno-7-168" href="#__codelineno-7-168"></a>
<a id="__codelineno-7-169" name="__codelineno-7-169" href="#__codelineno-7-169"></a><span class="k">class</span><span class="w"> </span><span class="nc">AggregateRepository</span><span class="p">:</span>
<a id="__codelineno-7-170" name="__codelineno-7-170" href="#__codelineno-7-170"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Repository pour les agrégats Event-Sourced&quot;&quot;&quot;</span>
<a id="__codelineno-7-171" name="__codelineno-7-171" href="#__codelineno-7-171"></a>
<a id="__codelineno-7-172" name="__codelineno-7-172" href="#__codelineno-7-172"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_store</span><span class="p">:</span> <span class="n">EventStore</span><span class="p">,</span> <span class="n">aggregate_class</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">AggregateRoot</span><span class="p">]):</span>
<a id="__codelineno-7-173" name="__codelineno-7-173" href="#__codelineno-7-173"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">event_store</span> <span class="o">=</span> <span class="n">event_store</span>
<a id="__codelineno-7-174" name="__codelineno-7-174" href="#__codelineno-7-174"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">aggregate_class</span> <span class="o">=</span> <span class="n">aggregate_class</span>
<a id="__codelineno-7-175" name="__codelineno-7-175" href="#__codelineno-7-175"></a>
<a id="__codelineno-7-176" name="__codelineno-7-176" href="#__codelineno-7-176"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">aggregate_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AggregateRoot</span><span class="p">]:</span>
<a id="__codelineno-7-177" name="__codelineno-7-177" href="#__codelineno-7-177"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Charge un agrégat depuis l&#39;Event Store&quot;&quot;&quot;</span>
<a id="__codelineno-7-178" name="__codelineno-7-178" href="#__codelineno-7-178"></a>        <span class="n">aggregate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aggregate_class</span><span class="p">(</span><span class="n">aggregate_id</span><span class="p">)</span>
<a id="__codelineno-7-179" name="__codelineno-7-179" href="#__codelineno-7-179"></a>
<a id="__codelineno-7-180" name="__codelineno-7-180" href="#__codelineno-7-180"></a>        <span class="n">events</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_store</span><span class="o">.</span><span class="n">get_events</span><span class="p">(</span>
<a id="__codelineno-7-181" name="__codelineno-7-181" href="#__codelineno-7-181"></a>            <span class="n">aggregate</span><span class="o">.</span><span class="n">_get_aggregate_type</span><span class="p">(),</span>
<a id="__codelineno-7-182" name="__codelineno-7-182" href="#__codelineno-7-182"></a>            <span class="n">aggregate_id</span>
<a id="__codelineno-7-183" name="__codelineno-7-183" href="#__codelineno-7-183"></a>        <span class="p">)</span>
<a id="__codelineno-7-184" name="__codelineno-7-184" href="#__codelineno-7-184"></a>
<a id="__codelineno-7-185" name="__codelineno-7-185" href="#__codelineno-7-185"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">events</span><span class="p">:</span>
<a id="__codelineno-7-186" name="__codelineno-7-186" href="#__codelineno-7-186"></a>            <span class="k">return</span> <span class="kc">None</span>
<a id="__codelineno-7-187" name="__codelineno-7-187" href="#__codelineno-7-187"></a>
<a id="__codelineno-7-188" name="__codelineno-7-188" href="#__codelineno-7-188"></a>        <span class="n">aggregate</span><span class="o">.</span><span class="n">load_from_history</span><span class="p">(</span><span class="n">events</span><span class="p">)</span>
<a id="__codelineno-7-189" name="__codelineno-7-189" href="#__codelineno-7-189"></a>        <span class="k">return</span> <span class="n">aggregate</span>
<a id="__codelineno-7-190" name="__codelineno-7-190" href="#__codelineno-7-190"></a>
<a id="__codelineno-7-191" name="__codelineno-7-191" href="#__codelineno-7-191"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">aggregate</span><span class="p">:</span> <span class="n">AggregateRoot</span><span class="p">):</span>
<a id="__codelineno-7-192" name="__codelineno-7-192" href="#__codelineno-7-192"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Sauvegarde les nouveaux événements d&#39;un agrégat&quot;&quot;&quot;</span>
<a id="__codelineno-7-193" name="__codelineno-7-193" href="#__codelineno-7-193"></a>        <span class="n">pending</span> <span class="o">=</span> <span class="n">aggregate</span><span class="o">.</span><span class="n">pending_events</span>
<a id="__codelineno-7-194" name="__codelineno-7-194" href="#__codelineno-7-194"></a>
<a id="__codelineno-7-195" name="__codelineno-7-195" href="#__codelineno-7-195"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">pending</span><span class="p">:</span>
<a id="__codelineno-7-196" name="__codelineno-7-196" href="#__codelineno-7-196"></a>            <span class="k">return</span>
<a id="__codelineno-7-197" name="__codelineno-7-197" href="#__codelineno-7-197"></a>
<a id="__codelineno-7-198" name="__codelineno-7-198" href="#__codelineno-7-198"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_store</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
<a id="__codelineno-7-199" name="__codelineno-7-199" href="#__codelineno-7-199"></a>            <span class="n">aggregate_type</span><span class="o">=</span><span class="n">aggregate</span><span class="o">.</span><span class="n">_get_aggregate_type</span><span class="p">(),</span>
<a id="__codelineno-7-200" name="__codelineno-7-200" href="#__codelineno-7-200"></a>            <span class="n">aggregate_id</span><span class="o">=</span><span class="n">aggregate</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
<a id="__codelineno-7-201" name="__codelineno-7-201" href="#__codelineno-7-201"></a>            <span class="n">events</span><span class="o">=</span><span class="n">pending</span><span class="p">,</span>
<a id="__codelineno-7-202" name="__codelineno-7-202" href="#__codelineno-7-202"></a>            <span class="n">expected_version</span><span class="o">=</span><span class="n">aggregate</span><span class="o">.</span><span class="n">version</span>
<a id="__codelineno-7-203" name="__codelineno-7-203" href="#__codelineno-7-203"></a>        <span class="p">)</span>
<a id="__codelineno-7-204" name="__codelineno-7-204" href="#__codelineno-7-204"></a>
<a id="__codelineno-7-205" name="__codelineno-7-205" href="#__codelineno-7-205"></a>        <span class="n">aggregate</span><span class="o">.</span><span class="n">clear_pending_events</span><span class="p">()</span>
</code></pre></div>
<blockquote>
<p><strong>Attention</strong><br />
L'Event Sourcing génère un volume important de données. Implémentez des mécanismes de snapshot pour les agrégats avec un long historique, et définissez des politiques de rétention adaptées à vos besoins de conformité.</p>
</blockquote>
<h3 id="snapshots-et-optimisation-de-performance">Snapshots et Optimisation de Performance<a class="headerlink" href="#snapshots-et-optimisation-de-performance" title="Permanent link">&para;</a></h3>
<p>À mesure que le nombre d'événements d'un agrégat croît, le temps de reconstruction de l'état augmente linéairement. Pour un agrégat avec des milliers d'événements, cette reconstruction peut devenir prohibitive. Les snapshots résolvent ce problème en capturant périodiquement l'état complet de l'agrégat, permettant de ne rejouer que les événements postérieurs au dernier snapshot.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="c1"># eventsourcing/snapshots.py</span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span>
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a>
<a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a><span class="nd">@dataclass</span>
<a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a><span class="k">class</span><span class="w"> </span><span class="nc">Snapshot</span><span class="p">:</span>
<a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Capture de l&#39;état d&#39;un agrégat à un instant donné&quot;&quot;&quot;</span>
<a id="__codelineno-8-10" name="__codelineno-8-10" href="#__codelineno-8-10"></a>    <span class="n">aggregate_type</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-8-11" name="__codelineno-8-11" href="#__codelineno-8-11"></a>    <span class="n">aggregate_id</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-8-12" name="__codelineno-8-12" href="#__codelineno-8-12"></a>    <span class="n">version</span><span class="p">:</span> <span class="nb">int</span>
<a id="__codelineno-8-13" name="__codelineno-8-13" href="#__codelineno-8-13"></a>    <span class="n">state</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
<a id="__codelineno-8-14" name="__codelineno-8-14" href="#__codelineno-8-14"></a>    <span class="n">timestamp</span><span class="p">:</span> <span class="n">datetime</span>
<a id="__codelineno-8-15" name="__codelineno-8-15" href="#__codelineno-8-15"></a>    <span class="n">checksum</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-8-16" name="__codelineno-8-16" href="#__codelineno-8-16"></a>
<a id="__codelineno-8-17" name="__codelineno-8-17" href="#__codelineno-8-17"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">to_json</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-8-18" name="__codelineno-8-18" href="#__codelineno-8-18"></a>        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span>
<a id="__codelineno-8-19" name="__codelineno-8-19" href="#__codelineno-8-19"></a>            <span class="s1">&#39;aggregate_type&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">aggregate_type</span><span class="p">,</span>
<a id="__codelineno-8-20" name="__codelineno-8-20" href="#__codelineno-8-20"></a>            <span class="s1">&#39;aggregate_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">aggregate_id</span><span class="p">,</span>
<a id="__codelineno-8-21" name="__codelineno-8-21" href="#__codelineno-8-21"></a>            <span class="s1">&#39;version&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">,</span>
<a id="__codelineno-8-22" name="__codelineno-8-22" href="#__codelineno-8-22"></a>            <span class="s1">&#39;state&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">,</span>
<a id="__codelineno-8-23" name="__codelineno-8-23" href="#__codelineno-8-23"></a>            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestamp</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
<a id="__codelineno-8-24" name="__codelineno-8-24" href="#__codelineno-8-24"></a>        <span class="p">})</span>
<a id="__codelineno-8-25" name="__codelineno-8-25" href="#__codelineno-8-25"></a>
<a id="__codelineno-8-26" name="__codelineno-8-26" href="#__codelineno-8-26"></a>
<a id="__codelineno-8-27" name="__codelineno-8-27" href="#__codelineno-8-27"></a><span class="k">class</span><span class="w"> </span><span class="nc">SnapshotStore</span><span class="p">:</span>
<a id="__codelineno-8-28" name="__codelineno-8-28" href="#__codelineno-8-28"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Gestionnaire de snapshots pour les agrégats&quot;&quot;&quot;</span>
<a id="__codelineno-8-29" name="__codelineno-8-29" href="#__codelineno-8-29"></a>
<a id="__codelineno-8-30" name="__codelineno-8-30" href="#__codelineno-8-30"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db_pool</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-8-31" name="__codelineno-8-31" href="#__codelineno-8-31"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">db_pool</span>
<a id="__codelineno-8-32" name="__codelineno-8-32" href="#__codelineno-8-32"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">snapshot_interval</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;snapshot_interval&#39;</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<a id="__codelineno-8-33" name="__codelineno-8-33" href="#__codelineno-8-33"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">max_snapshots_per_aggregate</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_snapshots&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<a id="__codelineno-8-34" name="__codelineno-8-34" href="#__codelineno-8-34"></a>
<a id="__codelineno-8-35" name="__codelineno-8-35" href="#__codelineno-8-35"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">save_snapshot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">aggregate</span><span class="p">:</span> <span class="n">AggregateRoot</span><span class="p">):</span>
<a id="__codelineno-8-36" name="__codelineno-8-36" href="#__codelineno-8-36"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Sauvegarde un snapshot de l&#39;agrégat&quot;&quot;&quot;</span>
<a id="__codelineno-8-37" name="__codelineno-8-37" href="#__codelineno-8-37"></a>
<a id="__codelineno-8-38" name="__codelineno-8-38" href="#__codelineno-8-38"></a>        <span class="n">snapshot</span> <span class="o">=</span> <span class="n">Snapshot</span><span class="p">(</span>
<a id="__codelineno-8-39" name="__codelineno-8-39" href="#__codelineno-8-39"></a>            <span class="n">aggregate_type</span><span class="o">=</span><span class="n">aggregate</span><span class="o">.</span><span class="n">_get_aggregate_type</span><span class="p">(),</span>
<a id="__codelineno-8-40" name="__codelineno-8-40" href="#__codelineno-8-40"></a>            <span class="n">aggregate_id</span><span class="o">=</span><span class="n">aggregate</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
<a id="__codelineno-8-41" name="__codelineno-8-41" href="#__codelineno-8-41"></a>            <span class="n">version</span><span class="o">=</span><span class="n">aggregate</span><span class="o">.</span><span class="n">version</span><span class="p">,</span>
<a id="__codelineno-8-42" name="__codelineno-8-42" href="#__codelineno-8-42"></a>            <span class="n">state</span><span class="o">=</span><span class="n">aggregate</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(),</span>
<a id="__codelineno-8-43" name="__codelineno-8-43" href="#__codelineno-8-43"></a>            <span class="n">timestamp</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
<a id="__codelineno-8-44" name="__codelineno-8-44" href="#__codelineno-8-44"></a>        <span class="p">)</span>
<a id="__codelineno-8-45" name="__codelineno-8-45" href="#__codelineno-8-45"></a>
<a id="__codelineno-8-46" name="__codelineno-8-46" href="#__codelineno-8-46"></a>        <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
<a id="__codelineno-8-47" name="__codelineno-8-47" href="#__codelineno-8-47"></a>            <span class="k">async</span> <span class="k">with</span> <span class="n">conn</span><span class="o">.</span><span class="n">transaction</span><span class="p">():</span>
<a id="__codelineno-8-48" name="__codelineno-8-48" href="#__codelineno-8-48"></a>                <span class="c1"># Insertion du nouveau snapshot</span>
<a id="__codelineno-8-49" name="__codelineno-8-49" href="#__codelineno-8-49"></a>                <span class="k">await</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-8-50" name="__codelineno-8-50" href="#__codelineno-8-50"></a><span class="s2">                    INSERT INTO snapshots </span>
<a id="__codelineno-8-51" name="__codelineno-8-51" href="#__codelineno-8-51"></a><span class="s2">                    (aggregate_type, aggregate_id, version, state, timestamp)</span>
<a id="__codelineno-8-52" name="__codelineno-8-52" href="#__codelineno-8-52"></a><span class="s2">                    VALUES ($1, $2, $3, $4, $5)</span>
<a id="__codelineno-8-53" name="__codelineno-8-53" href="#__codelineno-8-53"></a><span class="s2">                &quot;&quot;&quot;</span><span class="p">,</span>
<a id="__codelineno-8-54" name="__codelineno-8-54" href="#__codelineno-8-54"></a>                    <span class="n">snapshot</span><span class="o">.</span><span class="n">aggregate_type</span><span class="p">,</span>
<a id="__codelineno-8-55" name="__codelineno-8-55" href="#__codelineno-8-55"></a>                    <span class="n">snapshot</span><span class="o">.</span><span class="n">aggregate_id</span><span class="p">,</span>
<a id="__codelineno-8-56" name="__codelineno-8-56" href="#__codelineno-8-56"></a>                    <span class="n">snapshot</span><span class="o">.</span><span class="n">version</span><span class="p">,</span>
<a id="__codelineno-8-57" name="__codelineno-8-57" href="#__codelineno-8-57"></a>                    <span class="n">snapshot</span><span class="o">.</span><span class="n">to_json</span><span class="p">(),</span>
<a id="__codelineno-8-58" name="__codelineno-8-58" href="#__codelineno-8-58"></a>                    <span class="n">snapshot</span><span class="o">.</span><span class="n">timestamp</span>
<a id="__codelineno-8-59" name="__codelineno-8-59" href="#__codelineno-8-59"></a>                <span class="p">)</span>
<a id="__codelineno-8-60" name="__codelineno-8-60" href="#__codelineno-8-60"></a>
<a id="__codelineno-8-61" name="__codelineno-8-61" href="#__codelineno-8-61"></a>                <span class="c1"># Nettoyage des anciens snapshots</span>
<a id="__codelineno-8-62" name="__codelineno-8-62" href="#__codelineno-8-62"></a>                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cleanup_old_snapshots</span><span class="p">(</span>
<a id="__codelineno-8-63" name="__codelineno-8-63" href="#__codelineno-8-63"></a>                    <span class="n">conn</span><span class="p">,</span>
<a id="__codelineno-8-64" name="__codelineno-8-64" href="#__codelineno-8-64"></a>                    <span class="n">snapshot</span><span class="o">.</span><span class="n">aggregate_type</span><span class="p">,</span>
<a id="__codelineno-8-65" name="__codelineno-8-65" href="#__codelineno-8-65"></a>                    <span class="n">snapshot</span><span class="o">.</span><span class="n">aggregate_id</span>
<a id="__codelineno-8-66" name="__codelineno-8-66" href="#__codelineno-8-66"></a>                <span class="p">)</span>
<a id="__codelineno-8-67" name="__codelineno-8-67" href="#__codelineno-8-67"></a>
<a id="__codelineno-8-68" name="__codelineno-8-68" href="#__codelineno-8-68"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_latest_snapshot</span><span class="p">(</span>
<a id="__codelineno-8-69" name="__codelineno-8-69" href="#__codelineno-8-69"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-8-70" name="__codelineno-8-70" href="#__codelineno-8-70"></a>        <span class="n">aggregate_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-8-71" name="__codelineno-8-71" href="#__codelineno-8-71"></a>        <span class="n">aggregate_id</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-8-72" name="__codelineno-8-72" href="#__codelineno-8-72"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Snapshot</span><span class="p">]:</span>
<a id="__codelineno-8-73" name="__codelineno-8-73" href="#__codelineno-8-73"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Récupère le dernier snapshot d&#39;un agrégat&quot;&quot;&quot;</span>
<a id="__codelineno-8-74" name="__codelineno-8-74" href="#__codelineno-8-74"></a>
<a id="__codelineno-8-75" name="__codelineno-8-75" href="#__codelineno-8-75"></a>        <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
<a id="__codelineno-8-76" name="__codelineno-8-76" href="#__codelineno-8-76"></a>            <span class="n">row</span> <span class="o">=</span> <span class="k">await</span> <span class="n">conn</span><span class="o">.</span><span class="n">fetchrow</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-8-77" name="__codelineno-8-77" href="#__codelineno-8-77"></a><span class="s2">                SELECT aggregate_type, aggregate_id, version, state, timestamp</span>
<a id="__codelineno-8-78" name="__codelineno-8-78" href="#__codelineno-8-78"></a><span class="s2">                FROM snapshots</span>
<a id="__codelineno-8-79" name="__codelineno-8-79" href="#__codelineno-8-79"></a><span class="s2">                WHERE aggregate_type = $1 AND aggregate_id = $2</span>
<a id="__codelineno-8-80" name="__codelineno-8-80" href="#__codelineno-8-80"></a><span class="s2">                ORDER BY version DESC</span>
<a id="__codelineno-8-81" name="__codelineno-8-81" href="#__codelineno-8-81"></a><span class="s2">                LIMIT 1</span>
<a id="__codelineno-8-82" name="__codelineno-8-82" href="#__codelineno-8-82"></a><span class="s2">            &quot;&quot;&quot;</span><span class="p">,</span> <span class="n">aggregate_type</span><span class="p">,</span> <span class="n">aggregate_id</span><span class="p">)</span>
<a id="__codelineno-8-83" name="__codelineno-8-83" href="#__codelineno-8-83"></a>
<a id="__codelineno-8-84" name="__codelineno-8-84" href="#__codelineno-8-84"></a>            <span class="k">if</span> <span class="n">row</span><span class="p">:</span>
<a id="__codelineno-8-85" name="__codelineno-8-85" href="#__codelineno-8-85"></a>                <span class="n">state_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">])</span>
<a id="__codelineno-8-86" name="__codelineno-8-86" href="#__codelineno-8-86"></a>                <span class="k">return</span> <span class="n">Snapshot</span><span class="p">(</span>
<a id="__codelineno-8-87" name="__codelineno-8-87" href="#__codelineno-8-87"></a>                    <span class="n">aggregate_type</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;aggregate_type&#39;</span><span class="p">],</span>
<a id="__codelineno-8-88" name="__codelineno-8-88" href="#__codelineno-8-88"></a>                    <span class="n">aggregate_id</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;aggregate_id&#39;</span><span class="p">],</span>
<a id="__codelineno-8-89" name="__codelineno-8-89" href="#__codelineno-8-89"></a>                    <span class="n">version</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;version&#39;</span><span class="p">],</span>
<a id="__codelineno-8-90" name="__codelineno-8-90" href="#__codelineno-8-90"></a>                    <span class="n">state</span><span class="o">=</span><span class="n">state_data</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">],</span>
<a id="__codelineno-8-91" name="__codelineno-8-91" href="#__codelineno-8-91"></a>                    <span class="n">timestamp</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span>
<a id="__codelineno-8-92" name="__codelineno-8-92" href="#__codelineno-8-92"></a>                <span class="p">)</span>
<a id="__codelineno-8-93" name="__codelineno-8-93" href="#__codelineno-8-93"></a>
<a id="__codelineno-8-94" name="__codelineno-8-94" href="#__codelineno-8-94"></a>            <span class="k">return</span> <span class="kc">None</span>
<a id="__codelineno-8-95" name="__codelineno-8-95" href="#__codelineno-8-95"></a>
<a id="__codelineno-8-96" name="__codelineno-8-96" href="#__codelineno-8-96"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">should_snapshot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">aggregate</span><span class="p">:</span> <span class="n">AggregateRoot</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-8-97" name="__codelineno-8-97" href="#__codelineno-8-97"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Détermine si un snapshot doit être créé&quot;&quot;&quot;</span>
<a id="__codelineno-8-98" name="__codelineno-8-98" href="#__codelineno-8-98"></a>
<a id="__codelineno-8-99" name="__codelineno-8-99" href="#__codelineno-8-99"></a>        <span class="k">if</span> <span class="n">aggregate</span><span class="o">.</span><span class="n">version</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">snapshot_interval</span><span class="p">:</span>
<a id="__codelineno-8-100" name="__codelineno-8-100" href="#__codelineno-8-100"></a>            <span class="k">return</span> <span class="kc">False</span>
<a id="__codelineno-8-101" name="__codelineno-8-101" href="#__codelineno-8-101"></a>
<a id="__codelineno-8-102" name="__codelineno-8-102" href="#__codelineno-8-102"></a>        <span class="n">latest</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_latest_snapshot</span><span class="p">(</span>
<a id="__codelineno-8-103" name="__codelineno-8-103" href="#__codelineno-8-103"></a>            <span class="n">aggregate</span><span class="o">.</span><span class="n">_get_aggregate_type</span><span class="p">(),</span>
<a id="__codelineno-8-104" name="__codelineno-8-104" href="#__codelineno-8-104"></a>            <span class="n">aggregate</span><span class="o">.</span><span class="n">id</span>
<a id="__codelineno-8-105" name="__codelineno-8-105" href="#__codelineno-8-105"></a>        <span class="p">)</span>
<a id="__codelineno-8-106" name="__codelineno-8-106" href="#__codelineno-8-106"></a>
<a id="__codelineno-8-107" name="__codelineno-8-107" href="#__codelineno-8-107"></a>        <span class="k">if</span> <span class="n">latest</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-8-108" name="__codelineno-8-108" href="#__codelineno-8-108"></a>            <span class="k">return</span> <span class="kc">True</span>
<a id="__codelineno-8-109" name="__codelineno-8-109" href="#__codelineno-8-109"></a>
<a id="__codelineno-8-110" name="__codelineno-8-110" href="#__codelineno-8-110"></a>        <span class="n">events_since_snapshot</span> <span class="o">=</span> <span class="n">aggregate</span><span class="o">.</span><span class="n">version</span> <span class="o">-</span> <span class="n">latest</span><span class="o">.</span><span class="n">version</span>
<a id="__codelineno-8-111" name="__codelineno-8-111" href="#__codelineno-8-111"></a>        <span class="k">return</span> <span class="n">events_since_snapshot</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">snapshot_interval</span>
<a id="__codelineno-8-112" name="__codelineno-8-112" href="#__codelineno-8-112"></a>
<a id="__codelineno-8-113" name="__codelineno-8-113" href="#__codelineno-8-113"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_cleanup_old_snapshots</span><span class="p">(</span>
<a id="__codelineno-8-114" name="__codelineno-8-114" href="#__codelineno-8-114"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-8-115" name="__codelineno-8-115" href="#__codelineno-8-115"></a>        <span class="n">conn</span><span class="p">,</span>
<a id="__codelineno-8-116" name="__codelineno-8-116" href="#__codelineno-8-116"></a>        <span class="n">aggregate_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-8-117" name="__codelineno-8-117" href="#__codelineno-8-117"></a>        <span class="n">aggregate_id</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-8-118" name="__codelineno-8-118" href="#__codelineno-8-118"></a>    <span class="p">):</span>
<a id="__codelineno-8-119" name="__codelineno-8-119" href="#__codelineno-8-119"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Supprime les snapshots excédentaires&quot;&quot;&quot;</span>
<a id="__codelineno-8-120" name="__codelineno-8-120" href="#__codelineno-8-120"></a>
<a id="__codelineno-8-121" name="__codelineno-8-121" href="#__codelineno-8-121"></a>        <span class="k">await</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-8-122" name="__codelineno-8-122" href="#__codelineno-8-122"></a><span class="s2">            DELETE FROM snapshots</span>
<a id="__codelineno-8-123" name="__codelineno-8-123" href="#__codelineno-8-123"></a><span class="s2">            WHERE aggregate_type = $1 </span>
<a id="__codelineno-8-124" name="__codelineno-8-124" href="#__codelineno-8-124"></a><span class="s2">              AND aggregate_id = $2</span>
<a id="__codelineno-8-125" name="__codelineno-8-125" href="#__codelineno-8-125"></a><span class="s2">              AND version NOT IN (</span>
<a id="__codelineno-8-126" name="__codelineno-8-126" href="#__codelineno-8-126"></a><span class="s2">                  SELECT version FROM snapshots</span>
<a id="__codelineno-8-127" name="__codelineno-8-127" href="#__codelineno-8-127"></a><span class="s2">                  WHERE aggregate_type = $1 AND aggregate_id = $2</span>
<a id="__codelineno-8-128" name="__codelineno-8-128" href="#__codelineno-8-128"></a><span class="s2">                  ORDER BY version DESC</span>
<a id="__codelineno-8-129" name="__codelineno-8-129" href="#__codelineno-8-129"></a><span class="s2">                  LIMIT $3</span>
<a id="__codelineno-8-130" name="__codelineno-8-130" href="#__codelineno-8-130"></a><span class="s2">              )</span>
<a id="__codelineno-8-131" name="__codelineno-8-131" href="#__codelineno-8-131"></a><span class="s2">        &quot;&quot;&quot;</span><span class="p">,</span> <span class="n">aggregate_type</span><span class="p">,</span> <span class="n">aggregate_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_snapshots_per_aggregate</span><span class="p">)</span>
<a id="__codelineno-8-132" name="__codelineno-8-132" href="#__codelineno-8-132"></a>
<a id="__codelineno-8-133" name="__codelineno-8-133" href="#__codelineno-8-133"></a>
<a id="__codelineno-8-134" name="__codelineno-8-134" href="#__codelineno-8-134"></a><span class="k">class</span><span class="w"> </span><span class="nc">OptimizedAggregateRepository</span><span class="p">:</span>
<a id="__codelineno-8-135" name="__codelineno-8-135" href="#__codelineno-8-135"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Repository avec support des snapshots&quot;&quot;&quot;</span>
<a id="__codelineno-8-136" name="__codelineno-8-136" href="#__codelineno-8-136"></a>
<a id="__codelineno-8-137" name="__codelineno-8-137" href="#__codelineno-8-137"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-8-138" name="__codelineno-8-138" href="#__codelineno-8-138"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-8-139" name="__codelineno-8-139" href="#__codelineno-8-139"></a>        <span class="n">event_store</span><span class="p">:</span> <span class="n">EventStore</span><span class="p">,</span>
<a id="__codelineno-8-140" name="__codelineno-8-140" href="#__codelineno-8-140"></a>        <span class="n">snapshot_store</span><span class="p">:</span> <span class="n">SnapshotStore</span><span class="p">,</span>
<a id="__codelineno-8-141" name="__codelineno-8-141" href="#__codelineno-8-141"></a>        <span class="n">aggregate_class</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">AggregateRoot</span><span class="p">]</span>
<a id="__codelineno-8-142" name="__codelineno-8-142" href="#__codelineno-8-142"></a>    <span class="p">):</span>
<a id="__codelineno-8-143" name="__codelineno-8-143" href="#__codelineno-8-143"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">event_store</span> <span class="o">=</span> <span class="n">event_store</span>
<a id="__codelineno-8-144" name="__codelineno-8-144" href="#__codelineno-8-144"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">snapshot_store</span> <span class="o">=</span> <span class="n">snapshot_store</span>
<a id="__codelineno-8-145" name="__codelineno-8-145" href="#__codelineno-8-145"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">aggregate_class</span> <span class="o">=</span> <span class="n">aggregate_class</span>
<a id="__codelineno-8-146" name="__codelineno-8-146" href="#__codelineno-8-146"></a>
<a id="__codelineno-8-147" name="__codelineno-8-147" href="#__codelineno-8-147"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">aggregate_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AggregateRoot</span><span class="p">]:</span>
<a id="__codelineno-8-148" name="__codelineno-8-148" href="#__codelineno-8-148"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Charge un agrégat en utilisant les snapshots si disponibles&quot;&quot;&quot;</span>
<a id="__codelineno-8-149" name="__codelineno-8-149" href="#__codelineno-8-149"></a>
<a id="__codelineno-8-150" name="__codelineno-8-150" href="#__codelineno-8-150"></a>        <span class="n">aggregate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aggregate_class</span><span class="p">(</span><span class="n">aggregate_id</span><span class="p">)</span>
<a id="__codelineno-8-151" name="__codelineno-8-151" href="#__codelineno-8-151"></a>        <span class="n">aggregate_type</span> <span class="o">=</span> <span class="n">aggregate</span><span class="o">.</span><span class="n">_get_aggregate_type</span><span class="p">()</span>
<a id="__codelineno-8-152" name="__codelineno-8-152" href="#__codelineno-8-152"></a>
<a id="__codelineno-8-153" name="__codelineno-8-153" href="#__codelineno-8-153"></a>        <span class="c1"># Tentative de chargement depuis snapshot</span>
<a id="__codelineno-8-154" name="__codelineno-8-154" href="#__codelineno-8-154"></a>        <span class="n">snapshot</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">snapshot_store</span><span class="o">.</span><span class="n">get_latest_snapshot</span><span class="p">(</span>
<a id="__codelineno-8-155" name="__codelineno-8-155" href="#__codelineno-8-155"></a>            <span class="n">aggregate_type</span><span class="p">,</span> <span class="n">aggregate_id</span>
<a id="__codelineno-8-156" name="__codelineno-8-156" href="#__codelineno-8-156"></a>        <span class="p">)</span>
<a id="__codelineno-8-157" name="__codelineno-8-157" href="#__codelineno-8-157"></a>
<a id="__codelineno-8-158" name="__codelineno-8-158" href="#__codelineno-8-158"></a>        <span class="n">from_version</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-8-159" name="__codelineno-8-159" href="#__codelineno-8-159"></a>
<a id="__codelineno-8-160" name="__codelineno-8-160" href="#__codelineno-8-160"></a>        <span class="k">if</span> <span class="n">snapshot</span><span class="p">:</span>
<a id="__codelineno-8-161" name="__codelineno-8-161" href="#__codelineno-8-161"></a>            <span class="c1"># Restauration depuis le snapshot</span>
<a id="__codelineno-8-162" name="__codelineno-8-162" href="#__codelineno-8-162"></a>            <span class="n">aggregate</span><span class="o">.</span><span class="n">restore_from_snapshot</span><span class="p">(</span><span class="n">snapshot</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>
<a id="__codelineno-8-163" name="__codelineno-8-163" href="#__codelineno-8-163"></a>            <span class="n">aggregate</span><span class="o">.</span><span class="n">_version</span> <span class="o">=</span> <span class="n">snapshot</span><span class="o">.</span><span class="n">version</span>
<a id="__codelineno-8-164" name="__codelineno-8-164" href="#__codelineno-8-164"></a>            <span class="n">from_version</span> <span class="o">=</span> <span class="n">snapshot</span><span class="o">.</span><span class="n">version</span> <span class="o">+</span> <span class="mi">1</span>
<a id="__codelineno-8-165" name="__codelineno-8-165" href="#__codelineno-8-165"></a>
<a id="__codelineno-8-166" name="__codelineno-8-166" href="#__codelineno-8-166"></a>        <span class="c1"># Chargement des événements manquants</span>
<a id="__codelineno-8-167" name="__codelineno-8-167" href="#__codelineno-8-167"></a>        <span class="n">events</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_store</span><span class="o">.</span><span class="n">get_events</span><span class="p">(</span>
<a id="__codelineno-8-168" name="__codelineno-8-168" href="#__codelineno-8-168"></a>            <span class="n">aggregate_type</span><span class="p">,</span>
<a id="__codelineno-8-169" name="__codelineno-8-169" href="#__codelineno-8-169"></a>            <span class="n">aggregate_id</span><span class="p">,</span>
<a id="__codelineno-8-170" name="__codelineno-8-170" href="#__codelineno-8-170"></a>            <span class="n">from_version</span><span class="o">=</span><span class="n">from_version</span>
<a id="__codelineno-8-171" name="__codelineno-8-171" href="#__codelineno-8-171"></a>        <span class="p">)</span>
<a id="__codelineno-8-172" name="__codelineno-8-172" href="#__codelineno-8-172"></a>
<a id="__codelineno-8-173" name="__codelineno-8-173" href="#__codelineno-8-173"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">events</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">snapshot</span><span class="p">:</span>
<a id="__codelineno-8-174" name="__codelineno-8-174" href="#__codelineno-8-174"></a>            <span class="k">return</span> <span class="kc">None</span>
<a id="__codelineno-8-175" name="__codelineno-8-175" href="#__codelineno-8-175"></a>
<a id="__codelineno-8-176" name="__codelineno-8-176" href="#__codelineno-8-176"></a>        <span class="c1"># Application des événements récents</span>
<a id="__codelineno-8-177" name="__codelineno-8-177" href="#__codelineno-8-177"></a>        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span>
<a id="__codelineno-8-178" name="__codelineno-8-178" href="#__codelineno-8-178"></a>            <span class="n">aggregate</span><span class="o">.</span><span class="n">_apply_event</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">event_data</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">event_type</span><span class="p">)</span>
<a id="__codelineno-8-179" name="__codelineno-8-179" href="#__codelineno-8-179"></a>            <span class="n">aggregate</span><span class="o">.</span><span class="n">_version</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">sequence_number</span>
<a id="__codelineno-8-180" name="__codelineno-8-180" href="#__codelineno-8-180"></a>
<a id="__codelineno-8-181" name="__codelineno-8-181" href="#__codelineno-8-181"></a>        <span class="k">return</span> <span class="n">aggregate</span>
<a id="__codelineno-8-182" name="__codelineno-8-182" href="#__codelineno-8-182"></a>
<a id="__codelineno-8-183" name="__codelineno-8-183" href="#__codelineno-8-183"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">aggregate</span><span class="p">:</span> <span class="n">AggregateRoot</span><span class="p">):</span>
<a id="__codelineno-8-184" name="__codelineno-8-184" href="#__codelineno-8-184"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Sauvegarde l&#39;agrégat avec création optionnelle de snapshot&quot;&quot;&quot;</span>
<a id="__codelineno-8-185" name="__codelineno-8-185" href="#__codelineno-8-185"></a>
<a id="__codelineno-8-186" name="__codelineno-8-186" href="#__codelineno-8-186"></a>        <span class="n">pending</span> <span class="o">=</span> <span class="n">aggregate</span><span class="o">.</span><span class="n">pending_events</span>
<a id="__codelineno-8-187" name="__codelineno-8-187" href="#__codelineno-8-187"></a>
<a id="__codelineno-8-188" name="__codelineno-8-188" href="#__codelineno-8-188"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">pending</span><span class="p">:</span>
<a id="__codelineno-8-189" name="__codelineno-8-189" href="#__codelineno-8-189"></a>            <span class="k">return</span>
<a id="__codelineno-8-190" name="__codelineno-8-190" href="#__codelineno-8-190"></a>
<a id="__codelineno-8-191" name="__codelineno-8-191" href="#__codelineno-8-191"></a>        <span class="c1"># Sauvegarde des événements</span>
<a id="__codelineno-8-192" name="__codelineno-8-192" href="#__codelineno-8-192"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_store</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
<a id="__codelineno-8-193" name="__codelineno-8-193" href="#__codelineno-8-193"></a>            <span class="n">aggregate_type</span><span class="o">=</span><span class="n">aggregate</span><span class="o">.</span><span class="n">_get_aggregate_type</span><span class="p">(),</span>
<a id="__codelineno-8-194" name="__codelineno-8-194" href="#__codelineno-8-194"></a>            <span class="n">aggregate_id</span><span class="o">=</span><span class="n">aggregate</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
<a id="__codelineno-8-195" name="__codelineno-8-195" href="#__codelineno-8-195"></a>            <span class="n">events</span><span class="o">=</span><span class="n">pending</span><span class="p">,</span>
<a id="__codelineno-8-196" name="__codelineno-8-196" href="#__codelineno-8-196"></a>            <span class="n">expected_version</span><span class="o">=</span><span class="n">aggregate</span><span class="o">.</span><span class="n">version</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">pending</span><span class="p">)</span>
<a id="__codelineno-8-197" name="__codelineno-8-197" href="#__codelineno-8-197"></a>        <span class="p">)</span>
<a id="__codelineno-8-198" name="__codelineno-8-198" href="#__codelineno-8-198"></a>
<a id="__codelineno-8-199" name="__codelineno-8-199" href="#__codelineno-8-199"></a>        <span class="n">aggregate</span><span class="o">.</span><span class="n">clear_pending_events</span><span class="p">()</span>
<a id="__codelineno-8-200" name="__codelineno-8-200" href="#__codelineno-8-200"></a>
<a id="__codelineno-8-201" name="__codelineno-8-201" href="#__codelineno-8-201"></a>        <span class="c1"># Vérification si snapshot nécessaire</span>
<a id="__codelineno-8-202" name="__codelineno-8-202" href="#__codelineno-8-202"></a>        <span class="k">if</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">snapshot_store</span><span class="o">.</span><span class="n">should_snapshot</span><span class="p">(</span><span class="n">aggregate</span><span class="p">):</span>
<a id="__codelineno-8-203" name="__codelineno-8-203" href="#__codelineno-8-203"></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">snapshot_store</span><span class="o">.</span><span class="n">save_snapshot</span><span class="p">(</span><span class="n">aggregate</span><span class="p">)</span>
</code></pre></div>
<p>Le mécanisme de snapshot s'intègre de manière transparente avec l'Event Store. Le repository optimisé charge d'abord le dernier snapshot disponible, puis applique uniquement les événements survenus depuis. Cette approche réduit considérablement le temps de chargement pour les agrégats avec un long historique tout en préservant la capacité de reconstruction complète si nécessaire.</p>
<h3 id="projection-replay-et-reconstruction">Projection Replay et Reconstruction<a class="headerlink" href="#projection-replay-et-reconstruction" title="Permanent link">&para;</a></h3>
<p>L'un des avantages majeurs de l'Event Sourcing est la capacité de reconstruire des projections ou d'en créer de nouvelles à partir de l'historique complet des événements. Cette fonctionnalité est essentielle pour corriger des erreurs dans les projecteurs, ajouter de nouvelles vues, ou migrer vers de nouveaux schémas de données.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="c1"># eventsourcing/replay.py</span>
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span>
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a>
<a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a><span class="k">class</span><span class="w"> </span><span class="nc">ProjectionRebuilder</span><span class="p">:</span>
<a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Outil de reconstruction des projections&quot;&quot;&quot;</span>
<a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a>
<a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-9-10" name="__codelineno-9-10" href="#__codelineno-9-10"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-9-11" name="__codelineno-9-11" href="#__codelineno-9-11"></a>        <span class="n">event_store</span><span class="p">:</span> <span class="n">EventStore</span><span class="p">,</span>
<a id="__codelineno-9-12" name="__codelineno-9-12" href="#__codelineno-9-12"></a>        <span class="n">projectors</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Projector</span><span class="p">],</span>
<a id="__codelineno-9-13" name="__codelineno-9-13" href="#__codelineno-9-13"></a>        <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span>
<a id="__codelineno-9-14" name="__codelineno-9-14" href="#__codelineno-9-14"></a>    <span class="p">):</span>
<a id="__codelineno-9-15" name="__codelineno-9-15" href="#__codelineno-9-15"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">event_store</span> <span class="o">=</span> <span class="n">event_store</span>
<a id="__codelineno-9-16" name="__codelineno-9-16" href="#__codelineno-9-16"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">projectors</span> <span class="o">=</span> <span class="p">{</span><span class="n">p</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">:</span> <span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">projectors</span><span class="p">}</span>
<a id="__codelineno-9-17" name="__codelineno-9-17" href="#__codelineno-9-17"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;batch_size&#39;</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
<a id="__codelineno-9-18" name="__codelineno-9-18" href="#__codelineno-9-18"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">checkpoint_interval</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;checkpoint_interval&#39;</span><span class="p">,</span> <span class="mi">10000</span><span class="p">)</span>
<a id="__codelineno-9-19" name="__codelineno-9-19" href="#__codelineno-9-19"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">checkpoint_store</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;checkpoint_store&#39;</span><span class="p">)</span>
<a id="__codelineno-9-20" name="__codelineno-9-20" href="#__codelineno-9-20"></a>
<a id="__codelineno-9-21" name="__codelineno-9-21" href="#__codelineno-9-21"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">rebuild_projection</span><span class="p">(</span>
<a id="__codelineno-9-22" name="__codelineno-9-22" href="#__codelineno-9-22"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-9-23" name="__codelineno-9-23" href="#__codelineno-9-23"></a>        <span class="n">projector_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-9-24" name="__codelineno-9-24" href="#__codelineno-9-24"></a>        <span class="n">from_position</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-9-25" name="__codelineno-9-25" href="#__codelineno-9-25"></a>        <span class="n">to_position</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-9-26" name="__codelineno-9-26" href="#__codelineno-9-26"></a>        <span class="n">progress_callback</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-9-27" name="__codelineno-9-27" href="#__codelineno-9-27"></a>    <span class="p">):</span>
<a id="__codelineno-9-28" name="__codelineno-9-28" href="#__codelineno-9-28"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Reconstruit une projection depuis l&#39;Event Store&quot;&quot;&quot;</span>
<a id="__codelineno-9-29" name="__codelineno-9-29" href="#__codelineno-9-29"></a>
<a id="__codelineno-9-30" name="__codelineno-9-30" href="#__codelineno-9-30"></a>        <span class="n">projector</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">projectors</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">projector_name</span><span class="p">)</span>
<a id="__codelineno-9-31" name="__codelineno-9-31" href="#__codelineno-9-31"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">projector</span><span class="p">:</span>
<a id="__codelineno-9-32" name="__codelineno-9-32" href="#__codelineno-9-32"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Projecteur </span><span class="si">{</span><span class="n">projector_name</span><span class="si">}</span><span class="s2"> non trouvé&quot;</span><span class="p">)</span>
<a id="__codelineno-9-33" name="__codelineno-9-33" href="#__codelineno-9-33"></a>
<a id="__codelineno-9-34" name="__codelineno-9-34" href="#__codelineno-9-34"></a>        <span class="c1"># Nettoyage de la projection existante</span>
<a id="__codelineno-9-35" name="__codelineno-9-35" href="#__codelineno-9-35"></a>        <span class="k">await</span> <span class="n">projector</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
<a id="__codelineno-9-36" name="__codelineno-9-36" href="#__codelineno-9-36"></a>
<a id="__codelineno-9-37" name="__codelineno-9-37" href="#__codelineno-9-37"></a>        <span class="n">position</span> <span class="o">=</span> <span class="n">from_position</span>
<a id="__codelineno-9-38" name="__codelineno-9-38" href="#__codelineno-9-38"></a>        <span class="n">processed</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-9-39" name="__codelineno-9-39" href="#__codelineno-9-39"></a>        <span class="n">start_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
<a id="__codelineno-9-40" name="__codelineno-9-40" href="#__codelineno-9-40"></a>
<a id="__codelineno-9-41" name="__codelineno-9-41" href="#__codelineno-9-41"></a>        <span class="k">async</span> <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_store</span><span class="o">.</span><span class="n">get_all_events</span><span class="p">(</span>
<a id="__codelineno-9-42" name="__codelineno-9-42" href="#__codelineno-9-42"></a>            <span class="n">from_position</span><span class="o">=</span><span class="n">position</span><span class="p">,</span>
<a id="__codelineno-9-43" name="__codelineno-9-43" href="#__codelineno-9-43"></a>            <span class="n">batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span>
<a id="__codelineno-9-44" name="__codelineno-9-44" href="#__codelineno-9-44"></a>        <span class="p">):</span>
<a id="__codelineno-9-45" name="__codelineno-9-45" href="#__codelineno-9-45"></a>            <span class="c1"># Vérification de la limite</span>
<a id="__codelineno-9-46" name="__codelineno-9-46" href="#__codelineno-9-46"></a>            <span class="k">if</span> <span class="n">to_position</span> <span class="ow">and</span> <span class="n">event</span><span class="o">.</span><span class="n">sequence_number</span> <span class="o">&gt;</span> <span class="n">to_position</span><span class="p">:</span>
<a id="__codelineno-9-47" name="__codelineno-9-47" href="#__codelineno-9-47"></a>                <span class="k">break</span>
<a id="__codelineno-9-48" name="__codelineno-9-48" href="#__codelineno-9-48"></a>
<a id="__codelineno-9-49" name="__codelineno-9-49" href="#__codelineno-9-49"></a>            <span class="c1"># Projection de l&#39;événement si pertinent</span>
<a id="__codelineno-9-50" name="__codelineno-9-50" href="#__codelineno-9-50"></a>            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="ow">in</span> <span class="n">projector</span><span class="o">.</span><span class="n">handles</span><span class="p">():</span>
<a id="__codelineno-9-51" name="__codelineno-9-51" href="#__codelineno-9-51"></a>                <span class="k">await</span> <span class="n">projector</span><span class="o">.</span><span class="n">project</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
<a id="__codelineno-9-52" name="__codelineno-9-52" href="#__codelineno-9-52"></a>
<a id="__codelineno-9-53" name="__codelineno-9-53" href="#__codelineno-9-53"></a>            <span class="n">processed</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-9-54" name="__codelineno-9-54" href="#__codelineno-9-54"></a>            <span class="n">position</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">sequence_number</span>
<a id="__codelineno-9-55" name="__codelineno-9-55" href="#__codelineno-9-55"></a>
<a id="__codelineno-9-56" name="__codelineno-9-56" href="#__codelineno-9-56"></a>            <span class="c1"># Checkpoint périodique</span>
<a id="__codelineno-9-57" name="__codelineno-9-57" href="#__codelineno-9-57"></a>            <span class="k">if</span> <span class="n">processed</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkpoint_interval</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-9-58" name="__codelineno-9-58" href="#__codelineno-9-58"></a>                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_checkpoint</span><span class="p">(</span><span class="n">projector_name</span><span class="p">,</span> <span class="n">position</span><span class="p">)</span>
<a id="__codelineno-9-59" name="__codelineno-9-59" href="#__codelineno-9-59"></a>
<a id="__codelineno-9-60" name="__codelineno-9-60" href="#__codelineno-9-60"></a>                <span class="k">if</span> <span class="n">progress_callback</span><span class="p">:</span>
<a id="__codelineno-9-61" name="__codelineno-9-61" href="#__codelineno-9-61"></a>                    <span class="n">elapsed</span> <span class="o">=</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
<a id="__codelineno-9-62" name="__codelineno-9-62" href="#__codelineno-9-62"></a>                    <span class="n">rate</span> <span class="o">=</span> <span class="n">processed</span> <span class="o">/</span> <span class="n">elapsed</span> <span class="k">if</span> <span class="n">elapsed</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
<a id="__codelineno-9-63" name="__codelineno-9-63" href="#__codelineno-9-63"></a>                    <span class="k">await</span> <span class="n">progress_callback</span><span class="p">({</span>
<a id="__codelineno-9-64" name="__codelineno-9-64" href="#__codelineno-9-64"></a>                        <span class="s1">&#39;projector&#39;</span><span class="p">:</span> <span class="n">projector_name</span><span class="p">,</span>
<a id="__codelineno-9-65" name="__codelineno-9-65" href="#__codelineno-9-65"></a>                        <span class="s1">&#39;processed&#39;</span><span class="p">:</span> <span class="n">processed</span><span class="p">,</span>
<a id="__codelineno-9-66" name="__codelineno-9-66" href="#__codelineno-9-66"></a>                        <span class="s1">&#39;position&#39;</span><span class="p">:</span> <span class="n">position</span><span class="p">,</span>
<a id="__codelineno-9-67" name="__codelineno-9-67" href="#__codelineno-9-67"></a>                        <span class="s1">&#39;rate&#39;</span><span class="p">:</span> <span class="n">rate</span><span class="p">,</span>
<a id="__codelineno-9-68" name="__codelineno-9-68" href="#__codelineno-9-68"></a>                        <span class="s1">&#39;elapsed_seconds&#39;</span><span class="p">:</span> <span class="n">elapsed</span>
<a id="__codelineno-9-69" name="__codelineno-9-69" href="#__codelineno-9-69"></a>                    <span class="p">})</span>
<a id="__codelineno-9-70" name="__codelineno-9-70" href="#__codelineno-9-70"></a>
<a id="__codelineno-9-71" name="__codelineno-9-71" href="#__codelineno-9-71"></a>        <span class="c1"># Checkpoint final</span>
<a id="__codelineno-9-72" name="__codelineno-9-72" href="#__codelineno-9-72"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_checkpoint</span><span class="p">(</span><span class="n">projector_name</span><span class="p">,</span> <span class="n">position</span><span class="p">,</span> <span class="n">completed</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-9-73" name="__codelineno-9-73" href="#__codelineno-9-73"></a>
<a id="__codelineno-9-74" name="__codelineno-9-74" href="#__codelineno-9-74"></a>        <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-9-75" name="__codelineno-9-75" href="#__codelineno-9-75"></a>            <span class="s1">&#39;projector&#39;</span><span class="p">:</span> <span class="n">projector_name</span><span class="p">,</span>
<a id="__codelineno-9-76" name="__codelineno-9-76" href="#__codelineno-9-76"></a>            <span class="s1">&#39;events_processed&#39;</span><span class="p">:</span> <span class="n">processed</span><span class="p">,</span>
<a id="__codelineno-9-77" name="__codelineno-9-77" href="#__codelineno-9-77"></a>            <span class="s1">&#39;final_position&#39;</span><span class="p">:</span> <span class="n">position</span><span class="p">,</span>
<a id="__codelineno-9-78" name="__codelineno-9-78" href="#__codelineno-9-78"></a>            <span class="s1">&#39;duration_seconds&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
<a id="__codelineno-9-79" name="__codelineno-9-79" href="#__codelineno-9-79"></a>        <span class="p">}</span>
<a id="__codelineno-9-80" name="__codelineno-9-80" href="#__codelineno-9-80"></a>
<a id="__codelineno-9-81" name="__codelineno-9-81" href="#__codelineno-9-81"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">rebuild_all_projections</span><span class="p">(</span>
<a id="__codelineno-9-82" name="__codelineno-9-82" href="#__codelineno-9-82"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-9-83" name="__codelineno-9-83" href="#__codelineno-9-83"></a>        <span class="n">from_position</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-9-84" name="__codelineno-9-84" href="#__codelineno-9-84"></a>        <span class="n">progress_callback</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-9-85" name="__codelineno-9-85" href="#__codelineno-9-85"></a>    <span class="p">):</span>
<a id="__codelineno-9-86" name="__codelineno-9-86" href="#__codelineno-9-86"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Reconstruit toutes les projections en parallèle&quot;&quot;&quot;</span>
<a id="__codelineno-9-87" name="__codelineno-9-87" href="#__codelineno-9-87"></a>
<a id="__codelineno-9-88" name="__codelineno-9-88" href="#__codelineno-9-88"></a>        <span class="c1"># Groupement des événements par batch</span>
<a id="__codelineno-9-89" name="__codelineno-9-89" href="#__codelineno-9-89"></a>        <span class="n">position</span> <span class="o">=</span> <span class="n">from_position</span>
<a id="__codelineno-9-90" name="__codelineno-9-90" href="#__codelineno-9-90"></a>        <span class="n">processed</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-9-91" name="__codelineno-9-91" href="#__codelineno-9-91"></a>
<a id="__codelineno-9-92" name="__codelineno-9-92" href="#__codelineno-9-92"></a>        <span class="k">async</span> <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_store</span><span class="o">.</span><span class="n">get_all_events</span><span class="p">(</span>
<a id="__codelineno-9-93" name="__codelineno-9-93" href="#__codelineno-9-93"></a>            <span class="n">from_position</span><span class="o">=</span><span class="n">position</span><span class="p">,</span>
<a id="__codelineno-9-94" name="__codelineno-9-94" href="#__codelineno-9-94"></a>            <span class="n">batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span>
<a id="__codelineno-9-95" name="__codelineno-9-95" href="#__codelineno-9-95"></a>        <span class="p">):</span>
<a id="__codelineno-9-96" name="__codelineno-9-96" href="#__codelineno-9-96"></a>            <span class="c1"># Distribution aux projecteurs concernés</span>
<a id="__codelineno-9-97" name="__codelineno-9-97" href="#__codelineno-9-97"></a>            <span class="n">tasks</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-9-98" name="__codelineno-9-98" href="#__codelineno-9-98"></a>            <span class="k">for</span> <span class="n">projector</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">projectors</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
<a id="__codelineno-9-99" name="__codelineno-9-99" href="#__codelineno-9-99"></a>                <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="ow">in</span> <span class="n">projector</span><span class="o">.</span><span class="n">handles</span><span class="p">():</span>
<a id="__codelineno-9-100" name="__codelineno-9-100" href="#__codelineno-9-100"></a>                    <span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">projector</span><span class="o">.</span><span class="n">project</span><span class="p">(</span><span class="n">event</span><span class="p">))</span>
<a id="__codelineno-9-101" name="__codelineno-9-101" href="#__codelineno-9-101"></a>
<a id="__codelineno-9-102" name="__codelineno-9-102" href="#__codelineno-9-102"></a>            <span class="k">if</span> <span class="n">tasks</span><span class="p">:</span>
<a id="__codelineno-9-103" name="__codelineno-9-103" href="#__codelineno-9-103"></a>                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="n">tasks</span><span class="p">)</span>
<a id="__codelineno-9-104" name="__codelineno-9-104" href="#__codelineno-9-104"></a>
<a id="__codelineno-9-105" name="__codelineno-9-105" href="#__codelineno-9-105"></a>            <span class="n">processed</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-9-106" name="__codelineno-9-106" href="#__codelineno-9-106"></a>            <span class="n">position</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">sequence_number</span>
<a id="__codelineno-9-107" name="__codelineno-9-107" href="#__codelineno-9-107"></a>
<a id="__codelineno-9-108" name="__codelineno-9-108" href="#__codelineno-9-108"></a>            <span class="k">if</span> <span class="n">processed</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkpoint_interval</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-9-109" name="__codelineno-9-109" href="#__codelineno-9-109"></a>                <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">projectors</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
<a id="__codelineno-9-110" name="__codelineno-9-110" href="#__codelineno-9-110"></a>                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_checkpoint</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">position</span><span class="p">)</span>
<a id="__codelineno-9-111" name="__codelineno-9-111" href="#__codelineno-9-111"></a>
<a id="__codelineno-9-112" name="__codelineno-9-112" href="#__codelineno-9-112"></a>                <span class="k">if</span> <span class="n">progress_callback</span><span class="p">:</span>
<a id="__codelineno-9-113" name="__codelineno-9-113" href="#__codelineno-9-113"></a>                    <span class="k">await</span> <span class="n">progress_callback</span><span class="p">({</span>
<a id="__codelineno-9-114" name="__codelineno-9-114" href="#__codelineno-9-114"></a>                        <span class="s1">&#39;processed&#39;</span><span class="p">:</span> <span class="n">processed</span><span class="p">,</span>
<a id="__codelineno-9-115" name="__codelineno-9-115" href="#__codelineno-9-115"></a>                        <span class="s1">&#39;position&#39;</span><span class="p">:</span> <span class="n">position</span>
<a id="__codelineno-9-116" name="__codelineno-9-116" href="#__codelineno-9-116"></a>                    <span class="p">})</span>
<a id="__codelineno-9-117" name="__codelineno-9-117" href="#__codelineno-9-117"></a>
<a id="__codelineno-9-118" name="__codelineno-9-118" href="#__codelineno-9-118"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_save_checkpoint</span><span class="p">(</span>
<a id="__codelineno-9-119" name="__codelineno-9-119" href="#__codelineno-9-119"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-9-120" name="__codelineno-9-120" href="#__codelineno-9-120"></a>        <span class="n">projector_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-9-121" name="__codelineno-9-121" href="#__codelineno-9-121"></a>        <span class="n">position</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<a id="__codelineno-9-122" name="__codelineno-9-122" href="#__codelineno-9-122"></a>        <span class="n">completed</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-9-123" name="__codelineno-9-123" href="#__codelineno-9-123"></a>    <span class="p">):</span>
<a id="__codelineno-9-124" name="__codelineno-9-124" href="#__codelineno-9-124"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Sauvegarde un point de reprise&quot;&quot;&quot;</span>
<a id="__codelineno-9-125" name="__codelineno-9-125" href="#__codelineno-9-125"></a>
<a id="__codelineno-9-126" name="__codelineno-9-126" href="#__codelineno-9-126"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkpoint_store</span><span class="p">:</span>
<a id="__codelineno-9-127" name="__codelineno-9-127" href="#__codelineno-9-127"></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkpoint_store</span><span class="o">.</span><span class="n">save</span><span class="p">({</span>
<a id="__codelineno-9-128" name="__codelineno-9-128" href="#__codelineno-9-128"></a>                <span class="s1">&#39;projector&#39;</span><span class="p">:</span> <span class="n">projector_name</span><span class="p">,</span>
<a id="__codelineno-9-129" name="__codelineno-9-129" href="#__codelineno-9-129"></a>                <span class="s1">&#39;position&#39;</span><span class="p">:</span> <span class="n">position</span><span class="p">,</span>
<a id="__codelineno-9-130" name="__codelineno-9-130" href="#__codelineno-9-130"></a>                <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
<a id="__codelineno-9-131" name="__codelineno-9-131" href="#__codelineno-9-131"></a>                <span class="s1">&#39;completed&#39;</span><span class="p">:</span> <span class="n">completed</span>
<a id="__codelineno-9-132" name="__codelineno-9-132" href="#__codelineno-9-132"></a>            <span class="p">})</span>
<a id="__codelineno-9-133" name="__codelineno-9-133" href="#__codelineno-9-133"></a>
<a id="__codelineno-9-134" name="__codelineno-9-134" href="#__codelineno-9-134"></a>
<a id="__codelineno-9-135" name="__codelineno-9-135" href="#__codelineno-9-135"></a><span class="k">class</span><span class="w"> </span><span class="nc">IncrementalProjectionUpdater</span><span class="p">:</span>
<a id="__codelineno-9-136" name="__codelineno-9-136" href="#__codelineno-9-136"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Mise à jour incrémentale des projections depuis Kafka&quot;&quot;&quot;</span>
<a id="__codelineno-9-137" name="__codelineno-9-137" href="#__codelineno-9-137"></a>
<a id="__codelineno-9-138" name="__codelineno-9-138" href="#__codelineno-9-138"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-9-139" name="__codelineno-9-139" href="#__codelineno-9-139"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-9-140" name="__codelineno-9-140" href="#__codelineno-9-140"></a>        <span class="n">consumer</span><span class="p">,</span>
<a id="__codelineno-9-141" name="__codelineno-9-141" href="#__codelineno-9-141"></a>        <span class="n">projectors</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Projector</span><span class="p">],</span>
<a id="__codelineno-9-142" name="__codelineno-9-142" href="#__codelineno-9-142"></a>        <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span>
<a id="__codelineno-9-143" name="__codelineno-9-143" href="#__codelineno-9-143"></a>    <span class="p">):</span>
<a id="__codelineno-9-144" name="__codelineno-9-144" href="#__codelineno-9-144"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">consumer</span> <span class="o">=</span> <span class="n">consumer</span>
<a id="__codelineno-9-145" name="__codelineno-9-145" href="#__codelineno-9-145"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">projectors</span> <span class="o">=</span> <span class="n">projectors</span>
<a id="__codelineno-9-146" name="__codelineno-9-146" href="#__codelineno-9-146"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">projector_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_projector_map</span><span class="p">()</span>
<a id="__codelineno-9-147" name="__codelineno-9-147" href="#__codelineno-9-147"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">commit_interval</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;commit_interval&#39;</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<a id="__codelineno-9-148" name="__codelineno-9-148" href="#__codelineno-9-148"></a>
<a id="__codelineno-9-149" name="__codelineno-9-149" href="#__codelineno-9-149"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_build_projector_map</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Projector</span><span class="p">]]:</span>
<a id="__codelineno-9-150" name="__codelineno-9-150" href="#__codelineno-9-150"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Construit un mapping event_type -&gt; projectors&quot;&quot;&quot;</span>
<a id="__codelineno-9-151" name="__codelineno-9-151" href="#__codelineno-9-151"></a>        <span class="n">mapping</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-9-152" name="__codelineno-9-152" href="#__codelineno-9-152"></a>        <span class="k">for</span> <span class="n">projector</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">projectors</span><span class="p">:</span>
<a id="__codelineno-9-153" name="__codelineno-9-153" href="#__codelineno-9-153"></a>            <span class="k">for</span> <span class="n">event_type</span> <span class="ow">in</span> <span class="n">projector</span><span class="o">.</span><span class="n">handles</span><span class="p">():</span>
<a id="__codelineno-9-154" name="__codelineno-9-154" href="#__codelineno-9-154"></a>                <span class="k">if</span> <span class="n">event_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mapping</span><span class="p">:</span>
<a id="__codelineno-9-155" name="__codelineno-9-155" href="#__codelineno-9-155"></a>                    <span class="n">mapping</span><span class="p">[</span><span class="n">event_type</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-9-156" name="__codelineno-9-156" href="#__codelineno-9-156"></a>                <span class="n">mapping</span><span class="p">[</span><span class="n">event_type</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">projector</span><span class="p">)</span>
<a id="__codelineno-9-157" name="__codelineno-9-157" href="#__codelineno-9-157"></a>        <span class="k">return</span> <span class="n">mapping</span>
<a id="__codelineno-9-158" name="__codelineno-9-158" href="#__codelineno-9-158"></a>
<a id="__codelineno-9-159" name="__codelineno-9-159" href="#__codelineno-9-159"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-9-160" name="__codelineno-9-160" href="#__codelineno-9-160"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Boucle principale de mise à jour&quot;&quot;&quot;</span>
<a id="__codelineno-9-161" name="__codelineno-9-161" href="#__codelineno-9-161"></a>
<a id="__codelineno-9-162" name="__codelineno-9-162" href="#__codelineno-9-162"></a>        <span class="n">processed</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-9-163" name="__codelineno-9-163" href="#__codelineno-9-163"></a>
<a id="__codelineno-9-164" name="__codelineno-9-164" href="#__codelineno-9-164"></a>        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
<a id="__codelineno-9-165" name="__codelineno-9-165" href="#__codelineno-9-165"></a>            <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">consumer</span><span class="o">.</span><span class="n">poll</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
<a id="__codelineno-9-166" name="__codelineno-9-166" href="#__codelineno-9-166"></a>
<a id="__codelineno-9-167" name="__codelineno-9-167" href="#__codelineno-9-167"></a>            <span class="k">if</span> <span class="n">msg</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-9-168" name="__codelineno-9-168" href="#__codelineno-9-168"></a>                <span class="k">continue</span>
<a id="__codelineno-9-169" name="__codelineno-9-169" href="#__codelineno-9-169"></a>
<a id="__codelineno-9-170" name="__codelineno-9-170" href="#__codelineno-9-170"></a>            <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">error</span><span class="p">():</span>
<a id="__codelineno-9-171" name="__codelineno-9-171" href="#__codelineno-9-171"></a>                <span class="k">continue</span>
<a id="__codelineno-9-172" name="__codelineno-9-172" href="#__codelineno-9-172"></a>
<a id="__codelineno-9-173" name="__codelineno-9-173" href="#__codelineno-9-173"></a>            <span class="n">event</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_event</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<a id="__codelineno-9-174" name="__codelineno-9-174" href="#__codelineno-9-174"></a>            <span class="n">event_type</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;event_type&#39;</span><span class="p">)</span>
<a id="__codelineno-9-175" name="__codelineno-9-175" href="#__codelineno-9-175"></a>
<a id="__codelineno-9-176" name="__codelineno-9-176" href="#__codelineno-9-176"></a>            <span class="c1"># Distribution aux projecteurs concernés</span>
<a id="__codelineno-9-177" name="__codelineno-9-177" href="#__codelineno-9-177"></a>            <span class="n">projectors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">projector_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">event_type</span><span class="p">,</span> <span class="p">[])</span>
<a id="__codelineno-9-178" name="__codelineno-9-178" href="#__codelineno-9-178"></a>            <span class="k">for</span> <span class="n">projector</span> <span class="ow">in</span> <span class="n">projectors</span><span class="p">:</span>
<a id="__codelineno-9-179" name="__codelineno-9-179" href="#__codelineno-9-179"></a>                <span class="k">await</span> <span class="n">projector</span><span class="o">.</span><span class="n">project</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
<a id="__codelineno-9-180" name="__codelineno-9-180" href="#__codelineno-9-180"></a>
<a id="__codelineno-9-181" name="__codelineno-9-181" href="#__codelineno-9-181"></a>            <span class="n">processed</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-9-182" name="__codelineno-9-182" href="#__codelineno-9-182"></a>
<a id="__codelineno-9-183" name="__codelineno-9-183" href="#__codelineno-9-183"></a>            <span class="c1"># Commit périodique</span>
<a id="__codelineno-9-184" name="__codelineno-9-184" href="#__codelineno-9-184"></a>            <span class="k">if</span> <span class="n">processed</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">commit_interval</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-9-185" name="__codelineno-9-185" href="#__codelineno-9-185"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">consumer</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<a id="__codelineno-9-186" name="__codelineno-9-186" href="#__codelineno-9-186"></a>
<a id="__codelineno-9-187" name="__codelineno-9-187" href="#__codelineno-9-187"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_parse_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<a id="__codelineno-9-188" name="__codelineno-9-188" href="#__codelineno-9-188"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse un message Kafka en événement&quot;&quot;&quot;</span>
<a id="__codelineno-9-189" name="__codelineno-9-189" href="#__codelineno-9-189"></a>        <span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<a id="__codelineno-9-190" name="__codelineno-9-190" href="#__codelineno-9-190"></a>        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">value</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
</code></pre></div>
<p>La reconstruction des projections est une opération coûteuse qui doit être planifiée avec soin. En production, il est recommandé d'exécuter les reconstructions pendant les périodes de faible charge et de surveiller attentivement les ressources consommées. Le mécanisme de checkpoint permet de reprendre une reconstruction interrompue sans repartir du début.</p>
<hr />
<h2 id="ii94-patron-outbox-transactionnel">II.9.4 Patron « Outbox Transactionnel »<a class="headerlink" href="#ii94-patron-outbox-transactionnel" title="Permanent link">&para;</a></h2>
<h3 id="le-probleme-de-la-double-ecriture">Le Problème de la Double Écriture<a class="headerlink" href="#le-probleme-de-la-double-ecriture" title="Permanent link">&para;</a></h3>
<p>Dans une architecture événementielle, chaque modification d'état doit être accompagnée de la publication d'un événement correspondant. Cependant, cette double opération — écriture en base de données et publication sur le broker de messages — pose un problème fondamental de cohérence. Si l'une des deux opérations échoue après que l'autre a réussi, le système se retrouve dans un état incohérent.</p>
<p>Considérons un scénario typique : un agent traite une demande client et doit mettre à jour la base de données puis publier un événement. Si la mise à jour réussit mais que la publication échoue (timeout réseau, broker indisponible), l'événement est perdu et les consommateurs ne seront jamais informés du changement. Inversement, si la publication réussit mais que la transaction de base de données échoue ensuite, un événement a été émis pour une modification qui n'a pas eu lieu.</p>
<p>Le patron Outbox Transactionnel résout ce problème en utilisant la base de données comme intermédiaire fiable. Les événements sont d'abord écrits dans une table outbox au sein de la même transaction que les modifications métier. Un processus séparé lit ensuite cette table et publie les événements sur le broker, garantissant ainsi la cohérence entre l'état de la base de données et les événements publiés.</p>
<h3 id="architecture-du-patron-outbox">Architecture du Patron Outbox<a class="headerlink" href="#architecture-du-patron-outbox" title="Permanent link">&para;</a></h3>
<p>L'architecture du patron Outbox comprend trois composants principaux : la table outbox qui stocke les événements en attente, le service métier qui écrit dans cette table transactionnellement, et le relay qui lit la table et publie les événements.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="c1">-- Schema de la table Outbox</span>
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">outbox</span><span class="w"> </span><span class="p">(</span>
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="w">    </span><span class="n">id</span><span class="w"> </span><span class="n">BIGSERIAL</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a><span class="w">    </span><span class="n">aggregate_type</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a><span class="w">    </span><span class="n">aggregate_id</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a><span class="w">    </span><span class="n">event_type</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a><span class="w">    </span><span class="n">payload</span><span class="w"> </span><span class="n">JSONB</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a><span class="w">    </span><span class="n">metadata</span><span class="w"> </span><span class="n">JSONB</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="s1">&#39;{}&#39;</span><span class="p">,</span>
<a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a><span class="w">    </span><span class="n">created_at</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="w"> </span><span class="k">WITH</span><span class="w"> </span><span class="k">TIME</span><span class="w"> </span><span class="k">ZONE</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">(),</span>
<a id="__codelineno-10-10" name="__codelineno-10-10" href="#__codelineno-10-10"></a><span class="w">    </span><span class="n">published_at</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="w"> </span><span class="k">WITH</span><span class="w"> </span><span class="k">TIME</span><span class="w"> </span><span class="k">ZONE</span><span class="p">,</span>
<a id="__codelineno-10-11" name="__codelineno-10-11" href="#__codelineno-10-11"></a><span class="w">    </span><span class="n">retry_count</span><span class="w"> </span><span class="nb">INTEGER</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-10-12" name="__codelineno-10-12" href="#__codelineno-10-12"></a><span class="w">    </span><span class="n">last_error</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span>
<a id="__codelineno-10-13" name="__codelineno-10-13" href="#__codelineno-10-13"></a>
<a id="__codelineno-10-14" name="__codelineno-10-14" href="#__codelineno-10-14"></a><span class="w">    </span><span class="c1">-- Index pour le polling efficace</span>
<a id="__codelineno-10-15" name="__codelineno-10-15" href="#__codelineno-10-15"></a><span class="w">    </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_outbox_unpublished</span><span class="w"> </span><span class="p">(</span><span class="n">published_at</span><span class="p">)</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">published_at</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<a id="__codelineno-10-16" name="__codelineno-10-16" href="#__codelineno-10-16"></a><span class="w">    </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_outbox_aggregate</span><span class="w"> </span><span class="p">(</span><span class="n">aggregate_type</span><span class="p">,</span><span class="w"> </span><span class="n">aggregate_id</span><span class="p">)</span>
<a id="__codelineno-10-17" name="__codelineno-10-17" href="#__codelineno-10-17"></a><span class="p">);</span>
<a id="__codelineno-10-18" name="__codelineno-10-18" href="#__codelineno-10-18"></a>
<a id="__codelineno-10-19" name="__codelineno-10-19" href="#__codelineno-10-19"></a><span class="c1">-- Table de tracking pour la publication</span>
<a id="__codelineno-10-20" name="__codelineno-10-20" href="#__codelineno-10-20"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">outbox_position</span><span class="w"> </span><span class="p">(</span>
<a id="__codelineno-10-21" name="__codelineno-10-21" href="#__codelineno-10-21"></a><span class="w">    </span><span class="n">consumer_id</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
<a id="__codelineno-10-22" name="__codelineno-10-22" href="#__codelineno-10-22"></a><span class="w">    </span><span class="n">last_processed_id</span><span class="w"> </span><span class="nb">BIGINT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<a id="__codelineno-10-23" name="__codelineno-10-23" href="#__codelineno-10-23"></a><span class="w">    </span><span class="n">updated_at</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="w"> </span><span class="k">WITH</span><span class="w"> </span><span class="k">TIME</span><span class="w"> </span><span class="k">ZONE</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">()</span>
<a id="__codelineno-10-24" name="__codelineno-10-24" href="#__codelineno-10-24"></a><span class="p">);</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="c1"># outbox/service.py</span>
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">contextlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">asynccontextmanager</span>
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>
<a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a>
<a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a><span class="k">class</span><span class="w"> </span><span class="nc">OutboxService</span><span class="p">:</span>
<a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Service de gestion de l&#39;outbox transactionnel&quot;&quot;&quot;</span>
<a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a>
<a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db_pool</span><span class="p">):</span>
<a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">db_pool</span>
<a id="__codelineno-11-11" name="__codelineno-11-11" href="#__codelineno-11-11"></a>
<a id="__codelineno-11-12" name="__codelineno-11-12" href="#__codelineno-11-12"></a>    <span class="nd">@asynccontextmanager</span>
<a id="__codelineno-11-13" name="__codelineno-11-13" href="#__codelineno-11-13"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">transaction</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-11-14" name="__codelineno-11-14" href="#__codelineno-11-14"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Gestionnaire de contexte pour transaction avec outbox&quot;&quot;&quot;</span>
<a id="__codelineno-11-15" name="__codelineno-11-15" href="#__codelineno-11-15"></a>        <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
<a id="__codelineno-11-16" name="__codelineno-11-16" href="#__codelineno-11-16"></a>            <span class="k">async</span> <span class="k">with</span> <span class="n">conn</span><span class="o">.</span><span class="n">transaction</span><span class="p">():</span>
<a id="__codelineno-11-17" name="__codelineno-11-17" href="#__codelineno-11-17"></a>                <span class="k">yield</span> <span class="n">OutboxTransaction</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
<a id="__codelineno-11-18" name="__codelineno-11-18" href="#__codelineno-11-18"></a>
<a id="__codelineno-11-19" name="__codelineno-11-19" href="#__codelineno-11-19"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_unpublished</span><span class="p">(</span>
<a id="__codelineno-11-20" name="__codelineno-11-20" href="#__codelineno-11-20"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-11-21" name="__codelineno-11-21" href="#__codelineno-11-21"></a>        <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
<a id="__codelineno-11-22" name="__codelineno-11-22" href="#__codelineno-11-22"></a>        <span class="n">consumer_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;default&quot;</span>
<a id="__codelineno-11-23" name="__codelineno-11-23" href="#__codelineno-11-23"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
<a id="__codelineno-11-24" name="__codelineno-11-24" href="#__codelineno-11-24"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Récupère les événements non publiés&quot;&quot;&quot;</span>
<a id="__codelineno-11-25" name="__codelineno-11-25" href="#__codelineno-11-25"></a>
<a id="__codelineno-11-26" name="__codelineno-11-26" href="#__codelineno-11-26"></a>        <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
<a id="__codelineno-11-27" name="__codelineno-11-27" href="#__codelineno-11-27"></a>            <span class="c1"># Récupération de la dernière position</span>
<a id="__codelineno-11-28" name="__codelineno-11-28" href="#__codelineno-11-28"></a>            <span class="n">last_id</span> <span class="o">=</span> <span class="k">await</span> <span class="n">conn</span><span class="o">.</span><span class="n">fetchval</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-11-29" name="__codelineno-11-29" href="#__codelineno-11-29"></a><span class="s2">                SELECT COALESCE(last_processed_id, 0)</span>
<a id="__codelineno-11-30" name="__codelineno-11-30" href="#__codelineno-11-30"></a><span class="s2">                FROM outbox_position</span>
<a id="__codelineno-11-31" name="__codelineno-11-31" href="#__codelineno-11-31"></a><span class="s2">                WHERE consumer_id = $1</span>
<a id="__codelineno-11-32" name="__codelineno-11-32" href="#__codelineno-11-32"></a><span class="s2">            &quot;&quot;&quot;</span><span class="p">,</span> <span class="n">consumer_id</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span>
<a id="__codelineno-11-33" name="__codelineno-11-33" href="#__codelineno-11-33"></a>
<a id="__codelineno-11-34" name="__codelineno-11-34" href="#__codelineno-11-34"></a>            <span class="c1"># Récupération des événements</span>
<a id="__codelineno-11-35" name="__codelineno-11-35" href="#__codelineno-11-35"></a>            <span class="n">rows</span> <span class="o">=</span> <span class="k">await</span> <span class="n">conn</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-11-36" name="__codelineno-11-36" href="#__codelineno-11-36"></a><span class="s2">                SELECT id, aggregate_type, aggregate_id, event_type,</span>
<a id="__codelineno-11-37" name="__codelineno-11-37" href="#__codelineno-11-37"></a><span class="s2">                       payload, metadata, created_at</span>
<a id="__codelineno-11-38" name="__codelineno-11-38" href="#__codelineno-11-38"></a><span class="s2">                FROM outbox</span>
<a id="__codelineno-11-39" name="__codelineno-11-39" href="#__codelineno-11-39"></a><span class="s2">                WHERE id &gt; $1 AND published_at IS NULL</span>
<a id="__codelineno-11-40" name="__codelineno-11-40" href="#__codelineno-11-40"></a><span class="s2">                ORDER BY id ASC</span>
<a id="__codelineno-11-41" name="__codelineno-11-41" href="#__codelineno-11-41"></a><span class="s2">                LIMIT $2</span>
<a id="__codelineno-11-42" name="__codelineno-11-42" href="#__codelineno-11-42"></a><span class="s2">            &quot;&quot;&quot;</span><span class="p">,</span> <span class="n">last_id</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">)</span>
<a id="__codelineno-11-43" name="__codelineno-11-43" href="#__codelineno-11-43"></a>
<a id="__codelineno-11-44" name="__codelineno-11-44" href="#__codelineno-11-44"></a>            <span class="k">return</span> <span class="p">[</span><span class="nb">dict</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">]</span>
<a id="__codelineno-11-45" name="__codelineno-11-45" href="#__codelineno-11-45"></a>
<a id="__codelineno-11-46" name="__codelineno-11-46" href="#__codelineno-11-46"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">mark_published</span><span class="p">(</span>
<a id="__codelineno-11-47" name="__codelineno-11-47" href="#__codelineno-11-47"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-11-48" name="__codelineno-11-48" href="#__codelineno-11-48"></a>        <span class="n">event_ids</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
<a id="__codelineno-11-49" name="__codelineno-11-49" href="#__codelineno-11-49"></a>        <span class="n">consumer_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;default&quot;</span>
<a id="__codelineno-11-50" name="__codelineno-11-50" href="#__codelineno-11-50"></a>    <span class="p">):</span>
<a id="__codelineno-11-51" name="__codelineno-11-51" href="#__codelineno-11-51"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Marque des événements comme publiés&quot;&quot;&quot;</span>
<a id="__codelineno-11-52" name="__codelineno-11-52" href="#__codelineno-11-52"></a>
<a id="__codelineno-11-53" name="__codelineno-11-53" href="#__codelineno-11-53"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">event_ids</span><span class="p">:</span>
<a id="__codelineno-11-54" name="__codelineno-11-54" href="#__codelineno-11-54"></a>            <span class="k">return</span>
<a id="__codelineno-11-55" name="__codelineno-11-55" href="#__codelineno-11-55"></a>
<a id="__codelineno-11-56" name="__codelineno-11-56" href="#__codelineno-11-56"></a>        <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
<a id="__codelineno-11-57" name="__codelineno-11-57" href="#__codelineno-11-57"></a>            <span class="k">async</span> <span class="k">with</span> <span class="n">conn</span><span class="o">.</span><span class="n">transaction</span><span class="p">():</span>
<a id="__codelineno-11-58" name="__codelineno-11-58" href="#__codelineno-11-58"></a>                <span class="c1"># Mise à jour des événements</span>
<a id="__codelineno-11-59" name="__codelineno-11-59" href="#__codelineno-11-59"></a>                <span class="k">await</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-11-60" name="__codelineno-11-60" href="#__codelineno-11-60"></a><span class="s2">                    UPDATE outbox</span>
<a id="__codelineno-11-61" name="__codelineno-11-61" href="#__codelineno-11-61"></a><span class="s2">                    SET published_at = NOW()</span>
<a id="__codelineno-11-62" name="__codelineno-11-62" href="#__codelineno-11-62"></a><span class="s2">                    WHERE id = ANY($1)</span>
<a id="__codelineno-11-63" name="__codelineno-11-63" href="#__codelineno-11-63"></a><span class="s2">                &quot;&quot;&quot;</span><span class="p">,</span> <span class="n">event_ids</span><span class="p">)</span>
<a id="__codelineno-11-64" name="__codelineno-11-64" href="#__codelineno-11-64"></a>
<a id="__codelineno-11-65" name="__codelineno-11-65" href="#__codelineno-11-65"></a>                <span class="c1"># Mise à jour de la position</span>
<a id="__codelineno-11-66" name="__codelineno-11-66" href="#__codelineno-11-66"></a>                <span class="n">max_id</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">event_ids</span><span class="p">)</span>
<a id="__codelineno-11-67" name="__codelineno-11-67" href="#__codelineno-11-67"></a>                <span class="k">await</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-11-68" name="__codelineno-11-68" href="#__codelineno-11-68"></a><span class="s2">                    INSERT INTO outbox_position (consumer_id, last_processed_id)</span>
<a id="__codelineno-11-69" name="__codelineno-11-69" href="#__codelineno-11-69"></a><span class="s2">                    VALUES ($1, $2)</span>
<a id="__codelineno-11-70" name="__codelineno-11-70" href="#__codelineno-11-70"></a><span class="s2">                    ON CONFLICT (consumer_id)</span>
<a id="__codelineno-11-71" name="__codelineno-11-71" href="#__codelineno-11-71"></a><span class="s2">                    DO UPDATE SET </span>
<a id="__codelineno-11-72" name="__codelineno-11-72" href="#__codelineno-11-72"></a><span class="s2">                        last_processed_id = EXCLUDED.last_processed_id,</span>
<a id="__codelineno-11-73" name="__codelineno-11-73" href="#__codelineno-11-73"></a><span class="s2">                        updated_at = NOW()</span>
<a id="__codelineno-11-74" name="__codelineno-11-74" href="#__codelineno-11-74"></a><span class="s2">                &quot;&quot;&quot;</span><span class="p">,</span> <span class="n">consumer_id</span><span class="p">,</span> <span class="n">max_id</span><span class="p">)</span>
<a id="__codelineno-11-75" name="__codelineno-11-75" href="#__codelineno-11-75"></a>
<a id="__codelineno-11-76" name="__codelineno-11-76" href="#__codelineno-11-76"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">mark_failed</span><span class="p">(</span>
<a id="__codelineno-11-77" name="__codelineno-11-77" href="#__codelineno-11-77"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-11-78" name="__codelineno-11-78" href="#__codelineno-11-78"></a>        <span class="n">event_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<a id="__codelineno-11-79" name="__codelineno-11-79" href="#__codelineno-11-79"></a>        <span class="n">error</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-11-80" name="__codelineno-11-80" href="#__codelineno-11-80"></a>    <span class="p">):</span>
<a id="__codelineno-11-81" name="__codelineno-11-81" href="#__codelineno-11-81"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Marque un événement comme échoué&quot;&quot;&quot;</span>
<a id="__codelineno-11-82" name="__codelineno-11-82" href="#__codelineno-11-82"></a>
<a id="__codelineno-11-83" name="__codelineno-11-83" href="#__codelineno-11-83"></a>        <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
<a id="__codelineno-11-84" name="__codelineno-11-84" href="#__codelineno-11-84"></a>            <span class="k">await</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-11-85" name="__codelineno-11-85" href="#__codelineno-11-85"></a><span class="s2">                UPDATE outbox</span>
<a id="__codelineno-11-86" name="__codelineno-11-86" href="#__codelineno-11-86"></a><span class="s2">                SET retry_count = retry_count + 1,</span>
<a id="__codelineno-11-87" name="__codelineno-11-87" href="#__codelineno-11-87"></a><span class="s2">                    last_error = $2</span>
<a id="__codelineno-11-88" name="__codelineno-11-88" href="#__codelineno-11-88"></a><span class="s2">                WHERE id = $1</span>
<a id="__codelineno-11-89" name="__codelineno-11-89" href="#__codelineno-11-89"></a><span class="s2">            &quot;&quot;&quot;</span><span class="p">,</span> <span class="n">event_id</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span>
<a id="__codelineno-11-90" name="__codelineno-11-90" href="#__codelineno-11-90"></a>
<a id="__codelineno-11-91" name="__codelineno-11-91" href="#__codelineno-11-91"></a>
<a id="__codelineno-11-92" name="__codelineno-11-92" href="#__codelineno-11-92"></a><span class="k">class</span><span class="w"> </span><span class="nc">OutboxTransaction</span><span class="p">:</span>
<a id="__codelineno-11-93" name="__codelineno-11-93" href="#__codelineno-11-93"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Transaction avec support outbox&quot;&quot;&quot;</span>
<a id="__codelineno-11-94" name="__codelineno-11-94" href="#__codelineno-11-94"></a>
<a id="__codelineno-11-95" name="__codelineno-11-95" href="#__codelineno-11-95"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conn</span><span class="p">):</span>
<a id="__codelineno-11-96" name="__codelineno-11-96" href="#__codelineno-11-96"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">conn</span> <span class="o">=</span> <span class="n">conn</span>
<a id="__codelineno-11-97" name="__codelineno-11-97" href="#__codelineno-11-97"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_pending_events</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-11-98" name="__codelineno-11-98" href="#__codelineno-11-98"></a>
<a id="__codelineno-11-99" name="__codelineno-11-99" href="#__codelineno-11-99"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
<a id="__codelineno-11-100" name="__codelineno-11-100" href="#__codelineno-11-100"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Exécute une requête dans la transaction&quot;&quot;&quot;</span>
<a id="__codelineno-11-101" name="__codelineno-11-101" href="#__codelineno-11-101"></a>        <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
<a id="__codelineno-11-102" name="__codelineno-11-102" href="#__codelineno-11-102"></a>
<a id="__codelineno-11-103" name="__codelineno-11-103" href="#__codelineno-11-103"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">fetch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
<a id="__codelineno-11-104" name="__codelineno-11-104" href="#__codelineno-11-104"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Exécute une requête de lecture&quot;&quot;&quot;</span>
<a id="__codelineno-11-105" name="__codelineno-11-105" href="#__codelineno-11-105"></a>        <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
<a id="__codelineno-11-106" name="__codelineno-11-106" href="#__codelineno-11-106"></a>
<a id="__codelineno-11-107" name="__codelineno-11-107" href="#__codelineno-11-107"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">add_event</span><span class="p">(</span>
<a id="__codelineno-11-108" name="__codelineno-11-108" href="#__codelineno-11-108"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-11-109" name="__codelineno-11-109" href="#__codelineno-11-109"></a>        <span class="n">aggregate_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-11-110" name="__codelineno-11-110" href="#__codelineno-11-110"></a>        <span class="n">aggregate_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-11-111" name="__codelineno-11-111" href="#__codelineno-11-111"></a>        <span class="n">event_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-11-112" name="__codelineno-11-112" href="#__codelineno-11-112"></a>        <span class="n">payload</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
<a id="__codelineno-11-113" name="__codelineno-11-113" href="#__codelineno-11-113"></a>        <span class="n">metadata</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-11-114" name="__codelineno-11-114" href="#__codelineno-11-114"></a>    <span class="p">):</span>
<a id="__codelineno-11-115" name="__codelineno-11-115" href="#__codelineno-11-115"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Ajoute un événement à l&#39;outbox dans la transaction&quot;&quot;&quot;</span>
<a id="__codelineno-11-116" name="__codelineno-11-116" href="#__codelineno-11-116"></a>
<a id="__codelineno-11-117" name="__codelineno-11-117" href="#__codelineno-11-117"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-11-118" name="__codelineno-11-118" href="#__codelineno-11-118"></a><span class="s2">            INSERT INTO outbox (aggregate_type, aggregate_id, event_type, payload, metadata)</span>
<a id="__codelineno-11-119" name="__codelineno-11-119" href="#__codelineno-11-119"></a><span class="s2">            VALUES ($1, $2, $3, $4, $5)</span>
<a id="__codelineno-11-120" name="__codelineno-11-120" href="#__codelineno-11-120"></a><span class="s2">        &quot;&quot;&quot;</span><span class="p">,</span>
<a id="__codelineno-11-121" name="__codelineno-11-121" href="#__codelineno-11-121"></a>            <span class="n">aggregate_type</span><span class="p">,</span>
<a id="__codelineno-11-122" name="__codelineno-11-122" href="#__codelineno-11-122"></a>            <span class="n">aggregate_id</span><span class="p">,</span>
<a id="__codelineno-11-123" name="__codelineno-11-123" href="#__codelineno-11-123"></a>            <span class="n">event_type</span><span class="p">,</span>
<a id="__codelineno-11-124" name="__codelineno-11-124" href="#__codelineno-11-124"></a>            <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">),</span>
<a id="__codelineno-11-125" name="__codelineno-11-125" href="#__codelineno-11-125"></a>            <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">metadata</span> <span class="ow">or</span> <span class="p">{})</span>
<a id="__codelineno-11-126" name="__codelineno-11-126" href="#__codelineno-11-126"></a>        <span class="p">)</span>
</code></pre></div>
<h3 id="outbox-relay-avec-kafka-connect">Outbox Relay avec Kafka Connect<a class="headerlink" href="#outbox-relay-avec-kafka-connect" title="Permanent link">&para;</a></h3>
<p>Le relay peut être implémenté de plusieurs façons. La méthode la plus robuste utilise Kafka Connect avec le connecteur Debezium, qui capture les changements de la table outbox via le Change Data Capture (CDC). Cette approche élimine le polling et garantit une latence minimale.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="p">{</span>
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="w">    </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;outbox-connector&quot;</span><span class="p">,</span>
<a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="w">    </span><span class="nt">&quot;config&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a><span class="w">        </span><span class="nt">&quot;connector.class&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;io.debezium.connector.postgresql.PostgresConnector&quot;</span><span class="p">,</span>
<a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a><span class="w">        </span><span class="nt">&quot;database.hostname&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;postgres&quot;</span><span class="p">,</span>
<a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a><span class="w">        </span><span class="nt">&quot;database.port&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;5432&quot;</span><span class="p">,</span>
<a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a><span class="w">        </span><span class="nt">&quot;database.user&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;debezium&quot;</span><span class="p">,</span>
<a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a><span class="w">        </span><span class="nt">&quot;database.password&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;${file:/secrets/db-password}&quot;</span><span class="p">,</span>
<a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a><span class="w">        </span><span class="nt">&quot;database.dbname&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;agents&quot;</span><span class="p">,</span>
<a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a><span class="w">        </span><span class="nt">&quot;database.server.name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;agents-db&quot;</span><span class="p">,</span>
<a id="__codelineno-12-11" name="__codelineno-12-11" href="#__codelineno-12-11"></a>
<a id="__codelineno-12-12" name="__codelineno-12-12" href="#__codelineno-12-12"></a><span class="w">        </span><span class="nt">&quot;table.include.list&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;public.outbox&quot;</span><span class="p">,</span>
<a id="__codelineno-12-13" name="__codelineno-12-13" href="#__codelineno-12-13"></a>
<a id="__codelineno-12-14" name="__codelineno-12-14" href="#__codelineno-12-14"></a><span class="w">        </span><span class="nt">&quot;transforms&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;outbox&quot;</span><span class="p">,</span>
<a id="__codelineno-12-15" name="__codelineno-12-15" href="#__codelineno-12-15"></a><span class="w">        </span><span class="nt">&quot;transforms.outbox.type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;io.debezium.transforms.outbox.EventRouter&quot;</span><span class="p">,</span>
<a id="__codelineno-12-16" name="__codelineno-12-16" href="#__codelineno-12-16"></a><span class="w">        </span><span class="nt">&quot;transforms.outbox.table.fields.additional.placement&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;aggregate_type:header,aggregate_id:header&quot;</span><span class="p">,</span>
<a id="__codelineno-12-17" name="__codelineno-12-17" href="#__codelineno-12-17"></a><span class="w">        </span><span class="nt">&quot;transforms.outbox.table.field.event.id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;id&quot;</span><span class="p">,</span>
<a id="__codelineno-12-18" name="__codelineno-12-18" href="#__codelineno-12-18"></a><span class="w">        </span><span class="nt">&quot;transforms.outbox.table.field.event.key&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;aggregate_id&quot;</span><span class="p">,</span>
<a id="__codelineno-12-19" name="__codelineno-12-19" href="#__codelineno-12-19"></a><span class="w">        </span><span class="nt">&quot;transforms.outbox.table.field.event.type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;event_type&quot;</span><span class="p">,</span>
<a id="__codelineno-12-20" name="__codelineno-12-20" href="#__codelineno-12-20"></a><span class="w">        </span><span class="nt">&quot;transforms.outbox.table.field.event.payload&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;payload&quot;</span><span class="p">,</span>
<a id="__codelineno-12-21" name="__codelineno-12-21" href="#__codelineno-12-21"></a><span class="w">        </span><span class="nt">&quot;transforms.outbox.table.field.event.timestamp&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;created_at&quot;</span><span class="p">,</span>
<a id="__codelineno-12-22" name="__codelineno-12-22" href="#__codelineno-12-22"></a><span class="w">        </span><span class="nt">&quot;transforms.outbox.route.by.field&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;aggregate_type&quot;</span><span class="p">,</span>
<a id="__codelineno-12-23" name="__codelineno-12-23" href="#__codelineno-12-23"></a><span class="w">        </span><span class="nt">&quot;transforms.outbox.route.topic.replacement&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;events.${routedByValue}&quot;</span><span class="p">,</span>
<a id="__codelineno-12-24" name="__codelineno-12-24" href="#__codelineno-12-24"></a>
<a id="__codelineno-12-25" name="__codelineno-12-25" href="#__codelineno-12-25"></a><span class="w">        </span><span class="nt">&quot;tombstones.on.delete&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<a id="__codelineno-12-26" name="__codelineno-12-26" href="#__codelineno-12-26"></a><span class="w">        </span><span class="nt">&quot;key.converter&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;org.apache.kafka.connect.storage.StringConverter&quot;</span><span class="p">,</span>
<a id="__codelineno-12-27" name="__codelineno-12-27" href="#__codelineno-12-27"></a><span class="w">        </span><span class="nt">&quot;value.converter&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;org.apache.kafka.connect.json.JsonConverter&quot;</span><span class="p">,</span>
<a id="__codelineno-12-28" name="__codelineno-12-28" href="#__codelineno-12-28"></a><span class="w">        </span><span class="nt">&quot;value.converter.schemas.enable&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span>
<a id="__codelineno-12-29" name="__codelineno-12-29" href="#__codelineno-12-29"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-12-30" name="__codelineno-12-30" href="#__codelineno-12-30"></a><span class="p">}</span>
</code></pre></div>
<p>Pour les environnements où Debezium n'est pas disponible ou adapté, un relay basé sur le polling reste une option viable :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="c1"># outbox/relay.py</span>
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span>
<a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a>
<a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a><span class="k">class</span><span class="w"> </span><span class="nc">OutboxRelay</span><span class="p">:</span>
<a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Relay Outbox basé sur le polling&quot;&quot;&quot;</span>
<a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a>
<a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-13-9" name="__codelineno-13-9" href="#__codelineno-13-9"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-13-10" name="__codelineno-13-10" href="#__codelineno-13-10"></a>        <span class="n">outbox_service</span><span class="p">:</span> <span class="n">OutboxService</span><span class="p">,</span>
<a id="__codelineno-13-11" name="__codelineno-13-11" href="#__codelineno-13-11"></a>        <span class="n">kafka_producer</span><span class="p">,</span>
<a id="__codelineno-13-12" name="__codelineno-13-12" href="#__codelineno-13-12"></a>        <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span>
<a id="__codelineno-13-13" name="__codelineno-13-13" href="#__codelineno-13-13"></a>    <span class="p">):</span>
<a id="__codelineno-13-14" name="__codelineno-13-14" href="#__codelineno-13-14"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">outbox</span> <span class="o">=</span> <span class="n">outbox_service</span>
<a id="__codelineno-13-15" name="__codelineno-13-15" href="#__codelineno-13-15"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">producer</span> <span class="o">=</span> <span class="n">kafka_producer</span>
<a id="__codelineno-13-16" name="__codelineno-13-16" href="#__codelineno-13-16"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
<a id="__codelineno-13-17" name="__codelineno-13-17" href="#__codelineno-13-17"></a>
<a id="__codelineno-13-18" name="__codelineno-13-18" href="#__codelineno-13-18"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">consumer_id</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;consumer_id&#39;</span><span class="p">,</span> <span class="s1">&#39;relay-1&#39;</span><span class="p">)</span>
<a id="__codelineno-13-19" name="__codelineno-13-19" href="#__codelineno-13-19"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;batch_size&#39;</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<a id="__codelineno-13-20" name="__codelineno-13-20" href="#__codelineno-13-20"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">poll_interval</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;poll_interval&#39;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
<a id="__codelineno-13-21" name="__codelineno-13-21" href="#__codelineno-13-21"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">topic_prefix</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;topic_prefix&#39;</span><span class="p">,</span> <span class="s1">&#39;events&#39;</span><span class="p">)</span>
<a id="__codelineno-13-22" name="__codelineno-13-22" href="#__codelineno-13-22"></a>
<a id="__codelineno-13-23" name="__codelineno-13-23" href="#__codelineno-13-23"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_running</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-13-24" name="__codelineno-13-24" href="#__codelineno-13-24"></a>
<a id="__codelineno-13-25" name="__codelineno-13-25" href="#__codelineno-13-25"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-13-26" name="__codelineno-13-26" href="#__codelineno-13-26"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Démarre le relay&quot;&quot;&quot;</span>
<a id="__codelineno-13-27" name="__codelineno-13-27" href="#__codelineno-13-27"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_running</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-13-28" name="__codelineno-13-28" href="#__codelineno-13-28"></a>
<a id="__codelineno-13-29" name="__codelineno-13-29" href="#__codelineno-13-29"></a>        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_running</span><span class="p">:</span>
<a id="__codelineno-13-30" name="__codelineno-13-30" href="#__codelineno-13-30"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-13-31" name="__codelineno-13-31" href="#__codelineno-13-31"></a>                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_batch</span><span class="p">()</span>
<a id="__codelineno-13-32" name="__codelineno-13-32" href="#__codelineno-13-32"></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-13-33" name="__codelineno-13-33" href="#__codelineno-13-33"></a>                <span class="c1"># Log error, continue</span>
<a id="__codelineno-13-34" name="__codelineno-13-34" href="#__codelineno-13-34"></a>                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">poll_interval</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-13-35" name="__codelineno-13-35" href="#__codelineno-13-35"></a>
<a id="__codelineno-13-36" name="__codelineno-13-36" href="#__codelineno-13-36"></a>            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">poll_interval</span><span class="p">)</span>
<a id="__codelineno-13-37" name="__codelineno-13-37" href="#__codelineno-13-37"></a>
<a id="__codelineno-13-38" name="__codelineno-13-38" href="#__codelineno-13-38"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-13-39" name="__codelineno-13-39" href="#__codelineno-13-39"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Arrête le relay&quot;&quot;&quot;</span>
<a id="__codelineno-13-40" name="__codelineno-13-40" href="#__codelineno-13-40"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_running</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-13-41" name="__codelineno-13-41" href="#__codelineno-13-41"></a>
<a id="__codelineno-13-42" name="__codelineno-13-42" href="#__codelineno-13-42"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_process_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-13-43" name="__codelineno-13-43" href="#__codelineno-13-43"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Traite un lot d&#39;événements&quot;&quot;&quot;</span>
<a id="__codelineno-13-44" name="__codelineno-13-44" href="#__codelineno-13-44"></a>
<a id="__codelineno-13-45" name="__codelineno-13-45" href="#__codelineno-13-45"></a>        <span class="n">events</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">outbox</span><span class="o">.</span><span class="n">get_unpublished</span><span class="p">(</span>
<a id="__codelineno-13-46" name="__codelineno-13-46" href="#__codelineno-13-46"></a>            <span class="n">batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
<a id="__codelineno-13-47" name="__codelineno-13-47" href="#__codelineno-13-47"></a>            <span class="n">consumer_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">consumer_id</span>
<a id="__codelineno-13-48" name="__codelineno-13-48" href="#__codelineno-13-48"></a>        <span class="p">)</span>
<a id="__codelineno-13-49" name="__codelineno-13-49" href="#__codelineno-13-49"></a>
<a id="__codelineno-13-50" name="__codelineno-13-50" href="#__codelineno-13-50"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">events</span><span class="p">:</span>
<a id="__codelineno-13-51" name="__codelineno-13-51" href="#__codelineno-13-51"></a>            <span class="k">return</span>
<a id="__codelineno-13-52" name="__codelineno-13-52" href="#__codelineno-13-52"></a>
<a id="__codelineno-13-53" name="__codelineno-13-53" href="#__codelineno-13-53"></a>        <span class="n">published_ids</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-13-54" name="__codelineno-13-54" href="#__codelineno-13-54"></a>
<a id="__codelineno-13-55" name="__codelineno-13-55" href="#__codelineno-13-55"></a>        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span>
<a id="__codelineno-13-56" name="__codelineno-13-56" href="#__codelineno-13-56"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-13-57" name="__codelineno-13-57" href="#__codelineno-13-57"></a>                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
<a id="__codelineno-13-58" name="__codelineno-13-58" href="#__codelineno-13-58"></a>                <span class="n">published_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>
<a id="__codelineno-13-59" name="__codelineno-13-59" href="#__codelineno-13-59"></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-13-60" name="__codelineno-13-60" href="#__codelineno-13-60"></a>                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">outbox</span><span class="o">.</span><span class="n">mark_failed</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
<a id="__codelineno-13-61" name="__codelineno-13-61" href="#__codelineno-13-61"></a>
<a id="__codelineno-13-62" name="__codelineno-13-62" href="#__codelineno-13-62"></a>        <span class="k">if</span> <span class="n">published_ids</span><span class="p">:</span>
<a id="__codelineno-13-63" name="__codelineno-13-63" href="#__codelineno-13-63"></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">outbox</span><span class="o">.</span><span class="n">mark_published</span><span class="p">(</span><span class="n">published_ids</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">consumer_id</span><span class="p">)</span>
<a id="__codelineno-13-64" name="__codelineno-13-64" href="#__codelineno-13-64"></a>
<a id="__codelineno-13-65" name="__codelineno-13-65" href="#__codelineno-13-65"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_publish_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-13-66" name="__codelineno-13-66" href="#__codelineno-13-66"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Publie un événement sur Kafka&quot;&quot;&quot;</span>
<a id="__codelineno-13-67" name="__codelineno-13-67" href="#__codelineno-13-67"></a>
<a id="__codelineno-13-68" name="__codelineno-13-68" href="#__codelineno-13-68"></a>        <span class="n">topic</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">topic_prefix</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">event</span><span class="p">[</span><span class="s1">&#39;aggregate_type&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-13-69" name="__codelineno-13-69" href="#__codelineno-13-69"></a>
<a id="__codelineno-13-70" name="__codelineno-13-70" href="#__codelineno-13-70"></a>        <span class="c1"># Publication synchrone pour garantir l&#39;ordre</span>
<a id="__codelineno-13-71" name="__codelineno-13-71" href="#__codelineno-13-71"></a>        <span class="n">future</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">producer</span><span class="o">.</span><span class="n">produce</span><span class="p">(</span>
<a id="__codelineno-13-72" name="__codelineno-13-72" href="#__codelineno-13-72"></a>            <span class="n">topic</span><span class="o">=</span><span class="n">topic</span><span class="p">,</span>
<a id="__codelineno-13-73" name="__codelineno-13-73" href="#__codelineno-13-73"></a>            <span class="n">key</span><span class="o">=</span><span class="n">event</span><span class="p">[</span><span class="s1">&#39;aggregate_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(),</span>
<a id="__codelineno-13-74" name="__codelineno-13-74" href="#__codelineno-13-74"></a>            <span class="n">value</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="s1">&#39;payload&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">encode</span><span class="p">(),</span>
<a id="__codelineno-13-75" name="__codelineno-13-75" href="#__codelineno-13-75"></a>            <span class="n">headers</span><span class="o">=</span><span class="p">[</span>
<a id="__codelineno-13-76" name="__codelineno-13-76" href="#__codelineno-13-76"></a>                <span class="p">(</span><span class="s1">&#39;event_type&#39;</span><span class="p">,</span> <span class="n">event</span><span class="p">[</span><span class="s1">&#39;event_type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">()),</span>
<a id="__codelineno-13-77" name="__codelineno-13-77" href="#__codelineno-13-77"></a>                <span class="p">(</span><span class="s1">&#39;aggregate_type&#39;</span><span class="p">,</span> <span class="n">event</span><span class="p">[</span><span class="s1">&#39;aggregate_type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">()),</span>
<a id="__codelineno-13-78" name="__codelineno-13-78" href="#__codelineno-13-78"></a>                <span class="p">(</span><span class="s1">&#39;aggregate_id&#39;</span><span class="p">,</span> <span class="n">event</span><span class="p">[</span><span class="s1">&#39;aggregate_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">()),</span>
<a id="__codelineno-13-79" name="__codelineno-13-79" href="#__codelineno-13-79"></a>                <span class="p">(</span><span class="s1">&#39;outbox_id&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
<a id="__codelineno-13-80" name="__codelineno-13-80" href="#__codelineno-13-80"></a>            <span class="p">]</span>
<a id="__codelineno-13-81" name="__codelineno-13-81" href="#__codelineno-13-81"></a>        <span class="p">)</span>
<a id="__codelineno-13-82" name="__codelineno-13-82" href="#__codelineno-13-82"></a>
<a id="__codelineno-13-83" name="__codelineno-13-83" href="#__codelineno-13-83"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">producer</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
</code></pre></div>
<blockquote>
<p><strong>Bonnes pratiques</strong><br />
Configurez une politique de rétention pour la table outbox : les événements publiés peuvent être supprimés après un délai configurable. Surveillez la taille de la table et le lag du relay comme indicateurs de santé du système.</p>
</blockquote>
<hr />
<h2 id="ii95-gestion-des-erreurs-et-resilience">II.9.5 Gestion des Erreurs et Résilience<a class="headerlink" href="#ii95-gestion-des-erreurs-et-resilience" title="Permanent link">&para;</a></h2>
<h3 id="taxonomie-des-erreurs-dans-les-systemes-agentiques">Taxonomie des Erreurs dans les Systèmes Agentiques<a class="headerlink" href="#taxonomie-des-erreurs-dans-les-systemes-agentiques" title="Permanent link">&para;</a></h3>
<p>Les systèmes agentiques sont exposés à une variété d'erreurs qui nécessitent des stratégies de traitement différenciées. Une taxonomie claire permet de définir les comportements appropriés pour chaque type d'erreur et d'éviter les réponses inadaptées qui pourraient aggraver la situation.</p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Caractéristiques</th>
<th>Exemples</th>
<th>Stratégie</th>
</tr>
</thead>
<tbody>
<tr>
<td>Transitoire</td>
<td>Temporaire, auto-résolution</td>
<td>Timeout réseau, surcharge</td>
<td>Retry avec backoff</td>
</tr>
<tr>
<td>Permanente</td>
<td>Ne se résout pas seule</td>
<td>Données invalides, autorisation</td>
<td>Dead Letter Queue</td>
</tr>
<tr>
<td>Cognitive</td>
<td>Erreur de l'agent IA</td>
<td>Hallucination, hors-sujet</td>
<td>Escalade humaine</td>
</tr>
<tr>
<td>Systémique</td>
<td>Défaillance infrastructure</td>
<td>Broker down, DB crash</td>
<td>Circuit breaker</td>
</tr>
</tbody>
</table>
<h3 id="implementation-des-patterns-de-resilience">Implémentation des Patterns de Résilience<a class="headerlink" href="#implementation-des-patterns-de-resilience" title="Permanent link">&para;</a></h3>
<p>La résilience d'un système agentique repose sur plusieurs patterns complémentaires : le retry avec backoff exponentiel pour les erreurs transitoires, le circuit breaker pour prévenir les cascades de défaillances, la dead letter queue pour isoler les messages problématiques, et le bulkhead pour limiter l'impact des défaillances.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="c1"># resilience/patterns.py</span>
<a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
<a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Any</span>
<a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">enum</span><span class="w"> </span><span class="kn">import</span> <span class="n">Enum</span>
<a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a><span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
<a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a>
<a id="__codelineno-14-9" name="__codelineno-14-9" href="#__codelineno-14-9"></a><span class="k">class</span><span class="w"> </span><span class="nc">CircuitState</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
<a id="__codelineno-14-10" name="__codelineno-14-10" href="#__codelineno-14-10"></a>    <span class="n">CLOSED</span> <span class="o">=</span> <span class="s2">&quot;closed&quot;</span>      <span class="c1"># Fonctionnement normal</span>
<a id="__codelineno-14-11" name="__codelineno-14-11" href="#__codelineno-14-11"></a>    <span class="n">OPEN</span> <span class="o">=</span> <span class="s2">&quot;open&quot;</span>          <span class="c1"># Bloque les appels</span>
<a id="__codelineno-14-12" name="__codelineno-14-12" href="#__codelineno-14-12"></a>    <span class="n">HALF_OPEN</span> <span class="o">=</span> <span class="s2">&quot;half_open&quot;</span>  <span class="c1"># Test de récupération</span>
<a id="__codelineno-14-13" name="__codelineno-14-13" href="#__codelineno-14-13"></a>
<a id="__codelineno-14-14" name="__codelineno-14-14" href="#__codelineno-14-14"></a><span class="nd">@dataclass</span>
<a id="__codelineno-14-15" name="__codelineno-14-15" href="#__codelineno-14-15"></a><span class="k">class</span><span class="w"> </span><span class="nc">RetryConfig</span><span class="p">:</span>
<a id="__codelineno-14-16" name="__codelineno-14-16" href="#__codelineno-14-16"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Configuration des retries&quot;&quot;&quot;</span>
<a id="__codelineno-14-17" name="__codelineno-14-17" href="#__codelineno-14-17"></a>    <span class="n">max_attempts</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span>
<a id="__codelineno-14-18" name="__codelineno-14-18" href="#__codelineno-14-18"></a>    <span class="n">base_delay</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span>
<a id="__codelineno-14-19" name="__codelineno-14-19" href="#__codelineno-14-19"></a>    <span class="n">max_delay</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">60.0</span>
<a id="__codelineno-14-20" name="__codelineno-14-20" href="#__codelineno-14-20"></a>    <span class="n">exponential_base</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span>
<a id="__codelineno-14-21" name="__codelineno-14-21" href="#__codelineno-14-21"></a>    <span class="n">jitter</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-14-22" name="__codelineno-14-22" href="#__codelineno-14-22"></a>    <span class="n">retryable_exceptions</span><span class="p">:</span> <span class="nb">tuple</span> <span class="o">=</span> <span class="p">(</span><span class="ne">Exception</span><span class="p">,)</span>
<a id="__codelineno-14-23" name="__codelineno-14-23" href="#__codelineno-14-23"></a>
<a id="__codelineno-14-24" name="__codelineno-14-24" href="#__codelineno-14-24"></a><span class="k">class</span><span class="w"> </span><span class="nc">RetryHandler</span><span class="p">:</span>
<a id="__codelineno-14-25" name="__codelineno-14-25" href="#__codelineno-14-25"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Gestionnaire de retry avec backoff exponentiel&quot;&quot;&quot;</span>
<a id="__codelineno-14-26" name="__codelineno-14-26" href="#__codelineno-14-26"></a>
<a id="__codelineno-14-27" name="__codelineno-14-27" href="#__codelineno-14-27"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">RetryConfig</span><span class="p">):</span>
<a id="__codelineno-14-28" name="__codelineno-14-28" href="#__codelineno-14-28"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
<a id="__codelineno-14-29" name="__codelineno-14-29" href="#__codelineno-14-29"></a>
<a id="__codelineno-14-30" name="__codelineno-14-30" href="#__codelineno-14-30"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span>
<a id="__codelineno-14-31" name="__codelineno-14-31" href="#__codelineno-14-31"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-14-32" name="__codelineno-14-32" href="#__codelineno-14-32"></a>        <span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span>
<a id="__codelineno-14-33" name="__codelineno-14-33" href="#__codelineno-14-33"></a>        <span class="o">*</span><span class="n">args</span><span class="p">,</span>
<a id="__codelineno-14-34" name="__codelineno-14-34" href="#__codelineno-14-34"></a>        <span class="o">**</span><span class="n">kwargs</span>
<a id="__codelineno-14-35" name="__codelineno-14-35" href="#__codelineno-14-35"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<a id="__codelineno-14-36" name="__codelineno-14-36" href="#__codelineno-14-36"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Exécute une fonction avec retry&quot;&quot;&quot;</span>
<a id="__codelineno-14-37" name="__codelineno-14-37" href="#__codelineno-14-37"></a>
<a id="__codelineno-14-38" name="__codelineno-14-38" href="#__codelineno-14-38"></a>        <span class="n">last_exception</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-14-39" name="__codelineno-14-39" href="#__codelineno-14-39"></a>
<a id="__codelineno-14-40" name="__codelineno-14-40" href="#__codelineno-14-40"></a>        <span class="k">for</span> <span class="n">attempt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">max_attempts</span><span class="p">):</span>
<a id="__codelineno-14-41" name="__codelineno-14-41" href="#__codelineno-14-41"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-14-42" name="__codelineno-14-42" href="#__codelineno-14-42"></a>                <span class="k">return</span> <span class="k">await</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-14-43" name="__codelineno-14-43" href="#__codelineno-14-43"></a>            <span class="k">except</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">retryable_exceptions</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-14-44" name="__codelineno-14-44" href="#__codelineno-14-44"></a>                <span class="n">last_exception</span> <span class="o">=</span> <span class="n">e</span>
<a id="__codelineno-14-45" name="__codelineno-14-45" href="#__codelineno-14-45"></a>
<a id="__codelineno-14-46" name="__codelineno-14-46" href="#__codelineno-14-46"></a>                <span class="k">if</span> <span class="n">attempt</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">max_attempts</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-14-47" name="__codelineno-14-47" href="#__codelineno-14-47"></a>                    <span class="n">delay</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_delay</span><span class="p">(</span><span class="n">attempt</span><span class="p">)</span>
<a id="__codelineno-14-48" name="__codelineno-14-48" href="#__codelineno-14-48"></a>                    <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span>
<a id="__codelineno-14-49" name="__codelineno-14-49" href="#__codelineno-14-49"></a>
<a id="__codelineno-14-50" name="__codelineno-14-50" href="#__codelineno-14-50"></a>        <span class="k">raise</span> <span class="n">last_exception</span>
<a id="__codelineno-14-51" name="__codelineno-14-51" href="#__codelineno-14-51"></a>
<a id="__codelineno-14-52" name="__codelineno-14-52" href="#__codelineno-14-52"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_calculate_delay</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attempt</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<a id="__codelineno-14-53" name="__codelineno-14-53" href="#__codelineno-14-53"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Calcule le délai avec backoff exponentiel et jitter&quot;&quot;&quot;</span>
<a id="__codelineno-14-54" name="__codelineno-14-54" href="#__codelineno-14-54"></a>
<a id="__codelineno-14-55" name="__codelineno-14-55" href="#__codelineno-14-55"></a>        <span class="n">delay</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
<a id="__codelineno-14-56" name="__codelineno-14-56" href="#__codelineno-14-56"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">base_delay</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">exponential_base</span> <span class="o">**</span> <span class="n">attempt</span><span class="p">),</span>
<a id="__codelineno-14-57" name="__codelineno-14-57" href="#__codelineno-14-57"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">max_delay</span>
<a id="__codelineno-14-58" name="__codelineno-14-58" href="#__codelineno-14-58"></a>        <span class="p">)</span>
<a id="__codelineno-14-59" name="__codelineno-14-59" href="#__codelineno-14-59"></a>
<a id="__codelineno-14-60" name="__codelineno-14-60" href="#__codelineno-14-60"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">jitter</span><span class="p">:</span>
<a id="__codelineno-14-61" name="__codelineno-14-61" href="#__codelineno-14-61"></a>            <span class="n">delay</span> <span class="o">=</span> <span class="n">delay</span> <span class="o">*</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">+</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">())</span>
<a id="__codelineno-14-62" name="__codelineno-14-62" href="#__codelineno-14-62"></a>
<a id="__codelineno-14-63" name="__codelineno-14-63" href="#__codelineno-14-63"></a>        <span class="k">return</span> <span class="n">delay</span>
<a id="__codelineno-14-64" name="__codelineno-14-64" href="#__codelineno-14-64"></a>
<a id="__codelineno-14-65" name="__codelineno-14-65" href="#__codelineno-14-65"></a>
<a id="__codelineno-14-66" name="__codelineno-14-66" href="#__codelineno-14-66"></a><span class="nd">@dataclass</span>
<a id="__codelineno-14-67" name="__codelineno-14-67" href="#__codelineno-14-67"></a><span class="k">class</span><span class="w"> </span><span class="nc">CircuitBreakerConfig</span><span class="p">:</span>
<a id="__codelineno-14-68" name="__codelineno-14-68" href="#__codelineno-14-68"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Configuration du circuit breaker&quot;&quot;&quot;</span>
<a id="__codelineno-14-69" name="__codelineno-14-69" href="#__codelineno-14-69"></a>    <span class="n">failure_threshold</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span>
<a id="__codelineno-14-70" name="__codelineno-14-70" href="#__codelineno-14-70"></a>    <span class="n">success_threshold</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span>
<a id="__codelineno-14-71" name="__codelineno-14-71" href="#__codelineno-14-71"></a>    <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">30.0</span>
<a id="__codelineno-14-72" name="__codelineno-14-72" href="#__codelineno-14-72"></a>    <span class="n">half_open_max_calls</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span>
<a id="__codelineno-14-73" name="__codelineno-14-73" href="#__codelineno-14-73"></a>
<a id="__codelineno-14-74" name="__codelineno-14-74" href="#__codelineno-14-74"></a><span class="k">class</span><span class="w"> </span><span class="nc">CircuitBreaker</span><span class="p">:</span>
<a id="__codelineno-14-75" name="__codelineno-14-75" href="#__codelineno-14-75"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Circuit breaker pour protection contre les cascades de défaillances&quot;&quot;&quot;</span>
<a id="__codelineno-14-76" name="__codelineno-14-76" href="#__codelineno-14-76"></a>
<a id="__codelineno-14-77" name="__codelineno-14-77" href="#__codelineno-14-77"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">CircuitBreakerConfig</span><span class="p">):</span>
<a id="__codelineno-14-78" name="__codelineno-14-78" href="#__codelineno-14-78"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
<a id="__codelineno-14-79" name="__codelineno-14-79" href="#__codelineno-14-79"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
<a id="__codelineno-14-80" name="__codelineno-14-80" href="#__codelineno-14-80"></a>
<a id="__codelineno-14-81" name="__codelineno-14-81" href="#__codelineno-14-81"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">=</span> <span class="n">CircuitState</span><span class="o">.</span><span class="n">CLOSED</span>
<a id="__codelineno-14-82" name="__codelineno-14-82" href="#__codelineno-14-82"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_failure_count</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-14-83" name="__codelineno-14-83" href="#__codelineno-14-83"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_success_count</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-14-84" name="__codelineno-14-84" href="#__codelineno-14-84"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_last_failure_time</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">datetime</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-14-85" name="__codelineno-14-85" href="#__codelineno-14-85"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_half_open_calls</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-14-86" name="__codelineno-14-86" href="#__codelineno-14-86"></a>
<a id="__codelineno-14-87" name="__codelineno-14-87" href="#__codelineno-14-87"></a>    <span class="nd">@property</span>
<a id="__codelineno-14-88" name="__codelineno-14-88" href="#__codelineno-14-88"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">state</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CircuitState</span><span class="p">:</span>
<a id="__codelineno-14-89" name="__codelineno-14-89" href="#__codelineno-14-89"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;État actuel du circuit&quot;&quot;&quot;</span>
<a id="__codelineno-14-90" name="__codelineno-14-90" href="#__codelineno-14-90"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">==</span> <span class="n">CircuitState</span><span class="o">.</span><span class="n">OPEN</span><span class="p">:</span>
<a id="__codelineno-14-91" name="__codelineno-14-91" href="#__codelineno-14-91"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_should_attempt_reset</span><span class="p">():</span>
<a id="__codelineno-14-92" name="__codelineno-14-92" href="#__codelineno-14-92"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">=</span> <span class="n">CircuitState</span><span class="o">.</span><span class="n">HALF_OPEN</span>
<a id="__codelineno-14-93" name="__codelineno-14-93" href="#__codelineno-14-93"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_half_open_calls</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-14-94" name="__codelineno-14-94" href="#__codelineno-14-94"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span>
<a id="__codelineno-14-95" name="__codelineno-14-95" href="#__codelineno-14-95"></a>
<a id="__codelineno-14-96" name="__codelineno-14-96" href="#__codelineno-14-96"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span>
<a id="__codelineno-14-97" name="__codelineno-14-97" href="#__codelineno-14-97"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-14-98" name="__codelineno-14-98" href="#__codelineno-14-98"></a>        <span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span>
<a id="__codelineno-14-99" name="__codelineno-14-99" href="#__codelineno-14-99"></a>        <span class="o">*</span><span class="n">args</span><span class="p">,</span>
<a id="__codelineno-14-100" name="__codelineno-14-100" href="#__codelineno-14-100"></a>        <span class="o">**</span><span class="n">kwargs</span>
<a id="__codelineno-14-101" name="__codelineno-14-101" href="#__codelineno-14-101"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<a id="__codelineno-14-102" name="__codelineno-14-102" href="#__codelineno-14-102"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Exécute une fonction avec protection circuit breaker&quot;&quot;&quot;</span>
<a id="__codelineno-14-103" name="__codelineno-14-103" href="#__codelineno-14-103"></a>
<a id="__codelineno-14-104" name="__codelineno-14-104" href="#__codelineno-14-104"></a>        <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span>
<a id="__codelineno-14-105" name="__codelineno-14-105" href="#__codelineno-14-105"></a>
<a id="__codelineno-14-106" name="__codelineno-14-106" href="#__codelineno-14-106"></a>        <span class="k">if</span> <span class="n">state</span> <span class="o">==</span> <span class="n">CircuitState</span><span class="o">.</span><span class="n">OPEN</span><span class="p">:</span>
<a id="__codelineno-14-107" name="__codelineno-14-107" href="#__codelineno-14-107"></a>            <span class="k">raise</span> <span class="n">CircuitOpenError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Circuit </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> is open&quot;</span><span class="p">)</span>
<a id="__codelineno-14-108" name="__codelineno-14-108" href="#__codelineno-14-108"></a>
<a id="__codelineno-14-109" name="__codelineno-14-109" href="#__codelineno-14-109"></a>        <span class="k">if</span> <span class="n">state</span> <span class="o">==</span> <span class="n">CircuitState</span><span class="o">.</span><span class="n">HALF_OPEN</span><span class="p">:</span>
<a id="__codelineno-14-110" name="__codelineno-14-110" href="#__codelineno-14-110"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_half_open_calls</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">half_open_max_calls</span><span class="p">:</span>
<a id="__codelineno-14-111" name="__codelineno-14-111" href="#__codelineno-14-111"></a>                <span class="k">raise</span> <span class="n">CircuitOpenError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Circuit </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> half-open limit reached&quot;</span><span class="p">)</span>
<a id="__codelineno-14-112" name="__codelineno-14-112" href="#__codelineno-14-112"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_half_open_calls</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-14-113" name="__codelineno-14-113" href="#__codelineno-14-113"></a>
<a id="__codelineno-14-114" name="__codelineno-14-114" href="#__codelineno-14-114"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-14-115" name="__codelineno-14-115" href="#__codelineno-14-115"></a>            <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-14-116" name="__codelineno-14-116" href="#__codelineno-14-116"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_on_success</span><span class="p">()</span>
<a id="__codelineno-14-117" name="__codelineno-14-117" href="#__codelineno-14-117"></a>            <span class="k">return</span> <span class="n">result</span>
<a id="__codelineno-14-118" name="__codelineno-14-118" href="#__codelineno-14-118"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-14-119" name="__codelineno-14-119" href="#__codelineno-14-119"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_on_failure</span><span class="p">()</span>
<a id="__codelineno-14-120" name="__codelineno-14-120" href="#__codelineno-14-120"></a>            <span class="k">raise</span>
<a id="__codelineno-14-121" name="__codelineno-14-121" href="#__codelineno-14-121"></a>
<a id="__codelineno-14-122" name="__codelineno-14-122" href="#__codelineno-14-122"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_on_success</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-14-123" name="__codelineno-14-123" href="#__codelineno-14-123"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Appelé après un succès&quot;&quot;&quot;</span>
<a id="__codelineno-14-124" name="__codelineno-14-124" href="#__codelineno-14-124"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">==</span> <span class="n">CircuitState</span><span class="o">.</span><span class="n">HALF_OPEN</span><span class="p">:</span>
<a id="__codelineno-14-125" name="__codelineno-14-125" href="#__codelineno-14-125"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_success_count</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-14-126" name="__codelineno-14-126" href="#__codelineno-14-126"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_success_count</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">success_threshold</span><span class="p">:</span>
<a id="__codelineno-14-127" name="__codelineno-14-127" href="#__codelineno-14-127"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_reset</span><span class="p">()</span>
<a id="__codelineno-14-128" name="__codelineno-14-128" href="#__codelineno-14-128"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-14-129" name="__codelineno-14-129" href="#__codelineno-14-129"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_failure_count</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-14-130" name="__codelineno-14-130" href="#__codelineno-14-130"></a>
<a id="__codelineno-14-131" name="__codelineno-14-131" href="#__codelineno-14-131"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_on_failure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-14-132" name="__codelineno-14-132" href="#__codelineno-14-132"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Appelé après un échec&quot;&quot;&quot;</span>
<a id="__codelineno-14-133" name="__codelineno-14-133" href="#__codelineno-14-133"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_failure_count</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-14-134" name="__codelineno-14-134" href="#__codelineno-14-134"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_last_failure_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
<a id="__codelineno-14-135" name="__codelineno-14-135" href="#__codelineno-14-135"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_success_count</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-14-136" name="__codelineno-14-136" href="#__codelineno-14-136"></a>
<a id="__codelineno-14-137" name="__codelineno-14-137" href="#__codelineno-14-137"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_failure_count</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">failure_threshold</span><span class="p">:</span>
<a id="__codelineno-14-138" name="__codelineno-14-138" href="#__codelineno-14-138"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">=</span> <span class="n">CircuitState</span><span class="o">.</span><span class="n">OPEN</span>
<a id="__codelineno-14-139" name="__codelineno-14-139" href="#__codelineno-14-139"></a>
<a id="__codelineno-14-140" name="__codelineno-14-140" href="#__codelineno-14-140"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_should_attempt_reset</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-14-141" name="__codelineno-14-141" href="#__codelineno-14-141"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Vérifie si le circuit devrait passer en half-open&quot;&quot;&quot;</span>
<a id="__codelineno-14-142" name="__codelineno-14-142" href="#__codelineno-14-142"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_failure_time</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-14-143" name="__codelineno-14-143" href="#__codelineno-14-143"></a>            <span class="k">return</span> <span class="kc">True</span>
<a id="__codelineno-14-144" name="__codelineno-14-144" href="#__codelineno-14-144"></a>
<a id="__codelineno-14-145" name="__codelineno-14-145" href="#__codelineno-14-145"></a>        <span class="n">elapsed</span> <span class="o">=</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_failure_time</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
<a id="__codelineno-14-146" name="__codelineno-14-146" href="#__codelineno-14-146"></a>        <span class="k">return</span> <span class="n">elapsed</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">timeout</span>
<a id="__codelineno-14-147" name="__codelineno-14-147" href="#__codelineno-14-147"></a>
<a id="__codelineno-14-148" name="__codelineno-14-148" href="#__codelineno-14-148"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-14-149" name="__codelineno-14-149" href="#__codelineno-14-149"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Réinitialise le circuit&quot;&quot;&quot;</span>
<a id="__codelineno-14-150" name="__codelineno-14-150" href="#__codelineno-14-150"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">=</span> <span class="n">CircuitState</span><span class="o">.</span><span class="n">CLOSED</span>
<a id="__codelineno-14-151" name="__codelineno-14-151" href="#__codelineno-14-151"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_failure_count</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-14-152" name="__codelineno-14-152" href="#__codelineno-14-152"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_success_count</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-14-153" name="__codelineno-14-153" href="#__codelineno-14-153"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_half_open_calls</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-14-154" name="__codelineno-14-154" href="#__codelineno-14-154"></a>
<a id="__codelineno-14-155" name="__codelineno-14-155" href="#__codelineno-14-155"></a>
<a id="__codelineno-14-156" name="__codelineno-14-156" href="#__codelineno-14-156"></a><span class="k">class</span><span class="w"> </span><span class="nc">CircuitOpenError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
<a id="__codelineno-14-157" name="__codelineno-14-157" href="#__codelineno-14-157"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Erreur levée quand le circuit est ouvert&quot;&quot;&quot;</span>
<a id="__codelineno-14-158" name="__codelineno-14-158" href="#__codelineno-14-158"></a>    <span class="k">pass</span>
</code></pre></div>
<h3 id="dead-letter-queue-et-traitement-des-poisons">Dead Letter Queue et Traitement des Poisons<a class="headerlink" href="#dead-letter-queue-et-traitement-des-poisons" title="Permanent link">&para;</a></h3>
<p>Les messages qui ne peuvent pas être traités après plusieurs tentatives sont dirigés vers une Dead Letter Queue (DLQ). Cette file d'attente permet d'isoler les messages problématiques sans bloquer le traitement des autres messages, tout en préservant la possibilité d'analyse et de retraitement manuel.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="c1"># resilience/dlq.py</span>
<a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>
<a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span>
<a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a>
<a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a><span class="nd">@dataclass</span>
<a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a><span class="k">class</span><span class="w"> </span><span class="nc">DeadLetter</span><span class="p">:</span>
<a id="__codelineno-15-9" name="__codelineno-15-9" href="#__codelineno-15-9"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Message dans la Dead Letter Queue&quot;&quot;&quot;</span>
<a id="__codelineno-15-10" name="__codelineno-15-10" href="#__codelineno-15-10"></a>    <span class="n">original_topic</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-15-11" name="__codelineno-15-11" href="#__codelineno-15-11"></a>    <span class="n">original_key</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-15-12" name="__codelineno-15-12" href="#__codelineno-15-12"></a>    <span class="n">original_value</span><span class="p">:</span> <span class="nb">bytes</span>
<a id="__codelineno-15-13" name="__codelineno-15-13" href="#__codelineno-15-13"></a>    <span class="n">original_headers</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]</span>
<a id="__codelineno-15-14" name="__codelineno-15-14" href="#__codelineno-15-14"></a>    <span class="n">error_type</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-15-15" name="__codelineno-15-15" href="#__codelineno-15-15"></a>    <span class="n">error_message</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-15-16" name="__codelineno-15-16" href="#__codelineno-15-16"></a>    <span class="n">stack_trace</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
<a id="__codelineno-15-17" name="__codelineno-15-17" href="#__codelineno-15-17"></a>    <span class="n">retry_count</span><span class="p">:</span> <span class="nb">int</span>
<a id="__codelineno-15-18" name="__codelineno-15-18" href="#__codelineno-15-18"></a>    <span class="n">first_failure</span><span class="p">:</span> <span class="n">datetime</span>
<a id="__codelineno-15-19" name="__codelineno-15-19" href="#__codelineno-15-19"></a>    <span class="n">last_failure</span><span class="p">:</span> <span class="n">datetime</span>
<a id="__codelineno-15-20" name="__codelineno-15-20" href="#__codelineno-15-20"></a>    <span class="n">consumer_group</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-15-21" name="__codelineno-15-21" href="#__codelineno-15-21"></a>
<a id="__codelineno-15-22" name="__codelineno-15-22" href="#__codelineno-15-22"></a><span class="k">class</span><span class="w"> </span><span class="nc">DeadLetterHandler</span><span class="p">:</span>
<a id="__codelineno-15-23" name="__codelineno-15-23" href="#__codelineno-15-23"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Gestionnaire de Dead Letter Queue&quot;&quot;&quot;</span>
<a id="__codelineno-15-24" name="__codelineno-15-24" href="#__codelineno-15-24"></a>
<a id="__codelineno-15-25" name="__codelineno-15-25" href="#__codelineno-15-25"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">producer</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-15-26" name="__codelineno-15-26" href="#__codelineno-15-26"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">producer</span> <span class="o">=</span> <span class="n">producer</span>
<a id="__codelineno-15-27" name="__codelineno-15-27" href="#__codelineno-15-27"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dlq_topic</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dlq_topic&#39;</span><span class="p">,</span> <span class="s1">&#39;dead-letter-queue&#39;</span><span class="p">)</span>
<a id="__codelineno-15-28" name="__codelineno-15-28" href="#__codelineno-15-28"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">max_retries</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_retries&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<a id="__codelineno-15-29" name="__codelineno-15-29" href="#__codelineno-15-29"></a>
<a id="__codelineno-15-30" name="__codelineno-15-30" href="#__codelineno-15-30"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">send_to_dlq</span><span class="p">(</span>
<a id="__codelineno-15-31" name="__codelineno-15-31" href="#__codelineno-15-31"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-15-32" name="__codelineno-15-32" href="#__codelineno-15-32"></a>        <span class="n">message</span><span class="p">,</span>
<a id="__codelineno-15-33" name="__codelineno-15-33" href="#__codelineno-15-33"></a>        <span class="n">error</span><span class="p">:</span> <span class="ne">Exception</span><span class="p">,</span>
<a id="__codelineno-15-34" name="__codelineno-15-34" href="#__codelineno-15-34"></a>        <span class="n">retry_count</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<a id="__codelineno-15-35" name="__codelineno-15-35" href="#__codelineno-15-35"></a>        <span class="n">consumer_group</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-15-36" name="__codelineno-15-36" href="#__codelineno-15-36"></a>    <span class="p">):</span>
<a id="__codelineno-15-37" name="__codelineno-15-37" href="#__codelineno-15-37"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Envoie un message vers la DLQ&quot;&quot;&quot;</span>
<a id="__codelineno-15-38" name="__codelineno-15-38" href="#__codelineno-15-38"></a>
<a id="__codelineno-15-39" name="__codelineno-15-39" href="#__codelineno-15-39"></a>        <span class="n">dead_letter</span> <span class="o">=</span> <span class="n">DeadLetter</span><span class="p">(</span>
<a id="__codelineno-15-40" name="__codelineno-15-40" href="#__codelineno-15-40"></a>            <span class="n">original_topic</span><span class="o">=</span><span class="n">message</span><span class="o">.</span><span class="n">topic</span><span class="p">(),</span>
<a id="__codelineno-15-41" name="__codelineno-15-41" href="#__codelineno-15-41"></a>            <span class="n">original_key</span><span class="o">=</span><span class="n">message</span><span class="o">.</span><span class="n">key</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span> <span class="k">if</span> <span class="n">message</span><span class="o">.</span><span class="n">key</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<a id="__codelineno-15-42" name="__codelineno-15-42" href="#__codelineno-15-42"></a>            <span class="n">original_value</span><span class="o">=</span><span class="n">message</span><span class="o">.</span><span class="n">value</span><span class="p">(),</span>
<a id="__codelineno-15-43" name="__codelineno-15-43" href="#__codelineno-15-43"></a>            <span class="n">original_headers</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-15-44" name="__codelineno-15-44" href="#__codelineno-15-44"></a>                <span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">headers</span><span class="p">()</span> <span class="ow">or</span> <span class="p">[])</span>
<a id="__codelineno-15-45" name="__codelineno-15-45" href="#__codelineno-15-45"></a>            <span class="p">},</span>
<a id="__codelineno-15-46" name="__codelineno-15-46" href="#__codelineno-15-46"></a>            <span class="n">error_type</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="n">error</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
<a id="__codelineno-15-47" name="__codelineno-15-47" href="#__codelineno-15-47"></a>            <span class="n">error_message</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">error</span><span class="p">),</span>
<a id="__codelineno-15-48" name="__codelineno-15-48" href="#__codelineno-15-48"></a>            <span class="n">stack_trace</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_stack_trace</span><span class="p">(</span><span class="n">error</span><span class="p">),</span>
<a id="__codelineno-15-49" name="__codelineno-15-49" href="#__codelineno-15-49"></a>            <span class="n">retry_count</span><span class="o">=</span><span class="n">retry_count</span><span class="p">,</span>
<a id="__codelineno-15-50" name="__codelineno-15-50" href="#__codelineno-15-50"></a>            <span class="n">first_failure</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">(),</span>
<a id="__codelineno-15-51" name="__codelineno-15-51" href="#__codelineno-15-51"></a>            <span class="n">last_failure</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">(),</span>
<a id="__codelineno-15-52" name="__codelineno-15-52" href="#__codelineno-15-52"></a>            <span class="n">consumer_group</span><span class="o">=</span><span class="n">consumer_group</span>
<a id="__codelineno-15-53" name="__codelineno-15-53" href="#__codelineno-15-53"></a>        <span class="p">)</span>
<a id="__codelineno-15-54" name="__codelineno-15-54" href="#__codelineno-15-54"></a>
<a id="__codelineno-15-55" name="__codelineno-15-55" href="#__codelineno-15-55"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">producer</span><span class="o">.</span><span class="n">produce</span><span class="p">(</span>
<a id="__codelineno-15-56" name="__codelineno-15-56" href="#__codelineno-15-56"></a>            <span class="n">topic</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dlq_topic</span><span class="p">,</span>
<a id="__codelineno-15-57" name="__codelineno-15-57" href="#__codelineno-15-57"></a>            <span class="n">key</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dead_letter</span><span class="o">.</span><span class="n">original_topic</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">dead_letter</span><span class="o">.</span><span class="n">original_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">encode</span><span class="p">(),</span>
<a id="__codelineno-15-58" name="__codelineno-15-58" href="#__codelineno-15-58"></a>            <span class="n">value</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span>
<a id="__codelineno-15-59" name="__codelineno-15-59" href="#__codelineno-15-59"></a>                <span class="s1">&#39;original_topic&#39;</span><span class="p">:</span> <span class="n">dead_letter</span><span class="o">.</span><span class="n">original_topic</span><span class="p">,</span>
<a id="__codelineno-15-60" name="__codelineno-15-60" href="#__codelineno-15-60"></a>                <span class="s1">&#39;original_key&#39;</span><span class="p">:</span> <span class="n">dead_letter</span><span class="o">.</span><span class="n">original_key</span><span class="p">,</span>
<a id="__codelineno-15-61" name="__codelineno-15-61" href="#__codelineno-15-61"></a>                <span class="s1">&#39;original_value&#39;</span><span class="p">:</span> <span class="n">dead_letter</span><span class="o">.</span><span class="n">original_value</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;replace&#39;</span><span class="p">),</span>
<a id="__codelineno-15-62" name="__codelineno-15-62" href="#__codelineno-15-62"></a>                <span class="s1">&#39;error_type&#39;</span><span class="p">:</span> <span class="n">dead_letter</span><span class="o">.</span><span class="n">error_type</span><span class="p">,</span>
<a id="__codelineno-15-63" name="__codelineno-15-63" href="#__codelineno-15-63"></a>                <span class="s1">&#39;error_message&#39;</span><span class="p">:</span> <span class="n">dead_letter</span><span class="o">.</span><span class="n">error_message</span><span class="p">,</span>
<a id="__codelineno-15-64" name="__codelineno-15-64" href="#__codelineno-15-64"></a>                <span class="s1">&#39;retry_count&#39;</span><span class="p">:</span> <span class="n">dead_letter</span><span class="o">.</span><span class="n">retry_count</span><span class="p">,</span>
<a id="__codelineno-15-65" name="__codelineno-15-65" href="#__codelineno-15-65"></a>                <span class="s1">&#39;first_failure&#39;</span><span class="p">:</span> <span class="n">dead_letter</span><span class="o">.</span><span class="n">first_failure</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
<a id="__codelineno-15-66" name="__codelineno-15-66" href="#__codelineno-15-66"></a>                <span class="s1">&#39;last_failure&#39;</span><span class="p">:</span> <span class="n">dead_letter</span><span class="o">.</span><span class="n">last_failure</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
<a id="__codelineno-15-67" name="__codelineno-15-67" href="#__codelineno-15-67"></a>                <span class="s1">&#39;consumer_group&#39;</span><span class="p">:</span> <span class="n">dead_letter</span><span class="o">.</span><span class="n">consumer_group</span>
<a id="__codelineno-15-68" name="__codelineno-15-68" href="#__codelineno-15-68"></a>            <span class="p">})</span><span class="o">.</span><span class="n">encode</span><span class="p">(),</span>
<a id="__codelineno-15-69" name="__codelineno-15-69" href="#__codelineno-15-69"></a>            <span class="n">headers</span><span class="o">=</span><span class="p">[</span>
<a id="__codelineno-15-70" name="__codelineno-15-70" href="#__codelineno-15-70"></a>                <span class="p">(</span><span class="s1">&#39;dlq_reason&#39;</span><span class="p">,</span> <span class="n">dead_letter</span><span class="o">.</span><span class="n">error_type</span><span class="o">.</span><span class="n">encode</span><span class="p">()),</span>
<a id="__codelineno-15-71" name="__codelineno-15-71" href="#__codelineno-15-71"></a>                <span class="p">(</span><span class="s1">&#39;original_topic&#39;</span><span class="p">,</span> <span class="n">dead_letter</span><span class="o">.</span><span class="n">original_topic</span><span class="o">.</span><span class="n">encode</span><span class="p">()),</span>
<a id="__codelineno-15-72" name="__codelineno-15-72" href="#__codelineno-15-72"></a>                <span class="p">(</span><span class="s1">&#39;retry_count&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">dead_letter</span><span class="o">.</span><span class="n">retry_count</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
<a id="__codelineno-15-73" name="__codelineno-15-73" href="#__codelineno-15-73"></a>            <span class="p">]</span>
<a id="__codelineno-15-74" name="__codelineno-15-74" href="#__codelineno-15-74"></a>        <span class="p">)</span>
<a id="__codelineno-15-75" name="__codelineno-15-75" href="#__codelineno-15-75"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">producer</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
<a id="__codelineno-15-76" name="__codelineno-15-76" href="#__codelineno-15-76"></a>
<a id="__codelineno-15-77" name="__codelineno-15-77" href="#__codelineno-15-77"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_get_stack_trace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">error</span><span class="p">:</span> <span class="ne">Exception</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<a id="__codelineno-15-78" name="__codelineno-15-78" href="#__codelineno-15-78"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Extrait la stack trace d&#39;une exception&quot;&quot;&quot;</span>
<a id="__codelineno-15-79" name="__codelineno-15-79" href="#__codelineno-15-79"></a>        <span class="kn">import</span><span class="w"> </span><span class="nn">traceback</span>
<a id="__codelineno-15-80" name="__codelineno-15-80" href="#__codelineno-15-80"></a>        <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exception</span><span class="p">(</span>
<a id="__codelineno-15-81" name="__codelineno-15-81" href="#__codelineno-15-81"></a>            <span class="nb">type</span><span class="p">(</span><span class="n">error</span><span class="p">),</span> <span class="n">error</span><span class="p">,</span> <span class="n">error</span><span class="o">.</span><span class="n">__traceback__</span>
<a id="__codelineno-15-82" name="__codelineno-15-82" href="#__codelineno-15-82"></a>        <span class="p">))</span>
<a id="__codelineno-15-83" name="__codelineno-15-83" href="#__codelineno-15-83"></a>
<a id="__codelineno-15-84" name="__codelineno-15-84" href="#__codelineno-15-84"></a>
<a id="__codelineno-15-85" name="__codelineno-15-85" href="#__codelineno-15-85"></a><span class="k">class</span><span class="w"> </span><span class="nc">ResilientConsumer</span><span class="p">:</span>
<a id="__codelineno-15-86" name="__codelineno-15-86" href="#__codelineno-15-86"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Consumer Kafka avec gestion complète de la résilience&quot;&quot;&quot;</span>
<a id="__codelineno-15-87" name="__codelineno-15-87" href="#__codelineno-15-87"></a>
<a id="__codelineno-15-88" name="__codelineno-15-88" href="#__codelineno-15-88"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-15-89" name="__codelineno-15-89" href="#__codelineno-15-89"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-15-90" name="__codelineno-15-90" href="#__codelineno-15-90"></a>        <span class="n">consumer</span><span class="p">,</span>
<a id="__codelineno-15-91" name="__codelineno-15-91" href="#__codelineno-15-91"></a>        <span class="n">handler</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span>
<a id="__codelineno-15-92" name="__codelineno-15-92" href="#__codelineno-15-92"></a>        <span class="n">retry_handler</span><span class="p">:</span> <span class="n">RetryHandler</span><span class="p">,</span>
<a id="__codelineno-15-93" name="__codelineno-15-93" href="#__codelineno-15-93"></a>        <span class="n">circuit_breaker</span><span class="p">:</span> <span class="n">CircuitBreaker</span><span class="p">,</span>
<a id="__codelineno-15-94" name="__codelineno-15-94" href="#__codelineno-15-94"></a>        <span class="n">dlq_handler</span><span class="p">:</span> <span class="n">DeadLetterHandler</span><span class="p">,</span>
<a id="__codelineno-15-95" name="__codelineno-15-95" href="#__codelineno-15-95"></a>        <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span>
<a id="__codelineno-15-96" name="__codelineno-15-96" href="#__codelineno-15-96"></a>    <span class="p">):</span>
<a id="__codelineno-15-97" name="__codelineno-15-97" href="#__codelineno-15-97"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">consumer</span> <span class="o">=</span> <span class="n">consumer</span>
<a id="__codelineno-15-98" name="__codelineno-15-98" href="#__codelineno-15-98"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">handler</span> <span class="o">=</span> <span class="n">handler</span>
<a id="__codelineno-15-99" name="__codelineno-15-99" href="#__codelineno-15-99"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">retry</span> <span class="o">=</span> <span class="n">retry_handler</span>
<a id="__codelineno-15-100" name="__codelineno-15-100" href="#__codelineno-15-100"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">circuit</span> <span class="o">=</span> <span class="n">circuit_breaker</span>
<a id="__codelineno-15-101" name="__codelineno-15-101" href="#__codelineno-15-101"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dlq</span> <span class="o">=</span> <span class="n">dlq_handler</span>
<a id="__codelineno-15-102" name="__codelineno-15-102" href="#__codelineno-15-102"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
<a id="__codelineno-15-103" name="__codelineno-15-103" href="#__codelineno-15-103"></a>
<a id="__codelineno-15-104" name="__codelineno-15-104" href="#__codelineno-15-104"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">consumer_group</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;group_id&#39;</span><span class="p">,</span> <span class="s1">&#39;default&#39;</span><span class="p">)</span>
<a id="__codelineno-15-105" name="__codelineno-15-105" href="#__codelineno-15-105"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_retry_counts</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-15-106" name="__codelineno-15-106" href="#__codelineno-15-106"></a>
<a id="__codelineno-15-107" name="__codelineno-15-107" href="#__codelineno-15-107"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">process_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
<a id="__codelineno-15-108" name="__codelineno-15-108" href="#__codelineno-15-108"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Traite un message avec toutes les protections de résilience&quot;&quot;&quot;</span>
<a id="__codelineno-15-109" name="__codelineno-15-109" href="#__codelineno-15-109"></a>
<a id="__codelineno-15-110" name="__codelineno-15-110" href="#__codelineno-15-110"></a>        <span class="n">message_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_message_id</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
<a id="__codelineno-15-111" name="__codelineno-15-111" href="#__codelineno-15-111"></a>        <span class="n">retry_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_retry_counts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">message_id</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-15-112" name="__codelineno-15-112" href="#__codelineno-15-112"></a>
<a id="__codelineno-15-113" name="__codelineno-15-113" href="#__codelineno-15-113"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-15-114" name="__codelineno-15-114" href="#__codelineno-15-114"></a>            <span class="c1"># Protection circuit breaker</span>
<a id="__codelineno-15-115" name="__codelineno-15-115" href="#__codelineno-15-115"></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">circuit</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<a id="__codelineno-15-116" name="__codelineno-15-116" href="#__codelineno-15-116"></a>                <span class="c1"># Retry avec backoff</span>
<a id="__codelineno-15-117" name="__codelineno-15-117" href="#__codelineno-15-117"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">retry</span><span class="o">.</span><span class="n">execute</span><span class="p">,</span>
<a id="__codelineno-15-118" name="__codelineno-15-118" href="#__codelineno-15-118"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">handler</span><span class="p">,</span>
<a id="__codelineno-15-119" name="__codelineno-15-119" href="#__codelineno-15-119"></a>                <span class="n">message</span>
<a id="__codelineno-15-120" name="__codelineno-15-120" href="#__codelineno-15-120"></a>            <span class="p">)</span>
<a id="__codelineno-15-121" name="__codelineno-15-121" href="#__codelineno-15-121"></a>
<a id="__codelineno-15-122" name="__codelineno-15-122" href="#__codelineno-15-122"></a>            <span class="c1"># Succès - nettoyage</span>
<a id="__codelineno-15-123" name="__codelineno-15-123" href="#__codelineno-15-123"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_retry_counts</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">message_id</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-15-124" name="__codelineno-15-124" href="#__codelineno-15-124"></a>
<a id="__codelineno-15-125" name="__codelineno-15-125" href="#__codelineno-15-125"></a>        <span class="k">except</span> <span class="n">CircuitOpenError</span><span class="p">:</span>
<a id="__codelineno-15-126" name="__codelineno-15-126" href="#__codelineno-15-126"></a>            <span class="c1"># Circuit ouvert - ne pas retenter, attendre</span>
<a id="__codelineno-15-127" name="__codelineno-15-127" href="#__codelineno-15-127"></a>            <span class="k">raise</span>
<a id="__codelineno-15-128" name="__codelineno-15-128" href="#__codelineno-15-128"></a>
<a id="__codelineno-15-129" name="__codelineno-15-129" href="#__codelineno-15-129"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-15-130" name="__codelineno-15-130" href="#__codelineno-15-130"></a>            <span class="n">retry_count</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-15-131" name="__codelineno-15-131" href="#__codelineno-15-131"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_retry_counts</span><span class="p">[</span><span class="n">message_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">retry_count</span>
<a id="__codelineno-15-132" name="__codelineno-15-132" href="#__codelineno-15-132"></a>
<a id="__codelineno-15-133" name="__codelineno-15-133" href="#__codelineno-15-133"></a>            <span class="k">if</span> <span class="n">retry_count</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_retries&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>
<a id="__codelineno-15-134" name="__codelineno-15-134" href="#__codelineno-15-134"></a>                <span class="c1"># Épuisement des retries - DLQ</span>
<a id="__codelineno-15-135" name="__codelineno-15-135" href="#__codelineno-15-135"></a>                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">dlq</span><span class="o">.</span><span class="n">send_to_dlq</span><span class="p">(</span>
<a id="__codelineno-15-136" name="__codelineno-15-136" href="#__codelineno-15-136"></a>                    <span class="n">message</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">retry_count</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">consumer_group</span>
<a id="__codelineno-15-137" name="__codelineno-15-137" href="#__codelineno-15-137"></a>                <span class="p">)</span>
<a id="__codelineno-15-138" name="__codelineno-15-138" href="#__codelineno-15-138"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_retry_counts</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">message_id</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-15-139" name="__codelineno-15-139" href="#__codelineno-15-139"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-15-140" name="__codelineno-15-140" href="#__codelineno-15-140"></a>                <span class="c1"># Relancer pour retry ultérieur</span>
<a id="__codelineno-15-141" name="__codelineno-15-141" href="#__codelineno-15-141"></a>                <span class="k">raise</span>
<a id="__codelineno-15-142" name="__codelineno-15-142" href="#__codelineno-15-142"></a>
<a id="__codelineno-15-143" name="__codelineno-15-143" href="#__codelineno-15-143"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_get_message_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-15-144" name="__codelineno-15-144" href="#__codelineno-15-144"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Génère un identifiant unique pour le message&quot;&quot;&quot;</span>
<a id="__codelineno-15-145" name="__codelineno-15-145" href="#__codelineno-15-145"></a>        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">message</span><span class="o">.</span><span class="n">topic</span><span class="p">()</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">message</span><span class="o">.</span><span class="n">partition</span><span class="p">()</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">message</span><span class="o">.</span><span class="n">offset</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
</code></pre></div>
<blockquote>
<p><strong>Note technique</strong><br />
Configurez des alertes sur la croissance de la DLQ. Un nombre croissant de messages en DLQ peut indiquer un problème systémique nécessitant une intervention, comme un changement de format incompatible ou une défaillance d'un service dépendant.</p>
</blockquote>
<hr />
<h2 id="ii96-integration-avec-les-agents-cognitifs-vertex-ai">II.9.6 Intégration avec les Agents Cognitifs Vertex AI<a class="headerlink" href="#ii96-integration-avec-les-agents-cognitifs-vertex-ai" title="Permanent link">&para;</a></h2>
<h3 id="orchestration-agent-evenement">Orchestration Agent-Événement<a class="headerlink" href="#orchestration-agent-evenement" title="Permanent link">&para;</a></h3>
<p>L'intégration des patrons architecturaux avec les agents cognitifs Vertex AI crée une synergie puissante où les agents peuvent participer aux Sagas, consommer des vues CQRS optimisées, et générer des événements traçables. Cette section détaille les patterns d'intégration spécifiques au contexte agentique.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="c1"># agents/event_aware_agent.py</span>
<a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">List</span>
<a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>
<a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">uuid</span>
<a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a>
<a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a><span class="nd">@dataclass</span>
<a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a><span class="k">class</span><span class="w"> </span><span class="nc">AgentContext</span><span class="p">:</span>
<a id="__codelineno-16-9" name="__codelineno-16-9" href="#__codelineno-16-9"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Contexte enrichi pour un agent cognitif&quot;&quot;&quot;</span>
<a id="__codelineno-16-10" name="__codelineno-16-10" href="#__codelineno-16-10"></a>    <span class="n">agent_id</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-16-11" name="__codelineno-16-11" href="#__codelineno-16-11"></a>    <span class="n">saga_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-16-12" name="__codelineno-16-12" href="#__codelineno-16-12"></a>    <span class="n">correlation_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-16-13" name="__codelineno-16-13" href="#__codelineno-16-13"></a>    <span class="n">customer_context</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-16-14" name="__codelineno-16-14" href="#__codelineno-16-14"></a>    <span class="n">conversation_history</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-16-15" name="__codelineno-16-15" href="#__codelineno-16-15"></a>
<a id="__codelineno-16-16" name="__codelineno-16-16" href="#__codelineno-16-16"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-16-17" name="__codelineno-16-17" href="#__codelineno-16-17"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">correlation_id</span><span class="p">:</span>
<a id="__codelineno-16-18" name="__codelineno-16-18" href="#__codelineno-16-18"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">correlation_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
<a id="__codelineno-16-19" name="__codelineno-16-19" href="#__codelineno-16-19"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">conversation_history</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-16-20" name="__codelineno-16-20" href="#__codelineno-16-20"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">conversation_history</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-16-21" name="__codelineno-16-21" href="#__codelineno-16-21"></a>
<a id="__codelineno-16-22" name="__codelineno-16-22" href="#__codelineno-16-22"></a>
<a id="__codelineno-16-23" name="__codelineno-16-23" href="#__codelineno-16-23"></a><span class="k">class</span><span class="w"> </span><span class="nc">EventAwareAgent</span><span class="p">:</span>
<a id="__codelineno-16-24" name="__codelineno-16-24" href="#__codelineno-16-24"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Agent cognitif intégré avec l&#39;architecture événementielle&quot;&quot;&quot;</span>
<a id="__codelineno-16-25" name="__codelineno-16-25" href="#__codelineno-16-25"></a>
<a id="__codelineno-16-26" name="__codelineno-16-26" href="#__codelineno-16-26"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-16-27" name="__codelineno-16-27" href="#__codelineno-16-27"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-16-28" name="__codelineno-16-28" href="#__codelineno-16-28"></a>        <span class="n">agent_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-16-29" name="__codelineno-16-29" href="#__codelineno-16-29"></a>        <span class="n">vertex_client</span><span class="p">,</span>
<a id="__codelineno-16-30" name="__codelineno-16-30" href="#__codelineno-16-30"></a>        <span class="n">event_publisher</span><span class="p">,</span>
<a id="__codelineno-16-31" name="__codelineno-16-31" href="#__codelineno-16-31"></a>        <span class="n">read_model_client</span><span class="p">,</span>
<a id="__codelineno-16-32" name="__codelineno-16-32" href="#__codelineno-16-32"></a>        <span class="n">saga_coordinator</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SagaCoordinator</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-16-33" name="__codelineno-16-33" href="#__codelineno-16-33"></a>    <span class="p">):</span>
<a id="__codelineno-16-34" name="__codelineno-16-34" href="#__codelineno-16-34"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">agent_id</span> <span class="o">=</span> <span class="n">agent_id</span>
<a id="__codelineno-16-35" name="__codelineno-16-35" href="#__codelineno-16-35"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">vertex</span> <span class="o">=</span> <span class="n">vertex_client</span>
<a id="__codelineno-16-36" name="__codelineno-16-36" href="#__codelineno-16-36"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">publisher</span> <span class="o">=</span> <span class="n">event_publisher</span>
<a id="__codelineno-16-37" name="__codelineno-16-37" href="#__codelineno-16-37"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">read_model</span> <span class="o">=</span> <span class="n">read_model_client</span>
<a id="__codelineno-16-38" name="__codelineno-16-38" href="#__codelineno-16-38"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">saga_coordinator</span> <span class="o">=</span> <span class="n">saga_coordinator</span>
<a id="__codelineno-16-39" name="__codelineno-16-39" href="#__codelineno-16-39"></a>
<a id="__codelineno-16-40" name="__codelineno-16-40" href="#__codelineno-16-40"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span> <span class="o">=</span> <span class="s2">&quot;gemini-1.5-pro&quot;</span>
<a id="__codelineno-16-41" name="__codelineno-16-41" href="#__codelineno-16-41"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">system_instruction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_system_instruction</span><span class="p">()</span>
<a id="__codelineno-16-42" name="__codelineno-16-42" href="#__codelineno-16-42"></a>
<a id="__codelineno-16-43" name="__codelineno-16-43" href="#__codelineno-16-43"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_build_system_instruction</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-16-44" name="__codelineno-16-44" href="#__codelineno-16-44"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Construit les instructions système pour l&#39;agent&quot;&quot;&quot;</span>
<a id="__codelineno-16-45" name="__codelineno-16-45" href="#__codelineno-16-45"></a>        <span class="k">return</span> <span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-16-46" name="__codelineno-16-46" href="#__codelineno-16-46"></a><span class="s2">        Tu es un agent spécialisé dans le traitement des demandes clients.</span>
<a id="__codelineno-16-47" name="__codelineno-16-47" href="#__codelineno-16-47"></a><span class="s2">        Tu dois toujours:</span>
<a id="__codelineno-16-48" name="__codelineno-16-48" href="#__codelineno-16-48"></a><span class="s2">        1. Utiliser le contexte client fourni pour personnaliser tes réponses</span>
<a id="__codelineno-16-49" name="__codelineno-16-49" href="#__codelineno-16-49"></a><span class="s2">        2. Signaler clairement quand tu as besoin d&#39;informations supplémentaires</span>
<a id="__codelineno-16-50" name="__codelineno-16-50" href="#__codelineno-16-50"></a><span class="s2">        3. Proposer des actions concrètes et traçables</span>
<a id="__codelineno-16-51" name="__codelineno-16-51" href="#__codelineno-16-51"></a><span class="s2">        4. Respecter les garde-fous définis dans la constitution</span>
<a id="__codelineno-16-52" name="__codelineno-16-52" href="#__codelineno-16-52"></a><span class="s2">        &quot;&quot;&quot;</span>
<a id="__codelineno-16-53" name="__codelineno-16-53" href="#__codelineno-16-53"></a>
<a id="__codelineno-16-54" name="__codelineno-16-54" href="#__codelineno-16-54"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">process_request</span><span class="p">(</span>
<a id="__codelineno-16-55" name="__codelineno-16-55" href="#__codelineno-16-55"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-16-56" name="__codelineno-16-56" href="#__codelineno-16-56"></a>        <span class="n">request</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-16-57" name="__codelineno-16-57" href="#__codelineno-16-57"></a>        <span class="n">context</span><span class="p">:</span> <span class="n">AgentContext</span>
<a id="__codelineno-16-58" name="__codelineno-16-58" href="#__codelineno-16-58"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-16-59" name="__codelineno-16-59" href="#__codelineno-16-59"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Traite une requête avec contexte complet&quot;&quot;&quot;</span>
<a id="__codelineno-16-60" name="__codelineno-16-60" href="#__codelineno-16-60"></a>
<a id="__codelineno-16-61" name="__codelineno-16-61" href="#__codelineno-16-61"></a>        <span class="c1"># Enrichissement du contexte depuis les vues CQRS</span>
<a id="__codelineno-16-62" name="__codelineno-16-62" href="#__codelineno-16-62"></a>        <span class="n">enriched_context</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_enrich_context</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
<a id="__codelineno-16-63" name="__codelineno-16-63" href="#__codelineno-16-63"></a>
<a id="__codelineno-16-64" name="__codelineno-16-64" href="#__codelineno-16-64"></a>        <span class="c1"># Publication de l&#39;événement de début de traitement</span>
<a id="__codelineno-16-65" name="__codelineno-16-65" href="#__codelineno-16-65"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_publish_event</span><span class="p">(</span>
<a id="__codelineno-16-66" name="__codelineno-16-66" href="#__codelineno-16-66"></a>            <span class="n">event_type</span><span class="o">=</span><span class="s2">&quot;agent.processing.started&quot;</span><span class="p">,</span>
<a id="__codelineno-16-67" name="__codelineno-16-67" href="#__codelineno-16-67"></a>            <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">,</span>
<a id="__codelineno-16-68" name="__codelineno-16-68" href="#__codelineno-16-68"></a>            <span class="n">payload</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-16-69" name="__codelineno-16-69" href="#__codelineno-16-69"></a>                <span class="s1">&#39;request&#39;</span><span class="p">:</span> <span class="n">request</span><span class="p">,</span>
<a id="__codelineno-16-70" name="__codelineno-16-70" href="#__codelineno-16-70"></a>                <span class="s1">&#39;customer_id&#39;</span><span class="p">:</span> <span class="n">enriched_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;customer_id&#39;</span><span class="p">)</span>
<a id="__codelineno-16-71" name="__codelineno-16-71" href="#__codelineno-16-71"></a>            <span class="p">}</span>
<a id="__codelineno-16-72" name="__codelineno-16-72" href="#__codelineno-16-72"></a>        <span class="p">)</span>
<a id="__codelineno-16-73" name="__codelineno-16-73" href="#__codelineno-16-73"></a>
<a id="__codelineno-16-74" name="__codelineno-16-74" href="#__codelineno-16-74"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-16-75" name="__codelineno-16-75" href="#__codelineno-16-75"></a>            <span class="c1"># Appel au modèle Vertex AI</span>
<a id="__codelineno-16-76" name="__codelineno-16-76" href="#__codelineno-16-76"></a>            <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_invoke_model</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">enriched_context</span><span class="p">)</span>
<a id="__codelineno-16-77" name="__codelineno-16-77" href="#__codelineno-16-77"></a>
<a id="__codelineno-16-78" name="__codelineno-16-78" href="#__codelineno-16-78"></a>            <span class="c1"># Extraction des actions proposées</span>
<a id="__codelineno-16-79" name="__codelineno-16-79" href="#__codelineno-16-79"></a>            <span class="n">actions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_actions</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
<a id="__codelineno-16-80" name="__codelineno-16-80" href="#__codelineno-16-80"></a>
<a id="__codelineno-16-81" name="__codelineno-16-81" href="#__codelineno-16-81"></a>            <span class="c1"># Publication de l&#39;événement de succès</span>
<a id="__codelineno-16-82" name="__codelineno-16-82" href="#__codelineno-16-82"></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_publish_event</span><span class="p">(</span>
<a id="__codelineno-16-83" name="__codelineno-16-83" href="#__codelineno-16-83"></a>                <span class="n">event_type</span><span class="o">=</span><span class="s2">&quot;agent.processing.completed&quot;</span><span class="p">,</span>
<a id="__codelineno-16-84" name="__codelineno-16-84" href="#__codelineno-16-84"></a>                <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">,</span>
<a id="__codelineno-16-85" name="__codelineno-16-85" href="#__codelineno-16-85"></a>                <span class="n">payload</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-16-86" name="__codelineno-16-86" href="#__codelineno-16-86"></a>                    <span class="s1">&#39;response_summary&#39;</span><span class="p">:</span> <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;summary&#39;</span><span class="p">),</span>
<a id="__codelineno-16-87" name="__codelineno-16-87" href="#__codelineno-16-87"></a>                    <span class="s1">&#39;actions_proposed&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">actions</span><span class="p">),</span>
<a id="__codelineno-16-88" name="__codelineno-16-88" href="#__codelineno-16-88"></a>                    <span class="s1">&#39;confidence_score&#39;</span><span class="p">:</span> <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;confidence&#39;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
<a id="__codelineno-16-89" name="__codelineno-16-89" href="#__codelineno-16-89"></a>                <span class="p">}</span>
<a id="__codelineno-16-90" name="__codelineno-16-90" href="#__codelineno-16-90"></a>            <span class="p">)</span>
<a id="__codelineno-16-91" name="__codelineno-16-91" href="#__codelineno-16-91"></a>
<a id="__codelineno-16-92" name="__codelineno-16-92" href="#__codelineno-16-92"></a>            <span class="c1"># Si dans une Saga, progression de l&#39;état</span>
<a id="__codelineno-16-93" name="__codelineno-16-93" href="#__codelineno-16-93"></a>            <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">saga_id</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">saga_coordinator</span><span class="p">:</span>
<a id="__codelineno-16-94" name="__codelineno-16-94" href="#__codelineno-16-94"></a>                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_progress_saga</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">actions</span><span class="p">)</span>
<a id="__codelineno-16-95" name="__codelineno-16-95" href="#__codelineno-16-95"></a>
<a id="__codelineno-16-96" name="__codelineno-16-96" href="#__codelineno-16-96"></a>            <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-16-97" name="__codelineno-16-97" href="#__codelineno-16-97"></a>                <span class="s1">&#39;response&#39;</span><span class="p">:</span> <span class="n">response</span><span class="p">,</span>
<a id="__codelineno-16-98" name="__codelineno-16-98" href="#__codelineno-16-98"></a>                <span class="s1">&#39;actions&#39;</span><span class="p">:</span> <span class="n">actions</span><span class="p">,</span>
<a id="__codelineno-16-99" name="__codelineno-16-99" href="#__codelineno-16-99"></a>                <span class="s1">&#39;context&#39;</span><span class="p">:</span> <span class="n">enriched_context</span><span class="p">,</span>
<a id="__codelineno-16-100" name="__codelineno-16-100" href="#__codelineno-16-100"></a>                <span class="s1">&#39;trace_id&#39;</span><span class="p">:</span> <span class="n">context</span><span class="o">.</span><span class="n">correlation_id</span>
<a id="__codelineno-16-101" name="__codelineno-16-101" href="#__codelineno-16-101"></a>            <span class="p">}</span>
<a id="__codelineno-16-102" name="__codelineno-16-102" href="#__codelineno-16-102"></a>
<a id="__codelineno-16-103" name="__codelineno-16-103" href="#__codelineno-16-103"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-16-104" name="__codelineno-16-104" href="#__codelineno-16-104"></a>            <span class="c1"># Publication de l&#39;événement d&#39;échec</span>
<a id="__codelineno-16-105" name="__codelineno-16-105" href="#__codelineno-16-105"></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_publish_event</span><span class="p">(</span>
<a id="__codelineno-16-106" name="__codelineno-16-106" href="#__codelineno-16-106"></a>                <span class="n">event_type</span><span class="o">=</span><span class="s2">&quot;agent.processing.failed&quot;</span><span class="p">,</span>
<a id="__codelineno-16-107" name="__codelineno-16-107" href="#__codelineno-16-107"></a>                <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">,</span>
<a id="__codelineno-16-108" name="__codelineno-16-108" href="#__codelineno-16-108"></a>                <span class="n">payload</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-16-109" name="__codelineno-16-109" href="#__codelineno-16-109"></a>                    <span class="s1">&#39;error_type&#39;</span><span class="p">:</span> <span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
<a id="__codelineno-16-110" name="__codelineno-16-110" href="#__codelineno-16-110"></a>                    <span class="s1">&#39;error_message&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
<a id="__codelineno-16-111" name="__codelineno-16-111" href="#__codelineno-16-111"></a>                <span class="p">}</span>
<a id="__codelineno-16-112" name="__codelineno-16-112" href="#__codelineno-16-112"></a>            <span class="p">)</span>
<a id="__codelineno-16-113" name="__codelineno-16-113" href="#__codelineno-16-113"></a>            <span class="k">raise</span>
<a id="__codelineno-16-114" name="__codelineno-16-114" href="#__codelineno-16-114"></a>
<a id="__codelineno-16-115" name="__codelineno-16-115" href="#__codelineno-16-115"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_enrich_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">AgentContext</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-16-116" name="__codelineno-16-116" href="#__codelineno-16-116"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Enrichit le contexte avec les données des vues CQRS&quot;&quot;&quot;</span>
<a id="__codelineno-16-117" name="__codelineno-16-117" href="#__codelineno-16-117"></a>
<a id="__codelineno-16-118" name="__codelineno-16-118" href="#__codelineno-16-118"></a>        <span class="n">enriched</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-16-119" name="__codelineno-16-119" href="#__codelineno-16-119"></a>            <span class="s1">&#39;agent_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent_id</span><span class="p">,</span>
<a id="__codelineno-16-120" name="__codelineno-16-120" href="#__codelineno-16-120"></a>            <span class="s1">&#39;correlation_id&#39;</span><span class="p">:</span> <span class="n">context</span><span class="o">.</span><span class="n">correlation_id</span><span class="p">,</span>
<a id="__codelineno-16-121" name="__codelineno-16-121" href="#__codelineno-16-121"></a>            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
<a id="__codelineno-16-122" name="__codelineno-16-122" href="#__codelineno-16-122"></a>        <span class="p">}</span>
<a id="__codelineno-16-123" name="__codelineno-16-123" href="#__codelineno-16-123"></a>
<a id="__codelineno-16-124" name="__codelineno-16-124" href="#__codelineno-16-124"></a>        <span class="c1"># Chargement de la vue 360° client si disponible</span>
<a id="__codelineno-16-125" name="__codelineno-16-125" href="#__codelineno-16-125"></a>        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">customer_context</span> <span class="ow">and</span> <span class="s1">&#39;customer_id&#39;</span> <span class="ow">in</span> <span class="n">context</span><span class="o">.</span><span class="n">customer_context</span><span class="p">:</span>
<a id="__codelineno-16-126" name="__codelineno-16-126" href="#__codelineno-16-126"></a>            <span class="n">customer_id</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">customer_context</span><span class="p">[</span><span class="s1">&#39;customer_id&#39;</span><span class="p">]</span>
<a id="__codelineno-16-127" name="__codelineno-16-127" href="#__codelineno-16-127"></a>            <span class="n">customer_360</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_model</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
<a id="__codelineno-16-128" name="__codelineno-16-128" href="#__codelineno-16-128"></a>                <span class="s1">&#39;customer_360&#39;</span><span class="p">,</span>
<a id="__codelineno-16-129" name="__codelineno-16-129" href="#__codelineno-16-129"></a>                <span class="n">customer_id</span>
<a id="__codelineno-16-130" name="__codelineno-16-130" href="#__codelineno-16-130"></a>            <span class="p">)</span>
<a id="__codelineno-16-131" name="__codelineno-16-131" href="#__codelineno-16-131"></a>
<a id="__codelineno-16-132" name="__codelineno-16-132" href="#__codelineno-16-132"></a>            <span class="k">if</span> <span class="n">customer_360</span><span class="p">:</span>
<a id="__codelineno-16-133" name="__codelineno-16-133" href="#__codelineno-16-133"></a>                <span class="n">enriched</span><span class="p">[</span><span class="s1">&#39;customer&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-16-134" name="__codelineno-16-134" href="#__codelineno-16-134"></a>                    <span class="s1">&#39;profile&#39;</span><span class="p">:</span> <span class="n">customer_360</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;profile&#39;</span><span class="p">,</span> <span class="p">{}),</span>
<a id="__codelineno-16-135" name="__codelineno-16-135" href="#__codelineno-16-135"></a>                    <span class="s1">&#39;sentiment_trend&#39;</span><span class="p">:</span> <span class="n">customer_360</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;interactions&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sentiment_trend&#39;</span><span class="p">),</span>
<a id="__codelineno-16-136" name="__codelineno-16-136" href="#__codelineno-16-136"></a>                    <span class="s1">&#39;open_tickets&#39;</span><span class="p">:</span> <span class="n">customer_360</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;support&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;open_tickets&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<a id="__codelineno-16-137" name="__codelineno-16-137" href="#__codelineno-16-137"></a>                    <span class="s1">&#39;total_orders&#39;</span><span class="p">:</span> <span class="n">customer_360</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;orders&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;total&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<a id="__codelineno-16-138" name="__codelineno-16-138" href="#__codelineno-16-138"></a>                    <span class="s1">&#39;context_summary&#39;</span><span class="p">:</span> <span class="n">customer_360</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;context&#39;</span><span class="p">,</span> <span class="p">{})</span>
<a id="__codelineno-16-139" name="__codelineno-16-139" href="#__codelineno-16-139"></a>                <span class="p">}</span>
<a id="__codelineno-16-140" name="__codelineno-16-140" href="#__codelineno-16-140"></a>
<a id="__codelineno-16-141" name="__codelineno-16-141" href="#__codelineno-16-141"></a>        <span class="c1"># Contexte de Saga si applicable</span>
<a id="__codelineno-16-142" name="__codelineno-16-142" href="#__codelineno-16-142"></a>        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">saga_id</span><span class="p">:</span>
<a id="__codelineno-16-143" name="__codelineno-16-143" href="#__codelineno-16-143"></a>            <span class="n">enriched</span><span class="p">[</span><span class="s1">&#39;saga&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-16-144" name="__codelineno-16-144" href="#__codelineno-16-144"></a>                <span class="s1">&#39;saga_id&#39;</span><span class="p">:</span> <span class="n">context</span><span class="o">.</span><span class="n">saga_id</span><span class="p">,</span>
<a id="__codelineno-16-145" name="__codelineno-16-145" href="#__codelineno-16-145"></a>                <span class="s1">&#39;in_transaction&#39;</span><span class="p">:</span> <span class="kc">True</span>
<a id="__codelineno-16-146" name="__codelineno-16-146" href="#__codelineno-16-146"></a>            <span class="p">}</span>
<a id="__codelineno-16-147" name="__codelineno-16-147" href="#__codelineno-16-147"></a>
<a id="__codelineno-16-148" name="__codelineno-16-148" href="#__codelineno-16-148"></a>        <span class="k">return</span> <span class="n">enriched</span>
<a id="__codelineno-16-149" name="__codelineno-16-149" href="#__codelineno-16-149"></a>
<a id="__codelineno-16-150" name="__codelineno-16-150" href="#__codelineno-16-150"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_invoke_model</span><span class="p">(</span>
<a id="__codelineno-16-151" name="__codelineno-16-151" href="#__codelineno-16-151"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-16-152" name="__codelineno-16-152" href="#__codelineno-16-152"></a>        <span class="n">request</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-16-153" name="__codelineno-16-153" href="#__codelineno-16-153"></a>        <span class="n">context</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
<a id="__codelineno-16-154" name="__codelineno-16-154" href="#__codelineno-16-154"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-16-155" name="__codelineno-16-155" href="#__codelineno-16-155"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Invoque le modèle Vertex AI avec le contexte&quot;&quot;&quot;</span>
<a id="__codelineno-16-156" name="__codelineno-16-156" href="#__codelineno-16-156"></a>
<a id="__codelineno-16-157" name="__codelineno-16-157" href="#__codelineno-16-157"></a>        <span class="c1"># Construction du prompt enrichi</span>
<a id="__codelineno-16-158" name="__codelineno-16-158" href="#__codelineno-16-158"></a>        <span class="n">prompt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_prompt</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
<a id="__codelineno-16-159" name="__codelineno-16-159" href="#__codelineno-16-159"></a>
<a id="__codelineno-16-160" name="__codelineno-16-160" href="#__codelineno-16-160"></a>        <span class="c1"># Appel à Vertex AI</span>
<a id="__codelineno-16-161" name="__codelineno-16-161" href="#__codelineno-16-161"></a>        <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">vertex</span><span class="o">.</span><span class="n">generate_content</span><span class="p">(</span>
<a id="__codelineno-16-162" name="__codelineno-16-162" href="#__codelineno-16-162"></a>            <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="p">,</span>
<a id="__codelineno-16-163" name="__codelineno-16-163" href="#__codelineno-16-163"></a>            <span class="n">contents</span><span class="o">=</span><span class="p">[</span>
<a id="__codelineno-16-164" name="__codelineno-16-164" href="#__codelineno-16-164"></a>                <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;parts&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">prompt</span><span class="p">}]}</span>
<a id="__codelineno-16-165" name="__codelineno-16-165" href="#__codelineno-16-165"></a>            <span class="p">],</span>
<a id="__codelineno-16-166" name="__codelineno-16-166" href="#__codelineno-16-166"></a>            <span class="n">generation_config</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-16-167" name="__codelineno-16-167" href="#__codelineno-16-167"></a>                <span class="s2">&quot;temperature&quot;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span>
<a id="__codelineno-16-168" name="__codelineno-16-168" href="#__codelineno-16-168"></a>                <span class="s2">&quot;max_output_tokens&quot;</span><span class="p">:</span> <span class="mi">2048</span>
<a id="__codelineno-16-169" name="__codelineno-16-169" href="#__codelineno-16-169"></a>            <span class="p">},</span>
<a id="__codelineno-16-170" name="__codelineno-16-170" href="#__codelineno-16-170"></a>            <span class="n">system_instruction</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">system_instruction</span>
<a id="__codelineno-16-171" name="__codelineno-16-171" href="#__codelineno-16-171"></a>        <span class="p">)</span>
<a id="__codelineno-16-172" name="__codelineno-16-172" href="#__codelineno-16-172"></a>
<a id="__codelineno-16-173" name="__codelineno-16-173" href="#__codelineno-16-173"></a>        <span class="c1"># Parsing de la réponse</span>
<a id="__codelineno-16-174" name="__codelineno-16-174" href="#__codelineno-16-174"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_response</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
<a id="__codelineno-16-175" name="__codelineno-16-175" href="#__codelineno-16-175"></a>
<a id="__codelineno-16-176" name="__codelineno-16-176" href="#__codelineno-16-176"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_build_prompt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-16-177" name="__codelineno-16-177" href="#__codelineno-16-177"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Construit le prompt avec le contexte&quot;&quot;&quot;</span>
<a id="__codelineno-16-178" name="__codelineno-16-178" href="#__codelineno-16-178"></a>
<a id="__codelineno-16-179" name="__codelineno-16-179" href="#__codelineno-16-179"></a>        <span class="n">prompt_parts</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;Requête: </span><span class="si">{</span><span class="n">request</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">]</span>
<a id="__codelineno-16-180" name="__codelineno-16-180" href="#__codelineno-16-180"></a>
<a id="__codelineno-16-181" name="__codelineno-16-181" href="#__codelineno-16-181"></a>        <span class="k">if</span> <span class="s1">&#39;customer&#39;</span> <span class="ow">in</span> <span class="n">context</span><span class="p">:</span>
<a id="__codelineno-16-182" name="__codelineno-16-182" href="#__codelineno-16-182"></a>            <span class="n">customer</span> <span class="o">=</span> <span class="n">context</span><span class="p">[</span><span class="s1">&#39;customer&#39;</span><span class="p">]</span>
<a id="__codelineno-16-183" name="__codelineno-16-183" href="#__codelineno-16-183"></a>            <span class="n">prompt_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-16-184" name="__codelineno-16-184" href="#__codelineno-16-184"></a><span class="s2">Contexte client:</span>
<a id="__codelineno-16-185" name="__codelineno-16-185" href="#__codelineno-16-185"></a><span class="s2">- Tendance de sentiment: </span><span class="si">{</span><span class="n">customer</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sentiment_trend&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;inconnu&#39;</span><span class="p">)</span><span class="si">}</span>
<a id="__codelineno-16-186" name="__codelineno-16-186" href="#__codelineno-16-186"></a><span class="s2">- Tickets ouverts: </span><span class="si">{</span><span class="n">customer</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;open_tickets&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span>
<a id="__codelineno-16-187" name="__codelineno-16-187" href="#__codelineno-16-187"></a><span class="s2">- Nombre de commandes: </span><span class="si">{</span><span class="n">customer</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;total_orders&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span>
<a id="__codelineno-16-188" name="__codelineno-16-188" href="#__codelineno-16-188"></a><span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-16-189" name="__codelineno-16-189" href="#__codelineno-16-189"></a>
<a id="__codelineno-16-190" name="__codelineno-16-190" href="#__codelineno-16-190"></a>        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;saga&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;in_transaction&#39;</span><span class="p">):</span>
<a id="__codelineno-16-191" name="__codelineno-16-191" href="#__codelineno-16-191"></a>            <span class="n">prompt_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-16-192" name="__codelineno-16-192" href="#__codelineno-16-192"></a><span class="s2">Note: Cette interaction fait partie d&#39;une transaction en cours.</span>
<a id="__codelineno-16-193" name="__codelineno-16-193" href="#__codelineno-16-193"></a><span class="s2">Assure-toi que tes recommandations sont réversibles si nécessaire.</span>
<a id="__codelineno-16-194" name="__codelineno-16-194" href="#__codelineno-16-194"></a><span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-16-195" name="__codelineno-16-195" href="#__codelineno-16-195"></a>
<a id="__codelineno-16-196" name="__codelineno-16-196" href="#__codelineno-16-196"></a>        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">prompt_parts</span><span class="p">)</span>
<a id="__codelineno-16-197" name="__codelineno-16-197" href="#__codelineno-16-197"></a>
<a id="__codelineno-16-198" name="__codelineno-16-198" href="#__codelineno-16-198"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_extract_actions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
<a id="__codelineno-16-199" name="__codelineno-16-199" href="#__codelineno-16-199"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Extrait les actions proposées de la réponse&quot;&quot;&quot;</span>
<a id="__codelineno-16-200" name="__codelineno-16-200" href="#__codelineno-16-200"></a>
<a id="__codelineno-16-201" name="__codelineno-16-201" href="#__codelineno-16-201"></a>        <span class="n">actions</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-16-202" name="__codelineno-16-202" href="#__codelineno-16-202"></a>
<a id="__codelineno-16-203" name="__codelineno-16-203" href="#__codelineno-16-203"></a>        <span class="k">if</span> <span class="s1">&#39;proposed_actions&#39;</span> <span class="ow">in</span> <span class="n">response</span><span class="p">:</span>
<a id="__codelineno-16-204" name="__codelineno-16-204" href="#__codelineno-16-204"></a>            <span class="k">for</span> <span class="n">action</span> <span class="ow">in</span> <span class="n">response</span><span class="p">[</span><span class="s1">&#39;proposed_actions&#39;</span><span class="p">]:</span>
<a id="__codelineno-16-205" name="__codelineno-16-205" href="#__codelineno-16-205"></a>                <span class="n">actions</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
<a id="__codelineno-16-206" name="__codelineno-16-206" href="#__codelineno-16-206"></a>                    <span class="s1">&#39;action_id&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()),</span>
<a id="__codelineno-16-207" name="__codelineno-16-207" href="#__codelineno-16-207"></a>                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="n">action</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">),</span>
<a id="__codelineno-16-208" name="__codelineno-16-208" href="#__codelineno-16-208"></a>                    <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="n">action</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">),</span>
<a id="__codelineno-16-209" name="__codelineno-16-209" href="#__codelineno-16-209"></a>                    <span class="s1">&#39;requires_approval&#39;</span><span class="p">:</span> <span class="n">action</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;requires_approval&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-16-210" name="__codelineno-16-210" href="#__codelineno-16-210"></a>                    <span class="s1">&#39;reversible&#39;</span><span class="p">:</span> <span class="n">action</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;reversible&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-16-211" name="__codelineno-16-211" href="#__codelineno-16-211"></a>                <span class="p">})</span>
<a id="__codelineno-16-212" name="__codelineno-16-212" href="#__codelineno-16-212"></a>
<a id="__codelineno-16-213" name="__codelineno-16-213" href="#__codelineno-16-213"></a>        <span class="k">return</span> <span class="n">actions</span>
<a id="__codelineno-16-214" name="__codelineno-16-214" href="#__codelineno-16-214"></a>
<a id="__codelineno-16-215" name="__codelineno-16-215" href="#__codelineno-16-215"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_publish_event</span><span class="p">(</span>
<a id="__codelineno-16-216" name="__codelineno-16-216" href="#__codelineno-16-216"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-16-217" name="__codelineno-16-217" href="#__codelineno-16-217"></a>        <span class="n">event_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-16-218" name="__codelineno-16-218" href="#__codelineno-16-218"></a>        <span class="n">context</span><span class="p">:</span> <span class="n">AgentContext</span><span class="p">,</span>
<a id="__codelineno-16-219" name="__codelineno-16-219" href="#__codelineno-16-219"></a>        <span class="n">payload</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
<a id="__codelineno-16-220" name="__codelineno-16-220" href="#__codelineno-16-220"></a>    <span class="p">):</span>
<a id="__codelineno-16-221" name="__codelineno-16-221" href="#__codelineno-16-221"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Publie un événement sur le backbone&quot;&quot;&quot;</span>
<a id="__codelineno-16-222" name="__codelineno-16-222" href="#__codelineno-16-222"></a>
<a id="__codelineno-16-223" name="__codelineno-16-223" href="#__codelineno-16-223"></a>        <span class="n">event</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-16-224" name="__codelineno-16-224" href="#__codelineno-16-224"></a>            <span class="s1">&#39;event_id&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()),</span>
<a id="__codelineno-16-225" name="__codelineno-16-225" href="#__codelineno-16-225"></a>            <span class="s1">&#39;event_type&#39;</span><span class="p">:</span> <span class="n">event_type</span><span class="p">,</span>
<a id="__codelineno-16-226" name="__codelineno-16-226" href="#__codelineno-16-226"></a>            <span class="s1">&#39;agent_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent_id</span><span class="p">,</span>
<a id="__codelineno-16-227" name="__codelineno-16-227" href="#__codelineno-16-227"></a>            <span class="s1">&#39;correlation_id&#39;</span><span class="p">:</span> <span class="n">context</span><span class="o">.</span><span class="n">correlation_id</span><span class="p">,</span>
<a id="__codelineno-16-228" name="__codelineno-16-228" href="#__codelineno-16-228"></a>            <span class="s1">&#39;saga_id&#39;</span><span class="p">:</span> <span class="n">context</span><span class="o">.</span><span class="n">saga_id</span><span class="p">,</span>
<a id="__codelineno-16-229" name="__codelineno-16-229" href="#__codelineno-16-229"></a>            <span class="s1">&#39;payload&#39;</span><span class="p">:</span> <span class="n">payload</span><span class="p">,</span>
<a id="__codelineno-16-230" name="__codelineno-16-230" href="#__codelineno-16-230"></a>            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
<a id="__codelineno-16-231" name="__codelineno-16-231" href="#__codelineno-16-231"></a>        <span class="p">}</span>
<a id="__codelineno-16-232" name="__codelineno-16-232" href="#__codelineno-16-232"></a>
<a id="__codelineno-16-233" name="__codelineno-16-233" href="#__codelineno-16-233"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">publisher</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="s1">&#39;agent.events&#39;</span><span class="p">,</span> <span class="n">event</span><span class="p">)</span>
<a id="__codelineno-16-234" name="__codelineno-16-234" href="#__codelineno-16-234"></a>
<a id="__codelineno-16-235" name="__codelineno-16-235" href="#__codelineno-16-235"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_progress_saga</span><span class="p">(</span>
<a id="__codelineno-16-236" name="__codelineno-16-236" href="#__codelineno-16-236"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-16-237" name="__codelineno-16-237" href="#__codelineno-16-237"></a>        <span class="n">context</span><span class="p">:</span> <span class="n">AgentContext</span><span class="p">,</span>
<a id="__codelineno-16-238" name="__codelineno-16-238" href="#__codelineno-16-238"></a>        <span class="n">actions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span>
<a id="__codelineno-16-239" name="__codelineno-16-239" href="#__codelineno-16-239"></a>    <span class="p">):</span>
<a id="__codelineno-16-240" name="__codelineno-16-240" href="#__codelineno-16-240"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Progresse l&#39;état de la Saga si applicable&quot;&quot;&quot;</span>
<a id="__codelineno-16-241" name="__codelineno-16-241" href="#__codelineno-16-241"></a>
<a id="__codelineno-16-242" name="__codelineno-16-242" href="#__codelineno-16-242"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">saga_coordinator</span><span class="p">:</span>
<a id="__codelineno-16-243" name="__codelineno-16-243" href="#__codelineno-16-243"></a>            <span class="k">return</span>
<a id="__codelineno-16-244" name="__codelineno-16-244" href="#__codelineno-16-244"></a>
<a id="__codelineno-16-245" name="__codelineno-16-245" href="#__codelineno-16-245"></a>        <span class="c1"># Détermination de l&#39;événement de progression</span>
<a id="__codelineno-16-246" name="__codelineno-16-246" href="#__codelineno-16-246"></a>        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;requires_approval&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">actions</span><span class="p">):</span>
<a id="__codelineno-16-247" name="__codelineno-16-247" href="#__codelineno-16-247"></a>            <span class="n">event_type</span> <span class="o">=</span> <span class="s2">&quot;saga.step.pending_approval&quot;</span>
<a id="__codelineno-16-248" name="__codelineno-16-248" href="#__codelineno-16-248"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-16-249" name="__codelineno-16-249" href="#__codelineno-16-249"></a>            <span class="n">event_type</span> <span class="o">=</span> <span class="s2">&quot;saga.step.completed&quot;</span>
<a id="__codelineno-16-250" name="__codelineno-16-250" href="#__codelineno-16-250"></a>
<a id="__codelineno-16-251" name="__codelineno-16-251" href="#__codelineno-16-251"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">saga_coordinator</span><span class="o">.</span><span class="n">progress</span><span class="p">(</span>
<a id="__codelineno-16-252" name="__codelineno-16-252" href="#__codelineno-16-252"></a>            <span class="n">saga_id</span><span class="o">=</span><span class="n">context</span><span class="o">.</span><span class="n">saga_id</span><span class="p">,</span>
<a id="__codelineno-16-253" name="__codelineno-16-253" href="#__codelineno-16-253"></a>            <span class="n">step</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;agent.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">agent_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
<a id="__codelineno-16-254" name="__codelineno-16-254" href="#__codelineno-16-254"></a>            <span class="n">event_type</span><span class="o">=</span><span class="n">event_type</span><span class="p">,</span>
<a id="__codelineno-16-255" name="__codelineno-16-255" href="#__codelineno-16-255"></a>            <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;actions&#39;</span><span class="p">:</span> <span class="n">actions</span><span class="p">}</span>
<a id="__codelineno-16-256" name="__codelineno-16-256" href="#__codelineno-16-256"></a>        <span class="p">)</span>
<a id="__codelineno-16-257" name="__codelineno-16-257" href="#__codelineno-16-257"></a>
<a id="__codelineno-16-258" name="__codelineno-16-258" href="#__codelineno-16-258"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_parse_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vertex_response</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-16-259" name="__codelineno-16-259" href="#__codelineno-16-259"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse la réponse Vertex AI&quot;&quot;&quot;</span>
<a id="__codelineno-16-260" name="__codelineno-16-260" href="#__codelineno-16-260"></a>
<a id="__codelineno-16-261" name="__codelineno-16-261" href="#__codelineno-16-261"></a>        <span class="n">text</span> <span class="o">=</span> <span class="n">vertex_response</span><span class="o">.</span><span class="n">candidates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span>
<a id="__codelineno-16-262" name="__codelineno-16-262" href="#__codelineno-16-262"></a>
<a id="__codelineno-16-263" name="__codelineno-16-263" href="#__codelineno-16-263"></a>        <span class="c1"># Extraction structurée (simplifié)</span>
<a id="__codelineno-16-264" name="__codelineno-16-264" href="#__codelineno-16-264"></a>        <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-16-265" name="__codelineno-16-265" href="#__codelineno-16-265"></a>            <span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="n">text</span><span class="p">,</span>
<a id="__codelineno-16-266" name="__codelineno-16-266" href="#__codelineno-16-266"></a>            <span class="s1">&#39;summary&#39;</span><span class="p">:</span> <span class="n">text</span><span class="p">[:</span><span class="mi">200</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">200</span> <span class="k">else</span> <span class="n">text</span><span class="p">,</span>
<a id="__codelineno-16-267" name="__codelineno-16-267" href="#__codelineno-16-267"></a>            <span class="s1">&#39;confidence&#39;</span><span class="p">:</span> <span class="mf">0.85</span><span class="p">,</span>  <span class="c1"># À calculer selon le contexte</span>
<a id="__codelineno-16-268" name="__codelineno-16-268" href="#__codelineno-16-268"></a>            <span class="s1">&#39;proposed_actions&#39;</span><span class="p">:</span> <span class="p">[]</span>  <span class="c1"># À extraire du texte</span>
<a id="__codelineno-16-269" name="__codelineno-16-269" href="#__codelineno-16-269"></a>        <span class="p">}</span>
</code></pre></div>
<h3 id="agent-participant-de-saga">Agent Participant de Saga<a class="headerlink" href="#agent-participant-de-saga" title="Permanent link">&para;</a></h3>
<p>Un agent peut également agir comme participant à part entière dans une Saga, répondant aux événements et émettant ses propres événements de domaine.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="c1"># agents/saga_participant_agent.py</span>
<a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span>
<a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a>
<a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a><span class="k">class</span><span class="w"> </span><span class="nc">SagaParticipantAgent</span><span class="p">:</span>
<a id="__codelineno-17-7" name="__codelineno-17-7" href="#__codelineno-17-7"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Agent agissant comme participant de Saga&quot;&quot;&quot;</span>
<a id="__codelineno-17-8" name="__codelineno-17-8" href="#__codelineno-17-8"></a>
<a id="__codelineno-17-9" name="__codelineno-17-9" href="#__codelineno-17-9"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-17-10" name="__codelineno-17-10" href="#__codelineno-17-10"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-17-11" name="__codelineno-17-11" href="#__codelineno-17-11"></a>        <span class="n">agent_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-17-12" name="__codelineno-17-12" href="#__codelineno-17-12"></a>        <span class="n">consumer</span><span class="p">,</span>
<a id="__codelineno-17-13" name="__codelineno-17-13" href="#__codelineno-17-13"></a>        <span class="n">producer</span><span class="p">,</span>
<a id="__codelineno-17-14" name="__codelineno-17-14" href="#__codelineno-17-14"></a>        <span class="n">vertex_client</span><span class="p">,</span>
<a id="__codelineno-17-15" name="__codelineno-17-15" href="#__codelineno-17-15"></a>        <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span>
<a id="__codelineno-17-16" name="__codelineno-17-16" href="#__codelineno-17-16"></a>    <span class="p">):</span>
<a id="__codelineno-17-17" name="__codelineno-17-17" href="#__codelineno-17-17"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">agent_id</span> <span class="o">=</span> <span class="n">agent_id</span>
<a id="__codelineno-17-18" name="__codelineno-17-18" href="#__codelineno-17-18"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">consumer</span> <span class="o">=</span> <span class="n">consumer</span>
<a id="__codelineno-17-19" name="__codelineno-17-19" href="#__codelineno-17-19"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">producer</span> <span class="o">=</span> <span class="n">producer</span>
<a id="__codelineno-17-20" name="__codelineno-17-20" href="#__codelineno-17-20"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">vertex</span> <span class="o">=</span> <span class="n">vertex_client</span>
<a id="__codelineno-17-21" name="__codelineno-17-21" href="#__codelineno-17-21"></a>
<a id="__codelineno-17-22" name="__codelineno-17-22" href="#__codelineno-17-22"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">input_topic</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;input_topic&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;agent.</span><span class="si">{</span><span class="n">agent_id</span><span class="si">}</span><span class="s1">.requests&#39;</span><span class="p">)</span>
<a id="__codelineno-17-23" name="__codelineno-17-23" href="#__codelineno-17-23"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">output_topic</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;output_topic&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;agent.</span><span class="si">{</span><span class="n">agent_id</span><span class="si">}</span><span class="s1">.results&#39;</span><span class="p">)</span>
<a id="__codelineno-17-24" name="__codelineno-17-24" href="#__codelineno-17-24"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">compensation_topic</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;compensation_topic&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;agent.</span><span class="si">{</span><span class="n">agent_id</span><span class="si">}</span><span class="s1">.compensate&#39;</span><span class="p">)</span>
<a id="__codelineno-17-25" name="__codelineno-17-25" href="#__codelineno-17-25"></a>
<a id="__codelineno-17-26" name="__codelineno-17-26" href="#__codelineno-17-26"></a>        <span class="c1"># État local pour compensations</span>
<a id="__codelineno-17-27" name="__codelineno-17-27" href="#__codelineno-17-27"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_completed_tasks</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-17-28" name="__codelineno-17-28" href="#__codelineno-17-28"></a>
<a id="__codelineno-17-29" name="__codelineno-17-29" href="#__codelineno-17-29"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-17-30" name="__codelineno-17-30" href="#__codelineno-17-30"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Boucle principale du participant&quot;&quot;&quot;</span>
<a id="__codelineno-17-31" name="__codelineno-17-31" href="#__codelineno-17-31"></a>
<a id="__codelineno-17-32" name="__codelineno-17-32" href="#__codelineno-17-32"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">consumer</span><span class="o">.</span><span class="n">subscribe</span><span class="p">([</span>
<a id="__codelineno-17-33" name="__codelineno-17-33" href="#__codelineno-17-33"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">input_topic</span><span class="p">,</span>
<a id="__codelineno-17-34" name="__codelineno-17-34" href="#__codelineno-17-34"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">compensation_topic</span>
<a id="__codelineno-17-35" name="__codelineno-17-35" href="#__codelineno-17-35"></a>        <span class="p">])</span>
<a id="__codelineno-17-36" name="__codelineno-17-36" href="#__codelineno-17-36"></a>
<a id="__codelineno-17-37" name="__codelineno-17-37" href="#__codelineno-17-37"></a>        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
<a id="__codelineno-17-38" name="__codelineno-17-38" href="#__codelineno-17-38"></a>            <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">consumer</span><span class="o">.</span><span class="n">poll</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
<a id="__codelineno-17-39" name="__codelineno-17-39" href="#__codelineno-17-39"></a>
<a id="__codelineno-17-40" name="__codelineno-17-40" href="#__codelineno-17-40"></a>            <span class="k">if</span> <span class="n">msg</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-17-41" name="__codelineno-17-41" href="#__codelineno-17-41"></a>                <span class="k">continue</span>
<a id="__codelineno-17-42" name="__codelineno-17-42" href="#__codelineno-17-42"></a>
<a id="__codelineno-17-43" name="__codelineno-17-43" href="#__codelineno-17-43"></a>            <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">error</span><span class="p">():</span>
<a id="__codelineno-17-44" name="__codelineno-17-44" href="#__codelineno-17-44"></a>                <span class="k">continue</span>
<a id="__codelineno-17-45" name="__codelineno-17-45" href="#__codelineno-17-45"></a>
<a id="__codelineno-17-46" name="__codelineno-17-46" href="#__codelineno-17-46"></a>            <span class="n">event</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">value</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
<a id="__codelineno-17-47" name="__codelineno-17-47" href="#__codelineno-17-47"></a>            <span class="n">topic</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">topic</span><span class="p">()</span>
<a id="__codelineno-17-48" name="__codelineno-17-48" href="#__codelineno-17-48"></a>
<a id="__codelineno-17-49" name="__codelineno-17-49" href="#__codelineno-17-49"></a>            <span class="k">if</span> <span class="n">topic</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_topic</span><span class="p">:</span>
<a id="__codelineno-17-50" name="__codelineno-17-50" href="#__codelineno-17-50"></a>                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_request</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
<a id="__codelineno-17-51" name="__codelineno-17-51" href="#__codelineno-17-51"></a>            <span class="k">elif</span> <span class="n">topic</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">compensation_topic</span><span class="p">:</span>
<a id="__codelineno-17-52" name="__codelineno-17-52" href="#__codelineno-17-52"></a>                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_compensation</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
<a id="__codelineno-17-53" name="__codelineno-17-53" href="#__codelineno-17-53"></a>
<a id="__codelineno-17-54" name="__codelineno-17-54" href="#__codelineno-17-54"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_handle_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-17-55" name="__codelineno-17-55" href="#__codelineno-17-55"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Traite une requête de Saga&quot;&quot;&quot;</span>
<a id="__codelineno-17-56" name="__codelineno-17-56" href="#__codelineno-17-56"></a>
<a id="__codelineno-17-57" name="__codelineno-17-57" href="#__codelineno-17-57"></a>        <span class="n">saga_id</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;saga_id&#39;</span><span class="p">)</span>
<a id="__codelineno-17-58" name="__codelineno-17-58" href="#__codelineno-17-58"></a>        <span class="n">task_id</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;task_id&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()))</span>
<a id="__codelineno-17-59" name="__codelineno-17-59" href="#__codelineno-17-59"></a>
<a id="__codelineno-17-60" name="__codelineno-17-60" href="#__codelineno-17-60"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-17-61" name="__codelineno-17-61" href="#__codelineno-17-61"></a>            <span class="c1"># Exécution de la tâche cognitive</span>
<a id="__codelineno-17-62" name="__codelineno-17-62" href="#__codelineno-17-62"></a>            <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute_cognitive_task</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
<a id="__codelineno-17-63" name="__codelineno-17-63" href="#__codelineno-17-63"></a>
<a id="__codelineno-17-64" name="__codelineno-17-64" href="#__codelineno-17-64"></a>            <span class="c1"># Stockage pour compensation potentielle</span>
<a id="__codelineno-17-65" name="__codelineno-17-65" href="#__codelineno-17-65"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_completed_tasks</span><span class="p">[</span><span class="n">saga_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-17-66" name="__codelineno-17-66" href="#__codelineno-17-66"></a>                <span class="s1">&#39;task_id&#39;</span><span class="p">:</span> <span class="n">task_id</span><span class="p">,</span>
<a id="__codelineno-17-67" name="__codelineno-17-67" href="#__codelineno-17-67"></a>                <span class="s1">&#39;original_event&#39;</span><span class="p">:</span> <span class="n">event</span><span class="p">,</span>
<a id="__codelineno-17-68" name="__codelineno-17-68" href="#__codelineno-17-68"></a>                <span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="n">result</span><span class="p">,</span>
<a id="__codelineno-17-69" name="__codelineno-17-69" href="#__codelineno-17-69"></a>                <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
<a id="__codelineno-17-70" name="__codelineno-17-70" href="#__codelineno-17-70"></a>            <span class="p">}</span>
<a id="__codelineno-17-71" name="__codelineno-17-71" href="#__codelineno-17-71"></a>
<a id="__codelineno-17-72" name="__codelineno-17-72" href="#__codelineno-17-72"></a>            <span class="c1"># Publication du succès</span>
<a id="__codelineno-17-73" name="__codelineno-17-73" href="#__codelineno-17-73"></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_publish_result</span><span class="p">(</span>
<a id="__codelineno-17-74" name="__codelineno-17-74" href="#__codelineno-17-74"></a>                <span class="n">saga_id</span><span class="o">=</span><span class="n">saga_id</span><span class="p">,</span>
<a id="__codelineno-17-75" name="__codelineno-17-75" href="#__codelineno-17-75"></a>                <span class="n">task_id</span><span class="o">=</span><span class="n">task_id</span><span class="p">,</span>
<a id="__codelineno-17-76" name="__codelineno-17-76" href="#__codelineno-17-76"></a>                <span class="n">success</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-17-77" name="__codelineno-17-77" href="#__codelineno-17-77"></a>                <span class="n">result</span><span class="o">=</span><span class="n">result</span>
<a id="__codelineno-17-78" name="__codelineno-17-78" href="#__codelineno-17-78"></a>            <span class="p">)</span>
<a id="__codelineno-17-79" name="__codelineno-17-79" href="#__codelineno-17-79"></a>
<a id="__codelineno-17-80" name="__codelineno-17-80" href="#__codelineno-17-80"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-17-81" name="__codelineno-17-81" href="#__codelineno-17-81"></a>            <span class="c1"># Publication de l&#39;échec</span>
<a id="__codelineno-17-82" name="__codelineno-17-82" href="#__codelineno-17-82"></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_publish_result</span><span class="p">(</span>
<a id="__codelineno-17-83" name="__codelineno-17-83" href="#__codelineno-17-83"></a>                <span class="n">saga_id</span><span class="o">=</span><span class="n">saga_id</span><span class="p">,</span>
<a id="__codelineno-17-84" name="__codelineno-17-84" href="#__codelineno-17-84"></a>                <span class="n">task_id</span><span class="o">=</span><span class="n">task_id</span><span class="p">,</span>
<a id="__codelineno-17-85" name="__codelineno-17-85" href="#__codelineno-17-85"></a>                <span class="n">success</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-17-86" name="__codelineno-17-86" href="#__codelineno-17-86"></a>                <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
<a id="__codelineno-17-87" name="__codelineno-17-87" href="#__codelineno-17-87"></a>            <span class="p">)</span>
<a id="__codelineno-17-88" name="__codelineno-17-88" href="#__codelineno-17-88"></a>
<a id="__codelineno-17-89" name="__codelineno-17-89" href="#__codelineno-17-89"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_handle_compensation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-17-90" name="__codelineno-17-90" href="#__codelineno-17-90"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Compense une tâche précédente&quot;&quot;&quot;</span>
<a id="__codelineno-17-91" name="__codelineno-17-91" href="#__codelineno-17-91"></a>
<a id="__codelineno-17-92" name="__codelineno-17-92" href="#__codelineno-17-92"></a>        <span class="n">saga_id</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;saga_id&#39;</span><span class="p">)</span>
<a id="__codelineno-17-93" name="__codelineno-17-93" href="#__codelineno-17-93"></a>
<a id="__codelineno-17-94" name="__codelineno-17-94" href="#__codelineno-17-94"></a>        <span class="k">if</span> <span class="n">saga_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_completed_tasks</span><span class="p">:</span>
<a id="__codelineno-17-95" name="__codelineno-17-95" href="#__codelineno-17-95"></a>            <span class="c1"># Rien à compenser</span>
<a id="__codelineno-17-96" name="__codelineno-17-96" href="#__codelineno-17-96"></a>            <span class="k">return</span>
<a id="__codelineno-17-97" name="__codelineno-17-97" href="#__codelineno-17-97"></a>
<a id="__codelineno-17-98" name="__codelineno-17-98" href="#__codelineno-17-98"></a>        <span class="n">task_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_completed_tasks</span><span class="p">[</span><span class="n">saga_id</span><span class="p">]</span>
<a id="__codelineno-17-99" name="__codelineno-17-99" href="#__codelineno-17-99"></a>
<a id="__codelineno-17-100" name="__codelineno-17-100" href="#__codelineno-17-100"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-17-101" name="__codelineno-17-101" href="#__codelineno-17-101"></a>            <span class="c1"># Exécution de la compensation</span>
<a id="__codelineno-17-102" name="__codelineno-17-102" href="#__codelineno-17-102"></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute_compensation</span><span class="p">(</span><span class="n">task_info</span><span class="p">)</span>
<a id="__codelineno-17-103" name="__codelineno-17-103" href="#__codelineno-17-103"></a>
<a id="__codelineno-17-104" name="__codelineno-17-104" href="#__codelineno-17-104"></a>            <span class="c1"># Nettoyage</span>
<a id="__codelineno-17-105" name="__codelineno-17-105" href="#__codelineno-17-105"></a>            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_completed_tasks</span><span class="p">[</span><span class="n">saga_id</span><span class="p">]</span>
<a id="__codelineno-17-106" name="__codelineno-17-106" href="#__codelineno-17-106"></a>
<a id="__codelineno-17-107" name="__codelineno-17-107" href="#__codelineno-17-107"></a>            <span class="c1"># Confirmation</span>
<a id="__codelineno-17-108" name="__codelineno-17-108" href="#__codelineno-17-108"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_publish_event</span><span class="p">(</span>
<a id="__codelineno-17-109" name="__codelineno-17-109" href="#__codelineno-17-109"></a>                <span class="n">topic</span><span class="o">=</span><span class="s1">&#39;saga.compensations&#39;</span><span class="p">,</span>
<a id="__codelineno-17-110" name="__codelineno-17-110" href="#__codelineno-17-110"></a>                <span class="n">event</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-17-111" name="__codelineno-17-111" href="#__codelineno-17-111"></a>                    <span class="s1">&#39;saga_id&#39;</span><span class="p">:</span> <span class="n">saga_id</span><span class="p">,</span>
<a id="__codelineno-17-112" name="__codelineno-17-112" href="#__codelineno-17-112"></a>                    <span class="s1">&#39;agent_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent_id</span><span class="p">,</span>
<a id="__codelineno-17-113" name="__codelineno-17-113" href="#__codelineno-17-113"></a>                    <span class="s1">&#39;event_type&#39;</span><span class="p">:</span> <span class="s1">&#39;agent.task.compensated&#39;</span><span class="p">,</span>
<a id="__codelineno-17-114" name="__codelineno-17-114" href="#__codelineno-17-114"></a>                    <span class="s1">&#39;task_id&#39;</span><span class="p">:</span> <span class="n">task_info</span><span class="p">[</span><span class="s1">&#39;task_id&#39;</span><span class="p">],</span>
<a id="__codelineno-17-115" name="__codelineno-17-115" href="#__codelineno-17-115"></a>                    <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
<a id="__codelineno-17-116" name="__codelineno-17-116" href="#__codelineno-17-116"></a>                <span class="p">}</span>
<a id="__codelineno-17-117" name="__codelineno-17-117" href="#__codelineno-17-117"></a>            <span class="p">)</span>
<a id="__codelineno-17-118" name="__codelineno-17-118" href="#__codelineno-17-118"></a>
<a id="__codelineno-17-119" name="__codelineno-17-119" href="#__codelineno-17-119"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-17-120" name="__codelineno-17-120" href="#__codelineno-17-120"></a>            <span class="c1"># Échec de compensation - alerte critique</span>
<a id="__codelineno-17-121" name="__codelineno-17-121" href="#__codelineno-17-121"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_publish_event</span><span class="p">(</span>
<a id="__codelineno-17-122" name="__codelineno-17-122" href="#__codelineno-17-122"></a>                <span class="n">topic</span><span class="o">=</span><span class="s1">&#39;saga.compensation.failures&#39;</span><span class="p">,</span>
<a id="__codelineno-17-123" name="__codelineno-17-123" href="#__codelineno-17-123"></a>                <span class="n">event</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-17-124" name="__codelineno-17-124" href="#__codelineno-17-124"></a>                    <span class="s1">&#39;saga_id&#39;</span><span class="p">:</span> <span class="n">saga_id</span><span class="p">,</span>
<a id="__codelineno-17-125" name="__codelineno-17-125" href="#__codelineno-17-125"></a>                    <span class="s1">&#39;agent_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent_id</span><span class="p">,</span>
<a id="__codelineno-17-126" name="__codelineno-17-126" href="#__codelineno-17-126"></a>                    <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
<a id="__codelineno-17-127" name="__codelineno-17-127" href="#__codelineno-17-127"></a>                    <span class="s1">&#39;requires_manual_intervention&#39;</span><span class="p">:</span> <span class="kc">True</span>
<a id="__codelineno-17-128" name="__codelineno-17-128" href="#__codelineno-17-128"></a>                <span class="p">}</span>
<a id="__codelineno-17-129" name="__codelineno-17-129" href="#__codelineno-17-129"></a>            <span class="p">)</span>
<a id="__codelineno-17-130" name="__codelineno-17-130" href="#__codelineno-17-130"></a>
<a id="__codelineno-17-131" name="__codelineno-17-131" href="#__codelineno-17-131"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_execute_cognitive_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-17-132" name="__codelineno-17-132" href="#__codelineno-17-132"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Exécute la tâche cognitive demandée&quot;&quot;&quot;</span>
<a id="__codelineno-17-133" name="__codelineno-17-133" href="#__codelineno-17-133"></a>
<a id="__codelineno-17-134" name="__codelineno-17-134" href="#__codelineno-17-134"></a>        <span class="n">task_type</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;task_type&#39;</span><span class="p">)</span>
<a id="__codelineno-17-135" name="__codelineno-17-135" href="#__codelineno-17-135"></a>        <span class="n">payload</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;payload&#39;</span><span class="p">,</span> <span class="p">{})</span>
<a id="__codelineno-17-136" name="__codelineno-17-136" href="#__codelineno-17-136"></a>
<a id="__codelineno-17-137" name="__codelineno-17-137" href="#__codelineno-17-137"></a>        <span class="c1"># Construction du prompt selon le type de tâche</span>
<a id="__codelineno-17-138" name="__codelineno-17-138" href="#__codelineno-17-138"></a>        <span class="n">prompt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_task_prompt</span><span class="p">(</span><span class="n">task_type</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
<a id="__codelineno-17-139" name="__codelineno-17-139" href="#__codelineno-17-139"></a>
<a id="__codelineno-17-140" name="__codelineno-17-140" href="#__codelineno-17-140"></a>        <span class="c1"># Appel Vertex AI</span>
<a id="__codelineno-17-141" name="__codelineno-17-141" href="#__codelineno-17-141"></a>        <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">vertex</span><span class="o">.</span><span class="n">generate_content</span><span class="p">(</span>
<a id="__codelineno-17-142" name="__codelineno-17-142" href="#__codelineno-17-142"></a>            <span class="n">model</span><span class="o">=</span><span class="s2">&quot;gemini-1.5-pro&quot;</span><span class="p">,</span>
<a id="__codelineno-17-143" name="__codelineno-17-143" href="#__codelineno-17-143"></a>            <span class="n">contents</span><span class="o">=</span><span class="p">[{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;parts&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">prompt</span><span class="p">}]}],</span>
<a id="__codelineno-17-144" name="__codelineno-17-144" href="#__codelineno-17-144"></a>            <span class="n">generation_config</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;temperature&quot;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">}</span>
<a id="__codelineno-17-145" name="__codelineno-17-145" href="#__codelineno-17-145"></a>        <span class="p">)</span>
<a id="__codelineno-17-146" name="__codelineno-17-146" href="#__codelineno-17-146"></a>
<a id="__codelineno-17-147" name="__codelineno-17-147" href="#__codelineno-17-147"></a>        <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-17-148" name="__codelineno-17-148" href="#__codelineno-17-148"></a>            <span class="s1">&#39;task_type&#39;</span><span class="p">:</span> <span class="n">task_type</span><span class="p">,</span>
<a id="__codelineno-17-149" name="__codelineno-17-149" href="#__codelineno-17-149"></a>            <span class="s1">&#39;output&#39;</span><span class="p">:</span> <span class="n">response</span><span class="o">.</span><span class="n">candidates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">,</span>
<a id="__codelineno-17-150" name="__codelineno-17-150" href="#__codelineno-17-150"></a>            <span class="s1">&#39;processed_at&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
<a id="__codelineno-17-151" name="__codelineno-17-151" href="#__codelineno-17-151"></a>        <span class="p">}</span>
<a id="__codelineno-17-152" name="__codelineno-17-152" href="#__codelineno-17-152"></a>
<a id="__codelineno-17-153" name="__codelineno-17-153" href="#__codelineno-17-153"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_execute_compensation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_info</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-17-154" name="__codelineno-17-154" href="#__codelineno-17-154"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Exécute la logique de compensation&quot;&quot;&quot;</span>
<a id="__codelineno-17-155" name="__codelineno-17-155" href="#__codelineno-17-155"></a>
<a id="__codelineno-17-156" name="__codelineno-17-156" href="#__codelineno-17-156"></a>        <span class="n">task_type</span> <span class="o">=</span> <span class="n">task_info</span><span class="p">[</span><span class="s1">&#39;original_event&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;task_type&#39;</span><span class="p">)</span>
<a id="__codelineno-17-157" name="__codelineno-17-157" href="#__codelineno-17-157"></a>
<a id="__codelineno-17-158" name="__codelineno-17-158" href="#__codelineno-17-158"></a>        <span class="c1"># Logique de compensation selon le type</span>
<a id="__codelineno-17-159" name="__codelineno-17-159" href="#__codelineno-17-159"></a>        <span class="c1"># Dans le cas d&#39;un agent, cela peut signifier:</span>
<a id="__codelineno-17-160" name="__codelineno-17-160" href="#__codelineno-17-160"></a>        <span class="c1"># - Annuler une recommandation</span>
<a id="__codelineno-17-161" name="__codelineno-17-161" href="#__codelineno-17-161"></a>        <span class="c1"># - Marquer une analyse comme invalide</span>
<a id="__codelineno-17-162" name="__codelineno-17-162" href="#__codelineno-17-162"></a>        <span class="c1"># - Notifier qu&#39;une décision précédente est révoquée</span>
<a id="__codelineno-17-163" name="__codelineno-17-163" href="#__codelineno-17-163"></a>
<a id="__codelineno-17-164" name="__codelineno-17-164" href="#__codelineno-17-164"></a>        <span class="n">compensation_prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-17-165" name="__codelineno-17-165" href="#__codelineno-17-165"></a><span class="s2">        Une tâche précédente doit être compensée/annulée.</span>
<a id="__codelineno-17-166" name="__codelineno-17-166" href="#__codelineno-17-166"></a><span class="s2">        Type de tâche: </span><span class="si">{</span><span class="n">task_type</span><span class="si">}</span>
<a id="__codelineno-17-167" name="__codelineno-17-167" href="#__codelineno-17-167"></a><span class="s2">        Résultat original: </span><span class="si">{</span><span class="n">task_info</span><span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">]</span><span class="si">}</span>
<a id="__codelineno-17-168" name="__codelineno-17-168" href="#__codelineno-17-168"></a>
<a id="__codelineno-17-169" name="__codelineno-17-169" href="#__codelineno-17-169"></a><span class="s2">        Génère un message de notification approprié pour informer</span>
<a id="__codelineno-17-170" name="__codelineno-17-170" href="#__codelineno-17-170"></a><span class="s2">        que cette action est annulée dans le cadre d&#39;une compensation de transaction.</span>
<a id="__codelineno-17-171" name="__codelineno-17-171" href="#__codelineno-17-171"></a><span class="s2">        &quot;&quot;&quot;</span>
<a id="__codelineno-17-172" name="__codelineno-17-172" href="#__codelineno-17-172"></a>
<a id="__codelineno-17-173" name="__codelineno-17-173" href="#__codelineno-17-173"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">vertex</span><span class="o">.</span><span class="n">generate_content</span><span class="p">(</span>
<a id="__codelineno-17-174" name="__codelineno-17-174" href="#__codelineno-17-174"></a>            <span class="n">model</span><span class="o">=</span><span class="s2">&quot;gemini-1.5-pro&quot;</span><span class="p">,</span>
<a id="__codelineno-17-175" name="__codelineno-17-175" href="#__codelineno-17-175"></a>            <span class="n">contents</span><span class="o">=</span><span class="p">[{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;parts&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">compensation_prompt</span><span class="p">}]}]</span>
<a id="__codelineno-17-176" name="__codelineno-17-176" href="#__codelineno-17-176"></a>        <span class="p">)</span>
<a id="__codelineno-17-177" name="__codelineno-17-177" href="#__codelineno-17-177"></a>
<a id="__codelineno-17-178" name="__codelineno-17-178" href="#__codelineno-17-178"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_build_task_prompt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">payload</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-17-179" name="__codelineno-17-179" href="#__codelineno-17-179"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Construit le prompt selon le type de tâche&quot;&quot;&quot;</span>
<a id="__codelineno-17-180" name="__codelineno-17-180" href="#__codelineno-17-180"></a>
<a id="__codelineno-17-181" name="__codelineno-17-181" href="#__codelineno-17-181"></a>        <span class="n">prompts</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-17-182" name="__codelineno-17-182" href="#__codelineno-17-182"></a>            <span class="s1">&#39;analyze_request&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Analyse la demande suivante: </span><span class="si">{</span><span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;request&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
<a id="__codelineno-17-183" name="__codelineno-17-183" href="#__codelineno-17-183"></a>            <span class="s1">&#39;validate_documents&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Valide les documents: </span><span class="si">{</span><span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;documents&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
<a id="__codelineno-17-184" name="__codelineno-17-184" href="#__codelineno-17-184"></a>            <span class="s1">&#39;generate_recommendation&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Génère une recommandation pour: </span><span class="si">{</span><span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;context&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
<a id="__codelineno-17-185" name="__codelineno-17-185" href="#__codelineno-17-185"></a>            <span class="s1">&#39;assess_risk&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Évalue le risque pour: </span><span class="si">{</span><span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;scenario&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-17-186" name="__codelineno-17-186" href="#__codelineno-17-186"></a>        <span class="p">}</span>
<a id="__codelineno-17-187" name="__codelineno-17-187" href="#__codelineno-17-187"></a>
<a id="__codelineno-17-188" name="__codelineno-17-188" href="#__codelineno-17-188"></a>        <span class="k">return</span> <span class="n">prompts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">task_type</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Traite la tâche: </span><span class="si">{</span><span class="n">task_type</span><span class="si">}</span><span class="s2"> avec </span><span class="si">{</span><span class="n">payload</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-17-189" name="__codelineno-17-189" href="#__codelineno-17-189"></a>
<a id="__codelineno-17-190" name="__codelineno-17-190" href="#__codelineno-17-190"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_publish_result</span><span class="p">(</span>
<a id="__codelineno-17-191" name="__codelineno-17-191" href="#__codelineno-17-191"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-17-192" name="__codelineno-17-192" href="#__codelineno-17-192"></a>        <span class="n">saga_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-17-193" name="__codelineno-17-193" href="#__codelineno-17-193"></a>        <span class="n">task_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-17-194" name="__codelineno-17-194" href="#__codelineno-17-194"></a>        <span class="n">success</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
<a id="__codelineno-17-195" name="__codelineno-17-195" href="#__codelineno-17-195"></a>        <span class="n">result</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-17-196" name="__codelineno-17-196" href="#__codelineno-17-196"></a>        <span class="n">error</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-17-197" name="__codelineno-17-197" href="#__codelineno-17-197"></a>    <span class="p">):</span>
<a id="__codelineno-17-198" name="__codelineno-17-198" href="#__codelineno-17-198"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Publie le résultat de la tâche&quot;&quot;&quot;</span>
<a id="__codelineno-17-199" name="__codelineno-17-199" href="#__codelineno-17-199"></a>
<a id="__codelineno-17-200" name="__codelineno-17-200" href="#__codelineno-17-200"></a>        <span class="n">event</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-17-201" name="__codelineno-17-201" href="#__codelineno-17-201"></a>            <span class="s1">&#39;saga_id&#39;</span><span class="p">:</span> <span class="n">saga_id</span><span class="p">,</span>
<a id="__codelineno-17-202" name="__codelineno-17-202" href="#__codelineno-17-202"></a>            <span class="s1">&#39;agent_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent_id</span><span class="p">,</span>
<a id="__codelineno-17-203" name="__codelineno-17-203" href="#__codelineno-17-203"></a>            <span class="s1">&#39;task_id&#39;</span><span class="p">:</span> <span class="n">task_id</span><span class="p">,</span>
<a id="__codelineno-17-204" name="__codelineno-17-204" href="#__codelineno-17-204"></a>            <span class="s1">&#39;event_type&#39;</span><span class="p">:</span> <span class="s1">&#39;agent.task.completed&#39;</span> <span class="k">if</span> <span class="n">success</span> <span class="k">else</span> <span class="s1">&#39;agent.task.failed&#39;</span><span class="p">,</span>
<a id="__codelineno-17-205" name="__codelineno-17-205" href="#__codelineno-17-205"></a>            <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="n">success</span><span class="p">,</span>
<a id="__codelineno-17-206" name="__codelineno-17-206" href="#__codelineno-17-206"></a>            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
<a id="__codelineno-17-207" name="__codelineno-17-207" href="#__codelineno-17-207"></a>        <span class="p">}</span>
<a id="__codelineno-17-208" name="__codelineno-17-208" href="#__codelineno-17-208"></a>
<a id="__codelineno-17-209" name="__codelineno-17-209" href="#__codelineno-17-209"></a>        <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
<a id="__codelineno-17-210" name="__codelineno-17-210" href="#__codelineno-17-210"></a>            <span class="n">event</span><span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>
<a id="__codelineno-17-211" name="__codelineno-17-211" href="#__codelineno-17-211"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-17-212" name="__codelineno-17-212" href="#__codelineno-17-212"></a>            <span class="n">event</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">error</span>
<a id="__codelineno-17-213" name="__codelineno-17-213" href="#__codelineno-17-213"></a>
<a id="__codelineno-17-214" name="__codelineno-17-214" href="#__codelineno-17-214"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_publish_event</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_topic</span><span class="p">,</span> <span class="n">event</span><span class="p">)</span>
<a id="__codelineno-17-215" name="__codelineno-17-215" href="#__codelineno-17-215"></a>
<a id="__codelineno-17-216" name="__codelineno-17-216" href="#__codelineno-17-216"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_publish_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">topic</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-17-217" name="__codelineno-17-217" href="#__codelineno-17-217"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Publie un événement sur Kafka&quot;&quot;&quot;</span>
<a id="__codelineno-17-218" name="__codelineno-17-218" href="#__codelineno-17-218"></a>
<a id="__codelineno-17-219" name="__codelineno-17-219" href="#__codelineno-17-219"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">producer</span><span class="o">.</span><span class="n">produce</span><span class="p">(</span>
<a id="__codelineno-17-220" name="__codelineno-17-220" href="#__codelineno-17-220"></a>            <span class="n">topic</span><span class="o">=</span><span class="n">topic</span><span class="p">,</span>
<a id="__codelineno-17-221" name="__codelineno-17-221" href="#__codelineno-17-221"></a>            <span class="n">key</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;saga_id&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(),</span>
<a id="__codelineno-17-222" name="__codelineno-17-222" href="#__codelineno-17-222"></a>            <span class="n">value</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">event</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(),</span>
<a id="__codelineno-17-223" name="__codelineno-17-223" href="#__codelineno-17-223"></a>            <span class="n">headers</span><span class="o">=</span><span class="p">[</span>
<a id="__codelineno-17-224" name="__codelineno-17-224" href="#__codelineno-17-224"></a>                <span class="p">(</span><span class="s1">&#39;agent_id&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent_id</span><span class="o">.</span><span class="n">encode</span><span class="p">()),</span>
<a id="__codelineno-17-225" name="__codelineno-17-225" href="#__codelineno-17-225"></a>                <span class="p">(</span><span class="s1">&#39;event_type&#39;</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;event_type&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
<a id="__codelineno-17-226" name="__codelineno-17-226" href="#__codelineno-17-226"></a>            <span class="p">]</span>
<a id="__codelineno-17-227" name="__codelineno-17-227" href="#__codelineno-17-227"></a>        <span class="p">)</span>
<a id="__codelineno-17-228" name="__codelineno-17-228" href="#__codelineno-17-228"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">producer</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
</code></pre></div>
<hr />
<h2 id="ii97-tests-des-patrons-architecturaux">II.9.7 Tests des Patrons Architecturaux<a class="headerlink" href="#ii97-tests-des-patrons-architecturaux" title="Permanent link">&para;</a></h2>
<h3 id="strategies-de-test-pour-levent-sourcing">Stratégies de Test pour l'Event Sourcing<a class="headerlink" href="#strategies-de-test-pour-levent-sourcing" title="Permanent link">&para;</a></h3>
<p>Tester des systèmes basés sur l'Event Sourcing nécessite des approches spécifiques. Les tests doivent vérifier non seulement l'état final mais aussi la séquence d'événements produite. L'approche Given-When-Then est particulièrement adaptée.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="c1"># tests/eventsourcing_tests.py</span>
<a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span>
<a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>
<a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a>
<a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a><span class="nd">@dataclass</span>
<a id="__codelineno-18-7" name="__codelineno-18-7" href="#__codelineno-18-7"></a><span class="k">class</span><span class="w"> </span><span class="nc">TestScenario</span><span class="p">:</span>
<a id="__codelineno-18-8" name="__codelineno-18-8" href="#__codelineno-18-8"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Scénario de test pour Event Sourcing&quot;&quot;&quot;</span>
<a id="__codelineno-18-9" name="__codelineno-18-9" href="#__codelineno-18-9"></a>    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-18-10" name="__codelineno-18-10" href="#__codelineno-18-10"></a>    <span class="n">given_events</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span>
<a id="__codelineno-18-11" name="__codelineno-18-11" href="#__codelineno-18-11"></a>    <span class="n">when_command</span><span class="p">:</span> <span class="nb">dict</span>
<a id="__codelineno-18-12" name="__codelineno-18-12" href="#__codelineno-18-12"></a>    <span class="n">then_events</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span>
<a id="__codelineno-18-13" name="__codelineno-18-13" href="#__codelineno-18-13"></a>    <span class="n">then_state</span><span class="p">:</span> <span class="nb">dict</span>
<a id="__codelineno-18-14" name="__codelineno-18-14" href="#__codelineno-18-14"></a>
<a id="__codelineno-18-15" name="__codelineno-18-15" href="#__codelineno-18-15"></a>
<a id="__codelineno-18-16" name="__codelineno-18-16" href="#__codelineno-18-16"></a><span class="k">class</span><span class="w"> </span><span class="nc">EventSourcingTestHarness</span><span class="p">:</span>
<a id="__codelineno-18-17" name="__codelineno-18-17" href="#__codelineno-18-17"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Harnais de test pour les agrégats Event-Sourced&quot;&quot;&quot;</span>
<a id="__codelineno-18-18" name="__codelineno-18-18" href="#__codelineno-18-18"></a>
<a id="__codelineno-18-19" name="__codelineno-18-19" href="#__codelineno-18-19"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">aggregate_class</span><span class="p">,</span> <span class="n">event_store</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-18-20" name="__codelineno-18-20" href="#__codelineno-18-20"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">aggregate_class</span> <span class="o">=</span> <span class="n">aggregate_class</span>
<a id="__codelineno-18-21" name="__codelineno-18-21" href="#__codelineno-18-21"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">event_store</span> <span class="o">=</span> <span class="n">event_store</span> <span class="ow">or</span> <span class="n">InMemoryEventStore</span><span class="p">()</span>
<a id="__codelineno-18-22" name="__codelineno-18-22" href="#__codelineno-18-22"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">published_events</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-18-23" name="__codelineno-18-23" href="#__codelineno-18-23"></a>
<a id="__codelineno-18-24" name="__codelineno-18-24" href="#__codelineno-18-24"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">given</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">events</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">]):</span>
<a id="__codelineno-18-25" name="__codelineno-18-25" href="#__codelineno-18-25"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Configure l&#39;état initial avec des événements&quot;&quot;&quot;</span>
<a id="__codelineno-18-26" name="__codelineno-18-26" href="#__codelineno-18-26"></a>
<a id="__codelineno-18-27" name="__codelineno-18-27" href="#__codelineno-18-27"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">events</span><span class="p">:</span>
<a id="__codelineno-18-28" name="__codelineno-18-28" href="#__codelineno-18-28"></a>            <span class="k">return</span>
<a id="__codelineno-18-29" name="__codelineno-18-29" href="#__codelineno-18-29"></a>
<a id="__codelineno-18-30" name="__codelineno-18-30" href="#__codelineno-18-30"></a>        <span class="n">aggregate_id</span> <span class="o">=</span> <span class="n">events</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;aggregate_id&#39;</span><span class="p">)</span>
<a id="__codelineno-18-31" name="__codelineno-18-31" href="#__codelineno-18-31"></a>
<a id="__codelineno-18-32" name="__codelineno-18-32" href="#__codelineno-18-32"></a>        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span>
<a id="__codelineno-18-33" name="__codelineno-18-33" href="#__codelineno-18-33"></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_store</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
<a id="__codelineno-18-34" name="__codelineno-18-34" href="#__codelineno-18-34"></a>                <span class="n">aggregate_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">aggregate_class</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span>
<a id="__codelineno-18-35" name="__codelineno-18-35" href="#__codelineno-18-35"></a>                <span class="n">aggregate_id</span><span class="o">=</span><span class="n">aggregate_id</span><span class="p">,</span>
<a id="__codelineno-18-36" name="__codelineno-18-36" href="#__codelineno-18-36"></a>                <span class="n">events</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_dict_to_event</span><span class="p">(</span><span class="n">event</span><span class="p">)],</span>
<a id="__codelineno-18-37" name="__codelineno-18-37" href="#__codelineno-18-37"></a>                <span class="n">expected_version</span><span class="o">=-</span><span class="mi">1</span>
<a id="__codelineno-18-38" name="__codelineno-18-38" href="#__codelineno-18-38"></a>            <span class="p">)</span>
<a id="__codelineno-18-39" name="__codelineno-18-39" href="#__codelineno-18-39"></a>
<a id="__codelineno-18-40" name="__codelineno-18-40" href="#__codelineno-18-40"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">when</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;EventSourcingTestHarness&#39;</span><span class="p">:</span>
<a id="__codelineno-18-41" name="__codelineno-18-41" href="#__codelineno-18-41"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Exécute une commande&quot;&quot;&quot;</span>
<a id="__codelineno-18-42" name="__codelineno-18-42" href="#__codelineno-18-42"></a>
<a id="__codelineno-18-43" name="__codelineno-18-43" href="#__codelineno-18-43"></a>        <span class="n">aggregate_id</span> <span class="o">=</span> <span class="n">command</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;aggregate_id&#39;</span><span class="p">)</span>
<a id="__codelineno-18-44" name="__codelineno-18-44" href="#__codelineno-18-44"></a>        <span class="n">command_type</span> <span class="o">=</span> <span class="n">command</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">)</span>
<a id="__codelineno-18-45" name="__codelineno-18-45" href="#__codelineno-18-45"></a>
<a id="__codelineno-18-46" name="__codelineno-18-46" href="#__codelineno-18-46"></a>        <span class="c1"># Chargement de l&#39;agrégat</span>
<a id="__codelineno-18-47" name="__codelineno-18-47" href="#__codelineno-18-47"></a>        <span class="n">aggregate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aggregate_class</span><span class="p">(</span><span class="n">aggregate_id</span><span class="p">)</span>
<a id="__codelineno-18-48" name="__codelineno-18-48" href="#__codelineno-18-48"></a>        <span class="n">events</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_store</span><span class="o">.</span><span class="n">get_events</span><span class="p">(</span>
<a id="__codelineno-18-49" name="__codelineno-18-49" href="#__codelineno-18-49"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">aggregate_class</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span>
<a id="__codelineno-18-50" name="__codelineno-18-50" href="#__codelineno-18-50"></a>            <span class="n">aggregate_id</span>
<a id="__codelineno-18-51" name="__codelineno-18-51" href="#__codelineno-18-51"></a>        <span class="p">)</span>
<a id="__codelineno-18-52" name="__codelineno-18-52" href="#__codelineno-18-52"></a>        <span class="n">aggregate</span><span class="o">.</span><span class="n">load_from_history</span><span class="p">(</span><span class="n">events</span><span class="p">)</span>
<a id="__codelineno-18-53" name="__codelineno-18-53" href="#__codelineno-18-53"></a>
<a id="__codelineno-18-54" name="__codelineno-18-54" href="#__codelineno-18-54"></a>        <span class="c1"># Exécution de la commande</span>
<a id="__codelineno-18-55" name="__codelineno-18-55" href="#__codelineno-18-55"></a>        <span class="n">method</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">aggregate</span><span class="p">,</span> <span class="n">command_type</span><span class="p">)</span>
<a id="__codelineno-18-56" name="__codelineno-18-56" href="#__codelineno-18-56"></a>        <span class="n">method</span><span class="p">(</span><span class="o">**</span><span class="n">command</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;params&#39;</span><span class="p">,</span> <span class="p">{}))</span>
<a id="__codelineno-18-57" name="__codelineno-18-57" href="#__codelineno-18-57"></a>
<a id="__codelineno-18-58" name="__codelineno-18-58" href="#__codelineno-18-58"></a>        <span class="c1"># Capture des événements produits</span>
<a id="__codelineno-18-59" name="__codelineno-18-59" href="#__codelineno-18-59"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">published_events</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-18-60" name="__codelineno-18-60" href="#__codelineno-18-60"></a>            <span class="n">e</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">aggregate</span><span class="o">.</span><span class="n">pending_events</span>
<a id="__codelineno-18-61" name="__codelineno-18-61" href="#__codelineno-18-61"></a>        <span class="p">]</span>
<a id="__codelineno-18-62" name="__codelineno-18-62" href="#__codelineno-18-62"></a>
<a id="__codelineno-18-63" name="__codelineno-18-63" href="#__codelineno-18-63"></a>        <span class="c1"># Sauvegarde</span>
<a id="__codelineno-18-64" name="__codelineno-18-64" href="#__codelineno-18-64"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_store</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
<a id="__codelineno-18-65" name="__codelineno-18-65" href="#__codelineno-18-65"></a>            <span class="n">aggregate_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">aggregate_class</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span>
<a id="__codelineno-18-66" name="__codelineno-18-66" href="#__codelineno-18-66"></a>            <span class="n">aggregate_id</span><span class="o">=</span><span class="n">aggregate_id</span><span class="p">,</span>
<a id="__codelineno-18-67" name="__codelineno-18-67" href="#__codelineno-18-67"></a>            <span class="n">events</span><span class="o">=</span><span class="n">aggregate</span><span class="o">.</span><span class="n">pending_events</span><span class="p">,</span>
<a id="__codelineno-18-68" name="__codelineno-18-68" href="#__codelineno-18-68"></a>            <span class="n">expected_version</span><span class="o">=</span><span class="n">aggregate</span><span class="o">.</span><span class="n">version</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">aggregate</span><span class="o">.</span><span class="n">pending_events</span><span class="p">)</span>
<a id="__codelineno-18-69" name="__codelineno-18-69" href="#__codelineno-18-69"></a>        <span class="p">)</span>
<a id="__codelineno-18-70" name="__codelineno-18-70" href="#__codelineno-18-70"></a>
<a id="__codelineno-18-71" name="__codelineno-18-71" href="#__codelineno-18-71"></a>        <span class="k">return</span> <span class="bp">self</span>
<a id="__codelineno-18-72" name="__codelineno-18-72" href="#__codelineno-18-72"></a>
<a id="__codelineno-18-73" name="__codelineno-18-73" href="#__codelineno-18-73"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">then_events_match</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expected_events</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">]):</span>
<a id="__codelineno-18-74" name="__codelineno-18-74" href="#__codelineno-18-74"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Vérifie les événements produits&quot;&quot;&quot;</span>
<a id="__codelineno-18-75" name="__codelineno-18-75" href="#__codelineno-18-75"></a>
<a id="__codelineno-18-76" name="__codelineno-18-76" href="#__codelineno-18-76"></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">published_events</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">expected_events</span><span class="p">),</span> \
<a id="__codelineno-18-77" name="__codelineno-18-77" href="#__codelineno-18-77"></a>            <span class="sa">f</span><span class="s2">&quot;Nombre d&#39;événements: attendu </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">expected_events</span><span class="p">)</span><span class="si">}</span><span class="s2">, obtenu </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">published_events</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-18-78" name="__codelineno-18-78" href="#__codelineno-18-78"></a>
<a id="__codelineno-18-79" name="__codelineno-18-79" href="#__codelineno-18-79"></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">actual</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">published_events</span><span class="p">,</span> <span class="n">expected_events</span><span class="p">)):</span>
<a id="__codelineno-18-80" name="__codelineno-18-80" href="#__codelineno-18-80"></a>            <span class="k">assert</span> <span class="n">actual</span><span class="p">[</span><span class="s1">&#39;event_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">expected</span><span class="p">[</span><span class="s1">&#39;event_type&#39;</span><span class="p">],</span> \
<a id="__codelineno-18-81" name="__codelineno-18-81" href="#__codelineno-18-81"></a>                <span class="sa">f</span><span class="s2">&quot;Event </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">: type attendu </span><span class="si">{</span><span class="n">expected</span><span class="p">[</span><span class="s1">&#39;event_type&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, obtenu </span><span class="si">{</span><span class="n">actual</span><span class="p">[</span><span class="s1">&#39;event_type&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-18-82" name="__codelineno-18-82" href="#__codelineno-18-82"></a>
<a id="__codelineno-18-83" name="__codelineno-18-83" href="#__codelineno-18-83"></a>            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">expected</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;payload&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-18-84" name="__codelineno-18-84" href="#__codelineno-18-84"></a>                <span class="k">assert</span> <span class="n">actual</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">==</span> <span class="n">value</span><span class="p">,</span> \
<a id="__codelineno-18-85" name="__codelineno-18-85" href="#__codelineno-18-85"></a>                    <span class="sa">f</span><span class="s2">&quot;Event </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> attendu </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">, obtenu </span><span class="si">{</span><span class="n">actual</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-18-86" name="__codelineno-18-86" href="#__codelineno-18-86"></a>
<a id="__codelineno-18-87" name="__codelineno-18-87" href="#__codelineno-18-87"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">then_state_equals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expected_state</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-18-88" name="__codelineno-18-88" href="#__codelineno-18-88"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Vérifie l&#39;état final de l&#39;agrégat&quot;&quot;&quot;</span>
<a id="__codelineno-18-89" name="__codelineno-18-89" href="#__codelineno-18-89"></a>
<a id="__codelineno-18-90" name="__codelineno-18-90" href="#__codelineno-18-90"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">published_events</span><span class="p">:</span>
<a id="__codelineno-18-91" name="__codelineno-18-91" href="#__codelineno-18-91"></a>            <span class="k">return</span>
<a id="__codelineno-18-92" name="__codelineno-18-92" href="#__codelineno-18-92"></a>
<a id="__codelineno-18-93" name="__codelineno-18-93" href="#__codelineno-18-93"></a>        <span class="n">aggregate_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">published_events</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;aggregate_id&#39;</span><span class="p">)</span>
<a id="__codelineno-18-94" name="__codelineno-18-94" href="#__codelineno-18-94"></a>
<a id="__codelineno-18-95" name="__codelineno-18-95" href="#__codelineno-18-95"></a>        <span class="n">aggregate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aggregate_class</span><span class="p">(</span><span class="n">aggregate_id</span><span class="p">)</span>
<a id="__codelineno-18-96" name="__codelineno-18-96" href="#__codelineno-18-96"></a>        <span class="n">events</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_store</span><span class="o">.</span><span class="n">get_events</span><span class="p">(</span>
<a id="__codelineno-18-97" name="__codelineno-18-97" href="#__codelineno-18-97"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">aggregate_class</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span>
<a id="__codelineno-18-98" name="__codelineno-18-98" href="#__codelineno-18-98"></a>            <span class="n">aggregate_id</span>
<a id="__codelineno-18-99" name="__codelineno-18-99" href="#__codelineno-18-99"></a>        <span class="p">)</span>
<a id="__codelineno-18-100" name="__codelineno-18-100" href="#__codelineno-18-100"></a>        <span class="n">aggregate</span><span class="o">.</span><span class="n">load_from_history</span><span class="p">(</span><span class="n">events</span><span class="p">)</span>
<a id="__codelineno-18-101" name="__codelineno-18-101" href="#__codelineno-18-101"></a>
<a id="__codelineno-18-102" name="__codelineno-18-102" href="#__codelineno-18-102"></a>        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">expected_state</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-18-103" name="__codelineno-18-103" href="#__codelineno-18-103"></a>            <span class="k">assert</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">aggregate</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span> <span class="o">==</span> <span class="n">value</span><span class="p">,</span> \
<a id="__codelineno-18-104" name="__codelineno-18-104" href="#__codelineno-18-104"></a>                <span class="sa">f</span><span class="s2">&quot;État: </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> attendu </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">, obtenu </span><span class="si">{</span><span class="nb">getattr</span><span class="p">(</span><span class="n">aggregate</span><span class="p">,</span><span class="w"> </span><span class="n">key</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-18-105" name="__codelineno-18-105" href="#__codelineno-18-105"></a>
<a id="__codelineno-18-106" name="__codelineno-18-106" href="#__codelineno-18-106"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_dict_to_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-18-107" name="__codelineno-18-107" href="#__codelineno-18-107"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Convertit un dict en événement&quot;&quot;&quot;</span>
<a id="__codelineno-18-108" name="__codelineno-18-108" href="#__codelineno-18-108"></a>        <span class="c1"># Implémentation selon le mapping des types d&#39;événements</span>
<a id="__codelineno-18-109" name="__codelineno-18-109" href="#__codelineno-18-109"></a>        <span class="k">pass</span>
<a id="__codelineno-18-110" name="__codelineno-18-110" href="#__codelineno-18-110"></a>
<a id="__codelineno-18-111" name="__codelineno-18-111" href="#__codelineno-18-111"></a>
<a id="__codelineno-18-112" name="__codelineno-18-112" href="#__codelineno-18-112"></a><span class="k">class</span><span class="w"> </span><span class="nc">InMemoryEventStore</span><span class="p">:</span>
<a id="__codelineno-18-113" name="__codelineno-18-113" href="#__codelineno-18-113"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Event Store en mémoire pour les tests&quot;&quot;&quot;</span>
<a id="__codelineno-18-114" name="__codelineno-18-114" href="#__codelineno-18-114"></a>
<a id="__codelineno-18-115" name="__codelineno-18-115" href="#__codelineno-18-115"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-18-116" name="__codelineno-18-116" href="#__codelineno-18-116"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># aggregate_id -&gt; List[events]</span>
<a id="__codelineno-18-117" name="__codelineno-18-117" href="#__codelineno-18-117"></a>
<a id="__codelineno-18-118" name="__codelineno-18-118" href="#__codelineno-18-118"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">append</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">aggregate_type</span><span class="p">,</span> <span class="n">aggregate_id</span><span class="p">,</span> <span class="n">events</span><span class="p">,</span> <span class="n">expected_version</span><span class="p">):</span>
<a id="__codelineno-18-119" name="__codelineno-18-119" href="#__codelineno-18-119"></a>        <span class="n">key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">aggregate_type</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">aggregate_id</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-18-120" name="__codelineno-18-120" href="#__codelineno-18-120"></a>
<a id="__codelineno-18-121" name="__codelineno-18-121" href="#__codelineno-18-121"></a>        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="p">:</span>
<a id="__codelineno-18-122" name="__codelineno-18-122" href="#__codelineno-18-122"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-18-123" name="__codelineno-18-123" href="#__codelineno-18-123"></a>
<a id="__codelineno-18-124" name="__codelineno-18-124" href="#__codelineno-18-124"></a>        <span class="n">current_version</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="p">[</span><span class="n">key</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span>
<a id="__codelineno-18-125" name="__codelineno-18-125" href="#__codelineno-18-125"></a>
<a id="__codelineno-18-126" name="__codelineno-18-126" href="#__codelineno-18-126"></a>        <span class="k">if</span> <span class="n">expected_version</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">current_version</span> <span class="o">!=</span> <span class="n">expected_version</span><span class="p">:</span>
<a id="__codelineno-18-127" name="__codelineno-18-127" href="#__codelineno-18-127"></a>            <span class="k">raise</span> <span class="n">ConcurrencyError</span><span class="p">()</span>
<a id="__codelineno-18-128" name="__codelineno-18-128" href="#__codelineno-18-128"></a>
<a id="__codelineno-18-129" name="__codelineno-18-129" href="#__codelineno-18-129"></a>        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span>
<a id="__codelineno-18-130" name="__codelineno-18-130" href="#__codelineno-18-130"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
<a id="__codelineno-18-131" name="__codelineno-18-131" href="#__codelineno-18-131"></a>
<a id="__codelineno-18-132" name="__codelineno-18-132" href="#__codelineno-18-132"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_events</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">aggregate_type</span><span class="p">,</span> <span class="n">aggregate_id</span><span class="p">,</span> <span class="n">from_version</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<a id="__codelineno-18-133" name="__codelineno-18-133" href="#__codelineno-18-133"></a>        <span class="n">key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">aggregate_type</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">aggregate_id</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-18-134" name="__codelineno-18-134" href="#__codelineno-18-134"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">[])[</span><span class="n">from_version</span><span class="p">:]</span>
<a id="__codelineno-18-135" name="__codelineno-18-135" href="#__codelineno-18-135"></a>
<a id="__codelineno-18-136" name="__codelineno-18-136" href="#__codelineno-18-136"></a>
<a id="__codelineno-18-137" name="__codelineno-18-137" href="#__codelineno-18-137"></a><span class="c1"># Exemple de tests</span>
<a id="__codelineno-18-138" name="__codelineno-18-138" href="#__codelineno-18-138"></a><span class="k">class</span><span class="w"> </span><span class="nc">TestCustomerAggregate</span><span class="p">:</span>
<a id="__codelineno-18-139" name="__codelineno-18-139" href="#__codelineno-18-139"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Tests pour l&#39;agrégat Customer&quot;&quot;&quot;</span>
<a id="__codelineno-18-140" name="__codelineno-18-140" href="#__codelineno-18-140"></a>
<a id="__codelineno-18-141" name="__codelineno-18-141" href="#__codelineno-18-141"></a>    <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<a id="__codelineno-18-142" name="__codelineno-18-142" href="#__codelineno-18-142"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">harness</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-18-143" name="__codelineno-18-143" href="#__codelineno-18-143"></a>        <span class="k">return</span> <span class="n">EventSourcingTestHarness</span><span class="p">(</span><span class="n">CustomerAggregate</span><span class="p">)</span>
<a id="__codelineno-18-144" name="__codelineno-18-144" href="#__codelineno-18-144"></a>
<a id="__codelineno-18-145" name="__codelineno-18-145" href="#__codelineno-18-145"></a>    <span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">asyncio</span>
<a id="__codelineno-18-146" name="__codelineno-18-146" href="#__codelineno-18-146"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">test_create_customer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">harness</span><span class="p">):</span>
<a id="__codelineno-18-147" name="__codelineno-18-147" href="#__codelineno-18-147"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Test de création d&#39;un client&quot;&quot;&quot;</span>
<a id="__codelineno-18-148" name="__codelineno-18-148" href="#__codelineno-18-148"></a>
<a id="__codelineno-18-149" name="__codelineno-18-149" href="#__codelineno-18-149"></a>        <span class="k">await</span> <span class="n">harness</span><span class="o">.</span><span class="n">when</span><span class="p">({</span>
<a id="__codelineno-18-150" name="__codelineno-18-150" href="#__codelineno-18-150"></a>            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;create&#39;</span><span class="p">,</span>
<a id="__codelineno-18-151" name="__codelineno-18-151" href="#__codelineno-18-151"></a>            <span class="s1">&#39;aggregate_id&#39;</span><span class="p">:</span> <span class="s1">&#39;cust-123&#39;</span><span class="p">,</span>
<a id="__codelineno-18-152" name="__codelineno-18-152" href="#__codelineno-18-152"></a>            <span class="s1">&#39;params&#39;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-18-153" name="__codelineno-18-153" href="#__codelineno-18-153"></a>                <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Jean Dupont&#39;</span><span class="p">,</span>
<a id="__codelineno-18-154" name="__codelineno-18-154" href="#__codelineno-18-154"></a>                <span class="s1">&#39;email&#39;</span><span class="p">:</span> <span class="s1">&#39;jean@example.com&#39;</span>
<a id="__codelineno-18-155" name="__codelineno-18-155" href="#__codelineno-18-155"></a>            <span class="p">}</span>
<a id="__codelineno-18-156" name="__codelineno-18-156" href="#__codelineno-18-156"></a>        <span class="p">})</span>
<a id="__codelineno-18-157" name="__codelineno-18-157" href="#__codelineno-18-157"></a>
<a id="__codelineno-18-158" name="__codelineno-18-158" href="#__codelineno-18-158"></a>        <span class="n">harness</span><span class="o">.</span><span class="n">then_events_match</span><span class="p">([{</span>
<a id="__codelineno-18-159" name="__codelineno-18-159" href="#__codelineno-18-159"></a>            <span class="s1">&#39;event_type&#39;</span><span class="p">:</span> <span class="s1">&#39;customer.created&#39;</span><span class="p">,</span>
<a id="__codelineno-18-160" name="__codelineno-18-160" href="#__codelineno-18-160"></a>            <span class="s1">&#39;payload&#39;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-18-161" name="__codelineno-18-161" href="#__codelineno-18-161"></a>                <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Jean Dupont&#39;</span><span class="p">,</span>
<a id="__codelineno-18-162" name="__codelineno-18-162" href="#__codelineno-18-162"></a>                <span class="s1">&#39;email&#39;</span><span class="p">:</span> <span class="s1">&#39;jean@example.com&#39;</span>
<a id="__codelineno-18-163" name="__codelineno-18-163" href="#__codelineno-18-163"></a>            <span class="p">}</span>
<a id="__codelineno-18-164" name="__codelineno-18-164" href="#__codelineno-18-164"></a>        <span class="p">}])</span>
<a id="__codelineno-18-165" name="__codelineno-18-165" href="#__codelineno-18-165"></a>
<a id="__codelineno-18-166" name="__codelineno-18-166" href="#__codelineno-18-166"></a>        <span class="k">await</span> <span class="n">harness</span><span class="o">.</span><span class="n">then_state_equals</span><span class="p">({</span>
<a id="__codelineno-18-167" name="__codelineno-18-167" href="#__codelineno-18-167"></a>            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Jean Dupont&#39;</span><span class="p">,</span>
<a id="__codelineno-18-168" name="__codelineno-18-168" href="#__codelineno-18-168"></a>            <span class="s1">&#39;email&#39;</span><span class="p">:</span> <span class="s1">&#39;jean@example.com&#39;</span><span class="p">,</span>
<a id="__codelineno-18-169" name="__codelineno-18-169" href="#__codelineno-18-169"></a>            <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;active&#39;</span>
<a id="__codelineno-18-170" name="__codelineno-18-170" href="#__codelineno-18-170"></a>        <span class="p">})</span>
<a id="__codelineno-18-171" name="__codelineno-18-171" href="#__codelineno-18-171"></a>
<a id="__codelineno-18-172" name="__codelineno-18-172" href="#__codelineno-18-172"></a>    <span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">asyncio</span>
<a id="__codelineno-18-173" name="__codelineno-18-173" href="#__codelineno-18-173"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">test_update_existing_customer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">harness</span><span class="p">):</span>
<a id="__codelineno-18-174" name="__codelineno-18-174" href="#__codelineno-18-174"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Test de mise à jour d&#39;un client existant&quot;&quot;&quot;</span>
<a id="__codelineno-18-175" name="__codelineno-18-175" href="#__codelineno-18-175"></a>
<a id="__codelineno-18-176" name="__codelineno-18-176" href="#__codelineno-18-176"></a>        <span class="k">await</span> <span class="n">harness</span><span class="o">.</span><span class="n">given</span><span class="p">([{</span>
<a id="__codelineno-18-177" name="__codelineno-18-177" href="#__codelineno-18-177"></a>            <span class="s1">&#39;event_type&#39;</span><span class="p">:</span> <span class="s1">&#39;customer.created&#39;</span><span class="p">,</span>
<a id="__codelineno-18-178" name="__codelineno-18-178" href="#__codelineno-18-178"></a>            <span class="s1">&#39;aggregate_id&#39;</span><span class="p">:</span> <span class="s1">&#39;cust-123&#39;</span><span class="p">,</span>
<a id="__codelineno-18-179" name="__codelineno-18-179" href="#__codelineno-18-179"></a>            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Jean Dupont&#39;</span><span class="p">,</span>
<a id="__codelineno-18-180" name="__codelineno-18-180" href="#__codelineno-18-180"></a>            <span class="s1">&#39;email&#39;</span><span class="p">:</span> <span class="s1">&#39;jean@example.com&#39;</span>
<a id="__codelineno-18-181" name="__codelineno-18-181" href="#__codelineno-18-181"></a>        <span class="p">}])</span>
<a id="__codelineno-18-182" name="__codelineno-18-182" href="#__codelineno-18-182"></a>
<a id="__codelineno-18-183" name="__codelineno-18-183" href="#__codelineno-18-183"></a>        <span class="k">await</span> <span class="n">harness</span><span class="o">.</span><span class="n">when</span><span class="p">({</span>
<a id="__codelineno-18-184" name="__codelineno-18-184" href="#__codelineno-18-184"></a>            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;update_contact&#39;</span><span class="p">,</span>
<a id="__codelineno-18-185" name="__codelineno-18-185" href="#__codelineno-18-185"></a>            <span class="s1">&#39;aggregate_id&#39;</span><span class="p">:</span> <span class="s1">&#39;cust-123&#39;</span><span class="p">,</span>
<a id="__codelineno-18-186" name="__codelineno-18-186" href="#__codelineno-18-186"></a>            <span class="s1">&#39;params&#39;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-18-187" name="__codelineno-18-187" href="#__codelineno-18-187"></a>                <span class="s1">&#39;email&#39;</span><span class="p">:</span> <span class="s1">&#39;jean.dupont@example.com&#39;</span>
<a id="__codelineno-18-188" name="__codelineno-18-188" href="#__codelineno-18-188"></a>            <span class="p">}</span>
<a id="__codelineno-18-189" name="__codelineno-18-189" href="#__codelineno-18-189"></a>        <span class="p">})</span>
<a id="__codelineno-18-190" name="__codelineno-18-190" href="#__codelineno-18-190"></a>
<a id="__codelineno-18-191" name="__codelineno-18-191" href="#__codelineno-18-191"></a>        <span class="n">harness</span><span class="o">.</span><span class="n">then_events_match</span><span class="p">([{</span>
<a id="__codelineno-18-192" name="__codelineno-18-192" href="#__codelineno-18-192"></a>            <span class="s1">&#39;event_type&#39;</span><span class="p">:</span> <span class="s1">&#39;customer.contact.updated&#39;</span><span class="p">,</span>
<a id="__codelineno-18-193" name="__codelineno-18-193" href="#__codelineno-18-193"></a>            <span class="s1">&#39;payload&#39;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-18-194" name="__codelineno-18-194" href="#__codelineno-18-194"></a>                <span class="s1">&#39;changes&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;email&#39;</span><span class="p">:</span> <span class="s1">&#39;jean.dupont@example.com&#39;</span><span class="p">}</span>
<a id="__codelineno-18-195" name="__codelineno-18-195" href="#__codelineno-18-195"></a>            <span class="p">}</span>
<a id="__codelineno-18-196" name="__codelineno-18-196" href="#__codelineno-18-196"></a>        <span class="p">}])</span>
<a id="__codelineno-18-197" name="__codelineno-18-197" href="#__codelineno-18-197"></a>
<a id="__codelineno-18-198" name="__codelineno-18-198" href="#__codelineno-18-198"></a>    <span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">asyncio</span>
<a id="__codelineno-18-199" name="__codelineno-18-199" href="#__codelineno-18-199"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">test_deactivate_inactive_customer_fails</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">harness</span><span class="p">):</span>
<a id="__codelineno-18-200" name="__codelineno-18-200" href="#__codelineno-18-200"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Test d&#39;échec de désactivation d&#39;un client déjà inactif&quot;&quot;&quot;</span>
<a id="__codelineno-18-201" name="__codelineno-18-201" href="#__codelineno-18-201"></a>
<a id="__codelineno-18-202" name="__codelineno-18-202" href="#__codelineno-18-202"></a>        <span class="k">await</span> <span class="n">harness</span><span class="o">.</span><span class="n">given</span><span class="p">([</span>
<a id="__codelineno-18-203" name="__codelineno-18-203" href="#__codelineno-18-203"></a>            <span class="p">{</span>
<a id="__codelineno-18-204" name="__codelineno-18-204" href="#__codelineno-18-204"></a>                <span class="s1">&#39;event_type&#39;</span><span class="p">:</span> <span class="s1">&#39;customer.created&#39;</span><span class="p">,</span>
<a id="__codelineno-18-205" name="__codelineno-18-205" href="#__codelineno-18-205"></a>                <span class="s1">&#39;aggregate_id&#39;</span><span class="p">:</span> <span class="s1">&#39;cust-123&#39;</span><span class="p">,</span>
<a id="__codelineno-18-206" name="__codelineno-18-206" href="#__codelineno-18-206"></a>                <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Jean Dupont&#39;</span><span class="p">,</span>
<a id="__codelineno-18-207" name="__codelineno-18-207" href="#__codelineno-18-207"></a>                <span class="s1">&#39;email&#39;</span><span class="p">:</span> <span class="s1">&#39;jean@example.com&#39;</span>
<a id="__codelineno-18-208" name="__codelineno-18-208" href="#__codelineno-18-208"></a>            <span class="p">},</span>
<a id="__codelineno-18-209" name="__codelineno-18-209" href="#__codelineno-18-209"></a>            <span class="p">{</span>
<a id="__codelineno-18-210" name="__codelineno-18-210" href="#__codelineno-18-210"></a>                <span class="s1">&#39;event_type&#39;</span><span class="p">:</span> <span class="s1">&#39;customer.deactivated&#39;</span><span class="p">,</span>
<a id="__codelineno-18-211" name="__codelineno-18-211" href="#__codelineno-18-211"></a>                <span class="s1">&#39;aggregate_id&#39;</span><span class="p">:</span> <span class="s1">&#39;cust-123&#39;</span><span class="p">,</span>
<a id="__codelineno-18-212" name="__codelineno-18-212" href="#__codelineno-18-212"></a>                <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="s1">&#39;Demande client&#39;</span>
<a id="__codelineno-18-213" name="__codelineno-18-213" href="#__codelineno-18-213"></a>            <span class="p">}</span>
<a id="__codelineno-18-214" name="__codelineno-18-214" href="#__codelineno-18-214"></a>        <span class="p">])</span>
<a id="__codelineno-18-215" name="__codelineno-18-215" href="#__codelineno-18-215"></a>
<a id="__codelineno-18-216" name="__codelineno-18-216" href="#__codelineno-18-216"></a>        <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="s2">&quot;n&#39;est pas actif&quot;</span><span class="p">):</span>
<a id="__codelineno-18-217" name="__codelineno-18-217" href="#__codelineno-18-217"></a>            <span class="k">await</span> <span class="n">harness</span><span class="o">.</span><span class="n">when</span><span class="p">({</span>
<a id="__codelineno-18-218" name="__codelineno-18-218" href="#__codelineno-18-218"></a>                <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;deactivate&#39;</span><span class="p">,</span>
<a id="__codelineno-18-219" name="__codelineno-18-219" href="#__codelineno-18-219"></a>                <span class="s1">&#39;aggregate_id&#39;</span><span class="p">:</span> <span class="s1">&#39;cust-123&#39;</span><span class="p">,</span>
<a id="__codelineno-18-220" name="__codelineno-18-220" href="#__codelineno-18-220"></a>                <span class="s1">&#39;params&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="s1">&#39;Autre raison&#39;</span><span class="p">}</span>
<a id="__codelineno-18-221" name="__codelineno-18-221" href="#__codelineno-18-221"></a>            <span class="p">})</span>
</code></pre></div>
<h3 id="tests-de-saga-avec-simulation">Tests de Saga avec Simulation<a class="headerlink" href="#tests-de-saga-avec-simulation" title="Permanent link">&para;</a></h3>
<p>Les tests de Saga nécessitent de simuler les interactions entre participants et de vérifier les compensations.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="c1"># tests/saga_tests.py</span>
<a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span>
<a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
<a id="__codelineno-19-5" name="__codelineno-19-5" href="#__codelineno-19-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<a id="__codelineno-19-6" name="__codelineno-19-6" href="#__codelineno-19-6"></a>
<a id="__codelineno-19-7" name="__codelineno-19-7" href="#__codelineno-19-7"></a><span class="nd">@dataclass</span>
<a id="__codelineno-19-8" name="__codelineno-19-8" href="#__codelineno-19-8"></a><span class="k">class</span><span class="w"> </span><span class="nc">SagaTestContext</span><span class="p">:</span>
<a id="__codelineno-19-9" name="__codelineno-19-9" href="#__codelineno-19-9"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Contexte de test pour les Sagas&quot;&quot;&quot;</span>
<a id="__codelineno-19-10" name="__codelineno-19-10" href="#__codelineno-19-10"></a>    <span class="n">saga_id</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-19-11" name="__codelineno-19-11" href="#__codelineno-19-11"></a>    <span class="n">published_events</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
<a id="__codelineno-19-12" name="__codelineno-19-12" href="#__codelineno-19-12"></a>    <span class="n">consumed_events</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
<a id="__codelineno-19-13" name="__codelineno-19-13" href="#__codelineno-19-13"></a>    <span class="n">compensations_triggered</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
<a id="__codelineno-19-14" name="__codelineno-19-14" href="#__codelineno-19-14"></a>
<a id="__codelineno-19-15" name="__codelineno-19-15" href="#__codelineno-19-15"></a>
<a id="__codelineno-19-16" name="__codelineno-19-16" href="#__codelineno-19-16"></a><span class="k">class</span><span class="w"> </span><span class="nc">SagaTestHarness</span><span class="p">:</span>
<a id="__codelineno-19-17" name="__codelineno-19-17" href="#__codelineno-19-17"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Harnais de test pour les Sagas Chorégraphiées&quot;&quot;&quot;</span>
<a id="__codelineno-19-18" name="__codelineno-19-18" href="#__codelineno-19-18"></a>
<a id="__codelineno-19-19" name="__codelineno-19-19" href="#__codelineno-19-19"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-19-20" name="__codelineno-19-20" href="#__codelineno-19-20"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">contexts</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">SagaTestContext</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-19-21" name="__codelineno-19-21" href="#__codelineno-19-21"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">participant_handlers</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">callable</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-19-22" name="__codelineno-19-22" href="#__codelineno-19-22"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">compensation_handlers</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">callable</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-19-23" name="__codelineno-19-23" href="#__codelineno-19-23"></a>
<a id="__codelineno-19-24" name="__codelineno-19-24" href="#__codelineno-19-24"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">register_participant</span><span class="p">(</span>
<a id="__codelineno-19-25" name="__codelineno-19-25" href="#__codelineno-19-25"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-19-26" name="__codelineno-19-26" href="#__codelineno-19-26"></a>        <span class="n">event_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-19-27" name="__codelineno-19-27" href="#__codelineno-19-27"></a>        <span class="n">handler</span><span class="p">:</span> <span class="nb">callable</span><span class="p">,</span>
<a id="__codelineno-19-28" name="__codelineno-19-28" href="#__codelineno-19-28"></a>        <span class="n">compensation_handler</span><span class="p">:</span> <span class="nb">callable</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-19-29" name="__codelineno-19-29" href="#__codelineno-19-29"></a>    <span class="p">):</span>
<a id="__codelineno-19-30" name="__codelineno-19-30" href="#__codelineno-19-30"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Enregistre un participant simulé&quot;&quot;&quot;</span>
<a id="__codelineno-19-31" name="__codelineno-19-31" href="#__codelineno-19-31"></a>
<a id="__codelineno-19-32" name="__codelineno-19-32" href="#__codelineno-19-32"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">participant_handlers</span><span class="p">[</span><span class="n">event_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">handler</span>
<a id="__codelineno-19-33" name="__codelineno-19-33" href="#__codelineno-19-33"></a>        <span class="k">if</span> <span class="n">compensation_handler</span><span class="p">:</span>
<a id="__codelineno-19-34" name="__codelineno-19-34" href="#__codelineno-19-34"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">compensation_handlers</span><span class="p">[</span><span class="n">event_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">compensation_handler</span>
<a id="__codelineno-19-35" name="__codelineno-19-35" href="#__codelineno-19-35"></a>
<a id="__codelineno-19-36" name="__codelineno-19-36" href="#__codelineno-19-36"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">start_saga</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">saga_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">initial_event</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SagaTestContext</span><span class="p">:</span>
<a id="__codelineno-19-37" name="__codelineno-19-37" href="#__codelineno-19-37"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Démarre une saga de test&quot;&quot;&quot;</span>
<a id="__codelineno-19-38" name="__codelineno-19-38" href="#__codelineno-19-38"></a>
<a id="__codelineno-19-39" name="__codelineno-19-39" href="#__codelineno-19-39"></a>        <span class="n">context</span> <span class="o">=</span> <span class="n">SagaTestContext</span><span class="p">(</span><span class="n">saga_id</span><span class="o">=</span><span class="n">saga_id</span><span class="p">)</span>
<a id="__codelineno-19-40" name="__codelineno-19-40" href="#__codelineno-19-40"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">contexts</span><span class="p">[</span><span class="n">saga_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">context</span>
<a id="__codelineno-19-41" name="__codelineno-19-41" href="#__codelineno-19-41"></a>
<a id="__codelineno-19-42" name="__codelineno-19-42" href="#__codelineno-19-42"></a>        <span class="n">initial_event</span><span class="p">[</span><span class="s1">&#39;saga_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">saga_id</span>
<a id="__codelineno-19-43" name="__codelineno-19-43" href="#__codelineno-19-43"></a>        <span class="n">initial_event</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
<a id="__codelineno-19-44" name="__codelineno-19-44" href="#__codelineno-19-44"></a>
<a id="__codelineno-19-45" name="__codelineno-19-45" href="#__codelineno-19-45"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_event</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">initial_event</span><span class="p">)</span>
<a id="__codelineno-19-46" name="__codelineno-19-46" href="#__codelineno-19-46"></a>
<a id="__codelineno-19-47" name="__codelineno-19-47" href="#__codelineno-19-47"></a>        <span class="k">return</span> <span class="n">context</span>
<a id="__codelineno-19-48" name="__codelineno-19-48" href="#__codelineno-19-48"></a>
<a id="__codelineno-19-49" name="__codelineno-19-49" href="#__codelineno-19-49"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_process_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">SagaTestContext</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-19-50" name="__codelineno-19-50" href="#__codelineno-19-50"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Traite un événement et propage la chaîne&quot;&quot;&quot;</span>
<a id="__codelineno-19-51" name="__codelineno-19-51" href="#__codelineno-19-51"></a>
<a id="__codelineno-19-52" name="__codelineno-19-52" href="#__codelineno-19-52"></a>        <span class="n">context</span><span class="o">.</span><span class="n">consumed_events</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
<a id="__codelineno-19-53" name="__codelineno-19-53" href="#__codelineno-19-53"></a>        <span class="n">event_type</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;event_type&#39;</span><span class="p">)</span>
<a id="__codelineno-19-54" name="__codelineno-19-54" href="#__codelineno-19-54"></a>
<a id="__codelineno-19-55" name="__codelineno-19-55" href="#__codelineno-19-55"></a>        <span class="c1"># Recherche du handler</span>
<a id="__codelineno-19-56" name="__codelineno-19-56" href="#__codelineno-19-56"></a>        <span class="n">handler</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">participant_handlers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">event_type</span><span class="p">)</span>
<a id="__codelineno-19-57" name="__codelineno-19-57" href="#__codelineno-19-57"></a>
<a id="__codelineno-19-58" name="__codelineno-19-58" href="#__codelineno-19-58"></a>        <span class="k">if</span> <span class="n">handler</span><span class="p">:</span>
<a id="__codelineno-19-59" name="__codelineno-19-59" href="#__codelineno-19-59"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-19-60" name="__codelineno-19-60" href="#__codelineno-19-60"></a>                <span class="n">result_events</span> <span class="o">=</span> <span class="k">await</span> <span class="n">handler</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
<a id="__codelineno-19-61" name="__codelineno-19-61" href="#__codelineno-19-61"></a>
<a id="__codelineno-19-62" name="__codelineno-19-62" href="#__codelineno-19-62"></a>                <span class="k">for</span> <span class="n">result_event</span> <span class="ow">in</span> <span class="n">result_events</span><span class="p">:</span>
<a id="__codelineno-19-63" name="__codelineno-19-63" href="#__codelineno-19-63"></a>                    <span class="n">result_event</span><span class="p">[</span><span class="s1">&#39;saga_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">saga_id</span>
<a id="__codelineno-19-64" name="__codelineno-19-64" href="#__codelineno-19-64"></a>                    <span class="n">context</span><span class="o">.</span><span class="n">published_events</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result_event</span><span class="p">)</span>
<a id="__codelineno-19-65" name="__codelineno-19-65" href="#__codelineno-19-65"></a>
<a id="__codelineno-19-66" name="__codelineno-19-66" href="#__codelineno-19-66"></a>                    <span class="c1"># Propagation récursive</span>
<a id="__codelineno-19-67" name="__codelineno-19-67" href="#__codelineno-19-67"></a>                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_event</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">result_event</span><span class="p">)</span>
<a id="__codelineno-19-68" name="__codelineno-19-68" href="#__codelineno-19-68"></a>
<a id="__codelineno-19-69" name="__codelineno-19-69" href="#__codelineno-19-69"></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-19-70" name="__codelineno-19-70" href="#__codelineno-19-70"></a>                <span class="c1"># Déclenchement des compensations</span>
<a id="__codelineno-19-71" name="__codelineno-19-71" href="#__codelineno-19-71"></a>                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trigger_compensations</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">event_type</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
<a id="__codelineno-19-72" name="__codelineno-19-72" href="#__codelineno-19-72"></a>
<a id="__codelineno-19-73" name="__codelineno-19-73" href="#__codelineno-19-73"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_trigger_compensations</span><span class="p">(</span>
<a id="__codelineno-19-74" name="__codelineno-19-74" href="#__codelineno-19-74"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-19-75" name="__codelineno-19-75" href="#__codelineno-19-75"></a>        <span class="n">context</span><span class="p">:</span> <span class="n">SagaTestContext</span><span class="p">,</span>
<a id="__codelineno-19-76" name="__codelineno-19-76" href="#__codelineno-19-76"></a>        <span class="n">failed_step</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-19-77" name="__codelineno-19-77" href="#__codelineno-19-77"></a>        <span class="n">error</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-19-78" name="__codelineno-19-78" href="#__codelineno-19-78"></a>    <span class="p">):</span>
<a id="__codelineno-19-79" name="__codelineno-19-79" href="#__codelineno-19-79"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Déclenche les compensations en ordre inverse&quot;&quot;&quot;</span>
<a id="__codelineno-19-80" name="__codelineno-19-80" href="#__codelineno-19-80"></a>
<a id="__codelineno-19-81" name="__codelineno-19-81" href="#__codelineno-19-81"></a>        <span class="c1"># Identification des étapes complétées</span>
<a id="__codelineno-19-82" name="__codelineno-19-82" href="#__codelineno-19-82"></a>        <span class="n">completed_types</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-19-83" name="__codelineno-19-83" href="#__codelineno-19-83"></a>            <span class="n">e</span><span class="p">[</span><span class="s1">&#39;event_type&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">context</span><span class="o">.</span><span class="n">consumed_events</span>
<a id="__codelineno-19-84" name="__codelineno-19-84" href="#__codelineno-19-84"></a>            <span class="k">if</span> <span class="n">e</span><span class="p">[</span><span class="s1">&#39;event_type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.completed&#39;</span><span class="p">)</span>
<a id="__codelineno-19-85" name="__codelineno-19-85" href="#__codelineno-19-85"></a>        <span class="p">]</span>
<a id="__codelineno-19-86" name="__codelineno-19-86" href="#__codelineno-19-86"></a>
<a id="__codelineno-19-87" name="__codelineno-19-87" href="#__codelineno-19-87"></a>        <span class="c1"># Compensation en ordre inverse</span>
<a id="__codelineno-19-88" name="__codelineno-19-88" href="#__codelineno-19-88"></a>        <span class="k">for</span> <span class="n">event_type</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">completed_types</span><span class="p">):</span>
<a id="__codelineno-19-89" name="__codelineno-19-89" href="#__codelineno-19-89"></a>            <span class="n">base_type</span> <span class="o">=</span> <span class="n">event_type</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.completed&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
<a id="__codelineno-19-90" name="__codelineno-19-90" href="#__codelineno-19-90"></a>            <span class="n">compensation_handler</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compensation_handlers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">base_type</span><span class="p">)</span>
<a id="__codelineno-19-91" name="__codelineno-19-91" href="#__codelineno-19-91"></a>
<a id="__codelineno-19-92" name="__codelineno-19-92" href="#__codelineno-19-92"></a>            <span class="k">if</span> <span class="n">compensation_handler</span><span class="p">:</span>
<a id="__codelineno-19-93" name="__codelineno-19-93" href="#__codelineno-19-93"></a>                <span class="n">context</span><span class="o">.</span><span class="n">compensations_triggered</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">base_type</span><span class="p">)</span>
<a id="__codelineno-19-94" name="__codelineno-19-94" href="#__codelineno-19-94"></a>                <span class="k">await</span> <span class="n">compensation_handler</span><span class="p">({</span><span class="s1">&#39;saga_id&#39;</span><span class="p">:</span> <span class="n">context</span><span class="o">.</span><span class="n">saga_id</span><span class="p">})</span>
<a id="__codelineno-19-95" name="__codelineno-19-95" href="#__codelineno-19-95"></a>
<a id="__codelineno-19-96" name="__codelineno-19-96" href="#__codelineno-19-96"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">assert_saga_completed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">SagaTestContext</span><span class="p">):</span>
<a id="__codelineno-19-97" name="__codelineno-19-97" href="#__codelineno-19-97"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Vérifie que la saga s&#39;est terminée avec succès&quot;&quot;&quot;</span>
<a id="__codelineno-19-98" name="__codelineno-19-98" href="#__codelineno-19-98"></a>
<a id="__codelineno-19-99" name="__codelineno-19-99" href="#__codelineno-19-99"></a>        <span class="n">final_events</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-19-100" name="__codelineno-19-100" href="#__codelineno-19-100"></a>            <span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">context</span><span class="o">.</span><span class="n">published_events</span>
<a id="__codelineno-19-101" name="__codelineno-19-101" href="#__codelineno-19-101"></a>            <span class="k">if</span> <span class="n">e</span><span class="p">[</span><span class="s1">&#39;event_type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.approved&#39;</span><span class="p">)</span> <span class="ow">or</span> 
<a id="__codelineno-19-102" name="__codelineno-19-102" href="#__codelineno-19-102"></a>               <span class="n">e</span><span class="p">[</span><span class="s1">&#39;event_type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.completed&#39;</span><span class="p">)</span>
<a id="__codelineno-19-103" name="__codelineno-19-103" href="#__codelineno-19-103"></a>        <span class="p">]</span>
<a id="__codelineno-19-104" name="__codelineno-19-104" href="#__codelineno-19-104"></a>
<a id="__codelineno-19-105" name="__codelineno-19-105" href="#__codelineno-19-105"></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">final_events</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Aucun événement de complétion trouvé&quot;</span>
<a id="__codelineno-19-106" name="__codelineno-19-106" href="#__codelineno-19-106"></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">compensations_triggered</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> \
<a id="__codelineno-19-107" name="__codelineno-19-107" href="#__codelineno-19-107"></a>            <span class="sa">f</span><span class="s2">&quot;Des compensations ont été déclenchées: </span><span class="si">{</span><span class="n">context</span><span class="o">.</span><span class="n">compensations_triggered</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-19-108" name="__codelineno-19-108" href="#__codelineno-19-108"></a>
<a id="__codelineno-19-109" name="__codelineno-19-109" href="#__codelineno-19-109"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">assert_saga_compensated</span><span class="p">(</span>
<a id="__codelineno-19-110" name="__codelineno-19-110" href="#__codelineno-19-110"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-19-111" name="__codelineno-19-111" href="#__codelineno-19-111"></a>        <span class="n">context</span><span class="p">:</span> <span class="n">SagaTestContext</span><span class="p">,</span>
<a id="__codelineno-19-112" name="__codelineno-19-112" href="#__codelineno-19-112"></a>        <span class="n">expected_compensations</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
<a id="__codelineno-19-113" name="__codelineno-19-113" href="#__codelineno-19-113"></a>    <span class="p">):</span>
<a id="__codelineno-19-114" name="__codelineno-19-114" href="#__codelineno-19-114"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Vérifie que la saga a été compensée correctement&quot;&quot;&quot;</span>
<a id="__codelineno-19-115" name="__codelineno-19-115" href="#__codelineno-19-115"></a>
<a id="__codelineno-19-116" name="__codelineno-19-116" href="#__codelineno-19-116"></a>        <span class="k">assert</span> <span class="nb">set</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">compensations_triggered</span><span class="p">)</span> <span class="o">==</span> <span class="nb">set</span><span class="p">(</span><span class="n">expected_compensations</span><span class="p">),</span> \
<a id="__codelineno-19-117" name="__codelineno-19-117" href="#__codelineno-19-117"></a>            <span class="sa">f</span><span class="s2">&quot;Compensations attendues: </span><span class="si">{</span><span class="n">expected_compensations</span><span class="si">}</span><span class="s2">, obtenues: </span><span class="si">{</span><span class="n">context</span><span class="o">.</span><span class="n">compensations_triggered</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-19-118" name="__codelineno-19-118" href="#__codelineno-19-118"></a>
<a id="__codelineno-19-119" name="__codelineno-19-119" href="#__codelineno-19-119"></a>
<a id="__codelineno-19-120" name="__codelineno-19-120" href="#__codelineno-19-120"></a><span class="k">class</span><span class="w"> </span><span class="nc">TestLoanApplicationSaga</span><span class="p">:</span>
<a id="__codelineno-19-121" name="__codelineno-19-121" href="#__codelineno-19-121"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Tests pour la Saga de demande de prêt&quot;&quot;&quot;</span>
<a id="__codelineno-19-122" name="__codelineno-19-122" href="#__codelineno-19-122"></a>
<a id="__codelineno-19-123" name="__codelineno-19-123" href="#__codelineno-19-123"></a>    <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<a id="__codelineno-19-124" name="__codelineno-19-124" href="#__codelineno-19-124"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">harness</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-19-125" name="__codelineno-19-125" href="#__codelineno-19-125"></a>        <span class="n">h</span> <span class="o">=</span> <span class="n">SagaTestHarness</span><span class="p">()</span>
<a id="__codelineno-19-126" name="__codelineno-19-126" href="#__codelineno-19-126"></a>
<a id="__codelineno-19-127" name="__codelineno-19-127" href="#__codelineno-19-127"></a>        <span class="c1"># Participant: Vérification de crédit</span>
<a id="__codelineno-19-128" name="__codelineno-19-128" href="#__codelineno-19-128"></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">credit_check_handler</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
<a id="__codelineno-19-129" name="__codelineno-19-129" href="#__codelineno-19-129"></a>            <span class="k">return</span> <span class="p">[{</span>
<a id="__codelineno-19-130" name="__codelineno-19-130" href="#__codelineno-19-130"></a>                <span class="s1">&#39;event_type&#39;</span><span class="p">:</span> <span class="s1">&#39;credit.check.completed&#39;</span><span class="p">,</span>
<a id="__codelineno-19-131" name="__codelineno-19-131" href="#__codelineno-19-131"></a>                <span class="s1">&#39;credit_score&#39;</span><span class="p">:</span> <span class="mi">750</span><span class="p">,</span>
<a id="__codelineno-19-132" name="__codelineno-19-132" href="#__codelineno-19-132"></a>                <span class="s1">&#39;approved&#39;</span><span class="p">:</span> <span class="kc">True</span>
<a id="__codelineno-19-133" name="__codelineno-19-133" href="#__codelineno-19-133"></a>            <span class="p">}]</span>
<a id="__codelineno-19-134" name="__codelineno-19-134" href="#__codelineno-19-134"></a>
<a id="__codelineno-19-135" name="__codelineno-19-135" href="#__codelineno-19-135"></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">credit_check_compensate</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
<a id="__codelineno-19-136" name="__codelineno-19-136" href="#__codelineno-19-136"></a>            <span class="k">pass</span>  <span class="c1"># Pas de compensation nécessaire</span>
<a id="__codelineno-19-137" name="__codelineno-19-137" href="#__codelineno-19-137"></a>
<a id="__codelineno-19-138" name="__codelineno-19-138" href="#__codelineno-19-138"></a>        <span class="c1"># Participant: Vérification documents</span>
<a id="__codelineno-19-139" name="__codelineno-19-139" href="#__codelineno-19-139"></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">doc_verification_handler</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
<a id="__codelineno-19-140" name="__codelineno-19-140" href="#__codelineno-19-140"></a>            <span class="k">return</span> <span class="p">[{</span>
<a id="__codelineno-19-141" name="__codelineno-19-141" href="#__codelineno-19-141"></a>                <span class="s1">&#39;event_type&#39;</span><span class="p">:</span> <span class="s1">&#39;document.verification.completed&#39;</span><span class="p">,</span>
<a id="__codelineno-19-142" name="__codelineno-19-142" href="#__codelineno-19-142"></a>                <span class="s1">&#39;verified&#39;</span><span class="p">:</span> <span class="kc">True</span>
<a id="__codelineno-19-143" name="__codelineno-19-143" href="#__codelineno-19-143"></a>            <span class="p">}]</span>
<a id="__codelineno-19-144" name="__codelineno-19-144" href="#__codelineno-19-144"></a>
<a id="__codelineno-19-145" name="__codelineno-19-145" href="#__codelineno-19-145"></a>        <span class="c1"># Participant: Décision finale</span>
<a id="__codelineno-19-146" name="__codelineno-19-146" href="#__codelineno-19-146"></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">decision_handler</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
<a id="__codelineno-19-147" name="__codelineno-19-147" href="#__codelineno-19-147"></a>            <span class="k">return</span> <span class="p">[{</span>
<a id="__codelineno-19-148" name="__codelineno-19-148" href="#__codelineno-19-148"></a>                <span class="s1">&#39;event_type&#39;</span><span class="p">:</span> <span class="s1">&#39;loan.approved&#39;</span><span class="p">,</span>
<a id="__codelineno-19-149" name="__codelineno-19-149" href="#__codelineno-19-149"></a>                <span class="s1">&#39;amount&#39;</span><span class="p">:</span> <span class="mi">50000</span><span class="p">,</span>
<a id="__codelineno-19-150" name="__codelineno-19-150" href="#__codelineno-19-150"></a>                <span class="s1">&#39;rate&#39;</span><span class="p">:</span> <span class="mf">5.5</span>
<a id="__codelineno-19-151" name="__codelineno-19-151" href="#__codelineno-19-151"></a>            <span class="p">}]</span>
<a id="__codelineno-19-152" name="__codelineno-19-152" href="#__codelineno-19-152"></a>
<a id="__codelineno-19-153" name="__codelineno-19-153" href="#__codelineno-19-153"></a>        <span class="n">h</span><span class="o">.</span><span class="n">register_participant</span><span class="p">(</span>
<a id="__codelineno-19-154" name="__codelineno-19-154" href="#__codelineno-19-154"></a>            <span class="s1">&#39;loan.application.started&#39;</span><span class="p">,</span>
<a id="__codelineno-19-155" name="__codelineno-19-155" href="#__codelineno-19-155"></a>            <span class="n">credit_check_handler</span><span class="p">,</span>
<a id="__codelineno-19-156" name="__codelineno-19-156" href="#__codelineno-19-156"></a>            <span class="n">credit_check_compensate</span>
<a id="__codelineno-19-157" name="__codelineno-19-157" href="#__codelineno-19-157"></a>        <span class="p">)</span>
<a id="__codelineno-19-158" name="__codelineno-19-158" href="#__codelineno-19-158"></a>        <span class="n">h</span><span class="o">.</span><span class="n">register_participant</span><span class="p">(</span>
<a id="__codelineno-19-159" name="__codelineno-19-159" href="#__codelineno-19-159"></a>            <span class="s1">&#39;credit.check.completed&#39;</span><span class="p">,</span>
<a id="__codelineno-19-160" name="__codelineno-19-160" href="#__codelineno-19-160"></a>            <span class="n">doc_verification_handler</span>
<a id="__codelineno-19-161" name="__codelineno-19-161" href="#__codelineno-19-161"></a>        <span class="p">)</span>
<a id="__codelineno-19-162" name="__codelineno-19-162" href="#__codelineno-19-162"></a>        <span class="n">h</span><span class="o">.</span><span class="n">register_participant</span><span class="p">(</span>
<a id="__codelineno-19-163" name="__codelineno-19-163" href="#__codelineno-19-163"></a>            <span class="s1">&#39;document.verification.completed&#39;</span><span class="p">,</span>
<a id="__codelineno-19-164" name="__codelineno-19-164" href="#__codelineno-19-164"></a>            <span class="n">decision_handler</span>
<a id="__codelineno-19-165" name="__codelineno-19-165" href="#__codelineno-19-165"></a>        <span class="p">)</span>
<a id="__codelineno-19-166" name="__codelineno-19-166" href="#__codelineno-19-166"></a>
<a id="__codelineno-19-167" name="__codelineno-19-167" href="#__codelineno-19-167"></a>        <span class="k">return</span> <span class="n">h</span>
<a id="__codelineno-19-168" name="__codelineno-19-168" href="#__codelineno-19-168"></a>
<a id="__codelineno-19-169" name="__codelineno-19-169" href="#__codelineno-19-169"></a>    <span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">asyncio</span>
<a id="__codelineno-19-170" name="__codelineno-19-170" href="#__codelineno-19-170"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">test_successful_loan_application</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">harness</span><span class="p">):</span>
<a id="__codelineno-19-171" name="__codelineno-19-171" href="#__codelineno-19-171"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Test d&#39;une demande de prêt réussie&quot;&quot;&quot;</span>
<a id="__codelineno-19-172" name="__codelineno-19-172" href="#__codelineno-19-172"></a>
<a id="__codelineno-19-173" name="__codelineno-19-173" href="#__codelineno-19-173"></a>        <span class="n">context</span> <span class="o">=</span> <span class="k">await</span> <span class="n">harness</span><span class="o">.</span><span class="n">start_saga</span><span class="p">(</span><span class="s1">&#39;saga-001&#39;</span><span class="p">,</span> <span class="p">{</span>
<a id="__codelineno-19-174" name="__codelineno-19-174" href="#__codelineno-19-174"></a>            <span class="s1">&#39;event_type&#39;</span><span class="p">:</span> <span class="s1">&#39;loan.application.started&#39;</span><span class="p">,</span>
<a id="__codelineno-19-175" name="__codelineno-19-175" href="#__codelineno-19-175"></a>            <span class="s1">&#39;applicant_id&#39;</span><span class="p">:</span> <span class="s1">&#39;app-123&#39;</span><span class="p">,</span>
<a id="__codelineno-19-176" name="__codelineno-19-176" href="#__codelineno-19-176"></a>            <span class="s1">&#39;amount&#39;</span><span class="p">:</span> <span class="mi">50000</span>
<a id="__codelineno-19-177" name="__codelineno-19-177" href="#__codelineno-19-177"></a>        <span class="p">})</span>
<a id="__codelineno-19-178" name="__codelineno-19-178" href="#__codelineno-19-178"></a>
<a id="__codelineno-19-179" name="__codelineno-19-179" href="#__codelineno-19-179"></a>        <span class="n">harness</span><span class="o">.</span><span class="n">assert_saga_completed</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
<a id="__codelineno-19-180" name="__codelineno-19-180" href="#__codelineno-19-180"></a>
<a id="__codelineno-19-181" name="__codelineno-19-181" href="#__codelineno-19-181"></a>        <span class="c1"># Vérification des événements produits</span>
<a id="__codelineno-19-182" name="__codelineno-19-182" href="#__codelineno-19-182"></a>        <span class="n">event_types</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span><span class="p">[</span><span class="s1">&#39;event_type&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">context</span><span class="o">.</span><span class="n">published_events</span><span class="p">]</span>
<a id="__codelineno-19-183" name="__codelineno-19-183" href="#__codelineno-19-183"></a>        <span class="k">assert</span> <span class="s1">&#39;credit.check.completed&#39;</span> <span class="ow">in</span> <span class="n">event_types</span>
<a id="__codelineno-19-184" name="__codelineno-19-184" href="#__codelineno-19-184"></a>        <span class="k">assert</span> <span class="s1">&#39;document.verification.completed&#39;</span> <span class="ow">in</span> <span class="n">event_types</span>
<a id="__codelineno-19-185" name="__codelineno-19-185" href="#__codelineno-19-185"></a>        <span class="k">assert</span> <span class="s1">&#39;loan.approved&#39;</span> <span class="ow">in</span> <span class="n">event_types</span>
<a id="__codelineno-19-186" name="__codelineno-19-186" href="#__codelineno-19-186"></a>
<a id="__codelineno-19-187" name="__codelineno-19-187" href="#__codelineno-19-187"></a>    <span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">asyncio</span>
<a id="__codelineno-19-188" name="__codelineno-19-188" href="#__codelineno-19-188"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">test_loan_rejected_triggers_compensation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-19-189" name="__codelineno-19-189" href="#__codelineno-19-189"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Test de rejet avec compensation&quot;&quot;&quot;</span>
<a id="__codelineno-19-190" name="__codelineno-19-190" href="#__codelineno-19-190"></a>
<a id="__codelineno-19-191" name="__codelineno-19-191" href="#__codelineno-19-191"></a>        <span class="n">harness</span> <span class="o">=</span> <span class="n">SagaTestHarness</span><span class="p">()</span>
<a id="__codelineno-19-192" name="__codelineno-19-192" href="#__codelineno-19-192"></a>
<a id="__codelineno-19-193" name="__codelineno-19-193" href="#__codelineno-19-193"></a>        <span class="c1"># Credit check OK</span>
<a id="__codelineno-19-194" name="__codelineno-19-194" href="#__codelineno-19-194"></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">credit_ok</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
<a id="__codelineno-19-195" name="__codelineno-19-195" href="#__codelineno-19-195"></a>            <span class="k">return</span> <span class="p">[{</span><span class="s1">&#39;event_type&#39;</span><span class="p">:</span> <span class="s1">&#39;credit.check.completed&#39;</span><span class="p">,</span> <span class="s1">&#39;approved&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}]</span>
<a id="__codelineno-19-196" name="__codelineno-19-196" href="#__codelineno-19-196"></a>
<a id="__codelineno-19-197" name="__codelineno-19-197" href="#__codelineno-19-197"></a>        <span class="c1"># Doc verification échoue</span>
<a id="__codelineno-19-198" name="__codelineno-19-198" href="#__codelineno-19-198"></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">doc_fails</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
<a id="__codelineno-19-199" name="__codelineno-19-199" href="#__codelineno-19-199"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Documents invalides&quot;</span><span class="p">)</span>
<a id="__codelineno-19-200" name="__codelineno-19-200" href="#__codelineno-19-200"></a>
<a id="__codelineno-19-201" name="__codelineno-19-201" href="#__codelineno-19-201"></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">credit_compensate</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
<a id="__codelineno-19-202" name="__codelineno-19-202" href="#__codelineno-19-202"></a>            <span class="k">pass</span>
<a id="__codelineno-19-203" name="__codelineno-19-203" href="#__codelineno-19-203"></a>
<a id="__codelineno-19-204" name="__codelineno-19-204" href="#__codelineno-19-204"></a>        <span class="n">harness</span><span class="o">.</span><span class="n">register_participant</span><span class="p">(</span>
<a id="__codelineno-19-205" name="__codelineno-19-205" href="#__codelineno-19-205"></a>            <span class="s1">&#39;loan.application.started&#39;</span><span class="p">,</span>
<a id="__codelineno-19-206" name="__codelineno-19-206" href="#__codelineno-19-206"></a>            <span class="n">credit_ok</span><span class="p">,</span>
<a id="__codelineno-19-207" name="__codelineno-19-207" href="#__codelineno-19-207"></a>            <span class="n">credit_compensate</span>
<a id="__codelineno-19-208" name="__codelineno-19-208" href="#__codelineno-19-208"></a>        <span class="p">)</span>
<a id="__codelineno-19-209" name="__codelineno-19-209" href="#__codelineno-19-209"></a>        <span class="n">harness</span><span class="o">.</span><span class="n">register_participant</span><span class="p">(</span>
<a id="__codelineno-19-210" name="__codelineno-19-210" href="#__codelineno-19-210"></a>            <span class="s1">&#39;credit.check.completed&#39;</span><span class="p">,</span>
<a id="__codelineno-19-211" name="__codelineno-19-211" href="#__codelineno-19-211"></a>            <span class="n">doc_fails</span>
<a id="__codelineno-19-212" name="__codelineno-19-212" href="#__codelineno-19-212"></a>        <span class="p">)</span>
<a id="__codelineno-19-213" name="__codelineno-19-213" href="#__codelineno-19-213"></a>
<a id="__codelineno-19-214" name="__codelineno-19-214" href="#__codelineno-19-214"></a>        <span class="n">context</span> <span class="o">=</span> <span class="k">await</span> <span class="n">harness</span><span class="o">.</span><span class="n">start_saga</span><span class="p">(</span><span class="s1">&#39;saga-002&#39;</span><span class="p">,</span> <span class="p">{</span>
<a id="__codelineno-19-215" name="__codelineno-19-215" href="#__codelineno-19-215"></a>            <span class="s1">&#39;event_type&#39;</span><span class="p">:</span> <span class="s1">&#39;loan.application.started&#39;</span><span class="p">,</span>
<a id="__codelineno-19-216" name="__codelineno-19-216" href="#__codelineno-19-216"></a>            <span class="s1">&#39;applicant_id&#39;</span><span class="p">:</span> <span class="s1">&#39;app-456&#39;</span>
<a id="__codelineno-19-217" name="__codelineno-19-217" href="#__codelineno-19-217"></a>        <span class="p">})</span>
<a id="__codelineno-19-218" name="__codelineno-19-218" href="#__codelineno-19-218"></a>
<a id="__codelineno-19-219" name="__codelineno-19-219" href="#__codelineno-19-219"></a>        <span class="n">harness</span><span class="o">.</span><span class="n">assert_saga_compensated</span><span class="p">(</span>
<a id="__codelineno-19-220" name="__codelineno-19-220" href="#__codelineno-19-220"></a>            <span class="n">context</span><span class="p">,</span>
<a id="__codelineno-19-221" name="__codelineno-19-221" href="#__codelineno-19-221"></a>            <span class="n">expected_compensations</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;loan.application.started&#39;</span><span class="p">]</span>
<a id="__codelineno-19-222" name="__codelineno-19-222" href="#__codelineno-19-222"></a>        <span class="p">)</span>
</code></pre></div>
<hr />
<h2 id="ii98-metriques-et-observabilite-des-patrons">II.9.8 Métriques et Observabilité des Patrons<a class="headerlink" href="#ii98-metriques-et-observabilite-des-patrons" title="Permanent link">&para;</a></h2>
<h3 id="indicateurs-cles-de-performance">Indicateurs Clés de Performance<a class="headerlink" href="#indicateurs-cles-de-performance" title="Permanent link">&para;</a></h3>
<p>Chaque patron architectural génère des métriques spécifiques qui doivent être surveillées pour garantir la santé du système.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="c1"># observability/pattern_metrics.py</span>
<a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">prometheus_client</span><span class="w"> </span><span class="kn">import</span> <span class="n">Counter</span><span class="p">,</span> <span class="n">Histogram</span><span class="p">,</span> <span class="n">Gauge</span>
<a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span>
<a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a>
<a id="__codelineno-20-6" name="__codelineno-20-6" href="#__codelineno-20-6"></a><span class="c1"># Métriques Saga</span>
<a id="__codelineno-20-7" name="__codelineno-20-7" href="#__codelineno-20-7"></a><span class="n">saga_started_total</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span>
<a id="__codelineno-20-8" name="__codelineno-20-8" href="#__codelineno-20-8"></a>    <span class="s1">&#39;saga_started_total&#39;</span><span class="p">,</span>
<a id="__codelineno-20-9" name="__codelineno-20-9" href="#__codelineno-20-9"></a>    <span class="s1">&#39;Nombre total de Sagas démarrées&#39;</span><span class="p">,</span>
<a id="__codelineno-20-10" name="__codelineno-20-10" href="#__codelineno-20-10"></a>    <span class="p">[</span><span class="s1">&#39;saga_type&#39;</span><span class="p">]</span>
<a id="__codelineno-20-11" name="__codelineno-20-11" href="#__codelineno-20-11"></a><span class="p">)</span>
<a id="__codelineno-20-12" name="__codelineno-20-12" href="#__codelineno-20-12"></a>
<a id="__codelineno-20-13" name="__codelineno-20-13" href="#__codelineno-20-13"></a><span class="n">saga_completed_total</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span>
<a id="__codelineno-20-14" name="__codelineno-20-14" href="#__codelineno-20-14"></a>    <span class="s1">&#39;saga_completed_total&#39;</span><span class="p">,</span>
<a id="__codelineno-20-15" name="__codelineno-20-15" href="#__codelineno-20-15"></a>    <span class="s1">&#39;Nombre de Sagas complétées avec succès&#39;</span><span class="p">,</span>
<a id="__codelineno-20-16" name="__codelineno-20-16" href="#__codelineno-20-16"></a>    <span class="p">[</span><span class="s1">&#39;saga_type&#39;</span><span class="p">]</span>
<a id="__codelineno-20-17" name="__codelineno-20-17" href="#__codelineno-20-17"></a><span class="p">)</span>
<a id="__codelineno-20-18" name="__codelineno-20-18" href="#__codelineno-20-18"></a>
<a id="__codelineno-20-19" name="__codelineno-20-19" href="#__codelineno-20-19"></a><span class="n">saga_compensated_total</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span>
<a id="__codelineno-20-20" name="__codelineno-20-20" href="#__codelineno-20-20"></a>    <span class="s1">&#39;saga_compensated_total&#39;</span><span class="p">,</span>
<a id="__codelineno-20-21" name="__codelineno-20-21" href="#__codelineno-20-21"></a>    <span class="s1">&#39;Nombre de Sagas compensées&#39;</span><span class="p">,</span>
<a id="__codelineno-20-22" name="__codelineno-20-22" href="#__codelineno-20-22"></a>    <span class="p">[</span><span class="s1">&#39;saga_type&#39;</span><span class="p">,</span> <span class="s1">&#39;failed_step&#39;</span><span class="p">]</span>
<a id="__codelineno-20-23" name="__codelineno-20-23" href="#__codelineno-20-23"></a><span class="p">)</span>
<a id="__codelineno-20-24" name="__codelineno-20-24" href="#__codelineno-20-24"></a>
<a id="__codelineno-20-25" name="__codelineno-20-25" href="#__codelineno-20-25"></a><span class="n">saga_duration_seconds</span> <span class="o">=</span> <span class="n">Histogram</span><span class="p">(</span>
<a id="__codelineno-20-26" name="__codelineno-20-26" href="#__codelineno-20-26"></a>    <span class="s1">&#39;saga_duration_seconds&#39;</span><span class="p">,</span>
<a id="__codelineno-20-27" name="__codelineno-20-27" href="#__codelineno-20-27"></a>    <span class="s1">&#39;Durée des Sagas en secondes&#39;</span><span class="p">,</span>
<a id="__codelineno-20-28" name="__codelineno-20-28" href="#__codelineno-20-28"></a>    <span class="p">[</span><span class="s1">&#39;saga_type&#39;</span><span class="p">,</span> <span class="s1">&#39;outcome&#39;</span><span class="p">],</span>
<a id="__codelineno-20-29" name="__codelineno-20-29" href="#__codelineno-20-29"></a>    <span class="n">buckets</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">600</span><span class="p">]</span>
<a id="__codelineno-20-30" name="__codelineno-20-30" href="#__codelineno-20-30"></a><span class="p">)</span>
<a id="__codelineno-20-31" name="__codelineno-20-31" href="#__codelineno-20-31"></a>
<a id="__codelineno-20-32" name="__codelineno-20-32" href="#__codelineno-20-32"></a><span class="n">saga_active_count</span> <span class="o">=</span> <span class="n">Gauge</span><span class="p">(</span>
<a id="__codelineno-20-33" name="__codelineno-20-33" href="#__codelineno-20-33"></a>    <span class="s1">&#39;saga_active_count&#39;</span><span class="p">,</span>
<a id="__codelineno-20-34" name="__codelineno-20-34" href="#__codelineno-20-34"></a>    <span class="s1">&#39;Nombre de Sagas actuellement en cours&#39;</span><span class="p">,</span>
<a id="__codelineno-20-35" name="__codelineno-20-35" href="#__codelineno-20-35"></a>    <span class="p">[</span><span class="s1">&#39;saga_type&#39;</span><span class="p">]</span>
<a id="__codelineno-20-36" name="__codelineno-20-36" href="#__codelineno-20-36"></a><span class="p">)</span>
<a id="__codelineno-20-37" name="__codelineno-20-37" href="#__codelineno-20-37"></a>
<a id="__codelineno-20-38" name="__codelineno-20-38" href="#__codelineno-20-38"></a><span class="c1"># Métriques Event Sourcing</span>
<a id="__codelineno-20-39" name="__codelineno-20-39" href="#__codelineno-20-39"></a><span class="n">events_appended_total</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span>
<a id="__codelineno-20-40" name="__codelineno-20-40" href="#__codelineno-20-40"></a>    <span class="s1">&#39;events_appended_total&#39;</span><span class="p">,</span>
<a id="__codelineno-20-41" name="__codelineno-20-41" href="#__codelineno-20-41"></a>    <span class="s1">&#39;Nombre total d</span><span class="se">\&#39;</span><span class="s1">événements ajoutés&#39;</span><span class="p">,</span>
<a id="__codelineno-20-42" name="__codelineno-20-42" href="#__codelineno-20-42"></a>    <span class="p">[</span><span class="s1">&#39;aggregate_type&#39;</span><span class="p">,</span> <span class="s1">&#39;event_type&#39;</span><span class="p">]</span>
<a id="__codelineno-20-43" name="__codelineno-20-43" href="#__codelineno-20-43"></a><span class="p">)</span>
<a id="__codelineno-20-44" name="__codelineno-20-44" href="#__codelineno-20-44"></a>
<a id="__codelineno-20-45" name="__codelineno-20-45" href="#__codelineno-20-45"></a><span class="n">aggregate_load_duration_seconds</span> <span class="o">=</span> <span class="n">Histogram</span><span class="p">(</span>
<a id="__codelineno-20-46" name="__codelineno-20-46" href="#__codelineno-20-46"></a>    <span class="s1">&#39;aggregate_load_duration_seconds&#39;</span><span class="p">,</span>
<a id="__codelineno-20-47" name="__codelineno-20-47" href="#__codelineno-20-47"></a>    <span class="s1">&#39;Temps de chargement des agrégats&#39;</span><span class="p">,</span>
<a id="__codelineno-20-48" name="__codelineno-20-48" href="#__codelineno-20-48"></a>    <span class="p">[</span><span class="s1">&#39;aggregate_type&#39;</span><span class="p">,</span> <span class="s1">&#39;from_snapshot&#39;</span><span class="p">],</span>
<a id="__codelineno-20-49" name="__codelineno-20-49" href="#__codelineno-20-49"></a>    <span class="n">buckets</span><span class="o">=</span><span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>
<a id="__codelineno-20-50" name="__codelineno-20-50" href="#__codelineno-20-50"></a><span class="p">)</span>
<a id="__codelineno-20-51" name="__codelineno-20-51" href="#__codelineno-20-51"></a>
<a id="__codelineno-20-52" name="__codelineno-20-52" href="#__codelineno-20-52"></a><span class="n">snapshot_created_total</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span>
<a id="__codelineno-20-53" name="__codelineno-20-53" href="#__codelineno-20-53"></a>    <span class="s1">&#39;snapshot_created_total&#39;</span><span class="p">,</span>
<a id="__codelineno-20-54" name="__codelineno-20-54" href="#__codelineno-20-54"></a>    <span class="s1">&#39;Nombre de snapshots créés&#39;</span><span class="p">,</span>
<a id="__codelineno-20-55" name="__codelineno-20-55" href="#__codelineno-20-55"></a>    <span class="p">[</span><span class="s1">&#39;aggregate_type&#39;</span><span class="p">]</span>
<a id="__codelineno-20-56" name="__codelineno-20-56" href="#__codelineno-20-56"></a><span class="p">)</span>
<a id="__codelineno-20-57" name="__codelineno-20-57" href="#__codelineno-20-57"></a>
<a id="__codelineno-20-58" name="__codelineno-20-58" href="#__codelineno-20-58"></a><span class="n">events_since_snapshot</span> <span class="o">=</span> <span class="n">Histogram</span><span class="p">(</span>
<a id="__codelineno-20-59" name="__codelineno-20-59" href="#__codelineno-20-59"></a>    <span class="s1">&#39;events_since_snapshot&#39;</span><span class="p">,</span>
<a id="__codelineno-20-60" name="__codelineno-20-60" href="#__codelineno-20-60"></a>    <span class="s1">&#39;Nombre d</span><span class="se">\&#39;</span><span class="s1">événements rejoués depuis le snapshot&#39;</span><span class="p">,</span>
<a id="__codelineno-20-61" name="__codelineno-20-61" href="#__codelineno-20-61"></a>    <span class="p">[</span><span class="s1">&#39;aggregate_type&#39;</span><span class="p">],</span>
<a id="__codelineno-20-62" name="__codelineno-20-62" href="#__codelineno-20-62"></a>    <span class="n">buckets</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="mi">1000</span><span class="p">]</span>
<a id="__codelineno-20-63" name="__codelineno-20-63" href="#__codelineno-20-63"></a><span class="p">)</span>
<a id="__codelineno-20-64" name="__codelineno-20-64" href="#__codelineno-20-64"></a>
<a id="__codelineno-20-65" name="__codelineno-20-65" href="#__codelineno-20-65"></a><span class="c1"># Métriques CQRS</span>
<a id="__codelineno-20-66" name="__codelineno-20-66" href="#__codelineno-20-66"></a><span class="n">projection_lag_seconds</span> <span class="o">=</span> <span class="n">Gauge</span><span class="p">(</span>
<a id="__codelineno-20-67" name="__codelineno-20-67" href="#__codelineno-20-67"></a>    <span class="s1">&#39;projection_lag_seconds&#39;</span><span class="p">,</span>
<a id="__codelineno-20-68" name="__codelineno-20-68" href="#__codelineno-20-68"></a>    <span class="s1">&#39;Retard de la projection par rapport au write model&#39;</span><span class="p">,</span>
<a id="__codelineno-20-69" name="__codelineno-20-69" href="#__codelineno-20-69"></a>    <span class="p">[</span><span class="s1">&#39;projector_name&#39;</span><span class="p">]</span>
<a id="__codelineno-20-70" name="__codelineno-20-70" href="#__codelineno-20-70"></a><span class="p">)</span>
<a id="__codelineno-20-71" name="__codelineno-20-71" href="#__codelineno-20-71"></a>
<a id="__codelineno-20-72" name="__codelineno-20-72" href="#__codelineno-20-72"></a><span class="n">projection_events_processed</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span>
<a id="__codelineno-20-73" name="__codelineno-20-73" href="#__codelineno-20-73"></a>    <span class="s1">&#39;projection_events_processed_total&#39;</span><span class="p">,</span>
<a id="__codelineno-20-74" name="__codelineno-20-74" href="#__codelineno-20-74"></a>    <span class="s1">&#39;Événements traités par les projecteurs&#39;</span><span class="p">,</span>
<a id="__codelineno-20-75" name="__codelineno-20-75" href="#__codelineno-20-75"></a>    <span class="p">[</span><span class="s1">&#39;projector_name&#39;</span><span class="p">,</span> <span class="s1">&#39;event_type&#39;</span><span class="p">]</span>
<a id="__codelineno-20-76" name="__codelineno-20-76" href="#__codelineno-20-76"></a><span class="p">)</span>
<a id="__codelineno-20-77" name="__codelineno-20-77" href="#__codelineno-20-77"></a>
<a id="__codelineno-20-78" name="__codelineno-20-78" href="#__codelineno-20-78"></a><span class="n">read_model_queries_total</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span>
<a id="__codelineno-20-79" name="__codelineno-20-79" href="#__codelineno-20-79"></a>    <span class="s1">&#39;read_model_queries_total&#39;</span><span class="p">,</span>
<a id="__codelineno-20-80" name="__codelineno-20-80" href="#__codelineno-20-80"></a>    <span class="s1">&#39;Requêtes sur les modèles de lecture&#39;</span><span class="p">,</span>
<a id="__codelineno-20-81" name="__codelineno-20-81" href="#__codelineno-20-81"></a>    <span class="p">[</span><span class="s1">&#39;view_name&#39;</span><span class="p">]</span>
<a id="__codelineno-20-82" name="__codelineno-20-82" href="#__codelineno-20-82"></a><span class="p">)</span>
<a id="__codelineno-20-83" name="__codelineno-20-83" href="#__codelineno-20-83"></a>
<a id="__codelineno-20-84" name="__codelineno-20-84" href="#__codelineno-20-84"></a><span class="n">read_model_query_duration</span> <span class="o">=</span> <span class="n">Histogram</span><span class="p">(</span>
<a id="__codelineno-20-85" name="__codelineno-20-85" href="#__codelineno-20-85"></a>    <span class="s1">&#39;read_model_query_duration_seconds&#39;</span><span class="p">,</span>
<a id="__codelineno-20-86" name="__codelineno-20-86" href="#__codelineno-20-86"></a>    <span class="s1">&#39;Durée des requêtes read model&#39;</span><span class="p">,</span>
<a id="__codelineno-20-87" name="__codelineno-20-87" href="#__codelineno-20-87"></a>    <span class="p">[</span><span class="s1">&#39;view_name&#39;</span><span class="p">],</span>
<a id="__codelineno-20-88" name="__codelineno-20-88" href="#__codelineno-20-88"></a>    <span class="n">buckets</span><span class="o">=</span><span class="p">[</span><span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.005</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">]</span>
<a id="__codelineno-20-89" name="__codelineno-20-89" href="#__codelineno-20-89"></a><span class="p">)</span>
<a id="__codelineno-20-90" name="__codelineno-20-90" href="#__codelineno-20-90"></a>
<a id="__codelineno-20-91" name="__codelineno-20-91" href="#__codelineno-20-91"></a><span class="c1"># Métriques Outbox</span>
<a id="__codelineno-20-92" name="__codelineno-20-92" href="#__codelineno-20-92"></a><span class="n">outbox_pending_count</span> <span class="o">=</span> <span class="n">Gauge</span><span class="p">(</span>
<a id="__codelineno-20-93" name="__codelineno-20-93" href="#__codelineno-20-93"></a>    <span class="s1">&#39;outbox_pending_count&#39;</span><span class="p">,</span>
<a id="__codelineno-20-94" name="__codelineno-20-94" href="#__codelineno-20-94"></a>    <span class="s1">&#39;Nombre de messages en attente dans l</span><span class="se">\&#39;</span><span class="s1">outbox&#39;</span>
<a id="__codelineno-20-95" name="__codelineno-20-95" href="#__codelineno-20-95"></a><span class="p">)</span>
<a id="__codelineno-20-96" name="__codelineno-20-96" href="#__codelineno-20-96"></a>
<a id="__codelineno-20-97" name="__codelineno-20-97" href="#__codelineno-20-97"></a><span class="n">outbox_publish_duration</span> <span class="o">=</span> <span class="n">Histogram</span><span class="p">(</span>
<a id="__codelineno-20-98" name="__codelineno-20-98" href="#__codelineno-20-98"></a>    <span class="s1">&#39;outbox_publish_duration_seconds&#39;</span><span class="p">,</span>
<a id="__codelineno-20-99" name="__codelineno-20-99" href="#__codelineno-20-99"></a>    <span class="s1">&#39;Temps de publication depuis l</span><span class="se">\&#39;</span><span class="s1">outbox&#39;</span><span class="p">,</span>
<a id="__codelineno-20-100" name="__codelineno-20-100" href="#__codelineno-20-100"></a>    <span class="n">buckets</span><span class="o">=</span><span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>
<a id="__codelineno-20-101" name="__codelineno-20-101" href="#__codelineno-20-101"></a><span class="p">)</span>
<a id="__codelineno-20-102" name="__codelineno-20-102" href="#__codelineno-20-102"></a>
<a id="__codelineno-20-103" name="__codelineno-20-103" href="#__codelineno-20-103"></a><span class="n">outbox_failures_total</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span>
<a id="__codelineno-20-104" name="__codelineno-20-104" href="#__codelineno-20-104"></a>    <span class="s1">&#39;outbox_failures_total&#39;</span><span class="p">,</span>
<a id="__codelineno-20-105" name="__codelineno-20-105" href="#__codelineno-20-105"></a>    <span class="s1">&#39;Échecs de publication depuis l</span><span class="se">\&#39;</span><span class="s1">outbox&#39;</span><span class="p">,</span>
<a id="__codelineno-20-106" name="__codelineno-20-106" href="#__codelineno-20-106"></a>    <span class="p">[</span><span class="s1">&#39;error_type&#39;</span><span class="p">]</span>
<a id="__codelineno-20-107" name="__codelineno-20-107" href="#__codelineno-20-107"></a><span class="p">)</span>
<a id="__codelineno-20-108" name="__codelineno-20-108" href="#__codelineno-20-108"></a>
<a id="__codelineno-20-109" name="__codelineno-20-109" href="#__codelineno-20-109"></a><span class="c1"># Métriques Résilience</span>
<a id="__codelineno-20-110" name="__codelineno-20-110" href="#__codelineno-20-110"></a><span class="n">circuit_breaker_state</span> <span class="o">=</span> <span class="n">Gauge</span><span class="p">(</span>
<a id="__codelineno-20-111" name="__codelineno-20-111" href="#__codelineno-20-111"></a>    <span class="s1">&#39;circuit_breaker_state&#39;</span><span class="p">,</span>
<a id="__codelineno-20-112" name="__codelineno-20-112" href="#__codelineno-20-112"></a>    <span class="s1">&#39;État du circuit breaker (0=closed, 1=half-open, 2=open)&#39;</span><span class="p">,</span>
<a id="__codelineno-20-113" name="__codelineno-20-113" href="#__codelineno-20-113"></a>    <span class="p">[</span><span class="s1">&#39;circuit_name&#39;</span><span class="p">]</span>
<a id="__codelineno-20-114" name="__codelineno-20-114" href="#__codelineno-20-114"></a><span class="p">)</span>
<a id="__codelineno-20-115" name="__codelineno-20-115" href="#__codelineno-20-115"></a>
<a id="__codelineno-20-116" name="__codelineno-20-116" href="#__codelineno-20-116"></a><span class="n">retry_attempts_total</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span>
<a id="__codelineno-20-117" name="__codelineno-20-117" href="#__codelineno-20-117"></a>    <span class="s1">&#39;retry_attempts_total&#39;</span><span class="p">,</span>
<a id="__codelineno-20-118" name="__codelineno-20-118" href="#__codelineno-20-118"></a>    <span class="s1">&#39;Nombre de tentatives de retry&#39;</span><span class="p">,</span>
<a id="__codelineno-20-119" name="__codelineno-20-119" href="#__codelineno-20-119"></a>    <span class="p">[</span><span class="s1">&#39;operation&#39;</span><span class="p">,</span> <span class="s1">&#39;attempt_number&#39;</span><span class="p">]</span>
<a id="__codelineno-20-120" name="__codelineno-20-120" href="#__codelineno-20-120"></a><span class="p">)</span>
<a id="__codelineno-20-121" name="__codelineno-20-121" href="#__codelineno-20-121"></a>
<a id="__codelineno-20-122" name="__codelineno-20-122" href="#__codelineno-20-122"></a><span class="n">dlq_messages_total</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span>
<a id="__codelineno-20-123" name="__codelineno-20-123" href="#__codelineno-20-123"></a>    <span class="s1">&#39;dlq_messages_total&#39;</span><span class="p">,</span>
<a id="__codelineno-20-124" name="__codelineno-20-124" href="#__codelineno-20-124"></a>    <span class="s1">&#39;Messages envoyés en DLQ&#39;</span><span class="p">,</span>
<a id="__codelineno-20-125" name="__codelineno-20-125" href="#__codelineno-20-125"></a>    <span class="p">[</span><span class="s1">&#39;source_topic&#39;</span><span class="p">,</span> <span class="s1">&#39;error_type&#39;</span><span class="p">]</span>
<a id="__codelineno-20-126" name="__codelineno-20-126" href="#__codelineno-20-126"></a><span class="p">)</span>
<a id="__codelineno-20-127" name="__codelineno-20-127" href="#__codelineno-20-127"></a>
<a id="__codelineno-20-128" name="__codelineno-20-128" href="#__codelineno-20-128"></a>
<a id="__codelineno-20-129" name="__codelineno-20-129" href="#__codelineno-20-129"></a><span class="k">class</span><span class="w"> </span><span class="nc">PatternMetricsCollector</span><span class="p">:</span>
<a id="__codelineno-20-130" name="__codelineno-20-130" href="#__codelineno-20-130"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Collecteur centralisé des métriques des patrons&quot;&quot;&quot;</span>
<a id="__codelineno-20-131" name="__codelineno-20-131" href="#__codelineno-20-131"></a>
<a id="__codelineno-20-132" name="__codelineno-20-132" href="#__codelineno-20-132"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">registry</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-20-133" name="__codelineno-20-133" href="#__codelineno-20-133"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">registry</span> <span class="o">=</span> <span class="n">registry</span>
<a id="__codelineno-20-134" name="__codelineno-20-134" href="#__codelineno-20-134"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_saga_start_times</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">datetime</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-20-135" name="__codelineno-20-135" href="#__codelineno-20-135"></a>
<a id="__codelineno-20-136" name="__codelineno-20-136" href="#__codelineno-20-136"></a>    <span class="c1"># Saga</span>
<a id="__codelineno-20-137" name="__codelineno-20-137" href="#__codelineno-20-137"></a>
<a id="__codelineno-20-138" name="__codelineno-20-138" href="#__codelineno-20-138"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">saga_started</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">saga_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">saga_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-20-139" name="__codelineno-20-139" href="#__codelineno-20-139"></a>        <span class="n">saga_started_total</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span><span class="n">saga_type</span><span class="o">=</span><span class="n">saga_type</span><span class="p">)</span><span class="o">.</span><span class="n">inc</span><span class="p">()</span>
<a id="__codelineno-20-140" name="__codelineno-20-140" href="#__codelineno-20-140"></a>        <span class="n">saga_active_count</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span><span class="n">saga_type</span><span class="o">=</span><span class="n">saga_type</span><span class="p">)</span><span class="o">.</span><span class="n">inc</span><span class="p">()</span>
<a id="__codelineno-20-141" name="__codelineno-20-141" href="#__codelineno-20-141"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_saga_start_times</span><span class="p">[</span><span class="n">saga_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
<a id="__codelineno-20-142" name="__codelineno-20-142" href="#__codelineno-20-142"></a>
<a id="__codelineno-20-143" name="__codelineno-20-143" href="#__codelineno-20-143"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">saga_completed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">saga_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">saga_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-20-144" name="__codelineno-20-144" href="#__codelineno-20-144"></a>        <span class="n">saga_completed_total</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span><span class="n">saga_type</span><span class="o">=</span><span class="n">saga_type</span><span class="p">)</span><span class="o">.</span><span class="n">inc</span><span class="p">()</span>
<a id="__codelineno-20-145" name="__codelineno-20-145" href="#__codelineno-20-145"></a>        <span class="n">saga_active_count</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span><span class="n">saga_type</span><span class="o">=</span><span class="n">saga_type</span><span class="p">)</span><span class="o">.</span><span class="n">dec</span><span class="p">()</span>
<a id="__codelineno-20-146" name="__codelineno-20-146" href="#__codelineno-20-146"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_record_saga_duration</span><span class="p">(</span><span class="n">saga_type</span><span class="p">,</span> <span class="n">saga_id</span><span class="p">,</span> <span class="s1">&#39;completed&#39;</span><span class="p">)</span>
<a id="__codelineno-20-147" name="__codelineno-20-147" href="#__codelineno-20-147"></a>
<a id="__codelineno-20-148" name="__codelineno-20-148" href="#__codelineno-20-148"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">saga_compensated</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">saga_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">saga_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">failed_step</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-20-149" name="__codelineno-20-149" href="#__codelineno-20-149"></a>        <span class="n">saga_compensated_total</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span>
<a id="__codelineno-20-150" name="__codelineno-20-150" href="#__codelineno-20-150"></a>            <span class="n">saga_type</span><span class="o">=</span><span class="n">saga_type</span><span class="p">,</span>
<a id="__codelineno-20-151" name="__codelineno-20-151" href="#__codelineno-20-151"></a>            <span class="n">failed_step</span><span class="o">=</span><span class="n">failed_step</span>
<a id="__codelineno-20-152" name="__codelineno-20-152" href="#__codelineno-20-152"></a>        <span class="p">)</span><span class="o">.</span><span class="n">inc</span><span class="p">()</span>
<a id="__codelineno-20-153" name="__codelineno-20-153" href="#__codelineno-20-153"></a>        <span class="n">saga_active_count</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span><span class="n">saga_type</span><span class="o">=</span><span class="n">saga_type</span><span class="p">)</span><span class="o">.</span><span class="n">dec</span><span class="p">()</span>
<a id="__codelineno-20-154" name="__codelineno-20-154" href="#__codelineno-20-154"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_record_saga_duration</span><span class="p">(</span><span class="n">saga_type</span><span class="p">,</span> <span class="n">saga_id</span><span class="p">,</span> <span class="s1">&#39;compensated&#39;</span><span class="p">)</span>
<a id="__codelineno-20-155" name="__codelineno-20-155" href="#__codelineno-20-155"></a>
<a id="__codelineno-20-156" name="__codelineno-20-156" href="#__codelineno-20-156"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_record_saga_duration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">saga_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">saga_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">outcome</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-20-157" name="__codelineno-20-157" href="#__codelineno-20-157"></a>        <span class="k">if</span> <span class="n">saga_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_saga_start_times</span><span class="p">:</span>
<a id="__codelineno-20-158" name="__codelineno-20-158" href="#__codelineno-20-158"></a>            <span class="n">duration</span> <span class="o">=</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_saga_start_times</span><span class="p">[</span><span class="n">saga_id</span><span class="p">])</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
<a id="__codelineno-20-159" name="__codelineno-20-159" href="#__codelineno-20-159"></a>            <span class="n">saga_duration_seconds</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span>
<a id="__codelineno-20-160" name="__codelineno-20-160" href="#__codelineno-20-160"></a>                <span class="n">saga_type</span><span class="o">=</span><span class="n">saga_type</span><span class="p">,</span>
<a id="__codelineno-20-161" name="__codelineno-20-161" href="#__codelineno-20-161"></a>                <span class="n">outcome</span><span class="o">=</span><span class="n">outcome</span>
<a id="__codelineno-20-162" name="__codelineno-20-162" href="#__codelineno-20-162"></a>            <span class="p">)</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="n">duration</span><span class="p">)</span>
<a id="__codelineno-20-163" name="__codelineno-20-163" href="#__codelineno-20-163"></a>            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_saga_start_times</span><span class="p">[</span><span class="n">saga_id</span><span class="p">]</span>
<a id="__codelineno-20-164" name="__codelineno-20-164" href="#__codelineno-20-164"></a>
<a id="__codelineno-20-165" name="__codelineno-20-165" href="#__codelineno-20-165"></a>    <span class="c1"># Event Sourcing</span>
<a id="__codelineno-20-166" name="__codelineno-20-166" href="#__codelineno-20-166"></a>
<a id="__codelineno-20-167" name="__codelineno-20-167" href="#__codelineno-20-167"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">event_appended</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">aggregate_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">event_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-20-168" name="__codelineno-20-168" href="#__codelineno-20-168"></a>        <span class="n">events_appended_total</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span>
<a id="__codelineno-20-169" name="__codelineno-20-169" href="#__codelineno-20-169"></a>            <span class="n">aggregate_type</span><span class="o">=</span><span class="n">aggregate_type</span><span class="p">,</span>
<a id="__codelineno-20-170" name="__codelineno-20-170" href="#__codelineno-20-170"></a>            <span class="n">event_type</span><span class="o">=</span><span class="n">event_type</span>
<a id="__codelineno-20-171" name="__codelineno-20-171" href="#__codelineno-20-171"></a>        <span class="p">)</span><span class="o">.</span><span class="n">inc</span><span class="p">()</span>
<a id="__codelineno-20-172" name="__codelineno-20-172" href="#__codelineno-20-172"></a>
<a id="__codelineno-20-173" name="__codelineno-20-173" href="#__codelineno-20-173"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">aggregate_loaded</span><span class="p">(</span>
<a id="__codelineno-20-174" name="__codelineno-20-174" href="#__codelineno-20-174"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-20-175" name="__codelineno-20-175" href="#__codelineno-20-175"></a>        <span class="n">aggregate_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-20-176" name="__codelineno-20-176" href="#__codelineno-20-176"></a>        <span class="n">duration</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
<a id="__codelineno-20-177" name="__codelineno-20-177" href="#__codelineno-20-177"></a>        <span class="n">from_snapshot</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
<a id="__codelineno-20-178" name="__codelineno-20-178" href="#__codelineno-20-178"></a>        <span class="n">events_replayed</span><span class="p">:</span> <span class="nb">int</span>
<a id="__codelineno-20-179" name="__codelineno-20-179" href="#__codelineno-20-179"></a>    <span class="p">):</span>
<a id="__codelineno-20-180" name="__codelineno-20-180" href="#__codelineno-20-180"></a>        <span class="n">aggregate_load_duration_seconds</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span>
<a id="__codelineno-20-181" name="__codelineno-20-181" href="#__codelineno-20-181"></a>            <span class="n">aggregate_type</span><span class="o">=</span><span class="n">aggregate_type</span><span class="p">,</span>
<a id="__codelineno-20-182" name="__codelineno-20-182" href="#__codelineno-20-182"></a>            <span class="n">from_snapshot</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">from_snapshot</span><span class="p">)</span>
<a id="__codelineno-20-183" name="__codelineno-20-183" href="#__codelineno-20-183"></a>        <span class="p">)</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="n">duration</span><span class="p">)</span>
<a id="__codelineno-20-184" name="__codelineno-20-184" href="#__codelineno-20-184"></a>
<a id="__codelineno-20-185" name="__codelineno-20-185" href="#__codelineno-20-185"></a>        <span class="k">if</span> <span class="n">from_snapshot</span><span class="p">:</span>
<a id="__codelineno-20-186" name="__codelineno-20-186" href="#__codelineno-20-186"></a>            <span class="n">events_since_snapshot</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span>
<a id="__codelineno-20-187" name="__codelineno-20-187" href="#__codelineno-20-187"></a>                <span class="n">aggregate_type</span><span class="o">=</span><span class="n">aggregate_type</span>
<a id="__codelineno-20-188" name="__codelineno-20-188" href="#__codelineno-20-188"></a>            <span class="p">)</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="n">events_replayed</span><span class="p">)</span>
<a id="__codelineno-20-189" name="__codelineno-20-189" href="#__codelineno-20-189"></a>
<a id="__codelineno-20-190" name="__codelineno-20-190" href="#__codelineno-20-190"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">snapshot_created</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">aggregate_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-20-191" name="__codelineno-20-191" href="#__codelineno-20-191"></a>        <span class="n">snapshot_created_total</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span><span class="n">aggregate_type</span><span class="o">=</span><span class="n">aggregate_type</span><span class="p">)</span><span class="o">.</span><span class="n">inc</span><span class="p">()</span>
<a id="__codelineno-20-192" name="__codelineno-20-192" href="#__codelineno-20-192"></a>
<a id="__codelineno-20-193" name="__codelineno-20-193" href="#__codelineno-20-193"></a>    <span class="c1"># CQRS</span>
<a id="__codelineno-20-194" name="__codelineno-20-194" href="#__codelineno-20-194"></a>
<a id="__codelineno-20-195" name="__codelineno-20-195" href="#__codelineno-20-195"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">projection_event_processed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">projector_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">event_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-20-196" name="__codelineno-20-196" href="#__codelineno-20-196"></a>        <span class="n">projection_events_processed</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span>
<a id="__codelineno-20-197" name="__codelineno-20-197" href="#__codelineno-20-197"></a>            <span class="n">projector_name</span><span class="o">=</span><span class="n">projector_name</span><span class="p">,</span>
<a id="__codelineno-20-198" name="__codelineno-20-198" href="#__codelineno-20-198"></a>            <span class="n">event_type</span><span class="o">=</span><span class="n">event_type</span>
<a id="__codelineno-20-199" name="__codelineno-20-199" href="#__codelineno-20-199"></a>        <span class="p">)</span><span class="o">.</span><span class="n">inc</span><span class="p">()</span>
<a id="__codelineno-20-200" name="__codelineno-20-200" href="#__codelineno-20-200"></a>
<a id="__codelineno-20-201" name="__codelineno-20-201" href="#__codelineno-20-201"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">projection_lag_updated</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">projector_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">lag_seconds</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
<a id="__codelineno-20-202" name="__codelineno-20-202" href="#__codelineno-20-202"></a>        <span class="n">projection_lag_seconds</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span><span class="n">projector_name</span><span class="o">=</span><span class="n">projector_name</span><span class="p">)</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">lag_seconds</span><span class="p">)</span>
<a id="__codelineno-20-203" name="__codelineno-20-203" href="#__codelineno-20-203"></a>
<a id="__codelineno-20-204" name="__codelineno-20-204" href="#__codelineno-20-204"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">read_model_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">view_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">duration</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
<a id="__codelineno-20-205" name="__codelineno-20-205" href="#__codelineno-20-205"></a>        <span class="n">read_model_queries_total</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span><span class="n">view_name</span><span class="o">=</span><span class="n">view_name</span><span class="p">)</span><span class="o">.</span><span class="n">inc</span><span class="p">()</span>
<a id="__codelineno-20-206" name="__codelineno-20-206" href="#__codelineno-20-206"></a>        <span class="n">read_model_query_duration</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span><span class="n">view_name</span><span class="o">=</span><span class="n">view_name</span><span class="p">)</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="n">duration</span><span class="p">)</span>
<a id="__codelineno-20-207" name="__codelineno-20-207" href="#__codelineno-20-207"></a>
<a id="__codelineno-20-208" name="__codelineno-20-208" href="#__codelineno-20-208"></a>    <span class="c1"># Outbox</span>
<a id="__codelineno-20-209" name="__codelineno-20-209" href="#__codelineno-20-209"></a>
<a id="__codelineno-20-210" name="__codelineno-20-210" href="#__codelineno-20-210"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">outbox_pending_updated</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">count</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<a id="__codelineno-20-211" name="__codelineno-20-211" href="#__codelineno-20-211"></a>        <span class="n">outbox_pending_count</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">count</span><span class="p">)</span>
<a id="__codelineno-20-212" name="__codelineno-20-212" href="#__codelineno-20-212"></a>
<a id="__codelineno-20-213" name="__codelineno-20-213" href="#__codelineno-20-213"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">outbox_published</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">duration</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
<a id="__codelineno-20-214" name="__codelineno-20-214" href="#__codelineno-20-214"></a>        <span class="n">outbox_publish_duration</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="n">duration</span><span class="p">)</span>
<a id="__codelineno-20-215" name="__codelineno-20-215" href="#__codelineno-20-215"></a>
<a id="__codelineno-20-216" name="__codelineno-20-216" href="#__codelineno-20-216"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">outbox_failed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">error_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-20-217" name="__codelineno-20-217" href="#__codelineno-20-217"></a>        <span class="n">outbox_failures_total</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span><span class="n">error_type</span><span class="o">=</span><span class="n">error_type</span><span class="p">)</span><span class="o">.</span><span class="n">inc</span><span class="p">()</span>
<a id="__codelineno-20-218" name="__codelineno-20-218" href="#__codelineno-20-218"></a>
<a id="__codelineno-20-219" name="__codelineno-20-219" href="#__codelineno-20-219"></a>    <span class="c1"># Résilience</span>
<a id="__codelineno-20-220" name="__codelineno-20-220" href="#__codelineno-20-220"></a>
<a id="__codelineno-20-221" name="__codelineno-20-221" href="#__codelineno-20-221"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">circuit_state_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">circuit_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">CircuitState</span><span class="p">):</span>
<a id="__codelineno-20-222" name="__codelineno-20-222" href="#__codelineno-20-222"></a>        <span class="n">state_value</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;closed&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;half_open&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;open&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">}</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-20-223" name="__codelineno-20-223" href="#__codelineno-20-223"></a>        <span class="n">circuit_breaker_state</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span><span class="n">circuit_name</span><span class="o">=</span><span class="n">circuit_name</span><span class="p">)</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">state_value</span><span class="p">)</span>
<a id="__codelineno-20-224" name="__codelineno-20-224" href="#__codelineno-20-224"></a>
<a id="__codelineno-20-225" name="__codelineno-20-225" href="#__codelineno-20-225"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">retry_attempted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">operation</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">attempt</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<a id="__codelineno-20-226" name="__codelineno-20-226" href="#__codelineno-20-226"></a>        <span class="n">retry_attempts_total</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span>
<a id="__codelineno-20-227" name="__codelineno-20-227" href="#__codelineno-20-227"></a>            <span class="n">operation</span><span class="o">=</span><span class="n">operation</span><span class="p">,</span>
<a id="__codelineno-20-228" name="__codelineno-20-228" href="#__codelineno-20-228"></a>            <span class="n">attempt_number</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">attempt</span><span class="p">)</span>
<a id="__codelineno-20-229" name="__codelineno-20-229" href="#__codelineno-20-229"></a>        <span class="p">)</span><span class="o">.</span><span class="n">inc</span><span class="p">()</span>
<a id="__codelineno-20-230" name="__codelineno-20-230" href="#__codelineno-20-230"></a>
<a id="__codelineno-20-231" name="__codelineno-20-231" href="#__codelineno-20-231"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">dlq_message_sent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source_topic</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">error_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-20-232" name="__codelineno-20-232" href="#__codelineno-20-232"></a>        <span class="n">dlq_messages_total</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span>
<a id="__codelineno-20-233" name="__codelineno-20-233" href="#__codelineno-20-233"></a>            <span class="n">source_topic</span><span class="o">=</span><span class="n">source_topic</span><span class="p">,</span>
<a id="__codelineno-20-234" name="__codelineno-20-234" href="#__codelineno-20-234"></a>            <span class="n">error_type</span><span class="o">=</span><span class="n">error_type</span>
<a id="__codelineno-20-235" name="__codelineno-20-235" href="#__codelineno-20-235"></a>        <span class="p">)</span><span class="o">.</span><span class="n">inc</span><span class="p">()</span>
</code></pre></div>
<h3 id="dashboard-grafana-pour-les-patrons">Dashboard Grafana pour les Patrons<a class="headerlink" href="#dashboard-grafana-pour-les-patrons" title="Permanent link">&para;</a></h3>
<p>Configuration d'un dashboard Grafana pour visualiser la santé des patrons architecturaux :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="p">{</span>
<a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a><span class="w">  </span><span class="nt">&quot;dashboard&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a><span class="w">    </span><span class="nt">&quot;title&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Patrons Architecturaux - Santé du Système&quot;</span><span class="p">,</span>
<a id="__codelineno-21-4" name="__codelineno-21-4" href="#__codelineno-21-4"></a><span class="w">    </span><span class="nt">&quot;panels&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<a id="__codelineno-21-5" name="__codelineno-21-5" href="#__codelineno-21-5"></a><span class="w">      </span><span class="p">{</span>
<a id="__codelineno-21-6" name="__codelineno-21-6" href="#__codelineno-21-6"></a><span class="w">        </span><span class="nt">&quot;title&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Sagas Actives&quot;</span><span class="p">,</span>
<a id="__codelineno-21-7" name="__codelineno-21-7" href="#__codelineno-21-7"></a><span class="w">        </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;stat&quot;</span><span class="p">,</span>
<a id="__codelineno-21-8" name="__codelineno-21-8" href="#__codelineno-21-8"></a><span class="w">        </span><span class="nt">&quot;targets&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span>
<a id="__codelineno-21-9" name="__codelineno-21-9" href="#__codelineno-21-9"></a><span class="w">          </span><span class="nt">&quot;expr&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;sum(saga_active_count)&quot;</span><span class="p">,</span>
<a id="__codelineno-21-10" name="__codelineno-21-10" href="#__codelineno-21-10"></a><span class="w">          </span><span class="nt">&quot;legendFormat&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Sagas en cours&quot;</span>
<a id="__codelineno-21-11" name="__codelineno-21-11" href="#__codelineno-21-11"></a><span class="w">        </span><span class="p">}]</span>
<a id="__codelineno-21-12" name="__codelineno-21-12" href="#__codelineno-21-12"></a><span class="w">      </span><span class="p">},</span>
<a id="__codelineno-21-13" name="__codelineno-21-13" href="#__codelineno-21-13"></a><span class="w">      </span><span class="p">{</span>
<a id="__codelineno-21-14" name="__codelineno-21-14" href="#__codelineno-21-14"></a><span class="w">        </span><span class="nt">&quot;title&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Taux de Succès des Sagas&quot;</span><span class="p">,</span>
<a id="__codelineno-21-15" name="__codelineno-21-15" href="#__codelineno-21-15"></a><span class="w">        </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;gauge&quot;</span><span class="p">,</span>
<a id="__codelineno-21-16" name="__codelineno-21-16" href="#__codelineno-21-16"></a><span class="w">        </span><span class="nt">&quot;targets&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span>
<a id="__codelineno-21-17" name="__codelineno-21-17" href="#__codelineno-21-17"></a><span class="w">          </span><span class="nt">&quot;expr&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;sum(rate(saga_completed_total[5m])) / sum(rate(saga_started_total[5m])) * 100&quot;</span>
<a id="__codelineno-21-18" name="__codelineno-21-18" href="#__codelineno-21-18"></a><span class="w">        </span><span class="p">}],</span>
<a id="__codelineno-21-19" name="__codelineno-21-19" href="#__codelineno-21-19"></a><span class="w">        </span><span class="nt">&quot;fieldConfig&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-21-20" name="__codelineno-21-20" href="#__codelineno-21-20"></a><span class="w">          </span><span class="nt">&quot;defaults&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-21-21" name="__codelineno-21-21" href="#__codelineno-21-21"></a><span class="w">            </span><span class="nt">&quot;thresholds&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-21-22" name="__codelineno-21-22" href="#__codelineno-21-22"></a><span class="w">              </span><span class="nt">&quot;steps&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<a id="__codelineno-21-23" name="__codelineno-21-23" href="#__codelineno-21-23"></a><span class="w">                </span><span class="p">{</span><span class="nt">&quot;color&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;red&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;value&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">},</span>
<a id="__codelineno-21-24" name="__codelineno-21-24" href="#__codelineno-21-24"></a><span class="w">                </span><span class="p">{</span><span class="nt">&quot;color&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;yellow&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;value&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">90</span><span class="p">},</span>
<a id="__codelineno-21-25" name="__codelineno-21-25" href="#__codelineno-21-25"></a><span class="w">                </span><span class="p">{</span><span class="nt">&quot;color&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;green&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;value&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">98</span><span class="p">}</span>
<a id="__codelineno-21-26" name="__codelineno-21-26" href="#__codelineno-21-26"></a><span class="w">              </span><span class="p">]</span>
<a id="__codelineno-21-27" name="__codelineno-21-27" href="#__codelineno-21-27"></a><span class="w">            </span><span class="p">},</span>
<a id="__codelineno-21-28" name="__codelineno-21-28" href="#__codelineno-21-28"></a><span class="w">            </span><span class="nt">&quot;unit&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;percent&quot;</span>
<a id="__codelineno-21-29" name="__codelineno-21-29" href="#__codelineno-21-29"></a><span class="w">          </span><span class="p">}</span>
<a id="__codelineno-21-30" name="__codelineno-21-30" href="#__codelineno-21-30"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-21-31" name="__codelineno-21-31" href="#__codelineno-21-31"></a><span class="w">      </span><span class="p">},</span>
<a id="__codelineno-21-32" name="__codelineno-21-32" href="#__codelineno-21-32"></a><span class="w">      </span><span class="p">{</span>
<a id="__codelineno-21-33" name="__codelineno-21-33" href="#__codelineno-21-33"></a><span class="w">        </span><span class="nt">&quot;title&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Durée des Sagas (P95)&quot;</span><span class="p">,</span>
<a id="__codelineno-21-34" name="__codelineno-21-34" href="#__codelineno-21-34"></a><span class="w">        </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;timeseries&quot;</span><span class="p">,</span>
<a id="__codelineno-21-35" name="__codelineno-21-35" href="#__codelineno-21-35"></a><span class="w">        </span><span class="nt">&quot;targets&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span>
<a id="__codelineno-21-36" name="__codelineno-21-36" href="#__codelineno-21-36"></a><span class="w">          </span><span class="nt">&quot;expr&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;histogram_quantile(0.95, sum(rate(saga_duration_seconds_bucket[5m])) by (le, saga_type))&quot;</span><span class="p">,</span>
<a id="__codelineno-21-37" name="__codelineno-21-37" href="#__codelineno-21-37"></a><span class="w">          </span><span class="nt">&quot;legendFormat&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;{{saga_type}}&quot;</span>
<a id="__codelineno-21-38" name="__codelineno-21-38" href="#__codelineno-21-38"></a><span class="w">        </span><span class="p">}]</span>
<a id="__codelineno-21-39" name="__codelineno-21-39" href="#__codelineno-21-39"></a><span class="w">      </span><span class="p">},</span>
<a id="__codelineno-21-40" name="__codelineno-21-40" href="#__codelineno-21-40"></a><span class="w">      </span><span class="p">{</span>
<a id="__codelineno-21-41" name="__codelineno-21-41" href="#__codelineno-21-41"></a><span class="w">        </span><span class="nt">&quot;title&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Lag des Projections&quot;</span><span class="p">,</span>
<a id="__codelineno-21-42" name="__codelineno-21-42" href="#__codelineno-21-42"></a><span class="w">        </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;timeseries&quot;</span><span class="p">,</span>
<a id="__codelineno-21-43" name="__codelineno-21-43" href="#__codelineno-21-43"></a><span class="w">        </span><span class="nt">&quot;targets&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span>
<a id="__codelineno-21-44" name="__codelineno-21-44" href="#__codelineno-21-44"></a><span class="w">          </span><span class="nt">&quot;expr&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;projection_lag_seconds&quot;</span><span class="p">,</span>
<a id="__codelineno-21-45" name="__codelineno-21-45" href="#__codelineno-21-45"></a><span class="w">          </span><span class="nt">&quot;legendFormat&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;{{projector_name}}&quot;</span>
<a id="__codelineno-21-46" name="__codelineno-21-46" href="#__codelineno-21-46"></a><span class="w">        </span><span class="p">}],</span>
<a id="__codelineno-21-47" name="__codelineno-21-47" href="#__codelineno-21-47"></a><span class="w">        </span><span class="nt">&quot;fieldConfig&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-21-48" name="__codelineno-21-48" href="#__codelineno-21-48"></a><span class="w">          </span><span class="nt">&quot;defaults&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-21-49" name="__codelineno-21-49" href="#__codelineno-21-49"></a><span class="w">            </span><span class="nt">&quot;thresholds&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-21-50" name="__codelineno-21-50" href="#__codelineno-21-50"></a><span class="w">              </span><span class="nt">&quot;steps&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<a id="__codelineno-21-51" name="__codelineno-21-51" href="#__codelineno-21-51"></a><span class="w">                </span><span class="p">{</span><span class="nt">&quot;color&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;green&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;value&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">},</span>
<a id="__codelineno-21-52" name="__codelineno-21-52" href="#__codelineno-21-52"></a><span class="w">                </span><span class="p">{</span><span class="nt">&quot;color&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;yellow&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;value&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">30</span><span class="p">},</span>
<a id="__codelineno-21-53" name="__codelineno-21-53" href="#__codelineno-21-53"></a><span class="w">                </span><span class="p">{</span><span class="nt">&quot;color&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;red&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;value&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">60</span><span class="p">}</span>
<a id="__codelineno-21-54" name="__codelineno-21-54" href="#__codelineno-21-54"></a><span class="w">              </span><span class="p">]</span>
<a id="__codelineno-21-55" name="__codelineno-21-55" href="#__codelineno-21-55"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-21-56" name="__codelineno-21-56" href="#__codelineno-21-56"></a><span class="w">          </span><span class="p">}</span>
<a id="__codelineno-21-57" name="__codelineno-21-57" href="#__codelineno-21-57"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-21-58" name="__codelineno-21-58" href="#__codelineno-21-58"></a><span class="w">      </span><span class="p">},</span>
<a id="__codelineno-21-59" name="__codelineno-21-59" href="#__codelineno-21-59"></a><span class="w">      </span><span class="p">{</span>
<a id="__codelineno-21-60" name="__codelineno-21-60" href="#__codelineno-21-60"></a><span class="w">        </span><span class="nt">&quot;title&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Temps de Chargement des Agrégats&quot;</span><span class="p">,</span>
<a id="__codelineno-21-61" name="__codelineno-21-61" href="#__codelineno-21-61"></a><span class="w">        </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;heatmap&quot;</span><span class="p">,</span>
<a id="__codelineno-21-62" name="__codelineno-21-62" href="#__codelineno-21-62"></a><span class="w">        </span><span class="nt">&quot;targets&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span>
<a id="__codelineno-21-63" name="__codelineno-21-63" href="#__codelineno-21-63"></a><span class="w">          </span><span class="nt">&quot;expr&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;sum(rate(aggregate_load_duration_seconds_bucket[5m])) by (le)&quot;</span><span class="p">,</span>
<a id="__codelineno-21-64" name="__codelineno-21-64" href="#__codelineno-21-64"></a><span class="w">          </span><span class="nt">&quot;format&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;heatmap&quot;</span>
<a id="__codelineno-21-65" name="__codelineno-21-65" href="#__codelineno-21-65"></a><span class="w">        </span><span class="p">}]</span>
<a id="__codelineno-21-66" name="__codelineno-21-66" href="#__codelineno-21-66"></a><span class="w">      </span><span class="p">},</span>
<a id="__codelineno-21-67" name="__codelineno-21-67" href="#__codelineno-21-67"></a><span class="w">      </span><span class="p">{</span>
<a id="__codelineno-21-68" name="__codelineno-21-68" href="#__codelineno-21-68"></a><span class="w">        </span><span class="nt">&quot;title&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Messages Outbox en Attente&quot;</span><span class="p">,</span>
<a id="__codelineno-21-69" name="__codelineno-21-69" href="#__codelineno-21-69"></a><span class="w">        </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;stat&quot;</span><span class="p">,</span>
<a id="__codelineno-21-70" name="__codelineno-21-70" href="#__codelineno-21-70"></a><span class="w">        </span><span class="nt">&quot;targets&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span>
<a id="__codelineno-21-71" name="__codelineno-21-71" href="#__codelineno-21-71"></a><span class="w">          </span><span class="nt">&quot;expr&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;outbox_pending_count&quot;</span>
<a id="__codelineno-21-72" name="__codelineno-21-72" href="#__codelineno-21-72"></a><span class="w">        </span><span class="p">}],</span>
<a id="__codelineno-21-73" name="__codelineno-21-73" href="#__codelineno-21-73"></a><span class="w">        </span><span class="nt">&quot;fieldConfig&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-21-74" name="__codelineno-21-74" href="#__codelineno-21-74"></a><span class="w">          </span><span class="nt">&quot;defaults&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-21-75" name="__codelineno-21-75" href="#__codelineno-21-75"></a><span class="w">            </span><span class="nt">&quot;thresholds&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-21-76" name="__codelineno-21-76" href="#__codelineno-21-76"></a><span class="w">              </span><span class="nt">&quot;steps&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<a id="__codelineno-21-77" name="__codelineno-21-77" href="#__codelineno-21-77"></a><span class="w">                </span><span class="p">{</span><span class="nt">&quot;color&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;green&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;value&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">},</span>
<a id="__codelineno-21-78" name="__codelineno-21-78" href="#__codelineno-21-78"></a><span class="w">                </span><span class="p">{</span><span class="nt">&quot;color&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;yellow&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;value&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="p">},</span>
<a id="__codelineno-21-79" name="__codelineno-21-79" href="#__codelineno-21-79"></a><span class="w">                </span><span class="p">{</span><span class="nt">&quot;color&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;red&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;value&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1000</span><span class="p">}</span>
<a id="__codelineno-21-80" name="__codelineno-21-80" href="#__codelineno-21-80"></a><span class="w">              </span><span class="p">]</span>
<a id="__codelineno-21-81" name="__codelineno-21-81" href="#__codelineno-21-81"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-21-82" name="__codelineno-21-82" href="#__codelineno-21-82"></a><span class="w">          </span><span class="p">}</span>
<a id="__codelineno-21-83" name="__codelineno-21-83" href="#__codelineno-21-83"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-21-84" name="__codelineno-21-84" href="#__codelineno-21-84"></a><span class="w">      </span><span class="p">},</span>
<a id="__codelineno-21-85" name="__codelineno-21-85" href="#__codelineno-21-85"></a><span class="w">      </span><span class="p">{</span>
<a id="__codelineno-21-86" name="__codelineno-21-86" href="#__codelineno-21-86"></a><span class="w">        </span><span class="nt">&quot;title&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;État des Circuit Breakers&quot;</span><span class="p">,</span>
<a id="__codelineno-21-87" name="__codelineno-21-87" href="#__codelineno-21-87"></a><span class="w">        </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;table&quot;</span><span class="p">,</span>
<a id="__codelineno-21-88" name="__codelineno-21-88" href="#__codelineno-21-88"></a><span class="w">        </span><span class="nt">&quot;targets&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span>
<a id="__codelineno-21-89" name="__codelineno-21-89" href="#__codelineno-21-89"></a><span class="w">          </span><span class="nt">&quot;expr&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;circuit_breaker_state&quot;</span><span class="p">,</span>
<a id="__codelineno-21-90" name="__codelineno-21-90" href="#__codelineno-21-90"></a><span class="w">          </span><span class="nt">&quot;format&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;table&quot;</span>
<a id="__codelineno-21-91" name="__codelineno-21-91" href="#__codelineno-21-91"></a><span class="w">        </span><span class="p">}],</span>
<a id="__codelineno-21-92" name="__codelineno-21-92" href="#__codelineno-21-92"></a><span class="w">        </span><span class="nt">&quot;transformations&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span>
<a id="__codelineno-21-93" name="__codelineno-21-93" href="#__codelineno-21-93"></a><span class="w">          </span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;organize&quot;</span><span class="p">,</span>
<a id="__codelineno-21-94" name="__codelineno-21-94" href="#__codelineno-21-94"></a><span class="w">          </span><span class="nt">&quot;options&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-21-95" name="__codelineno-21-95" href="#__codelineno-21-95"></a><span class="w">            </span><span class="nt">&quot;renameByName&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-21-96" name="__codelineno-21-96" href="#__codelineno-21-96"></a><span class="w">              </span><span class="nt">&quot;circuit_name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Circuit&quot;</span><span class="p">,</span>
<a id="__codelineno-21-97" name="__codelineno-21-97" href="#__codelineno-21-97"></a><span class="w">              </span><span class="nt">&quot;Value&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;État&quot;</span>
<a id="__codelineno-21-98" name="__codelineno-21-98" href="#__codelineno-21-98"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-21-99" name="__codelineno-21-99" href="#__codelineno-21-99"></a><span class="w">          </span><span class="p">}</span>
<a id="__codelineno-21-100" name="__codelineno-21-100" href="#__codelineno-21-100"></a><span class="w">        </span><span class="p">}]</span>
<a id="__codelineno-21-101" name="__codelineno-21-101" href="#__codelineno-21-101"></a><span class="w">      </span><span class="p">},</span>
<a id="__codelineno-21-102" name="__codelineno-21-102" href="#__codelineno-21-102"></a><span class="w">      </span><span class="p">{</span>
<a id="__codelineno-21-103" name="__codelineno-21-103" href="#__codelineno-21-103"></a><span class="w">        </span><span class="nt">&quot;title&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Messages DLQ (24h)&quot;</span><span class="p">,</span>
<a id="__codelineno-21-104" name="__codelineno-21-104" href="#__codelineno-21-104"></a><span class="w">        </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;timeseries&quot;</span><span class="p">,</span>
<a id="__codelineno-21-105" name="__codelineno-21-105" href="#__codelineno-21-105"></a><span class="w">        </span><span class="nt">&quot;targets&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span>
<a id="__codelineno-21-106" name="__codelineno-21-106" href="#__codelineno-21-106"></a><span class="w">          </span><span class="nt">&quot;expr&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;sum(increase(dlq_messages_total[1h])) by (source_topic)&quot;</span><span class="p">,</span>
<a id="__codelineno-21-107" name="__codelineno-21-107" href="#__codelineno-21-107"></a><span class="w">          </span><span class="nt">&quot;legendFormat&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;{{source_topic}}&quot;</span>
<a id="__codelineno-21-108" name="__codelineno-21-108" href="#__codelineno-21-108"></a><span class="w">        </span><span class="p">}]</span>
<a id="__codelineno-21-109" name="__codelineno-21-109" href="#__codelineno-21-109"></a><span class="w">      </span><span class="p">}</span>
<a id="__codelineno-21-110" name="__codelineno-21-110" href="#__codelineno-21-110"></a><span class="w">    </span><span class="p">]</span>
<a id="__codelineno-21-111" name="__codelineno-21-111" href="#__codelineno-21-111"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-21-112" name="__codelineno-21-112" href="#__codelineno-21-112"></a><span class="p">}</span>
</code></pre></div>
<hr />
<h2 id="ii99-etude-de-cas-systeme-de-gestion-de-commandes-agentique">II.9.9 Étude de Cas : Système de Gestion de Commandes Agentique<a class="headerlink" href="#ii99-etude-de-cas-systeme-de-gestion-de-commandes-agentique" title="Permanent link">&para;</a></h2>
<h3 id="contexte-et-exigences">Contexte et Exigences<a class="headerlink" href="#contexte-et-exigences" title="Permanent link">&para;</a></h3>
<p>Cette étude de cas illustre l'intégration complète des patrons dans un système réel de gestion de commandes où des agents cognitifs participent au traitement. Le système doit gérer des commandes clients impliquant vérification de stock, validation de paiement, préparation logistique, et notifications — le tout avec une traçabilité complète et une capacité de compensation.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a>Architecture de référence :
<a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a>
<a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a>┌─────────────────────────────────────────────────────────────────┐
<a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a>│                    COUCHE PRÉSENTATION                          │
<a id="__codelineno-22-5" name="__codelineno-22-5" href="#__codelineno-22-5"></a>│  ┌──────────┐  ┌──────────┐  ┌──────────────────────────────┐  │
<a id="__codelineno-22-6" name="__codelineno-22-6" href="#__codelineno-22-6"></a>│  │ API REST │  │ WebSocket│  │ Agent Conversationnel        │  │
<a id="__codelineno-22-7" name="__codelineno-22-7" href="#__codelineno-22-7"></a>│  └────┬─────┘  └────┬─────┘  │ (Vertex AI)                  │  │
<a id="__codelineno-22-8" name="__codelineno-22-8" href="#__codelineno-22-8"></a>│       │             │        └──────────────┬───────────────┘  │
<a id="__codelineno-22-9" name="__codelineno-22-9" href="#__codelineno-22-9"></a>└───────┼─────────────┼───────────────────────┼──────────────────┘
<a id="__codelineno-22-10" name="__codelineno-22-10" href="#__codelineno-22-10"></a>        │             │                       │
<a id="__codelineno-22-11" name="__codelineno-22-11" href="#__codelineno-22-11"></a>┌───────▼─────────────▼───────────────────────▼──────────────────┐
<a id="__codelineno-22-12" name="__codelineno-22-12" href="#__codelineno-22-12"></a>│                    COUCHE COMMAND (Write)                       │
<a id="__codelineno-22-13" name="__codelineno-22-13" href="#__codelineno-22-13"></a>│  ┌──────────────────────────────────────────────────────────┐  │
<a id="__codelineno-22-14" name="__codelineno-22-14" href="#__codelineno-22-14"></a>│  │                  Command Handlers                         │  │
<a id="__codelineno-22-15" name="__codelineno-22-15" href="#__codelineno-22-15"></a>│  │  ┌────────────┐ ┌────────────┐ ┌─────────────────────┐   │  │
<a id="__codelineno-22-16" name="__codelineno-22-16" href="#__codelineno-22-16"></a>│  │  │ Order Cmd  │ │ Payment Cmd│ │ Inventory Cmd       │   │  │
<a id="__codelineno-22-17" name="__codelineno-22-17" href="#__codelineno-22-17"></a>│  │  └─────┬──────┘ └──────┬─────┘ └──────────┬──────────┘   │  │
<a id="__codelineno-22-18" name="__codelineno-22-18" href="#__codelineno-22-18"></a>│  └────────┼───────────────┼──────────────────┼──────────────┘  │
<a id="__codelineno-22-19" name="__codelineno-22-19" href="#__codelineno-22-19"></a>│           │               │                  │                  │
<a id="__codelineno-22-20" name="__codelineno-22-20" href="#__codelineno-22-20"></a>│  ┌────────▼───────────────▼──────────────────▼──────────────┐  │
<a id="__codelineno-22-21" name="__codelineno-22-21" href="#__codelineno-22-21"></a>│  │                    Event Store + Outbox                   │  │
<a id="__codelineno-22-22" name="__codelineno-22-22" href="#__codelineno-22-22"></a>│  │              (PostgreSQL + Transactional Outbox)          │  │
<a id="__codelineno-22-23" name="__codelineno-22-23" href="#__codelineno-22-23"></a>│  └────────────────────────────┬─────────────────────────────┘  │
<a id="__codelineno-22-24" name="__codelineno-22-24" href="#__codelineno-22-24"></a>└───────────────────────────────┼─────────────────────────────────┘
<a id="__codelineno-22-25" name="__codelineno-22-25" href="#__codelineno-22-25"></a>                                │
<a id="__codelineno-22-26" name="__codelineno-22-26" href="#__codelineno-22-26"></a>┌───────────────────────────────▼─────────────────────────────────┐
<a id="__codelineno-22-27" name="__codelineno-22-27" href="#__codelineno-22-27"></a>│                    BACKBONE ÉVÉNEMENTIEL (Kafka)                │
<a id="__codelineno-22-28" name="__codelineno-22-28" href="#__codelineno-22-28"></a>│  ┌──────────────────────────────────────────────────────────┐  │
<a id="__codelineno-22-29" name="__codelineno-22-29" href="#__codelineno-22-29"></a>│  │ Topics: orders.events, payments.events, inventory.events │  │
<a id="__codelineno-22-30" name="__codelineno-22-30" href="#__codelineno-22-30"></a>│  │         saga.events, agent.events, dlq                   │  │
<a id="__codelineno-22-31" name="__codelineno-22-31" href="#__codelineno-22-31"></a>│  └──────────────────────────────────────────────────────────┘  │
<a id="__codelineno-22-32" name="__codelineno-22-32" href="#__codelineno-22-32"></a>└───────────────────────────────┬─────────────────────────────────┘
<a id="__codelineno-22-33" name="__codelineno-22-33" href="#__codelineno-22-33"></a>                                │
<a id="__codelineno-22-34" name="__codelineno-22-34" href="#__codelineno-22-34"></a>┌───────────────────────────────▼─────────────────────────────────┐
<a id="__codelineno-22-35" name="__codelineno-22-35" href="#__codelineno-22-35"></a>│                    COUCHE QUERY (Read)                          │
<a id="__codelineno-22-36" name="__codelineno-22-36" href="#__codelineno-22-36"></a>│  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────┐  │
<a id="__codelineno-22-37" name="__codelineno-22-37" href="#__codelineno-22-37"></a>│  │ Order View   │  │ Customer 360 │  │ Analytics View       │  │
<a id="__codelineno-22-38" name="__codelineno-22-38" href="#__codelineno-22-38"></a>│  │ (MongoDB)    │  │ (Redis)      │  │ (ClickHouse)         │  │
<a id="__codelineno-22-39" name="__codelineno-22-39" href="#__codelineno-22-39"></a>│  └──────────────┘  └──────────────┘  └──────────────────────┘  │
<a id="__codelineno-22-40" name="__codelineno-22-40" href="#__codelineno-22-40"></a>└─────────────────────────────────────────────────────────────────┘
</code></pre></div>
<h3 id="implementation-complete">Implémentation Complète<a class="headerlink" href="#implementation-complete" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a><span class="c1"># order_system/domain/order_aggregate.py</span>
<a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
<a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span>
<a id="__codelineno-23-4" name="__codelineno-23-4" href="#__codelineno-23-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<a id="__codelineno-23-5" name="__codelineno-23-5" href="#__codelineno-23-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">enum</span><span class="w"> </span><span class="kn">import</span> <span class="n">Enum</span>
<a id="__codelineno-23-6" name="__codelineno-23-6" href="#__codelineno-23-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">uuid</span>
<a id="__codelineno-23-7" name="__codelineno-23-7" href="#__codelineno-23-7"></a>
<a id="__codelineno-23-8" name="__codelineno-23-8" href="#__codelineno-23-8"></a><span class="k">class</span><span class="w"> </span><span class="nc">OrderStatus</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
<a id="__codelineno-23-9" name="__codelineno-23-9" href="#__codelineno-23-9"></a>    <span class="n">CREATED</span> <span class="o">=</span> <span class="s2">&quot;created&quot;</span>
<a id="__codelineno-23-10" name="__codelineno-23-10" href="#__codelineno-23-10"></a>    <span class="n">VALIDATED</span> <span class="o">=</span> <span class="s2">&quot;validated&quot;</span>
<a id="__codelineno-23-11" name="__codelineno-23-11" href="#__codelineno-23-11"></a>    <span class="n">PAYMENT_PENDING</span> <span class="o">=</span> <span class="s2">&quot;payment_pending&quot;</span>
<a id="__codelineno-23-12" name="__codelineno-23-12" href="#__codelineno-23-12"></a>    <span class="n">PAYMENT_CONFIRMED</span> <span class="o">=</span> <span class="s2">&quot;payment_confirmed&quot;</span>
<a id="__codelineno-23-13" name="__codelineno-23-13" href="#__codelineno-23-13"></a>    <span class="n">PREPARING</span> <span class="o">=</span> <span class="s2">&quot;preparing&quot;</span>
<a id="__codelineno-23-14" name="__codelineno-23-14" href="#__codelineno-23-14"></a>    <span class="n">SHIPPED</span> <span class="o">=</span> <span class="s2">&quot;shipped&quot;</span>
<a id="__codelineno-23-15" name="__codelineno-23-15" href="#__codelineno-23-15"></a>    <span class="n">DELIVERED</span> <span class="o">=</span> <span class="s2">&quot;delivered&quot;</span>
<a id="__codelineno-23-16" name="__codelineno-23-16" href="#__codelineno-23-16"></a>    <span class="n">CANCELLED</span> <span class="o">=</span> <span class="s2">&quot;cancelled&quot;</span>
<a id="__codelineno-23-17" name="__codelineno-23-17" href="#__codelineno-23-17"></a>
<a id="__codelineno-23-18" name="__codelineno-23-18" href="#__codelineno-23-18"></a><span class="nd">@dataclass</span>
<a id="__codelineno-23-19" name="__codelineno-23-19" href="#__codelineno-23-19"></a><span class="k">class</span><span class="w"> </span><span class="nc">OrderItem</span><span class="p">:</span>
<a id="__codelineno-23-20" name="__codelineno-23-20" href="#__codelineno-23-20"></a>    <span class="n">product_id</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-23-21" name="__codelineno-23-21" href="#__codelineno-23-21"></a>    <span class="n">quantity</span><span class="p">:</span> <span class="nb">int</span>
<a id="__codelineno-23-22" name="__codelineno-23-22" href="#__codelineno-23-22"></a>    <span class="n">unit_price</span><span class="p">:</span> <span class="nb">float</span>
<a id="__codelineno-23-23" name="__codelineno-23-23" href="#__codelineno-23-23"></a>
<a id="__codelineno-23-24" name="__codelineno-23-24" href="#__codelineno-23-24"></a>    <span class="nd">@property</span>
<a id="__codelineno-23-25" name="__codelineno-23-25" href="#__codelineno-23-25"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">total</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<a id="__codelineno-23-26" name="__codelineno-23-26" href="#__codelineno-23-26"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">quantity</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_price</span>
<a id="__codelineno-23-27" name="__codelineno-23-27" href="#__codelineno-23-27"></a>
<a id="__codelineno-23-28" name="__codelineno-23-28" href="#__codelineno-23-28"></a><span class="nd">@dataclass</span>
<a id="__codelineno-23-29" name="__codelineno-23-29" href="#__codelineno-23-29"></a><span class="k">class</span><span class="w"> </span><span class="nc">OrderAggregate</span><span class="p">(</span><span class="n">AggregateRoot</span><span class="p">):</span>
<a id="__codelineno-23-30" name="__codelineno-23-30" href="#__codelineno-23-30"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Agrégat Order avec Event Sourcing complet&quot;&quot;&quot;</span>
<a id="__codelineno-23-31" name="__codelineno-23-31" href="#__codelineno-23-31"></a>
<a id="__codelineno-23-32" name="__codelineno-23-32" href="#__codelineno-23-32"></a>    <span class="n">customer_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-23-33" name="__codelineno-23-33" href="#__codelineno-23-33"></a>    <span class="n">items</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">OrderItem</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
<a id="__codelineno-23-34" name="__codelineno-23-34" href="#__codelineno-23-34"></a>    <span class="n">status</span><span class="p">:</span> <span class="n">OrderStatus</span> <span class="o">=</span> <span class="n">OrderStatus</span><span class="o">.</span><span class="n">CREATED</span>
<a id="__codelineno-23-35" name="__codelineno-23-35" href="#__codelineno-23-35"></a>    <span class="n">shipping_address</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
<a id="__codelineno-23-36" name="__codelineno-23-36" href="#__codelineno-23-36"></a>    <span class="n">payment_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-23-37" name="__codelineno-23-37" href="#__codelineno-23-37"></a>    <span class="n">tracking_number</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-23-38" name="__codelineno-23-38" href="#__codelineno-23-38"></a>    <span class="n">total_amount</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>
<a id="__codelineno-23-39" name="__codelineno-23-39" href="#__codelineno-23-39"></a>    <span class="n">created_at</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">datetime</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-23-40" name="__codelineno-23-40" href="#__codelineno-23-40"></a>    <span class="n">updated_at</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">datetime</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-23-41" name="__codelineno-23-41" href="#__codelineno-23-41"></a>
<a id="__codelineno-23-42" name="__codelineno-23-42" href="#__codelineno-23-42"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-23-43" name="__codelineno-23-43" href="#__codelineno-23-43"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">order_id</span><span class="p">)</span>
<a id="__codelineno-23-44" name="__codelineno-23-44" href="#__codelineno-23-44"></a>
<a id="__codelineno-23-45" name="__codelineno-23-45" href="#__codelineno-23-45"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_get_aggregate_type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-23-46" name="__codelineno-23-46" href="#__codelineno-23-46"></a>        <span class="k">return</span> <span class="s2">&quot;order&quot;</span>
<a id="__codelineno-23-47" name="__codelineno-23-47" href="#__codelineno-23-47"></a>
<a id="__codelineno-23-48" name="__codelineno-23-48" href="#__codelineno-23-48"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-23-49" name="__codelineno-23-49" href="#__codelineno-23-49"></a>        <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-23-50" name="__codelineno-23-50" href="#__codelineno-23-50"></a>            <span class="s1">&#39;order_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
<a id="__codelineno-23-51" name="__codelineno-23-51" href="#__codelineno-23-51"></a>            <span class="s1">&#39;customer_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">customer_id</span><span class="p">,</span>
<a id="__codelineno-23-52" name="__codelineno-23-52" href="#__codelineno-23-52"></a>            <span class="s1">&#39;items&#39;</span><span class="p">:</span> <span class="p">[</span>
<a id="__codelineno-23-53" name="__codelineno-23-53" href="#__codelineno-23-53"></a>                <span class="p">{</span><span class="s1">&#39;product_id&#39;</span><span class="p">:</span> <span class="n">i</span><span class="o">.</span><span class="n">product_id</span><span class="p">,</span> <span class="s1">&#39;quantity&#39;</span><span class="p">:</span> <span class="n">i</span><span class="o">.</span><span class="n">quantity</span><span class="p">,</span> <span class="s1">&#39;unit_price&#39;</span><span class="p">:</span> <span class="n">i</span><span class="o">.</span><span class="n">unit_price</span><span class="p">}</span>
<a id="__codelineno-23-54" name="__codelineno-23-54" href="#__codelineno-23-54"></a>                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span>
<a id="__codelineno-23-55" name="__codelineno-23-55" href="#__codelineno-23-55"></a>            <span class="p">],</span>
<a id="__codelineno-23-56" name="__codelineno-23-56" href="#__codelineno-23-56"></a>            <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
<a id="__codelineno-23-57" name="__codelineno-23-57" href="#__codelineno-23-57"></a>            <span class="s1">&#39;shipping_address&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">shipping_address</span><span class="p">,</span>
<a id="__codelineno-23-58" name="__codelineno-23-58" href="#__codelineno-23-58"></a>            <span class="s1">&#39;payment_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">payment_id</span><span class="p">,</span>
<a id="__codelineno-23-59" name="__codelineno-23-59" href="#__codelineno-23-59"></a>            <span class="s1">&#39;tracking_number&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">tracking_number</span><span class="p">,</span>
<a id="__codelineno-23-60" name="__codelineno-23-60" href="#__codelineno-23-60"></a>            <span class="s1">&#39;total_amount&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_amount</span>
<a id="__codelineno-23-61" name="__codelineno-23-61" href="#__codelineno-23-61"></a>        <span class="p">}</span>
<a id="__codelineno-23-62" name="__codelineno-23-62" href="#__codelineno-23-62"></a>
<a id="__codelineno-23-63" name="__codelineno-23-63" href="#__codelineno-23-63"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">restore_from_snapshot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]):</span>
<a id="__codelineno-23-64" name="__codelineno-23-64" href="#__codelineno-23-64"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">customer_id</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s1">&#39;customer_id&#39;</span><span class="p">]</span>
<a id="__codelineno-23-65" name="__codelineno-23-65" href="#__codelineno-23-65"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">items</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-23-66" name="__codelineno-23-66" href="#__codelineno-23-66"></a>            <span class="n">OrderItem</span><span class="p">(</span><span class="o">**</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;items&#39;</span><span class="p">,</span> <span class="p">[])</span>
<a id="__codelineno-23-67" name="__codelineno-23-67" href="#__codelineno-23-67"></a>        <span class="p">]</span>
<a id="__codelineno-23-68" name="__codelineno-23-68" href="#__codelineno-23-68"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">OrderStatus</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">])</span>
<a id="__codelineno-23-69" name="__codelineno-23-69" href="#__codelineno-23-69"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">shipping_address</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;shipping_address&#39;</span><span class="p">,</span> <span class="p">{})</span>
<a id="__codelineno-23-70" name="__codelineno-23-70" href="#__codelineno-23-70"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">payment_id</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;payment_id&#39;</span><span class="p">)</span>
<a id="__codelineno-23-71" name="__codelineno-23-71" href="#__codelineno-23-71"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tracking_number</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tracking_number&#39;</span><span class="p">)</span>
<a id="__codelineno-23-72" name="__codelineno-23-72" href="#__codelineno-23-72"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">total_amount</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;total_amount&#39;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
<a id="__codelineno-23-73" name="__codelineno-23-73" href="#__codelineno-23-73"></a>
<a id="__codelineno-23-74" name="__codelineno-23-74" href="#__codelineno-23-74"></a>    <span class="c1"># Commands</span>
<a id="__codelineno-23-75" name="__codelineno-23-75" href="#__codelineno-23-75"></a>
<a id="__codelineno-23-76" name="__codelineno-23-76" href="#__codelineno-23-76"></a>    <span class="nd">@classmethod</span>
<a id="__codelineno-23-77" name="__codelineno-23-77" href="#__codelineno-23-77"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create</span><span class="p">(</span>
<a id="__codelineno-23-78" name="__codelineno-23-78" href="#__codelineno-23-78"></a>        <span class="bp">cls</span><span class="p">,</span>
<a id="__codelineno-23-79" name="__codelineno-23-79" href="#__codelineno-23-79"></a>        <span class="n">order_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-23-80" name="__codelineno-23-80" href="#__codelineno-23-80"></a>        <span class="n">customer_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-23-81" name="__codelineno-23-81" href="#__codelineno-23-81"></a>        <span class="n">items</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">],</span>
<a id="__codelineno-23-82" name="__codelineno-23-82" href="#__codelineno-23-82"></a>        <span class="n">shipping_address</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span>
<a id="__codelineno-23-83" name="__codelineno-23-83" href="#__codelineno-23-83"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;OrderAggregate&#39;</span><span class="p">:</span>
<a id="__codelineno-23-84" name="__codelineno-23-84" href="#__codelineno-23-84"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Crée une nouvelle commande&quot;&quot;&quot;</span>
<a id="__codelineno-23-85" name="__codelineno-23-85" href="#__codelineno-23-85"></a>
<a id="__codelineno-23-86" name="__codelineno-23-86" href="#__codelineno-23-86"></a>        <span class="n">order</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">order_id</span><span class="p">)</span>
<a id="__codelineno-23-87" name="__codelineno-23-87" href="#__codelineno-23-87"></a>
<a id="__codelineno-23-88" name="__codelineno-23-88" href="#__codelineno-23-88"></a>        <span class="n">order_items</span> <span class="o">=</span> <span class="p">[</span><span class="n">OrderItem</span><span class="p">(</span><span class="o">**</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">]</span>
<a id="__codelineno-23-89" name="__codelineno-23-89" href="#__codelineno-23-89"></a>        <span class="n">total</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">total</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">order_items</span><span class="p">)</span>
<a id="__codelineno-23-90" name="__codelineno-23-90" href="#__codelineno-23-90"></a>
<a id="__codelineno-23-91" name="__codelineno-23-91" href="#__codelineno-23-91"></a>        <span class="n">order</span><span class="o">.</span><span class="n">_raise_event</span><span class="p">(</span><span class="n">OrderCreatedEvent</span><span class="p">(</span>
<a id="__codelineno-23-92" name="__codelineno-23-92" href="#__codelineno-23-92"></a>            <span class="n">event_id</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()),</span>
<a id="__codelineno-23-93" name="__codelineno-23-93" href="#__codelineno-23-93"></a>            <span class="n">aggregate_id</span><span class="o">=</span><span class="n">order_id</span><span class="p">,</span>
<a id="__codelineno-23-94" name="__codelineno-23-94" href="#__codelineno-23-94"></a>            <span class="n">order_id</span><span class="o">=</span><span class="n">order_id</span><span class="p">,</span>
<a id="__codelineno-23-95" name="__codelineno-23-95" href="#__codelineno-23-95"></a>            <span class="n">customer_id</span><span class="o">=</span><span class="n">customer_id</span><span class="p">,</span>
<a id="__codelineno-23-96" name="__codelineno-23-96" href="#__codelineno-23-96"></a>            <span class="n">items</span><span class="o">=</span><span class="n">items</span><span class="p">,</span>
<a id="__codelineno-23-97" name="__codelineno-23-97" href="#__codelineno-23-97"></a>            <span class="n">shipping_address</span><span class="o">=</span><span class="n">shipping_address</span><span class="p">,</span>
<a id="__codelineno-23-98" name="__codelineno-23-98" href="#__codelineno-23-98"></a>            <span class="n">total_amount</span><span class="o">=</span><span class="n">total</span><span class="p">,</span>
<a id="__codelineno-23-99" name="__codelineno-23-99" href="#__codelineno-23-99"></a>            <span class="n">timestamp</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
<a id="__codelineno-23-100" name="__codelineno-23-100" href="#__codelineno-23-100"></a>        <span class="p">))</span>
<a id="__codelineno-23-101" name="__codelineno-23-101" href="#__codelineno-23-101"></a>
<a id="__codelineno-23-102" name="__codelineno-23-102" href="#__codelineno-23-102"></a>        <span class="k">return</span> <span class="n">order</span>
<a id="__codelineno-23-103" name="__codelineno-23-103" href="#__codelineno-23-103"></a>
<a id="__codelineno-23-104" name="__codelineno-23-104" href="#__codelineno-23-104"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">validation_result</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]):</span>
<a id="__codelineno-23-105" name="__codelineno-23-105" href="#__codelineno-23-105"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Valide la commande après vérifications&quot;&quot;&quot;</span>
<a id="__codelineno-23-106" name="__codelineno-23-106" href="#__codelineno-23-106"></a>
<a id="__codelineno-23-107" name="__codelineno-23-107" href="#__codelineno-23-107"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="n">OrderStatus</span><span class="o">.</span><span class="n">CREATED</span><span class="p">:</span>
<a id="__codelineno-23-108" name="__codelineno-23-108" href="#__codelineno-23-108"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Impossible de valider une commande en statut </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-23-109" name="__codelineno-23-109" href="#__codelineno-23-109"></a>
<a id="__codelineno-23-110" name="__codelineno-23-110" href="#__codelineno-23-110"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">validation_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;stock_available&#39;</span><span class="p">):</span>
<a id="__codelineno-23-111" name="__codelineno-23-111" href="#__codelineno-23-111"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_raise_event</span><span class="p">(</span><span class="n">OrderValidationFailedEvent</span><span class="p">(</span>
<a id="__codelineno-23-112" name="__codelineno-23-112" href="#__codelineno-23-112"></a>                <span class="n">event_id</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()),</span>
<a id="__codelineno-23-113" name="__codelineno-23-113" href="#__codelineno-23-113"></a>                <span class="n">aggregate_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
<a id="__codelineno-23-114" name="__codelineno-23-114" href="#__codelineno-23-114"></a>                <span class="n">reason</span><span class="o">=</span><span class="s2">&quot;stock_unavailable&quot;</span><span class="p">,</span>
<a id="__codelineno-23-115" name="__codelineno-23-115" href="#__codelineno-23-115"></a>                <span class="n">details</span><span class="o">=</span><span class="n">validation_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;unavailable_items&#39;</span><span class="p">,</span> <span class="p">[]),</span>
<a id="__codelineno-23-116" name="__codelineno-23-116" href="#__codelineno-23-116"></a>                <span class="n">timestamp</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
<a id="__codelineno-23-117" name="__codelineno-23-117" href="#__codelineno-23-117"></a>            <span class="p">))</span>
<a id="__codelineno-23-118" name="__codelineno-23-118" href="#__codelineno-23-118"></a>            <span class="k">return</span>
<a id="__codelineno-23-119" name="__codelineno-23-119" href="#__codelineno-23-119"></a>
<a id="__codelineno-23-120" name="__codelineno-23-120" href="#__codelineno-23-120"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_raise_event</span><span class="p">(</span><span class="n">OrderValidatedEvent</span><span class="p">(</span>
<a id="__codelineno-23-121" name="__codelineno-23-121" href="#__codelineno-23-121"></a>            <span class="n">event_id</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()),</span>
<a id="__codelineno-23-122" name="__codelineno-23-122" href="#__codelineno-23-122"></a>            <span class="n">aggregate_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
<a id="__codelineno-23-123" name="__codelineno-23-123" href="#__codelineno-23-123"></a>            <span class="n">order_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
<a id="__codelineno-23-124" name="__codelineno-23-124" href="#__codelineno-23-124"></a>            <span class="n">validation_details</span><span class="o">=</span><span class="n">validation_result</span><span class="p">,</span>
<a id="__codelineno-23-125" name="__codelineno-23-125" href="#__codelineno-23-125"></a>            <span class="n">timestamp</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
<a id="__codelineno-23-126" name="__codelineno-23-126" href="#__codelineno-23-126"></a>        <span class="p">))</span>
<a id="__codelineno-23-127" name="__codelineno-23-127" href="#__codelineno-23-127"></a>
<a id="__codelineno-23-128" name="__codelineno-23-128" href="#__codelineno-23-128"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">confirm_payment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">payment_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">transaction_details</span><span class="p">:</span> <span class="n">Dict</span><span class="p">):</span>
<a id="__codelineno-23-129" name="__codelineno-23-129" href="#__codelineno-23-129"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Confirme le paiement&quot;&quot;&quot;</span>
<a id="__codelineno-23-130" name="__codelineno-23-130" href="#__codelineno-23-130"></a>
<a id="__codelineno-23-131" name="__codelineno-23-131" href="#__codelineno-23-131"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="n">OrderStatus</span><span class="o">.</span><span class="n">PAYMENT_PENDING</span><span class="p">:</span>
<a id="__codelineno-23-132" name="__codelineno-23-132" href="#__codelineno-23-132"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Paiement non attendu en statut </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-23-133" name="__codelineno-23-133" href="#__codelineno-23-133"></a>
<a id="__codelineno-23-134" name="__codelineno-23-134" href="#__codelineno-23-134"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_raise_event</span><span class="p">(</span><span class="n">PaymentConfirmedEvent</span><span class="p">(</span>
<a id="__codelineno-23-135" name="__codelineno-23-135" href="#__codelineno-23-135"></a>            <span class="n">event_id</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()),</span>
<a id="__codelineno-23-136" name="__codelineno-23-136" href="#__codelineno-23-136"></a>            <span class="n">aggregate_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
<a id="__codelineno-23-137" name="__codelineno-23-137" href="#__codelineno-23-137"></a>            <span class="n">order_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
<a id="__codelineno-23-138" name="__codelineno-23-138" href="#__codelineno-23-138"></a>            <span class="n">payment_id</span><span class="o">=</span><span class="n">payment_id</span><span class="p">,</span>
<a id="__codelineno-23-139" name="__codelineno-23-139" href="#__codelineno-23-139"></a>            <span class="n">transaction_details</span><span class="o">=</span><span class="n">transaction_details</span><span class="p">,</span>
<a id="__codelineno-23-140" name="__codelineno-23-140" href="#__codelineno-23-140"></a>            <span class="n">timestamp</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
<a id="__codelineno-23-141" name="__codelineno-23-141" href="#__codelineno-23-141"></a>        <span class="p">))</span>
<a id="__codelineno-23-142" name="__codelineno-23-142" href="#__codelineno-23-142"></a>
<a id="__codelineno-23-143" name="__codelineno-23-143" href="#__codelineno-23-143"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">start_preparation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">warehouse_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-23-144" name="__codelineno-23-144" href="#__codelineno-23-144"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Démarre la préparation&quot;&quot;&quot;</span>
<a id="__codelineno-23-145" name="__codelineno-23-145" href="#__codelineno-23-145"></a>
<a id="__codelineno-23-146" name="__codelineno-23-146" href="#__codelineno-23-146"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="n">OrderStatus</span><span class="o">.</span><span class="n">PAYMENT_CONFIRMED</span><span class="p">:</span>
<a id="__codelineno-23-147" name="__codelineno-23-147" href="#__codelineno-23-147"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Préparation impossible en statut </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-23-148" name="__codelineno-23-148" href="#__codelineno-23-148"></a>
<a id="__codelineno-23-149" name="__codelineno-23-149" href="#__codelineno-23-149"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_raise_event</span><span class="p">(</span><span class="n">PreparationStartedEvent</span><span class="p">(</span>
<a id="__codelineno-23-150" name="__codelineno-23-150" href="#__codelineno-23-150"></a>            <span class="n">event_id</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()),</span>
<a id="__codelineno-23-151" name="__codelineno-23-151" href="#__codelineno-23-151"></a>            <span class="n">aggregate_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
<a id="__codelineno-23-152" name="__codelineno-23-152" href="#__codelineno-23-152"></a>            <span class="n">order_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
<a id="__codelineno-23-153" name="__codelineno-23-153" href="#__codelineno-23-153"></a>            <span class="n">warehouse_id</span><span class="o">=</span><span class="n">warehouse_id</span><span class="p">,</span>
<a id="__codelineno-23-154" name="__codelineno-23-154" href="#__codelineno-23-154"></a>            <span class="n">timestamp</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
<a id="__codelineno-23-155" name="__codelineno-23-155" href="#__codelineno-23-155"></a>        <span class="p">))</span>
<a id="__codelineno-23-156" name="__codelineno-23-156" href="#__codelineno-23-156"></a>
<a id="__codelineno-23-157" name="__codelineno-23-157" href="#__codelineno-23-157"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">ship</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">carrier</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tracking_number</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-23-158" name="__codelineno-23-158" href="#__codelineno-23-158"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Expédie la commande&quot;&quot;&quot;</span>
<a id="__codelineno-23-159" name="__codelineno-23-159" href="#__codelineno-23-159"></a>
<a id="__codelineno-23-160" name="__codelineno-23-160" href="#__codelineno-23-160"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="n">OrderStatus</span><span class="o">.</span><span class="n">PREPARING</span><span class="p">:</span>
<a id="__codelineno-23-161" name="__codelineno-23-161" href="#__codelineno-23-161"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Expédition impossible en statut </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-23-162" name="__codelineno-23-162" href="#__codelineno-23-162"></a>
<a id="__codelineno-23-163" name="__codelineno-23-163" href="#__codelineno-23-163"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_raise_event</span><span class="p">(</span><span class="n">OrderShippedEvent</span><span class="p">(</span>
<a id="__codelineno-23-164" name="__codelineno-23-164" href="#__codelineno-23-164"></a>            <span class="n">event_id</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()),</span>
<a id="__codelineno-23-165" name="__codelineno-23-165" href="#__codelineno-23-165"></a>            <span class="n">aggregate_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
<a id="__codelineno-23-166" name="__codelineno-23-166" href="#__codelineno-23-166"></a>            <span class="n">order_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
<a id="__codelineno-23-167" name="__codelineno-23-167" href="#__codelineno-23-167"></a>            <span class="n">carrier</span><span class="o">=</span><span class="n">carrier</span><span class="p">,</span>
<a id="__codelineno-23-168" name="__codelineno-23-168" href="#__codelineno-23-168"></a>            <span class="n">tracking_number</span><span class="o">=</span><span class="n">tracking_number</span><span class="p">,</span>
<a id="__codelineno-23-169" name="__codelineno-23-169" href="#__codelineno-23-169"></a>            <span class="n">timestamp</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
<a id="__codelineno-23-170" name="__codelineno-23-170" href="#__codelineno-23-170"></a>        <span class="p">))</span>
<a id="__codelineno-23-171" name="__codelineno-23-171" href="#__codelineno-23-171"></a>
<a id="__codelineno-23-172" name="__codelineno-23-172" href="#__codelineno-23-172"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">cancel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reason</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">cancelled_by</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-23-173" name="__codelineno-23-173" href="#__codelineno-23-173"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Annule la commande&quot;&quot;&quot;</span>
<a id="__codelineno-23-174" name="__codelineno-23-174" href="#__codelineno-23-174"></a>
<a id="__codelineno-23-175" name="__codelineno-23-175" href="#__codelineno-23-175"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="ow">in</span> <span class="p">[</span><span class="n">OrderStatus</span><span class="o">.</span><span class="n">SHIPPED</span><span class="p">,</span> <span class="n">OrderStatus</span><span class="o">.</span><span class="n">DELIVERED</span><span class="p">]:</span>
<a id="__codelineno-23-176" name="__codelineno-23-176" href="#__codelineno-23-176"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Impossible d&#39;annuler une commande expédiée ou livrée&quot;</span><span class="p">)</span>
<a id="__codelineno-23-177" name="__codelineno-23-177" href="#__codelineno-23-177"></a>
<a id="__codelineno-23-178" name="__codelineno-23-178" href="#__codelineno-23-178"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_raise_event</span><span class="p">(</span><span class="n">OrderCancelledEvent</span><span class="p">(</span>
<a id="__codelineno-23-179" name="__codelineno-23-179" href="#__codelineno-23-179"></a>            <span class="n">event_id</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()),</span>
<a id="__codelineno-23-180" name="__codelineno-23-180" href="#__codelineno-23-180"></a>            <span class="n">aggregate_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
<a id="__codelineno-23-181" name="__codelineno-23-181" href="#__codelineno-23-181"></a>            <span class="n">order_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
<a id="__codelineno-23-182" name="__codelineno-23-182" href="#__codelineno-23-182"></a>            <span class="n">reason</span><span class="o">=</span><span class="n">reason</span><span class="p">,</span>
<a id="__codelineno-23-183" name="__codelineno-23-183" href="#__codelineno-23-183"></a>            <span class="n">cancelled_by</span><span class="o">=</span><span class="n">cancelled_by</span><span class="p">,</span>
<a id="__codelineno-23-184" name="__codelineno-23-184" href="#__codelineno-23-184"></a>            <span class="n">previous_status</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
<a id="__codelineno-23-185" name="__codelineno-23-185" href="#__codelineno-23-185"></a>            <span class="n">timestamp</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
<a id="__codelineno-23-186" name="__codelineno-23-186" href="#__codelineno-23-186"></a>        <span class="p">))</span>
<a id="__codelineno-23-187" name="__codelineno-23-187" href="#__codelineno-23-187"></a>
<a id="__codelineno-23-188" name="__codelineno-23-188" href="#__codelineno-23-188"></a>    <span class="c1"># Event Applicators</span>
<a id="__codelineno-23-189" name="__codelineno-23-189" href="#__codelineno-23-189"></a>
<a id="__codelineno-23-190" name="__codelineno-23-190" href="#__codelineno-23-190"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_apply_order_created</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-23-191" name="__codelineno-23-191" href="#__codelineno-23-191"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">customer_id</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;customer_id&#39;</span><span class="p">]</span>
<a id="__codelineno-23-192" name="__codelineno-23-192" href="#__codelineno-23-192"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">items</span> <span class="o">=</span> <span class="p">[</span><span class="n">OrderItem</span><span class="p">(</span><span class="o">**</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;items&#39;</span><span class="p">]]</span>
<a id="__codelineno-23-193" name="__codelineno-23-193" href="#__codelineno-23-193"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">shipping_address</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;shipping_address&#39;</span><span class="p">]</span>
<a id="__codelineno-23-194" name="__codelineno-23-194" href="#__codelineno-23-194"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">total_amount</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;total_amount&#39;</span><span class="p">]</span>
<a id="__codelineno-23-195" name="__codelineno-23-195" href="#__codelineno-23-195"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">OrderStatus</span><span class="o">.</span><span class="n">CREATED</span>
<a id="__codelineno-23-196" name="__codelineno-23-196" href="#__codelineno-23-196"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">created_at</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">])</span>
<a id="__codelineno-23-197" name="__codelineno-23-197" href="#__codelineno-23-197"></a>
<a id="__codelineno-23-198" name="__codelineno-23-198" href="#__codelineno-23-198"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_apply_order_validated</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-23-199" name="__codelineno-23-199" href="#__codelineno-23-199"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">OrderStatus</span><span class="o">.</span><span class="n">PAYMENT_PENDING</span>
<a id="__codelineno-23-200" name="__codelineno-23-200" href="#__codelineno-23-200"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">updated_at</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">])</span>
<a id="__codelineno-23-201" name="__codelineno-23-201" href="#__codelineno-23-201"></a>
<a id="__codelineno-23-202" name="__codelineno-23-202" href="#__codelineno-23-202"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_apply_order_validation_failed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-23-203" name="__codelineno-23-203" href="#__codelineno-23-203"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">OrderStatus</span><span class="o">.</span><span class="n">CANCELLED</span>
<a id="__codelineno-23-204" name="__codelineno-23-204" href="#__codelineno-23-204"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">updated_at</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">])</span>
<a id="__codelineno-23-205" name="__codelineno-23-205" href="#__codelineno-23-205"></a>
<a id="__codelineno-23-206" name="__codelineno-23-206" href="#__codelineno-23-206"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_apply_payment_confirmed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-23-207" name="__codelineno-23-207" href="#__codelineno-23-207"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">payment_id</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;payment_id&#39;</span><span class="p">]</span>
<a id="__codelineno-23-208" name="__codelineno-23-208" href="#__codelineno-23-208"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">OrderStatus</span><span class="o">.</span><span class="n">PAYMENT_CONFIRMED</span>
<a id="__codelineno-23-209" name="__codelineno-23-209" href="#__codelineno-23-209"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">updated_at</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">])</span>
<a id="__codelineno-23-210" name="__codelineno-23-210" href="#__codelineno-23-210"></a>
<a id="__codelineno-23-211" name="__codelineno-23-211" href="#__codelineno-23-211"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_apply_preparation_started</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-23-212" name="__codelineno-23-212" href="#__codelineno-23-212"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">OrderStatus</span><span class="o">.</span><span class="n">PREPARING</span>
<a id="__codelineno-23-213" name="__codelineno-23-213" href="#__codelineno-23-213"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">updated_at</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">])</span>
<a id="__codelineno-23-214" name="__codelineno-23-214" href="#__codelineno-23-214"></a>
<a id="__codelineno-23-215" name="__codelineno-23-215" href="#__codelineno-23-215"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_apply_order_shipped</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-23-216" name="__codelineno-23-216" href="#__codelineno-23-216"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tracking_number</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;tracking_number&#39;</span><span class="p">]</span>
<a id="__codelineno-23-217" name="__codelineno-23-217" href="#__codelineno-23-217"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">OrderStatus</span><span class="o">.</span><span class="n">SHIPPED</span>
<a id="__codelineno-23-218" name="__codelineno-23-218" href="#__codelineno-23-218"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">updated_at</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">])</span>
<a id="__codelineno-23-219" name="__codelineno-23-219" href="#__codelineno-23-219"></a>
<a id="__codelineno-23-220" name="__codelineno-23-220" href="#__codelineno-23-220"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_apply_order_cancelled</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-23-221" name="__codelineno-23-221" href="#__codelineno-23-221"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">OrderStatus</span><span class="o">.</span><span class="n">CANCELLED</span>
<a id="__codelineno-23-222" name="__codelineno-23-222" href="#__codelineno-23-222"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">updated_at</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">])</span>
<a id="__codelineno-23-223" name="__codelineno-23-223" href="#__codelineno-23-223"></a>
<a id="__codelineno-23-224" name="__codelineno-23-224" href="#__codelineno-23-224"></a>
<a id="__codelineno-23-225" name="__codelineno-23-225" href="#__codelineno-23-225"></a><span class="c1"># order_system/saga/order_saga.py</span>
<a id="__codelineno-23-226" name="__codelineno-23-226" href="#__codelineno-23-226"></a><span class="k">class</span><span class="w"> </span><span class="nc">OrderProcessingSaga</span><span class="p">:</span>
<a id="__codelineno-23-227" name="__codelineno-23-227" href="#__codelineno-23-227"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Saga de traitement de commande complète&quot;&quot;&quot;</span>
<a id="__codelineno-23-228" name="__codelineno-23-228" href="#__codelineno-23-228"></a>
<a id="__codelineno-23-229" name="__codelineno-23-229" href="#__codelineno-23-229"></a>    <span class="n">STEPS</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-23-230" name="__codelineno-23-230" href="#__codelineno-23-230"></a>        <span class="s1">&#39;order.created&#39;</span><span class="p">,</span>
<a id="__codelineno-23-231" name="__codelineno-23-231" href="#__codelineno-23-231"></a>        <span class="s1">&#39;inventory.reserved&#39;</span><span class="p">,</span>
<a id="__codelineno-23-232" name="__codelineno-23-232" href="#__codelineno-23-232"></a>        <span class="s1">&#39;payment.processed&#39;</span><span class="p">,</span>
<a id="__codelineno-23-233" name="__codelineno-23-233" href="#__codelineno-23-233"></a>        <span class="s1">&#39;order.validated&#39;</span><span class="p">,</span>
<a id="__codelineno-23-234" name="__codelineno-23-234" href="#__codelineno-23-234"></a>        <span class="s1">&#39;preparation.started&#39;</span><span class="p">,</span>
<a id="__codelineno-23-235" name="__codelineno-23-235" href="#__codelineno-23-235"></a>        <span class="s1">&#39;order.shipped&#39;</span>
<a id="__codelineno-23-236" name="__codelineno-23-236" href="#__codelineno-23-236"></a>    <span class="p">]</span>
<a id="__codelineno-23-237" name="__codelineno-23-237" href="#__codelineno-23-237"></a>
<a id="__codelineno-23-238" name="__codelineno-23-238" href="#__codelineno-23-238"></a>    <span class="n">COMPENSATION_MAP</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-23-239" name="__codelineno-23-239" href="#__codelineno-23-239"></a>        <span class="s1">&#39;inventory.reserved&#39;</span><span class="p">:</span> <span class="s1">&#39;inventory.release&#39;</span><span class="p">,</span>
<a id="__codelineno-23-240" name="__codelineno-23-240" href="#__codelineno-23-240"></a>        <span class="s1">&#39;payment.processed&#39;</span><span class="p">:</span> <span class="s1">&#39;payment.refund&#39;</span><span class="p">,</span>
<a id="__codelineno-23-241" name="__codelineno-23-241" href="#__codelineno-23-241"></a>        <span class="s1">&#39;preparation.started&#39;</span><span class="p">:</span> <span class="s1">&#39;preparation.cancel&#39;</span>
<a id="__codelineno-23-242" name="__codelineno-23-242" href="#__codelineno-23-242"></a>    <span class="p">}</span>
<a id="__codelineno-23-243" name="__codelineno-23-243" href="#__codelineno-23-243"></a>
<a id="__codelineno-23-244" name="__codelineno-23-244" href="#__codelineno-23-244"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_store</span><span class="p">,</span> <span class="n">outbox_service</span><span class="p">,</span> <span class="n">metrics_collector</span><span class="p">):</span>
<a id="__codelineno-23-245" name="__codelineno-23-245" href="#__codelineno-23-245"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">event_store</span> <span class="o">=</span> <span class="n">event_store</span>
<a id="__codelineno-23-246" name="__codelineno-23-246" href="#__codelineno-23-246"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">outbox</span> <span class="o">=</span> <span class="n">outbox_service</span>
<a id="__codelineno-23-247" name="__codelineno-23-247" href="#__codelineno-23-247"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span> <span class="o">=</span> <span class="n">metrics_collector</span>
<a id="__codelineno-23-248" name="__codelineno-23-248" href="#__codelineno-23-248"></a>
<a id="__codelineno-23-249" name="__codelineno-23-249" href="#__codelineno-23-249"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">order_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-23-250" name="__codelineno-23-250" href="#__codelineno-23-250"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Démarre la saga de traitement&quot;&quot;&quot;</span>
<a id="__codelineno-23-251" name="__codelineno-23-251" href="#__codelineno-23-251"></a>
<a id="__codelineno-23-252" name="__codelineno-23-252" href="#__codelineno-23-252"></a>        <span class="n">saga_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;order-saga-</span><span class="si">{</span><span class="n">order_id</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span><span class="p">[:</span><span class="mi">8</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-23-253" name="__codelineno-23-253" href="#__codelineno-23-253"></a>
<a id="__codelineno-23-254" name="__codelineno-23-254" href="#__codelineno-23-254"></a>        <span class="c1"># Création de l&#39;événement initial</span>
<a id="__codelineno-23-255" name="__codelineno-23-255" href="#__codelineno-23-255"></a>        <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">outbox</span><span class="o">.</span><span class="n">transaction</span><span class="p">()</span> <span class="k">as</span> <span class="n">tx</span><span class="p">:</span>
<a id="__codelineno-23-256" name="__codelineno-23-256" href="#__codelineno-23-256"></a>            <span class="c1"># Sauvegarde de l&#39;état initial de la saga</span>
<a id="__codelineno-23-257" name="__codelineno-23-257" href="#__codelineno-23-257"></a>            <span class="k">await</span> <span class="n">tx</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-23-258" name="__codelineno-23-258" href="#__codelineno-23-258"></a><span class="s2">                INSERT INTO saga_state (saga_id, saga_type, status, current_step, data)</span>
<a id="__codelineno-23-259" name="__codelineno-23-259" href="#__codelineno-23-259"></a><span class="s2">                VALUES ($1, $2, $3, $4, $5)</span>
<a id="__codelineno-23-260" name="__codelineno-23-260" href="#__codelineno-23-260"></a><span class="s2">            &quot;&quot;&quot;</span><span class="p">,</span> <span class="n">saga_id</span><span class="p">,</span> <span class="s1">&#39;order_processing&#39;</span><span class="p">,</span> <span class="s1">&#39;started&#39;</span><span class="p">,</span> <span class="s1">&#39;order.created&#39;</span><span class="p">,</span> 
<a id="__codelineno-23-261" name="__codelineno-23-261" href="#__codelineno-23-261"></a>                <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">order_data</span><span class="p">))</span>
<a id="__codelineno-23-262" name="__codelineno-23-262" href="#__codelineno-23-262"></a>
<a id="__codelineno-23-263" name="__codelineno-23-263" href="#__codelineno-23-263"></a>            <span class="c1"># Événement de démarrage</span>
<a id="__codelineno-23-264" name="__codelineno-23-264" href="#__codelineno-23-264"></a>            <span class="k">await</span> <span class="n">tx</span><span class="o">.</span><span class="n">add_event</span><span class="p">(</span>
<a id="__codelineno-23-265" name="__codelineno-23-265" href="#__codelineno-23-265"></a>                <span class="n">aggregate_type</span><span class="o">=</span><span class="s1">&#39;saga&#39;</span><span class="p">,</span>
<a id="__codelineno-23-266" name="__codelineno-23-266" href="#__codelineno-23-266"></a>                <span class="n">aggregate_id</span><span class="o">=</span><span class="n">saga_id</span><span class="p">,</span>
<a id="__codelineno-23-267" name="__codelineno-23-267" href="#__codelineno-23-267"></a>                <span class="n">event_type</span><span class="o">=</span><span class="s1">&#39;order.saga.started&#39;</span><span class="p">,</span>
<a id="__codelineno-23-268" name="__codelineno-23-268" href="#__codelineno-23-268"></a>                <span class="n">payload</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-23-269" name="__codelineno-23-269" href="#__codelineno-23-269"></a>                    <span class="s1">&#39;saga_id&#39;</span><span class="p">:</span> <span class="n">saga_id</span><span class="p">,</span>
<a id="__codelineno-23-270" name="__codelineno-23-270" href="#__codelineno-23-270"></a>                    <span class="s1">&#39;order_id&#39;</span><span class="p">:</span> <span class="n">order_id</span><span class="p">,</span>
<a id="__codelineno-23-271" name="__codelineno-23-271" href="#__codelineno-23-271"></a>                    <span class="s1">&#39;order_data&#39;</span><span class="p">:</span> <span class="n">order_data</span>
<a id="__codelineno-23-272" name="__codelineno-23-272" href="#__codelineno-23-272"></a>                <span class="p">}</span>
<a id="__codelineno-23-273" name="__codelineno-23-273" href="#__codelineno-23-273"></a>            <span class="p">)</span>
<a id="__codelineno-23-274" name="__codelineno-23-274" href="#__codelineno-23-274"></a>
<a id="__codelineno-23-275" name="__codelineno-23-275" href="#__codelineno-23-275"></a>            <span class="c1"># Première étape: réservation inventaire</span>
<a id="__codelineno-23-276" name="__codelineno-23-276" href="#__codelineno-23-276"></a>            <span class="k">await</span> <span class="n">tx</span><span class="o">.</span><span class="n">add_event</span><span class="p">(</span>
<a id="__codelineno-23-277" name="__codelineno-23-277" href="#__codelineno-23-277"></a>                <span class="n">aggregate_type</span><span class="o">=</span><span class="s1">&#39;inventory&#39;</span><span class="p">,</span>
<a id="__codelineno-23-278" name="__codelineno-23-278" href="#__codelineno-23-278"></a>                <span class="n">aggregate_id</span><span class="o">=</span><span class="n">order_id</span><span class="p">,</span>
<a id="__codelineno-23-279" name="__codelineno-23-279" href="#__codelineno-23-279"></a>                <span class="n">event_type</span><span class="o">=</span><span class="s1">&#39;inventory.reservation.requested&#39;</span><span class="p">,</span>
<a id="__codelineno-23-280" name="__codelineno-23-280" href="#__codelineno-23-280"></a>                <span class="n">payload</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-23-281" name="__codelineno-23-281" href="#__codelineno-23-281"></a>                    <span class="s1">&#39;saga_id&#39;</span><span class="p">:</span> <span class="n">saga_id</span><span class="p">,</span>
<a id="__codelineno-23-282" name="__codelineno-23-282" href="#__codelineno-23-282"></a>                    <span class="s1">&#39;order_id&#39;</span><span class="p">:</span> <span class="n">order_id</span><span class="p">,</span>
<a id="__codelineno-23-283" name="__codelineno-23-283" href="#__codelineno-23-283"></a>                    <span class="s1">&#39;items&#39;</span><span class="p">:</span> <span class="n">order_data</span><span class="p">[</span><span class="s1">&#39;items&#39;</span><span class="p">]</span>
<a id="__codelineno-23-284" name="__codelineno-23-284" href="#__codelineno-23-284"></a>                <span class="p">},</span>
<a id="__codelineno-23-285" name="__codelineno-23-285" href="#__codelineno-23-285"></a>                <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;saga_id&#39;</span><span class="p">:</span> <span class="n">saga_id</span><span class="p">}</span>
<a id="__codelineno-23-286" name="__codelineno-23-286" href="#__codelineno-23-286"></a>            <span class="p">)</span>
<a id="__codelineno-23-287" name="__codelineno-23-287" href="#__codelineno-23-287"></a>
<a id="__codelineno-23-288" name="__codelineno-23-288" href="#__codelineno-23-288"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">saga_started</span><span class="p">(</span><span class="s1">&#39;order_processing&#39;</span><span class="p">,</span> <span class="n">saga_id</span><span class="p">)</span>
<a id="__codelineno-23-289" name="__codelineno-23-289" href="#__codelineno-23-289"></a>
<a id="__codelineno-23-290" name="__codelineno-23-290" href="#__codelineno-23-290"></a>        <span class="k">return</span> <span class="n">saga_id</span>
<a id="__codelineno-23-291" name="__codelineno-23-291" href="#__codelineno-23-291"></a>
<a id="__codelineno-23-292" name="__codelineno-23-292" href="#__codelineno-23-292"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">handle_step_completed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">saga_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">step</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">result</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-23-293" name="__codelineno-23-293" href="#__codelineno-23-293"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Gère la complétion d&#39;une étape&quot;&quot;&quot;</span>
<a id="__codelineno-23-294" name="__codelineno-23-294" href="#__codelineno-23-294"></a>
<a id="__codelineno-23-295" name="__codelineno-23-295" href="#__codelineno-23-295"></a>        <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">outbox</span><span class="o">.</span><span class="n">transaction</span><span class="p">()</span> <span class="k">as</span> <span class="n">tx</span><span class="p">:</span>
<a id="__codelineno-23-296" name="__codelineno-23-296" href="#__codelineno-23-296"></a>            <span class="c1"># Mise à jour de l&#39;état</span>
<a id="__codelineno-23-297" name="__codelineno-23-297" href="#__codelineno-23-297"></a>            <span class="k">await</span> <span class="n">tx</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-23-298" name="__codelineno-23-298" href="#__codelineno-23-298"></a><span class="s2">                UPDATE saga_state </span>
<a id="__codelineno-23-299" name="__codelineno-23-299" href="#__codelineno-23-299"></a><span class="s2">                SET current_step = $2, </span>
<a id="__codelineno-23-300" name="__codelineno-23-300" href="#__codelineno-23-300"></a><span class="s2">                    completed_steps = array_append(completed_steps, $2),</span>
<a id="__codelineno-23-301" name="__codelineno-23-301" href="#__codelineno-23-301"></a><span class="s2">                    updated_at = NOW()</span>
<a id="__codelineno-23-302" name="__codelineno-23-302" href="#__codelineno-23-302"></a><span class="s2">                WHERE saga_id = $1</span>
<a id="__codelineno-23-303" name="__codelineno-23-303" href="#__codelineno-23-303"></a><span class="s2">            &quot;&quot;&quot;</span><span class="p">,</span> <span class="n">saga_id</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>
<a id="__codelineno-23-304" name="__codelineno-23-304" href="#__codelineno-23-304"></a>
<a id="__codelineno-23-305" name="__codelineno-23-305" href="#__codelineno-23-305"></a>            <span class="c1"># Détermination de l&#39;étape suivante</span>
<a id="__codelineno-23-306" name="__codelineno-23-306" href="#__codelineno-23-306"></a>            <span class="n">next_step</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_next_step</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>
<a id="__codelineno-23-307" name="__codelineno-23-307" href="#__codelineno-23-307"></a>
<a id="__codelineno-23-308" name="__codelineno-23-308" href="#__codelineno-23-308"></a>            <span class="k">if</span> <span class="n">next_step</span><span class="p">:</span>
<a id="__codelineno-23-309" name="__codelineno-23-309" href="#__codelineno-23-309"></a>                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trigger_next_step</span><span class="p">(</span><span class="n">tx</span><span class="p">,</span> <span class="n">saga_id</span><span class="p">,</span> <span class="n">next_step</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
<a id="__codelineno-23-310" name="__codelineno-23-310" href="#__codelineno-23-310"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-23-311" name="__codelineno-23-311" href="#__codelineno-23-311"></a>                <span class="c1"># Saga terminée</span>
<a id="__codelineno-23-312" name="__codelineno-23-312" href="#__codelineno-23-312"></a>                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_complete_saga</span><span class="p">(</span><span class="n">tx</span><span class="p">,</span> <span class="n">saga_id</span><span class="p">)</span>
<a id="__codelineno-23-313" name="__codelineno-23-313" href="#__codelineno-23-313"></a>
<a id="__codelineno-23-314" name="__codelineno-23-314" href="#__codelineno-23-314"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">handle_step_failed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">saga_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">failed_step</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">error</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-23-315" name="__codelineno-23-315" href="#__codelineno-23-315"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Gère l&#39;échec d&#39;une étape et déclenche les compensations&quot;&quot;&quot;</span>
<a id="__codelineno-23-316" name="__codelineno-23-316" href="#__codelineno-23-316"></a>
<a id="__codelineno-23-317" name="__codelineno-23-317" href="#__codelineno-23-317"></a>        <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">outbox</span><span class="o">.</span><span class="n">transaction</span><span class="p">()</span> <span class="k">as</span> <span class="n">tx</span><span class="p">:</span>
<a id="__codelineno-23-318" name="__codelineno-23-318" href="#__codelineno-23-318"></a>            <span class="c1"># Récupération des étapes complétées</span>
<a id="__codelineno-23-319" name="__codelineno-23-319" href="#__codelineno-23-319"></a>            <span class="n">row</span> <span class="o">=</span> <span class="k">await</span> <span class="n">tx</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-23-320" name="__codelineno-23-320" href="#__codelineno-23-320"></a><span class="s2">                SELECT completed_steps, data FROM saga_state WHERE saga_id = $1</span>
<a id="__codelineno-23-321" name="__codelineno-23-321" href="#__codelineno-23-321"></a><span class="s2">            &quot;&quot;&quot;</span><span class="p">,</span> <span class="n">saga_id</span><span class="p">)</span>
<a id="__codelineno-23-322" name="__codelineno-23-322" href="#__codelineno-23-322"></a>
<a id="__codelineno-23-323" name="__codelineno-23-323" href="#__codelineno-23-323"></a>            <span class="n">completed_steps</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;completed_steps&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="p">[]</span>
<a id="__codelineno-23-324" name="__codelineno-23-324" href="#__codelineno-23-324"></a>            <span class="n">saga_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">])</span>
<a id="__codelineno-23-325" name="__codelineno-23-325" href="#__codelineno-23-325"></a>
<a id="__codelineno-23-326" name="__codelineno-23-326" href="#__codelineno-23-326"></a>            <span class="c1"># Mise à jour du statut</span>
<a id="__codelineno-23-327" name="__codelineno-23-327" href="#__codelineno-23-327"></a>            <span class="k">await</span> <span class="n">tx</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-23-328" name="__codelineno-23-328" href="#__codelineno-23-328"></a><span class="s2">                UPDATE saga_state </span>
<a id="__codelineno-23-329" name="__codelineno-23-329" href="#__codelineno-23-329"></a><span class="s2">                SET status = &#39;compensating&#39;, </span>
<a id="__codelineno-23-330" name="__codelineno-23-330" href="#__codelineno-23-330"></a><span class="s2">                    failed_step = $2,</span>
<a id="__codelineno-23-331" name="__codelineno-23-331" href="#__codelineno-23-331"></a><span class="s2">                    error = $3,</span>
<a id="__codelineno-23-332" name="__codelineno-23-332" href="#__codelineno-23-332"></a><span class="s2">                    updated_at = NOW()</span>
<a id="__codelineno-23-333" name="__codelineno-23-333" href="#__codelineno-23-333"></a><span class="s2">                WHERE saga_id = $1</span>
<a id="__codelineno-23-334" name="__codelineno-23-334" href="#__codelineno-23-334"></a><span class="s2">            &quot;&quot;&quot;</span><span class="p">,</span> <span class="n">saga_id</span><span class="p">,</span> <span class="n">failed_step</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span>
<a id="__codelineno-23-335" name="__codelineno-23-335" href="#__codelineno-23-335"></a>
<a id="__codelineno-23-336" name="__codelineno-23-336" href="#__codelineno-23-336"></a>            <span class="c1"># Déclenchement des compensations en ordre inverse</span>
<a id="__codelineno-23-337" name="__codelineno-23-337" href="#__codelineno-23-337"></a>            <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">completed_steps</span><span class="p">):</span>
<a id="__codelineno-23-338" name="__codelineno-23-338" href="#__codelineno-23-338"></a>                <span class="n">compensation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">COMPENSATION_MAP</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>
<a id="__codelineno-23-339" name="__codelineno-23-339" href="#__codelineno-23-339"></a>                <span class="k">if</span> <span class="n">compensation</span><span class="p">:</span>
<a id="__codelineno-23-340" name="__codelineno-23-340" href="#__codelineno-23-340"></a>                    <span class="k">await</span> <span class="n">tx</span><span class="o">.</span><span class="n">add_event</span><span class="p">(</span>
<a id="__codelineno-23-341" name="__codelineno-23-341" href="#__codelineno-23-341"></a>                        <span class="n">aggregate_type</span><span class="o">=</span><span class="s1">&#39;saga&#39;</span><span class="p">,</span>
<a id="__codelineno-23-342" name="__codelineno-23-342" href="#__codelineno-23-342"></a>                        <span class="n">aggregate_id</span><span class="o">=</span><span class="n">saga_id</span><span class="p">,</span>
<a id="__codelineno-23-343" name="__codelineno-23-343" href="#__codelineno-23-343"></a>                        <span class="n">event_type</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">compensation</span><span class="si">}</span><span class="s1">.requested&#39;</span><span class="p">,</span>
<a id="__codelineno-23-344" name="__codelineno-23-344" href="#__codelineno-23-344"></a>                        <span class="n">payload</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-23-345" name="__codelineno-23-345" href="#__codelineno-23-345"></a>                            <span class="s1">&#39;saga_id&#39;</span><span class="p">:</span> <span class="n">saga_id</span><span class="p">,</span>
<a id="__codelineno-23-346" name="__codelineno-23-346" href="#__codelineno-23-346"></a>                            <span class="s1">&#39;original_step&#39;</span><span class="p">:</span> <span class="n">step</span><span class="p">,</span>
<a id="__codelineno-23-347" name="__codelineno-23-347" href="#__codelineno-23-347"></a>                            <span class="s1">&#39;saga_data&#39;</span><span class="p">:</span> <span class="n">saga_data</span>
<a id="__codelineno-23-348" name="__codelineno-23-348" href="#__codelineno-23-348"></a>                        <span class="p">}</span>
<a id="__codelineno-23-349" name="__codelineno-23-349" href="#__codelineno-23-349"></a>                    <span class="p">)</span>
<a id="__codelineno-23-350" name="__codelineno-23-350" href="#__codelineno-23-350"></a>
<a id="__codelineno-23-351" name="__codelineno-23-351" href="#__codelineno-23-351"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">saga_compensated</span><span class="p">(</span><span class="s1">&#39;order_processing&#39;</span><span class="p">,</span> <span class="n">saga_id</span><span class="p">,</span> <span class="n">failed_step</span><span class="p">)</span>
<a id="__codelineno-23-352" name="__codelineno-23-352" href="#__codelineno-23-352"></a>
<a id="__codelineno-23-353" name="__codelineno-23-353" href="#__codelineno-23-353"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_get_next_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_step</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<a id="__codelineno-23-354" name="__codelineno-23-354" href="#__codelineno-23-354"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Détermine l&#39;étape suivante&quot;&quot;&quot;</span>
<a id="__codelineno-23-355" name="__codelineno-23-355" href="#__codelineno-23-355"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-23-356" name="__codelineno-23-356" href="#__codelineno-23-356"></a>            <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">STEPS</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">current_step</span><span class="p">)</span>
<a id="__codelineno-23-357" name="__codelineno-23-357" href="#__codelineno-23-357"></a>            <span class="k">if</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">STEPS</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-23-358" name="__codelineno-23-358" href="#__codelineno-23-358"></a>                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">STEPS</span><span class="p">[</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-23-359" name="__codelineno-23-359" href="#__codelineno-23-359"></a>        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
<a id="__codelineno-23-360" name="__codelineno-23-360" href="#__codelineno-23-360"></a>            <span class="k">pass</span>
<a id="__codelineno-23-361" name="__codelineno-23-361" href="#__codelineno-23-361"></a>        <span class="k">return</span> <span class="kc">None</span>
<a id="__codelineno-23-362" name="__codelineno-23-362" href="#__codelineno-23-362"></a>
<a id="__codelineno-23-363" name="__codelineno-23-363" href="#__codelineno-23-363"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_trigger_next_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tx</span><span class="p">,</span> <span class="n">saga_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">step</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-23-364" name="__codelineno-23-364" href="#__codelineno-23-364"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Déclenche l&#39;étape suivante&quot;&quot;&quot;</span>
<a id="__codelineno-23-365" name="__codelineno-23-365" href="#__codelineno-23-365"></a>
<a id="__codelineno-23-366" name="__codelineno-23-366" href="#__codelineno-23-366"></a>        <span class="n">step_events</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-23-367" name="__codelineno-23-367" href="#__codelineno-23-367"></a>            <span class="s1">&#39;inventory.reserved&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;payment&#39;</span><span class="p">,</span> <span class="s1">&#39;payment.process.requested&#39;</span><span class="p">),</span>
<a id="__codelineno-23-368" name="__codelineno-23-368" href="#__codelineno-23-368"></a>            <span class="s1">&#39;payment.processed&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;order&#39;</span><span class="p">,</span> <span class="s1">&#39;order.validation.requested&#39;</span><span class="p">),</span>
<a id="__codelineno-23-369" name="__codelineno-23-369" href="#__codelineno-23-369"></a>            <span class="s1">&#39;order.validated&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;warehouse&#39;</span><span class="p">,</span> <span class="s1">&#39;preparation.start.requested&#39;</span><span class="p">),</span>
<a id="__codelineno-23-370" name="__codelineno-23-370" href="#__codelineno-23-370"></a>            <span class="s1">&#39;preparation.started&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;shipping&#39;</span><span class="p">,</span> <span class="s1">&#39;shipment.create.requested&#39;</span><span class="p">)</span>
<a id="__codelineno-23-371" name="__codelineno-23-371" href="#__codelineno-23-371"></a>        <span class="p">}</span>
<a id="__codelineno-23-372" name="__codelineno-23-372" href="#__codelineno-23-372"></a>
<a id="__codelineno-23-373" name="__codelineno-23-373" href="#__codelineno-23-373"></a>        <span class="k">if</span> <span class="n">step</span> <span class="ow">in</span> <span class="n">step_events</span><span class="p">:</span>
<a id="__codelineno-23-374" name="__codelineno-23-374" href="#__codelineno-23-374"></a>            <span class="n">aggregate_type</span><span class="p">,</span> <span class="n">event_type</span> <span class="o">=</span> <span class="n">step_events</span><span class="p">[</span><span class="n">step</span><span class="p">]</span>
<a id="__codelineno-23-375" name="__codelineno-23-375" href="#__codelineno-23-375"></a>            <span class="k">await</span> <span class="n">tx</span><span class="o">.</span><span class="n">add_event</span><span class="p">(</span>
<a id="__codelineno-23-376" name="__codelineno-23-376" href="#__codelineno-23-376"></a>                <span class="n">aggregate_type</span><span class="o">=</span><span class="n">aggregate_type</span><span class="p">,</span>
<a id="__codelineno-23-377" name="__codelineno-23-377" href="#__codelineno-23-377"></a>                <span class="n">aggregate_id</span><span class="o">=</span><span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;order_id&#39;</span><span class="p">),</span>
<a id="__codelineno-23-378" name="__codelineno-23-378" href="#__codelineno-23-378"></a>                <span class="n">event_type</span><span class="o">=</span><span class="n">event_type</span><span class="p">,</span>
<a id="__codelineno-23-379" name="__codelineno-23-379" href="#__codelineno-23-379"></a>                <span class="n">payload</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-23-380" name="__codelineno-23-380" href="#__codelineno-23-380"></a>                    <span class="s1">&#39;saga_id&#39;</span><span class="p">:</span> <span class="n">saga_id</span><span class="p">,</span>
<a id="__codelineno-23-381" name="__codelineno-23-381" href="#__codelineno-23-381"></a>                    <span class="o">**</span><span class="n">context</span>
<a id="__codelineno-23-382" name="__codelineno-23-382" href="#__codelineno-23-382"></a>                <span class="p">}</span>
<a id="__codelineno-23-383" name="__codelineno-23-383" href="#__codelineno-23-383"></a>            <span class="p">)</span>
<a id="__codelineno-23-384" name="__codelineno-23-384" href="#__codelineno-23-384"></a>
<a id="__codelineno-23-385" name="__codelineno-23-385" href="#__codelineno-23-385"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_complete_saga</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tx</span><span class="p">,</span> <span class="n">saga_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-23-386" name="__codelineno-23-386" href="#__codelineno-23-386"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Finalise la saga avec succès&quot;&quot;&quot;</span>
<a id="__codelineno-23-387" name="__codelineno-23-387" href="#__codelineno-23-387"></a>
<a id="__codelineno-23-388" name="__codelineno-23-388" href="#__codelineno-23-388"></a>        <span class="k">await</span> <span class="n">tx</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-23-389" name="__codelineno-23-389" href="#__codelineno-23-389"></a><span class="s2">            UPDATE saga_state </span>
<a id="__codelineno-23-390" name="__codelineno-23-390" href="#__codelineno-23-390"></a><span class="s2">            SET status = &#39;completed&#39;, </span>
<a id="__codelineno-23-391" name="__codelineno-23-391" href="#__codelineno-23-391"></a><span class="s2">                completed_at = NOW()</span>
<a id="__codelineno-23-392" name="__codelineno-23-392" href="#__codelineno-23-392"></a><span class="s2">            WHERE saga_id = $1</span>
<a id="__codelineno-23-393" name="__codelineno-23-393" href="#__codelineno-23-393"></a><span class="s2">        &quot;&quot;&quot;</span><span class="p">,</span> <span class="n">saga_id</span><span class="p">)</span>
<a id="__codelineno-23-394" name="__codelineno-23-394" href="#__codelineno-23-394"></a>
<a id="__codelineno-23-395" name="__codelineno-23-395" href="#__codelineno-23-395"></a>        <span class="k">await</span> <span class="n">tx</span><span class="o">.</span><span class="n">add_event</span><span class="p">(</span>
<a id="__codelineno-23-396" name="__codelineno-23-396" href="#__codelineno-23-396"></a>            <span class="n">aggregate_type</span><span class="o">=</span><span class="s1">&#39;saga&#39;</span><span class="p">,</span>
<a id="__codelineno-23-397" name="__codelineno-23-397" href="#__codelineno-23-397"></a>            <span class="n">aggregate_id</span><span class="o">=</span><span class="n">saga_id</span><span class="p">,</span>
<a id="__codelineno-23-398" name="__codelineno-23-398" href="#__codelineno-23-398"></a>            <span class="n">event_type</span><span class="o">=</span><span class="s1">&#39;order.saga.completed&#39;</span><span class="p">,</span>
<a id="__codelineno-23-399" name="__codelineno-23-399" href="#__codelineno-23-399"></a>            <span class="n">payload</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;saga_id&#39;</span><span class="p">:</span> <span class="n">saga_id</span><span class="p">}</span>
<a id="__codelineno-23-400" name="__codelineno-23-400" href="#__codelineno-23-400"></a>        <span class="p">)</span>
<a id="__codelineno-23-401" name="__codelineno-23-401" href="#__codelineno-23-401"></a>
<a id="__codelineno-23-402" name="__codelineno-23-402" href="#__codelineno-23-402"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">saga_completed</span><span class="p">(</span><span class="s1">&#39;order_processing&#39;</span><span class="p">,</span> <span class="n">saga_id</span><span class="p">)</span>
</code></pre></div>
<p>Cette étude de cas démontre comment les patrons s'intègrent dans un système réel, avec l'Event Sourcing pour la traçabilité des commandes, CQRS pour les vues optimisées, les Sagas pour la coordination des services, et l'Outbox pour la fiabilité des publications.</p>
<hr />
<h2 id="conclusion">Conclusion<a class="headerlink" href="#conclusion" title="Permanent link">&para;</a></h2>
<p>Les patrons architecturaux présentés dans ce chapitre constituent les fondations techniques sur lesquelles repose la fiabilité des systèmes agentiques. La Saga Chorégraphiée permet d'orchestrer des transactions distribuées complexes tout en maintenant l'autonomie des participants. CQRS optimise les performances en séparant les flux de lecture et d'écriture, permettant de construire des vues adaptées aux besoins spécifiques de chaque agent. L'Event Sourcing offre une traçabilité complète et la capacité de reconstituer l'état du système à tout moment. Le patron Outbox Transactionnel garantit la cohérence entre les modifications de données et la publication des événements.</p>
<p>Ces patrons ne fonctionnent pas isolément mais se combinent naturellement. Une architecture robuste utilise typiquement l'Event Sourcing comme fondation, CQRS pour optimiser les accès, le patron Outbox pour garantir la publication des événements, et les Sagas pour coordonner les processus multi-étapes. Les mécanismes de résilience — retry, circuit breaker, dead letter queue — viennent compléter l'ensemble en assurant que le système peut absorber et récupérer des défaillances inévitables.</p>
<p>L'intégration avec les agents cognitifs Vertex AI ajoute une dimension supplémentaire où les agents peuvent participer aux Sagas comme des participants à part entière, consommer des vues CQRS optimisées pour leurs besoins décisionnels, et générer des événements traçables. Cette synergie entre architecture événementielle et intelligence artificielle constitue le cœur de l'Agentic Event Mesh.</p>
<p>Les stratégies de test présentées — harnais de test Given-When-Then pour l'Event Sourcing, simulation de Sagas avec compensation — permettent de valider le comportement de ces systèmes complexes de manière déterministe malgré leur nature distribuée et asynchrone.</p>
<p>La mise en œuvre de ces patrons exige une compréhension approfondie des compromis impliqués. L'Event Sourcing offre une traçabilité incomparable mais génère un volume de données important, nécessitant des mécanismes de snapshot et des politiques de rétention. CQRS simplifie les requêtes mais introduit une complexité dans la synchronisation des modèles et le monitoring du lag. Les Sagas permettent les transactions distribuées mais nécessitent une gestion rigoureuse des compensations et des timeouts. L'observabilité fine de ces patrons via des métriques Prometheus et des dashboards Grafana est essentielle pour maintenir la santé opérationnelle du système.</p>
<p>Le chapitre suivant explorera les pipelines CI/CD et les stratégies de déploiement qui permettent de mettre ces architectures en production de manière fiable et reproductible, en tenant compte des spécificités des systèmes agentiques.</p>
<hr />
<h2 id="ii910-resume">II.9.10 Résumé<a class="headerlink" href="#ii910-resume" title="Permanent link">&para;</a></h2>
<p><strong>Saga Chorégraphiée.</strong> Patron de coordination des transactions distribuées sans coordinateur central. Chaque participant réagit aux événements, exécute sa transaction locale et publie le résultat. Les compensations permettent d'annuler les effets en cas d'échec. Idéal pour les processus métier multi-étapes impliquant plusieurs agents ou services.</p>
<p><strong>Événements de Saga.</strong> Quatre types principaux : commandes (initient une action), succès (confirment l'exécution), échecs (signalent un problème), compensations (annulent une action). Le saga_id corrèle tous les événements d'une même transaction distribuée.</p>
<p><strong>CQRS (Command Query Responsibility Segregation).</strong> Séparation des opérations de lecture et d'écriture en modèles distincts. Le modèle de commande (write) est normalisé pour la cohérence, le modèle de lecture (read) est dénormalisé pour la performance. Synchronisation asynchrone via événements.</p>
<p><strong>Projecteurs.</strong> Composants responsables de la transformation des événements en vues de lecture. Doivent être idempotents pour supporter le retraitement. Permettent de créer des vues spécialisées (profil client, vue 360° pour agents) sans modifier le modèle d'écriture.</p>
<p><strong>Event Sourcing.</strong> Persistance de l'état sous forme de séquence d'événements plutôt que d'état courant. L'état est reconstitué en appliquant les événements dans l'ordre. Offre traçabilité complète, audit naturel, et capacité de time-travel (reconstitution à tout instant).</p>
<p><strong>Event Store.</strong> Composant central de l'Event Sourcing. Garantit l'ordonnancement des événements par agrégat, l'atomicité des écritures avec verrouillage optimiste, et la lecture efficace de l'historique. Publication sur Kafka après persistance pour diffusion aux projecteurs.</p>
<p><strong>Snapshots.</strong> Mécanisme d'optimisation pour l'Event Sourcing. Capture périodique de l'état complet d'un agrégat, permettant de ne rejouer que les événements postérieurs. Réduit considérablement le temps de chargement des agrégats avec un long historique.</p>
<p><strong>Projection Replay.</strong> Capacité de reconstruire des projections à partir de l'historique complet des événements. Essentiel pour corriger des erreurs, ajouter de nouvelles vues, ou migrer vers de nouveaux schémas. Mécanisme de checkpoint pour reprendre les reconstructions interrompues.</p>
<p><strong>Agrégats Event-Sourced.</strong> Entités dont l'état est reconstruit à partir des événements. Définissent les règles métier, valident les commandes, génèrent de nouveaux événements. La méthode apply reconstruit l'état, la méthode raise_event enregistre les changements.</p>
<p><strong>Outbox Transactionnel.</strong> Résout le problème de la double écriture (base de données + broker). Les événements sont écrits dans une table outbox dans la même transaction que les modifications métier. Un relay (polling ou CDC/Debezium) publie ensuite sur Kafka.</p>
<p><strong>Retry avec Backoff Exponentiel.</strong> Stratégie pour les erreurs transitoires. Délai croissant entre les tentatives (base × 2^attempt) avec plafond et jitter pour éviter les thundering herds. Configuration du nombre max de tentatives et des exceptions retryables.</p>
<p><strong>Circuit Breaker.</strong> Protection contre les cascades de défaillances. Trois états : fermé (normal), ouvert (bloque les appels), semi-ouvert (teste la récupération). Transition basée sur le nombre d'échecs consécutifs et un timeout de récupération.</p>
<p><strong>Dead Letter Queue (DLQ).</strong> File d'attente pour les messages qui ont épuisé leurs tentatives de retry. Isole les messages problématiques sans bloquer le traitement. Préserve les informations d'erreur et permet l'analyse et le retraitement manuel.</p>
<p><strong>Intégration Agent-Événement.</strong> Les agents cognitifs peuvent participer aux Sagas comme participants, consommer des vues CQRS optimisées, et émettre des événements traçables. Le contexte enrichi permet aux agents de prendre des décisions informées basées sur l'état global du système.</p>
<p><strong>Agent Participant de Saga.</strong> Pattern où un agent agit comme participant à part entière dans une transaction distribuée. L'agent réagit aux événements, exécute des tâches cognitives, et peut être compensé si nécessaire. Stockage local de l'état pour permettre la compensation.</p>
<p><strong>Tests Event Sourcing.</strong> Approche Given-When-Then avec harnais de test spécialisé. Vérification non seulement de l'état final mais aussi de la séquence d'événements produite. Event Store en mémoire pour l'isolation des tests.</p>
<p><strong>Tests de Saga.</strong> Simulation des interactions entre participants avec vérification des compensations. Enregistrement de handlers simulés pour chaque étape, validation du parcours complet ou de la récupération après échec.</p>
<p><strong>Métriques des Patrons.</strong> Indicateurs spécifiques : durée et taux de succès des Sagas, temps de chargement des agrégats, lag des projections, taille de l'outbox, état des circuit breakers, messages en DLQ. Dashboard Grafana centralisé pour la supervision.</p>
<p><strong>Combinaison des patrons.</strong> Architecture typique : Event Sourcing comme fondation avec snapshots pour l'optimisation, CQRS pour les vues spécialisées, Outbox pour la publication fiable, Sagas pour la coordination multi-services, et mécanismes de résilience pour la robustesse. L'étude de cas du système de commandes illustre cette intégration complète.</p>
<hr />
<p><em>Chapitre suivant : Chapitre II.10 — Pipelines CI/CD et Déploiement des Agents</em></p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Retour en haut de la page
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        
<div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/agbruneau/CorpusInformatique" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../../..", "features": ["navigation.tabs", "navigation.sections", "navigation.expand", "navigation.top", "navigation.indexes", "toc.integrate", "search.suggest", "search.highlight", "content.code.copy"], "search": "../../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copi\u00e9 dans le presse-papier", "clipboard.copy": "Copier dans le presse-papier", "search.result.more.one": "1 de plus sur cette page", "search.result.more.other": "# de plus sur cette page", "search.result.none": "Aucun document trouv\u00e9", "search.result.one": "1 document trouv\u00e9", "search.result.other": "# documents trouv\u00e9s", "search.result.placeholder": "Taper pour d\u00e9marrer la recherche", "search.result.term.missing": "Non trouv\u00e9", "select.version": "S\u00e9lectionner la version"}, "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.79ae519e.min.js"></script>
      
        <script src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>